/*!
 * Copyright (c) 2017 Flat - Tutteo Ltd. <hello@flat.io>
 * https://flat.io
 */

function EditorModalPrivacyCtrl(a,b,c,d,e,f,g,h){function i(a){if("Enter"===a.key)return k()}function j(){return"public"===l.score.privacy||"organizationPublic"===l.score.privacy}function k(a){l.processing=!0;var c=a||l.accessRight,e=l.score.id||l.score.id;g.put({id:e,privacy:c}).then(function(a){b.score&&(d.search("sharingKey",a.sharingKey).replace(),b.score.privacy=a.privacy,b.score.htmlUrl=a.htmlUrl),l.isPublic=j(),l.isPublic?(b.account.ownedPublicScoresCount++,b.account.ownedPrivateScoresCount--):(b.account.ownedPublicScoresCount--,b.account.ownedPrivateScoresCount++),h.add("score.privacy-switch")}).catch(function(a){l.processing=!1,b.displayErrors(a,null,!0)}).finally(function(){$(".modal").modal("hide")})}var l=this;l.score=b.flat.modalData.score||b.score,l.organization=b.organization,l.isEdu=!(!l.organization||!l.organization.id),l.isPublic=j(),l.togglePrivacy=k,l.pressEnter=i,l.accessRights=[{value:"private",text:i18n.t("flat:score.access-modal.access.private")},{value:"privateLink",text:i18n.t("flat:score.access-modal.access.private-link")}],l.isEdu&&l.accessRights.push({value:"organizationPublic",text:i18n.t("flat:score.access-modal.access.public-in-school")}),(!l.organization||l.organization.privacy&&l.organization.privacy.publicScores)&&l.accessRights.push({value:"public",text:i18n.t("flat:score.access-modal.access.public")}),l.accessRight=l.score.privacy,e.pageTrack("/score/modal/privacy"),$(".modal").on("hidden.bs.modal",b.hideModal).modal("show")}function EditorModalShortcutsCtrl(a,b,c,d,e,f,g,h,i){function j(){i.queryWithContext().then(function(b){a.forEach(b,function(b,c){a.includes(p,c)&&(b.display="half"),b.splitedShortcuts=[],a.forEach(b.shortcuts,function(a){"drum"===b.type?b.splitedShortcuts.push([a]):b.splitedShortcuts.push(l(a))})}),o.editorShortcuts=b})}function k(){j(),h.add("help.editor-shortcuts")}function l(a){var b=a.filter(function(a){return a.left}),c=a.filter(function(a){return!a.left});return[b,c]}function m(){b.hideModal(),c.flat.modalData.interaction&&c.flat.modalData.interaction.focusKeyboard()}function n(){$(".modal-backdrop").addClass("visible-header white")}var o=this,p=["measure","lyrics","chord","articulation","dynamics","ornaments","bongos","congas"];o.editorShortcuts=[],k(),d.search("m","shortcuts"),e.pageTrack("/score/modal/shortcuts"),$(".modal").on("hidden.bs.modal",m).on("shown.bs.modal",n).modal("show"),o.print=function(){window.print()}}function EditorModalTimelineCtrl(a,b,c,d,e){function f(){$(".modal").modal("hide")}function g(a){b.$broadcast("TimelineModale.revision",a),f()}function h(){$(".change-revision").removeClass("ch-hide"),b.hideModal()}var i=this;i.revisions=c.flat.modalData.revisions,i.currentRevId=c.flat.modalData.currentRevId,i.selectRevision=g,i.closeModal=f,e.search("m","timeline"),d.pageTrack("/score/timeline"),$(".modal").modal("show").on("hidden.bs.modal",h),$(".modal-backdrop").addClass("smart-history-backdrop"),$(".change-revision").addClass("ch-hide"),c.$on("$destroy",h)}function EditorModalTuningCtrl(a,b,c,d,e,f,g){var h,i=this,j=Adagio.Utils.partContentUtils,k=Adagio.Utils.measureUtils,l=Adagio.Utils.attributesUtils,m=Adagio.Utils.staffDetailsUtils,n=b.flat.modalData.partIdx,o=b.flat.modalData.interaction;"number"!=typeof n&&(n=parseInt(c.search().part,10));var p,q,r,s,t;i.presets={guitar:{standard:[{o:2,s:"E",a:0},{o:2,s:"A",a:0},{o:3,s:"D",a:0},{o:3,s:"G",a:0},{o:3,s:"B",a:0},{o:4,s:"E",a:0}],halfStepDown:[{o:2,s:"D",a:1},{o:2,s:"G",a:1},{o:3,s:"C",a:1},{o:3,s:"F",a:1},{o:3,s:"A",a:1},{o:4,s:"D",a:1}],wholeStepDown:[{o:2,s:"D",a:0},{o:2,s:"G",a:0},{o:3,s:"C",a:0},{o:3,s:"F",a:0},{o:3,s:"A",a:0},{o:4,s:"D",a:0}],oneAndHalfStepDown:[{o:2,s:"C",a:1},{o:2,s:"F",a:1},{o:3,s:"B",a:0},{o:3,s:"E",a:0},{o:3,s:"G",a:1},{o:4,s:"C",a:1}],twoStepsDown:[{o:2,s:"C",a:0},{o:2,s:"F",a:0},{o:3,s:"A",a:1},{o:3,s:"D",a:1},{o:3,s:"G",a:0},{o:4,s:"C",a:0}],dropD:[{o:2,s:"D",a:0},{o:2,s:"A",a:0},{o:3,s:"D",a:0},{o:3,s:"G",a:0},{o:3,s:"B",a:0},{o:4,s:"E",a:0}],dropCS:[{o:2,s:"C",a:1},{o:2,s:"G",a:1},{o:3,s:"C",a:1},{o:3,s:"F",a:1},{o:3,s:"A",a:1},{o:4,s:"D",a:1}],dropC:[{o:2,s:"C",a:0},{o:2,s:"G",a:0},{o:3,s:"C",a:0},{o:3,s:"F",a:0},{o:3,s:"A",a:0},{o:4,s:"D",a:0}],dropB:[{o:2,s:"B",a:0},{o:2,s:"F",a:1},{o:3,s:"B",a:0},{o:3,s:"E",a:0},{o:3,s:"G",a:1},{o:4,s:"C",a:1}],dropAS:[{o:2,s:"A",a:1},{o:2,s:"F",a:0},{o:3,s:"A",a:1},{o:3,s:"D",a:1},{o:3,s:"G",a:0},{o:4,s:"C",a:0}],doubleDrop:[{o:2,s:"D",a:0},{o:2,s:"A",a:0},{o:3,s:"D",a:0},{o:3,s:"G",a:0},{o:3,s:"B",a:0},{o:4,s:"D",a:0}],openD:[{o:2,s:"D",a:0},{o:2,s:"A",a:0},{o:3,s:"D",a:0},{o:3,s:"F",a:1},{o:3,s:"A",a:0},{o:4,s:"D",a:0}],openDMinor:[{o:2,s:"D",a:0},{o:2,s:"A",a:0},{o:3,s:"D",a:0},{o:3,s:"F",a:0},{o:3,s:"A",a:0},{o:4,s:"D",a:0}],openG:[{o:2,s:"D",a:0},{o:2,s:"G",a:0},{o:3,s:"D",a:0},{o:3,s:"G",a:0},{o:3,s:"B",a:0},{o:4,s:"D",a:0}],openGMinor:[{o:2,s:"D",a:0},{o:2,s:"G",a:0},{o:3,s:"D",a:0},{o:3,s:"G",a:0},{o:3,s:"A",a:1},{o:4,s:"D",a:0}],openC:[{o:2,s:"C",a:0},{o:2,s:"G",a:0},{o:3,s:"C",a:0},{o:3,s:"G",a:0},{o:4,s:"C",a:0},{o:4,s:"E",a:0}],openCMinor:[{o:2,s:"C",a:0},{o:2,s:"G",a:0},{o:3,s:"C",a:0},{o:3,s:"G",a:0},{o:4,s:"C",a:0},{o:4,s:"D",a:1}]},banjo:{standard:[{o:4,s:"G",a:0},{o:3,s:"D",a:0},{o:3,s:"G",a:0},{o:3,s:"B",a:0},{o:4,s:"D",a:0}],cTuning:[{o:4,s:"G",a:0},{o:3,s:"C",a:0},{o:3,s:"G",a:0},{o:3,s:"B",a:0},{o:4,s:"D",a:0}],doubleC:[{o:4,s:"G",a:0},{o:3,s:"C",a:0},{o:3,s:"G",a:0},{o:3,s:"C",a:0},{o:4,s:"D",a:0}],sawmill:[{o:4,s:"G",a:0},{o:3,s:"D",a:0},{o:3,s:"G",a:0},{o:3,s:"C",a:0},{o:4,s:"D",a:0}],openD:[{o:4,s:"F",a:1},{o:3,s:"D",a:0},{o:3,s:"F",a:1},{o:3,s:"A",a:0},{o:4,s:"D",a:0}],openC:[{o:4,s:"G",a:0},{o:3,s:"C",a:0},{o:3,s:"G",a:0},{o:3,s:"C",a:0},{o:4,s:"E",a:0}],guitar:[{o:4,s:"G",a:0},{o:3,s:"D",a:0},{o:3,s:"G",a:0},{o:3,s:"B",a:0},{o:4,s:"E",a:0}],willieMoore:[{o:4,s:"G",a:0},{o:3,s:"D",a:0},{o:3,s:"G",a:0},{o:3,s:"A",a:0},{o:4,s:"D",a:0}],docBogsD:[{o:4,s:"F",a:1},{o:3,s:"D",a:0},{o:3,s:"G",a:0},{o:3,s:"A",a:0},{o:4,s:"D",a:0}],cumberlandGap:[{o:4,s:"G",a:0},{o:3,s:"E",a:0},{o:3,s:"A",a:0},{o:3,s:"D",a:0},{o:4,s:"E",a:0}],gMinor:[{o:4,s:"G",a:0},{o:3,s:"D",a:0},{o:3,s:"G",a:0},{o:3,s:"B",a:-1},{o:4,s:"D",a:0}]},ukulele:{standard:[{o:4,s:"G",a:0},{o:4,s:"C",a:0},{o:4,s:"E",a:0},{o:4,s:"A",a:0}],soprano:[{o:4,s:"A",a:0},{o:4,s:"D",a:0},{o:4,s:"F",a:1},{o:4,s:"B",a:0}],highG:[{o:4,s:"G",a:0},{o:3,s:"C",a:0},{o:4,s:"E",a:0},{o:4,s:"A",a:0}],highD:[{o:4,s:"D",a:0},{o:3,s:"G",a:0},{o:3,s:"B",a:0},{o:4,s:"E",a:0}]},mandolin:{standard:[{o:3,s:"G",a:0},{o:4,s:"D",a:0},{o:4,s:"A",a:0},{o:5,s:"E",a:0}]},bass:{standard:[{o:1,s:"E",a:0},{o:1,s:"A",a:0},{o:2,s:"D",a:0},{o:2,s:"G",a:0}],dropD:[{o:1,s:"D",a:0},{o:1,s:"A",a:0},{o:2,s:"D",a:0},{o:2,s:"G",a:0}],halfStepDown:[{o:1,s:"D",a:1},{o:1,s:"G",a:1},{o:2,s:"C",a:1},{o:2,s:"F",a:1}],wholeStepDown:[{o:1,s:"D",a:0},{o:1,s:"G",a:0},{o:2,s:"C",a:0},{o:2,s:"F",a:0}]},bass5s:{standard:[{o:0,s:"B",a:0},{o:1,s:"E",a:0},{o:1,s:"A",a:0},{o:2,s:"D",a:0},{o:2,s:"G",a:0}]}},i.setPreset=function(a){if(e.pageTrack("/score/modal/tuning/"+i.key+"/"+a),a=i.instrumentPresets[a])for(var b=0;b<a.length;b++)i.tuning[b]["tuning-step"]=a[b].s,i.tuning[b]["tuning-octave"]=a[b].o,i.tuning[b]["tuning-alter"]=a[b].a},i.searchPresetMatch=function(){var a=Object.keys(i.instrumentPresets);i.previousTuningPreset=i.tuningPreset;for(var b=0;b<a.length;b++){for(var c=i.instrumentPresets[a[b]],d=!0,f=0;f<c.length;f++)if(c[f].o!==i.tuning[f]["tuning-octave"]||c[f].s!==i.tuning[f]["tuning-step"]||c[f].a!==i.tuning[f]["tuning-alter"]){d=!1;break}if(d)return i.tuningPreset=a[b],i.tuningPreset}return i.tuningPreset="custom",i.previousTuningPreset&&i.previousTuningPreset!==i.tuningPreset&&e.pageTrack("/score/modal/tuning/"+i.key+"/"+i.tuningPreset),i.tuningPreset};var u=a.$watch("score.adagioData",function(){if(h=a.score,!(a.account&&a.account.plan&&a.account.plan.features&&a.account.plan.features.tabsTuning))return i.upgradePlan=!0,g("btn-tuning-upgrade"),f.add("editor.instruments.tuning-tabs.intented"),!0;if(!h||!h.adagioData)return!0;if(p=h.adagioData.getPartContent(n),q=h.adagioData.getPartHeader(n),r=j.getMeasure(p,0),s=k.getAttributes(r),t=l.getStaffDetails(s)[0],i.tuning=m.getStaffTunings(t),i.capo=(m.getCapo(t)||0).toString(),d.debug("[tuning] strings =",i.tuning.length),!i.tuning||!(i.tuning.length>=4&&i.tuning.length<=6))return d.warn(new Error("Unsupported tuning preferences"),{extra:{tunng:i.tuning,staffDetails:t}}),i.close();if(6===i.tuning.length)i.key="guitar";else if(q&&q["midi-instrument"]){var b=q["midi-instrument"]["midi-program"];d.debug("[tuning] MIDI program =",b),106===b&&5===i.tuning.length?i.key="banjo":225===b&&4===i.tuning.length?i.key="mandolin":224===b&&4===i.tuning.length?i.key="ukulele":34!==b&&35!==b&&37!==b||4!==i.tuning.length?34!==b&&35!==b||5!==i.tuning.length||(i.key="bass5s"):i.key="bass"}d.debug("[tuning] detected instrument =",i.key),i.instrumentPresets=i.presets[i.key]||{},i.instrumentPresetsList=Object.keys(i.instrumentPresets),i.searchPresetMatch(),e.pageTrack("/score/modal/tuning/"+i.key)});i.save=function(){o.do("action.SetTuning",{partIdx:n,staffIdx:0,staffTunings:i.tuning,capo:parseInt(i.capo,10)}),i.close(),f.add("editor.instruments.tuning-tabs")},i.close=function(){u&&u(),a.hideModal()},i.pressEnter=function(a){if("Enter"===a.key){if(!i.upgradePlan)return i.save();$("#btn-tuning-upgrade").click()}},b.$on("$destroy",i.close),e.pageTrack("/score/modal/tuning")}function EditorModalUpdateCtrl(a,b,c,d,e){b.reload=function(){$(".modal").modal("hide"),location.reload(!0)},b.pressEnter=function(a){if("Enter"===a.key)return b.reload()},$(".modal").on("hidden.bs.modal",a.hideModal).modal("show"),e.search("m","update"),$(".modal-backdrop").addClass("backdrop-update"),d.pageTrack("/flat/update")}function EditorPanelInlineCommentsCtrl(a,b,c,d,e,f,g){function h(){a.score.collaborators&&(n.preloadedUsers=[],_.each(a.score.collaborators,function(b){b.user&&b.user.id&&b.user.id!==a.account.id&&n.preloadedUsers.push(b.user)})),m()}function i(a){a.id!==n.editorScope.scoreInlineComments.highlightedId&&(n.editorScope.scoreInlineComments.highlightedId=a.id)}function j(a){a.id===n.editorScope.scoreInlineComments.highlightedId&&(n.editorScope.scoreInlineComments.highlightedId=null)}function k(a){a._reply=!a._reply,a._reply&&f(["comment-input",a.score,a.revision,a.id].join("-")),m()}function l(b){var c=_.findIndex(n.editorScope.scoreInlineComments.list,{id:b.id});if(c>=0){var d=angular.copy(b);d.resolved||g.resolve({score:d.score,id:d.id}).then(function(b){n.editorScope.scoreInlineComments.list.splice(c,1),n.editorScope.scoreInlineComments.resolved.push(b),0===n.editorScope.scoreInlineComments.list.length&&a.$broadcast("Menu.Display",{name:"inline_comments"}),m()})}}function m(){e(function(){if("track"===a.scoreLayout)return void $(".inline-comment-card").css({top:"initial"});var b=$(".page rect[data-inline-comment]"),c=$(".score-content").offset().top,d=null;_.forEach(b,function(a){var b=$(a),e=b.attr("data-inline-comment"),f=$('.inline-comment-card[data-inline-comment="'+e+'"]');if(f&&f[0]&&b&&b[0]){var g=f.height(),h=b.offset();o[e]={},o[e].height=g,o[e].top=h.top-40-c,d&&o[e].top<o[d].bottom&&(o[e].top=o[d].bottom+8),o[e].bottom=o[e].top+o[e].height,d=e,n.cardsStyle[e]={top:o[e].top}}})},200)}var n=this,o={};n.cardsStyle={},n.editorScope=b.$parent.$parent,n.canEdit=a.score.rights.aclWrite,n.currentUser=a.account,n.preloadedUsers=[],n.selectComment=i,n.unselectComment=j,n.resolveComment=l,n.toggleReplyInput=k,b.$on("ObjectUpdate.ScoreComment",m),b.$on("CommentInput.AddSuccess",m),b.$on("CommentInput.ResetCards",m),a.$broadcast("Editor.windowResize"),d.pageTrack("/score/panel/inlineComments"),h()}function EditorPopoverCollaboratorsCtrl(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){function t(){i("add-collaborator-input")}function u(b){return function(c){var d=[];c.item?(d.push(c.item.name),d.push(c.text),"group"===c.type&&c.class&&c.class.name?d.push(c.class.name):"user"===c.type&&(c.item.printableName?d.push(c.item.printableName):c.item.username&&d.push(c.item.username))):(c.name&&d.push(c.name),c.printableName&&d.push(c.printableName),c.username&&d.push(c.username));var e=!1;return a.forEach(d,function(a){if(e=a.toLowerCase().indexOf(b.toLowerCase())!==-1)return!1}),e}}function v(b){var c,d;d=b.item?b.item:b,d.id&&d.id.length?c=a.findIndex(M.selectedUsers,{id:d.id}):K(b)&&(b={email:b},c=a.findIndex(M.selectedUsers,{email:d})),c<0&&(M.selectedUsers.push(b),M.searchQuery="",M.loadUsers(""),M.isSearchQueryAnEmail=""),t()}function w(b){var c;b.id&&b.id.length?c=a.findIndex(M.selectedUsers,{id:b.id}):b.email&&b.email.length&&(c=a.findIndex(M.selectedUsers,{email:b.email})),c>=0&&M.selectedUsers.splice(c,1),t()}function x(b){var c=a.findIndex(M.inviteRoles,{key:b.key});c>=0&&(M.inviteAs=b)}function y(a){38===a.keyCode&&C(),40===a.keyCode&&B(),13===a.keyCode?0===M.searchQuery.length&&M.selectedUsers.length>0?E():M.searchQuery.length&&M.resultFocused>=0?A():M.isSearchQueryAnEmail&&M.addTag(M.searchQuery):8===a.keyCode&&M.selectedUsers.length>=1&&0===M.searchQuery.length&&M.selectedUsers.splice(M.selectedUsers.length-1,1),a.stopPropagation()}function z(d){return c(function(c,e){var f=[];d.length>6&&(M.isSearchQueryAnEmail=K(d)),M.isEdu&&(f=M.eduPropList),d.length>2?(N&&b.cancel(N),N=b(function(){r.users({q:d}).$promise.then(function(b){var d=a.uniqBy(M.followings.concat(b),"id");a.forEach(d,function(b){var c=a.findIndex(M.selectedUsers,{id:b.id}),d=a.findIndex(M.collaborators,{"user.id":b.id});c<0&&d<0&&f.push(b)}),M.searchResult=f,M.resultFocused=M.searchResult.length-1,c(M.searchResult)}).catch(e)},150)):(M.searchResult=f,c(M.searchResult))})}function A(){var a=M.searchResult[M.resultFocused];a&&v(a)}function B(){M.searchResult.length&&M.resultFocused+1<M.searchResult.length&&M.resultFocused++}function C(){M.searchResult.length&&M.resultFocused-1>=0&&M.resultFocused--}function D(){M.copying=!0,b(angular.noop),async.waterfall([function(a){return"private"!==M.score.privacy?a(null,null):void l.put({id:M.score.id,privacy:"privateLink",sharingKey:M.sharingKey},a.bind(this,null),a)}],function(a,c){a?f.info(a):(c&&(s.add("score.privacy-switch"),M.scoreLink=c.htmlUrl,M.score.privacy="privateLink",M.score.sharingKey=c.sharingKey,g.search("sharingKey",c.sharingKey).replace()),M.account.ownedPublicScoresCount++,M.account.ownedPrivateScoresCount--),M.copied=!0,M.copying=!1,b(function(){M.copied=!1},3e3),s.add("score.share.copy-link"),b(angular.noop)})}function E(){if(M.selectedUsers.length){var b=a.map(M.selectedUsers,function(a){return a&&!a.id&&a.email?a.email:a});q.add(M.score.id,b,{aclWrite:M.inviteAs.aclWrite,aclAdmin:M.inviteAs.aclAdmin}).then(function(){var a="",b={};1===M.selectedUsers.length&&(M.selectedUsers[0].username||M.selectedUsers[0].name)?(a="flat:collaborators.single-invitation-success",b.username=M.selectedUsers[0].username||M.selectedUsers[0].name):(a="flat:collaborators.multiple-invitation-success",b.count=M.selectedUsers.length),j.broadcast(i18n.t(a,b),{color:"success"}),L()})}}function F(b){q.remove(M.score.id,b.id).then(function(){var c=a.findIndex(M.collaborators,{id:b.id});c>=0&&M.collaborators.splice(c,1)})}function G(a,b,c){q.changeRights({scoreId:M.score.id,collaborator:M.collaborators[a],aclWrite:b,aclAdmin:c}).then(function(){var d=M.collaborators[a];d.group=M.collaborators[a].group,d.user=M.collaborators[a].user,d.aclWrite=b,d.aclAdmin=c,M.collaborators[a]=d})}function H(){n.query().$promise.then(function(b){M.eduPropList=[],a.forEach(b,function(a){var b=a.name+" - ";a.section&&(b+=a.section+" - "),M.eduPropList.push({type:"group",text:b+i18n.t("flat:collaborators.add-edu-group-student"),item:a.studentsGroup,class:a}),M.eduPropList.push({type:"group",text:b+i18n.t("flat:collaborators.add-edu-group-teacher"),item:a.teachersGroup,class:a})})})}function I(){m.following({user:d.account.id}).$promise.then(function(b){a.forEach(M.collaborators,function(c){var d=a.findIndex(b,c);d>-1&&b.splice(d,1)}),M.followings=b})}function J(){return c(function(b,c){p.query({score:d.score.id}).$promise.then(function(c){M.collaborators=a.map(c,function(a){return a.userEmail&&(a.invited=!0),a}),b(M.collaborators)}).catch(c)})}function K(a){var b=/^\s*[\w\-\+_]+(\.[\w\-\+_]+)*\@[\w\-\+_]+\.[\w\-\+_]+(\.[\w\-\+_]+)*\s*$/;return String(a).search(b)!==-1}function L(){M.searchQuery="",M.selectedUsers=[],M.isSearchQueryAnEmail=!1,J().finally(function(){M.isEdu?H():M.followings.length||I()})}var M=this,N=null;M.score=d.score,M.account=d.account,M.isEdu=!(!d.organization||!d.organization.id),M.eduPrivacyExternal=!!(d.organization&&d.organization.privacy&&d.organization.privacy.externalCollaboration),M.collaborators=[],M.followings=[],M.classes=[],M.eduPropList=[],M.resultFocused=-1,M.copied=!1,M.copying=!1,"public"===M.score.privacy||"organizationPublic"===M.score.privacy||"privateLink"===M.score.privacy?M.scoreLink=M.score.htmlUrl:(M.sharingKey=l.generateSharingKey(),M.scoreLink=M.score.htmlUrl+"?sharingKey="+M.sharingKey),M.selectedUsers=[],M.searchQuery="",M.isSearchQueryAnEmail=!1,M.inviteRoles=[{key:"admin",value:i18n.t("flat:score.canAdmin"),aclWrite:!0,aclAdmin:!0},{key:"write",value:i18n.t("flat:score.canWrite"),aclWrite:!0,aclAdmin:!1},{key:"read",value:i18n.t("flat:score.canRead"),aclWrite:!1,aclAdmin:!1}],M.inviteAs=M.inviteRoles[1],M.loadModal=d.loadModal,M.changeRights=G,M.copyLink=D,M.addCollaborators=E,M.removeCollaborator=F,M.filterByName=u,M.inputActions=y,M.loadUsers=z,M.addTag=v,M.removeTag=w,M.selectInviteAs=x,L()}function MidiSetupCtrl(a,b,c,d,e,f,g,h){var i=this;i.isWebMIDIAvailable=function(){return"function"==typeof navigator.requestMIDIAccess},i.getBrowserName=function(){return navigator.userAgent.indexOf("Opera")>=0||navigator.userAgent.indexOf("OPR")>=0?"opera":"chrome"},i.browserName=i.getBrowserName(),i.firstMIDIAccessRequest=!1,i.requestMIDIAccess=function(){var a=e.defer();return i.isWebMIDIAvailable()?i.browserAuthorized?(a.resolve(),a.promise):(i.browserCompatible=!0,i.browserAuthorizationPending=!0,i.browserAuthorized=!1,navigator.requestMIDIAccess().then(function(){i.browserAuthorizationPending=!1,i.browserAuthorized=!0,h.push({funnel:{id:i.funnel},event:{type:"input",category:"setup-midi",name:"device-granted"}}),a.resolve()}).catch(function(){i.browserAuthorizationPending=!1,i.browserAuthorized=!1,"browser"===i.step?setTimeout(i.requestMIDIAccess,3e3):a.reject(),i.firstMIDIAccessRequest!==!1&&(i.firstMIDIAccessRequest=!1,h.push({funnel:{id:i.funnel},event:{type:"input",category:"setup-midi",name:"device-not-granted"}}))}),a.promise):(h.push({funnel:{id:i.funnel},event:{type:"input",category:"setup-midi",name:"browser-not-supported",properties:{ua:navigator.userAgent}}}),a.reject(),a.promise)},i.updateMIDIDevices=function(){i.devices=i.MIDI.getInputs();for(var a=[],c=0;c<i.devices.length;c++)a.push({manufacturer:i.devices[c].manufacturer,name:i.devices[c].name});h.push({funnel:{id:i.funnel},event:{type:"input",category:"setup-midi",name:"devices-list",properties:{devices:JSON.stringify(a)}}}),b.$$phase||b.$digest()},i.MIDI=new Dacapo.MIDI(i.updateMIDIDevices),i.browserStep=function(){i.requestMIDIAccess()},i.deviceStep=function(){i.requestMIDIAccess().then(function(){try{i.MIDI.MIDI&&i.devices||i.MIDI.init(i.updateMIDIDevices)}catch(a){d.debug(a)}f(function(){i.delayNotFound=!0},5e3)}).catch(function(){d.debug("[midi-setup] device step without having authzed midi"),i.dispatchStep("browser")})},i.upgradeStep=function(){return a.account.plan&&a.account.plan.features&&a.account.plan.features.midiInput?i.dispatchStep("completed"):(i.freeTrialState=a.account.plan&&a.account.plan.trials&&a.account.plan.trials.midi,d.debug("[midi-setup] free trial state is",i.freeTrialState),h.push({funnel:{id:i.funnel},event:{type:"action",category:"setup-midi",name:"free-trial",properties:{state:i.freeTrialState}}}),"active"===i.freeTrialState?i.dispatchStep("completed"):void 0)},i.startFreeTrial=function(){g.activateTrial({action:"midi"},function(b){a.account.plan.trials=b,a.account.plan.features.midiInput=!0,a.account.plan.features.midiOutput=!0,i.dispatchStep("completed")},function(b){a.displayErrors(b,null,!0)})},i.completedStep=function(){h.push({funnel:{id:i.funnel,completed:!0}})},i.dispatchStep=function(a){if(a="string"==typeof a&&a||c.search().step,["browser","device","upgrade","completed"].indexOf(a)<0&&(d.debug("[midi-step] set default step (browser)"),a="browser"),a===i.step)return!1;if(d.debug("[midi-step] step",a),i.step=a,i[i.step+"Step"](),c.search().step!==a){var b=!c.search().step;c.search("step",i.step),b&&c.replace()}h.push({funnel:{id:i.funnel},event:{type:"page",category:"setup-midi",name:i.step}})},h.push({funnel:{category:"setup",name:"midi",referral:c.search().ref}},function(a){i.funnel=a.funnel,h.setupAutoTrack($(".midi-setup")[0],i.funnel,"setup-midi"),b.$on("$routeUpdate",i.dispatchStep),i.dispatchStep()})}function SmartHistoryCtrl(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){function u(){var a=O.smartHistory.curr._index;if(a>0){var b=O.smartHistory.revisions[a-1];A(0===b._index?null:b.id)}}function v(){var a=O.smartHistory.curr._index;if(a+1<O.smartHistory.revisions.length){var b=O.smartHistory.revisions[a+1];A(b.id)}}function w(){O.smartHistory.restore().then(function(){return b.score=l,b.history={},e.search("revision",null),e.path("/score/"+l.id)})}function x(){return b.score=l,b.history={},e.search("revision",null),e.path("/score/"+l.id)}function y(){c.loadModal("editor","timeline",{revisions:O.smartHistory.revisions,currentRevId:e.search().revision||O.smartHistory.curr.id})}function z(a,b){A(O.smartHistory.head.id===b?null:b)}function A(a){return O.scoreLoader=!0,R=!0,a?(O.smartHistory.update(a).then(function(){b.history.scoreData=O.smartHistory.curr._data,b.history.adagioData=O.smartHistory._adagioData,b.history.currentRevision=a,b.history.scoreDataLoaded=new Date,e.search("revision",a)}).catch(function(c){var d=new Error("[smart-history] Unable to change revision");d.e=c,d.score=b.score.id,d.revision=a,h.warn(d),e.search("revision",null)}).finally(function(){O.scoreLoader=!1,O.smartHistory.curr.id===a&&C()}),!1):(b.history.adagioData=null,b.history.scoreData=null,b.history.scoreDataLoaded=null,b.history.currentRevision=null,e.search("revision",null),O.smartHistory.update(null),O.scoreLoader=!1,!1)}function B(){$(".editor-content").css({"min-height":$(window).height()}),F(),E()}function C(){if(!O.smartHistory.curr._actionsHistory)return!1;var a=O.smartHistory.curr._actionsHistory.length;0===a?S.setAttribute("disabled",!0):S.removeAttribute("disabled");var b={start:[a],step:1,range:{min:[0],max:[a]}};S.noUiSlider&&(S.noUiSlider.destroy(),M=a),noUiSlider.create(S,b).on("update",H);var c='<div class="noUi-tooltip">#{text}</div>';c=c.replace("#{text}",i18n.t("flat:tooltips.smart-history.slider")),$(".noUi-origin").append(c)}function D(a){$("body").animate({scrollTop:(a.clientY-Q.sidenav.top)*Q.score.height/Q.sidenav.height},"slow")}function E(){F();var a=Q.score.top-68;Q.slider={height:Q.sidenav.height*Q.sidenav.height/Q.score.height,top:Math.abs(a*Q.sidenav.height/Q.score.height)},$(".sidenav-slider").css({height:Q.slider.height+"px",top:Q.slider.top+"px"})}function F(){Q.score={};var a=angular.element(".score-content #svg-content");a.length>0&&(Q.score=a[0].getBoundingClientRect()),Q.sidenav={},a=angular.element(".smart-history-sidenav"),a.length>0&&(Q.sidenav=a[0].getBoundingClientRect())}function G(){R&&(R=!1,f(function(){F(),E();var b=[];a.forEach(O.smartHistory.curr._actionsHistory,function(c){var d=$(".action_"+c.id);a.forEach(d,function(a){var d=c.userId||O.smartHistory.curr.user,e=a.getBoundingClientRect(),f=e.top-Q.score.top,g=Q.sidenav.height*f/Q.score.height;b.push({top:g,color:O.smartHistory._collaborators[d].session.color})})}),b=a.uniqWith(b,a.isEqual);var c=$("#history-sidenav-bars");c.html(""),a.forEach(b,function(a){var b='<div class="action-bar" style="background: #{color};top: #{top}px;"></div>';b=b.replace("#{color}",a.color),b=b.replace("#{top}",a.top),c.append(b)})},300))}function H(){if(!(O.smartHistory.curr._actionsHistory.length<=0)){var a=Math.floor(S.noUiSlider.get());if(null===M)return void(M=a);N&&f.cancel(N),N=f(function(){var b=a-M;b<0?O.smartHistory.undo(Math.abs(b)):b>0&&O.smartHistory.redo(b),N=null,M=a,R=!0,G()},200)}}function I(){b.score=angular.copy(l),b.score.rights.canRevert=b.score.rights.aclWrite,b.score.rights.aclWrite=!1,b.score.rights.aclAdmin=!1,O.interaction.rightsHandler=new q,O.interaction.rangeSelect.canComment=!1,O.interaction.rangeSelect.reset(),b.pageTitle=b.score.title,O.keyboard=new t(O.interaction);var d=document.getElementById("global-editor");d.addEventListener("keydown",O.keyboard.keyDown.bind(O.keyboard)),b.history={scoreData:null,currentRevision:null,masterRevision:l.revisions[0].id},c.collaborators||(c.collaborators=new p(b.score)),a.forEach(c.collaborators.collaborators,function(a,b){c.collaborators.setOnline(b)}),O.smartHistory.init(b.score,e.search().revision,c.collaborators).catch(function(a){return 402===a.status?e.path("/settings/upgrade").search({ref:"limit-history",hf:"smart-history"}):(h.error(a),e.path("/score/"+l.id))}).then(function(){h.debug("[SmartHistory] Initialized ",O.smartHistory),b.score.scoreData=O.smartHistory.curr._data,b.score.adagioData=O.smartHistory._adagioData,b.score.scoreDataLoaded=new Date,O.scoreLoader=!1,C(),K()}),j.add("score.history-advanced")}function J(){$(".smart-history-footer").find('[data-toggle="tooltip"]').tooltip({delay:{show:200}})}function K(){e.search().m&&P.indexOf(e.search().m)>=0&&("timeline"===e.search().m?y():c.loadModal("editor",e.search().m))}function L(){h.debug("[SmartHistory] cleanup"),b.score.adagioData=b.score.scoreData=null,angular.element(".smart-history-sidenav").unbind("click",D),window.removeEventListener("scroll",E,T),window.removeEventListener("resize",B,T)}var M,N,O=this,P=["timeline"],Q={actions:[]},R=!0,S=document.getElementById("auto-save-slider");l.revisions=m,O.scoreLoader=!0,O.interaction=new s(l),O.audio=b.audio=O.interaction.audio=new r((void 0),O.interaction),O.restore=w,O.backToEditor=x,O.loadTimeline=y,O.changeRevision=A,O.previousRevision=u,O.nextRevision=v,O.smartHistory=o,b.scoreLayout="page",!k||b.account&&b.account.id||(b.account=k),I(),B(),c.$on("Editor.windowResize",f.bind(this,B)),c.$on("TimelineModale.revision",z),c.$on("score.render",G),c.$on("score.pageRendered",G),c.$on("$destroy",L);var T=!!window.Modernizr.supportsPassiveOption&&{passive:!0};window.addEventListener("scroll",E,T),window.addEventListener("resize",B,T),f(function(){J(),angular.element(".smart-history-sidenav").bind("click",D)},2e3)}function CommentInputDirective(){var a={templateUrl:"/views/editor/_comment_input.html",restrict:"EA",replace:!0,controller:CommentInputDirectiveCtrl,controllerAs:"vm",bindToController:!0,scope:{scoreId:"=",sharingKey:"=",editComment:"=",replyToComment:"=",preloadedUsers:"=",displayActions:"@",commentToPost:"=",customPost:"@"}};return a}function CommentInputDirectiveCtrl(a,b,c,d,e,f,g,h,i,j,k,l){function m(){z.replyToComment&&(z.replyToComment._reply=!1),z.editComment&&(z.editComment._edit=!1)}function n(){0!==z.newComment.length&&(z.addingComment=!0,x(z.newComment).then(function(a){l.put(o(a)).then(function(a){z.newComment="",z.addingComment=!1,a.replyTo=z.replyTo,i.add("score.comment.post"),e.pageTrack("/score/modal/comments/posted"),c.$broadcast("CommentInput.AddSuccess",a)}).catch(function(a){z.addingComment=!1,c.displayErrors(a,null,!0),e.pageTrack("/score/modal/comments/failed"),c.$broadcast("CommentInput.AddError",a)})}))}function o(a){var b={score:z.scoreId,replyTo:z.replyTo};return z.editComment&&(b=z.editComment),b.revision="last",b.sharingKey=z.sharingKey,b.rawComment=z.newComment,b.comment=a,b.mentions=z.mentionedUser,b}function p(){x(z.newComment).then(function(a){z.commentToPost=o(a)})}function q(a){z.textarea||(z.textarea=$("#"+z.inputId),z.textarea.keypress(function(a){13===a.keyCode&&a.preventDefault()})),z.customPost&&p(),"Enter"!==a.key&&13!==a.keyCode||(z.customPost?c.$broadcast("CommentInput.Submit"):z.mentionDropdownOpened||z.addingComment||(z.addComment(),a.preventDefault()))}function r(b){var d=[],e=[];return a.each(b,function(b){if(b.id!==c.account.id){var f=a.findIndex(z.preloadedUsers,{id:b.id});f>=0?(b.type="collaborator",d.push(b)):(b.type="community",e.push(b))}}),a.uniqBy(a.union(d,e),"id")}function s(c){return b(function(d,e){y&&g.cancel(y);var f=z.preloadedUsers||[];0===c.length?z.mentions=r(f.slice(0,10)):z.mentions=r(a.filter(f,function(a){return a.username&&a.username.indexOf(c)>=0||a.name&&a.name.indexOf(c)>=0})),c.length<4?(z.mentionDropdownOpened=!!f.length,d(z.mentions)):y=g(function(){b.all([k.users({q:c}).$promise]).then(function(b){var c=a.sortBy(a.unionBy(z.mentions,b[0],b[1],function(a){return a.username},"username"));z.mentions=r(c.slice(0,10)),z.mentionDropdownOpened=!!c.length,d(z.mentions)}).catch(e)},150)})}function t(a){return z.mentions=[],z.mentionDropdownOpened=!1,"@"+a.username}function u(){j.get({user:z.replyToUser}).$promise.then(function(a){z.newComment+="@"+a.username+" "})}function v(a){return"@["+a.id+":"+a.username+"] "}function w(a){return a.match(/(@[^\s]*)/g)}function x(c){var d=b.defer(),e=a.uniq(w(c)),f={},g=[],h=function(a){f[a.username]=a},i=function(b){a.forEach(b,h)};return a.forEach(e,function(a){var b=a.substring(1);g.push(k.users({q:b}).$promise.then(i))}),b.all(g).finally(function(){a.forEach(e,function(a){var b=a.substring(1),d=f[b];if(d&&d.id){var e=new RegExp(a,"g"),g=v(d);c=c.replace(e,g),z.mentionedUser.push(d.id)}}),z.mentionedUser=a.uniq(z.mentionedUser),d.resolve(c)}),d.promise}var y,z=this;z.replyToComment&&(z.replyTo=z.replyToComment.id,z.replyToUser=z.replyToComment.user,u()),z.inputId="comment-input-"+z.scoreId+"-"+z.replyTo,z.textarea=null,z.newComment="",z.fromUser=c.account,z.inputPlaceholder=z.replyToComment?"flat:score.comments.reply-placeholder":"flat:score.comments.add-placeholder",z.editComment&&(z.newComment=z.editComment.comment),z.mentionedUser=[],z.mentions=[],z.mentionDropdownOpened=!1,z.addComment=n,z.searchUser=s,z.keyPressed=q,z.mentionOnSelect=t,z.cancel=m,h(z.inputId)}function ScoreInlineCommentPopoverDirective(){var a={restrict:"EA",replace:!0,templateUrl:"/views/editor/_popover_inline_comments.html",link:ScoreInlineCommentPopoverDirectiveLink,controller:ScoreInlineCommentPopoverDirectiveCtrl,controllerAs:"vm",bindToController:!0,scope:{interaction:"=",rangeSelect:"="}};return a}function ScoreInlineCommentPopoverDirectiveLink(a,b){function c(){if(d.length>0){var a=d.offset(),c=e.offset(),f=a.top-c.top-18,g=a.left-c.left+30;b.css({top:f,left:g})}}var d=$("#inline-comment-icon-container"),e=$("#svg-content");c(),b.on("$destroy",function(){$(window).unbind("resize",c)}),$(window).resize(c)}function ScoreInlineCommentPopoverDirectiveCtrl(a,b,c,d,e,f,g,h,i,j,k){function l(){b(function(){h(p.inputId)})}function m(){p.interaction.closeInlinePopover(),p.interaction.rangeSelect.reset()}function n(){e.commentToPost&&e.commentToPost.comment&&!e.sendingComment&&(e.sendingComment=!0,b(function(){var b=angular.copy(e.commentToPost),c=a.pickBy(p.collaboratorsToNotify,function(a){return a===!0}),f=p.interaction.rangeSelect.getRange();null!==f&&(b.context=d.score.inlineComments.getParamToAdd(f),b.mentions=a.uniq(a.concat(b.mentions,a.keys(c))),a.isEmpty(b)||k.put(b).then(function(a){e.sendingComment=!1,d.$broadcast("ObjectUpdate.ScoreComment",a),m()}).catch(function(a){e.sendingComment=!1,d.displayErrors(a,null,!0)}))},1))}function o(){d.score.collaborators&&(p.preloadedUsers=[],a.each(d.score.collaborators,function(a){a.user&&a.user.id&&a.user.id!==d.account.id&&p.preloadedUsers.push(a.user)})),l()}var p=this;p.account=d.account,p.scoreId=d.score.id,p.revisionId=d.history.currentRevision||d.history.masterRevision,p.inputId=["comment-input-",p.scoreId,"-",p.revisionId,"-undefined"].join(""),p.preloadedUsers=[],p.sendComment=n,p.cancel=m,p.loadModal=d.loadModal,e.$on("CommentInput.Submit",n),
o()}function ScoreCommentDirective(){var a={templateUrl:"/views/editor/_score_comment.html",restrict:"EA",replace:!0,controller:ScoreCommentDirectiveCtrl,controllerAs:"vm",bindToController:!0,scope:{scoreId:"=",revisionId:"=",sharingKey:"=",comment:"=",deleteComment:"&deleteFunc"}};return a}function ScoreCommentDirectiveCtrl(a,b,c,d,e){function f(){var c=null;b.score&&b.score.id===k.comment.score&&(a.isObject(b.score.user)&&b.score.user.id?c=b.score.user.id:a.isString(b.score.user)&&(c=b.score.user),c&&c.length&&(k.isOwner=k.currentUser.id===c)),b.score.collaborators&&(k.preloadedUsers=[],a.each(b.score.collaborators,function(a){a.user&&a.user.id&&a.user.id!==b.account.id&&k.preloadedUsers.push(a.user)}))}function g(){k.comment._reply=!k.comment._reply,k.comment._reply&&e(["comment-input",k.comment.score,k.comment.revision,k.comment.id].join("-")),b.$broadcast("CommentInput.ReplyTo",k.comment)}function h(){k.comment._reply=!1}function i(a,b){b.id!==k.comment.id&&h()}function j(a,b){b.replyTo===k.comment.id&&h()}var k=this;k.comment._reply=!1,k.currentUser=b.account,k.toggleReplyInput=g,k.preloadedUsers=[],k.isOwner=!1,c.$on("CommentInput.AddSuccess",j),c.$on("CommentInput.ReplyTo",i),f()}function ShortcutDirective(){var a={templateUrl:"/views/editor/_shortcut.html",restrict:"EA",replace:!0,controller:ShortcutDirectiveCtrl,controllerAs:"vm",bindToController:!0,scope:{shortcut:"=",isDrum:"=",darkTheme:"="}};return a}function ShortcutDirectiveCtrl(a,b){var c=this;c.ctrlKeyName=b.trustAsHtml(navigator.userAgent.indexOf("Mac OS X")<0?"Ctrl":"&#x2318;"),c.delKeyName=b.trustAsHtml(navigator.userAgent.indexOf("Mac OS X")<0?"Delete":"&#9003;"),c.altKeyName=b.trustAsHtml(navigator.userAgent.indexOf("Mac OS X")<0?"Alt":"&#8997;");var d=["/img/icons/music/crescendo.svg","/img/icons/music/note_staccato.svg","/img/icons/music/trill.svg"];c.specialPaddingIcon=a.includes(d,c.shortcut.musicIcon)}function SyncScore(){var a={templateUrl:"/views/editor/_sync_score.html",restrict:"EA",replace:!0,controller:SyncScoreController,controllerAs:"vm",bindToController:!0};return a}function SyncScoreController(a,b,c,d,e,f){function g(){t.offlineRW=!0,t.offlineRWTrial="active"}function h(){t.sync.closed=!0}function i(){b.info("SyncScore.SetOnline"),t.sync.wasOffline=!1,t.sync.wasOfflineAt=null,t.sync.wasOfflineFor=0,e.get("trials.offlineRW")&&f.activateTrial({action:"offlineRW"},function(b){a.account.plan.trials=b,a.account.plan.features.offlineRW=!0,e.remove("trials.offlineRW")})}function j(){b.info("SyncScore.SetOffline"),t.sync.processing=!1,t.sync.wasOffline=!0,t.sync.wasOfflineAt||(t.sync.wasOfflineAt=new Date),d(angular.noop)}function k(){!t.offlineRW&&t.sync.wasOfflineAt&&(t.sync.wasOfflineFor=Math.round(Math.abs(new Date-t.sync.wasOfflineAt)/1e3),!u&&t.sync.wasOfflineFor>10&&"unused"===t.offlineRWTrial&&(a.loadModal("editor","offline-upgrade"),u=!0)),j()}function l(){t.sync={wasOffline:!1,wasOfflineAt:null,wasOfflineFor:0,processing:!1,isReady:c.interaction.rightsHandler.values["rt.ready"],executing:!1,finished:!1,closed:!1,n:0,total:0,err:[]}}function m(a,b){b.total>=10&&!b.finished&&(t.sync.processing=!0,t.sync.n=b.n,t.sync.total=b.total,t.sync.finished=!1,d(angular.noop))}function n(){t.sync.processing?(t.sync.n=t.sync.total,t.sync.finished=!0,d(h,5e3),d(l,6e3),d(angular.noop)):l()}function o(a,b){t.sync.err.push(b),n()}function p(a,b){b.total>=10&&!b.finished&&(t.sync.n=b.n,t.sync.total=b.total,t.sync.finished=!1,t.sync.executing=!0,d(angular.noop))}function q(){t.sync.executing?(t.sync.n=t.sync.total,t.sync.finished=!0,d(h,5e3),d(l,6e3),d(angular.noop)):l()}function r(a,b){t.sync.err.push(b),q()}function s(a,b){t.sync.persistedError=b}var t=this,u=!1;t.offlineRW=a.account.plan&&a.account.plan.features.offlineRW,t.offlineRWTrial=a.account.plan&&a.account.plan.trials&&a.account.plan.trials.offlineRW,t.closeSync=h,l(),c.$on("Realtime.Unstack",m),c.$on("Realtime.Unstacked",n),c.$on("Realtime.UnstackError",o),c.$on("Realtime.Executing",p),c.$on("Realtime.Executed",q),c.$on("Realtime.ExecutingError",r),c.$on("Realtime.PersistedError",s),c.$on("Realtime.Online",i),c.$on("Realtime.Offline",j),c.$on("Realtime.ConnectionError",k),c.$on("Account.EnableOfflineRW",g),c.$watch('Interac.rightsHandler.values["rt.ready"]',function(a){t.sync.isReady=a})}function TuningHead(){return{templateUrl:"/views/editor/modal/_modal_tabs_tuning_head.html",restrict:"A",scope:{tuningHead:"=",changed:"="},controller:TuningHeadCtrl}}function TuningHeadCtrl(a){a.stringsList=[];for(var b=0;b<=8;b++)a.stringsList.push({o:b,s:"C",a:0},{o:b,s:"C",a:1},{o:b,s:"D",a:0},{o:b,s:"D",a:1},{o:b,s:"E",a:0},{o:b,s:"F",a:0},{o:b,s:"F",a:1},{o:b,s:"G",a:0},{o:b,s:"G",a:1},{o:b,s:"A",a:0},{o:b,s:"A",a:1},{o:b,s:"B",a:0});a.set=function(b){a.tuningHead["tuning-step"]=b.s,a.tuningHead["tuning-octave"]=b.o,a.tuningHead["tuning-alter"]=b.a,a.changed&&a.changed()}}function CollaboratorsService(a,b,c,d,e,f,g){function h(a){c.displayErrors(a,null,!0)}function i(b,c,d){return a.isArray(c)?k(b,c,d):j(b,c,d)}function j(c,f,i){return b(function(b,j){f||j();var k={score:c};f.item?"group"===f.type?k.group=f.item.id:k.user=f.item.id:"string"==typeof f?k.user=f:k.user=f.id;var l=new g(k);l.aclAdmin=o.canAdmin,l.aclWrite=o.canWrite,i&&!a.isUndefined(i.aclWrite)&&(l.aclWrite=i.aclWrite),i&&!a.isUndefined(i.aclAdmin)&&(l.aclAdmin=i.aclAdmin),l.$add().then(function(a){d.pageTrack("/score/share/collaborator"),e.add("editor.collaboration.add"),d.eventTrack("collaborator.add",{category:"editor.collaboration"}),b(a)}).catch(function(a){h(a),j(a)})})}function k(c,d,e){return b.all(a.map(d,function(a){return j(c,a,e)}))}function l(a,c){return b(function(b,f){g.delete({score:a,collaborator:c}).$promise.then(function(a){e.add("editor.collaboration.rm"),d.eventTrack("collaborator.remove",{category:"editor.collaboration"}),b(a)}).catch(f)})}function m(a){return b(function(b,c){var f={score:a.scoreId,aclAdmin:a.aclAdmin,aclWrite:a.aclWrite};a.collaborator.group?f.group=a.collaborator.group.id||a.collaborator.group:f.user=a.collaborator.user.id||a.collaborator.user;var h=new g(f);h.$add().then(function(a){e.add("editor.collaboration.rights"),d.eventTrack("collaborator.changeRights",{category:"editor.collaboration"}),b(a)}).catch(c)})}var n={add:i,addOne:j,addMultiple:k,remove:l,changeRights:m},o={canRead:!0,canWrite:!0,canAdmin:!1};return n}function EditorHelpService(a,b,c){function d(b){return a.remove(a.difference(b.toLowerCase().match(/[\w]+/g),m),function(a){return a.length>2})}function e(b){var c=[b.title,b.description,b.keywords||""],e=[];return a.forEach(c,function(a){e.push(d(a))}),a.union.apply(a,e)}function f(a){for(var b=0;b<a.length;b++)a[b].color=l.colors[b%l.colors.length];return a}function g(a){return a.title?a:(a.title=i18n.t("help:"+a.key+".title"),a.description=i18n.t("help:"+a.key+".description"),a.keywords=i18n.t("help:"+a.key+".keywords",{defaultValue:""}),a.gif=a.key.replace(".","_")+"_en.gif",a.more&&a.more.indexOf("utm")<0&&(a.more+="?utm_source=flat&utm_medium=help-editor&utm_campaign=flat-help-editor"),a.blog&&a.blog.url&&a.blog.url.indexOf("utm")<0&&(a.blog.url+="?utm_source=flat&utm_medium=help-editor&utm_campaign=flat-help-editor"),a.tokens||(a.tokens=e(a)),a)}function h(b){var d=[];return c.account&&c.account.experience?(b.forEach(function(b){var e=a.find(n,{key:b});e&&e.xps&&0===a.intersection(c.account.experience,e.xps).length&&d.push(e)}),d):d}function i(b){var c=[];return b=d(b),0===b.length?n:(a.forEach(n,function(a){if(a.tokens){var d=!1;a._searchScore=0;for(var e=0;e<b.length;e++)for(var f=0;f<a.tokens.length;f++)if(a.tokens[f].indexOf(b[e])>=0){a._searchScore++,d||(c.push(a),d=!0);break}}}),f(a.orderBy(c,"_searchScore","desc")))}function j(){return b(function(b){var c=function(){return i18n.isInitialized()?void b(f(a.map(n,g))):setTimeout(c,250)};c()})}function k(c){return b(function(b,d){var e=a.findIndex(n,{key:c});e>=0?b(g(n[e])):d()})}var l={query:j,get:k,search:i,propositionsXps:h,colors:["blue","green","orange","purple","brown"]},m=["how","you","your","the","for","and","then"],n=[{key:"editor.shortcuts",modal:["editor","shortcuts"],xps:["help.editor-shortcuts"]},{key:"editor.addnote",xps:["editor.addnote","editor.addnotepercu","editor.addnotetab"]},{key:"editor.changeduration",xps:["editor.addnote","editor.addnotepercu","editor.addnotetab"]},{key:"editor.timesig",xps:["editor.timesignature"]},{key:"editor.keysig",xps:["editor.keysignature"]},{key:"editor.dotted",xps:["editor.dotted"]},{key:"editor.graceNote",xps:["editor.graceNote"]},{key:"editor.slashgrace",xps:["editor.slashgrace"]},{key:"editor.accidental",xps:["editor.accidental"]},{key:"editor.doubleaccidental",xps:["editor.accidental"]},{key:"editor.clef",xps:["editor.addclef"]},{key:"editor.player",xps:["editor.player"]},{key:"editor.pickupmeasure",xps:["editor.pickupmeasure"]},{key:"editor.addmeasure",xps:["editor.addmeasure"]},{key:"editor.measurenumberpolicy",xps:[]},{key:"editor.addvoice",xps:["editor.addvoices"]},{key:"editor.addtempo",xps:["editor.tempo"]},{key:"editor.tienote",xps:["editor.tienote"]},{key:"editor.slur",xps:["editor.addslurs"]},{key:"editor.tuplet",xps:["editor.addtuplet"],more:"https://blog.flat.io/how-to-twist-time-with-tuplets/"},{key:"editor.instruments",xps:["editor.instruments.replace","editor.instruments.rename","editor.instruments.move","editor.instruments.add","editor.instruments.rm","editor.instruments.switch-tabs","editor.instruments.tuning-tabs"]},{key:"editor.staves",xps:["editor.instruments.staves"]},{key:"editor.concertpitch",xps:[]},{key:"editor.paste",xps:["editor.paste"]},{key:"editor.undo",xps:["editor.undo"]},{key:"editor.revert",more:"https://blog.flat.io/introducing-smart-history/"},{key:"editor.inlinecomments",blog:{url:"https://blog.flat.io/get-the-most-of-the-new-inline-comments/",cover:"https://blog.flat.io/content/images/2016/09/photo-1454166155302-ef4863c27e70-copy.jpg",title:"I just came here for the (inline) comments"}},{key:"editor.smarthistory",blog:{url:"https://blog.flat.io/introducing-smart-history/",cover:"https://blog.flat.io/content/images/2016/05/Smart-History-0-1.png",title:"Introducing Smart History"}},{key:"editor.transpose",xps:["editor.transpose"]},{key:"editor.repeat",xps:["editor.addrepeat"]},{key:"editor.rehearsal",xps:"editor.rehearsal"},{key:"editor.endings",xps:["editor.addendings"]},{key:"editor.print",xps:["editor.print"],more:"https://blog.flat.io/print-and-export-the-pdfs-of-your-music-scores-offline/"},{key:"editor.printpart",xps:["editor.print"],more:"https://blog.flat.io/print-and-export-the-pdfs-of-your-music-scores-offline/"},{key:"editor.export",xps:["editor.export.pdf","editor.export.midi","editor.export.mxl","editor.export.xml","editor.export.mp3","editor.export.wav"],more:"https://blog.flat.io/import-and-export-midi-your-music-score/"},{key:"editor.import",xps:["score.import"],more:"https://blog.flat.io/import-and-export-midi-your-music-score/"},{key:"editor.deactivatemetronome",xps:[]},{key:"editor.midistart",xps:["editor.input-midi"],more:"https://blog.flat.io/compose-using-your-midi-devices/"},{key:"editor.midioutput",xps:["editor.output-midi"],blog:{url:"https://blog.flat.io/introducing-the-web-midi-output/",cover:"https://blog.flat.io/content/images/2016/05/Artboard-1-3.png",title:"Introducing the Web MIDI Output: Use any sounds you want with Flat!"}},{key:"editor.volume",xps:["editor.volume-mix"],more:"https://blog.flat.io/mix-table-collaborative/"},{key:"editor.reverb",xps:["editor.reverb"],more:"https://blog.flat.io/mix-table-collaborative/"},{key:"editor.swing",xps:["editor.swing"],more:"https://blog.flat.io/a-little-bit-of-swing/"},{key:"editor.multimeasurerests",xps:["editor.multimeasures-rest"],more:"https://flat.io/updates/574df8fe452c26b1577b548e"},{key:"editor.articulation",xps:["editor.articulation"]},{key:"editor.bow",xps:["editor.technical"]},{key:"editor.pizz",xps:["editor.pizzicato"]},{key:"editor.fermata",xps:["editor.notation"]},{key:"editor.dynamics",xps:["editor.adddynamics"]},{key:"editor.wedges",xps:["editor.addwedge"]},{key:"editor.trill",xps:["editor.addornament"]},{key:"editor.tremolo",xps:["editor.addornament"]},{key:"editor.buzznote",xps:[]},{key:"editor.lyrics",xps:["editor.addlyrics"]},{key:"editor.multilineslyrics",xps:["editor.addlyrics"]},{key:"editor.lyricsspaces",xps:["editor.addlyrics"]},{key:"editor.lyricshyphens",xps:["editor.addlyrics"]},{key:"editor.chords",xps:["editor.addchord"]},{key:"editor.annotation",xps:["editor.word"]},{key:"editor.share",xps:["score.share.twitter","score.share.facebook","score.share.gplus","score.share.pinterest","score.share.copy-link","score.embed.copy-code"]},{key:"editor.sharepeople",xps:["editor.collaboration.add"]},{key:"editor.layout",xps:["editor.score-layout"]},{key:"editor.measuresline",xps:["editor.measuresline"]},{key:"editor.tabs",xps:["editor.instruments.switch-tabs"],more:"https://blog.flat.io/compose-with-guitar-tabs/"},{key:"editor.tuning",xps:["editor.instruments.tuning-tabs"],more:"https://blog.flat.io/tune-your-guitar/"}];return l}function EditorShortcutsService(a,b,c,d,e,f){function g(){return b(function(a,b){e.query().$promise.then(function(b){a(b.editor_shortcuts)}).catch(b)})}function h(){return b(function(a,b){j().then(a).catch(b)})}function i(){return c.score&&c.score.scoreData&&c.score.scoreData["score-partwise"]?a.map(c.score.scoreData["score-partwise"]["part-list"]["score-part"],function(a){return f.identifyFromPart(a).instrument}):[]}function j(){var c=i();return b(function(b,d){g().then(function(d){if(0===c.length)return b(d);var e=Object.keys(l),f=a.omit(d,e);e.forEach(function(a){c.indexOf(l[a])>=0&&(f[a]=d[a])}),b(f)}).catch(d)})}var k={query:g,queryWithContext:h},l={drum_kit:"drumset-1",marchine_bass_drums:"marching-bass-drums",marchine_tenor_drums:"marching-tenor-drums",marchine_cymbals:"marching-cymbals",marchine_snare_drums:"marching-snare-drums",bongos:"bongos",congas:"congas"};return k}function SmartHistoryFactory(a,b,c,d,e,f,g,h,i){function j(b,e){var f,g,h=[],j=new Adagio.edit.common.CancelStack;a.times(b,function(){var a=e?i.redoStack:i.localStack;if(g=a.getLast()){f=Adagio.undo.safe.getReverseActionData(g);for(var b=0;b<f.length;b++)f[b].opts.actionOrigin="local.undo",h.push(f[b]);a.stack.pop()}}),a.forEach(h,function(a){if(h){var b=a.name,d=JSON.parse(JSON.stringify(a.opts));g&&g.redrawList.payload&&j.setPayload(g.redrawList.payload);try{z._adagioData&&z._adagioData[b]&&z._adagioData[b](d,j)}catch(f){var e;f instanceof Adagio.Error.client.ClientError||f instanceof Adagio.Error.value.ValueError||f instanceof Adagio.Error.noChange.NoChangeError?e=new Error("[smart-history] Crash while performing the action ["+a.id+">"+b+"]"):(e=new Error("[smart-history] Legitimate error while performing the action ["+b+"]"),e.level="warning"),e.e=f,e.score=z._score.id,e.revision=z.curr.id,e.actionId=a.id,e.actionName=b,e.actionOpts=d,c.error(e)}}}),e?i.localStack.stack=i.localStack.stack.concat(j.stack):i.redoStack.stack=i.redoStack.stack.concat(j.stack),d.$broadcast("SmartRevision.Updated",{drawStack:j})}function k(){c.info("[SmartHistory] Hightlight Changes",z.curr._actionsHistory.length);var b=[],d={total:z.curr._actionsHistory.length,done:0,error:0};a.forEach(z.curr._actionsHistory,function(a){var e=a.userId||z.curr.user,f={headCssClassesSet:Adagio.Utils.mapUtils.fromPairs([{key:" user_action_"+e,value:!0},{key:" action_"+a.id,value:!0}])};try{i.localStack.setPayload(f),z._adagioData[a.fnc](a.args,i.localStack),d.done+=1,b.push(a)}catch(b){d.error+=1;var g;g=b instanceof Adagio.Error.client.ClientError||b instanceof Adagio.Error.value.ValueError||b instanceof Adagio.Error.noChange.NoChangeError?"[smart-history] Legitimate error while performing the action ["+a.fnc+"]":"[smart-history] Crash while performing the action ["+a.id+">"+a.fnc+"]";var h=new Error(g);h.e=b,h.score=z._score.id,h.revision=z.curr.id,h.actionId=a.id,h.actionName=a.fnc,h.actionOpts=a.args,c.warn(h)}}),z.curr._actionsHistory=b,c.debug("[SmartHistory] HightlightChanges Status: ",d)}function l(b,c){var d=angular.copy(b);d._index=c||a.findIndex(z._score.revisions,{id:b.id}),d._isMaster=0===d._index||t(b),d._collaborators=[],d._actionsHistory=null,d._data=null,d.collaborators.length||d.collaborators.push(z._score.user);for(var e=0;e<d.collaborators.length;e++)z._collaborators[d.collaborators[e]]&&d._collaborators.push(z._collaborators[d.collaborators[e]]);return d}function m(a){return g.getHistory({score:z._score.id,revision:a,sharingKey:z._score.sharingKey}).$promise}function n(a){return h.getData({score:z._score.id,revision:a,sharingKey:z._score.sharingKey},{strategy:"cacheFirst",cache:z._isCollaborator,update:!1})}function o(){var b=[],c=document.createElement("style");c.type="text/css",a.forEach(z._collaborators,function(a,c){a.session&&a.session.color&&(b.push(".user_action_"+c+" { fill: "+a.session.color+" }"),b.push(".user_action_"+c+" line { stroke: "+a.session.color+" }"))}),c.innerHTML=b.join("\n"),document.getElementsByTagName("head")[0].appendChild(c)}function p(a){var b=a._index+1;return b<z.revisions.length?z.revisions[b]:z.revisions[z.revisions.length-1]}function q(a){z.curr._actionsHistory=a,z.curr.id===z.head.id&&(z.head._actionsHistory=a)}function r(a){delete a.$promise,delete a.$resolved,z.curr._data=a,z.curr.id===z.head.id&&(z.head._data=a)}function s(a){delete a.$promise,delete a.$resolved,z.prev._data=a}function t(b){return a.isUndefined(b.autosave)||b.autosave!==!0}function u(a){c.info("[SmartHistory] Undo: ",a),j(a,!1)}function v(a){c.info("[SmartHistory] Redo: ",a),j(a,!0)}function w(){return c.info("[SmartHistory] Restore: ",z._adagioData),e.add("score.restore"),h.create({score:z._score.id,data:JSON.stringify(z._adagioData.exportData()),description:"Restore: "+i18n.t("flat:score.save-default-message"),autosave:!1},{cache:!0})}function x(d){c.info("[SmartHistory] Update: ",d);var e=b.defer(),f=d?a.findIndex(z.revisions,{id:d}):0;f===-1&&(f=0),z.head=z.revisions[0],z.curr=z.revisions[f],z.prev=p(z.curr);var g=[];return g.push(n(z.curr.id).then(r)),g.push(n(z.prev.id).then(s)),g.push(m(z.curr.id).then(q)),b.all(g).then(function(){i.init(),z.curr._actionsHistory&&z.curr._actionsHistory.length?z._adagioData=new Adagio.Data(JSON.parse(JSON.stringify(z.prev._data))):z._adagioData=new Adagio.Data(JSON.parse(JSON.stringify(z.curr._data))),k()}).catch(e.reject).finally(function(){e.resolve(z.curr)}),e.promise}function y(b,c,e){return i.init(),z._score=b,z._collaborators=a.keyBy(e.collaborators,"user.id"),z._isCollaborator=z._collaborators[d.account.id]&&!z._collaborators[d.account.id]._frontendOnly,o(),z.revisions=a.map(z._score.revisions,l),x(c)}var z={init:y,update:x,restore:w,undo:u,redo:v};return z}function CommentFilter(a,b){return function(c){var d=/@\[([^:]*):([^\]]*)\]/g;return a.trustAsHtml(b.flatDisplay(c).replace(d,'<a href="/$2">@$2</a>'))}}angular.module("flat.editor.controllers",[]),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B){function C(){!m||a.account&&a.account.id||(a.account=m),d.search().panel&&(a.editorPanel=d.search().panel),b.displaySmartHistoryBtn=a.account.plan&&(a.account.plan.features&&a.account.plan.features.advancedHistory||a.account.plan.trials&&"unused"===a.account.plan.trials.advancedHistory&&a.account.experience&&a.account.experience.indexOf("score.history")>=0),b.displayPianoKeyboard=l.get("editor.piano-keyboard"),"boolean"!=typeof b.displayPianoKeyboard&&(b.displayPianoKeyboard=document.body.classList.contains("touch")),D(),b.resizeEditor(),e(E)}function D(){var b=l.get("score-view.layout");b&&_.indexOf(["track","page"],b)>=0&&(a.scoreLayout=b);var c=d.search().layout;c&&"track"===c?a.scoreLayout="track":a.scoreLayout||(a.scoreLayout="page"),l.remove("score-view.dpi"),h.debug("[editor] using layout",a.scoreLayout)}function E(){b.interaction.setRealtime(null),b.interaction.rightsHandler.setValue("online",!0),b.interaction.rightsHandler.setValue("score_write",n.rights.aclWrite),a.score=n,n.revisions=o,n.modificationDateRelative=k("fromNow")(n.modificationDate),a.pageTitle=n.title,d.search("sharingKey",n.sharingKey).replace(),a.history={scoreData:null,masterRevision:n.revisions[0].id,currentRevision:c.revision},b.collaborators||(b.collaborators=new x(a.score)),b.isCollaborator=b.collaborators.isCollaborator(),b.interaction.rangeSelect.canComment=b.isCollaborator||"public"!==n.privacy&&b.collaborators.collaborators[a.account.id]&&b.collaborators.collaborators[a.account.id].aclRead,b.rt=new w(n,b.collaborators,b.interaction),b.rt.rt&&(b.rt.rt.uid=a.account.id,b.rt.rt.editorSid=a.editorSid),b.bindRt();var e=s.getData({score:n.id,revision:a.history.masterRevision,sharingKey:c.sharingKey},{strategy:"cacheFirst",cache:!!b.isCollaborator,update:!1});e.then(function(c){return!!a.score&&(h.log("[editor] score revision loaded"),n.scoreData=c,n.scoreRevisionId=a.history.masterRevision,n.scoreDataLoaded=new Date,void(b.collaborators||(b.collaborators=new x(a.score))))}),a.history.currentRevision?b.changeRevision(a.history.currentRevision):b.interaction.rightsHandler.setValue("current_revision",!0),a.account&&a.account.organization&&a.account.plan.quotas.assignments>0&&(n.submissions=r.submissions({id:n.id},function(c){n.submission=null;for(var e=0;e<c.length;e++)d.search().submission===c[e].id&&(n.submission=c[e]);!n.submission&&c.length>0&&(n.submission=c[0],n.submission.creator=p.get({user:n.submission.creator})),"teacher"===a.account.classRole&&n.submission&&b.clickMenuDisplay("submissions")}))}function F(){$(".editor-content").css({"min-height":$(window).height()}),b.interaction.applyZoomAuto()}function G(){return window.innerWidth<770||window.innerHeight<700||window.innerWidth<1150&&document.body.classList.contains("touch")}function H(){if(G())return void(b.headerFull=!1);var c,d,e=$(".global-editor .dashboard-header-nav"),f=$(".dashboard-header"),g=$(".editor");if(e.length>0&&f.length>0)if(b.headerFull){c=g[0]&&g[0].getBoundingClientRect()||{},c.bottom&&c.bottom>0?f.css({top:c.top}):f.css({top:0}),d=e[0].getBoundingClientRect();var h=1+d.top/e.height();h>1?h=1:h<0&&(h=0),e.css({opacity:h}),d.bottom<=0&&(b.headerFull=!1,f.removeAttr("style"),b.$$phase||b.$digest())}else g&&g.length>0&&("page"===a.scoreLayout&&g[0].getBoundingClientRect().top>=-66||"track"===a.scoreLayout&&g[0].getBoundingClientRect().top>=0)&&(b.headerFull=!0,e.css({opacity:1}),H(),b.$$phase||b.$digest())}function I(){b.helpOpened=!0}function J(){b.helpOpened=!1}function K(){b.menuEditor.value=null}function L(){b.rt&&b.rt.reconnect()}function M(a){return _.find(n.revisions,{id:a})}function N(b,c){return c&&(b=c),b===a.scoreLayout||["page","track"].indexOf(b)<0?b:(d.search("layout",b).replace(),a.scoreLayout=b,l.set("score-view.layout",b),void u.add("editor.switch-layout"))}function O(f){if(h.debug("changeRevision:enter",f),b.loaders.score=!0,b.interaction.rangeSelect.reset(),a.history.currentMetadata=b.getRevisionMetadata(f),d.search("revision",f).replace(),b.interaction.rightsHandler.setValue("current_revision",!f),!f)return a.history.adagioData=null,a.history.scoreData=null,a.history.scoreDataLoaded=null,a.history.currentRevision=null,!1;var g=s.getData({score:n.id,revision:f,sharingKey:c.sharingKey},{strategy:"cacheFirst",cache:!!b.isCollaborator,update:!1});return g.then(function(b){a.history.adagioData=null,a.history.scoreData=b,a.history.scoreDataLoaded=new Date,a.history.currentRevision=f,h.debug("changeRevision:success",a.history.currentRevision),e(angular.noop),u.add("score.history")}).catch(function(a){h.error(a),b.changeRevision(null)}),!1}function P(){return!c.revision}function Q(a,c){c&&(a=c);var d={};"string"!=typeof a&&(d=a,a=d.name,delete d.name),!d.onlyOpen&&b.menuEditor.value===a&&angular.equals(d,b.menuEditor.options)?(b.menuEditor.value="",b.interaction.focusKeyboard()):(b.menuEditor.value=a,b.menuEditor.options=d)}function R(){return!!b.interaction.rightsHandler.categoryState.score_write&&void(b.rt&&b.rt.save())}function S(){return a.likedScores&&a.likedScores.indexOf(n.id)>=0}function T(){a.account.plan&&!a.account.plan.features.advancedHistory?"unused"===a.account.plan.trials.advancedHistory?a.loadModal("editor","trial-history"):window.location="/smart-history":d.path("/score/"+n.id+"/history")}function U(){return d.path().indexOf("/history")<0&&d.search("sharingKey",null).replace(),h.debug("[editor] cleanup"),$("#modalIframe").attr("src","about:blank"),b.editorSid!==a.editorSid?void h.debug("[editor] a new editor instance has been created, skipping whole destroy"):void delete a.score}function V(a){v.broadcast(i18n.t(a),{color:"danger"})}function W(){b.interaction.setRealtime(b.rt)}function X(){if(!a.account.id)return window.top.location.href="/auth/signup",!1;a.animateLikeButton=!0;var d=n.likes.total;b.likedByUser()?(r.unlike({id:n.id,sharingKey:c.sharingKey}).$promise.then(function(){a.account.likedScoresCount--,a.likedScores=a.likedScores||[],a.likedScores.splice(a.likedScores.indexOf(n.id),1),n.likes.total=d-1}).catch(function(b){a.displayErrors(b,null,!0)}),i.pageTrack("/score/unstar/"+b.context),u.add("score.unlike")):(r.like({id:n.id,sharingKey:c.sharingKey}).$promise.then(function(){a.account.likedScoresCount++,a.likedScores=a.likedScores||[],a.likedScores.indexOf(n.id)<0&&a.likedScores.push(n.id),n.likesCount=d+1}).catch(function(b){a.displayErrors(b,null,!0)}),i.pageTrack("/score/star/"+b.context),u.add("score.like"))}function Y(){if(!a.flat.modal||"comments"!==a.flat.modal.name)return a.account.id||0!==n.comments.total?void b.interaction.openModal("comments",{scoreId:n.id,revisionId:a.history.currentRevision||a.history.masterRevision,comments:b.scoreComments,collaborators:b.collaborators,sharingKey:c.sharingKey}):(window.location="/auth?next="+d.path(),!1)}function Z(){b.beatsRecording=0,b.counting=!0,b.audio.record(function(){b.beatsRecording++},function(){b.counting=!1})}function aa(){b.isRecording()?b.audio.stopRecord():b.record()}function ba(a){for(var b=[];a>0;)a--,b.unshift(a);return b}function ca(){b.audio.stopRecord()}function da(){return!!b.audio.inputMIDI&&b.audio.inputMIDI.recording}function ea(){b.interaction.focusKeyboard()}function fa(){b.editor_offline=!1}function ga(){b.editor_offline=!0,e(angular.noop)}function ha(e,f){a.history.masterRevision=f.revision,s.get({score:n.id,revision:f.revision,sharingKey:c.sharingKey},{strategy:"cacheFirst",cache:!!b.isCollaborator,update:!1}).then(function(a){f.redraw&&(h.debug("Redraw revision Success"),n.adagioData=null,n.scoreData=a,d.search("revision",null),n.scoreDataLoaded=new Date),n.scoreRevisionId=f.revision}).catch(function(a){f.redraw&&(h.error(a),d.search("revision",null))})}function ia(){b.editor_offline=!0,e(angular.noop)}function ja(){q.get({id:n.id,sharingKey:c.sharingKey},{strategy:"networkOnly",update:!1}).catch(function(a){403===a.status&&(window.top.location.href="/score/"+n.id+"/request-access")})}function ka(){b.scrollEditor(),a.editorPanel&&b.clickMenuDisplay(a.editorPanel),b.rt&&b.rt.init();var e=t.query({score:n.id,sharingKey:c.sharingKey},{strategy:"networkFirst",broadcastUpdate:!0,cache:!!b.isCollaborator}).then(function(a){var c=[],d=[],e=[],f={};_.forEach(a,function(a){a.context?a.resolved?e.push(a):d.push(a):"inline"===a.type&&a.replyTo?(f[a.replyTo]||(f[a.replyTo]=[]),f[a.replyTo].push(a)):c.push(a)}),b.scoreComments=c,b.scoreInlineComments={highlightedId:null,list:d,replies:f,resolved:e}});d.search().m&&b.availableModals.indexOf(d.search().m)>=0?"comments"===d.search().m?e.finally(b.loadCommentsModal):b.interaction.openModal(d.search().m):d.search().p&&b.availablePanels.indexOf(d.search().p)>=0&&Q(d.search().p),a.$broadcast("Editor.rendered"),b.initialized=!0}function la(b,c){a.score&&n.scoreData&&c.id===n.id&&(Object.keys(c).forEach(function(a){n[a]=c[a]}),n.modificationDateRelative=k("fromNow")(n.modificationDate))}function ma(a,c){if(n.id===c.score){var d;c.context||"inline"===c.type?c.replyTo?(b.scoreInlineComments.replies[c.replyTo]||(b.scoreInlineComments.replies[c.replyTo]=[]),d=_.findIndex(b.scoreInlineComments.replies[c.replyTo],{id:c.id}),d>=0?b.scoreInlineComments.replies[c.replyTo][d]=c:b.scoreInlineComments.replies[c.replyTo].push(c)):(d=_.findIndex(b.scoreInlineComments.list,{id:c.id}),c.resolved?(d>=0&&(b.scoreInlineComments.list.splice(d,1),0===b.scoreInlineComments.list.length&&b.clickMenuDisplay("")),b.scoreInlineComments.resolved.push(c)):(d>=0?b.scoreInlineComments.list[d]=c:b.scoreInlineComments.list.push(c),b.scoreInlineComments.highlightedId=c.id)):(d=_.findIndex(b.scoreComments,{id:c.id}),d>=0?b.scoreComments[d]=c:b.scoreComments.unshift(c))}}function na(a,c){if(n.id===c.score&&"inline"===c.type&&c.replyTo){var d=_.findIndex(b.scoreInlineComments.list,{id:c.replyTo});d>=0&&(b.scoreInlineComments.list[d]._reply=!1),b.scoreInlineComments.replies[c.replyTo]||(b.scoreInlineComments.replies[c.replyTo]=[]),b.scoreInlineComments.replies[c.replyTo].push(c)}}function oa(){b.alreadyPlayed||(b.alreadyPlayed=!0,r.played({id:n.id,sharingKey:c.sharingKey},{},function(){},function(){b.alreadyPlayed=!1}))}function pa(a){a.ctrlKey&&(window.requestAnimationFrame(function(a){a>0?b.interaction.zoomIn(.05):b.interaction.zoomOut(.05),e(angular.noop)}.bind(null,Math.max(-1,Math.min(1,a.wheelDelta||-a.detail)))),a.stopImmediatePropagation())}b.availableModals=["delete","export","shre","comments","trial-history","shortcuts","instruments"],b.availablePanels=["assignment","submissions"],b.rt=null,b.counting=!1,b.beatsRecording=0,b.helpOpened=!1,b.editorSid=a.editorSid=Adagio.Utils.uuidUtils.generate(),b.headerFull=!0,b.scoreComments=[],b.loaders={score:!0},b.menuEditor={value:"",isSaving:!1,saveCom:"Quick Save"},b.interaction=new z(n),b.interaction.setZoomAuto(!0),b.audio=b.interaction.audio=new y((void 0),b.interaction),b.keyboard=new A(b.interaction);var qa=document.getElementById("global-editor");qa.addEventListener("keydown",b.keyboard.keyDown.bind(b.keyboard)),b.interaction.rightsHandler=new B,b.interaction.rangeSelect.rightsHandler=b.interaction.rightsHandler,b.initEditor=E,a.addErrors=V,b.openHelp=I,b.closeHelp=J,b.closeMenu=K,b.clickMenuDisplay=Q,b.getRange=ba,b.record=Z,b.stopRecord=ca,b.isRecording=da,b.toggleRecord=aa,b.likeScore=X,b.likedByUser=S,b.saveProcess=R,b.changeRevision=O,b.isMasterRevision=P,b.getRevisionMetadata=M,b.switchScoreLayout=N,b.bindRt=W,b.tryReconnect=L,b.loadCommentsModal=Y,b.openSmartHistory=T,b.resizeEditor=F,b.scrollEditor=H,b.cleanupEditor=U;var ra=!!window.Modernizr.supportsPassiveOption&&{passive:!0};$(window).resize(b.resizeEditor),window.addEventListener("scroll",b.scrollEditor,ra),b.$on("Editor.windowResize",e.bind(this,b.resizeEditor)),b.$on("Toolbar.triggerTool",e.bind(this,b.resizeEditor)),b.$on("Score.Save",b.saveProcess.bind(this)),b.$on("ObjectUpdate.Score",la),b.$on("ObjectUpdate.ScoreComment",ma),b.$on("CommentInput.AddSuccess",na),b.$on("Audio.play",oa),b.$on("Realtime.Online",fa),b.$on("Realtime.Offline",ga),b.$on("Realtime.Revision",ha),b.$on("Realtime.JoinError",ja),b.$on("Realtime.ConnectionError",ia),b.$on("score.render",ka),b.$on("modals.closed",ea),b.$on("Menu.Display",b.clickMenuDisplay.bind(this)),b.$on("Editor.SwitchScoreLayout",b.switchScoreLayout.bind(this));var sa=document.getElementsByClassName("global-editor");if(sa.length>0&&(sa[0].addEventListener("mousewheel",pa,ra),sa[0].addEventListener("DOMMouseScroll",pa,ra)),b.$on("$destroy",U),C(),!G()){var ta=$(".dashboard-header");ta.css({top:0})}}angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorCtrl",a),a.$inject=["$rootScope","$scope","$routeParams","$location","$timeout","$sce","$injector","$log","$analytics","$window","$filter","UxStore","UserData","ScoreData","ScoreRevisionsData","UserV2","ScoreIDB","ScoreV2","ScoreRevisionIDB","ScoreCommentIDB","Experience","MessageService","flat.editor.services.RealTime","flat.editor.services.Collaborators","flat.editor.services.Audio","flat.editor.services.Interaction","flat.editor.services.Keyboard","flat.editor.services.RightsHandler"];
}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k){function l(){if(A.comments.length&&o(A.comments),n(),!G&&F.collaborators[c.account.id]){var b=a.findIndex(A.collaborators,{user:c.account.id});b>=0&&A.collaborators.splice(b,1)}}function m(b){a.isUndefined(A.popoverIsOpen[b])&&(A.popoverIsOpen[b]=!1),a.forEach(A.popoverIsOpen,function(a,c){c!==b&&(A.popoverIsOpen[c]=!1)}),A.popoverIsOpen[b]=!A.popoverIsOpen[b]}function n(){k.query({score:A.scoreId,sharingKey:A.sharingKey},{strategy:"networkFirst",broadcastUpdate:!0,cache:G}).then(function(b){var c=a.filter(b,function(a){return"document"===a.type});o(c)})}function o(b){H=a.keyBy(b,"id"),s(b),c.$broadcast("Editor.windowResize"),i.add("score.comment.list"),g(function(){A.isLoading=!1},1)}function p(b){k.remove({score:A.scoreId,id:b,sharingKey:A.sharingKey}).then(function(b){a.forEach(b,function(b){var c=q(H[b]);A.comments=a.reject(A.comments,{id:b}),A.replies=a.omit(A.replies,b),c.length&&(A.replies[c]=a.reject(A.replies[c],{id:b}))})})}function q(a){return a?a.replyTo?q(H[a.replyTo]):a.id:null}function r(a){var b=q(a);A.replies[b]||(A.replies[b]=[]),A.replies[b].push(a)}function s(b){var c=[],d={};a.forEach(b,function(a){if(a.replyTo){var b=q(a);d[b]||(d[b]=[]),d[b].push(a)}else c.push(a);A.preloadedUsers.push(a.user)}),A.comments=c,A.replies=d,v(),t()}function t(){A.preloadedUsers=a.union(A.preloadedUsers);var c=a.map(A.preloadedUsers,function(a){return j.get({user:a.id||a}).$promise});b.all(c).then(function(b){A.preloadedUsers=a.sortBy(b,"username")}).catch(function(){var b=[];a.forEach(c,function(a){1===a.$$state.status&&b.push(a.$$state.value)}),A.preloadedUsers=a.sortBy(b,"username")})}function u(){I.page+=1,v()}function v(){A.commentsTotalDisplayed=I.perPage*I.page}function w(b,c){H=a.keyBy(c,"id"),s(c)}function x(b,c){H[c.id]=c;var d=a.findIndex(A.comments,{id:c.id});d<0?(c.replyTo?r(c):A.comments.push(c),v()):(A.comments[d]=c,s(A.comments))}function y(){$(".editor-comments-button").removeClass("slideOutDown"),c.hideModal()}function z(){$(".editor-comments-button").addClass("slideOutDown"),h(["comment-input",A.scoreId,A.revisionId,"undefined"].join("-"))}var A=this,B=c.flat.modalData,C=c.score.id,D=B.revision,E=B.comments,F=B.collaborators,G=F.collaborators[c.account.id]&&!F.collaborators[c.account.id]._frontendOnly,H={},I={page:1,perPage:10};A.scoreId=C?C:c.score.id,A.revisionId=D?D:c.history.masterRevision,A.sharingKey=B.sharingKey||c.score.sharingKey,A.popoverIsOpen={},A.isLoading=!0,A.comments=Array.isArray(E)&&E||[],A.replies={},A.preloadedUsers=Object.keys(F.collaborators),A.collaborators=a.values(F.collaborators),A.maxCollaboratorsDisplay=5,A.commentsTotalDisplayed=0,A.deleteFunc=p,A.displayMore=u,A.closePopovers=m,l(),e.search("m","comments"),f.pageTrack("/score/modal/comments"),d.$on("IDBObjectUpdate.ScoreComment",w),d.$on("ObjectUpdate.ScoreComment",x),d.$on("CommentInput.AddSuccess",x),d.$on("CommentInput.ReplySuccess",x),$(".modal").on("hidden.bs.modal",y).on("shown.bs.modal",z).modal("show")}angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalCommentsCtrl",a),a.$inject=["_","$q","$rootScope","$scope","$location","$analytics","$timeout","focus","Experience","UserV2","ScoreCommentIDB"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(a){if("Enter"===a.key&&n.rights.aclWrite)return k()}function j(){n=a.score,n&&n.adagioData&&(b.metaTitle=n.title,b.s.title=n.adagioData.hasTitle()&&n.adagioData.getTitle()||"",b.s.subtitle=n.adagioData.hasSubtitle()&&n.adagioData.getSubtitle()||"",b.s.composer=n.adagioData.hasComposer()&&n.adagioData.getComposerStr()||"",b.s.lyricist=n.adagioData.hasLyricist()&&n.adagioData.getLyricistStr()||"",b.s.rights=n.adagioData.hasRights()&&n.adagioData.getRightsStr()||"",b.orig=angular.copy(b.s),h("modalCreditsTitle"))}function k(){var c=[];(b.metaTitle!==b.s.title||b.s.title!==b.orig.title)&&b.s.title.length>0&&(o&&o.put({id:a.score.id,title:b.s.title},function(){a.score&&(a.score.title=b.s.title)}),c.push({name:"action.SetTitle",opts:{title:b.s.title}})),b.s.subtitle!==b.orig.subtitle&&c.push({name:"action.SetSubtitle",opts:{subtitle:b.s.subtitle}}),b.s.composer!==b.orig.composer&&c.push({name:"action.SetComposer",opts:{composer:b.s.composer}}),b.s.lyricist!==b.orig.lyricist&&c.push({name:"action.SetLyricist",opts:{lyricist:b.s.lyricist}}),b.s.rights!==b.orig.rights&&c.push({name:"action.SetRights",opts:{rights:b.s.rights}}),c.length>0&&b.interaction.do(c,{subStackName:"credit"}),f.pageTrack("/score/modal/credits/done"),$(".modal").modal("hide")}function l(){m&&m(),b.interaction.focusKeyboard(),b.hideModal()}var m,n=a.score,o=g.has("ScoreV2")?g.get("ScoreV2"):null;return b.s={},b.orig={},b.interaction=b.flat.modalData.interaction,b.interaction?(b.save=k,b.pressEnter=i,m=a.$watch("score.adagioData",j),f.pageTrack("/score/modal/credits"),void $(".modal").on("hidden.bs.modal",l).modal("show")):(c.warn("interaction not passed to modal"),l())}angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalCreditsCtrl",a),a.$inject=["$rootScope","$scope","$log","$timeout","$location","$analytics","$injector","focus"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){function h(a){if("Enter"===a.key)return i()}function i(){f.remove({id:b.score.id}).finally(b.goBackToDashboard),e.remove("score-audio.volume:"+b.score.id),g.add("score.delete")}function j(){a.hideModal(),d.pageTrack("/score/modal/delete/done"),"public"===b.score.privacy?a.account.ownedPublicScoresCount--:a.account.ownedPrivateScoresCount--}b.score=b.flat.modalData.score||a.score,b.goBackToDashboard=j,b.delete=i,b.pressEnter=h,d.pageTrack("/score/modal/delete"),$(".modal").on("hidden.bs.modal",a.hideModal).modal("show")}angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalDeleteCtrl",a),a.$inject=["$rootScope","$scope","$location","$analytics","UxStore","ScoreIDB","Experience"]}(),angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalExportCtrl",["_","$analytics","$location","$timeout","$rootScope","$scope","TokenHandler","Instruments","ScoreV2","User","Experience","MessageService","UxStore","focus","flat.editor.services.PDFKit",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){"use strict";var p=Adagio.Utils.partHeaderUtils,q=f.score;if(f.printing=!!f.flat.modalData.printing,f.interaction=f.flat.modalData.interaction,f.format=f.flat.modalData.format,f.pdfFormat=f.flat.modalData.pdf_format,f.rt=f.flat.modalData.rt,f.canUseOptions=e.account.plan&&e.account.plan.features&&e.account.plan.features.exportOptions||!1,"soundtrap"===f.format&&(f.format="midi",f.service="soundtrap"),f.hasTabs=!1,h.get({locale:e.account.locale||"en"},function(b){a.forEach(q.instruments,function(a){var c=a.split(".")[0],d=a.split(".")[1];b.instruments[c][d]&&b.instruments[c][d].clefs&&"TAB"===b.instruments[c][d].clefs[0].sign&&(f.hasTabs=!0)})}),f.printing&&(f.allParts=f.flat.modalData.allParts),$("#modalIframe").attr("src","about:blank"),f.optionValues={paperSize:[{name:"US Letter",value:"US Letter"},{name:"A4",value:"A4"},{name:"A3",value:"A3"}],layout:[{name:i18n.t("flat:account.editor-preferences.page-size.portrait"),value:"portrait",icon:"/img/icons/_common/export_portrait.svg"},{name:i18n.t("flat:account.editor-preferences.page-size.landscape"),value:"landscape",icon:"/img/icons/_common/export_landscape.svg"}]},f.options={layout:"portrait"},f.canUseOptions&&e.account&&e.account.editorPreferences&&e.account.editorPreferences&&(f.options.multiMeasuresRests=!!e.account.editorPreferences.multiMeasuresRests,f.options.hideNonTab=!!e.account.editorPreferences.hideNonTab,f.options.printHideTempo=!!e.account.editorPreferences.printHideTempo),"paper"===f.pdfFormat&&(f.options.paperSize="US Letter"),f.destroy=function(){$(".modal").modal("hide"),e.flat.modal=null,f.exportLoading=q.exporting=!1},f.powerScore=!1,q.collaborators)for(var r=0;r<q.collaborators.length;r++)if(q.collaborators[r].user&&q.collaborators[r].user.isPowerUser){f.powerScore=!0,f.canUseOptions=!0;break}f.pressEnter=function(a){"Enter"===a.key&&(f.exportLoading||(f.format?f.format&&!f.exportingNoParts&&f.exportProcess():(f.format="pdf",$("#btn-export").focus())))},f.exportOptions=function(){var a={};if(f.canUseOptions&&!f.isExportingAllParts()&&f.exportedParts.length>0){a.parts=[];for(var c=0;c<f.exportedParts.length;c++)f.exportedParts[c]&&a.parts.push(c);k.add("editor."+(f.printing?"print":"export")+".parts"),b.pageTrack("/score/modal/"+(f.printing?"printing":"export")+"/partial-parts")}return f.isPDF&&(a.layout=f.options.layout,a.paperSize=f.options.paperSize),a.multiMeasuresRests=f.options.multiMeasuresRests,a.hideNonTab=f.options.hideNonTab,a.hideTempo=f.options.printHideTempo,a.exportBranding=f.options.exportBranding,a.isConcertPitch=f.interaction.config.get().isConcertPitch,f.printing||(a.mimeType="application/octet-stream"),a.multiMeasuresRests&&(k.add("editor.multimeasures-rest"),b.pageTrack("/score/modal/"+(f.printing?"printing":"export")+"/mmr")),a.hideNonTab&&(k.add("editor.hide-non-tab"),b.pageTrack("/score/modal/"+(f.printing?"printing":"export")+"/hnt")),a},f.switchMultiMeasuresRests=function(){e.account&&j.put({editorPreferences:{multiMeasuresRests:f.options.multiMeasuresRests}},function(a){e.account=a})},f.switchHideNonTab=function(){e.account&&j.put({editorPreferences:{hideNonTab:f.options.hideNonTab}},function(a){e.account=a})},f.switchHideTempo=function(){e.account&&j.put({editorPreferences:{printHideTempo:f.options.printHideTempo}},function(a){e.account=a})},f.exportPartsSwitchAll=function(){f.exportPartsAll(!f.isExportingAllParts())},f.isExportingAllParts=function(){return f.exportedParts.length===f.scoreParts.length&&f.exportedParts.indexOf(!1)<0},f.updateExportParts=function(){f.exportingNoParts=f.exportedParts.indexOf(!0)<0,f.exportingAllParts=f.isExportingAllParts()},f.exportPartsAll=function(a){for(var b=0;b<f.scoreParts.length;b++)f.exportedParts[b]=a;f.updateExportParts()},f.exportUrl=function(a){var b=f.exportOptions(),c=window.location.protocol+"//"+window.location.host+"/api/v2/scores/"+encodeURIComponent(q.id)+"/revisions/"+encodeURIComponent(e.history.masterRevision)+"/"+a+"?_=true";return q.sharingKey&&(c+="&sharingKey="+encodeURIComponent(q.sharingKey)),b.parts&&(c+="&parts="+b.parts.join(",")),b.multiMeasuresRests&&(c+="&multiMeasuresRests=true"),b.hideNonTab&&(c+="&hideNonTab=true"),f.printing&&(c+="&printing=true"),c},f.exportRedirect=function(a,b){return"pdf"===a?($(".modal").modal("hide"),q.printing=f.printing,q.exporting=!f.printing,o.generate({properties:q,adagioData:q.adagioData||e.history.adagioData},f.exportOptions(),b)):b(null,f.exportUrl(a))},f.exportCallback=function(a,b,c){if(a||!b)return void(f.exportLoading=!1);var g=q.title;if(f.printing&&"undefined"==typeof InstallTrigger)if(window.navigator.msSaveOrOpenBlob)saveAs(c,g+".pdf");else{var h=$("#modalIframe");h.one("load",function(){h[0].focus(),h[0].contentWindow.print(),$(".modal").modal("hide"),e.flat.modal=null,q.printing=f.exportLoading=!1,d(angular.noop)}),h.attr("src",b)}else{if("pdf"===f.format){if(!f.isExportingAllParts())for(var i=0;i<f.exportedParts.length;i++)f.exportedParts[i]&&f.scoreParts[i]["part-name"].length>0&&(g+=" - "+f.scoreParts[i]["part-name"]);saveAs(c,g+".pdf")}else{if(f.service)return f[f.service](b);window.location=b}f.destroy()}},f.export=function(a){f.format=a,f.printing?f.allParts?f.exportProcess():f.exportLoading=!1:f.interaction.export(a)},f.exportProcess=function(){return e.account.id||f.powerScore||f.service?(f.options.exportBranding=!0,e.account.plan&&e.account.plan.features&&(f.options.exportBranding=e.account.plan.features.exportBranding),f.powerScore&&(f.options.exportBranding=!1),f.exportLoading=q.exporting=!0,b.pageTrack("/score/modal/"+(f.printing?"printing":"export")+"/"+f.format),k.add("editor.export."+f.format),f.exportRedirect(f.format,f.exportCallback)):(window.location="/auth?next="+c.path(),!1)},f.soundtrap=function(){k.add("editor.export.soundtrap"),i.midiLink({id:q.id},function(a){window.location="https://www.soundtrap.com/publicapi/import/midi1/?url="+encodeURIComponent(a.url)+"&title="+encodeURIComponent(q.title),f.destroy()},function(a){e.displayErrors(a,null,!0),f.destroy()})},f.scoreParts=[],f.exportedParts=[],f.unwatchScore=e.$watch("score.scoreData",function(){if(q=e.score,!q||!q.scoreData||!q.scoreData["score-partwise"])return!0;f.unwatchScore(),f.scoreParts=[];for(var a=0;a<q.scoreData["score-partwise"]["part-list"]["score-part"].length;a++){var c=angular.copy(q.scoreData["score-partwise"]["part-list"]["score-part"][a]);c["part-name"]=p.getName(c),f.scoreParts.push(c)}f.exportPartsSwitchAll(),f.printing&&f.allParts?(f.export("pdf"),$(".modal").remove()):(b.pageTrack("/score/modal/"+(f.printing?"printing":"export")),f.rt.save(function(){f.printing&&f.export("pdf"),d(angular.noop)}),f.service||f.scoreParts.length<=1&&f.format&&"pdf"!==f.format?(f.exportProcess(),$(".modal").remove()):$(".modal").on("hidden.bs.modal",function(){f.interaction.focusKeyboard(),e.hideModal()}).modal("show")),k.add("editor."+(f.printing?"print":"export"))}),f.printing&&(f.exportLoading=!0)}]),function(){"use strict";function a(a,b,c,d,e){function f(){return!(a.account.plan&&a.account.plan.features&&a.account.plan.features.copyScore)||($(".modal").remove(),c.path("/score/"+b.score.id+"/fork").search("multipleCopiesAllowed","true"),e.add("score.fork"),!1)}return b.score=b.flat.modalData.score||a.score,!!f()&&(d.pageTrack("/score/modal/fork-upgrade"),e.add("score.fork.intented"),void $(".modal").on("hidden.bs.modal",a.hideModal).modal("show"))}angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalForkCtrl",a),a.$inject=["$rootScope","$scope","$location","$analytics","Experience"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){function h(){g.get(l.key).then(function(a){k.help=a})}function i(){$(".modal").modal("hide")}function j(){if(!l||!l.key)return d.warn("[modal] No key param provided"),$(".modal").remove(),!1}var k=this,l=b.flat.modalData;j(),h(),k.hideDescription=l.hideDescription,k.closeModal=i,e.pageTrack("/score/modal/help"),f.search({m:"help",key:l.key}),$(".modal").modal("show").on("hidden.bs.modal",b.hideModal),c.$on("$destroy",b.hideModal)}angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalHelpCtrl",a),a.$inject=["_","$rootScope","$scope","$log","$analytics","$location","EditorHelpService"]}(),angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalInstrumentsCtrl",["_","$injector","$analytics","$location","$timeout","$rootScope","$scope","focus","UxStore","Instruments","Experience",function(a,b,c,d,e,f,g,h,i,j,k){"use strict";var l=f.score,m=Adagio.Utils.partHeaderUtils,n=$(".modal"),o=b.has("CustomPitchedInstrument")?b.get("CustomPitchedInstrument"):null,p=o&&f.account.plan&&f.account.plan.features&&f.account.plan.features.customInstrument;g.rt=g.flat.modalData.rt,g.audio=g.flat.modalData.audio,g.interaction=g.flat.modalData.interaction,d.search("m","instruments"),c.pageTrack("/score/modal/instruments"),g.changing=-1,g.editing=-1,g.isRename=!1,g.options={layout:"staff"},g.removedInstruments=[],g.interaction.rangeSelect.reset(),g.rt&&g.rt.save(),g.freeInstruments={piano:!0,violin:!0,flute:!0,"alto-saxophone":!0,clarinet:!0,trumpet:!0,trombone:!0,"guitar-nylon":!0,"electric-bass":!0,"choir-aahs":!0,"drumline-cowbell":!0,"drumset-1":!0},g.instruments={},j.get({locale:f.account.locale}).$promise.then(function(b){if(g.instruments=b.instruments,angular.forEach(g.instruments.$sort,function(a){"keyboards"===a.name&&(g.selectedGroup=a)}),f.account.plan.features.restrictedInstruments&&(g.instruments=angular.copy(g.instruments),angular.forEach(g.instruments,function(a){a.$name&&Object.keys(a).forEach(function(b){"object"!=typeof a[b]||g.freeInstruments[b]||(a[b].restricted=!0)})}),angular.forEach(g.instruments.$sort,function(b){b.instruments=a.sortBy(b.instruments,[function(a){return!!g.instruments[b.name][a].restricted}])})),f.organization&&f.organization.capabilities&&f.organization.capabilities.fun===!1){var c=a.findIndex(g.instruments.$sort,["name","special"]);c>=0&&g.instruments.$sort.splice(c,1)}}).then(function(){p&&o.query().$promise.then(function(a){g.instruments.$sort[0]&&"custom"!==g.instruments.$sort[0].name?g.instruments.$sort.unshift({name:"custom",instruments:[]}):g.instruments.$sort[0].instruments=[],g.instruments.custom={$name:i18n.t("flat:score.my-custom-instruments"),icon:"custom"},angular.forEach(a,function(a){var b=a.longname.replace(" ","-").toLowerCase();g.instruments.$sort[0].instruments.push(b),g.instruments.custom[b]=a}),g.selectedGroup=g.instruments.$sort[0]})}),g.scoreParts=[];var q=f.$watch("score.adagioData",function(){if(l=f.score){var a=l.adagioData,b=l.scoreData;if(!a||!b||!b["score-partwise"])return!0;g.scoreParts=[];for(var c=0;c<b["score-partwise"]["part-list"]["score-part"].length;c++){var d=angular.copy(b["score-partwise"]["part-list"]["score-part"][c]);d["part-name"]=m.getName(d),m.hasAbbreviation(d)&&(d["part-abbreviation"]=m.getAbbreviation(d)),d["part-abbreviation"]=d["part-abbreviation"]||"",d.originalIdx=c;var e=a.getMeasure(c,0),h=Adagio.Utils.measureUtils.getWrappedClef(e),i=h.getNbStaves();d.staves=[];for(var j=0;j<i;j++)d.staves.push({staffIdx:j,clef:h.getEntry(j)});d.metas=g.getInstrumentMetasFromPart(d),g.scoreParts.push(d)}g.scorePartsOrig=angular.copy(g.scoreParts,g.scorePartsOrig),g.scoreParts=angular.copy(g.scoreParts)}}),r=f.$watch("history.scoreData",function(){f.history&&f.history.scoreData&&n.modal("hide")});g.getInstrumentMetasFromPart=function(a){var b=j.identifyFromPart(a);return b&&b.group&&b.instrument?(a.metas=g.instruments[b.group][b.instrument],a.metas.group=b.group,a.metas):{}},g.selectGroup=function(a){g.selectedGroup=a},g.getInstrumentPreviewURL=function(a){if(g.selectedGroup&&g.instruments[g.selectedGroup.name][a])return g.instruments[g.selectedGroup.name][a].mp3Url||(g.instruments[g.selectedGroup.name][a].mp3Url=baseurl+"/sounds/instruments-previews/"+a+".mp3"),g.instruments[g.selectedGroup.name][a].mp3Url},g.addInstrument=function(a,b){if(g.instruments[a][b].restricted)return g.powerWarning=!0,!1;if(g.changing>-1)return g.changeInstrument(a,b);var d=g.instruments[a][b],e={"part-name":d.longname,"part-abbreviation":d.shortname,"midi-instrument":{},newInstrument:d,newInstrumentGroup:a,staves:[]};d.midichannel&&d.midichannel.default&&d.midichannel.default.program&&(e["midi-instrument"]["midi-program"]=d.midichannel.default.program),e.metas=d,e.metas.group=a,g.scoreParts.push(e),g.adding=!1,c.eventTrack("instruments.add",{category:"editor.ui",label:d.longname})},g.pressEnter=function(a){if("Enter"===a.key&&!(g.changing>-1||g.editing>-1)&&f.score.rights.aclWrite)return g.adding?void(g.adding=!1):g.save()},g.replaceInstrument=function(a){g.changing=a},g.renameInstrument=function(a){g.editing=a,g.scoreParts[g.editing].oldPartName=g.scoreParts[g.editing]["part-name"],g.scoreParts[g.editing].oldPartAbs=g.scoreParts[g.editing]["part-abbreviation"],g.edit=g.scoreParts[g.editing],h("instrument-name-"+a)},g.renameProcess=function(){g.backRename(),g.edit=void 0,c.eventTrack("instruments.rename",{category:"editor.ui"})},g.backRename=function(){g.editing=-1},g.removeInstrument=function(a){c.eventTrack("instruments.remove",{category:"editor.ui",label:g.scoreParts[a]["part-name"]}),g.scoreParts[a].newInstrument||g.removedInstruments.indexOf(g.scoreParts[a]["part-name"])!==-1||g.removedInstruments.push(g.scoreParts[a]["part-name"]),g.scoreParts.splice(a,1)},g.isDrumset=function(a){var b=m.getMIDIInstruments(a);return b.length>0&&"10"===b[0]["midi-channel"]},g.hasTabsSupport=function(a){return a.metas&&a.metas.clefs&&a.metas.clefs.length&&"TAB"===a.metas.clefs[0].sign},g.hasTunningSupport=function(a,b){return a.metas&&a.metas.clefs&&a.metas.clefs.length&&"TAB"===a.metas.clefs[0].sign&&a.metas.details["staff-tuning"]&&[4,5,6].indexOf(a.metas.details["staff-tuning"].length)>=0&&g.hasTabsEnabled(b)},g.hasTabsEnabled=function(a){return"undefined"!=typeof g.scoreParts[a].withTabs?g.scoreParts[a].withTabs:!g.scoreParts[a].newInstrument&&(l.adagioData&&l.adagioData.isPartTab(g.scoreParts[a].originalIdx))},g.switchTabs=function(a){if(g.scoreParts[a].withTabs=!g.hasTabsEnabled(a),!g.scoreParts[a].newInstrument){var b=g.getInstrumentMetasFromPart(g.scoreParts[a]);b&&(g.scoreParts[a].replace=b)}k.add("editor.instruments.switch-tabs"),c.eventTrack("instruments.tabs."+(g.scoreParts[a].withTabs?"enable":"disable"),{category:"editor.ui",label:g.scoreParts[a]["part-name"]})},g.changeTuning=function(a){g.save(),g.interaction.openModal("tabs-tuning",{partIdx:a})},g.changeInstrument=function(a,b){var c=g.instruments[a][b];g.scoreParts[g.changing]["part-name"]=c.longname,g.scoreParts[g.changing]["part-abbreviation"]=c.shortname,g.scoreParts[g.changing].newInstrument?(g.scoreParts[g.changing].newInstrument=c,g.scoreParts[g.changing].newInstrumentGroup=a):g.scoreParts[g.changing].replace=c,c.midichannel&&c.midichannel.default&&c.midichannel.default.program&&(g.scoreParts[g.changing]["midi-instrument"]={},g.scoreParts[g.changing]["midi-instrument"]["midi-program"]=c.midichannel.default.program),g.scoreParts[g.changing].metas=g.getInstrumentMetasFromPart(g.scoreParts[g.changing]),delete g.scoreParts[g.changing].withTabs,g.changing=-1},g.renameChange=function(){g.isRename=!(g.instrumentNameOrg===g.instrumentName&&g.instrumentAbs===g.instrumentAbsOrg)},g.sortableOptions={update:function(a,b){if(g.editing>=0)return b.item.sortable.cancel()}},g.addStave=function(b){var c={added:!0,clef:{}},d=a.filter(b.staves,function(a){return!a.removed});1===d.length?"F"===d[0].clef.sign?(c.clef.sign="G",b.staves.unshift(c)):(c.clef.sign="F",b.staves.push(c)):(c.clef.sign="G",b.staves.push(c))},g.removeStave=function(b,c,d){d.removed=!0,0===a.filter(b.staves,function(a){return!a.removed}).length&&g.removeInstrument(c)},g.createPart=function(a,b){var c=b.clefs,d={partIdx:a,partName:b.longname,instrumentName:b.longname,abbreviation:b.shortname,staves:[],MIDIProgram:b.midichannel.default.program,redraw:!1};c[0]&&"TAB"===c[0].sign&&(c=b.alternativeClef);for(var e=0;e<c.length;e++)d.staves.push({clef:c[e],transpose:{chromatic:b.transposechromatic%12||0,diatonic:b.transposediatonic%7||0,"octave-change":b.transposechromatic<0?Math.ceil(b.transposechromatic/12)||0:Math.floor(b.transposechromatic/12)||0}}),g.scoreParts[a]&&g.scoreParts[a].withTabs&&b.details&&(d.staves[e].staffDetails=b.details);return d},g.save=function(){var a,b,d,e,h,j=0,k=[],l=i.get("score-audio.volume:"+f.score.id)||{},m=l.parts instanceof Array,o={};if(q&&(q(),q=null),m)for(a=0;a<g.scorePartsOrig.length;a++)e=g.scorePartsOrig[a].$id,o[e]={volume:l.parts[a],reverb:l.reverbs[a],solo:l.soloMode[a]};for(g.interaction.cursor.resetPos(),g.interaction.changeCursor(g.interaction.cursor.getPosition()),g.interaction.domCache.cleanCacheHead(),a=0;a<g.scoreParts.length;a++)if(!g.scoreParts[a].$id){if(b=g.scoreParts[a].newInstrument,"unpitched-percussion"===g.scoreParts[a].newInstrumentGroup||b.drumset){for(j=0;j<b.instruments.length;j++)b.instruments[j].MIDIProgram=b.midiprogram||1;k.push({name:"action.AddPartPercu",opts:{name:b.longname,abbreviation:b.shortname,partIdx:a,instrumentsList:b.instruments,pitchMapping:b.mapping,nbStaffLines:b.lines}})}else if(b.ensemble){for(h in b.instruments)b.instruments.hasOwnProperty(h)&&k.push({name:"action.AddPart",opts:g.createPart(a+j++,b.instruments[h])});j--}else k.push({name:"action.AddPart",opts:g.createPart(a+j,b)});g.scorePartsOrig.splice(a,0,g.scoreParts[a])}for(a=g.scorePartsOrig.length;a--;){var p=!1;for(j=0;j<g.scoreParts.length;j++)if(g.scoreParts[j].$id===g.scorePartsOrig[a].$id){p=!0;break}p||(g.scorePartsOrig.splice(a,1),k.push({name:"action.RemovePart",opts:{partIdx:a}}))}for(a=0;a<g.scoreParts.length;a++)if(!m||g.scoreParts[a].$id){e=g.scoreParts[a].$id;var r=null;for(j=0;j<g.scorePartsOrig.length;j++)if(e===g.scorePartsOrig[j].$id){r=j;break}m&&null!==r&&(l.parts[a]=o[e].volume,l.reverbs[a]=o[e].reverb,l.soloMode[a]=o[e].solo),null!==r&&r!==a&&(g.scorePartsOrig.splice(r,1),g.scorePartsOrig.splice(a,0,g.scoreParts[a]),k.push({name:"action.MovePart",opts:{fromPartIdx:r,toPartIdx:a}}))}else l.parts[a]=1,l.reverbs[a]=0,l.soloMode[a]=!1;for(m&&(l.parts instanceof Array&&l.parts.splice(g.scoreParts.length),l.reverbs instanceof Array&&l.reverbs.splice(g.scoreParts.length),l.soloMode instanceof Array&&l.soloMode.splice(g.scoreParts.length),i.set("score-audio.volume:"+f.score.id,l)),a=0;a<g.scoreParts.length;a++)g.scoreParts[a].replace&&(b=g.scoreParts[a].replace,d={partIdx:a,instrumentName:b.longname,partName:b.longname,abbreviation:b.shortname,transpose:{chromatic:b.transposechromatic%12||0,diatonic:b.transposediatonic%7||0,"octave-change":b.transposechromatic<0?Math.ceil(b.transposechromatic/12)||0:Math.floor(b.transposechromatic/12)||0}},b.midichannel&&(d.MIDIProgram=b.midichannel.default.program),g.scoreParts[a].withTabs&&b.details&&(d.staffDetails=[b.details]),k.push({name:"action.ChangeInstrument",opts:d})),"string"==typeof g.scoreParts[a].oldPartName&&k.push({name:"action.ChangePartName",opts:{partIdx:a,partName:g.scoreParts[a]["part-name"],partAbbreviation:g.scoreParts[a]["part-abbreviation"]}});for(a=0;a<g.scoreParts.length;a++){var s,t=g.scoreParts[a];if(t.staves){for(j=0;j<t.staves.length;j++)s=t.staves[j],s.added&&k.push({name:"action.AddStaff",opts:{partIdx:a,staffIdx:j,clef:s.clef}});for(j=t.staves.length-1;j>=0;j--)s=t.staves[j],s.removed&&(s.adding||"undefined"==typeof s.staffIdx||k.push({name:"action.RemoveStaff",opts:{partIdx:a,staffIdx:s.staffIdx}}),t.staves.splice(j,1))}}k.length>0&&g.interaction.do(k,{subStackName:"instruments",onErrorUndoSubstack:!0,callback:function(){g.rt&&g.rt.save({message:"flat:score.save-instruments-message"},function(){g.interaction.domCache.cleanCacheHead(),c.pageTrack("/score/modal/instruments/done"),g.audio.reloadInstruments()})}}),n.modal("hide")},n.on("hidden.bs.modal",function(){q&&(q(),q=null),r&&(r(),r=null),g.interaction.focusKeyboard(),g.hideModal()}).modal("show")}]),angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalKeySelectionCtrl",["$analytics","$scope","$timeout",function(a,b,c){"use strict";var d=$(".modal"),e=b.flat.modalData.interaction;b.clef=null,b.clefs=[{l:"G",n:2},{l:"G",n:2,o:1},{l:"G",n:2,o:2},{l:"G",n:2,o:-1},{l:"G",n:2,o:-2},{l:"G",n:2,o:1},{l:"F",n:4},{l:"F",n:4,o:1},{l:"F",n:4,o:2},{l:"F",n:4,o:-1},{l:"F",n:4,o:-2},{l:"F",n:3},{l:"F",n:5},{l:"C",n:1},{l:"C",n:2},{l:"C",n:3},{l:"C",n:4},{l:"C",n:5}],d.on("hidden.bs.modal",function(){e.focusKeyboard(),b.hideModal()}).modal("show"),b.getClefSvg=function(a){return"/img/icons/music/keysel-"+a.l.toLowerCase()+a.n+(a.o||0)+".svg"},b.setClef=function(a){b.clef&&(b.clef.selected=!1),a.selected=!0,b.clef=a,c(function(){$("#modal-cta").focus()},1)},b.save=function(){if(b.clef){var c=Adagio.Utils.clefUtils.create(b.clef.l,b.clef.n);"undefined"!=typeof b.clef.o&&Adagio.Utils.clefUtils.setOctaveChange(c,b.clef.o),e.AddClef(c),a.pageTrack("/score/modal/keysignature/done"),d.modal("hide")}},b.pressEnter=function(a){if("Enter"===a.key&&b.clef)return b.save()},a.pageTrack("/score/modal/keyselection")}]),angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalKeySignatureCtrl",["$analytics","$scope","Experience",function(a,b,c){"use strict";var d=$(".modal"),e=b.flat.modalData.interaction;d.on("hidden.bs.modal",function(){e.focusKeyboard(),b.hideModal()}).modal("show"),b.getKeySignIcon=function(a,b){return"/img/icons/music/keysign-"+a+b+".svg"},b.setKeySignature=function(f,g){"b"===g&&(f=-f),b.concertPitch?e.SetKeyFull(f,b.changeKey):e.SetKey(f,b.changeKey),a.pageTrack("/score/modal/keysignature/done"),c.add("editor.keysignature"),d.modal("hide")},b.changeKey=Adagio.edit.values.KeyTranspose.NONE,b.concertPitch=!0,a.pageTrack("/score/modal/keysignature")}]),angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalLayoutCtrl",["$analytics","$timeout","$rootScope","$scope","User","flat.editor.services.PageLayout",function(a,b,c,d,e,f){"use strict";var g,h,i=c.score,j=$(".modal"),k=d.flat.modalData.interaction;d.rt=d.flat.modalData.rt;var l=6.53,m=Adagio.Utils.pageMarginUtils.TYPE_BOTH;j.on("hidden.bs.modal",function(){g&&g(),h&&h(),d.hideModal(),k.focusKeyboard()}).modal("show"),d.prefs=c.account.editorPreferences=c.account.editorPreferences||{},d.canCustomizeLayout=c.account.plan&&c.account.plan.features&&c.account.plan.features.customLayout||!1,d.orig={},d.pressEnter=function(a){if("Enter"===a.key&&!d.pageLayout.$invalid)return d.save()},g=c.$watch("score.adagioData",function(){if(i=c.score,i&&i.adagioData){d.notesSpacingCoeff=i.adagioData.getNotesSpacingCoeff().toString(),d.userUnit=f.userUnit(),d.pageLayoutPresets=f.presetsToUser(),i.adagioData.hasPageSize()&&(d.pageHeight=Math.round(i.adagioData.getPageHeightAsMillimeters()),d.pageWidth=Math.round(i.adagioData.getPageWidthAsMillimeters()),d.pagePreset=f.sizeToPreset(d.pageHeight,d.pageWidth)),d.pagePreset||(d.pagePreset=f.userPreset(),d.pageHeight=f.preset[d.pagePreset[0]].height,d.pageWidth=f.preset[d.pagePreset[0]].width,d.canCustomizeLayout&&(d.pagePreset=["custom","portrait"])),d.measureNumberPolicy=i.adagioData.getMeasureNumberingPolicy(),d.pageHeight=f.mmToUser(d.pageHeight),d.pageWidth=f.mmToUser(d.pageWidth),i.adagioData.hasScaling()?(d.scoreScaling=i.adagioData.getMillimetersScaling()/l,d.scoreScaling<.9?d.scoreScaling=.75:d.scoreScaling>1.2?d.scoreScaling=1.5:d.scoreScaling=1,d.orig.scoreScaling=d.scoreScaling):(d.scoreScaling=d.getPrefScaling(),d.orig.scoreScaling=null),d.orig.maxNbMeasuresPerLine=d.maxNbMeasuresPerLine=i.adagioData.getSystemBreakPolicy().maxNbMeasuresPerLine,d.scoreScaling=d.scoreScaling.toString(),d.pageSize=d.pagePreset[0],d.pageOrientation=d.pagePreset[1],i.adagioData.hasPageSize()&&(d.orig.pageSize=d.pageSize.toString(),d.orig.pageOrientation=d.pageOrientation);try{d.orig.pageMarginTop=d.pageMarginTop=Math.round(100*f.mmToUser(i.adagioData.getOddPageTopMarginAsMillimeters()))/100,d.orig.pageMarginBottom=d.pageMarginBottom=Math.round(100*f.mmToUser(i.adagioData.getOddPageBottomMarginAsMillimeters()))/100,d.orig.pageMarginRight=d.pageMarginRight=Math.round(100*f.mmToUser(i.adagioData.getOddPageRightMarginAsMillimeters()))/100,d.orig.pageMarginLeft=d.pageMarginLeft=Math.round(100*f.mmToUser(i.adagioData.getOddPageLeftMarginAsMillimeters()))/100}catch(a){d.pageMarginTop=f.userMargin("Top"),d.pageMarginBottom=f.userMargin("Bottom"),d.pageMarginLeft=f.userMargin("Left"),d.pageMarginRight=f.userMargin("Right")}}}),h=c.$watch("history.scoreData",function(){c.history&&c.history.scoreData&&j.modal("hide")}),d.getPrefScaling=function(){var a=d.prefs.scoreScaling||c.defaultValues.scoreScaling;return a=20===a?.75:40===a?1.5:1},d.usePreferred=function(){d.pagePreset=f.userPreset(),d.pageSize=d.pagePreset[0],d.pageOrientation=d.pagePreset[1],d.scoreScaling=d.getPrefScaling().toString(),d.pageMarginTop=f.userMargin("Top"),d.pageMarginBottom=f.userMargin("Bottom"),d.pageMarginLeft=f.userMargin("Left"),d.pageMarginRight=f.userMargin("Right"),d.needSave=!0},d.save=function(){var g=!1,h={},n=[];if(n.push({name:"action.SetScaling",opts:{millimeters:parseFloat(d.scoreScaling)*l,tenths:40}}),d.orig.scoreScaling!==parseFloat(d.scoreScaling)&&(g=!0),parseFloat(d.notesSpacingCoeff)!==i.adagioData.getNotesSpacingCoeff()&&n.push({name:"action.SetNotesSpacingCoeff",opts:{coeff:parseFloat(d.notesSpacingCoeff)}}),d.measureNumberPolicy!==i.adagioData.getMeasureNumberingPolicy()&&n.push({name:"action.SetMeasureNumberingPolicy",opts:{policy:d.measureNumberPolicy}}),g||d.orig.pageOrientation!==d.pageOrientation||d.orig.pageSize!==d.pageSize||"custom"===d.pageSize){if("custom"===d.pageSize){if(d.canCustomizeLayout){var o=Math.max(f.userToMm(d.pageWidth),50),p=Math.max(f.userToMm(d.pageHeight),50);
n.push({name:"action.SetPageSize",opts:{width:o,height:p}}),h.pageWidth=o,h.pageHeight=p}}else{var q=f.userToPreferences(d.pageSize,d.pageOrientation);q&&void 0!==q.height&&void 0!==q.width&&(n.push({name:"action.SetPageSize",opts:{width:q.width,height:q.height}}),h.pageWidth=q.width,h.pageHeight=q.height,d.pageWidth=f.mmToUser(q.width),d.pageHeight=f.mmToUser(q.height))}g=!0}if(g||d.orig.pageMarginTop!==d.pageMarginTop){var r=f.userToMm(Math.max(Math.min(d.pageHeight/2,d.pageMarginTop),.01));n.push({name:"action.SetTopMargin",opts:{millimeters:r,type:m}}),h.pageMarginTop=r}if(g||d.orig.pageMarginBottom!==d.pageMarginBottom){var s=f.userToMm(Math.max(Math.min(d.pageHeight/2,d.pageMarginBottom),.01));n.push({name:"action.SetBottomMargin",opts:{millimeters:s,type:m}}),h.pageMarginBottom=s}if(g||d.orig.pageMarginLeft!==d.pageMarginLeft){var t=f.userToMm(Math.max(Math.min(d.pageWidth/2,d.pageMarginLeft),.01));n.push({name:"action.SetLeftMargin",opts:{millimeters:t,type:m}}),h.pageMarginLeft=t}if(g||d.orig.pageMarginRight!==d.pageMarginRight){var u=f.userToMm(Math.max(Math.min(d.pageWidth/2,d.pageMarginRight),.01));n.push({name:"action.SetRightMargin",opts:{millimeters:u,type:m}}),h.pageMarginRight=u}if(g||d.orig.maxNbMeasuresPerLine!==d.maxNbMeasuresPerLine){var v=Math.min(Math.max(Math.round(d.maxNbMeasuresPerLine),1),16);n.push({name:"action.SetSystemBreakPolicy",opts:{config:{maxNbMeasuresPerLine:v,forbiddenCounts:{}}}}),h.maxNbMeasuresPerLine=v}n.length>0&&k.do(n,{subStackName:"layout",callback:function(){d.rt&&b(function(){d.rt.save("Update page layout")},200);var f=c.account.editorPreferences&&c.account.editorPreferences.zoom;e.put({editorPreferences:h},function(a){c.account=a,c.account.editorPreferences.zoom=f}),"track"===c.scoreLayout&&k.switchScoreLayout("page"),a.pageTrack("/score/modal/layout/done")}}),j.modal("hide")}}]),angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalLeaveCtrl",["$rootScope","$scope","$location","$analytics","UxStore","CollaboratorV2","PersistenceService",function(a,b,c,d,e,f,g){"use strict";var h=b.flat.modalData.score||a.score;d.pageTrack("/score/modal/leave"),$(".modal").on("hidden.bs.modal",a.hideModal).modal("show"),b.goBackToDashboard=function(){a.hideModal(),d.pageTrack("/score/modal/leave/done"),a.$broadcast("reloadScore")},b.leave=function(){f.delete({score:h.id,collaborator:a.account.id},function(){g.scores.removeDeep(h.id).finally(function(){a.$broadcast("ObjectDelete.Score",h.id),b.goBackToDashboard()})},b.goBackToDashboard),e.remove("score-audio.volume:"+h.id)},b.pressEnter=function(a){if("Enter"===a.key)return b.leave()}}]),function(){"use strict";function a(a,b,c,d,e,f){function g(){$(".modal").modal("hide")}function h(){b.account.plan.trials.offlineRW="active",b.account.plan.features.offlineRW=!0,b.$broadcast("Account.EnableOfflineRW"),f.set("trials.offlineRW",new Date),i.closeModal()}var i=this;i.closeModal=g,i.activate=h,d.search("m","offline-upgrade"),e.pageTrack("/score/offline-upgrade"),$(".modal").modal("show").on("hidden.bs.modal",b.hideModal),c.$on("$destroy",b.hideModal)}angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalOfflineUpgradeCtrl",a),a.$inject=["$log","$rootScope","$scope","$location","$analytics","UxStore"]}(),angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalPrivacyCtrl",EditorModalPrivacyCtrl),EditorModalPrivacyCtrl.$inject=["$log","$rootScope","$scope","$location","$analytics","MessageService","ScoreIDB","Experience"],angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalRevertCtrl",["$rootScope","$scope","$sce","$analytics","Experience",function(a,b,c,d,e){"use strict";b.description=a.history.currentMetadata.description;var f=b.flat.modalData.rt,g=b.flat.modalData.interaction;$(".modal").on("hidden.bs.modal",function(){b.hideModal(),g.focusKeyboard()}).modal("show"),b.revert=function(){f.revert(a.history.currentRevision),$(".modal").modal("hide"),d.pageTrack("/score/modal/revert/done"),e.add("score.restore")},b.pressEnter=function(a){if("Enter"===a.key)return b.revert()},d.pageTrack("/score/modal/revert")}]),angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalShortcutsCtrl",EditorModalShortcutsCtrl),EditorModalShortcutsCtrl.$inject=["_","$rootScope","$scope","$location","$analytics","$timeout","UxStore","Experience","EditorShortcutsService"],angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalShreCtrl",["$rootScope","$scope","$q","$sce","$location","$analytics","$timeout","$i18next","UserV2","Experience","ScoreV2","MessageService","flat.editor.services.SocialFacebook","flat.editor.services.SocialTwitter","flat.editor.services.SocialPinterest","flat.editor.services.SocialGoogle",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){"use strict";b.scoreTitle=a.score.title,"public"===a.score.privacy||"organizationPublic"===a.score.privacy||"privateLink"===a.score.privacy?b.scoreLink=a.score.htmlUrl:(b.sharingKey=k.generateSharingKey(),b.scoreLink=a.score.htmlUrl+"?sharingKey="+b.sharingKey),b.pressEnter=function(a){if("Enter"===a.key)return b.copyLink()},b.copyLink=function(){b.switchPrivacy("privateLink").then(function(){b.copied=!0,g(function(){$(".modal").modal("hide"),l.broadcast(h("flat:collaborators.sharing-link.copied"),{color:"success"})},2e3),f.pageTrack("/score/share/link-copied/modal-share"),j.add("score.share.copy-link")})},b.shareFb=function(){b.switchPrivacy("public").then(function(){m.shareScore(a.score,a.account),f.pageTrack("/score/share/facebook/modal-share"),j.add("score.share.facebook")})},b.shareTwitter=function(){b.switchPrivacy("public").then(function(){n.shareScore(a.score,a.account),f.pageTrack("/score/share/twitter/modal-share"),j.add("score.share.twitter")})},b.sharePinterest=function(){b.switchPrivacy("public").then(function(){var b=a.score.user.id;b===a.account.id?o.shareScore(a.score,a.account):i.get({user:b},function(b){o.shareScore(a.score,b)}),f.pageTrack("/score/share/pinterest/modal-share"),j.add("score.share.pinterest")})},b.shareGoogle=function(){b.switchPrivacy("public").then(function(){f.pageTrack("/score/share/google-plus"),p.share(b.scoreLink),j.add("score.share.gplus")})},b.goEmbed=function(){b.switchPrivacy("privateLink").then(function(){var b="/developers/embed/generator?score="+a.score.id;a.score.sharingKey&&(b+="&sharingKey="+encodeURIComponent(a.score.sharingKey)),window.open(b),f.pageTrack("/score/share/embed")})},b.switchPrivacy=function(d){return c(function(c){return"public"===a.score.privacy||"privateLink"===a.score.privacy?c():void k.put({id:b.score.id,privacy:d||"public",sharingKey:b.sharingKey}).$promise.then(function(d){a.score.privacy=d.privacy,a.score.htmlUrl=d.htmlUrl,e.search("sharingKey",d.sharingKey).replace(),b.scoreLink=a.score.htmlUrl,"public"!==d.privacy&&"organizationPublic"!==d.privacy||(a.account.ownedPublicScoresCount++,a.account.ownedPrivateScoresCount--),j.add("score.privacy-switch"),c()}).catch(function(b){a.displayErrors(b,null,!0)})})},$(".modal").on("hidden.bs.modal",function(){b.hideModal(),b.flat.modalData.interaction&&b.flat.modalData.interaction.focusKeyboard(),e.search("m",null)}).on("shown.bs.modal",function(){$(".modal-backdrop").remove()}).modal("show"),e.search("m","shre"),f.pageTrack("/score/share")}]),angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalTempoCtrl",["$rootScope","$scope","$timeout","_",function(a,b,c,d){"use strict";function e(a){var b=a.getBoundingClientRect();return{top:b.top,left:b.left,x:b.left+b.width/2,y:b.top+b.height/2}}function f(a){return a.type.indexOf("mouse")===-1&&(a=(a.originalEvent||a).changedTouches[0]),{x:a.clientX,y:a.clientY}}function g(a,b){var c=-(Math.atan2(a.y-b.y,b.x-a.x)-Math.PI/2);return 360*(c>0?c:2*Math.PI+c)/(2*Math.PI)}function h(a){return a<10?a=10:a>350&&(a=350),a}function i(){if(b.data&&b.measureTime){var a=Adagio.Utils.tempoUtils.bpmToQpm(b.bpm,b.durationTypes[b.tempoType],b.tempoTypeDotted?1:0),d=4/b.measureTime["beat-type"]*(60/a);$("#tempoModal #tempoToogleContainer").css("animation","none"),b.audio.transport&&2!==b.audio.getMetronomeMode()&&(b.audio.transport.setMetronomeMode(0),b.audio.transport.stopMetronomeSequence()),s&&c.cancel(s),s=c(function(){b.audio.transport&&2!==b.audio.getMetronomeMode()&&b.audio.transport.scheduleMetronomeSequence({sequences:1/0,clicks:b.measureTime.beats,quarterDuration:d},Dacapo.context.currentTime+.25),$("#tempoModal #tempoToogleContainer").css("animation",d+"s tempo-bounce .25s infinite")},1e3)}}function j(a){for(var b=0;b<w.length;b++)if(!(a<w[b].minDeg||a>w[b].maxDeg))return Math.round(w[b].minTempo+(a-w[b].minDeg)*(w[b].maxTempo-w[b].minTempo)/(w[b].maxDeg-w[b].minDeg))}function k(a){a<40?a=40:a>208&&(a=208);for(var b=0;b<w.length;b++)if(!(a<w[b].minTempo||a>w[b].maxTempo))return Math.round(w[b].minDeg+(a-w[b].minTempo)*(w[b].maxDeg-w[b].minDeg)/(w[b].maxTempo-w[b].minTempo))}function l(a){for(a=-a*(Math.PI/180)-Math.PI/2;a<0;)a+=2*Math.PI;var b=z/2,c=y/2,d=b*Math.cos(a),e=b*Math.sin(a);d>0?d+=c:d=c+d,e=e>0?c-e:c-e,d-=x/2,e-=x/2,t=t||document.getElementById("tempoToogle"),t&&t.setAttribute("transform","translate("+d+","+e+")")}function m(){for(var a=0;a<A.length;a++)if(b.bpm>A[a].minTempo&&b.bpm<=A[a].maxTempo){if(A[a].text===u)return;u=A[a].text;break}u&&(v=v||$('#tempoLabels > [id^="tempo-label-"], #tempoLines > [id^="tempo-line-"]'),v.removeClass("active"),$("#tempo-label-"+u+", #tempo-line-"+u).addClass("active"),v&&0===v.length&&(v=u=void 0))}function n(a){27===a.keyCode?(p.modal("hide"),a.stopPropagation()):13===a.keyCode&&(b.checkInvalidTempo()&&b.save(),a.stopPropagation())}var o=Adagio.Values.DurationType,p=$(".modal"),q=$(".modal-open");b.editMode="measure",b.tempoType="quarter",b.tempoTypeDotted=!1,b.audio=b.flat.modalData.audio,b.interaction=b.flat.modalData.interaction;var r=a.$watch("score.adagioData",function(){var d=a.score&&a.score.adagioData;if(d){if(b.data=d,b.pos=b.interaction.cursor.getPosition(),b.range=b.interaction.rangeSelect.getRange(),b.measureTime=d.getStaffMeasure(b.pos).time,b.tempo=b.data.getRealTempo(b.range&&b.range.startMeasureIdx||b.pos.measureIdx),b.bpm=b.tempo.bpm,b.tempoType=b.adagioDurationTypeToString(b.tempo.durationType),b.tempoTypeDotted=1===b.tempo.nbDots,b.tempoMarksSelected=0,b.range){b.editMode="range";for(var e=b.range.startMeasureIdx;e<b.range.stopMeasureIdx;e++)0!==e&&b.tempoMarksSelected++}else 0===b.pos.measureIdx?b.editMode="score":b.data.getCommonContent().hasOwnTempo(b.pos.measureIdx)&&(b.tempoMarksSelected=1);c(b.updateDisplayFromTempo),r()}});b.durationTypes={whole:o.FULL,half:o.HALF,quarter:o.QUARTER,eighth:o.EIGHT,sixteenth:o.SIXTEENTH},b.adagioDurationTypeToString=function(a){return d.findKey(b.durationTypes,d.partial(d.isEqual,a))||"quarter"},b.selectType=function(a,c){b.tempoType=a,b.tempoTypeDotted=c,i()},b.checkInvalidTempo=function(){return"undefined"==typeof b.bpm?(b.bpm=80,!1):b.bpm<10?(b.bpm=10,!1):!(b.bpm>500)||(b.bpm=500,!1)},b.save=function(){b.checkInvalidTempo();var a={tempo:{bpm:b.bpm,qpm:Adagio.Utils.tempoUtils.bpmToQpm(b.bpm,b.durationTypes[b.tempoType],b.tempoTypeDotted?1:0),durationType:b.durationTypes[b.tempoType],nbDots:b.tempoTypeDotted?1:0}};b.pos=b.interaction.cursor.getPosition(),b.range=b.interaction.rangeSelect.getRange(),"range"===b.editMode&&b.range?(a.startMeasureIdx=b.range.startMeasureIdx,a.stopMeasureIdx=b.range.stopMeasureIdx):"measure"===b.editMode?(a.startMeasureIdx=b.pos.measureIdx,a.stopMeasureIdx=b.data.getCommonContent().getNextOwnTempo(a.startMeasureIdx),null===a.stopMeasureIdx?a.stopMeasureIdx=b.interaction.dataReader.getNbMeasures()-1:a.stopMeasureIdx--):(a.startMeasureIdx=0,a.stopMeasureIdx=b.interaction.dataReader.getNbMeasures()-1),p.modal("hide"),b.interaction.do("action.SetTempo",a)},b.removeMarks=function(){b.pos=b.interaction.cursor.getPosition(),b.range=b.interaction.rangeSelect.getRange();var a=b.range&&b.range.startMeasureIdx||b.pos.measureIdx;if(!(a<=0)){var c={tempo:b.data.getRealTempo(a-1),startMeasureIdx:a};c.stopMeasureIdx=b.data.getCommonContent().getNextOwnTempo(b.range&&b.range.stopMeasureIdx||c.startMeasureIdx),null===c.stopMeasureIdx?c.stopMeasureIdx=b.interaction.dataReader.getNbMeasures()-1:c.stopMeasureIdx--,p.modal("hide"),b.interaction.do("action.SetTempo",c)}};var s,t,u,v,w=[{minDeg:10,maxDeg:100,minTempo:40,maxTempo:60},{minDeg:100,maxDeg:145,minTempo:60,maxTempo:76},{minDeg:145,maxDeg:240,minTempo:76,maxTempo:120},{minDeg:240,maxDeg:305,minTempo:120,maxTempo:160},{minDeg:305,maxDeg:350,minTempo:160,maxTempo:208}],x=16,y=364,z=300,A=[{minTempo:0,maxTempo:60,text:"largo"},{minTempo:60,maxTempo:66,text:"larghetto"},{minTempo:66,maxTempo:76,text:"adagio"},{minTempo:76,maxTempo:108,text:"adante"},{minTempo:108,maxTempo:120,text:"moderato"},{minTempo:120,maxTempo:168,text:"allegro"},{minTempo:168,maxTempo:200,text:"presto"},{minTempo:200,maxTempo:301,text:"prestissimo"}];b.updateTempoFromEvent=function(a,d){var k=f(d),n=e(a),o=g(k,n);o=h(o),b.bpm=j(o),l(o),i(),m(),b.bpm>=208&&$(".tempo-selector input").focus(),c(angular.noop)},b.updateDisplayFromTempo=function(){if(b.bpm){var a=k(b.bpm);l(a),i(),m()}},$(".modal").on("mousedown",".tempo-inhibitor circle, .dropdown-menu",function(a){a.stopPropagation()});var B,C=function(a){B=!0,document.getElementById("tempoToogleContainer").classList.add("focus"),b.updateTempoFromEvent(this,a),a.preventDefault()},D=function(a){B&&b.updateTempoFromEvent(this,a),a.preventDefault()},E=function(a){B=!1,document.getElementById("tempoToogleContainer").classList.remove("focus"),a.preventDefault()};$(".modal").on("mousedown",".tempo-selector > svg",C),$(".modal").on("mousemove",".tempo-selector > svg",D),$(".modal").on("mouseup",".tempo-selector > svg",E),$(".modal").on("mouseleave",".tempo-selector > svg",E),$(".modal").on("touchstart",".tempo-selector > svg",C),$(".modal").on("touchmove",".tempo-selector > svg",D),$(".modal").on("touchend",".tempo-selector > svg",E),p.on("hidden.bs.modal",function(){s&&c.cancel(s),b.audio.transport&&b.audio.transport.stopMetronomeSequence(),a.hideModal(),b.interaction.focusKeyboard(),q&&q.unbind("keyup",n)}).modal("show"),setTimeout(function(){q=$(".modal-open"),q&&q.keyup(n).focus()},1e3)}]),angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalTimeSignatureCtrl",["$analytics","$timeout","$rootScope","$scope","Experience",function(a,b,c,d,e){"use strict";var f=$(".modal"),g=d.flat.modalData.interaction;b(function(){$(".modal-body").find('[data-toggle="tooltip"]').tooltip({delay:{show:200}})},2e3),f.on("hidden.bs.modal",function(){g.focusKeyboard(),d.hideModal()}).modal("show"),a.pageTrack("/score/modal/timesignature"),d.nbChanged=function(){var a=d.buildTime(),b=d.buildDisplayedTime();try{Adagio.Utils.timeUtils.check(a),Adagio.Utils.timeUtils.check(b),delete d.error}catch(a){d.error=c.displayErrors(a,null,!0)}},d.changeNb=function(a,b){["beats","beattype"].indexOf(a)!==-1?d.changed=!0:d.changed||d[a.slice(9,a.length)]!==d[a]||(d[a.slice(9,a.length)]=b),d[a]=b,"displayedbeats"!==a&&"displayedbeattype"!==a||(d.beatCommonTime=!1,d.beatCutTime=!1),d.nbChanged()},d.save=function(){var b=d.buildTime(),c=d.buildDisplayedTime();d.beatCutTime?c.$symbol="cut":d.beatCommonTime&&(c.$symbol="common"),g.SetTime(b,c),g.focusKeyboard(),a.pageTrack("/score/modal/timesignature/done"),f.modal("hide"),d.beats===d.displayedbeats&&d.beattype===d.displayedbeattype||e.add("editor.pickupmeasure")},d.buildTime=function(){return{beats:d.beats,"beat-type":d.beattype}},d.buildDisplayedTime=function(){return{beats:d.displayedbeats,"beat-type":d.displayedbeattype}},d.pressEnter=function(a){if("Enter"===a.key&&!d.error)return d.save()},d.init=function(){var a=g.getMeasureInfo();d.beats=a.time.beats,d.beattype=a.time["beat-type"],d.sign=a.time,d.displayedbeats=a.displayedTime.beats,d.displayedbeattype=a.displayedTime["beat-type"],d.displayedsign=a.displayedTime,d.beatCutTime="cut"===a.displayedTime.$symbol,d.beatCommonTime="common"===a.displayedTime.$symbol},d.init()}]),angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalTimelineCtrl",EditorModalTimelineCtrl),EditorModalTimelineCtrl.$inject=["_","$rootScope","$scope","$analytics","$location"],angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalTransposeCtrl",["$analytics","$location","$timeout","$rootScope","$scope","UxStore","MessageService","flat.editor.services.Config",function(a,b,c,d,e,f,g,h){"use strict";e.interaction=e.flat.modalData.interaction,e.msg="",e.transposeVoice=-1,e.preview={original:{},update:{}},e.preview.original.svg=new Adagio.Brush.Elem("svg"),e.preview.update.svg=new Adagio.Brush.Elem("svg");var i=$(".modal"),j=new Adagio.Drawer.CachedTextMetric(e.preview.original.svg.node()),k="flat_ux.editor.transposition-options";e.pressEnter=function(a){if("Enter"===a.key&&e.form.octave.$valid&&e.form.interval.$valid)return e.doTranspose()},e.updateAction=function(){e.form.octave.$valid&&e.form.interval.$valid&&(e.octave=Math.round(e.octave),e.interval=Math.round(e.interval),e.action=e.available[Math.abs(e.interval)],e.chromatic=e.available[Math.abs(e.interval)][0].chromatic)},e.updatePreview=function(){if(e.form.octave.$valid&&e.form.interval.$valid){var a={partIdx:0,staffIdx:0,voiceIdx:0,startMeasureIdx:e.opts.startMeasureIdx,stopMeasureIdx:e.opts.stopMeasureIdx,checkNotTab:!1,allowDoubleAccidental:!0};e.transposeVoice>=0&&(a.voiceIdx=e.transposeVoice),a=e.buildParam(a),e.drawPreview(a),e.saveLastOptions()}},e.saveLastOptions=function(){var a={interval:e.interval,chromatic:e.chromatic,octave:e.octave,transposeVoice:e.transposeVoice,updateKeys:e.updateKeys,updateHarmonies:e.updateHarmonies};f.set(k,a)},e.restoreLastOptions=function(){var a=f.get(k);a&&"object"==typeof a&&(e.interval=a.interval,e.chromatic=a.chromatic,e.octave=a.octave,e.updateKeys=a.updateKeys,e.updateHarmonies=a.updateHarmonies,e.checkMultiVoicesOption()&&(e.transposeVoice=a.transposeVoice))},e.doTranspose=function(){var b=e.buildParam(e.opts);if(e.transposeVoice>=0){b.voiceIdx=e.transposeVoice;var c=e.interaction.dataReader.convertVoiceIdx(b),d=Adagio.edit.common.timePosIntervalToNoteIdxInterval(e.measuresScroller,e.timePos,c.voiceIdx);b.startMeasureIdx=d.startMeasureIdx,b.stopMeasureIdx=d.stopMeasureIdx,b.startNoteIdx=d.startNoteIdx,b.stopNoteIdx=d.stopNoteIdx}e.interaction.IntervalTranspose(b),a.pageTrack("/editor/modal/transpose/done"),i.modal("hide"),e.interaction.focusKeyboard()},e.getInstrumentName=function(){var a=e.interaction.cursor.getPosition();e.header=e.interaction.data.getPartsHeaders()[a.partIdx],e.instrument=Adagio.Utils.partHeaderUtils.getName(e.header)},e.getSelectedMeasure=function(){if(e.getInstrumentName(),e.range=e.interaction.rangeSelect.getRange(),null===e.range){e.msg=i18n.t("flat:transpose.warn-whole-part",{instrument:e.instrument});var a=e.interaction.cursor.getPosition();a.measureIdx=0,a.noteIdx=0,e.opts.startMeasureIdx=a.measureIdx,e.opts.stopMeasureIdx=e.interaction.dataReader.getNbMeasures()-1,e.opts.startNoteIdx=0;var b=angular.copy(a);b.measureIdx=e.opts.stopMeasureIdx,e.interaction.dataReader.checkVoice(a),e.interaction.dataReader.checkVoice(b),e.opts.stopNoteIdx=e.interaction.dataReader.getNbNotes(b)-1,e.opts.staffIdx=a.staffIdx,e.opts.partIdx=a.partIdx,e.opts.startVoiceIdx=e.interaction.dataReader.convertVoiceIdx(a).voiceIdx,e.opts.stopVoiceIdx=e.interaction.dataReader.convertVoiceIdx(b).voiceIdx}else e.opts=e.range;e.measuresScroller=Adagio.edit.common.getMeasuresScroller(e.interaction.data,{partIdx:e.opts.partIdx}),e.timePos={};var c=e.measuresScroller.getMeasureData(e.opts.startMeasureIdx),d=c.getVoice(e.opts.startVoiceIdx);e.timePos.startTimePos=d.getRangeSpace(0,e.opts.startNoteIdx),e.timePos.startDpq=c.getDpqValue(),c=this.measuresScroller.getMeasureData(e.opts.stopMeasureIdx),d=c.getVoice(e.opts.stopVoiceIdx);var f=d.getNote(e.opts.stopNoteIdx),g=Adagio.Utils.noteUtils.getDuration(f);e.timePos.stopTimePos=d.getRangeSpace(0,e.opts.stopNoteIdx)+g,e.timePos.stopDpq=c.getDpqValue(),e.timePos.startMeasureIdx=e.opts.startMeasureIdx,e.timePos.stopMeasureIdx=e.opts.stopMeasureIdx},e.checkMultiVoicesOption=function(){e.hasMultiVoices=e.interaction.data.hasPartStaffVoiceAtIdx(e.opts.partIdx,e.opts.staffIdx,1)&&e.interaction.data.hasPartStaffVoiceAtIdx(e.opts.partIdx,e.opts.staffIdx,0)},e.initPreview=function(){e.preview.original.elem=document.getElementById("svg-original"),e.preview.original.elem.appendChild(e.preview.original.svg.node()),e.preview.update.elem=document.getElementById("svg-preview"),e.preview.update.elem.appendChild(e.preview.update.svg.node());var a=e.interaction.data.getStaffMeasure({partIdx:e.opts.partIdx,measureIdx:e.opts.startMeasureIdx,staffIdx:e.opts.staffIdx}),b=angular.copy(e.opts);if(e.opts.startMeasureIdx+2<e.interaction.dataReader.getNbMeasures()-1&&e.opts.startMeasureIdx+2<e.opts.stopMeasureIdx){b.stopMeasureIdx=b.startMeasureIdx+2,b.stopNoteIdx=e.interaction.dataReader.getNbNotes({partIdx:e.opts.partIdx,staffIdx:e.opts.staffIdx,voiceIdx:0,measureIdx:b.stopMeasureIdx})-1;var c={partIdx:b.partIdx,staffIdx:b.staffIdx,measureIdx:b.stopMeasureIdx,noteIdx:b.stopNoteIdx,voiceIdx:0};e.interaction.dataReader.checkVoice(c),b.stopVoiceIdx=e.interaction.dataReader.convertVoiceIdx(c).voiceIdx}e.preview.original.data=new Adagio.Data,e.preview.original.data.setNbMeasures(b.stopMeasureIdx-b.startMeasureIdx+1),e.preview.original.data.setTime(a.time),e.preview.original.data.setScaling(6.35,40);var d={partIdx:0,instrumentName:"",MIDIProgram:"1",staves:[a]};e.preview.original.data["action.AddPart"](d);var f=e.interaction.dataReader.data.getStaffContentCrossMeasure(b),g={partIdx:0,staffIdx:0,measureIdx:0,noteIdx:0};g.voiceIdx=e.preview.original.data.getPartStaffVoiceAtIdx(g.partIdx,g.staffIdx,0),g.data=f,e.preview.original.data["action.InsertStaffContentCrossMeasureAtIdx"](g),e.preview.original.config=new h,e.preview.original.config.initFromScoreData(e.preview.original.data),e.preview.original.drawer=new Adagio.track.TrackLayout(e.preview.original.data,90,j,Adagio.assets.smufl.bravura,e.preview.original.config.get()),e.preview.original.drawer.fillNextPage(e.preview.original.svg),e.restoreLastOptions()},e.buildParam=function(a){return a.transpose={},a.transpose.diatonic=e.interval,a.transpose.chromatic=e.interval>=0?e.chromatic:-e.chromatic,a.transpose["octave-change"]=e.octave,a.updateKeys=e.updateKeys,a.updateHarmonies=e.updateHarmonies,a.allowDoubleAccidentals=!0,a},e.drawPreview=function(a){if(e.preview.update.data=new Adagio.Data(e.preview.original.data.exportData()),a)try{a.startMeasureIdx=0,a.stopMeasureIdx=e.preview.update.data.getNbMeasures()-1,a.voiceIdx=e.preview.update.data.getPartStaffVoiceAtIdx(a.partIdx,a.staffIdx,a.voiceIdx),e.transposeVoice===-1?e.preview.update.data["action.TransposeStaff"](a):e.preview.update.data["action.TransposeVoice"](a)}catch(a){if(!(a instanceof Adagio.Error.client.PitchOverflowError||a instanceof Adagio.Error.client.LineOutOfRangeError))throw a;g.broadcast(a.message,{color:"warning"})}e.preview.update.elem.removeChild(e.preview.update.svg.node()),e.preview.update.svg=new Adagio.Brush.Elem("svg"),e.preview.update.elem.appendChild(e.preview.update.svg.node()),e.preview.update.config=new h,e.preview.update.config.initFromScoreData(e.preview.update.data),e.preview.update.drawer=new Adagio.track.TrackLayout(e.preview.update.data,90,j,Adagio.assets.smufl.bravura,e.preview.update.config.get()),e.preview.update.drawer.fillNextPage(e.preview.update.svg)},e.available={0:[{value:"flat:transpose.D-unison",chromatic:-1},{value:"flat:transpose.P-unison",chromatic:0},{value:"flat:transpose.A-unison",chromatic:1}],1:[{value:"flat:transpose.D-second",chromatic:0},{value:"flat:transpose.m-second",chromatic:1},{value:"flat:transpose.M-second",chromatic:2},{value:"flat:transpose.A-second",chromatic:3}],2:[{value:"flat:transpose.D-third",chromatic:2},{value:"flat:transpose.m-third",chromatic:3},{value:"flat:transpose.M-third",chromatic:4},{value:"flat:transpose.A-third",chromatic:5}],3:[{value:"flat:transpose.D-fourth",chromatic:4},{value:"flat:transpose.P-fourth",chromatic:5},{value:"flat:transpose.A-fourth",chromatic:6}],4:[{value:"flat:transpose.D-fifth",chromatic:6},{value:"flat:transpose.P-fifth",chromatic:7},{value:"flat:transpose.A-fifth",chromatic:8}],5:[{value:"flat:transpose.D-sixth",chromatic:7},{value:"flat:transpose.m-sixth",chromatic:8},{value:"flat:transpose.M-sixth",chromatic:9},{value:"flat:transpose.A-sixth",chromatic:10}],6:[{value:"flat:transpose.D-seventh",chromatic:9},{value:"flat:transpose.m-seventh",chromatic:10},{value:"flat:transpose.M-seventh",chromatic:11}]},e.interval=0,e.chromatic=0,e.octave=0,e.updateKeys=!1,e.updateHarmonies=!1,e.action=e.available[e.interval],e.opts={},i.on("hidden.bs.modal",function(){e.hideModal(),e.interaction.focusKeyboard()}).on("shown.bs.modal",function(){e.getSelectedMeasure(),e.initPreview(),e.drawPreview(),e.checkMultiVoicesOption(),c(angular.noop)}).modal("show"),b.search("m","transpose")}]),angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalTuningCtrl",EditorModalTuningCtrl),EditorModalTuningCtrl.$inject=["$rootScope","$scope","$location","$log","$analytics","Experience","focus"],angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalUpdateCtrl",EditorModalUpdateCtrl),EditorModalUpdateCtrl.$inject=["$rootScope","$scope","$log","$analytics","$location"],angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorModalVolumeCtrl",["$analytics","$timeout","$rootScope","$scope","UxStore","Experience","Instruments",function(a,b,c,d,e,f,g){"use strict";var h=c.score,i=Adagio.Utils.partHeaderUtils,j=$(".modal"),k=d.flat.modalData,l=k.interaction,m=k.audio,n="score-audio.volume:"+h.id,o=e.get(n)||{},p="score-audio.swing:"+h.id;j.on("hidden.bs.modal",function(){l.focusKeyboard(),d.hideModal()}).modal("show"),a.pageTrack("/score/modal/volume"),d.editionMode="local",d.soloMode=[],d.initialized=!1,d.changed=!0,d.scoreParts=[];var q=c.$watch("score.scoreData",function(){if(h=c.score,!h||!h.scoreData||!h.scoreData["score-partwise"])return!0;q(),d.swingStatus=e.get(p)||l.dataReader.data.getSwing(0),"object"==typeof d.swingStatus&&(d.swingStatus=!!d.swingStatus.swing),d.scoreParts=[];for(var a=0;a<l.dataReader.data.getNbParts();a++){var f=l.dataReader.data.getPartHeader(a);d.scoreParts.push({name:i.getName(f),group:g.identifyFromPart(f)})}d.scoreParts[0]._displayOptions=!0,b(v)});d.pressEnter=function(a){if("Enter"===a.key)return d.close()},d.setEditionMode=function(a){("remote"!==a||h.rights.aclWrite)&&(d.editionMode=a,d.setSlidersValues())},d.toggleSwing=function(){if(m.toggleSwing(),e.set(p,d.swingStatus),"remote"===d.editionMode){var a;a=d.swingStatus?Adagio.Utils.swingUtils.createSwing(100):Adagio.Utils.swingUtils.createNoSwing(),l.do("action.SetGlobalSwing",{swing:a})}f.add("editor.swing")};var r=function(a,c,f){b(angular.noop);var g=c[f]/100;m.setPartVolume(a,g),o.parts[a]=g,e.set(n,o),"remote"===d.editionMode&&l.do("action.SetPartGlobalVolume",{partIdx:a,volume:parseInt(c[f])})},s=function(a,b){b||(b=0),m.setMasterVolume(a[b]/100),o.master=a[b]/100,e.set(n,o)},t=function(){var a={};return function(b,d,e){if(c.account.plan&&c.account.plan.features.reverbPlayback){a[b]&&a[b].remove();var f=d?d[e]:0;a[b]=$("<style>.reverbSet-"+b+" .noUi-base:before { width: "+f+"% !important; }</style>"),a[b].appendTo($(this))}}}(),u=function(a,g,h){if(c.account.plan&&c.account.plan.features.reverbPlayback){b(angular.noop);var i=g?g[h]:0;o.reverbs[a]=i/100,e.set(n,o),m.setPartReverb(a,i/100),"remote"===d.editionMode&&l.do("action.SetPartGlobalReverberation",{partIdx:a,reverberation:parseInt(i)}),f.add("editor.reverb")}};d.updateSoloMode=function(a){d.soloMode[a]?m.setPartSoloMode(a):m.unsetPartSoloMode(a),o.soloMode=d.soloMode,e.set(n,o)};var v=function(){o.parts=o.parts||[],o.reverbs=o.reverbs||[];for(var a=0;a<d.scoreParts.length;a++){o.parts[a]="undefined"!=typeof o.parts[a]?o.parts[a]:1,o.reverbs[a]="undefined"!=typeof o.reverbs[a]?o.reverbs[a]:0;var b=$(".volumeSet-"+a)[0],c=$(".reverbSet-"+a)[0],e=m.getPartVolume(a),f=m.getPartReverb(a);b&&(noUiSlider.create(b,{start:"undefined"!=typeof e?100*e:100,connect:"lower",orientation:"horizontal",range:{min:0,max:100}}),b.noUiSlider.on("change",r.bind(b,a))),c&&(noUiSlider.create(c,{start:"undefined"!=typeof f?100*f:100,connect:"lower",orientation:"horizontal",range:{min:0,max:100}}),c.noUiSlider.on("update",t.bind(c,a)),c.noUiSlider.on("change",u.bind(c,a))),d.soloMode[a]=m.getPartSoloMode(a)}var g=m.getMasterVolume(),h=$(".masterSet")[0];h&&(noUiSlider.create(h,{start:"undefined"!=typeof g?100*g:100,connect:"lower",orientation:"horizontal",range:{min:0,max:100}}),h.noUiSlider.on("set",s)),d.initialized=!0};d.setSlidersValues=function(){var a;a=m.getMasterVolume(),$(".masterSet")[0].noUiSlider.set("undefined"!=typeof a?100*a:100);for(var b=0;b<d.scoreParts.length;b++){var c,e,f=$(".volumeSet-"+b)[0],g=$(".reverbSet-"+b)[0];if("local"===d.editionMode)c=100*m.getPartVolume(b),e=100*m.getPartReverb(b);else{var h=l.dataReader.data.getPartHeader(b);c=i.getGlobalVolume(h),e=i.getGlobalReverberation(h)}f.noUiSlider.set("undefined"!=typeof c?c:100),g.noUiSlider.set("undefined"!=typeof e?e:0)}},d.applyToOtherMode=function(){if(d.changed!==!1){var a=d.editionMode;"local"===a?d.editionMode="remote":d.editionMode="local";for(var b=0;b<d.scoreParts.length;b++){var c=$(".volumeSet-"+b)[0],e=$(".reverbSet-"+b)[0],f=c.noUiSlider.get(),g=e.noUiSlider.get();r.call(c,b,[f],0),u.call(e,b,[g],0)}d.changed=!1,d.editionMode=a}},d.close=function(){a.pageTrack("/score/modal/volume/done"),j.modal("hide")},f.add("editor.volume-mix")}]),angular.module("flat.editor.controllers").controller("EditorPanelAssignmentCtrl",["$rootScope","$scope","$q","$sce","$analytics","$location","_","Text","UxStore","MessageService","AssignmentV2","AssignmentSubmissionV2","ClassV2",function(a,b,c,d,e,f,g,h,i,j,k,l,m){"use strict";var n,o=b.currentSubmission=a.score.submission,p=b.assignment=a.score.submission&&a.score.submission.assignment||a.score.assignment;b.fetchAssignment=function(b,d){var e=c.defer();return b.id||!d?(e.resolve(b),e.promise):(k.get({class:d.classroom,id:b}).$promise.then(function(a){e.resolve(a)}).catch(function(b){a.displayErrors(b,null,!0)}),e.promise)},b.fetchAssignments=function(){var d=c.defer();return b.classes=m.query(function(){b.assignments=[],async.map(b.classes,function(a,b){k.query({class:a.id},b.bind(this,null),b.bind(this))},function(c,e){if(c)a.displayErrors(c,null,!0);else{for(var f=0;f<e.length;f++)for(var h=0;h<e[f].length;h++)e[f][h].classroom=b.classes[f],e[f][h].submissions&&e[f][h].submissions.length>0&&(e[f][h].submission=e[f][h].submissions[0]),e[f][h].submission&&e[f][h].submission.returnDate||b.assignments.push(e[f][h]);b.assignments=g.orderBy(b.assignments,["dueDate","creationDate"])}d.resolve(b.assignments)})}),d.promise},b.setSubmission=function(c){b.currentSubmission=a.score.submission=o=c},b.setAssignment=function(c){b.assignment=a.score.assignment=c},b.displayAssignment=function(e){var f=c.defer();return b.choosingAssignment=!1,b.fetchAssignment(e,o).then(function(c){p=c,b.setAssignment(p),p.trustedDescription=d.trustAsHtml(h.flatDisplay(p.description)),p.submission=p.submission||p.submissions.length>0&&p.submissions[0]||{},p.submission.attachments=p.submission.attachments||[],b.setSubmission(p.submission);var e=g.findIndex(p.submission.attachments,{score:a.score.id});e<0?(n={type:"flat",score:a.score.id,title:a.score.title,revision:b.assignment.dueDate&&a.history.masterRevision||void 0},p.submission.attachments.push(n)):n=p.submission.attachments[e],f.resolve(b.assignments)}),f.promise},b.removeAttachment=function(a){o.attachments.splice(a,1)},b.submitSubmission=function(){
b.processing=!0,l.put({class:p.classroom.id||p.classroom,assignment:p.id,studentComment:o.studentComment,attachments:o.attachments,submit:!0},function(a){return e.pageTrack("/score/submission/done"),i.remove("google.classroom.failures"),a.googleClassroom?(window.location=a.googleClassroom.alternateLink,!1):(j.broadcast(i18n.t("edu:submission.success-sent"),{color:"success"}),b.setSubmission(a),p.submission=a,b.processing=!1,void b.clickMenuDisplay(""))},function(c){!i.get("google.classroom.failures")&&c.data.message.indexOf("Unable to submit your work on Google Classroom")>=0?(i.set("google.classroom.failures",1),i.set("redirect.next",{path:f.path(),search:{p:"assignment"}}),window.location="/auth/google?classroom=true"):(b.processing=!1,a.displayErrors(c,null,!0),i.remove("google.classroom.failures"))})},b.rt&&b.rt.save(function(a,c){!a&&n&&(n.revision=b.assignment.dueDate&&c||void 0)}),p&&b.displayAssignment(p).then(function(){1===i.get("google.classroom.failures")&&b.submitSubmission()}),b.fetchAssignments(),e.pageTrack("/score/panel/assignment")}]),angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorPanelInlineCommentsCtrl",EditorPanelInlineCommentsCtrl),EditorPanelInlineCommentsCtrl.$inject=["$rootScope","$scope","$sce","$analytics","$timeout","focus","ScoreCommentIDB"],angular.module("flat.editor.controllers").controller("EditorPanelSubmissionsCtrl",["$rootScope","$scope","$sce","$analytics","User","AssignmentV2","AssignmentSubmissionV2",function(a,b,c,d,e,f,g){"use strict";if(a.score.submission){var h=b.currentSubmission=a.score.submission;h.creator.id||(h.creator=e.get({user:h.creator})),b.submissionsToReview=[],b.submissionsReviewed=[],g.query({class:h.classroom,assignment:h.assignment.id||h.assignment}).$promise.then(function(a){for(var c=0;c<a.length;c++){var d=a[c];d.id!==b.currentSubmission.id&&d.submissionDate&&(d.creator=e.get({user:d.creator}),d.returnDate?b.submissionsReviewed.push(d):b.submissionsToReview.push(d))}}).catch(function(b){a.displayErrors(b,null,!0)}),h.assignment.id?b.assignment=h.assignment:h.assignment=b.assignment=f.get({class:h.classroom,id:h.assignment}),b.returnAssignment=function(){b.processing=!0,g.put({class:h.classroom,assignment:h.assignment.id||h.assignment,id:h.id,returnFeedback:h.returnFeedback},function(c){b.currentSubmissionReviewed=!0,b.processing=!1,d.eventTrack("assignment.return",{category:"edu.class"}),a.score.submission=h=c,h.assignment=b.assignment},function(c){b.processing=!1,a.displayErrors(c,null,4)})},d.pageTrack("/score/panel/submission")}}]),angular.module("flat.editor.controllers").controller("flat.editor.controllers.EditorPopoverCollaboratorsCtrl",EditorPopoverCollaboratorsCtrl),EditorPopoverCollaboratorsCtrl.$inject=["_","$timeout","$q","$rootScope","$scope","$log","$location","$filter","focus","MessageService","UserV2","ScoreV2","Follow","ClassV2","Group","CollaboratorV2","CollaboratorService","Search","Experience"],angular.module("flat.editor.controllers").controller("flat.editor.controllers.MidiSetupCtrl",MidiSetupCtrl),MidiSetupCtrl.$inject=["$rootScope","$scope","$location","$log","$q","$timeout","User","FrontendEvent"],angular.module("flat.editor.controllers").controller("flat.editor.controllers.SmartHistoryCtrl",SmartHistoryCtrl),SmartHistoryCtrl.$inject=["_","$rootScope","$scope","$routeParams","$location","$timeout","$sce","$log","$window","Experience","UserData","ScoreData","ScoreRevisionsData","ScoreRevisionIDB","flat.editor.services.SmartHistoryService","flat.editor.services.Collaborators","flat.editor.services.RightsHandler","flat.editor.services.Audio","flat.editor.services.Interaction","flat.editor.services.Keyboard"],angular.module("flat.editor.directives",[]),angular.module("flat.editor.directives").directive("commentInput",CommentInputDirective),CommentInputDirectiveCtrl.$inject=["_","$q","$rootScope","$scope","$analytics","$filter","$timeout","focus","Experience","User","Search","ScoreCommentIDB"],function(){"use strict";function a(){var a={templateUrl:"/views/editor/_help.html",restrict:"EA",replace:!0,controller:b,controllerAs:"vm",bindToController:!0,scope:{isOpen:"="}};return a}function b(a,b,c,d,e,f,g,h,i,j){function k(a){i.add("help.editor.search"),h.pageTrack("/support/editor?search="+a),A.helpFiltered=j.search(a),a.length?l():n()}function l(){g(function(){$(".editor-help-content").scrollLeft(0)},1)}function m(a,b){a!==b&&a===!0&&n()}function n(){var b=0;A.initialized||z(),g(function(){$(".editor-help").addClass("ft-visible");var c=$(".help-card");l(),a.forEach(c,function(a){g(function(){$(a).addClass("ft-visible")},b),b+=50})},1)}function o(){$(".editor-help").removeClass("ft-visible")}function p(){$(".help-card").removeClass("ft-visible")}function q(){p(),o()}function r(){q(),A.searchQuery="",A.selectedHelp=null,A.helpFiltered=A.helpSections,g(function(){A.isOpen=!1},300)}function s(){window.open("/support/editor"),close()}function t(a){a.modal?(close(),b.loadModal(a.modal[0],a.modal[1])):(p(),A.selectedHelp=a),i.add("help.editor.watch"),h.pageTrack("/support/editor/item/"+a.key)}function u(){n(),A.selectedHelp=null}function v(a){b.loadModal("editor","help",{key:a.key,hideDescription:!0})}function w(){b.account.id?(A.searchQuery.length>0?Intercom("showNewMessage",i18n.t("flat:editor.help.contact-us.msg-with-query",{query:A.searchQuery})):Intercom("showNewMessage",i18n.t("flat:editor.help.contact-us.msg")),close(),z()):f.path("/support"),i.add("help.editor.contact")}function x(){var a=j.propositionsXps(["editor.addnote","editor.timesig","editor.keysig","editor.shortcuts"]);a.length>0?(c.$parent.helpHighlightedItems=A.highlightedItems=A.helpFiltered=a,A.onboardingXpListener||(A.onboardingXpListener=c.$watchCollection(function(){return b.account.experience},function(a,b){a!==b&&x()}))):y()}function y(){A.onboardingXpListener&&A.onboardingXpListener(),c.$parent.helpHighlightedItems=A.highlightedItems=[],A.helpFiltered=A.helpSections,n()}function z(){j.query().then(function(a){A.helpSections=a,A.helpFiltered=a,A.initialized=!0,A.useOnboarding&&A.onboarding()})}var A=this;A.initialized=!1,A.colors=j.colors,A.searchQuery="",A.helpSections=[],A.helpFiltered=[],A.selectedHelp=null,A.useOnboarding=b.account.experience&&b.account.experience.length<10,A.closeHelp=r,A.openTab=s,A.contactUs=w,A.initialize=z,A.selectHelp=t,A.unselectHelp=u,A.searchUpdate=k,A.openHelpModal=v,A.onboarding=x,A.leaveOnboarding=y,c.$watch("vm.isOpen",m),A.useOnboarding&&z(),$(".editor-help-content").mousewheel(function(a,b,c){c||($(".editor-help-content").scrollLeft(this.scrollLeft-b),a.preventDefault())})}angular.module("flat.editor.directives").directive("editorHelp",a),b.$inject=["_","$rootScope","$scope","$log","$anchorScroll","$location","$timeout","$analytics","Experience","EditorHelpService"]}(),angular.module("flat.editor.directives").directive("inlineCommentPopover",ScoreInlineCommentPopoverDirective),ScoreInlineCommentPopoverDirectiveCtrl.$inject=["_","$timeout","$q","$rootScope","$scope","$log","$filter","focus","User","Group","ScoreCommentIDB"],function(){"use strict";function a(){var a={templateUrl:"/views/editor/_piano_keyboard.html",restrict:"EA",replace:!0,controller:b,controllerAs:"vm",bindToController:!0,link:{post:d},scope:{isOpen:"=",interaction:"="}};return a}function b(a,b,c,d,e){var f=this;f.notes=["C","D","E","F","G","A","B"],f.pitchesByOctave=[],f.pitches=[],f.uniformPitchAlter=function(a){return a.alter!==-1?a:{octave:a.octave,step:f.notes[f.notes.indexOf(a.step)-1],alter:1}},f.getPitchesByOctave=function(a){for(var b={},c=0;c<a.length;c++){var d=f.uniformPitchAlter(a[c]);b[d.octave.toString()]=b[d.octave]=b[d.octave]||{},b[d.octave][d.step+d.alter]=a[c]}return b},f.addKey=function(a){if(a&&a.octave&&a.step){if("drum"===f.interaction.currentStyle)return void b.debug("[pkeyboard] drums are not supported");var c=f.pitchesByOctave[a.octave]&&f.pitchesByOctave[a.octave][a.step+a.alter];if(c)f.interaction.RemoveNote({octave:c.octave,step:c.step});else{var d=f.interaction.cursor.getPosition();if(!d)return void b.debug("[pkeyboard] dont have a keyboard yet");if(delete d.line,d.pitch={octave:a.octave,step:a.step},a.alter){var g=f.notes[f.notes.indexOf(a.step)+1],h=Adagio.Utils.pitchUtils.stepToAlter(g,f.fifths);h<0?(d.accidental=Adagio.Values.AccidentalStyle.FLAT,d.pitch.step=g):d.accidental=Adagio.Values.AccidentalStyle.SHARP}else d.accidental=Adagio.Values.AccidentalStyle.NATURAL;if(d.voiceIdx!==f.interaction.voiceIdx){var i=f.interaction.dataReader.convertVoiceIdx(d);d.voiceIdx=f.interaction.voiceIdx,d.voiceIdxRef=i.voiceIdx,d.noteIdxRef=i.noteIdx}f.interaction.AddNote(f.interaction.duration||f.interaction.noteInfo.durationType,d)}e.add("editor.piano-keyboard")}},f.goRight=function(){f.interaction.data&&f.interaction.goRight(!1,!0,function(){f.interaction.adaptDuration()}.bind(this))},f.close=function(){a.$parent.$parent.displayPianoKeyboard=!1},f.modeStep=40,f.getLeft=function(){return void 0===f.left&&(f.left=parseInt($(".keyboard-keys-container").css("left"))),f.left},f.moveProcess=function(a){f.getLeft(),a<0?f.left+f.modeStep>=0?f.left=0:f.left+=f.modeStep:window.requestAnimationFrame(function(){var a=$(".keyboard-keys-container .octave:last-child").get(0);a&&(a=a.getBoundingClientRect()),a&&a.left+a.width-f.modeStep<window.innerWidth?f.left-=a.left+a.width-window.innerWidth:f.left-=f.modeStep,c(angular.noop)})},f.goToTouch=function(){if(f.getLeft(),0!==f.pitches.length){var a=$('.wkey[data-octave="'+f.pitches[0].octave+'"][data-step="'+f.pitches[0].step+'"]');if(a.length>0){var b=a[0].getBoundingClientRect();b.left<0?(f.left-=b.left-200,c(angular.noop)):b.left>window.innerWidth&&(f.left-=b.left-200,c(angular.noop))}}},f.move=function(a,b){b?d.cancel(f.movePromise):(f.moveProcess(a),f.movePromise=d(f.moveProcess.bind(f,a),100))},a.$watch("vm.interaction.noteInfo",function(){if(!f.interaction.noteInfo)return!1;f.pitches=f.interaction.noteInfo.pitches||[],f.pitchesByOctave=f.getPitchesByOctave(f.pitches);var a=f.interaction.cursor.getPosition();f.interaction.data?f.fifths=parseInt(Adagio.Utils.measureUtils.getWrappedKey(f.interaction.data.getMeasure(a.partIdx,a.measureIdx)).getEntry(a.staffIdx).fifths):f.fifths=0,window.requestAnimationFrame(f.goToTouch)})}function c(a){var b=a.currentTarget;return{octave:b.getAttribute("data-octave"),step:b.getAttribute("data-step"),alter:parseInt(b.getAttribute("data-alter")||0,10)}}function d(a,b){var d,e=0;$(b).on("touchstart",".key",function(b){0===e&&(d=a.vm.pitches&&a.vm.pitches.length>0),e++,a.vm.addKey(c(b)),b.preventDefault()}),$(b).on("touchend",".key",function(b){e--,d||0!==e||a.vm.goRight(),b.preventDefault()}),$(b).on("click",".key",function(b){var d=a.vm.pitches&&a.vm.pitches.length>0;a.vm.addKey(c(b)),d||a.vm.goRight(),b.preventDefault()}),$(b).on("touchstart",".keyboard-nav-btn.next",function(b){a.vm.move(1),b.preventDefault()}),$(b).on("touchend",".keyboard-nav-btn.next",function(b){a.vm.move(1,!0),b.preventDefault()}),$(b).on("touchstart",".keyboard-nav-btn.prev",function(b){a.vm.move(-1),b.preventDefault()}),$(b).on("touchend",".keyboard-nav-btn.prev",function(b){a.vm.move(-1,!0),b.preventDefault()})}angular.module("flat.editor.directives").directive("pianoKeyboard",a),b.$inject=["$scope","$log","$timeout","$interval","Experience"]}(),angular.module("flat.editor.directives").directive("score",["$rootScope","$timeout","$interval","$injector","flat.editor.services.Mouse","flat.editor.services.CancelStack","flat.editor.services.PageLayout","flat.editor.services.MouseSelected",function(a,b,c,d,e,f,g,h){"use strict";return{restrict:"AE",scope:{ngModel:"=ngModel",rt:"=",audio:"=",collaborators:"=",scoreInlineComments:"=",interaction:"=",score:"="},require:"ngModel",replace:!0,controller:["$scope",function(a){Adagio.setDocument(window.document),a.d=debug("flat:score"),a.svg=[],f.init()}],link:function(i,j){function k(){i.interaction.cursor.sendPosition()}function l(){if("responsive"===a.scoreLayout&&i.updater){var b=(window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth)-40;i.d("responsive: %s",b),i.updater.setExternalWidth(b),i.updater.setScaling(i.interaction.zoom||1)}}function m(a){i.interaction.svgTools.init(i.svg,i.pageLayout.getPagesStructures(),i.pageLayout),i.interaction.cursor.init(i.svg,i.interaction,i.collaborators),e.setRect(a),i.d("render"),i.$emit("score.render"),i.cursor=new Adagio.cursor.Cursor,i.cursor.setTarget(i.pageLayout),i.marker||(i.marker=new Adagio.marker.Marker),i.marker.setDrawer(i.pageLayout),i.marker.setScoreData(i.data),i.mouseSelected=new h(i.interaction,i.collaborators),i.mouse=new e.mouse(i.interaction,i.pageLayout,i.cursor,i.collaborators,i.mouseSelected),i.interaction.setMouse(i.mouse,i.mouseSelected),i.interaction.cursor.loadCursor();var b=i.interaction.cursor.getPosition();i.interaction.changeCursor(b),i.interaction.focusKeyboard(),i.d("events loaded"),i.interaction.voiceIdx=0,i.interaction.domCache.cleanCacheHead(),i.audio&&i.audio.reloadInstruments()}function n(){for(var a=i.updater.getRemovedPagesIndexes(),b=a.length-1;b>=0;b--){var c=a[b],d=i.svg[c].elem.parentElement;d.removeChild(i.svg[c].elem),i.svg.splice(c,1),0===c&&i.textmetrics.init(i.svg[c].node())}}function o(){u=!1,$(j).find(">svg").remove(),i.svg=[]}function p(b,c){if(i.ngModel&&i.ngModel.scoreData&&i.ngModel.scoreData.hasOwnProperty("score-partwise")){if(i.d("cleanup before full redraw"),i.interaction.cursor.cleanup(),i.interaction.rangeSelect.reset(),i.mouse&&(i.mouse.cleanUp(),delete i.mouse),!b){if(!i.ngModel.adagioData){delete i.ngModel.scoreData.$promise,delete i.ngModel.scoreData.$resolved;var d=!1;i.ngModel.scoreData["score-partwise"]["measure-list"]||(d=!0),i.ngModel.adagioData=new Adagio.Data(i.ngModel.scoreData),d&&(i.d("[score] upgrading file format and saving"),i.rt&&i.rt.save({force:!0,message:"Upgrading score format",data:i.ngModel.adagioData}),d=!1)}i.data=i.ngModel.adagioData,i.bindData()}i.drawQueue.push({job:"renderScore"},c),a.scoreLayoutProcessed=a.scoreLayout}else if(c)return c()}function q(){a.history.scoreData&&a.history.scoreData.hasOwnProperty("score-partwise")&&a.history.currentRevision&&(a.history.adagioData||(delete a.history.scoreData.$promise,delete a.history.scoreData.$resolved,a.history.adagioData=new Adagio.Data(a.history.scoreData)),i.data=a.history.adagioData,i.bindData(!0),i.drawQueue.push({job:"renderScore"}))}function r(a,b){null!==a&&a!==b?q():null===a&&a!==b&&"undefined"!=typeof b&&p()}function s(b,c){!b||b===c&&i.data||a.history&&a.history.currentRevision?a.history&&a.history.currentRevision&&q():p()}function t(){if(i.ngModel.inlineComments)return i.ngModel.inlineComments.refresh();try{x=x||d.get("flat.editor.services.InlineComments");var a,b,c=i.$watch("scoreInlineComments",function(d){d&&(i.ngModel.inlineComments=new x(i.scoreInlineComments,i.marker,i.interaction.dataReader),c(),a=i.$watch("scoreInlineComments.list",function(a){a&&(i.ngModel.inlineComments.comments=i.scoreInlineComments,i.ngModel.inlineComments.refresh())},!0),b=i.$watch("scoreInlineComments.highlightedId",function(){i.ngModel.inlineComments.comments.highlightedId=i.scoreInlineComments.highlightedId,i.ngModel.inlineComments.darkenRange()}))})}catch(a){}}var u=!1,v=120,w=null;j.on("$destroy",function(){i.rt&&i.rt.save&&i.rt.save(function(){i.rt.cleanup()}),i.interaction.rangeSelect.reset(),i.mouse&&(i.mouse.cleanUp(),delete i.mouse),null!==w&&c.cancel(w),i.audio&&!i.audio.err&&(i.audio.stop(),i.audio.cleanUp(!0,!0)),i.audio&&(i.audio.data=null,i.audio.drawer=null),y&&y(),z&&z(),f.init(),u&&o()}),i.ngModel.rights.aclWrite&&(w=c(k,3e4)),$(j).on("click",".title, .subtitle, .lyricist, .composer, .rights",function(){i.ngModel.rights.aclWrite&&(i.interaction.openModal("credits"),b(angular.noop))}),$(j).on("click",".part-name",function(){i.ngModel.rights.aclWrite&&(i.interaction.openModal("instruments"),b(angular.noop))}),i.renderScore=function(c,d){if(u&&o(),u=!0,i.ngModel.rendered=!1,!i.data.hasPageSize()){var e=g.userPreset(),f=g.userToPreferences(e[0],e[1]);i.data.setScaling(6.35,40),i.data.setPageSizeAsMillimeters(f.width,f.height),i.data.setPageTopMarginMillimeters(10*g.userMargin("Top"),"both"),i.data.setPageBottomMarginMillimeters(10*g.userMargin("Bottom"),"both"),i.data.setPageLeftMarginMillimeters(10*g.userMargin("Left"),"both"),i.data.setPageRightMarginMillimeters(10*g.userMargin("Right"),"both")}var h=new Adagio.Brush.Elem;j.append(h.node()),i.textmetrics=new Adagio.Drawer.CachedTextMetric(h.node()),i.interaction.config.initFromScoreData(i.data),"responsive"===a.scoreLayout?(i.pageLayout=new Adagio.page.EmbedLayout(i.data,v,i.textmetrics,Adagio.assets.smufl.bravura,i.interaction.config.get()),i.updater=new Adagio.updater.page.PageDisplayUpdater(i.data,i.pageLayout),l()):"page"===a.scoreLayout?(i.pageLayout=new Adagio.page.PageLayout(i.data,v,i.textmetrics,Adagio.assets.smufl.bravura,i.interaction.config.get()),i.updater=new Adagio.updater.page.PageDisplayUpdater(i.data,i.pageLayout)):(i.pageLayout=new Adagio.track.TrackLayout(i.data,v,i.textmetrics,Adagio.assets.smufl.bravura,i.interaction.config.get()),i.updater=new Adagio.updater.track.TrackDisplayUpdater(i.data,i.pageLayout)),i.pageLayout.setScaling(i.interaction.zoom||1),i.interaction.pageLayout=i.pageLayout,i.audio&&(i.audio.drawer=i.pageLayout),b(angular.noop),i.updateView({firstRender:!0,svg:h},d)},i.drawQueue=async.queue(function(a,b){i[a.job](a,b)},1),i.bindData=function(a){i.interaction.setData(i.data),!a&&i.rt&&i.rt.setData(i.ngModel.scoreRevisionId,i.data),i.audio&&!i.audio.err&&(i.audio.setData(i.data),i.audio.initMIDI())};var x,y=i.$watch("ngModel.scoreDataLoaded",s,!0),z=a.$watch("history.scoreDataLoaded",r,!0);i.updateView=function(c,d){var e,f,g=c.firstRender,h=c.svg,k=c.realtime;f=0;var l=function(){return i.ngModel&&i.ngModel.scoreData?(i.pageLayout.hasRemaining()&&((f>0||!h)&&(h=new Adagio.Brush.Elem,j.append(h.node())),i.ngModel.rendered=!0,i.pageLayout.fillNextPage(h),e=i.pageLayout.getLastPageGeometries(),i.svg.push(h),i.interaction.svgTools.info=i.pageLayout.getPagesStructures(),g&&0===f&&m(e),i.refreshUX(e,k),f++),window.requestAnimationFrame(function(){b(angular.noop),!this.interaction.pageWidthNoScaling&&i.svg.length>0&&(this.interaction.pageWidthNoScaling=i.svg[0].elem.clientWidth/this.interaction.zoom,this.interaction.applyZoomAuto())}.bind(this)),i.pageLayout.hasRemaining()?(window.requestAnimationFrame(l),void a.$broadcast("score.pageRendered")):(t(),g&&a.$broadcast("CommentInput.ResetCards"),d())):(o(),d())}.bind(this);l()},i.refreshUX=function(a,b){window.requestAnimationFrame(function(){i.interaction.cursor.refresh(),a&&(e.setRect(a),i.mouse&&i.mouse.updateEvents(a,b))})},i.$on("Realtime.Updated",function(){!a.history.currentRevision&&i.ngModel.rendered&&(f.onlineStack.needCompleteRedraw()?p(!0,function(){f.onlineStack.stateCompleteRedrawDone(),f.resetOnline()}):(i.updater.update(f.onlineStack),f.resetOnline(),n(),i.interaction.svgTools.info=i.pageLayout.getPagesStructures(),i.refreshUX(i.updater.getGeometries()),i.drawQueue.push({job:"updateView",realtime:!0})))}),i.$on("Interaction.Updated",function(a,b,c,d){if("function"==typeof c&&(d=c,c={}),d=d||function(){},c=c||{},c.redraw||b&&b.needCompleteRedraw())i.d("full redraw"),p(!0,function(a){b&&b.stateCompleteRedrawDone(),f.resetDrawQueue(),d(a)});else{if(i.d("%s actions to draw",f.drawQueue.stack.length),0===f.drawQueue.stack.length&&!c.force)return d();i.updater.update(f.drawQueue),f.resetDrawQueue(),n(),i.interaction.svgTools.info=i.pageLayout.getPagesStructures(),i.refreshUX(i.updater.getGeometries()),i.drawQueue.push({job:"updateView"},d)}}),i.$on("SmartRevision.Updated",function(a,b){b.drawStack.needCompleteRedraw()?p(!0,function(){b.drawStack.stateCompleteRedrawDone()}):(i.updater.update(b.drawStack),n(),i.drawQueue.push({job:"updateView"}),i.interaction.cursor.refresh())}),i.$on("ScoreScaling.Updated",function(){i.pageLayout&&(i.pageLayout.setScaling(i.interaction.zoom||1),i.interaction.svgTools.init(i.svg,i.pageLayout.getPagesStructures(),i.pageLayout),i.interaction.cursor.loadCursor(!0),i.interaction.cursor.refresh(),i.refreshUX(),a.$broadcast("CommentInput.ResetCards"),"responsive"===a.scoreLayout&&(l(),a.$broadcast("Interaction.Updated",null,{force:!0})))}),i.$on("ResponsiveWidth.Updated",function(b,c){l(),a.$broadcast("Interaction.Updated",null,{force:!0,redraw:!!c})}),i.$on("Editor.SwitchScoreLayout",function(){p(!0)}),i.$on("Editor.RedrawScore",function(){p(!0)})}}}]),angular.module("flat.editor.directives").directive("scoreComment",ScoreCommentDirective),ScoreCommentDirectiveCtrl.$inject=["_","$rootScope","$scope","$timeout","focus"],angular.module("flat.editor.directives").directive("ftShortcut",ShortcutDirective),ShortcutDirectiveCtrl.$inject=["_","$sce"],angular.module("flat.editor.directives").directive("syncScore",SyncScore),SyncScoreController.$inject=["$rootScope","$log","$scope","$timeout","UxStore","User"],angular.module("flat.editor.directives").directive("toolbar",["$timeout",function(a){"use strict";return{restrict:"AE",replace:!0,templateUrl:"/views/editor/_toolbar.html",scope:{embed:"=",config:"=",audio:"=",rt:"=",score:"=ngScore",history:"=history",interaction:"="},controller:["$rootScope","$scope","$sce","$log","flat.editor.services.CancelStack","Instruments","UxStore",function(b,c,d,e,f,g,h){c.groups={all:["brass","electronic-instruments","free-reed","keyboards","pitched-percussion","unpitched-percussion","plucked-strings","special","strings","vocals","woodwinds"],unpitched:["unpitched-percussion"],strings:["strings","plucked-strings"],pitched:["brass","electronic-instruments","free-reed","keyboards","pitched-percussion","plucked-strings","special","strings","vocals","woodwinds"],brass:["brass","woodwinds"]},c.triggerAnimation=!1,c.enabled=c.interaction.rightsHandler.categoryState.score_write||!1,c.cursor=c.interaction.cursor;var i=c.config||{};c.activeToolbar=null;var j=function(a){return!(!c.interaction.noteInfo||!c.interaction.noteInfo.possibleTuplets)&&!!(c.interaction.noteInfo.possibleTuplets.indexOf(a.value)!==-1||this.vars.active&&this.vars.active===a)};if(c.lockUndo=function(a){var b;return b="undo"===a?f.localStack.getLast():f.redoStack.getLast(),!(b&&Adagio.undo.safe.getReverseActionData(b).length>0)},c.lockAudio=function(){return!(Dacapo.context&&c.audio&&c.audio.transport&&c.audio.manager)},c.lockZoom=function(a){return!b.account.editorPreferences||!c.interaction||(a>0?c.interaction.zoom>=3:c.interaction.zoom<=.2)},c.ctrlKeyName=d.trustAsHtml(navigator.userAgent.indexOf("Mac OS X")<0?"Ctrl":"⌘"),c.delKeyName=d.trustAsHtml(navigator.userAgent.indexOf("Mac OS X")<0?"Delete":"⌫"),c.altKeyName=d.trustAsHtml(navigator.userAgent.indexOf("Mac OS X")<0?"Alt":"⌥"),c.toolbar=[],i.selectMode!==!1){var k={title:i18n.t("flat:editor.toolbar.main.select.title"),ks:"("+c.ctrlKeyName+" + 1)",type:"select",action:"select",role:"main",readWrite:!0,subs:[]};c.toolbar.push(k),i.selectMode&&!i.selectMode.copyPaste||k.subs.push({title:i18n.t("flat:editor.toolbar.main.select.copy"),type:"copy",ks:"("+c.ctrlKeyName+" + C)",iconSvg:"/img/icons/_common/copy.svg",action:"blocCopy"},{title:i18n.t("flat:editor.toolbar.main.select.cut"),ks:"("+c.ctrlKeyName+" + X)",type:"cut",iconSvg:"/img/icons/_common/cut.svg",action:"blocCut"},{title:i18n.t("flat:editor.toolbar.main.select.paste"),ks:"("+c.ctrlKeyName+" + V)",type:"paste",iconSvg:"/img/icons/_common/paste.svg",action:"pasteCopy"},{separator:!0,show:"pitched"}),i.selectMode&&!i.selectMode.transpose||k.subs.push({title:i18n.t("flat:editor.toolbar.main.select.transpose"),type:"transpose",show:"pitched",iconSvg:"/img/icons/music/transpose.svg"},{separator:!0}),k.subs.push({title:i18n.t("flat:editor.toolbar.main.remove"),ks:"("+c.delKeyName+")",type:"remove",iconSvg:"/img/icons/_common/trash.svg",show:"all"})}if(i.noteMode!==!1){var l={title:i18n.t("flat:editor.toolbar.main.notes.title"),type:"note",ks:"("+c.ctrlKeyName+" + 2)",role:"main",readWrite:!0,action:"Focus",subs:[]};c.toolbar.push(l),i.noteMode&&!i.noteMode.unpitchedHeads||l.subs.push({title:i18n.t("flat:editor.toolbar.main.notes.head.normal"),show:"unpitched",type:"head",iconSvg:"/img/icons/music/note_normal.svg",value:Adagio.Values.Notehead.NORMAL},{title:i18n.t("flat:editor.toolbar.main.notes.head.cross"),show:"unpitched",type:"head",iconSvg:"/img/icons/music/cross.svg",value:Adagio.Values.Notehead.X},{title:i18n.t("flat:editor.toolbar.main.notes.head.circle"),show:"unpitched",type:"head",iconSvg:"/img/icons/music/circle.svg",value:Adagio.Values.Notehead.DIAMOND}),i.noteMode&&!i.noteMode.accidentals||l.subs.push({title:i18n.t("flat:editor.toolbar.main.notes.accidental.natural"),ks:"(0)",type:"accidental.natural",show:"pitched",iconSvg:"/img/icons/music/note_natural.svg",value:Adagio.Values.AccidentalStyle.NATURAL},{title:i18n.t("flat:editor.toolbar.main.notes.accidental.sharp"),ks:"(+)",type:"accidental.sharp",show:"pitched",iconSvg:"/img/icons/music/note_sharp.svg",value:[Adagio.Values.AccidentalStyle.SHARP,Adagio.Values.AccidentalStyle.DOUBLESHARP]},{title:i18n.t("flat:editor.toolbar.main.notes.accidental.flat"),ks:"(-)",type:"accidental.flat",show:"pitched",iconSvg:"/img/icons/music/note_flat.svg",value:[Adagio.Values.AccidentalStyle.FLAT,Adagio.Values.AccidentalStyle.FLATFLAT]},{separator:!0}),i.noteMode&&!i.noteMode.switchEnharmonic||l.subs.push({title:i18n.t("flat:editor.toolbar.main.notes.switch-enharmonic"),type:"enharmonic",showFnc:function(){return c.interaction.dataReader&&c.interaction.dataReader.partHasTabs(c.cursor.getPosition())},iconSvg:"/img/icons/music/enharmonic_switch.svg",lock:function(){return c.interaction.canTrySwitchEnharmonic()}},{separator:!0,showFnc:function(){return c.interaction.dataReader&&c.interaction.dataReader.partHasTabs(c.cursor.getPosition())}}),i.noteMode&&!i.noteMode.durations||l.subs.push({title:i18n.t("flat:editor.toolbar.main.notes.duration.whole"),type:"duration",ks:"(1)",iconSvg:"/img/icons/music/note_whole.svg",value:Adagio.Values.DurationType.FULL,show:"all"},{title:i18n.t("flat:editor.toolbar.main.notes.duration.half"),type:"duration",ks:"(2)",iconSvg:"/img/icons/music/note_half.svg",value:Adagio.Values.DurationType.HALF,show:"all"},{title:i18n.t("flat:editor.toolbar.main.notes.duration.quarter"),ks:"(3)",type:"duration",iconSvg:"/img/icons/music/note_quarter.svg",value:Adagio.Values.DurationType.QUARTER,show:"all"},{title:i18n.t("flat:editor.toolbar.main.notes.duration.eighth"),type:"duration",ks:"(4)",iconSvg:"/img/icons/music/note_eighth.svg",value:Adagio.Values.DurationType.EIGHT,show:"all"},{title:i18n.t("flat:editor.toolbar.main.notes.duration.sixteenth"),type:"duration",ks:"(5)",iconSvg:"/img/icons/music/note_sixteenth.svg",value:Adagio.Values.DurationType.SIXTEENTH,show:"all"},{title:i18n.t("flat:editor.toolbar.main.notes.duration.thirtysecondnote"),type:"duration",ks:"(6)",iconSvg:"/img/icons/music/note_thirtysecondnote.svg",value:Adagio.Values.DurationType.THIRTY_SECOND,show:"all"},{title:i18n.t("flat:editor.toolbar.main.notes.duration.sixtyfourth"),type:"duration",ks:"(7)",iconSvg:"/img/icons/music/note_sixtyfourth.svg",value:Adagio.Values.DurationType.SIXTY_FOURTH,show:"all"},{separator:!0},{title:i18n.t("flat:editor.toolbar.main.notes.rest"),type:"rest",ks:"(i)",iconSvg:"/img/icons/music/rest_quarter.svg"}),i.noteMode&&!i.noteMode.dotted||l.subs.push({title:i18n.t("flat:editor.toolbar.main.notes.dotted"),type:"dot",ks:"(•)",subs:[{title:i18n.t("flat:editor.toolbar.main.notes.dotted"),iconSvg:"/img/icons/music/note_dotted.svg",value:1},{title:i18n.t("flat:editor.toolbar.main.notes.double-dotted"),iconSvg:"/img/icons/music/note_double-dotted.svg",value:2}],show:"all"}),i.noteMode&&!i.noteMode.ties||l.subs.push({title:i18n.t("flat:editor.toolbar.main.notes.tie"),type:"tie",ks:"(,)",iconSvg:"/img/icons/music/tie.svg",value:!0,show:"all"}),i.noteMode&&!i.noteMode.ghostNote||l.subs.push({title:i18n.t("flat:editor.toolbar.main.notes.ghost"),type:"ghost",iconSvg:"/img/icons/music/ghost.svg",value:!0,show:"all"}),(!i.noteMode||i.noteMode.acciaccatura||i.noteMode.graceNote)&&l.subs.push({separator:!0,show:"all"}),i.noteMode&&!i.noteMode.acciaccatura||l.subs.push({title:i18n.t("flat:editor.toolbar.main.slashgrace"),type:"slashgrace",iconSvg:"/img/icons/music/slashgracenote.svg",show:"all"}),i.noteMode&&!i.noteMode.graceNote||l.subs.push({title:i18n.t("flat:editor.toolbar.main.grace"),type:"grace",iconSvg:"/img/icons/music/gracenote.svg",show:"all"}),i.noteMode&&!i.noteMode.octaveShift||l.subs.push({separator:!0,show:"pitched"},{title:i18n.t("flat:editor.toolbar.octave-shift"),type:"shift",show:"pitched",subs:[{title:i18n.t("flat:editor.toolbar.octave-shift"),value:Adagio.Values.OctaveShiftSize.EIGHT,iconSvg:"/img/icons/music/8.svg"},{title:i18n.t("flat:editor.toolbar.octave-shift"),value:Adagio.Values.OctaveShiftSize.FIFTEEN,iconSvg:"/img/icons/music/15.svg"}]}),i.noteMode&&!i.noteMode.tuplets||l.subs.push({separator:!0,show:"all"},{title:i18n.t("flat:editor.toolbar.main.tuplet.tooltip"),type:"tuplet",show:"all",subs:[{iconSvg:"/img/icons/music/tuplet_3.svg",value:Adagio.Values.TupletType.TRIPLET,title:i18n.t("flat:editor.toolbar.main.tuplet.triplet"),showFnc:j},{iconSvg:"/img/icons/music/tuplet_2.svg",value:Adagio.Values.TupletType.DUPLET,title:i18n.t("flat:editor.toolbar.main.tuplet.duplet"),showFnc:j},{iconSvg:"/img/icons/music/tuplet_4.svg",value:Adagio.Values.TupletType.QUADRUPLET,title:i18n.t("flat:editor.toolbar.main.tuplet.quadruplet"),showFnc:j},{iconSvg:"/img/icons/music/tuplet_5.svg",value:Adagio.Values.TupletType.QUINTUPLET,title:i18n.t("flat:editor.toolbar.main.tuplet.quintuplet"),showFnc:j},{iconSvg:"/img/icons/music/tuplet_5.svg",value:Adagio.Values.TupletType.QUINTUPLET_COMPOUND,title:i18n.t("flat:editor.toolbar.main.tuplet.quintuplet-compound"),showFnc:j},{iconSvg:"/img/icons/music/tuplet_6.svg",value:Adagio.Values.TupletType.SEXTUPLET,title:i18n.t("flat:editor.toolbar.main.tuplet.sextuplet"),showFnc:j},{iconSvg:"/img/icons/music/tuplet_7.svg",value:Adagio.Values.TupletType.SEPTUPLET,title:i18n.t("flat:editor.toolbar.main.tuplet.septuplet"),showFnc:j},{iconSvg:"/img/icons/music/tuplet_7.svg",value:Adagio.Values.TupletType.SEPTUPLET_COMPOUND,title:i18n.t("flat:editor.toolbar.main.tuplet.septuplet-compound"),showFnc:j},{iconSvg:"/img/icons/music/tuplet_9.svg",value:Adagio.Values.TupletType.NONUPLET,title:i18n.t("flat:editor.toolbar.main.tuplet.nonuplet"),showFnc:j},{iconSvg:"/img/icons/music/tuplet_11.svg",value:Adagio.Values.TupletType.TUPLET_11,title:i18n.t("flat:editor.toolbar.main.tuplet.tuplet_11"),showFnc:j}]}),l.subs.push({separator:!0},{title:i18n.t("flat:editor.toolbar.main.remove"),ks:"("+c.delKeyName+")",type:"remove",iconSvg:"/img/icons/_common/trash.svg",show:"all"})}if(i.articulationMode!==!1){var m={title:i18n.t("flat:editor.toolbar.main.articulations.title"),type:"articulation",ks:"("+c.ctrlKeyName+" + 3)",role:"main",readWrite:!0,subs:[]};c.toolbar.push(m),i.articulationMode&&!i.articulationMode.staccato||m.subs.push({title:i18n.t("flat:editor.toolbar.main.arti.staccato"),ks:"(1)",type:"arti",iconSvg:"/img/icons/music/note_staccato.svg",value:Adagio.Values.ArticulationType.STACCATO,show:"all"}),i.articulationMode&&!i.articulationMode.staccatissimo||m.subs.push({title:i18n.t("flat:editor.toolbar.main.arti.staccatissimo"),ks:"(2)",type:"arti",iconSvg:"/img/icons/music/note_staccatissimo.svg",value:Adagio.Values.ArticulationType.STACCATISSIMO,show:"all"}),i.articulationMode&&!i.articulationMode.tenuto||m.subs.push({title:i18n.t("flat:editor.toolbar.main.arti.tenuto"),ks:"(3)",type:"arti",iconSvg:"/img/icons/music/note_tenuto.svg",value:Adagio.Values.ArticulationType.TENUTO,show:"all"}),i.articulationMode&&!i.articulationMode.tenutoStaccato||m.subs.push({title:i18n.t("flat:editor.toolbar.main.arti.tenutoStaccato"),type:"arti",iconSvg:"/img/icons/music/note_tenutoStaccato.svg",value:Adagio.Values.ArticulationType.STACCATO_TENUTO,show:"all"}),(!i.articulationMode||i.articulationMode.martellato||i.articulationMode.marcato)&&m.subs.push({
separator:!0,show:"all"}),i.articulationMode&&!i.articulationMode.martellato||m.subs.push({title:i18n.t("flat:editor.toolbar.main.arti.martellato"),ks:"(4)",type:"arti",iconSvg:"/img/icons/music/note_martellato.svg",value:Adagio.Values.ArticulationType.STRONG,show:"all"}),i.articulationMode&&!i.articulationMode.marcato||m.subs.push({title:i18n.t("flat:editor.toolbar.main.arti.marcato"),ks:"(5)",type:"arti",iconSvg:"/img/icons/music/note_marcato.svg",value:Adagio.Values.ArticulationType.ACCENT,show:"all"}),i.articulationMode&&!i.articulationMode.fermata||m.subs.push({separator:!0},{title:i18n.t("flat:editor.toolbar.main.notation.fermata"),ks:"(6)",type:"notation",iconSvg:"/img/icons/music/fermata.svg",value:Adagio.Values.NotationType.FERMATA,show:"all"}),i.articulationMode&&!i.articulationMode.bow||m.subs.push({separator:!0,show:"strings"},{title:i18n.t("flat:editor.toolbar.main.notation.bow-up"),ks:"(7)",type:"bow",iconSvg:"/img/icons/music/note_bow_up.svg",value:Adagio.Values.TechnicalType.UPBOW,show:"strings"},{title:i18n.t("flat:editor.toolbar.main.notation.bow-down"),ks:"(8)",type:"bow",iconSvg:"/img/icons/music/note_bow_down.svg",value:Adagio.Values.TechnicalType.DOWNBOW,show:"strings"},{title:i18n.t("flat:editor.toolbar.main.notation.snapPizzicato"),type:"bow",iconSvg:"/img/icons/music/snapPizzicato.svg",value:Adagio.Values.TechnicalType.SNAP_PIZZICATO,show:"strings"}),i.articulationMode&&!i.articulationMode.hammer||m.subs.push({title:i18n.t("flat:editor.toolbar.main.notation.hammeron"),ks:"(9)",type:"hammer",iconSvg:"/img/icons/music/pulloff_hammeron.svg",show:"strings"}),i.articulationMode&&!i.articulationMode.doit||m.subs.push({title:i18n.t("flat:editor.toolbar.main.notation.doit"),type:"arti",iconSvg:"/img/icons/music/brassDoitMedium.svg",value:Adagio.Values.ArticulationType.DOIT,show:"brass"}),i.articulationMode&&!i.articulationMode.fallOff||m.subs.push({title:i18n.t("flat:editor.toolbar.main.notation.fallrough"),type:"arti",iconSvg:"/img/icons/music/brassfallroughshort.svg",value:Adagio.Values.ArticulationType.FALLOFF,show:"brass"}),i.articulationMode&&!i.articulationMode.plop||m.subs.push({title:i18n.t("flat:editor.toolbar.main.notation.plop"),type:"arti",iconSvg:"/img/icons/music/brassplop.svg",value:Adagio.Values.ArticulationType.PLOP,show:"brass"}),i.articulationMode&&!i.articulationMode.scoop||m.subs.push({title:i18n.t("flat:editor.toolbar.main.notation.scoop"),type:"arti",iconSvg:"/img/icons/music/brassscoop.svg",value:Adagio.Values.ArticulationType.SCOOP,show:"brass"}),i.articulationMode&&!i.articulationMode.slurs||m.subs.push({title:i18n.t("flat:editor.toolbar.main.notation.slurs"),ks:"(S)",type:"slurs",iconSvg:"/img/icons/music/slurs.svg",show:"all"}),i.articulationMode&&!i.articulationMode.fingering||m.subs.push({separator:!0}),i.articulationMode&&!i.articulationMode.fingering||m.subs.push({title:i18n.t("flat:editor.toolbar.main.notation.fingering"),type:"fingering",iconSvg:"/img/icons/music/fingering.svg",show:"all",value:[1,2,3,4,5]}),(!i.articulationMode||i.articulationMode.breathMark||i.articulationMode.caesura)&&m.subs.push({separator:!0}),i.articulationMode&&!i.articulationMode.breathMark||m.subs.push({title:i18n.t("flat:editor.toolbar.main.arti.breath-mark"),type:"arti",value:Adagio.Values.ArticulationType.BREATHMARK,iconSvg:"/img/icons/music/breathmark.svg",show:"all"}),i.articulationMode&&!i.articulationMode.caesura||m.subs.push({title:i18n.t("flat:editor.toolbar.main.arti.caesura"),type:"arti",value:Adagio.Values.ArticulationType.CAESURA,iconSvg:"/img/icons/music/caesura.svg",show:"all"}),(!i.articulationMode||i.articulationMode.drumRoll||i.articulationMode.buzzRoll)&&m.subs.push({separator:!0,show:"unpitched"}),i.articulationMode&&!i.articulationMode.drumRoll||m.subs.push({title:i18n.t("flat:editor.toolbar.main.notation.drum-roll"),type:"drumroll",value:[{value:Adagio.Values.OrnamentType.TREMOLO,nbBeam:1},{value:Adagio.Values.OrnamentType.TREMOLO,nbBeam:2},{value:Adagio.Values.OrnamentType.TREMOLO,nbBeam:3}],iconSvgFunc:function(a){return(!a||a<=0)&&(a=0),"/img/icons/music/drumroll_"+(a+1)+".svg"},show:"unpitched"}),i.articulationMode&&!i.articulationMode.buzzRoll||m.subs.push({title:i18n.t("flat:editor.toolbar.main.notation.buzz-roll"),type:"buzzroll",value:Adagio.Values.OrnamentType.BUZZ,iconSvg:"/img/icons/music/buzzroll.svg",show:"unpitched"}),m.subs.push({separator:!0},{title:i18n.t("flat:editor.toolbar.main.remove"),ks:"("+c.delKeyName+")",type:"remove",iconSvg:"/img/icons/_common/trash.svg",show:"all"})}if(i.ornamentMode!==!1){var n={title:i18n.t("flat:editor.toolbar.main.ornaments.title"),action:"OrnamentsMode",ks:"("+c.ctrlKeyName+" + 4)",type:"ornaments",role:"main",readWrite:!0,show:"pitched",subs:[]};c.toolbar.push(n),i.ornamentMode&&!i.ornamentMode.trill||n.subs.push({title:i18n.t("flat:editor.toolbar.main.notation.trill"),type:"trill",iconSvg:"/img/icons/music/trill.svg",value:Adagio.Values.OrnamentType.TRILLMARK,show:"pitched"}),i.ornamentMode&&!i.ornamentMode.tremolo||n.subs.push({title:i18n.t("flat:editor.toolbar.main.notation.tremolo"),type:"tremolo",value:Adagio.Values.OrnamentType.TREMOLO,iconSvg:"/img/icons/music/tremolo.svg",show:"pitched"}),(!i.ornamentMode||i.ornamentMode.trill||i.ornamentMode.tremolo)&&n.subs.push({separator:!0}),i.ornamentMode&&!i.ornamentMode.arpeggio||n.subs.push({title:i18n.t("flat:editor.toolbar.main.arti.arpeggio"),type:"arpeggio",iconSvg:"/img/icons/music/arpeggio.svg",show:"pitched"}),i.ornamentMode&&!i.ornamentMode.mordent||n.subs.push({title:i18n.t("flat:editor.toolbar.main.ornaments.mordent"),type:"mordent",show:"pitched",subs:[{iconSvg:"/img/icons/music/mordent.svg",value:{value:Adagio.Values.OrnamentType.MORDENT,long:"no"},title:i18n.t("flat:editor.toolbar.main.ornaments.normal-mordent")},{iconSvg:"/img/icons/music/mordent-inverted.svg",value:{value:Adagio.Values.OrnamentType.INVERTED_MORDENT,long:"no"},title:i18n.t("flat:editor.toolbar.main.ornaments.inverted-mordent")},{iconSvg:"/img/icons/music/mordent-long.svg",value:{value:Adagio.Values.OrnamentType.MORDENT,long:"yes"},title:i18n.t("flat:editor.toolbar.main.ornaments.long-mordent")},{iconSvg:"/img/icons/music/mordent-inverted-long.svg",value:{value:Adagio.Values.OrnamentType.INVERTED_MORDENT,long:"yes"},title:i18n.t("flat:editor.toolbar.main.ornaments.inverted-long-mordent")},{iconSvg:"/img/icons/music/mordent-above-approach.svg",value:{value:Adagio.Values.OrnamentType.MORDENT,long:"yes",approach:"above"},title:i18n.t("flat:editor.toolbar.main.ornaments.mordent-approach-above")},{iconSvg:"/img/icons/music/mordent-below-approach.svg",value:{value:Adagio.Values.OrnamentType.MORDENT,long:"yes",approach:"below"},title:i18n.t("flat:editor.toolbar.main.ornaments.mordent-approach-below")},{iconSvg:"/img/icons/music/mordent-inverted-above-approach.svg",value:{value:Adagio.Values.OrnamentType.INVERTED_MORDENT,long:"yes",approach:"above"},title:i18n.t("flat:editor.toolbar.main.ornaments.inverted-mordent-approach-above")},{iconSvg:"/img/icons/music/mordent-inverted-below-approach.svg",value:{value:Adagio.Values.OrnamentType.INVERTED_MORDENT,long:"yes",approach:"below"},title:i18n.t("flat:editor.toolbar.main.ornaments.inverted-mordent-approach-below")},{iconSvg:"/img/icons/music/mordent-inverted-above-departure.svg",value:{value:Adagio.Values.OrnamentType.INVERTED_MORDENT,long:"yes",departure:"above"},title:i18n.t("flat:editor.toolbar.main.ornaments.inverted-mordent-departure-above")},{iconSvg:"/img/icons/music/mordent-inverted-below-departure.svg",value:{value:Adagio.Values.OrnamentType.INVERTED_MORDENT,long:"yes",departure:"below"},title:i18n.t("flat:editor.toolbar.main.ornaments.inverted-mordent-departure-below")}]}),i.ornamentMode&&!i.ornamentMode.turn||n.subs.push({title:i18n.t("flat:editor.toolbar.main.ornaments.turn"),type:"turns",show:"pitched",subs:[{iconSvg:"/img/icons/music/turn.svg",value:{value:Adagio.Values.OrnamentType.TURN},title:i18n.t("flat:editor.toolbar.main.ornaments.turn")},{iconSvg:"/img/icons/music/turn-inverted.svg",value:{value:Adagio.Values.OrnamentType.INVERTED_TURN},title:i18n.t("flat:editor.toolbar.main.ornaments.inverted-turn")}]}),i.ornamentMode&&!i.ornamentMode.glissando||n.subs.push({separator:!0},{title:i18n.t("flat:editor.toolbar.main.arti.glissando"),type:"glissando",iconSvg:"/img/icons/music/glissando.svg",show:"pitched"}),n.subs.push({separator:!0},{title:i18n.t("flat:editor.toolbar.main.remove"),ks:"("+c.delKeyName+")",type:"remove",iconSvg:"/img/icons/_common/trash.svg",show:"all"})}if(i.dynamicMode!==!1){var o={title:i18n.t("flat:editor.toolbar.main.dynamics.title"),action:"DynamicsMode",ks:"("+c.ctrlKeyName+" + 5)",type:"dynamics",role:"main",readWrite:!0,subs:[]};c.toolbar.push(o),i.dynamicMode&&!i.dynamicMode.crescendo||o.subs.push({title:i18n.t("flat:editor.toolbar.main.wedge.crescendo"),ks:"(<)",type:"wedge",iconSvg:"/img/icons/music/crescendo.svg",value:Adagio.Values.WedgeType.CRESCENDO,show:"all"}),i.dynamicMode&&!i.dynamicMode.decrescendo||o.subs.push({title:i18n.t("flat:editor.toolbar.main.wedge.decrescendo"),ks:"(>)",type:"wedge",iconSvg:"/img/icons/music/decrescendo.svg",value:Adagio.Values.WedgeType.DIMINUENDO,show:"all"}),(!i.dynamicMode||i.dynamicMode.crescendo||i.dynamicMode.decrescendo)&&o.subs.push({separator:!0}),i.dynamicMode&&!i.dynamicMode.ppp||o.subs.push({title:i18n.t("flat:editor.toolbar.main.dynamics.pianississimo"),ks:"(1)",iconSvg:"/img/icons/music/dynamics-pianississimo.svg",type:"dyn",value:"ppp",show:"all"}),i.dynamicMode&&!i.dynamicMode.pp||o.subs.push({title:i18n.t("flat:editor.toolbar.main.dynamics.pianissimo"),ks:"(2)",iconSvg:"/img/icons/music/dynamics-pianissimo.svg",type:"dyn",value:"pp",show:"all"}),i.dynamicMode&&!i.dynamicMode.p||o.subs.push({title:i18n.t("flat:editor.toolbar.main.dynamics.piano"),ks:"(3)",iconSvg:"/img/icons/music/dynamics-piano.svg",type:"dyn",value:"p",show:"all"}),i.dynamicMode&&!i.dynamicMode.mp||o.subs.push({title:i18n.t("flat:editor.toolbar.main.dynamics.mezzo-piano"),ks:"(4)",iconSvg:"/img/icons/music/dynamics-mezzo-piano.svg",type:"dyn",value:"mp",show:"all"}),i.dynamicMode&&!i.dynamicMode.mf||o.subs.push({title:i18n.t("flat:editor.toolbar.main.dynamics.mezzo-forte"),ks:"(5)",iconSvg:"/img/icons/music/dynamics-mezzo-forte.svg",type:"dyn",value:"mf",show:"all"}),i.dynamicMode&&!i.dynamicMode.f||o.subs.push({title:i18n.t("flat:editor.toolbar.main.dynamics.forte"),ks:"(6)",iconSvg:"/img/icons/music/dynamics-forte.svg",type:"dyn",value:"f",show:"all"}),i.dynamicMode&&!i.dynamicMode.ff||o.subs.push({title:i18n.t("flat:editor.toolbar.main.dynamics.fortissimo"),ks:"(7)",iconSvg:"/img/icons/music/dynamics-fortissimo.svg",type:"dyn",value:"ff",show:"all"}),i.dynamicMode&&!i.dynamicMode.fff||o.subs.push({title:i18n.t("flat:editor.toolbar.main.dynamics.fortississimo"),ks:"(8)",iconSvg:"/img/icons/music/dynamics-fortississimo.svg",type:"dyn",value:"fff",show:"all"}),(!i.dynamicMode||i.dynamicMode.sfz||i.dynamicMode.rfz||i.dynamicMode.fp||i.dynamicMode.pf)&&o.subs.push({separator:!0}),i.dynamicMode&&!i.dynamicMode.sfz||o.subs.push({title:i18n.t("flat:editor.toolbar.main.dynamics.sforzando"),ks:"(9)",iconSvg:"/img/icons/music/dynamics-sforzando.svg",type:"dyn",value:"sfz",show:"all"}),i.dynamicMode&&!i.dynamicMode.rfz||o.subs.push({title:i18n.t("flat:editor.toolbar.main.dynamics.rinforzando"),iconSvg:"/img/icons/music/dynamics-rfz.svg",type:"dyn",value:"rfz",show:"all"}),i.dynamicMode&&!i.dynamicMode.fp||o.subs.push({title:i18n.t("flat:editor.toolbar.main.dynamics.fortepiano"),iconSvg:"/img/icons/music/dynamics-fp.svg",type:"dyn",value:"fp",show:"all"}),i.dynamicMode&&!i.dynamicMode.pf||o.subs.push({title:i18n.t("flat:editor.toolbar.main.dynamics.fortepiano"),iconSvg:"/img/icons/music/dynamics-fp.svg",type:"dyn",value:"fp",show:"all"}),(!i.dynamicMode||i.dynamicMode.pizz||i.dynamicMode.arco)&&o.subs.push({separator:!0,show:"strings"}),i.dynamicMode&&!i.dynamicMode.pizz||o.subs.push({title:i18n.t("flat:editor.toolbar.main.notation.pizz"),type:"pizz",iconSvg:"/img/icons/music/pizzicato.svg",value:Adagio.Values.PizzicatoType.PIZZICATO,show:"strings"}),i.dynamicMode&&!i.dynamicMode.arco||o.subs.push({title:i18n.t("flat:editor.toolbar.main.notation.arco"),type:"pizz",iconSvg:"/img/icons/music/arco.svg",value:Adagio.Values.PizzicatoType.ARCO,show:"strings"}),i.dynamicMode&&!i.dynamicMode.pedal||o.subs.push({separator:!0,show:["keyboards"]},{title:i18n.t("flat:editor.toolbar.main.notation.pedal"),type:"ped",iconSvg:"/img/icons/music/ped.svg",show:["keyboards"]}),o.subs.push({separator:!0},{title:i18n.t("flat:editor.toolbar.main.remove"),ks:"("+c.delKeyName+")",type:"remove",iconSvg:"/img/icons/_common/trash.svg",show:"all"})}if(i.measureMode!==!1){var p={title:i18n.t("flat:editor.toolbar.main.measures.title"),ks:"("+c.ctrlKeyName+" + 6)",action:"MeasureMode",type:"measure",role:"main",readWrite:!0,subs:[]};c.toolbar.push(p),i.measureMode&&!i.measureMode.add||p.subs.push({title:i18n.t("flat:editor.toolbar.measure.add-before"),action:function(){c.interaction.AddMeasure(!0)},showFnc:function(){var a=c.cursor.getPosition();return a&&0===a.measureIdx},iconSvg:"/img/icons/music/measure_add_before.svg",type:"Measure",value:!0,active:null,show:"all"},{title:i18n.t("flat:editor.toolbar.measure.add"),action:"AddMeasure",iconSvg:"/img/icons/music/measure_add.svg",type:"Measure",active:null,show:"all"}),i.measureMode&&!i.measureMode.remove||p.subs.push({title:i18n.t("flat:editor.toolbar.measure.remove"),action:"RemoveMeasure",iconSvg:"/img/icons/music/measure_remove.svg",type:"Measure",active:null,show:"all"}),(!i.measureMode||i.measureMode.clef||i.measureMode.keySignature||i.measureMode.timeSignature||i.measureMode.tempo)&&p.subs.push({separator:!0}),i.measureMode&&!i.measureMode.clef||p.subs.push({title:i18n.t("flat:editor.toolbar.clef.tooltip"),iconSvg:"/img/icons/music/clef.svg",type:"clef",active:null,show:"pitched"}),i.measureMode&&!i.measureMode.keySignature||p.subs.push({title:i18n.t("flat:editor.toolbar.keys"),type:"Keys",iconSvg:"/img/icons/music/key_signature.svg",active:null,show:"pitched"}),i.measureMode&&!i.measureMode.timeSignature||p.subs.push({title:i18n.t("flat:editor.toolbar.time"),type:"Time",iconSvg:"/img/icons/music/time_signature.svg",active:null,show:"all"}),i.measureMode&&!i.measureMode.tempo||p.subs.push({title:i18n.t("flat:editor.toolbar.tempo"),type:"Tempo",iconSvg:"/img/icons/music/tempo.svg",active:null,show:"all"}),(!i.measureMode||i.measureMode.repeatLeft||i.measureMode.repeatRight)&&p.subs.push({separator:!0}),i.measureMode&&!i.measureMode.repeatLeft||p.subs.push({title:i18n.t("flat:editor.toolbar.repeat-left"),ks:"([)",type:"AddRepeat",iconSvg:"/img/icons/music/measure_repeat_left.svg",value:{times:1,direction:"forward"},show:"all"}),i.measureMode&&!i.measureMode.repeatLeft||p.subs.push({title:i18n.t("flat:editor.toolbar.repeat-right"),ks:"(])",type:"AddRepeat",iconSvg:"/img/icons/music/measure_repeat_right.svg",value:{times:1,direction:"backward"},show:"all"}),i.measureMode&&!i.measureMode.repeatLeft||p.subs.push({title:i18n.t("flat:editor.toolbar.double-barline"),type:"barline",iconSvg:"/img/icons/music/measure_double_barline.svg",value:Adagio.Utils.barlineUtils.DOUBLE_LIGHT,show:"all"}),i.measureMode&&!i.measureMode.endings||p.subs.push({separator:!0},{title:i18n.t("flat:editor.toolbar.first-ending"),type:"AddEndings",iconSvg:"/img/icons/music/ending_1.svg",value:1,show:"all"},{title:i18n.t("flat:editor.toolbar.second-ending"),type:"AddEndings",iconSvg:"/img/icons/music/ending_2.svg",value:2,show:"all"}),(!i.measureMode||i.measureMode.rehearsalNumber||i.measureMode.rehearsalLetter)&&p.subs.push({separator:!0}),i.measureMode&&!i.measureMode.rehearsalLetter||p.subs.push({title:i18n.t("flat:editor.toolbar.rehearsal"),type:"rehearsal",iconSvg:"/img/icons/music/rehearsalletters.svg",show:"all"}),i.measureMode&&!i.measureMode.rehearsalNumber||p.subs.push({title:i18n.t("flat:editor.toolbar.rehearsal-number"),type:"rehearsalnumber",iconSvg:"/img/icons/music/rehearsalnumber.svg",show:"all"}),(!i.measureMode||i.measureMode.segno||i.measureMode.coda||i.measureMode.fine)&&p.subs.push({separator:!0}),i.measureMode&&!i.measureMode.segno||p.subs.push({title:i18n.t("flat:editor.toolbar.segno"),type:"tag",iconSvg:"/img/icons/music/segno.svg",value:Adagio.Values.SoundType.SEGNO,show:"all"}),i.measureMode&&!i.measureMode.coda||p.subs.push({title:i18n.t("flat:editor.toolbar.coda"),type:"tag",iconSvg:"/img/icons/music/coda.svg",value:Adagio.Values.SoundType.CODA,show:"all"}),i.measureMode&&!i.measureMode.fine||p.subs.push({title:i18n.t("flat:editor.toolbar.fine"),type:"call",iconSvg:"/img/icons/music/fine.svg",value:Adagio.Values.SoundType.FINE,show:"all"}),(!i.measureMode||i.measureMode.dalSegno||i.measureMode.dacapo||i.measureMode.toCoda)&&p.subs.push({separator:!0}),i.measureMode&&!i.measureMode.dalSegno||p.subs.push({title:i18n.t("flat:editor.toolbar.dal-segno"),type:"call",iconSvg:"/img/icons/music/dalsegno.svg",value:Adagio.Values.SoundType.DALSEGNO,show:"all"}),i.measureMode&&!i.measureMode.dacapo||p.subs.push({title:i18n.t("flat:editor.toolbar.dacapo"),type:"call",iconSvg:"/img/icons/music/dacapo.svg",value:Adagio.Values.SoundType.DACAPO,show:"all"}),i.measureMode&&!i.measureMode.toCoda||p.subs.push({title:i18n.t("flat:editor.toolbar.to-coda"),type:"call",iconSvg:"/img/icons/music/to_coda.svg",value:Adagio.Values.SoundType.TOCODA,show:"all"}),(!i.measureMode||i.measureMode.accelerando||i.measureMode.ritardando)&&p.subs.push({separator:!0}),i.measureMode&&!i.measureMode.accelerando||p.subs.push({title:i18n.t("flat:editor.toolbar.accel"),type:"tempoChange",iconSvg:"/img/icons/music/accelerando.svg",value:Adagio.Values.TempoChangeType.ACCELERANDO,show:"all"}),i.measureMode&&!i.measureMode.ritardando||p.subs.push({title:i18n.t("flat:editor.toolbar.ritar"),type:"tempoChange",iconSvg:"/img/icons/music/ritardando.svg",value:Adagio.Values.TempoChangeType.RITARDANDO,show:"all"}),p.subs.push({separator:!0},{title:i18n.t("flat:editor.toolbar.main.remove"),ks:"("+c.delKeyName+")",type:"remove",iconSvg:"/img/icons/_common/trash.svg",show:"all"})}if(i.textMode!==!1){var q={title:i18n.t("flat:editor.toolbar.main.text.title"),action:"TextMode",ks:"("+c.ctrlKeyName+" + 7)",type:"text",role:"main",readWrite:!0,show:"all",subs:[]};c.toolbar.push(q),i.textMode&&!i.textMode.lyric||q.subs.push({title:i18n.t("flat:editor.toolbar.main.lyrics.title"),type:"lyrics",iconSvg:"/img/icons/music/lyrics.svg",action:"toggleLyricsMode",show:"all"}),(!i.textMode||i.textMode.lyric&&i.textMode.chord)&&q.subs.push({separator:!0}),i.textMode&&!i.textMode.chord||q.subs.push({title:i18n.t("flat:editor.toolbar.main.chord.title"),type:"chords",iconSvg:"/img/icons/music/chords.svg",show:"all",action:"toggleChordsMode"}),(!i.textMode||i.textMode.chord&&i.textMode.annotation)&&q.subs.push({separator:!0}),i.textMode&&!i.textMode.annotation||q.subs.push({title:i18n.t("flat:editor.toolbar.main.text.annotation"),type:"annotation",iconSvg:"/img/icons/music/annotation.svg",show:"all",action:"toggleAnnotationMode"})}i.global&&!i.global.undo||c.toolbar.push({title:i18n.t("flat:editor.toolbar.document.undo"),ks:"("+c.ctrlKeyName+" Z)",action:"undo",iconSvg:"/img/icons/_common/undo.svg",readWrite:!0,disableHistory:!0,role:"document",lock:c.lockUndo.bind(c,"undo"),disableOtherTools:!1,active:null}),i.global&&!i.global.undo||c.toolbar.push({title:i18n.t("flat:editor.toolbar.document.redo"),ks:"("+c.ctrlKeyName+" Y)",action:"redo",iconSvg:"/img/icons/_common/redo.svg",readWrite:!0,disableHistory:!0,role:"document",lock:c.lockUndo.bind(c,"redo"),disableOtherTools:!1,active:null}),i.global&&!i.global.volume||c.toolbar.push({separator:!0,role:"document",readWrite:!0},{title:i18n.t("flat:editor.toolbar.document.volume"),action:"volume",iconSvg:"/img/icons/_common/volume.svg",role:"document",disableOtherTools:!1,lock:c.lockAudio,active:null}),i.global&&!i.global.metronome||c.toolbar.push({title:i18n.t("flat:editor.toolbar.document.metronome"),action:"toggleMetronome",iconSvgFunc:function(){return c.audio&&2===c.audio.metronomeMode?"/img/icons/music/metronome-muted.svg":"/img/icons/music/metronome.svg"},value:function(){return c.audio&&1===c.audio.metronomeMode},iconClass:"toolbar-metronome",disableOtherTools:!1,role:"document",lock:c.lockAudio}),i.global&&!i.global.save||c.toolbar.push({separator:!0,role:"document"},{title:i18n.t("flat:editor.toolbar.document.save"),ks:"("+c.ctrlKeyName+" + S)",action:"save",iconTemplate:"/views/editor/_toolbar_save.html",role:"document",disableOtherTools:!1,readWrite:!0,active:null}),i.global&&!i.global.export||c.toolbar.push({title:i18n.t("flat:editor.toolbar.document.export"),iconTemplate:"/views/editor/_toolbar_export.html",role:"document",disableOtherTools:!1,active:null}),i.global&&!i.global.print||c.toolbar.push({title:i18n.t("flat:editor.toolbar.document.print"),ks:"("+c.ctrlKeyName+" + P)",iconTemplate:"/views/editor/_toolbar_print.html",role:"document",disableOtherTools:!1,active:null}),i.global&&!i.global.pageLayout||c.toolbar.push({title:i18n.t("flat:account.editor-preferences.page-layout.title"),action:"layout",iconSvg:"/img/icons/_common/layout.svg",role:"document",readWrite:!0,disableOtherTools:!1,active:null}),i.global&&!i.global.zoom||c.toolbar.push({separator:!0,readWrite:!0,role:"document"},{title:i18n.t("flat:editor.toolbar.document.zoom-in"),ks:"("+c.ctrlKeyName+' + "+")',type:"ZoomIn",action:"zoomIn",role:"document",iconSvg:"/img/icons/_common/zoom_in.svg",lock:c.lockZoom.bind(c,1),active:null},{title:i18n.t("flat:editor.toolbar.document.zoom-out"),ks:"("+c.ctrlKeyName+' + "-")',type:"ZoomOut",action:"zoomOut",role:"document",iconSvg:"/img/icons/_common/zoom_out.svg",lock:c.lockZoom.bind(c,-1),active:null}),i.global&&!i.global.concertPitch||c.toolbar.push({title:i18n.t("flat:editor.toolbar.document.toggle-concert-pitch"),type:"ToggleConcertPitch",action:"toggleConcertPitch",role:"document",iconSvg:"/img/icons/_common/concert-pitch.svg",showFnc:function(){return c.interaction.dataReader&&c.interaction.dataReader.hasTransposingInstrument()},value:function(){return c.interaction.config.get().isConcertPitch}}),i.global&&!i.global.pageLayout||c.toolbar.push({title:i18n.t("flat:editor.toolbar.document.page-layout"),action:"switchScoreLayout",iconSvg:"/img/icons/_common/page.svg",iconSvgFunc:function(){return"/img/icons/_common/"+b.scoreLayout+".svg"},role:"document",active:null}),i.global&&!i.global.keyboardShortcuts||c.toolbar.push({title:i18n.t("flat:editor.toolbar.document.ks"),ks:"(?)",action:"openKeyboardShortcutsModal",iconSvg:"/img/icons/_common/keyboard.svg",role:"document",readWrite:!0,disableOtherTools:!1}),i.global&&!i.global.pianoKeyboard||c.toolbar.push({title:i18n.t("flat:editor.toolbar.document.pkeyboard"),iconSvg:"/img/icons/_common/piano-keyboard.svg",role:"document",readWrite:!0,disableOtherTools:!1,action:function(){c.$parent.displayPianoKeyboard=!c.$parent.displayPianoKeyboard,h.set("editor.piano-keyboard",c.$parent.displayPianoKeyboard)},value:function(){return c.$parent&&c.$parent.displayPianoKeyboard}}),i.global&&!i.global.voiceSwitch||c.toolbar.push({type:"all",role:"main",readWrite:!0,action:"changeVoice",subs:[{title:i18n.t("flat:editor.toolbar.voice.one"),type:"voice",value:0,iconSvg:"/img/icons/music/voice_1.svg",group:!0,show:"all"},{title:i18n.t("flat:editor.toolbar.voice.two"),type:"voice",value:1,iconSvg:"/img/icons/music/voice_2.svg",show:"all"},{title:i18n.t("flat:editor.toolbar.voice.remove"),type:"removeVoice",iconSvg:"/img/icons/music/voice_remove.svg",show:"all"}]});for(var r={},s={},t=0;t<c.toolbar.length;t++)c.toolbar[t].type&&(r[c.toolbar[t].type]=t);for(var u in r)if(r.hasOwnProperty(u)){if(s[r[u]]={},!c.toolbar[r[u]].subs)continue;for(t=0;t<c.toolbar[r[u]].subs.length;t++){var v=c.toolbar[r[u]].subs[t];s[r[u]][v.type]=t}}c.instruments={},g.get({locale:b.account.locale||"en"},function(a){a.instruments&&(c.mappingInstruments=a.instruments.$midi,_.each(a,function(a,b){b.startsWith("$")||_.each(_.keys(a),function(a){c.instruments[a]=b})}),c.updateActiveToolbar())}),c.getToolbar=function(a){for(var b=0;b<c.toolbar.length;b++)if(c.toolbar[b].type===a)return c.toolbar[b]},c.setActiveToolbar=function(a){if(a){if(c.exToolbar=c.activeToolbar,c.interaction.submode=null,c.activeToolbar===a&&c.enabled)return c.interaction.setMode(null),c.activeToolbar=null,void c.updateActiveToolbar();c.interaction.setMode(a.type),c.activeToolbar=a,c.updateActiveToolbar()}},c.triggerTool=function(a,d,e,f){var g,h;if(!e&&"document"!==d.role)return void this.setActiveToolbar(d);if(e){if(h=c.isSubtoolActive(d.type,e),!e.subs&&null!==e.active&&angular.isArray(e.value))e.currentIdx===e.value.length-1?e.currentIdx=-1:(e.currentIdx="undefined"!=typeof e.currentIdx?e.currentIdx:-1,g=e.value[++e.currentIdx]);else if(e.subs){if(!f)return;(h!==f||_.isObject(f.value))&&(g=f.value)}}else e={};"undefined"!=typeof Raven&&Raven.captureBreadcrumb({category:"toolbar",message:e&&(e.action||e.title)||d&&(d.action||d.title)}),b.$broadcast("Toolbar.triggerTool"),this.action(d,e,g,h),this.updateActiveToolbar()},c.isSubtoolActive=function(a,b){if(c.interaction.noteInfo){var d,e=c.cursor.getPosition();switch(a){case"note":switch(b.type){case"duration":return this.followUp(b,c.interaction.noteInfo.durationType);case"accidental.flat":case"accidental.sharp":case"accidental.natural":var f,g=-1;if(!c.interaction.noteInfo.pitches)return this.followUp(b,null);c.interaction.noteInfo.lines&&(g=c.interaction.noteInfo.lines.indexOf(e.line)),g!==-1&&g<c.interaction.noteInfo.pitches.length&&(f=c.interaction.noteInfo.pitches[g].alter);var h={"accidental.flat":f<0?b.value[-f-1]:null,"accidental.sharp":f>0?b.value[f-1]:null,"accidental.natural":0===f?Adagio.Values.AccidentalStyle.NATURAL:null};return this.followUp(b,h[b.type]);case"head":return this.followUp(b,c.interaction.noteInfo.notehead);case"tuplet":return this.followUp(b,c.interaction.noteInfo.tupletType);case"ghost":return c.interaction.noteInfo.ghostNotes&&c.interaction.noteInfo.lines?(g=c.interaction.noteInfo.lines.indexOf(e.line),this.followUp(b,c.interaction.noteInfo.ghostNotes[g])):this.followUp(b,null);case"dot":return this.followUp(b,c.interaction.noteInfo.nbDots);case"tie":return this.followUp(b,c.interaction.noteInfo.isTied);case"shift":return this.followUp(b,c.interaction.noteInfo.octaveShift?c.interaction.noteInfo.octaveShift.size:null)}return!1;case"ornaments":var i,j;switch(b.type){case"arpeggio":return c.interaction.noteInfo.hasArpeggio;case"mordent":if(c.interaction.noteInfo.ornaments[Adagio.Values.OrnamentType.MORDENT])i=Adagio.Values.OrnamentType.MORDENT;else{if(!c.interaction.noteInfo.ornaments[Adagio.Values.OrnamentType.INVERTED_MORDENT])return this.followUp(b,{});i=Adagio.Values.OrnamentType.INVERTED_MORDENT}return j=angular.copy(c.interaction.noteInfo.ornaments[i]),j.value=i,this.followUp(b,j);case"turns":if(c.interaction.noteInfo.ornaments[Adagio.Values.OrnamentType.TURN])i=Adagio.Values.OrnamentType.TURN;else{if(!c.interaction.noteInfo.ornaments[Adagio.Values.OrnamentType.INVERTED_TURN])return this.followUp(b,{});i=Adagio.Values.OrnamentType.INVERTED_TURN}return j=angular.copy(c.interaction.noteInfo.ornaments[i]),j.value=i,this.followUp(b,j);case"trill":case"tremolo":return i=b.value,c.interaction.noteInfo.ornaments[i]?this.followUp(b,i):this.followUp(b,null);case"glissando":return c.interaction.noteInfo.hasGlissando}return!1;case"measure":var k=c.interaction.getMeasureInfo();switch(b.type){case"clef":return this.followUp(b,{line:k.clef.line,sign:k.clef.sign});case"barline":return!!k.rightBarline&&this.followUp(b,k.rightBarline["bar-style"]);case"AddRepeat":if(k.leftBarline&&k.leftBarline.repeat){var l={times:k.leftBarline.repeat.$times,direction:k.leftBarline.repeat.$direction};if(this.followUp(b,l))return!0}if(k.rightBarline&&k.rightBarline.repeat){var m={times:k.rightBarline.repeat.$times,direction:k.rightBarline.repeat.$direction};if(this.followUp(b,m))return!0}return!1;case"AddEndings":return c.interaction.getEndings().indexOf(b.value)!==-1&&this.followUp(b,b.value);case"call":return this.followUp(b,k.jumpCall);case"tag":return this.followUp(b,k.jumpTag);case"rehearsal":return k.rehearsalType===Adagio.Values.RehearsalType.AUTO;case"rehearsalnumber":return k.rehearsalType===Adagio.Values.RehearsalType.MEASURE_NUMBER;case"tempoChange":return this.followUp(b,c.interaction.noteInfo.tempoChange?c.interaction.noteInfo.tempoChange.type:"")}return!1;case"articulation":switch(b.type){case"arti":case"notation":for(d=0;d<c.interaction.noteInfo.articulations.length;d++)if(this.followUp(b,c.interaction.noteInfo.articulations[d]))return!0;return!1;case"bow":for(d=0;d<c.interaction.noteInfo.technical.length;d++)if(this.followUp(b,c.interaction.noteInfo.technical[d]))return!0;return!1;case"hammer":var n=c.cursor.getPosition().string;if("undefined"!=typeof n){var o=c.interaction.dataReader.getStringIdx(c.interaction.noteInfo,n);if(null!==o)return c.interaction.noteInfo.hammerOnPullOffs[o]}return!1;case"fingering":return g=-1,f=null,c.interaction.noteInfo.fingerings?(c.interaction.noteInfo.lines&&"undefined"==typeof e.string?g=c.interaction.noteInfo.lines.indexOf(e.line):c.interaction.noteInfo.lines&&"undefined"!=typeof e.string&&(g=c.interaction.dataReader.getStringIdx(c.interaction.noteInfo,e.string)),g!==-1&&g<c.interaction.noteInfo.fingerings.length&&(f=c.interaction.noteInfo.fingerings[g]),this.followUp(b,f)):this.followUp(b,f);case"slurs":return c.interaction.noteInfo.isInSlur;case"drumroll":var p=Adagio.Values.OrnamentType.TREMOLO;return c.interaction.noteInfo.ornaments[p]?this.followUp(b,{value:p,nbBeam:c.interaction.noteInfo.ornaments[p].nbBeam}):this.followUp(b,{});case"buzzroll":return c.interaction.noteInfo.ornaments[Adagio.Values.OrnamentType.BUZZ]}return!1;case"dynamics":switch(b.type){case"dyn":return this.followUp(b,c.interaction.noteInfo.dynamicStyle);case"wedge":return this.followUp(b,c.interaction.noteInfo.wedgeType);case"pizz":return this.followUp(b,c.interaction.noteInfo.pizzicatoData?c.interaction.noteInfo.pizzicatoData.type:null);case"ped":return!!c.interaction.noteInfo.pedal}return!1;case"text":switch(b.type){case"lyrics":return c.interaction.mode===a&&c.interaction.submode===b.type;case"chords":return c.interaction.mode===a&&c.interaction.submode===b.type;case"annotation":return c.interaction.mode===a&&c.interaction.submode===b.type}return!1;case"all":switch(b.type){case"voice":return this.followUp(b,c.interaction.voiceIdx)}return!1}}},c.followUp=function(a,b){if("undefined"==typeof a.subs&&angular.isArray(a.value)){if(a.currentIdx=-1,null===b)return!1;for(var c=0;c<a.value.length;c++)if(angular.equals(a.value[c],b)&&(a.currentIdx=c,null!==a.active))return a.value[c];return!1}if("undefined"==typeof a.subs&&"object"==typeof a.value&&angular.equals(a.value,b)){if(null!==a.active)return!0}else if("undefined"==typeof a.subs&&"object"!=typeof a.value&&a.value===b){if(null!==a.active)return!0}else if("undefined"!=typeof a.subs&&a.subs.length>0){for(var d=null,e=0;e<a.subs.length;e++)if(angular.equals(a.subs[e].value,b)){d=e;break}var f=a.subs[d||0];if(null!==a.active&&null!==d)return f}return null},c.shouldShowTool=function(a,b){if(!c.mappingInstruments)return!1;var d=c.getGroup(b);return!!(!d||!a||_.isArray(a)&&a.indexOf(d)>-1||_.isString(a)&&c.groups[a].indexOf(d)>-1)},c.getGroup=function(a){if(!c.mappingInstruments)return!1;var b;return null===a||void 0===a?b=void 0:(b=c.mappingInstruments[a.program],b?b=b.group:a.isUnpitched&&(b="unpitched-percussion")),b},c.close=function(){this.setActiveToolbar(null),b.$broadcast("Toolbar.triggerTool")},c.action=function(a,b,d,e){var f,g=b.action||a.action||a,h=b.type||a.type;"undefined"!=typeof d?f=d:"undefined"!=typeof b.value?f=b.value:"undefined"!=typeof a.value&&(f=a.value),"function"==typeof g?g():"undefined"!=typeof c.interaction[g]?c.interaction[g]():"document"!==a.role&&this.checkUpToolbar(g,h,f,e)},c.$watch("interaction.noteInfo",function(){c.updateActiveToolbar();
}),c.$watch("interaction.voiceIdx",function(){c.updateActiveToolbar()}),c.$watch("$parent.displayPianoKeyboard",function(){c.updateActiveToolbar()}),c.updateActiveToolbar=function(){for(var a=0;a<this.toolbar.length;a++)this.toolbar[a].vars={},this.toolbar[a].vars.active=!1,this.toolbar[a].showFnc?this.toolbar[a].vars.show=this.toolbar[a].showFnc.call(this.toolbar[a]):this.toolbar[a].vars.show=this.shouldShowTool(this.toolbar[a].show,c.interaction.MIDIProgram),this.toolbar[a].vars.lock=this.toolbar[a].lock&&this.toolbar[a].lock(),this.toolbar[a].value&&(this.toolbar[a].vars.value=this.toolbar[a].value()),this.toolbar[a].iconSvgFunc&&(this.toolbar[a].iconSvg=this.toolbar[a].iconSvgFunc());if(this.activeToolbar&&this.activeToolbar.subs){if(this.activeToolbar.vars.show===!1)return void this.setActiveToolbar(this.exToolbar);var b=[this.activeToolbar];"undefined"!=typeof r.all&&b.push(this.toolbar[r.all]);for(var d=0;d<b.length;d++)for(var e=b[d],f=0;f<e.subs.length;f++)if(e.subs[f].vars={},e.subs[f].showFnc?e.subs[f].vars.show=e.subs[f].showFnc():e.subs[f].vars.show=this.shouldShowTool(e.subs[f].show,c.interaction.MIDIProgram),e.subs[f].vars.show&&(e.subs[f].iconSvgFunc&&(e.subs[f].iconSvg=e.subs[f].iconSvgFunc(e.subs[f].currentIdx)),e.subs[f].vars.lock=!1,e.subs[f].lock&&(e.subs[f].vars.lock=e.subs[f].lock()),!e.subs[f].vars.lock)){null!==e.subs[f].active&&(e.subs[f].vars.active=this.isSubtoolActive(e.type,e.subs[f],c.interaction.noteInfo));var g=e.subs[f].subs;if(g){for(var h=0,i=0;i<g.length;i++)g[i].vars=g[i].vars||{},g[i].vars.show=!0,g[i].showFnc&&(g[i].vars.show=g[i].showFnc.call(e.subs[f],g[i])),g[i].vars.show&&h++;0===h&&(e.subs[f].vars.lock=!0)}if("all"===e.type&&"voice"===e.subs[f].type){e.subs[f].vars.activated=!1;var j=c.cursor.getPosition();c.interaction.dataReader.data&&j&&(e.subs[f].vars.activated=c.interaction.dataReader.hasVoiceAtMeasure(j,e.subs[f].value))}}}},c.updateInstrumentsList=function(){var a=b.score;if(a){c.instrumentsList=[];for(var d=c.interaction.dataReader.data.getNbParts(),e=0;e<d;e++){var f=c.interaction.dataReader.data.getPartHeader(e),g={name:Adagio.Utils.partHeaderUtils.getName(f),group:c.getGroup(c.interaction.getMIDIInstrumentId(e))};c.instrumentsList.push(g)}}},c.moveCursorToPart=function(a){var b=c.cursor.getPosition();b.partIdx=a,b.staffIdx=0,b.voiceIdx=0,c.interaction.changeCursor(b)},c.checkUpToolbar=function(a,b,d,f){var g=this.getAction(a,b,d,f,c.interaction.noteInfo);if(!g)return e.warn(new Error("[interaction/checkUpToolbar] action not found"),{extra:{action:a,type:b,value:d,active:f,noteInfo:c.interaction.noteInfo}}),!1;for(var h=0;h<g.length&&("undefined"!=typeof g[h].arg||!c.interaction[g[h].fnc].apply(c.interaction));h++)c.interaction[g[h].fnc].apply(c.interaction,g[h].arg);c.interaction.focusKeyboard()},c.$on("Interaction.Updated",function(a,b,d){d&&c.updateInstrumentsList()}),c.$on("Editor.rendered",function(){c.updateInstrumentsList()}),c.$on("RightsHandler.score_write",function(a,b){b===!0&&c.setActiveToolbar(c.toolbar[r.note]),e.debug("[Toolbar] received score_write, enable toolbar"),c.enabled=b,c.enabled||c.setActiveToolbar(null)}),c.$on("Toolbar.mode",function(b,c){var d=null;c&&(d=this.toolbar[r[c]]),this.setActiveToolbar(d),a(angular.noop)}.bind(c)),c.$on("Toolbar.close",c.close.bind(c)),c.$watch("Interac.MIDIProgram",function(b,d){d&&b&&c.getGroup(d)!==c.getGroup(b)&&(c.triggerAnimation=!0,a(function(){c.triggerAnimation=!1},210))}),b.$broadcast("Toolbar.loaded"),b.$broadcast("Toolbar.triggerTool"),e.debug("[Toolbar] loaded"),c.getAction=function(a,b,d,e){var f=[];switch(d=angular.copy(d),b){case"tuplet":return e&&f.push({fnc:"RemoveTuplet",arg:[]}),d&&f.push({fnc:"AddTuplet",arg:[d]}),f;case"duration":return c.interaction.noteInfo.durationType!==d&&f.push({fnc:"setDuration",arg:[d]},{fnc:"changeDuration",arg:[d]}),f.push({fnc:"isNotRest",arg:["goRight"]}),f;case"accidental.sharp":return[{fnc:"lookUpSharp",arg:[]}];case"accidental.flat":return[{fnc:"lookUpFlat",arg:[]}];case"accidental.natural":return[{fnc:"lookUpNatural",arg:[]}];case"tie":return e?[{fnc:"RemoveTie",arg:[]}]:[{fnc:"AddTie",arg:[d]},{fnc:"isNoError"},{fnc:"goRight",arg:[!1,!0]}];case"rest":return[{fnc:"lookupInsertRest",arg:[]}];case"dot":return e&&!d&&(d=0),f.push({fnc:"AddDotted",arg:[c.interaction.noteInfo.durationType,d]},{fnc:"isNoError"}),c.interaction.noteInfo.isRest?f.push({fnc:"adaptDuration",arg:[]}):f.push({fnc:"goRight",arg:[]},{fnc:"adaptDuration",arg:[]}),f;case"remove":return[{fnc:"removeElem",arg:[!0]}];case"head":return[{fnc:"changeNoteHead",arg:[d]}];case"voice":return[{fnc:"changeVoice",arg:[d]}];case"removeVoice":return[{fnc:"deleteVoice",arg:[]}];case"arti":return e?[{fnc:"RemoveArticulation",arg:[d]}]:[{fnc:"AddArticulation",arg:[d]}];case"notation":return e?[{fnc:"RemoveNotation",arg:[d]}]:[{fnc:"AddNotation",arg:[d]}];case"bow":return e?[{fnc:"RemoveTechnical",arg:[d]}]:[{fnc:"AddTechnical",arg:[d]}];case"hammer":return e?[{fnc:"RemoveHammer",arg:[]}]:[{fnc:"AddHammer",arg:[]}];case"slurs":return[{fnc:"lookUpSlurs",arg:[]}];case"fingering":return[{fnc:"incFingering",arg:[]}];case"arpeggio":return e?[{fnc:"RemoveArpeggio",arg:[]}]:[{fnc:"AddArpeggio",arg:[]}];case"copy":return[{fnc:"blocCopy",arg:[]}];case"cut":return[{fnc:"blocCut",arg:[]}];case"paste":return[{fnc:"paste",arg:[]}];case"transpose":return[{fnc:"openModal",arg:["transpose"]}];case"clef":return[{fnc:"openModal",arg:["keyselection"]}];case"AddRepeat":return e?[{fnc:"RemoveBarline",arg:[d]}]:[{fnc:"AddRepeat",arg:[d]}];case"AddEndings":return e?[{fnc:"RemoveEndings",arg:[d]}]:[{fnc:"AddEndings",arg:[d]}];case"barline":return e?[{fnc:"RemoveBarline",arg:[d]}]:[{fnc:"AddDoubleBarline",arg:[]}];case"tag":return e?[{fnc:"RemoveJumpTag",arg:[]}]:[{fnc:"AddJumpTag",arg:[d]}];case"rehearsal":return e?[{fnc:"RemoveRehearsal",arg:[]}]:[{fnc:"AddRehearsal",arg:[]}];case"rehearsalnumber":return e?[{fnc:"RemoveRehearsalNumber",arg:[]}]:[{fnc:"AddRehearsalNumber",arg:[]}];case"call":return e?[{fnc:"RemoveJumpCall",arg:[]}]:[{fnc:"AddJumpCall",arg:[d]}];case"tempoChange":return[{fnc:"lookupTempoChange",arg:[d]}];case"Keys":return[{fnc:"openModal",arg:["keysignature"]}];case"Time":return[{fnc:"openModal",arg:["timesignature"]}];case"Tempo":return[{fnc:"openModal",arg:["tempo",{audio:c.audio}]}];case"trill":return e?[{fnc:"RemoveOrnament",arg:[d]}]:[{fnc:"AddOrnament",arg:[d]}];case"tremolo":return e?[{fnc:"RemoveOrnament",arg:[d]}]:[{fnc:"AddOrnament",arg:[d,{nbBeam:3}]}];case"glissando":return e?[{fnc:"RemoveGlissando",arg:[]}]:[{fnc:"AddGlissando",arg:[]}];case"mordent":case"turns":var g=d.value;return delete d.value,[{fnc:"AddOrnament",arg:[g,d]}];case"dyn":return e?[{fnc:"RemoveDynamics",arg:[0]}]:[{fnc:"AddDynamics",arg:[d,"below"]}];case"wedge":return[{fnc:"lookupWedge",arg:[d,"below"]}];case"pizz":return e?[{fnc:"RemovePizzicato",arg:[c.interaction.noteInfo.pizzicatoData.idx]}]:[{fnc:"AddPizzicato",arg:[d,"above"]}];case"ped":return[{fnc:"lookupPedal",arg:["above"]}];case"shift":return[{fnc:"lookupOctaveShift",arg:[d,"above"]}];case"grace":return[{fnc:"insertGrace",arg:[]}];case"slashgrace":return[{fnc:"insertSlashGrace",arg:[]}];case"ghost":return e?[{fnc:"RemoveGhostNote",arg:[]}]:[{fnc:"AddGhostNote",arg:[]}];case"drumroll":var h=angular.isArray(d);return e&&h?[{fnc:"RemoveOrnament",arg:[e.value]}]:(e&&f.push({fnc:"RemoveOrnament",arg:[d.value]}),f.push({fnc:"AddOrnament",arg:[d.value,{nbBeam:d.nbBeam}]}),f);case"buzzroll":return e?[{fnc:"RemoveOrnament",arg:[d]}]:[{fnc:"AddOrnament",arg:[d]}];case"enharmonic":return[{fnc:"SwitchEnharmonic",arg:[]}]}return null}}],link:{post:function(a,b){$(b).on("shown.bs.dropdown",".dropdown-container",function(){var a=this.getBoundingClientRect();$(this).find(".dropdown-menu").css({position:"fixed",top:a.top,left:a.left})})}}}}]),angular.module("flat.editor.directives").directive("annotationinput",["$rootScope",function(a){"use strict";return{restrict:"AE",scope:!0,controller:["$rootScope","$scope","$element",function(a,b,c){var d=b.interaction;b.pos=d.cursor.pos[a.account.id],b.checkPlacement=function(){d.selected.elem&&"word"===d.selected.elem.type?b.placement=d.selected.elem.data.placement:d.noteInfo.wordData?b.placement=d.noteInfo.wordData.placement:b.placement="above"},b.getAnnotationData=function(){return d.selected.elem&&"word"===d.selected.elem.type?d.selected.elem.data:d.noteInfo.wordData?d.noteInfo.wordData:{}},b.checkAddRemove=function(a){0===b.content.trim().length?b.checkRemove(a):b.checkAdd(a)},b.checkBlur=function(){b.checkAddRemove(),d.selected.elem&&"word"===d.selected.elem.type&&d.selected.cleanUp()},b.checkAdd=function(a){if(b.getAnnotationData().text===b.content&&b.placement===b.getAnnotationData().placement||!(b.content.length>0))return a&&a();if(d.selected.elem&&"word"===d.selected.elem.type){var c=angular.copy(d.selected.elem.topPos);c.wordIdx=d.selected.elem.data.idx,d.AddAnnotationAtIdx(b.content,b.placement,c,a)}else d.AddAnnotation(b.content,b.placement,angular.copy(b.pos),a)},b.moveBackspace=function(a){var e=c.find("input")[0].selectionStart;0===e&&0===b.content.length&&(a.stopPropagation(),b.checkRemove(function(){d.goLeft()}),d.selected.elem&&"word"===d.selected.elem.type&&d.selected.cleanUp())},b.checkRemove=function(a){return 0===b.content.trim().length&&b.getAnnotationData().text?void(d.selected.elem&&"word"===d.selected.elem.type?d.RemoveAnnotation(d.selected.elem.topPos,b.getAnnotationData().idx,a):d.RemoveAnnotation(angular.copy(b.pos),b.getAnnotationData().idx,a)):a&&a()},b.changePlacement=function(a){a&&"above"===b.placement?b.placement="below":a||"below"!==b.placement||(b.placement="above")},b.moveRight=function(a){var e=c.find("input")[0].selectionStart,f=b.content.length;e+1>f&&(a.preventDefault(),b.checkAddRemove(function(){d.goRight()}),d.selected.elem&&"word"===d.selected.elem.type&&d.selected.cleanUp())},b.moveLeft=function(a){var e=c.find("input")[0].selectionStart,f=c.find("input")[0].selectionEnd;0===e&&e===f&&(a.preventDefault(),b.checkAddRemove(function(){d.goLeft()}),d.selected.elem&&"word"===d.selected.elem.type&&d.selected.cleanUp())},b.escape=function(b){b.stopPropagation(),"select"!==d.mode&&a.$broadcast("Toolbar.mode","select"),d.selected.elem&&"word"===d.selected.elem.type&&d.selected.cleanUp()},b.checkup=function(a){switch(a.keyCode){case 38:b.changePlacement(!1);break;case 40:b.changePlacement(!0);break;case 39:b.moveRight(a);break;case 37:b.moveLeft(a);break;case 27:b.escape(a);break;case 8:b.moveBackspace(a);break;case 13:b.checkAddRemove(function(){d.goRight(),d.selected.elem&&"word"===d.selected.elem.type&&d.selected.cleanUp()})}a.stopPropagation()}}],link:function(b,c){function d(){b.checkPlacement(),e()}function e(){var a=b.getAnnotationData();"undefined"==typeof a.text?b.content="":b.content=a.text,h.selected.elem&&"word"===h.selected.elem.type?f(h.selected.elem):g(h.cursor.getNote()),b.updateInputWidth()}function f(c){var d=i.getCoord(c.elem),e=i.getCoord(c.mea),f=c.topPos,g=h.mouse.drawer.getStaffWordsY(f.staffIdx,f.partIdx,f.measureIdx,b.placement)*i.scaling,j=i.findGoodPage(f.partIdx,f.measureIdx),k=$("#svg-content")[0].getBoundingClientRect(),l=h.svgTools.svg[j.pageIdx].elem.getBoundingClientRect(),m=0;"page"===a.scoreLayout&&(m=l.left-k.left);var n=l.top-k.top;b.moveTo(m+d.abs.x,e.abs.y+n+g)}function g(c){var d=i.getCoord(c.note),e=i.getCoord(c.mea),f=h.cursor.getPosition(),g=h.mouse.drawer.getStaffWordsY(f.staffIdx,f.partIdx,f.measureIdx,b.placement)*i.scaling,j=i.findGoodPage(f.partIdx,f.measureIdx),k=$("#svg-content")[0].getBoundingClientRect(),l=h.svgTools.svg[j.pageIdx].elem.getBoundingClientRect(),m=0;"page"===a.scoreLayout&&(m=l.left-k.left);var n=l.top-k.top;b.moveTo(m+d.abs.x,e.abs.y+n+g)}var h=b.interaction,i=h.svgTools;b.textWidth=function(a){return $.fn.textWidth(a,c.find("input").css("font"))+25},b.moveTo=function(a,d){b.baseX=a,b.baseY=d,b.inputMinWidth=b.textWidth(b.content),b.updateInputWidth(),c.find("input").focus().select()};var j=b.$watch("pos",d,!0),k=b.$watch("placement",e,!0),l=b.$watch("content",function(){b.updateInputWidth()});b.moveToProcess=function(){c.css({left:b.baseX-12.5,top:b.baseY-($("#annotationinput").height()-i.wordSize/4),"font-size":i.wordSize,height:i.wordSize+i.wordSize/4})},b.updateInputWidth=function(){c.css("width",Math.max(b.inputMinWidth,b.textWidth(b.content))),b.moveToProcess()},b.clickPlacement=function(a,c){c<2.5?b.changePlacement(!0):b.changePlacement()};var m=b.$on("ScoreScaling.Updated",b.positionListener),n=b.$on("mouse.click.line",b.clickPlacement);c.on("$destroy",function(){j&&j(),l&&l(),k&&k(),n&&n(),m&&m(),h.focusKeyboard()}),b.checkPlacement()}}}]),angular.module("flat.editor.directives").directive("chordinput",["$rootScope","Chords","$timeout",function(a,b,c){"use strict";return{restrict:"AE",scope:!0,controller:["$rootScope","$scope",function(a,d){var e=d.interaction;d.dic=b.get(),d.content="",d.focusIdx=0,d.proposition=[],d.pos=e.cursor.pos[a.account.id],d.libChord=new LibChord,d.checkup=function(a){"keydown"===a.type&&(37===a.keyCode&&d.leftArrow(a),39===a.keyCode&&d.rightArrow(a),13!==a.keyCode&&32!==a.keyCode||d.enter(a),8===a.keyCode&&d.backspace(a),9===a.keyCode&&d.tab(a),27===a.keyCode&&d.escape(a)),a.stopPropagation()},d.escape=function(b){b.stopPropagation(),"select"!==e.mode&&a.$broadcast("Toolbar.mode","select"),e.selected.elem&&"chord"===e.selected.elem.type&&e.selected.cleanUp()},d.tab=function(a){d.proposition.length>0&&(d.checkAddChord(d.proposition[d.focusIdx],function(){e.goRightMeasure(!0)}),e.selected.elem&&"chord"===e.selected.elem.type&&e.selected.cleanUp()),a.preventDefault()},d.backspace=function(){0===d.content.length&&(e.selected.elem&&"chord"===e.selected.elem.type?e.RemoveHarmony(e.selected.elem.chordIdx,angular.copy(e.selected.elem.topPos)):e.noteInfo.harmony&&e.RemoveHarmony(e.noteInfo.harmony.idx),e.goLeft(),e.selected.elem&&"chord"===e.selected.elem.type&&e.selected.cleanUp())},d.enter=function(a){d.proposition.length>0&&(d.checkAddChord(d.proposition[d.focusIdx],function(){e.goRight(!0,!0)}),e.selected.elem&&"chord"===e.selected.elem.type&&e.selected.cleanUp()),a.stopPropagation()},d.rightArrow=function(a){d.proposition.length>0&&d.focusIdx+1<d.proposition.length?c(function(){d.proposition[d.focusIdx].focus=!1,d.focusIdx++,d.proposition[d.focusIdx].focus=!0}):d.focusIdx+1>=d.proposition.length&&(e.goRight(),e.selected.elem&&"chord"===e.selected.elem.type&&e.selected.cleanUp()),a.preventDefault()},d.leftArrow=function(a){d.proposition.length>0&&d.focusIdx>0?c(function(){d.proposition[d.focusIdx].focus=!1,d.focusIdx--,d.proposition[d.focusIdx].focus=!0}):d.focusIdx-1<=0&&(e.goLeft(),e.selected.elem&&"chord"===e.selected.elem.type&&e.selected.cleanUp()),a.preventDefault()},d.checkUpMatch=function(a){if(a=a||"",d.previous!==a){d.previous=a;var b=d.libChord.resolveString(a);b.forEach(function(a){a.letter=d.libChord.resolveChord(a)}),d.proposition=angular.copy(b),b.length>0&&(d.proposition[0].focus=!0,d.focusIdx=0)}},d.cleanFocus=function(){for(var a=0;a<d.proposition.length;a++)d.proposition[a].focus=!1},d.clean=function(){d.proposition=[],d.focusIdx=0,d.content="",d.previous=""},d.checkAddChord=function(a,b){if(e.selected.elem&&"chord"===e.selected.elem.type){var c=angular.copy(e.selected.elem.topPos);c.harmonyIdx=e.selected.elem.chordIdx,e.AddHarmonyAtIdx(a,c,b)}else e.AddHarmony(a,angular.copy(d.pos),b)},d.clickChord=function(a){d.checkAddChord(a,function(){e.goRightMeasure(!0)}),e.selected.elem&&"chord"===e.selected.elem.type&&e.selected.cleanUp()}}],link:function(b,c){function d(){var a=e();a?b.content=b.libChord.resolveChord(a)||"":b.content="",h.selected.elem&&"chord"===h.selected.elem.type?f(h.selected.elem):g(h.cursor.getNote()),b.updateInputWidth()}function e(){var a=h.cursor.getPosition();return h.selected.elem&&"chord"===h.selected.elem.type?h.data.getHarmonyData({partIdx:a.partIdx,measureIdx:a.measureIdx,harmonyIdx:h.selected.elem.chordIdx}):h.noteInfo.harmony?h.data.getHarmonyData({partIdx:a.partIdx,measureIdx:a.measureIdx,harmonyIdx:h.noteInfo.harmony.idx}):void 0}function f(c){var d=i.getCoord(c.elem),e=i.getCoord(c.mea),f=c.topPos,g=h.mouse.drawer.getSystemChordsY(f.partIdx,f.measureIdx)*i.scaling,j=i.findGoodPage(f.partIdx,f.measureIdx),k=$("#svg-content")[0].getBoundingClientRect(),l=h.svgTools.svg[j.pageIdx].elem.getBoundingClientRect(),m=0;"page"===a.scoreLayout&&(m=l.left-k.left);var n=l.top-k.top;b.moveTo(m+d.abs.x,e.abs.y+n+g)}function g(c){var d=i.getCoord(c.note),e=i.getCoord(c.mea),f=h.cursor.getPosition(),g=h.mouse.drawer.getSystemChordsY(f.partIdx,f.measureIdx)*i.scaling,j=i.findGoodPage(f.partIdx,f.measureIdx),k=$("#svg-content")[0].getBoundingClientRect(),l=i.svg[j.pageIdx].elem.getBoundingClientRect(),m=0;"page"===a.scoreLayout&&(m=l.left-k.left);var n=l.top-k.top;b.moveTo(m+d.abs.x,e.abs.y+n+g)}var h=b.interaction,i=h.svgTools;b.textWidth=function(a){return $.fn.textWidth(a,c.find("input").css("font"))+25},b.moveTo=function(a,d){b.baseX=a,b.baseY=d,b.checkUpMatch(b.content),b.inputMinWidth=b.textWidth(b.content),b.updateInputWidth(),c.find("input").focus().select()};var j=b.$watch("pos",d,!0),k=b.$watch("content",function(){b.updateInputWidth()}),l=b.$on("ScoreScaling.Updated",b.positionListener);b.moveToProcess=function(){c.css({left:b.baseX-$("#chordinput .input").width()/5,top:b.baseY-$("#chordinput .input").height()-10,"font-size":i.harmonySize,height:i.harmonySize+i.harmonySize/4})},b.updateInputWidth=function(){c.find(".input").css("width",Math.max(b.inputMinWidth,b.textWidth(b.content))),b.moveToProcess()},c.on("$destroy",function(){j&&j(),k&&k(),l&&l(),h.focusKeyboard()})}}}]),angular.module("flat.editor.directives").directive("custominput",["$rootScope","$timeout",function(a,b){"use strict";return{restrict:"AE",scope:!0,controller:["$rootScope","$scope","$element",function(a,b,c){var d=b.interaction;b.content="",b.inputMinWidth=0,b.inputWidth=0,b.lvl=0,b.moveLeft=function(a){var e=c.find("input")[0].selectionStart,f=c.find("input")[0].selectionEnd;0===e&&e===f&&(a.preventDefault(),b.checkAddRemove(function(){d.goLeft()}),d.selected.elem&&"lyricLine"===d.selected.elem.type&&d.selected.cleanUp())},b.checkBlur=function(){b.checkAddRemove(),d.selected.elem&&"lyricLine"===d.selected.elem.type&&d.selected.cleanUp()},b.moveRight=function(a){var e=c.find("input")[0].selectionStart,f=b.content.length;e+1>f&&(a.preventDefault(),b.checkAddRemove(function(){d.goRight()}),d.selected.elem&&"lyricLine"===d.selected.elem.type&&d.selected.cleanUp())},b.moveSpace=function(a){var e=c.find("input")[0].selectionStart;a.shiftKey||e!==b.content.length||(b.checkAddRemove(function(){d.goRight()}),a.preventDefault())},b.moveHyphen=function(a){var e=c.find("input")[0].selectionStart;e===b.content.length&&(b.checkAddRemove(function(){d.goRight()},!0),a.preventDefault())},b.checkAddRemove=function(a,c){0===b.content.trim().length?b.checkRemove(a):b.checkAdd(a,c)},b.checkAdd=function(a,c){return c=c||!1,b.getText()!==b.content&&b.content.length>0||d.noteInfo.lyrics&&d.noteInfo.lyrics[b.lvl]&&c!==d.noteInfo.lyrics[b.lvl].hasRightConnection?void d.AddLyrics(b.content,b.lvl,c,a):a&&a()},b.checkRemove=function(a){var c=b.getText();return c&&c.length>0&&c!==b.content?void d.RemoveLyrics(b.lvl,a):a&&a()},b.moveBackspace=function(){var a=c.find("input")[0].selectionStart;0===a&&0===b.content.length&&(b.checkRemove(function(){d.goLeft()}),d.selected.elem&&"lyricLine"===d.selected.elem.type&&d.selected.cleanUp())},b.getText=function(){if(d.noteInfo.lyrics)for(var a=0;a<d.noteInfo.lyrics.length;a++)if(d.noteInfo.lyrics[a].level===b.lvl)return d.noteInfo.lyrics[a].text},b.checkup=function(c){switch(c.keyCode){case 38:b.lvl>0&&b.checkAddRemove(function(){b.lvl--,b.positionListener()});break;case 40:b.lvl<5&&b.checkAddRemove(function(){b.lvl++,b.positionListener()});break;case 39:b.moveRight(c);break;case 37:b.moveLeft(c);break;case 27:a.$broadcast("Toolbar.mode","select");break;case 8:b.moveBackspace();break;case 32:b.moveSpace(c);break;case 173:case 189:case 54:b.moveHyphen(c);break;case 13:b.checkAddRemove(function(){d.goRight()})}c.stopPropagation()},b.$on("input.saveLyrics",function(a,c){b.checkAddRemove(c)})}],link:function(c,d){function e(b){var d=g.getCoord(b.note),e=g.getCoord(b.mea),h=f.mouse.drawer.getStaffLyricsUpY(b.pos.staffIdx,b.pos.partIdx,b.pos.measureIdx,c.lvl)*g.scaling,i=g.findGoodPage(b.pos.partIdx,b.pos.measureIdx),j=$("#svg-content")[0].getBoundingClientRect(),k=g.svg[i.pageIdx].elem.getBoundingClientRect(),l=0;"page"===a.scoreLayout&&(l=k.left-j.left);var m=k.top-j.top;c.moveTo(l+d.abs.x,e.abs.y+h+m)}var f=c.interaction,g=f.svgTools;c.textWidth=function(a){return $.fn.textWidth(a,d.find("input").css("font"))+20},c.moveTo=function(a,e){c.baseX=a,c.baseY=e,c.content=c.getText()||"",c.inputMinWidth=c.textWidth(c.content),c.moveToProcess(),b(function(){d.find("input").focus().select()})},c.moveToProcess=function(){d.css({left:c.baseX-($("#custominput").width()-10)/2,top:c.baseY-$("#custominput").height()/4,"font-size":g.fontSize,height:g.fontSize+g.fontSize/4})},c.positionListener=function(){e(f.cursor.getNote()),c.updateInputWidth()},c.updateInputWidth=function(){d.css("width",Math.max(c.inputMinWidth,c.textWidth(c.content))),c.moveToProcess()},c.deselect=function(){d.find("input")[0].setSelectionRange(c.content.length,c.content.length)};var h=c.$watch(function(){return JSON.stringify(f.cursor.pos[a.account.id])},c.positionListener,!0),i=c.$watch("content",function(){c.updateInputWidth()}),j=c.$on("ScoreScaling.Updated",c.positionListener);d.on("$destroy",function(){h&&h(),i&&i(),j&&j(),f.focusKeyboard()})}}}]),angular.module("flat.editor.directives").directive("midiconfig",["$rootScope","$timeout","flat.editor.services.SVGTools","FrontendEvent",function(a,b,c,d){"use strict";return{restrict:"A",replace:!0,scope:{audio:"="},templateUrl:"/views/editor/_midi_config.html",controller:["$scope",function(c){c.cancelConfig=function(){c.stopCalibration(),c.hideConfig(),a.$broadcast("MIDI.Config.cancel")},c.finishConfig=function(){c.hideConfig(),a.$broadcast("MIDI.Config.finish",c.humanDelay)},c.loadModal=a.loadModal,c.account=a.account,b(function(){c.init(),c.audio.tempoMIDIConfig&&c.setTempo(c.audio.tempoMIDIConfig),c.displayConfig(c.audio.tempoMIDIConfig)}),c.$on("MIDI.Config.skip",function(){c.stopCalibration(),c.hideConfig()})}],link:function(e,f){var g,h=[1,1,.5,.5,.25,.25,.25,.25],i=[],j={"score-partwise":{$version:"3.0","part-list":{"score-part":[{"part-name":"Piano",voiceMapping:{0:[0]},staffMapping:[{mainVoiceIdx:0,voices:[0]}],"part-abbreviation":"Pno.","score-instrument":{"instrument-name":"Piano",$id:"P1-I1"},"midi-instrument":{"midi-program":1,$id:"P1-I1","midi-channel":"1"},$id:"P1"}]},part:[{measure:[{note:[{staff:"1",voice:"1",duration:"4",pitch:{octave:"4",step:"F"}},{staff:"1",voice:"1",duration:"4",pitch:{octave:"4",step:"F"}},{staff:"1",voice:"1",duration:"2",pitch:{octave:"4",step:"F"},beam:{$number:"1",content:"begin"}},{staff:"1",voice:"1",duration:"2",pitch:{octave:"4",step:"F"},beam:{$number:"1",content:"end"}},{staff:"1",voice:"1",duration:"1",pitch:{octave:"4",step:"F"},beam:[{$number:"1",content:"begin"},{$number:"2",content:"begin"}]},{staff:"1",voice:"1",duration:"1",pitch:{octave:"4",step:"F"},beam:[{$number:"1",content:"continue"},{$number:"2",content:"continue"}]},{staff:"1",voice:"1",duration:"1",pitch:{octave:"4",step:"F"},beam:[{$number:"1",content:"continue"},{$number:"2",content:"continue"}]},{staff:"1",voice:"1",duration:"1",pitch:{octave:"4",step:"F"},beam:[{$number:"1",content:"end"},{$number:"2",content:"end"}]}],$number:"1",harmony:[],barline:{$location:"right","bar-style":"light-heavy"},attributes:[{staves:"1",divisions:"4",time:{beats:"4","beat-type":"4"},clef:[{sign:"G",line:"2",$number:"1"}],key:{fifths:"0"},"staff-details":{"staff-lines":"5"},noteBefore:"-1"}],sound:{$tempo:"80"}}],$id:"P1"}]}},k=new Adagio.Brush.Elem("svg"),l=k.node(),m=new Adagio.Drawer.CachedTextMetric(l),n=100,o=new Adagio.Data(j);angular.element(document.getElementById("midi-config-score")).append(l),o.setScaling(6.35,24),o["action.ChangePartName"]({partIdx:0,partName:"",partAbbreviation:""}),e.cancelStack=new Adagio.edit.common.CancelStack,e.pageLayout=new Adagio.track.TrackLayout(o,n,m,Adagio.assets.smufl.bravura,{}),e.pageLayout.fillNextPage(k),e.displayUpdater=new Adagio.updater.track.TrackDisplayUpdater(o,e.pageLayout),e.init=function(){e.noteIdx=0,e.humanDelay=.2,e.active=!1,e.step=0,e.beats=4},e.displayConfig=function(){f.addClass("active")},e.hideConfig=function(){f.removeClass("active")},e.setTempo=function(a){for(e.tempo=a,e.unitDuration=60/e.tempo,e.barDuration=e.unitDuration*e.beats,g=0;g<h.length;g++)i[g]=h[g]*e.unitDuration;o["action.SetTempo"]({tempo:a,startMeasureIdx:0,stopMeasureIdx:0},e.cancelStack),e.updateDisplay()},e.validateNote=function(){e.noteIdx<e.notes.length&&(e.notes[e.noteIdx].style.fill="#268FF4",e.notes[e.noteIdx].style.stroke="#268FF4",e.noteIdx++),e.noteIdx===e.notes.length&&e.stopCalibration()},e.startCalibration=function(){e.startTime=Dacapo.context.currentTime,e.step=1,e.noteIdx=0,e.audio.startMIDICalibration(e.unitDuration,e.validateNote.bind(this))},e.stopCalibration=function(){1===e.step&&e.audio.stopMIDICalibration(i,e.endCalibration.bind(this))},e.endCalibration=function(c,f,g){c||!f?(c||f?e.error=c.message:"undefined"!=typeof f&&(e.error="Delay is "+f.toString()),e.initHeadColor(),e.step=3):(e.step=2,e.humanDelay=f),b(angular.noop),g&&(g.sid=a.score.id,g.userId=a.account.id,g.calibration=!0,g.delay=f,d.pushMidi(g))},e.initHeadColor=function(){var a;for(a=0;a<e.notes.length;a++)e.notes[a].style.fill="#000",e.notes[a].style.stroke="#000"},e.updateDisplay=function(){e.displayUpdater.update(e.cancelStack),e.fetchNoteHeads()},e.fetchNoteHeads=function(){e.voice=c.getElementsByClassName(l,"voice")[0],e.notes=c.getElementsByClassName(e.voice,"note")},e.init(),e.setTempo(80),e.fetchNoteHeads(),f.on("$destroy",function(){})}}}]),angular.module("flat.editor.directives").directive("playnav",[function(){"use strict";return{restrict:"A",replace:!0,templateUrl:"/views/editor/_playnav.html",scope:{audio:"=",dataReader:"="},controller:["$scope","$timeout",function(a,b){a.reachBar=function(b){a.audio.changeMeasure(b-1)},a.lastActiveMeasure=0,a.$on("sliderPos",function(c,d){d.currentMeasure!==a.lastActiveMeasure&&a.active&&(a.lastActiveMeasure=d.currentMeasure,a.activateSticks(),b(angular.noop))})}],link:function(a,b){function c(a,b){var c,d=[];for(b=b||1,d.push({index:1,active:!0,level:!0}),c=1===b?2:b;c<=a;c+=b)d.push({index:c,active:!1,level:c%10===0});return d}function d(){var d,e;a.lastActiveIdx=0,a.lastActiveMeasure=0,a.measureCount=a.dataReader.data.getNbMeasures(),a.measureCount>=10&&(a.measureCount>a.max?(a.step=Math.ceil(a.measureCount/a.max),a.step%2!==0&&a.step++):a.step=1,e=b.width()-24,a.marks=c(a.measureCount,a.step),d=(e-2*a.marks.length)/(2*a.marks.length)>>0,a.paddingValue={"padding-left":d,"padding-right":d},a.active=!0,b.addClass("active"))}a.markingsDiv=b.children(),a.active=!1,a.measureCount=1,a.paddingValue={},a.marks=[1],a.step=1,a.max=120,a.lastActiveIdx=0,a.activateSticks=function(){var b,c,d=a.lastActiveMeasure;if(d>0&&a.step>1&&d++,c=d/a.step>>0,c>a.lastActiveIdx)for(b=a.lastActiveIdx;b<=c&&b<a.marks.length;b++)a.marks[b]&&(a.marks[b].active=!0);else if(c<a.lastActiveIdx)for(c>=a.marks.length&&(c=a.marks.length-1),b=a.lastActiveIdx;b>c&&b>=0;b--)a.marks[b]&&(a.marks[b].active=!1);a.lastActiveIdx=c},d()}}}]),angular.module("flat.editor.directives").directive("swFocus",[function(){"use strict";return{restrict:"AE",scope:{rt:"="},link:function(a,b){b.on("$destroy",function(){$(window).unbind("focus",e),"serviceWorker"in navigator&&"function"==typeof navigator.serviceWorker.removeEventListener&&navigator.serviceWorker.removeEventListener("message",d)});var c=!1,d=function(b){"focus-changed"===b.data&&(c||a.rt&&a.rt.focusLost&&a.rt.focusLost(),c=!1)},e=function(){a.rt&&a.rt.focusGained&&a.rt.focusGained(),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&(c=!0,navigator.serviceWorker.controller.postMessage("focus-changed"))};$(window).bind("focus",e),"serviceWorker"in navigator&&"function"==typeof navigator.serviceWorker.addEventListener&&navigator.serviceWorker.addEventListener("message",d),e()}}}]),angular.module("flat.editor.directives").directive("tuningHead",TuningHead),TuningHeadCtrl.$inject=["$scope"],angular.module("flat.editor.services",["ngResource"]).factory("ScoreComment",["$resource",function(a){return a(apiv2baseurl+"/scores/:score/comments/:id/:action_path",{score:"@score",id:"@id"},{add:{method:"POST"},update:{method:"PUT"},resolve:{method:"PUT",params:{action_path:"resolved"}},unresolve:{method:"DELETE",params:{action_path:"resolved"}}})}]).factory("ScoreRevisionV2",["$resource",function(a){return a(apiv2baseurl+"/scores/:score/revisions/:revision/:action",{score:"@score",revision:"@revision"},{create:{method:"POST"},get:{method:"GET",cache:!0},getData:{method:"GET",cache:!0,params:{action:"json"}},getHistory:{method:"GET",cache:!0,isArray:!0,params:{action:"history"}},export:{method:"GET"}})}]),angular.module("flat.editor.services").factory("flat.editor.services.Audio",["$rootScope","$location","$timeout","$injector","$log","flat.editor.services.Slider","flat.editor.services.CancelStack","MessageService","Experience","UxStore","FrontendEvent",function(a,b,c,d,e,f,g,h,i,j,k){function l(b,c){try{Dacapo.init()}catch(a){return this.displayDacapoError(a),!1}/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream||Dacapo.throwIfWebAudioStucked(!0).catch(function(a){e.error(a),this.displayDacapoError(a)}.bind(this)),this.debug=debug("flat:audio"),this.bufferList={},this.loaderInstru={},this.percentCompletion=0,this.completion=0,this.totalSize=0,this.loading=!1,this.pendingPlay=!1,this.preloadSamples=!0,this.playbackTitle="flat:play.localPlay",this.commonContent=null,this.MIDI=null,this.midiTab=0,this.midiNotationEnabled=!0,this.inMIDIConfig=!1,this.inputMIDI=null,this.outputMIDI=null,this.devices={input:[],output:[]},this.measureStartRecord=0,this.counting=!1,a.account&&a.account.plan&&a.account.plan.features&&(a.account.plan.features.midiOutput||j.remove("midi.default-output"),a.account.plan.features.midiInput||j.remove("midi.default-device")),this.humanDelay=.2,this.selectedInputDevice={id:0,name:j.get("midi.default-device")||""},this.selectedOutputDevice={id:-1,name:j.get("midi.default-output")||""},this.interaction=c,this.cursor=c.cursor,this.slider=new f(c),this.playing=!1,this.pausing=!1,b?this.setData(b):(this.instrumentList=[],this.reader=null,this.transport=null,this.manager=null)}return l.prototype.displayDacapoError=function(b,c){this.err=b=b||this.err,b instanceof Dacapo.Error.ConnectionOverflowError?a.addErrors(this.playbackTitle=i18n.t("flat:dacapo.errors.connection-overflow",{bound:b.maxConnections})):b instanceof Dacapo.Error.BlockedWAAPIError?(h.broadcast(this.playbackTitle=i18n.t("flat:dacapo.errors.stucked-waapi"),{color:"danger",important:!0,timeout:3e4}),i.add("editor.stuck-waapi")):(c?window.open("/browser-upgrade"):h.broadcast(this.playbackTitle=i18n.t("flat:dacapo.errors.compat"),{color:"danger",important:!0,timeout:3e4}),b instanceof Dacapo.Error.CompatibilityError||e.error(b))},l.prototype.midiIconAction=function(){this.devices&&(0!==this.devices.input.length||0!==this.devices.output.length)&&a.account.plan.features.midiInput||b.path("/midi-devices/setup").search("ref","editor-header")},l.prototype.setPartVolume=function(a,b){if(!Dacapo.context||!this.manager)return 0;this.debug("set part %s (%s) volume to %s",a,typeof a,b);try{this.manager.setInstrumentVolume(a,b)}catch(c){throw new Error(c.message+' Volume value was "'+b.toString()+'". index was "'+a.toString()+'"')}},l.prototype.getPartVolume=function(a){return Dacapo.context&&this.manager?this.manager.getInstrumentVolume(a):0},l.prototype.setPartReverb=function(a,b){if(this.debug("set part %s reverb to %s",a,b),
!Dacapo.context||!this.manager)return 0;try{this.manager.setInstrumentReverb(a,100*b)}catch(c){throw new Error(c.message+' Reverb value was "'+b.toString()+'". index was "'+a.toString()+'"')}},l.prototype.getPartReverb=function(a){return Dacapo.context&&this.manager?this.manager.getInstrumentReverb(a)/100:0},l.prototype.setPartSoloMode=function(a){if(Dacapo.context&&this.manager)return this.manager.setInstrumentSolo(a)},l.prototype.unsetPartSoloMode=function(a){if(Dacapo.context&&this.manager)return this.manager.unsetInstrumentSolo(a)},l.prototype.getPartSoloMode=function(a){return Dacapo.context&&this.manager?this.manager.isInstrumentSolo(a):0},l.prototype.setMasterVolume=function(a){if(!Dacapo.context)return 0;this.debug("set master volume to %s",a);try{Dacapo.mainOutput.setGain(a)}catch(b){throw new Error(b.message+'volume value was "'+a.toString()+'"')}},l.prototype.getMasterVolume=function(){return this.manager?this.manager.getMasterVolume():1},l.prototype.restart=function(){this.transport.restart().catch(function(a){e.error(a),this.displayDacapoError(a)}.bind(this))},l.prototype.toggleMetronome=function(){return this.transport&&(this.metronomeMode=this.transport.toggleMetronome(),j.set("score-audio.metronomeDisabled",2===this.metronomeMode)),this.metronomeMode},l.prototype.toggleMetronomeRecord=function(){this.transport&&(this.isMetronomeOn()?(this.counting?(this.transport.cleanWorker(),this.transport.stop(),this.metronome.setMode(this.metronomeMode=2),this.metronome.switchOff()):this.transport.setMetronomeMode(this.metronomeMode=2),j.set("score-record.metronomeEnabled",!1)):(this.transport.setMetronomeMode(this.metronomeMode=1),j.set("score-record.metronomeEnabled",!0)))},l.prototype.setMetronomeMode=function(a){this.transport&&(this.transport.setMetronomeMode(a),this.metronomeMode=a)},l.prototype.isMetronomeOn=function(){return 1===this.metronomeMode||1===this.getMetronomeMode()},l.prototype.switchMetronomeOn=function(){this.metronome&&(this.metronome.switchOn(),this.metronome.unmute())},l.prototype.getMetronomeMode=function(){return this.metronomeMode=0,this.metronome&&(this.metronomeMode=this.metronome.getMode()),this.metronomeMode},l.prototype.playNote=function(a){this.err||(a.line=void 0,this.manager&&this.manager.playNoteAtPosition(a))},l.prototype.errorCallback=function(a){this.loaderInstru[a]=0,this.bufferList[a]&&this.bufferList[a]instanceof Dacapo.Sampler&&this.bufferList[a].downloadSoundfont(a,this.loadedCallback.bind(this),function(){})},l.prototype.loadedCallback=function(a,b){this.loaderInstru[b]=1;for(var c in this.loaderInstru)if(0===this.loaderInstru[c])return;this.manager&&this.reader&&this.preloadSamples?this.manager.preloadSamples(this.reader.getPlayedNotesInParts(),this.endCallback.bind(this)):this.endCallback()},l.prototype.endCallback=function(){this.loading=!1,this.preloadSamples=!1,this.playbackTitle="flat:play.localPlay",this.pendingPlay&&(this.play(),this.pendingPlay=!1),c(angular.noop)},l.prototype.getInstrumentInfo=function(a){var b,c,d,e,f;if(this.data.isPartUnpitched(a))b=this.data.getPartHeader(a),d=Adagio.Utils.partHeaderUtils.getMIDIInstruments(b),e=this.fetchMatchingDrumset(d),c=.8;else{var g=Adagio.Utils.partHeaderUtils.getMIDIInstruments(this.instrumentList[a]);f=Adagio.Utils.MIDIInstrumentUtils.getMIDIProgram(g[0]),"undefined"!=typeof g[0]&&(c=Number(g[0].volume||100)/100),e=f in Dacapo.Utils.InstrumentConf?Dacapo.Utils.InstrumentConf[f]:Dacapo.Utils.InstrumentConf[1]}return{instrumentInfo:e,volume:c,instruId:f}},l.prototype.loadInstrument=function(a,b){var c;"undefined"==typeof this.bufferList[a.instrumentInfo.id]?(this.loading=!0,c=a.instrumentInfo.samplerv2?new Dacapo.SFBuffer2:new Dacapo.SFBuffer,this.loaderInstru[a.instrumentInfo.id]=0,c.init(a.instrumentInfo,this.loadedCallback.bind(this),this.errorCallback.bind(this)),this.bufferList[a.instrumentInfo.id]=c):c=this.bufferList[a.instrumentInfo.id],b.setSFBuffer(c),b.setInstrumentInfo(a.instrumentInfo),b.connectTo(Dacapo.mainOutput),b.setVolume(a.volume)},l.prototype.initInstruments=function(){var a,b;if(Dacapo.context){if(this.playbackTitle="flat:play.loadPlayback",this.instrumentList&&this.instrumentList.length>0){for(var c=0;c<this.instrumentList.length;c++)b=this.getInstrumentInfo(c),a=this.createSampler(b),this.configureSampler(a,c),this.loadInstrument(b,a),this.manager.addInstrument(a);return this.loadVolumePreferences(),!0}return!1}},l.prototype.createSampler=function(a){var b;return b=a.instrumentInfo.samplerv2?new Dacapo.SamplerV2:new Dacapo.Sampler},l.prototype.configureSampler=function(a,b){this.data.isPartUnpitched(b)&&(a.setDrumSet(!0),a.setHeader(this.instrumentList[b]))},l.prototype.fetchMatchingDrumset=function(a){var b,c,d={},e={id:1,occur:0};for(c=0;c<a.length;c++)b=a[c]["midi-program"],"undefined"!=typeof b&&("undefined"==typeof d[b]&&(d[b]=0),++d[b]>e.occur&&(e.id=b,e.occur=d[b]));return Dacapo.Utils.DrumsetConf.hasOwnProperty(e.id)?Dacapo.Utils.DrumsetConf[e.id]:Dacapo.Utils.DrumsetConf[1]},l.prototype.loadVolumePreferences=function(){var a,b=j.get("score-audio.volume:"+this.interaction.score.id)||{};b.parts=b.parts||[],b.reverbs=b.reverbs||[],b.soloMode=b.soloMode||[],"number"==typeof b.master&&b.master>=0&&b.master<=1&&this.setMasterVolume(b.master);for(var c=0;c<this.instrumentList.length;c++){var d=this.data.getPartHeader(c);"number"==typeof b.parts[c]&&b.parts[c]>=0&&b.parts[c]<=1?this.setPartVolume(c,b.parts[c]):(a=Adagio.Utils.partHeaderUtils.getGlobalVolume(d)/100,this.setPartVolume(c,a),b.parts[c]=a),"number"==typeof b.reverbs[c]&&b.reverbs[c]>=0&&b.reverbs[c]<=1?this.setPartReverb(c,b.reverbs[c]):(a=Adagio.Utils.partHeaderUtils.getGlobalReverberation(d)/100,this.setPartReverb(c,a),b.reverbs[c]=a),"boolean"==typeof b.soloMode[c]&&b.soloMode[c]?this.setPartSoloMode(c):this.unsetPartSoloMode(c)}j.set("score-audio.volume:"+this.interaction.score.id,b)},l.prototype.play=function(){if(this.currentMeasure=0,this.err)return this.displayDacapoError(this.err,!0);if(!(!this.transport||this.inputMIDI&&this.inputMIDI.recording)){if(this.loading)return void(this.pendingPlay=!0);if(!this.pausing&&this.slider.loadSlider(this.drawer)===-1)return h.broadcast("Setting up scores...,",{color:"error",important:!0});var b;b=this.playing||!this.cursor.isInit()?void 0:this.cursor.getPosition().measureIdx;var d=function(){var b;return this.transport?(b=this.transport.getPlayingHeadPosition(),this.slider.updateLine(b)?(this.currentMeasure!==b.currentMeasure&&(a.$broadcast("sliderPos",b),this.currentMeasure=b.currentMeasure),void(this.idAnim=window.requestAnimationFrame(d))):this.stop()):this.stop()}.bind(this);this.transport&&this.data&&(this.transport.start(b,function(){this.playing=!0,this.pausing=!1}.bind(this),function(){this.cleanUp(!0),this.playing=!1,c(angular.noop),a.$broadcast("Audio.End")}.bind(this)).catch(function(a){e.error(a),this.displayDacapoError(a)}.bind(this)),a.$broadcast("Audio.play"),i.add("editor.player"),window.requestAnimationFrame(d))}},l.prototype.stop=function(){this.transport&&(this.cleanUp(!0),this.transport.stop(function(){this.manager.stopAll(),this.playing=!1,this.pausing=!1,a.$broadcast("Audio.stop")}.bind(this)),this.inputMIDI&&this.stopRecord())},l.prototype.cleanUp=function(a,b){this.idAnim&&window.cancelAnimationFrame(this.idAnim),a&&this.slider.clear(),b&&this.MIDI&&(this.MIDI.destroy(),this.MIDI=null,this.inputMIDI=null,this.outputMIDI=null)},l.prototype.pause=function(){if(null!==this.transport){if(this.inputMIDI&&this.inputMIDI.recording)return;this.cleanUp(!1),this.pausing=!0,this.transport.pause(),a.$broadcast("Audio.pause")}},l.prototype.setPages=function(a){this.pages=a},l.prototype.reloadInstruments=function(){var a,b,c,d;if(this.data){for(this.instrumentList=this.data.score["score-partwise"]["part-list"]["score-part"],a=0;a<this.instrumentList.length;a++)c=this.manager.instrumentStack[a],b=this.getInstrumentInfo(a),d=this.createSampler(b),this.configureSampler(d,a),c?b.instrumentInfo.id!==c.instInfo.id&&(this.loadInstrument(b,d),this.manager.instrumentStack[a]=d):(this.loadInstrument(b,d),this.manager.addInstrument(d));this.loadVolumePreferences(),this.reader=new Dacapo.Reader(this.manager,this.data,this.commonContent),this.transport.reader=this.reader,this.transport.setMetronome(this.metronome)}},l.prototype.setData=function(a){a&&(this.data=a,this.commonContent=a.getCommonContent(),this.instrumentList=a.score["score-partwise"]["part-list"]["score-part"],this.slider.init(),this.manager?(this.manager.setData(this.data),this.reader.setData(this.data,this.commonContent)):(this.metronome=new Dacapo.Metronome,this.metronomeMode=0,this.manager=new Dacapo.InstrumentManager(null,this.data),this.reader=new Dacapo.Reader(this.manager,this.data,this.commonContent),this.transport=new Dacapo.Clock(this.reader),this.metronome.connectTo(Dacapo.mainOutput),this.manager.setTransport(this.transport),this.transport.setMetronome(this.metronome),this.transport.loopOff()),this.editorInputMidi&&this.editorInputMidi.setData(this.data),j.get("score-audio.metronomeDisabled")&&this.transport.setMetronomeMode(this.metronomeMode=2),this.initInstruments()&&(this.initSwing(),this.manager.selectInstrument(0),this.reader.init(0)))},l.prototype.changeMeasure=function(a){this.transport.jumpToMeasure(a).catch(function(a){e.error(a),this.displayDacapoError(a)})},l.prototype.initMIDI=function(){if(!this.MIDI){this.MIDI=new Dacapo.MIDI(this.updateMIDIDevices.bind(this));try{this.MIDI.init(function(){this.updateMIDIDevices()}.bind(this)),this.inputMIDI=this.MIDI.getMidiInput(),this.outputMIDI=this.MIDI.getMidiOutput(),this.editorInputMidi=new(d.get("flat.editor.services.InputMidi"))(this.data,this.interaction),this.inputMIDI.init(this.manager,this.editorInputMidi.AddNoteMidi.bind(this.editorInputMidi),this.editorInputMidi.AddNoteLiveMidi.bind(this.editorInputMidi),this.getCurrentNoteDuration.bind(this),this.getCurrentTempo.bind(this)),this.manager.setMidiOutput(this.outputMIDI)}catch(a){if(a instanceof Dacapo.Error.CompatibilityError||a.message.indexOf("$injector:unpr")>0)return this.inputMIDI=null,void(this.outputMIDI=null);throw a}}},l.prototype.updateMIDIDevices=function(){this.MIDI&&(this.fetchDevices("Input"),this.fetchDevices("Output"),c(angular.noop))},l.prototype.fetchDevices=function(b){var c,d,e,f;if(e=b.toLowerCase(),f=this["selected"+b+"Device"],d=this.MIDI["get"+b+"s"](),d.length>0){for(this.devices[e]=[{id:-1,name:i18n.t("flat:midi.none")}],c=0;c<d.length;c++)this.devices[e].push({id:c,name:d[c].name});a.account&&a.account.plan&&a.account.plan.features&&(a.account.plan.features.midiInput&&"Input"===b||a.account.plan.features.midiOutput&&"Output"===b)&&((f.id+1>=this.devices[e].length||this.devices[e][f.id+1].name!==f.name)&&(f.id=this.retrieveDeviceId(b)),this["select"+b+"Device"](f.id)),i.add("editor.device-midi")}else this.devices[e]=[],f.id=0,f.name=""},l.prototype.retrieveDeviceId=function(a){for(var b=this.devices[a.toLowerCase()],c=this["selected"+a+"Device"],d=0;d<b.length;d++)if(c.name===b[d].name)return d-1;return"Input"===a?0:-1},l.prototype.lockDevice=function(a,b){var c;for(c=0;c<this.devices[a].length;c++)this.devices[a][c].name===b&&(this.devices[a][c].lock=!0)},l.prototype.unlockDevice=function(a,b){var c;for(c=0;c<this.devices[a].length;c++)this.devices[a][c].name===b&&(this.devices[a][c].lock=!1)},l.prototype.fetchRemainingTimeInBar=function(){var a,b=0,c=this.cursor.getPosition(),d=this.data.getMeasure(c.partIdx,c.measureIdx),e=Number(d.$adagio.attributes.divisions);for(a=c.noteIdx;a<d.note.length;a++)Number(d.note[a].voice||1)===c.voiceIdx+1&&(b+=Number(d.note[a].duration)/e);return b},l.prototype.switchMidiTab=function(a,b){a.stopPropagation(),this.midiTab=b},l.prototype.getCurrentNoteDuration=function(){var a=this.cursor.getPosition(),b=this.data.getMeasure(a.partIdx,a.measureIdx),c=Number(b.$adagio.attributes.divisions);return Number(b.note[a.noteIdx].duration)/c},l.prototype.getCurrentTempo=function(){var a=this.cursor.getPosition();return this.commonContent.getTempo(a.measureIdx)>>0},l.prototype.selectInputDevice=function(a){var b;if(this.MIDI){if(this.devices.input[a+1].name===this.selectedOutputDevice.name&&a!==-1||this.devices.input[a+1].lock)return void(this.devices.input[a+1].lock=!0);b=this.selectedInputDevice.name,this.devices.input[this.selectedInputDevice.id+1]||(this.selectedInputDevice.id=this.retrieveDeviceId("Input")),this.devices.input[this.selectedInputDevice.id+1].active=!1,this.devices.input[a+1].active=!0,this.selectedInputDevice.id=a,this.devices.input[a+1].name!==this.selectedInputDevice.name&&(a===-1?h.broadcast(i18n.t("flat:midi.inputs.notification.disable",{device:this.devices.input[a+1].name}),{color:"default"}):h.broadcast(i18n.t("flat:midi.inputs.notification.selected",{device:this.devices.input[a+1].name}),{color:"success"}),j.set("midi.default-device",this.devices.input[a+1].name)),this.selectedInputDevice.name=this.devices.input[a+1].name,a===-1?this.MIDI.unselectInputDevice():this.MIDI.selectInputDevice(a),this.unlockDevice("output",b),this.selectedInputDevice.id!==-1&&this.lockDevice("output",this.selectedInputDevice.name)}},l.prototype.selectFreeInputDevice=function(){var b;if(this.MIDI&&a.account&&a.account.plan&&a.account.plan.features&&a.account.plan.features.midiInput)for(b=1;b<this.devices.input.length;b++)this.devices.input[b].name===this.selectedOutputDevice.name||this.devices.input[b].lock?this.devices.input[b].lock=!0:this.selectInputDevice(b-1)},l.prototype.selectOutputDevice=function(a){var b;if(this.MIDI){if(this.devices.output[a+1].name===this.selectedInputDevice.name&&a!==-1||this.devices.output[a+1].lock)return void(this.devices.output[a+1].lock=!0);b=this.selectedOutputDevice.name,this.devices.output[this.selectedOutputDevice.id+1]||(this.selectedOutputDevice.id=this.retrieveDeviceId("Output")),this.devices.output[this.selectedOutputDevice.id+1].active=!1,this.devices.output[a+1].active=!0,this.selectedOutputDevice.id=a,this.devices.output[a+1].name!==this.selectedOutputDevice.name&&(a===-1?h.broadcast(i18n.t("flat:midi.outputs.notification.disable",{device:this.devices.output[a+1].name}),{color:"default"}):h.broadcast(i18n.t("flat:midi.outputs.notification.selected",{device:this.devices.output[a+1].name}),{color:"success"}),j.set("midi.default-output",this.devices.output[a+1].name)),this.selectedOutputDevice.name=this.devices.output[a+1].name,a===-1?(this.manager.disableMidiOutput(),this.MIDI.unselectOutputDevice()):(this.manager.enableMidiOutput(),this.MIDI.selectOutputDevice(a),i.add("editor.output-midi")),this.unlockDevice("input",b),this.selectedOutputDevice.id!==-1&&this.lockDevice("input",this.selectedOutputDevice.name)}},l.prototype.getDeviceName=function(){return this.MIDI?0===this.devices.length?i18n.t("flat:midi.no-devices"):this.selectedDevice.name:i18n.t("flat:midi.incompatible")},l.prototype.toggleInputNotation=function(){this.midiNotationEnabled?this.inputMIDI.enableNotation():this.inputMIDI.disableNotation()},l.prototype.getClickCount=function(){return{sequences:2,clicks:4}},l.prototype.startMIDIConfig=function(b,c){var d="midi.config."+this.selectedInputDevice.name,e=j.get(d);this.tempoMIDIConfig=this.getCurrentTempo(),e?this.startRecord(b,c,e):(this.inMIDIConfig=!0,a.$on("MIDI.Config.finish",function(a,e){j.set(d,e),this.inMIDIConfig=!1,this.startRecord(b,c,e)}.bind(this)),a.$on("MIDI.Config.cancel",function(){this.inMIDIConfig=!1}.bind(this)))},l.prototype.startMIDICalibration=function(a,b){this.inputMIDI.startCalibration(a,b)},l.prototype.stopMIDICalibration=function(a,b){this.inputMIDI.stopCalibration(a,b)},l.prototype.record=function(b,c){this.measureStartRecord=this.cursor.getPosition().measureIdx,this.isMetronomeOn()&&this.metronome.isSolo()&&this.transport.setMetronomeMode(0),this.selectedInputDevice&&this.selectedInputDevice.id===-1&&this.selectFreeInputDevice(),this.switchMetronomeOn(),this.inMIDIConfig?(a.$broadcast("MIDI.Config.skip"),this.inMIDIConfig=!1,this.startRecord(b,c,this.humanDelay)):this.startMIDIConfig(b,c),i.add("editor.live-midi")},l.prototype.startRecord=function(b,d,e){var f,g=0,h=0;a.account&&a.account.plan&&a.account.plan.features&&!a.account.plan.features.midiInput||(this.counting=!0,g=Dacapo.context.currentTime+.1,this.inMIDIConfig=!1,f=this.getClickCount(),f.quarterDuration=Dacapo.unitDuration,h=f.clicks*f.sequences*Dacapo.unitDuration,this.inputMIDI.setHumanDelay(e),this.inputMIDI.setMetaMap(this.reader.getMetaMap()),this.inputMIDI.startRecording(g+h),this.transport.scheduleMetronomeSequence(f,g,function(){b(),c(angular.noop)},function(){this.counting=!1,d(),c(angular.noop)}.bind(this)),j.get("score-record.metronomeEnabled")&&this.transport.setMetronomeMode(1,g+h))},l.prototype.stopRecord=function(){var b;this.counting&&(this.metronome.cancelSequence(),this.transport.cleanWorker()),b=this.inputMIDI.getStartRecordTime(),this.isMetronomeOn()&&(b=this.metronome.getStartMeasureTimeFrom(b)),j.get("score-audio.metronomeDisabled")?this.transport.setMetronomeMode(2):this.transport.setMetronomeMode(0),this.inputMIDI.stopRecording(b,function(b,d){var e=this.cursor.getPosition();d.sid=this.interaction.score.id,d.userId=a.account.id,k.pushMidi(d),e=this.interaction.dataReader.convertVoiceIdx(e),this.data["action.InsertVoiceContentCrossMeasure"]({partIdx:e.partIdx,measureIdx:this.measureStartRecord,staffIdx:e.staffIdx,voiceIdx:e.voiceIdx,timePos:0,dpq:1,data:b},g.localStack),g.drawQueue.push(g.localStack.getLast()),a.$broadcast("Interaction.Updated",g.localStack),c(angular.noop)}.bind(this))},l.prototype.toggleRecord=function(){this.inputMIDI.recording?this.stopRecord():this.record()},l.prototype.initSwing=function(){var a=this.interaction.score.adagioData&&this.interaction.score.adagioData.getSwing(0)||j.get("score-audio.swing:"+this.interaction.score.id)||!1;"object"==typeof a&&(a=!!a.swing),"boolean"!=typeof a&&(a=!1),this.debug("[swing] state = %s",a),a&&this.transport.enableSwing()},l.prototype.toggleSwing=function(){this.transport.toggleSwing()},l}]),angular.module("flat.editor.services").factory("flat.editor.services.CancelStack",[function(){"use strict";var a={localStack:new Adagio.edit.common.CancelStack,onlineStack:new Adagio.edit.common.CancelStack,redoStack:new Adagio.edit.common.CancelStack,drawQueue:new Adagio.edit.common.CancelStack,init:function(){a.localStack=new Adagio.edit.common.CancelStack,a.onlineStack=new Adagio.edit.common.CancelStack,a.redoStack=new Adagio.edit.common.CancelStack,a.drawQueue=new Adagio.edit.common.CancelStack},resetOnline:function(){a.onlineStack=new Adagio.edit.common.CancelStack},resetRedo:function(){a.redoStack=new Adagio.edit.common.CancelStack},resetLocal:function(){a.localStack=new Adagio.edit.common.CancelStack},resetDrawQueue:function(){a.drawQueue=new Adagio.edit.common.CancelStack}};return a}]),angular.module("flat.editor.services").factory("CollaboratorService",CollaboratorsService),CollaboratorsService.$inject=["_","$q","$rootScope","$analytics","Experience","MessageService","CollaboratorV2"],angular.module("flat.editor.services").factory("flat.editor.services.Collaborators",["$rootScope","$log","Experience",function(a,b,c){"use strict";function d(b){this.ownColor=e,this.colors=angular.copy(f),this.colorsCodes=Object.keys(this.colors),this.debug=debug("flat:collaborators"),this.collaborators={},this.score=b;for(var c=b.collaborators,d=0;d<c.length;d++){var g=c[d].user&&c[d].user.id;g&&(this.collaborators[g]=c[d],g===a.account.id&&b&&(b.rights.userRights=c[d]))}a.account&&a.account.id&&this.setOnline(a.account.id),this.debug("loaded")}var e="#0B7BE8",f={"#F62459":0,"#1ABC9C":0,"#9B59B6":0,"#D35400":0,"#F1C40F":0,"#65E892":0,"#8E44AD":0,"#81CFE0":0,"#F46D6D":0,"#F2784B":0,"#BE90D4":0,"#FF94C7":0,"#ADEBBE":0,"#FDE3A7":0,"#3498DB":0,"#D789D7":0,"#F39C12":0,"#C0392B":0,"#E760BF":0,"#E74C3C":0,"#2980B9":0,"#E67E22":0,"#FFA87B":0,"#FDA4CF":0};return d.prototype.isCollaborator=function(){return this.collaborators[a.account.id]&&!this.collaborators[a.account.id]._frontendOnly},d.prototype.getNextColor=function(){var a,b=0;return this.colorsCodes.forEach(function(c){(!a||this.colors[c]<b)&&(b=this.colors[c],a=c)}.bind(this)),this.colors[a]++,a},d.prototype.setOnline=function(b){if(this.collaborators[b]&&this.collaborators[b].session)return this.collaborators[b];this.collaborators[b]||(this.collaborators[b]={aclWrite:!0,aclRead:!0,user:b,_frontendOnly:!0});var d=a.account&&a.account.id===b?this.ownColor:this.getNextColor();return this.collaborators[b].session={color:d,style:{"border-color":d}},Object.keys(this.getOnlineCollaborators()).length>1&&c.add("editor.collaboration.realtime"),this.collaborators[b]},d.prototype.setOffline=function(a){this.collaborators[a]&&this.collaborators[a].session&&(this.collaborators[a].session.color&&this.colors[this.collaborators[a].session.color]--,delete this.collaborators[a].session)},d.prototype.getOnlineCollaborators=function(){var a={};for(var b in this.collaborators)this.collaborators[b].session&&(a[b]=this.collaborators[b]);return a},d.prototype.getUserColor=function(a){return"undefined"!=typeof this.collaborators[a]&&"undefined"!=typeof this.collaborators[a].session?this.collaborators[a].session.color:this.ownColor},d}]),angular.module("flat.editor.services").factory("flat.editor.services.Config",[function(){"use strict";function a(){this.user={}}function b(a){if(1===a.getNbParts())return!0;if(2===a.getNbParts()){var b=a.getPartContent(0),c=a.getPartContent(1),d=Adagio.Utils.partContentUtils.getNbStaves(b),e=Adagio.Utils.partContentUtils.getNbStaves(c);return d!==e}return!1}return a.prototype.init=function(){this.config={noFooter:!1,noHeader:!1,displayFirstLinePartsNames:!0,displayOtherLinesPartsNames:!0,isConcertPitch:!1,composer:{"font-family":"Noto Serif"},copyrights:{"font-family":"Noto Serif"},harmonyText:{"font-family":"Noto Serif"},lyric:{"font-family":"Noto Serif"},lyricist:{"font-family":"Noto Serif"},measureNumber:{"font-family":"Noto Serif"},pageNumber:{"font-family":"Noto Serif"},partName:{"font-family":"Noto Serif"},pizzicato:{"font-family":"Noto Serif"},rehearsalText:{"font-family":"Noto Serif"},subtitle:{"font-family":"Noto Serif"},tempo:{"font-family":"Noto Serif"},title:{"font-family":"Noto Serif"},word:{"font-family":"Coming soon"},wordFontSizeRatio:1/1.7};for(var a in this.user)this.user.hasOwnProperty(a)&&(this.config[a]=this.user[a])},a.prototype.get=function(){return this.config||this.init(),this.config},a.prototype.set=function(a,b){this.user[a]=b,this.config||this.init(),this.config[a]=b},a.prototype.initFromScoreData=function(a){this.init(),b(a)&&(this.config.displayOtherLinesPartsNames=!1)},a}]),angular.module("flat.editor.services").factory("flat.editor.services.Cursor",["$rootScope","$log","$timeout",function(a,b,c){"use strict";function d(){this.init.apply(this,arguments),this.debug=debug("flat:cursor")}var e=angular.copy,f="M0 10c0 3.3 2.7 6 6 6s6-2.7 6-6S6 0,6 0S0 6.7 0 10z";return d.prototype.init=function(b,c,d){this.polygone=null,this.focus=!1,this.size=0,this.svg=b,this.interaction=c,this.svgTools=c.svgTools,this.dataReader=c.dataReader,this.collaborators=d,this.pos=[],this.note=[],this.dataReader&&this.resetPos(),this.id=a.account.id,this.colorVoice0=this.color=c.colorVoice0||"#5696fa",this.colorVoice1=c.colorVoice1||"#fa5696"},d.prototype.resetPos=function(){this.pos[this.id]={measureIdx:0,partIdx:0,staffIdx:0,voiceIdx:0,noteIdx:0},this.mapping=this.dataReader.data.getPartStaffMapping(this.pos[this.id].partIdx,this.pos[this.id].staffIdx)},d.prototype.samePos=function(a){var b=this.pos[this.id];return a.partIdx===b.partIdx&&a.noteIdx===b.noteIdx&&a.staffIdx===b.staffIdx&&a.measureIdx===b.measureIdx&&a.voiceIdx===b.voiceIdx},d.prototype.isInit=function(){return!!this.svg},d.prototype.setSize=function(){this.size=this.interaction&&this.interaction.zoom||1,this.scale=this.size},d.prototype.refresh=function(){var a=Object.keys(this.note);a.forEach(function(a){this.draw(a)}.bind(this))},d.prototype.cleanup=function(){null!==this.polygone&&(this.removePolygon(),this.polygone=null),this.debug("cleanup")},d.prototype.getPosition=function(){return e(this.pos[this.id])},d.prototype.getNote=function(){return this.note[this.id]},d.prototype.findNote=function(a){if(this.pos[a]){var b=angular.copy(this.pos[a]);"undefined"!=typeof b.string&&b.staffIdx++,this.note[a]=this.svgTools.getNote(b)}},d.prototype.isOnTab=function(){return this.svgTools.isTab(this.note[this.id].staff)},d.prototype.removePolygon=function(){this.polygone.removeFromParent()},d.prototype.bindPolygone=function(a){this.svg[a].node().insertBefore(this.polygone.node(),this.svg[a].node().firstChild)},d.prototype.loadCursor=function(a){this.setSize(),null!==this.polygone&&this.removePolygon(),this.createPolygon(),a||this.resetPos(),this.debug("loaded")},d.prototype.draw=function(c){if(this.id=a.account.id,"undefined"===c&&(c=void 0),(!this.scale||this.scale<0)&&this.setSize(),this.findNote(c),null===this.note[c]||null===this.note[c].note){var d=new Error("[cursor/draw] note not found");return d.id=c,d.this_note=this.node,void b.warn(d)}var e,f;if(c===this.id&&null!==this.polygone){this.bindPolygone(this.note[c].pageIdx),e=this.svgTools.getNbOccurs(this.note[c].note,"head"),f=e>0?this.svgTools.extractChild(this.note[c].note,"head",e-1):this.note[c].note;var g=this.svgTools.getNbVoice(f);0===this.mapping[this.pos[this.id].staffIdx].voices.indexOf(g)?this.color=this.colorVoice0:this.color=this.colorVoice1;var h=this.svg[0].node().createSVGTransformFromMatrix(f.getCTM());h.matrix.a=this.scale,h.matrix.d=this.scale,h.matrix.f+=this.getYMargin(f),h.matrix.e-=this.polygone.getBBox().width/2.5,this.polygone.node().transform.baseVal.initialize(h),this.polygone.node().style.fill=this.color}this.highlightNote(c)},d.prototype.highlightNote=function(a){this.id!==a||"undefined"==typeof this.pos[a].line&&"undefined"==typeof this.pos[a].string?this.id!==a&&(this.note[a].note.style.fill=this.collaborators.getUserColor(a),this.note[a].note.style.stroke=this.collaborators.getUserColor(a)):("undefined"!=typeof this.pos[a].line?this.note[a].head=this.svgTools.getHeadAtLine(this.note[a].note,this.pos[a].line):this.highlightTabHead(),this.note[a].head?(this.note[a].head.style.fill=this.color,this.note[a].head.style.stroke=this.color):(this.note[a].note.style.fill=this.color,this.note[a].note.style.stroke=this.color))},d.prototype.highlightTabHead=function(){var a=this.svgTools.getHeadAtLine(this.note[this.id].note,this.pos[this.id].string);if(!a){var b=new Adagio.Brush.Elem("rect");b.attr("width",this.svgTools.tabLine/this.svgTools.scaling).attr("height",this.svgTools.tabLine/this.svgTools.scaling).attr("fill",this.collaborators.getUserColor(this.id)).attr("class","rect-cursor").attr("transform","translate(0, "+((this.pos[this.id].string-1)*this.svgTools.tabLine-this.svgTools.tabLine/2)/this.svgTools.scaling+")").attr("rx",3).style("mix-blend-mode","darken"),a=this.note[this.id].note.appendChild(b.node())}this.note[this.id].head=a},d.prototype.undraw=function(a){null!==this.note[a]&&"undefined"!=typeof this.note[a]&&"undefined"!=typeof this.note[a].note&&(this.note[a].note.style.fill="black",this.note[a].note.style.stroke="black",this.note[a].note.style.opacity=1,null!==this.note[a].head&&"undefined"!=typeof this.note[a].head&&(this.note[a].head.classList.contains("rect-cursor")?this.note[a].note.removeChild(this.note[a].head):(this.note[a].head.style.fill="",this.note[a].head.style.stroke="",this.note[a].head.style.opacity=1,this.note[a].head=null)))},d.prototype.getYMargin=function(a){var b=this.note[this.id],c=this.svgTools.extractChild(b.staff,"staffLines",0),d=c.getElementsByTagName("line").length,e=this.svgTools.getCoord(c);return"undefined"!=typeof this.pos[this.id].string?Math.max(this.svgTools.getCoord(a).abs.y+this.polygone.getBBox().height,e.abs.y+this.svgTools.tabLine*d)-this.svgTools.getCoord(a).abs.y:Math.max(this.svgTools.getCoord(a).abs.y+this.polygone.getBBox().height,e.abs.y+this.svgTools.spaceLine*d)-this.svgTools.getCoord(a).abs.y},d.prototype.addGuys=function(a){a!==this.id&&(this.pos[a]={measureIdx:0,partIdx:0,staffIdx:0,voiceIdx:0,noteIdx:0})},d.prototype.delGuys=function(a){"undefined"!=typeof this.pos[a]&&"undefined"!=typeof this.note[a]&&(this.undraw(a),this.pos.splice(this.pos.indexOf(a),1),this.note.splice(this.pos.indexOf(a),1))},d.prototype.setPos=function(a){this.pos[this.id].measureIdx=a.measureIdx,this.pos[this.id].partIdx=a.partIdx,this.pos[this.id].noteIdx=a.noteIdx,this.pos[this.id].staffIdx=a.staffIdx,this.pos[this.id].voiceIdx=a.voiceIdx,"undefined"!=typeof a.graceIdx&&null!==a.graceIdx?this.pos[this.id].graceIdx=a.graceIdx:delete this.pos[this.id].graceIdx,"undefined"!=typeof a.string&&(this.pos[this.id].string=a.string),"undefined"!=typeof a.line&&(this.pos[this.id].line=a.line),this.mapping=this.dataReader.data.getPartStaffMapping(this.pos[this.id].partIdx,this.pos[this.id].staffIdx),this.undraw(this.id),this.draw(this.id)},d.prototype.changeFocus=function(a,b,d){null!==a.partIdx&&("undefined"==typeof this.pos[b]&&this.addGuys(b),this.pos[b].measureIdx=a.measureIdx,this.pos[b].partIdx=a.partIdx,this.pos[b].noteIdx=a.noteIdx,this.pos[b].staffIdx=a.staffIdx,this.pos[b].voiceIdx=a.voiceIdx,this.pos[b].graceIdx=a.graceIdx,"undefined"!=typeof a.closeLine?(this.pos[b].line=a.closeLine,delete this.pos[b].string):"undefined"!=typeof a.line?(this.pos[b].line=a.line,delete this.pos[b].string):delete this.pos[b].line,"undefined"!=typeof a.closeString?(this.pos[b].string=a.closeString,delete this.pos[b].line):"undefined"!=typeof a.string?(this.pos[b].string=a.string,delete this.pos[b].line):delete this.pos[b].string,this.mapping=this.dataReader.data.getPartStaffMapping(this.pos[this.id].partIdx,this.pos[this.id].staffIdx),"undefined"!=typeof Raven&&Raven.captureBreadcrumb({category:"cursor",message:"change: "+b,data:{pos:JSON.stringify(this.pos[b])}}),this.undraw(b),this.draw(b),b!==this.id||d||c(this.sendPosition.bind(this)))},d.prototype.sendPosition=function(){this.pos[this.id]&&a.$broadcast("RealTime.position",{partIdx:this.pos[this.id].partIdx,measureIdx:this.pos[this.id].measureIdx,staffIdx:this.pos[this.id].staffIdx,voiceIdx:this.pos[this.id].voiceIdx,noteIdx:this.pos[this.id].noteIdx})},d.prototype.createPolygon=function(){var a=new Adagio.Brush.Elem("path");a.attr("d",f),this.polygone=a,this.bindPolygone(0)},d}]),angular.module("flat.editor.services").factory("flat.editor.services.DataReader",["$rootScope",function(a){"use strict";function b(a,b){this.svgTools=a,this.data=b}return b.prototype.getNextRightMeasure=function(a){var b=this.data.getNbMeasures();return a.measureIdx<b-1&&a.measureIdx++,a.noteIdx=0,a},b.prototype.getNextLeftMeasure=function(a){return a.measureIdx>0?a.measureIdx--:(a.measureIdx=0,a.noteIdx=0),a},b.prototype.getLeftPos=function(a){var b,c=angular.copy(a);return c.graceIdx-1<0?(delete c.graceIdx,c.noteIdx>0?c.noteIdx--:c.measureIdx>0&&(c.measureIdx--,this.checkVoice(c),b=this.getNbNotes(c),c.noteIdx=b-1)):c.noteIdx>0?c.noteIdx--:c.measureIdx>0?(c.measureIdx--,this.checkVoice(c),b=this.getNbNotes(c),c.noteIdx=b-1):(c.measureIdx=0,c.noteIdx=0),c},b.prototype.getLeftGracePos=function(a){var b=angular.copy(a),c=this.getNoteInfo(b);return c.nbGraces>0&&("undefined"==typeof b.graceIdx||b.graceIdx-1>=0)?"undefined"==typeof b.graceIdx?b.graceIdx=c.nbGraces-1:b.graceIdx--:b=this.getLeftPos(b),b},b.prototype.partHasTabs=function(a){return!!(a&&this.data&&this.data.isPartTab(a.partIdx))},b.prototype.getRightNotePos=function(a){var b=angular.copy(a),c=this.getNbNotes(b),d=this.getNbMeasures();return b.noteIdx+1<c?(b.noteIdx++,this.data.getNoteData(this.convertVoiceIdx(b)).nbGraces&&(b.graceIdx=0)):b.measureIdx+1<d?(b.measureIdx++,this.checkVoice(b),b.noteIdx=0):(b.measureIdx=d-1,b.noteIdx=c-1),b},b.prototype.getRightGraceNotePos=function(a){var b=angular.copy(a),c=this.getNoteInfo(b);return"undefined"!=typeof b.graceIdx?b.graceIdx+1<c.nbGraces?b.graceIdx++:b.graceIdx+1>=c.nbGraces&&delete b.graceIdx:b=this.getRightNotePos(b),
b},b.prototype.getUpNextNote=function(b){var c;if(b.staffIdx>0)b.staffIdx--;else if(b.partIdx>0)b.partIdx--,c=this.data.getPartContent(b.partIdx),b.staffIdx=Adagio.Utils.partContentUtils.getNbStaves(c);else if("page"===a.scoreLayout){var d=this.svgTools.getNextUpPos(b.partIdx,b.measureIdx);null!==d&&(b.measureIdx=d,b.partIdx=this.data.getNbParts()-1)}return b},b.prototype.getDownNextNote=function(b){var c=this.data.getNbParts(),d=this.data.getPartContent(b.partIdx),e=Adagio.Utils.partContentUtils.getNbStaves(d);if(b.staffIdx+1<e)b.staffIdx++;else if(b.partIdx+1<c)b.partIdx++,b.staffIdx=0;else if("page"===a.scoreLayout){var f=this.svgTools.getNextDownPos(b.partIdx,b.measureIdx);null!==f&&(b.measureIdx=f,b.partIdx=0)}return b},b.prototype.getNbNotes=function(a){return this.data.getPartVoiceNbNotes(this.convertVoiceIdx(a))},b.prototype.getDiffNotes=function(a,b){return angular.equals(a,b)?0:a.measureIdx===b.measureIdx?a.noteIdx<b.noteIdx?1:-1:a.measureIdx<b.measureIdx?1:-1},b.prototype.convertVoiceIdx=function(a){delete a.elem;var b=angular.copy(a);return"undefined"!=typeof a.partIdx&&"undefined"!=typeof a.staffIdx&&"undefined"!==a.voiceIdx&&(b.voiceIdx=this.data.getPartStaffVoiceAtIdx(a.partIdx,a.staffIdx,a.voiceIdx)),b},b.prototype.getNoteInfo=function(a){return this.data.getNoteData(this.convertVoiceIdx(a))},b.prototype.getNbMeasures=function(){return this.data.getNbMeasures()},b.prototype.comparePos=function(a,b){return a.partIdx===b.partIdx&&a.noteIdx===b.noteIdx&&a.staffIdx===b.staffIdx&&a.measureIdx===b.measureIdx&&a.voiceIdx===b.voiceIdx},b.prototype.hasTransposingInstrument=function(){if(!this.data)return!1;for(var a=this.data.getNbParts(),b=0;b<a;b++){var c=this.data.getStaffMeasure({partIdx:b,measureIdx:0,staffIdx:0});if(Adagio.Utils.transposeUtils.isIdentity(c.transpose)===!1)return!0}return!1},b.prototype.getTabsAtString=function(a,b){if(a.tabsData&&"undefined"!=typeof b)for(var c=0;c<a.tabsData.length;c++)if(a.tabsData[c]&&a.tabsData[c].string===b)return a.tabsData[c];return null},b.prototype.getStringIdx=function(a,b){if(a.tabsData&&"undefined"!=typeof b)for(var c=0;c<a.tabsData.length;c++)if(a.tabsData[c]&&a.tabsData[c].string===b)return c;return null},b.prototype.getNoteAtLine=function(a,b){if(!a.isRest&&"undefined"!=typeof b)for(var c=0;c<a.lines.length;c++)if(a.lines[c]===b)return c;return null},b.prototype.checkVoice=function(a){1!==a.voiceIdx||this.data.hasMeasureVoice(this.convertVoiceIdx(a))?0!==a.voiceIdx||this.data.hasMeasureVoice(this.convertVoiceIdx(a))||(a.voiceIdx=1):a.voiceIdx=0},b.prototype.hasVoiceAtMeasure=function(a,b){return!(!a||!this.data.hasPartStaffVoiceAtIdx(a.partIdx,a.staffIdx,b))&&(a.voiceIdx=b,this.data.hasMeasureVoice(this.convertVoiceIdx(a)))},b.prototype.validateData=function(a){var b=!1,c=this.data.getNbParts(),d=this.data.getNbMeasures();a.partIdx>=c&&(a.partIdx=c-1,b=!0);var e=this.data.getPartStaffMapping(a.partIdx).length;if(a.staffIdx>=e&&(a.staffIdx=e-1,b=!0),a.measureIdx>=d&&(a.measureIdx=d-1,b=!0),this.checkVoice(a),b===!0)a.noteIdx=0,a.graceIdx=null;else{var f=this.getNbNotes(a);if(a.noteIdx>=f&&(a.noteIdx=f-1,b=!0),b===!1&&null!==a.graceIdx&&"undefined"!=typeof a.graceIdx){var g=this.getNoteInfo(a);0===g.nbGraces?(a.graceIdx=null,b=!0):a.graceIdx>=g.nbGraces&&(a.graceIdx=g.nbGraces-1,b=!0)}}return b},b}]),angular.module("flat.editor.services").factory("EditorHelpService",EditorHelpService),EditorHelpService.$inject=["_","$q","$rootScope"],angular.module("flat.editor.services").factory("flat.editor.services.InlineComments",["ScoreCommentIDB",function(a){"use strict";function b(a,b,c){this.marker=b,this.comments=a,this.dataReader=c,this.rect=[]}return b.prototype.refresh=function(){this.marker.clearMarkers(),this.comments.list.forEach(function(a,b){var c=angular.copy(a.context),d=this.marker.addMarker(c);null===d?(a.resolved=!0,this.resolveComment(a),this.comments.list.splice(b,1)):this.contextHasChanged(c,d,a)?(this.colorElem(d,a.id,"rgba(255,219,98,0.40)"),this.rect[a.id]=d.markerGroups):(this.updateComment(a,this.buildOpt(d)),this.colorElem(d,a.id,"rgba(255,219,98,0.40)"))}.bind(this))},b.prototype.colorElem=function(a,b,c){a.markerGroups.forEach(function(a){a.attr("data-inline-comment",b),a.attr("fill",c),a.style("mix-blend-mode","darken")})},b.prototype.getParamToAdd=function(a){var b=this.getTimePos(a);return b.partUuid=this.convertPartToUuid(a),b.measureUuids=this.convertRangeToUuid(a),b.staffIdx=a.staffIdx,b},b.prototype.convertRangeToUuid=function(a){return this.dataReader.data.getMeasureUuids(a.startMeasureIdx,a.stopMeasureIdx)},b.prototype.convertPartToUuid=function(a){return this.dataReader.data.getPartUuid(a.partIdx)},b.prototype.isInsideComments=function(a){for(var b=this.dataReader.data.getPartUuid(a.partIdx),c=this.dataReader.data.getMeasureUuid(a.measureIdx),d=0;d<this.comments.list.length;d++)if(this.comments.list[d].context.partUuid===b&&this.comments.list[d].context.measureUuids.indexOf(c)>=0&&a.staffIdx===this.comments.list[d].context.staffIdx)return this.comments.highlightedId=this.comments.list[d].id,void this.darkenRange();this.comments.highlightedId=null},b.prototype.getTimePos=function(a){var b=this.dataReader.data.getPartContent(a.partIdx),c=Adagio.Utils.partContentUtils.getMeasures(b),d=new Adagio.edit.common.MeasuresScroller(c,a.partIdx,this.dataReader.data);return Adagio.edit.common.noteIdxIntervalToTimePosInterval(d,a)},b.prototype.darkenRange=function(){this.refresh();var a=this.comments.highlightedId;a&&this.rect&&this.rect[a]&&this.rect[a].forEach(function(a){a.attr("fill","rgba(255,197,0,0.40)")})},b.prototype.updateComment=function(b,c){b.context=c,a.put(b)},b.prototype.resolveComment=function(b){a.resolve({score:b.score,id:b.id})},b.prototype.contextHasChanged=function(a,b){return angular.equals(this.buildOpt(b),this.buildOpt(a))},b.prototype.buildOpt=function(a){return{measureUuids:a.measureUuids,partUuid:a.partUuid,staffIdx:a.staffIdx,startDpq:a.startDpq,startTimePos:a.startTimePos,stopDpq:a.stopDpq,stopTimePos:a.stopTimePos}},b}]),angular.module("flat.editor.services").factory("flat.editor.services.Interaction",["$rootScope","$log","$injector","$timeout","UxStore","Experience","MessageService","flat.editor.services.Cursor","flat.editor.services.CancelStack","flat.editor.services.SVGTools","flat.editor.services.Config","flat.editor.services.RangeSelect","flat.editor.services.DataReader","flat.editor.services.DomCache",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(a,b){this.insertMode=Adagio.edit.values.InsertMode.REPLACE,this.duration=null,this.d=debug("flat:interac"),this.currentStyle="classic",this.MIDIProgram=null,this.focus=!1,this.noteInfo=null,this.voiceIdx=0,this.mode=null,this.zoom=e.get("score-view.zoom")||1,this.InlinePopOver=!1,this.config=new k,this.svgTools=new j.SVGTools,this.rangeSelect=new l(this),this.domCache=new n(this),this.cursor=new h(null,this),this.score=a,b&&this.setData(b)}var p=3,q=.2,r={"action.AddNote":"editor.addnote","action.AddNoteCrossMeasure":"editor.addnote","action.AddNotePercu":"editor.addnotepercu","action.AddNoteTab":"editor.addnotetab","action.AddAccidentals":"editor.accidental","action.AddCourtesyAccidental":"editor.coutesy","action.AddMeasure":"editor.addmeasure","action.AddTie":"editor.tienote","action.AddTiePercu":"editor.tienote","action.SetTempo":"editor.tempo","action.AddRepeat":"editor.addrepeat","action.AddEndings":"editor.addendings","action.SetClef":"editor.addclef","action.SetKey":"editor.setkey","action.Transpose":"editor.transpose","action.TransposeStaff":"editor.transpose","action.AddDynamics":"editor.adddynamics","action.AddTuplet":"editor.addtuplet","action.AddOctaveShift":"editor.octaveShift","action.SetTimeSignature":"editor.timesignature","action.AddChord":"editor.addchord","action.AddChordCrossMeasure":"editor.addchord","action.AddLyrics":"editor.addlyrics","action.AddWedge":"editor.addwedge","action.AddSlurs":"editor.addslurs","action.AddGhostNotePercu":"editor.ghostnote","action.AddGhostNotes":"editor.ghostnote","action.ChangeFret":"editor.changefret","action.AddOrnament":"editor.addornament","action.AddArticulation":"editor.articulation","action.AddNotation":"editor.notation","action.AddTechnical":"editor.technical","action.InsertGraceNote":"editor.graceNote","action.AddPedal":"editor.pedal","action.AddPizzicato":"editor.pizzicato","action.AddGraceToChord":"editor.chordGrace","action.AddVoices":"editor.addvoices","action.AddGlissando":"editor.addglissando","action.SetRights":"editor.credits","action.SetLyricist":"editor.credits","action.SetComposer":"editor.credits","action.SetTitle":"editor.credits","action.SetSubtitle":"editor.credits","action.ChangePartName":"editor.instruments.rename","action.ChangeInstrument":"editor.instruments.replace","action.MovePart":"editor.instruments.move","action.RemovePart":"editor.instruments.rm","action.AddPart":"editor.instruments.add","action.AddPartPercu":"editor.instruments.add","action.AddStaff":"editor.instruments.staves","action.RemoveStaff":"editor.instruments.staves","action.SetScaling":"editor.score-layout","action.SetPageSize":"editor.score-layout","action.SetTopMargin":"editor.score-layout","action.SetBottomMargin":"editor.score-layout","action.SetLeftMargin":"editor.score-layout","action.SetRightMargin":"editor.score-layout","action.SetSystemBreakPolicy":"editor.measuresline","action.AddRehearsalWithUpdate":"editor.rehearsal","action.AddHammerOnPullOff":"editor.hammeron","action.AddWordAtNote":"editor.word","action.AddWordAtIdx":"editor.word","action.InsertSlashedGraceNote":"editor.slashgrace","action.InsertSlashedGraceNotePercu":"editor.slashgrace"};o.prototype.setZoomAuto=function(a){return this.zoomAuto=!!a,this.zoomAuto&&this.zoomReset(),this.zoomAuto},o.prototype.getViewportWidth=function(){return window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth},o.prototype.applyZoomAuto=function(){if(this.zoomAuto&&"page"===a.scoreLayout&&this.pageWidthNoScaling){var b=Math.round((this.getViewportWidth()-40)/this.pageWidthNoScaling*100)/100;b>1.25?b=1.25:b<q&&(b=q),this.d("zoom: %s",b),this.zoom=b,a.$broadcast("ScoreScaling.Updated"),d(angular.noop)}},o.prototype.setData=function(a){this.data=a,this.dataReader?this.dataReader.data=a:(this.dataReader=new m(this.svgTools,a),this.rangeSelect.dataReader=this.dataReader)},o.prototype.setMouse=function(a,b){this.mouse=a,this.selected=b},o.prototype.openKeyboardShortcutsModal=function(){a.flat.modal&&"shortcuts"===a.flat.modal.name?a.hideModal():(this.openModal("shortcuts"),d(angular.noop))},o.prototype.getDuration=function(){return this.duration},o.prototype.play=function(){this.audio.pausing||this.audio.playing?this.audio.stop():this.audio.play(),this.focusKeyboard()},o.prototype.pause=function(){this.audio.pausing?(this.audio.play(),this.focusKeyboard()):this.audio.pause()},o.prototype.getMIDIInstrumentId=function(a){var b=this.data.getPartData({partIdx:a}),c=b.instrumentsData[0];return{program:c.MIDIProgram,unpitched:c.MIDIUnpitched,isUnpitched:b.isUnpitched||!1}},o.prototype.setMIDIInstrumentId=function(a){var b=this.getMIDIInstrumentId(a.partIdx);this.MIDIProgram&&b&&this.MIDIProgram.program===b.program&&this.MIDIProgram.unpitched===b.unpitched&&this.MIDIProgram.isUnpitched===b.isUnpitched||(this.MIDIProgram=b)},o.prototype.checkStyle=function(a){"undefined"!=typeof a.partIdx&&"classic"===this.currentStyle&&this.data.isPartUnpitched(a.partIdx)&&this.changeStyle("drum"),"undefined"==typeof a.partIdx||"drum"!==this.currentStyle||this.data.isPartUnpitched(a.partIdx)||this.changeStyle("classic")},o.prototype.changeCursor=function(b,c){this.dataReader.validateData(b),this.dataReader.data.hasPartStaffVoiceAtIdx(b.partIdx,b.staffIdx,this.voiceIdx)||(this.voiceIdx=0),this.cursor.changeFocus(b,a.account.id,c),this.checkStyle(b),this.setMIDIInstrumentId(b),this.getNoteInfo(),this.score.inlineComments&&this.score.inlineComments.isInsideComments(b)},o.prototype.changePitch=function(a){a.accidental=null,a.isConcertPitch=this.config.get().isConcertPitch,this.data.isPartUnpitched(a.partIdx)||"undefined"!=typeof a.graceIdx?"undefined"!=typeof a.graceIdx?this.do("action.ChangeGracePitch",a):this.do("action.ChangePitchPercu",a):this.do("action.ChangePitch",a),this.audio.playNote(this.dataReader.convertVoiceIdx(a))},o.prototype.setLastNoteAdded=function(a){return null===a?void(this.lastNoteAdded=void 0):void(this.lastNoteAdded=a)},o.prototype.AddNote=function(a,b,c,d){b.midi=d,b.insertMode=this.insertMode,b.durationType=a,b.isConcertPitch=this.config.get().isConcertPitch,"undefined"==typeof b.nbDots&&(b.nbDots=this.noteInfo.nbDots),"undefined"==typeof b.accidental&&(b.accidental=null),this.noteInfo.isRest&&(b.closeLine=b.line),"classic"===this.currentStyle&&"undefined"==typeof b.string&&"undefined"==typeof b.graceIdx?this.do("action.AddNoteCrossMeasure",b):"undefined"!=typeof b.graceIdx?"drum"===this.currentStyle?(b.notehead=this.noteInfo.noteheads[this.noteInfo.lines.indexOf(b.line)],this.do("action.AddGraceToChordPercu",b)):this.do("action.AddGraceToChord",b):"undefined"!=typeof b.string?("undefined"==typeof b.fretData&&(b.fretData={string:b.string,fret:0}),this.do("action.AddNoteTab",b)):this.do("action.AddNotePercu",b),this.setLastNoteAdded(b),c||this.audio.playNote(this.dataReader.convertVoiceIdx(b))},o.prototype.AddChordCrossMeasure=function(a,b,c,d,e){a.quarterDuration=b,a.quarterPosition=c,a.pitches=d,a.midi=e,this.do("action.AddChordCrossMeasure",a)},o.prototype.RemoveNote=function(a){var b=this.cursor.getPosition();if(b.insertMode=this.insertMode,b.formatRests=!0,b.isConcertPitch=this.config.get().isConcertPitch,a?(b.pitch=a,delete b.line):"undefined"!=typeof b.string||this.noteInfo.isChord&&"undefined"!=typeof b.line||(b.line=this.noteInfo.lines[0]),"undefined"!=typeof b.string){if(b.fretData=this.getTabsAtString(b.string),null===b.fretData)return;this.do("action.RemoveNoteTab",b)}else"undefined"!=typeof b.graceIdx&&this.noteInfo.isChord?"drum"===this.currentStyle?this.do("action.RemoveGraceFromChordPercu",b):this.do("action.RemoveGraceFromChord",b):"undefined"!=typeof b.graceIdx?"drum"===this.currentStyle?this.do("action.DeleteGraceNotePercu",b):this.do("action.DeleteGraceNote",b):"classic"===this.currentStyle?this.do("action.RemoveNote",b):this.do("action.RemoveNotePercu",b)},o.prototype.RemoveRest=function(){var a=this.cursor.getPosition();this.do("action.DeleteRest",a)},o.prototype.getAccidental=function(a,b){var c,d=-1;return a.accidentals?(a.lines&&(d=a.lines.indexOf(b.line)),d!==-1&&d<a.accidentals.length&&(c=a.accidentals[d]),c):c},o.prototype.getAlter=function(a,b){var c,d=-1;return a.pitches?(a.lines&&(d=a.lines.indexOf(b.line)),d!==-1&&d<a.pitches.length&&(c=a.pitches[d].alter),c):c},o.prototype.getCourtesy=function(a,b){var c,d=-1;return a.courtesyAccidentals?(a.lines&&(d=a.lines.indexOf(b.line)),d!==-1&&d<a.courtesyAccidentals.length&&(c=a.courtesyAccidentals[d]),c):c},o.prototype.lookUpNatural=function(){var a=this.lastNoteAdded,b=this.cursor.getPosition(),c=this.noteInfo,d=!1;this.noteInfo.isRest&&a&&(b=a,c=this.dataReader.getNoteInfo(b),d=!0);var e=this.getAccidental(c,b),f=this.getCourtesy(c,b),g=this.getAlter(c,b);e===Adagio.Values.AccidentalStyle.NATURAL?this.do([{name:"action.RemoveCourtesyAccidentals",opts:this.RemoveCourtesy(b,!0)},this.RemoveAccidentals(b,!0,!0)]):0!==g||e||f?0===g&&f?this.RemoveCourtesy(b):this.isRest?this.AddAccidentals(b,Adagio.Values.AccidentalStyle.NATURAL):this.do([{name:"action.RemoveCourtesyAccidentals",opts:this.RemoveCourtesy(b,!0)},this.AddAccidentals(b,Adagio.Values.AccidentalStyle.NATURAL,!0,!0)]):this.AddCourtesy(b)},o.prototype.lookUpFlat=function(){var a=this.lastNoteAdded,b=this.cursor.getPosition(),c=this.noteInfo,d=!1;this.noteInfo.isRest&&a&&(b=a,c=this.dataReader.getNoteInfo(b),d=!0);var e=this.getAccidental(c,b),f=this.getCourtesy(c,b),g=this.getAlter(c,b);g===-1?e===Adagio.Values.AccidentalStyle.FLAT?this.AddAccidentals(b,Adagio.Values.AccidentalStyle.FLATFLAT):null!==e||f?f&&this.do([{name:"action.RemoveCourtesyAccidentals",opts:this.RemoveCourtesy(b,!0)},this.AddAccidentals(b,Adagio.Values.AccidentalStyle.FLATFLAT,!0,!0)]):this.AddCourtesy(b):g===-2?e===Adagio.Values.AccidentalStyle.FLATFLAT?this.RemoveAccidentals(b):null!==e||f?f&&this.do([{name:"action.RemoveCourtesyAccidentals",opts:this.RemoveCourtesy(b,!0)},this.RemoveAccidentals(b,!0,!0)]):this.AddCourtesy(b):this.noteInfo.isRest?this.AddAccidentals(b,Adagio.Values.AccidentalStyle.FLAT):this.do([{name:"action.RemoveCourtesyAccidentals",opts:this.RemoveCourtesy(b,!0)},this.AddAccidentals(b,Adagio.Values.AccidentalStyle.FLAT,!0,!0)]),d&&(this.lastNoteAdded=a)},o.prototype.lookUpSharp=function(){var a=this.lastNoteAdded,b=this.cursor.getPosition(),c=this.noteInfo,d=!1;this.noteInfo.isRest&&a&&(b=angular.copy(a),c=this.dataReader.getNoteInfo(b),d=!0);var e=this.getAccidental(c,b),f=this.getCourtesy(c,b),g=this.getAlter(c,b);1===g?e===Adagio.Values.AccidentalStyle.SHARP?this.AddAccidentals(b,Adagio.Values.AccidentalStyle.DOUBLESHARP):null!==e||f?f&&this.do([{name:"action.RemoveCourtesyAccidentals",opts:this.RemoveCourtesy(b,!0)},this.AddAccidentals(b,Adagio.Values.AccidentalStyle.DOUBLESHARP,!0,!0)]):this.AddCourtesy(b):2===g?e===Adagio.Values.AccidentalStyle.DOUBLESHARP?this.RemoveAccidentals(b):null!==e||f?f&&this.do([{name:"action.RemoveCourtesyAccidentals",opts:this.RemoveCourtesy(b,!0)},this.RemoveAccidentals(b,!0,!0)]):this.AddCourtesy(b):this.noteInfo.isRest?this.AddAccidentals(b,Adagio.Values.AccidentalStyle.SHARP):this.do([{name:"action.RemoveCourtesyAccidentals",opts:this.RemoveCourtesy(b,!0)},this.AddAccidentals(b,Adagio.Values.AccidentalStyle.SHARP,!0,!0)]),d&&(this.lastNoteAdded=a)},o.prototype.RemoveAccidentals=function(a,b,c){return a.isConcertPitch=this.config.get().isConcertPitch,c?"undefined"==typeof a.graceIdx?{opts:a,name:"action.RemoveAccidentals"}:(a.accidental=null,{opts:a,name:"action.AddGraceAccidental"}):("undefined"==typeof a.graceIdx?this.do("action.RemoveAccidentals",a):(a.accidental=null,this.do("action.AddGraceAccidental",a)),void(b||this.audio.playNote(this.dataReader.convertVoiceIdx(a))))},o.prototype.RemoveCourtesy=function(a,b){return a.isConcertPitch=this.config.get().isConcertPitch,b?a:void this.do("action.RemoveCourtesyAccidentals",a)},o.prototype.AddAccidentals=function(a,b,c,d){return a.isConcertPitch=this.config.get().isConcertPitch,a.accidental=b,d?"undefined"==typeof a.graceIdx?{opts:a,name:"action.AddAccidentals"}:{opts:a,name:"action.AddGraceAccidental"}:("undefined"==typeof a.graceIdx?this.do("action.AddAccidentals",a):this.do("action.AddGraceAccidental",a),void(c||this.audio.playNote(this.dataReader.convertVoiceIdx(a))))},o.prototype.AddCourtesy=function(a,b){return a.isConcertPitch=this.config.get().isConcertPitch,b?a:void this.do("action.AddCourtesyAccidentals",a)},o.prototype.AddEndings=function(a){var b=this.cursor.getPosition(),c=this.data.getCommonContent().getEnding(b.measureIdx)||[];c.length>0&&(this.RemoveEndings(),c=[]),c.indexOf(a)===-1&&c.push(a),this.do("action.AddEnding",{measureIdx:b.measureIdx,numbers:c})},o.prototype.RemoveEndings=function(){var a=this.cursor.getPosition();this.do("action.RemoveEnding",{measureIdx:a.measureIdx})},o.prototype.getEndings=function(){var a=this.cursor.getPosition();return this.data.getCommonContent().getEnding(a.measureIdx)||[]},o.prototype.AddTie=function(a){if(this.noteInfo.isRest)return g.broadcast("Action can't be done on a rest. Add a note first",{color:"warning"});var b=this.cursor.getPosition();this.noteInfo.isChord||(b.line=this.noteInfo.lines[0]),this.data.isPartUnpitched(b.partIdx)?this.do("action.AddTiePercu",b):this.do("action.AddTie",b),a||this.audio.playNote(this.dataReader.convertVoiceIdx(b))},o.prototype.RemoveTie=function(){if(this.noteInfo.isRest)return g.broadcast("Action can't be done on a rest. Add a note first",{color:"warning"});var a=this.cursor.getPosition();this.noteInfo.isChord||(a.line=this.noteInfo.lines[0]),this.data.isPartUnpitched(a.partIdx)?this.do("action.RemoveTiePercu",a):this.do("action.RemoveTie",a),this.audio.playNote(this.dataReader.convertVoiceIdx(a))},o.prototype.AddRepeat=function(a){var b=this.cursor.getPosition();b.direction=a.direction,this.do("action.AddRepeat",b)},o.prototype.AddBarline=function(a){var b=this.cursor.getPosition();b.style=a,b.side="right",this.do("action.AddBarline",b)},o.prototype.AddDoubleBarline=function(){var a=this.cursor.getPosition();this.do("action.AddDoubleBarline",a)},o.prototype.RemoveBarline=function(a){var b=this.cursor.getPosition();"forward"===a.direction?b.side=Adagio.edit.values.PosBarline.LEFT:b.side=Adagio.edit.values.PosBarline.RIGHT,this.do("action.RemoveBarline",b)},o.prototype.AddClef=function(a){var b=this.cursor.getPosition(),c=this.checkRange();b.startMeasureIdx=c.min,b.stopMeasureIdx=c.max,b.clef=a,this.do("action.SetClef",b)},o.prototype.AddTechnical=function(a){var b=this.cursor.getPosition();b.technicalType=a,this.do("action.AddTechnical",b)},o.prototype.RemoveTechnical=function(a){var b=this.cursor.getPosition();b.technicalType=a,this.do("action.RemoveTechnical",b)},o.prototype.AddHammer=function(){var a=this.cursor.getPosition();"undefined"!=typeof a.string&&(a.fretData=this.getTabsAtString(a.string),delete a.string),this.do("action.AddHammerOnPullOff",a)},o.prototype.RemoveHammer=function(){var a=this.cursor.getPosition();a.isConcertPitch=this.config.get().isConcertPitch,"undefined"!=typeof a.string&&(a.fretData=this.getTabsAtString(a.string),delete a.string),this.do("action.RemoveHammerOnPullOff",a)},o.prototype.AddGhostNote=function(a){"undefined"!=typeof a&&"undefined"!=typeof a.partIdx||(a=this.cursor.getPosition()),"drum"===this.currentStyle?this.do("action.AddGhostNotePercus",a):this.do("action.AddGhostNotes",a)},o.prototype.RemoveGhostNote=function(a){"undefined"!=typeof a&&"undefined"!=typeof a.partIdx||(a=this.cursor.getPosition()),"drum"===this.currentStyle?this.do("action.RemoveGhostNotePercus",a):this.do("action.RemoveGhostNotes",a)},o.prototype.AddArticulation=function(a){var b=this.cursor.getPosition();b.articulationType=a,this.do("action.AddArticulations",b)},o.prototype.RemoveArticulation=function(a){var b=this.cursor.getPosition();b.articulationType=a,this.do("action.RemoveArticulation",b)},o.prototype.AddOrnament=function(a,b){var c,d=this.cursor.getPosition();if(d.ornamentType=a,d.ornamentsOpts=b||{},a===Adagio.Values.OrnamentType.MORDENT||a===Adagio.Values.OrnamentType.INVERTED_MORDENT){if(c=angular.copy(this.noteInfo.ornaments),c[a]&&this.RemoveOrnament(a),c[a]&&c[a].long===b.long&&c[a].approach===b.approach&&c[a].departure===b.departure)return;a===Adagio.Values.OrnamentType.MORDENT&&c[Adagio.Values.OrnamentType.INVERTED_MORDENT]?this.RemoveOrnament(Adagio.Values.OrnamentType.INVERTED_MORDENT):a===Adagio.Values.OrnamentType.INVERTED_MORDENT&&c[Adagio.Values.OrnamentType.MORDENT]&&this.RemoveOrnament(Adagio.Values.OrnamentType.MORDENT)}else if((a===Adagio.Values.OrnamentType.TURN||a===Adagio.Values.OrnamentType.INVERTED_TURN)&&(c=angular.copy(this.noteInfo.ornaments),c[a]))return this.RemoveOrnament(a);this.do("action.AddOrnament",d)},o.prototype.RemoveOrnament=function(a){var b=this.cursor.getPosition();b.ornamentType=a,this.do("action.RemoveOrnament",b)},o.prototype.AddArpeggio=function(){var a=this.cursor.getPosition();this.do("action.AddArpeggio",a)},o.prototype.RemoveArpeggio=function(){var a=this.cursor.getPosition();this.do("action.RemoveArpeggio",a)},o.prototype.AddGlissando=function(){var a=this.cursor.getPosition();this.do("action.AddGlissandos",a)},o.prototype.RemoveGlissando=function(){var a=this.cursor.getPosition();this.do("action.RemoveGlissandos",a)},o.prototype.AddNotation=function(a){var b=this.cursor.getPosition();b.notationType=a,this.do("action.AddNotations",b)},o.prototype.RemoveNotation=function(a){var b=this.cursor.getPosition();b.notationType=a,this.do("action.RemoveNotation",b)},o.prototype.AddDynamics=function(a,b,c){c||(c=this.cursor.getPosition()),c.placement=b,c.style=a,this.do("action.AddDynamics",c)},o.prototype.RemoveDynamics=function(a,b){b||(b=this.cursor.getPosition()),b.dynamicIdx=a,this.do("action.RemoveDynamicAtIdx",b)},o.prototype.getMeasureStartStop=function(){var a=this.cursor.getPosition(),b=this.dataReader.getNbNotes(a);return 1===b?a.measureIdx+1<this.data.getNbMeasures()&&(a.startMeasureIdx=a.measureIdx,a.startNoteIdx=0,a.stopNoteIdx=1,a.stopMeasureIdx=a.measureIdx+1):(a.startMeasureIdx=a.measureIdx,a.startNoteIdx=a.noteIdx,a.stopNoteIdx=b,a.stopMeasureIdx=a.measureIdx),a},o.prototype.bindTempoChange=function(){var a=this.cursor.getPosition(),b=this.svgTools.getMeasure(0,a.measureIdx,0),c=this.svgTools.getElementsByClassName(b.staff,"tempoChange"),d=this.svgTools.getElementsByClassName(b.measure,"note")[0],e=this.svgTools.getBBox(d),f=this.svgTools.getCoord(d),g=f.relative.x,h=f.relative.y,i={clientX:g+e.width/2+e.x,clientY:h+e.height/2+e.y};c=this.svgTools.getCloserElem(i,c),c&&this.selected.select(c,this.cursor.getPosition(),this.selected.color)},o.prototype.lookupTempoChange=function(a){if(this.noteInfo.tempoChange&&a===this.noteInfo.tempoChange.type)this.RemoveTempoChange(this.cursor.getPosition());else{var b=this.getMeasureStartStop();b.callback=function(){this.err||this.bindTempoChange()}.bind(this),this.AddTempoChange(a,b)}},o.prototype.AddTempoChange=function(a,b){if("undefined"==typeof b.partIdx){var c=this.cursor.getPosition();b.partIdx=c.partIdx,b.staffIdx=c.staffIdx,b.voiceIdx=c.voiceIdx}b.type=a,this.do("action.AddTempoChange",b)},o.prototype.RemoveTempoChange=function(a){a||(a=this.cursor.getPosition()),this.do("action.RemoveTempoChange",a)},o.prototype.RemoveTempoChangeAtTimePos=function(a){a&&this.do("action.RemoveTempoChangeAtTimePos",a)},o.prototype.lookupWedge=function(a,b,c){"undefined"==typeof c&&(c=this.getMeasureStartStop()),this.noteInfo.wedgeType&&this.noteInfo.wedgeType===a?this.RemoveWedge():(c.callback=function(){this.err||this.bindWedge()}.bind(this),this.AddWedge(a,b,c))},o.prototype.AddWedge=function(a,b,c){if("undefined"==typeof c.partIdx){var d=this.cursor.getPosition();c.partIdx=d.partIdx,c.staffIdx=d.staffIdx,c.voiceIdx=d.voiceIdx}c.placement=b,c.type=a,this.do("action.AddWedge",c)},o.prototype.RemoveWedge=function(a){a||(a=this.cursor.getPosition()),this.do("action.RemoveWedge",a)},o.prototype.RemoveWedgeAtTimePos=function(a){"undefined"!=typeof a&&this.do("action.RemoveWedgeAtTimePos",a)},o.prototype.bindWedge=function(){var a=this.cursor.getNote(),b=this.svgTools.getElementsByClassName(a.staff,"wedgeLines"),c=this.svgTools.getBBox(a.note),d=this.svgTools.getCoord(a.note),e=d.relative.x,f=d.relative.y,g={clientX:e+c.width/2+c.x,clientY:f+c.height/2+c.y};b=this.svgTools.getCloserElem(g,b),b&&this.selected.select(b,this.cursor.getPosition(),this.selected.color)},o.prototype.lookupOctaveShift=function(a,b,c){return this.noteInfo.octaveShift?void this.RemoveOctaveShift():("undefined"==typeof c&&(c=this.getMeasureStartStop()),void this.AddOctaveShift(a,b,c))},o.prototype.AddOctaveShift=function(a,b,c){c.placement=b,c.size=a,this.do("action.AddOctaveShift",c)},o.prototype.RemoveOctaveShift=function(a){a||(a=this.cursor.getPosition()),this.do("action.RemoveOctaveShift",a)},o.prototype.RemoveOctaveShiftAtTimePos=function(a){a&&this.do("action.RemoveOctaveShiftAtTimePos",a)},o.prototype.AddDotted=function(a,b,c){var d=this.cursor.getPosition();d.insertMode=this.insertMode,d.durationType=a,d.nbDots=b,d.formatRests=!0,"classic"===this.currentStyle?this.do("action.ChangeDurationCrossMeasure",d,c):this.do("action.ChangeDurationFormat",d,c),this.audio.playNote(this.dataReader.convertVoiceIdx(d)),f.add("editor.dotted")},o.prototype.SetKey=function(a){var b=this.cursor.getPosition(),c=this.checkRange();b.firstMeasureIdx=c.min,b.lastMeasureIdx=c.max,b.key={fifths:a},this.do("action.SetKey",b)},o.prototype.SetKeyFull=function(a){var b=this.cursor.getPosition(),c=this.checkRange();b.firstMeasureIdx=c.min,b.lastMeasureIdx=c.max,b.concertKey={fifths:a},this.do("action.SetKeyColumn",b)},o.prototype.SetTime=function(a,b){var c=this.cursor.getPosition(),d=this.checkRange();angular.equals(a,b)?(c.startMeasureIdx=d.min,c.stopMeasureIdx=d.max):null===this.rangeSelect.firstPos?(c.startMeasureIdx=this.cursor.getPosition().measureIdx,c.stopMeasureIdx=this.cursor.getPosition().measureIdx):(c.startMeasureIdx=d.min,c.stopMeasureIdx=d.max),c.timeSignature=a,c.displayedTime=b,this.do("action.SetTimeSignature",c)},o.prototype.changeDuration=function(a,b){var c=this.cursor.getPosition();c.insertMode=this.insertMode,c.durationType=a,c.nbDots=0,c.formatRests=!0,"undefined"!=typeof c.graceIdx?this.do("action.ChangeGraceDuration",c,b):"classic"===this.currentStyle?this.do("action.ChangeDurationCrossMeasure",c,b):this.do("action.ChangeDurationFormat",c,b),this.audio.playNote(this.dataReader.convertVoiceIdx(c))},o.prototype.AddMeasure=function(a,b){var c=this.cursor.getPosition();a||(c.measureIdx+=1),b&&(c.callback=b),this.do("action.AddMeasure",c)},o.prototype.RemoveMeasure=function(){var a=this.cursor.getPosition();this.do("action.RemoveOrClearMeasure",a)},o.prototype.validateLine=function(a){if("undefined"!=typeof a.string){if(a.string<0&&a.string>5)return a.string=0,!0}else if("undefined"!=typeof a.line){if(this.noteInfo.isRest)return delete a.line,!0;if(null===this.getNoteAtLine(a.line))return a.line=this.noteInfo.lines[0],!0}else if(this.noteInfo.lines)return a.line=this.noteInfo.lines[0],!0;return!1},o.prototype.getNoteInfo=function(){var a=this.cursor.getPosition();this.dataReader.validateData(a)&&this.cursor.setPos(a),a.isConcertPitch=this.config.get().isConcertPitch;try{this.noteInfo=this.data.getNoteData(this.dataReader.convertVoiceIdx(a)),this.posLeft=this.dataReader.getLeftPos(a),this.noteInfoLeft=this.data.getNoteData(this.dataReader.convertVoiceIdx(this.posLeft))}catch(c){c.pos=a,c.measure=JSON.stringify(this.data.getMeasure(a.partIdx,a.measureIdx,a.staffIdx)),b.error(c)}null!==a.graceIdx&&a.graceIdx>=0&&this.noteInfo.nbGraces>0&&a.graceIdx<this.noteInfo.nbGraces&&(this.noteInfo=this.data.getGraceData(this.dataReader.convertVoiceIdx(a))),this.validateLine(a)&&this.cursor.setPos(a),this.checkStyle(a),this.setMIDIInstrumentId(a)},o.prototype.getMeasureInfo=function(){var a=this.cursor.getPosition();return this.measureInfo=this.data.getStaffMeasure(a),this.measureInfo},o.prototype.setMode=function(a){this.mode=a},o.prototype.do=function(c,d){if(this.rightsHandler.categoryState.score_write||"action.SetTempo"===c){d=d||{},d.actionOrigin=d.actionOrigin||"local.do";var e=d.callback||function(){};"local.undo"!==d.actionOrigin&&"local.redo"!==d.actionOrigin&&i.resetRedo(),"string"==typeof c&&(c=[{name:c,opts:d}],delete d.callback);var h=d.redo?i.redoStack:i.localStack,j=h;(c.length>1||d.subStackName)&&(h=h.createSubstack(d.subStackName||"substack")),this.d("%s actions to do",c.length);var k,l,m;try{for(m=0;m<c.length;m++){k=c[m];var n=k.name,o=k.opts;if("undefined"==typeof o.voiceIdx||d.midi||(o=this.dataReader.convertVoiceIdx(o)),this.data&&this.data[n]){o.actionOrigin=d.actionOrigin,"undefined"!=typeof Raven&&Raven.captureBreadcrumb({category:"interact.do",message:n,data:{opts:JSON.stringify(o)}}),o.logs=[{date:new Date,context:d.actionOrigin,user:a.account.id,revision:a.history&&a.history.masterRevision,editorSid:a.editorSid,dataSid:this.data.getDataUuid()}],l=angular.copy(o),this.d("do: action %s %o",n,o);var p=this.data[n](o,h);this.d("do: adagio generated %s actions",p.length),p&&p.length>0&&(this.rt||a.scoreEmbedded?this.rt&&this.rt.bulkEdit(p):a.addErrors("flat:realtime.error.not-defined"))}else this.d("do: executing offline: %s",n),this.score.adagioData[n](o);r[n]&&f.add(r[n])}i.drawQueue.push(j.getLast()),this.err=!1,this.setLastNoteAdded(void 0),this.getNoteInfo(),window.requestAnimationFrame(a.$broadcast.bind(a,"Interaction.Updated",h,e)),"undefined"!=typeof embedMode&&a.$broadcast("Interaction.do",c)}catch(f){var q=function(){var a=angular.copy(c).slice(m<11?0:m-10,m+1);
b.error(f,{logger:"editor:do",tags:{"do:actionOrigin":d.actionOrigin,"do:subStackName":d.subStackName,"adagio:name":k.name},extra:{"err:original":f,"context:called":"Interaction.do","adagio:name":k.name,"adagio:opts":l,"do:options":d,"do:actions":a}})};return f instanceof Adagio.Error.client.ClientError||f instanceof Adagio.Error.value.ValueError?(this.err=!0,d.mute||g.broadcast(f.message,{color:"warning"}),"local.undo"!==d.actionOrigin&&"local.redo"!==d.actionOrigin||(q(),a.$broadcast("Editor.RedrawScore"))):(q(),a.$broadcast("Editor.RedrawScore")),f&&d.onErrorUndoSubstack&&this.undo(),e(f)}}},o.prototype.isNoError=function(){return this.err},o.prototype.undo=function(){var a=i.localStack.getLast();if(a){var b=Adagio.undo.safe.getReverseActionData(a);this.do(b,{actionOrigin:"local.undo",subStackName:"undo",mute:!0,redo:!0,callback:function(a){a&&(i.resetLocal(),i.resetRedo())}}),i.localStack.stack.pop()}f.add("editor.undo")},o.prototype.redo=function(){var a=i.redoStack.getLast();if(a){var b=Adagio.undo.safe.getReverseActionData(a);this.do(b,{actionOrigin:"local.redo",subStackName:"redo",mute:!0,callback:function(a){a&&(i.resetLocal(),i.resetRedo())}}),i.redoStack.stack.pop()}f.add("editor.undo")},o.prototype.toggleLyricsMode=function(){"lyrics"===this.submode?this.submode=null:this.submode="lyrics"},o.prototype.AddLyrics=function(a,b,c,d){var e=this.cursor.getPosition();e.lyric=a,e.level=b,e.hasRightConnection=c,e.callback=d,this.do("action.AddLyric",e)},o.prototype.RemoveLyrics=function(a,b){var c=this.cursor.getPosition();c.level=a,c.callback=b,this.do("action.RemoveLyric",c)},o.prototype.toggleAnnotationMode=function(){"annotation"===this.submode?this.submode=null:this.submode="annotation"},o.prototype.AddAnnotation=function(a,b,c,d){"undefined"==typeof c.partIdx&&(c=this.cursor.getPosition()),c.placement=b,c.text=a,c.callback=d,this.do("action.AddWordAtNote",c)},o.prototype.AddAnnotationAtIdx=function(a,b,c,d){c.placement=b,c.text=a,c.callback=d,this.do("action.AddWordAtIdx",c)},o.prototype.RemoveAnnotation=function(a,b,c){"undefined"==typeof a.partIdx&&(a=this.cursor.getPosition()),a.wordIdx=b,a.callback=c,this.do("action.RemoveWordAtIdx",a)},o.prototype.toggleChordsMode=function(){"chords"===this.submode?this.submode=null:this.submode="chords"},o.prototype.AddHarmony=function(a,b,c){b.root=a.root,b.kind=a.kind,"undefined"!=typeof a.bass&&(b.bass=a.bass),b.degrees=a.degrees,b.isConcertPitch=this.config.get().isConcertPitch,c&&(b.callback=c),this.do("action.AddHarmonyAtNote",b)},o.prototype.AddHarmonyAtIdx=function(a,b,c){b.root=a.root,b.kind=a.kind,"undefined"!=typeof a.bass&&(b.bass=a.bass),b.degrees=a.degrees,b.isConcertPitch=this.config.get().isConcertPitch,c&&(b.callback=c),this.do("action.AddHarmonyAtIdx",b)},o.prototype.RemoveHarmony=function(a,b){"undefined"==typeof b&&(b=this.cursor.getPosition()),b.harmonyIdx=a,this.do("action.RemoveHarmony",b)},o.prototype.incFingering=function(){if(!this.noteInfo.isRest){var a,b=this.cursor.getPosition();"undefined"!=typeof b.string?(a=this.dataReader.getStringIdx(this.noteInfo,b.string),delete b.string):(a=this.dataReader.getNoteAtLine(this.noteInfo,b.line),delete b.line),b.pitch=this.noteInfo.pitches[a];var c=this.noteInfo.fingerings[a];c<5?this.AddFingering(c+1,b):this.RemoveFingering(b)}},o.prototype.AddFingering=function(a,b){"undefined"==typeof b&&(b=this.cursor.getPosition()),b.fingering=a,this.do("action.AddFingerings",b)},o.prototype.RemoveFingering=function(a){"undefined"==typeof a&&(a=this.cursor.getPosition()),this.do("action.RemoveFingerings",a)},o.prototype.AddRehearsal=function(){var a=this.cursor.getPosition();this.do("action.AddRehearsalWithUpdate",a)},o.prototype.RemoveRehearsal=function(){var a=this.cursor.getPosition();this.do("action.RemoveRehearsalWithUpdate",a)},o.prototype.AddRehearsalNumber=function(){var a=this.cursor.getPosition();this.do("action.AddRehearsalMeasureNumber",a)},o.prototype.RemoveRehearsalNumber=function(){var a=this.cursor.getPosition();this.do("action.RemoveRehearsalMain",a)},o.prototype.increasePitch=function(a){var b=this.cursor.getPosition();b.isConcertPitch=this.config.get().isConcertPitch;var c=this.getNoteAtLine(b.line);b.pitch=this.noteInfo.pitches[c],b.mute=!0,a?"undefined"==typeof b.graceIdx?this.do("action.ShiftHalfToneUp",b):this.do("action.ShiftGraceHalfToneUp",b):"undefined"==typeof b.graceIdx?this.do("action.ShiftDiatonicUp",b):this.do("action.ShiftGraceDiatonicUp",b);var d=this.cursor.getPosition();this.err&&c<this.noteInfo.lines.length-1&&(c+=1),d.line=this.noteInfo.lines[c],this.changeCursor(d),this.audio.playNote(this.dataReader.convertVoiceIdx(this.cursor.getPosition()))},o.prototype.decreasePitch=function(a){var b=this.cursor.getPosition();b.isConcertPitch=this.config.get().isConcertPitch;var c=this.getNoteAtLine(b.line);b.pitch=this.noteInfo.pitches[c],b.mute=!0,a?"undefined"==typeof b.graceIdx?this.do("action.ShiftHalfToneDown",b):this.do("action.ShiftGraceHalfToneDown",b):"undefined"==typeof b.graceIdx?this.do("action.ShiftDiatonicDown",b):this.do("action.ShiftGraceDiatonicDown",b),this.err&&c>0&&c--;var d=this.cursor.getPosition();d.line=this.noteInfo.lines[c],this.changeCursor(d),this.audio.playNote(this.dataReader.convertVoiceIdx(this.cursor.getPosition()))},o.prototype.increaseChord=function(a){var b=this.cursor.getPosition();a?this.do("action.ShiftChordHalfToneUp",b):this.do("action.ShiftChordDiatonicUp",b)},o.prototype.decreaseChord=function(a){var b=this.cursor.getPosition();a?this.do("action.ShiftChordHalfToneDown",b):this.do("action.ShiftChordDiatonicDown",b)},o.prototype.increaseRange=function(a){var b=this.rangeSelect.getRange();b.direction=Adagio.edit.values.PitchShiftDirection.UP,b.preserveTies=!0,b.updateGraces=!0,a?this.do("action.ShiftStaffRangeHalfTone",b):this.do("action.ShiftStaffRangeDiatonic",b)},o.prototype.decreaseRange=function(a){var b=this.rangeSelect.getRange();b.direction=Adagio.edit.values.PitchShiftDirection.DOWN,b.preserveTies=!0,b.updateGraces=!0,a?this.do("action.ShiftStaffRangeHalfTone",b):this.do("action.ShiftStaffRangeDiatonic",b)},o.prototype.increaseFret=function(){var a=this.cursor.getPosition();if(a.isConcertPitch=this.config.get().isConcertPitch,this.noteInfo.tabsData){"undefined"==typeof a.string&&(a.string=this.noteInfo.tabsData[0].string);var b=this.getTabsAtString(a.string);b&&(b=b.fret,a.fromFretData={fret:b,string:a.string},a.toFretData={fret:b+1,string:a.string},this.do("action.ChangeFret",a),this.audio.playNote(this.dataReader.convertVoiceIdx(this.cursor.getPosition())))}},o.prototype.decreaseFret=function(){var a=this.cursor.getPosition();if(a.isConcertPitch=this.config.get().isConcertPitch,this.noteInfo.tabsData){var b=this.getTabsAtString(a.string);b&&(b=b.fret,a.fromFretData={fret:b,string:a.string},a.toFretData={fret:b-1,string:a.string},this.do("action.ChangeFret",a),this.audio.playNote(this.dataReader.convertVoiceIdx(this.cursor.getPosition())))}},o.prototype.changeFret=function(a){var b=this.cursor.getPosition();b.isConcertPitch=this.config.get().isConcertPitch;var c;c=this.getTabsAtString(b.string).fret,b.fromFretData={fret:c,string:b.string},b.toFretData={fret:a,string:b.string},this.do("action.ChangeFret",b)},o.prototype.setDuration=function(a){this.duration=a},o.prototype.goLeftMeasure=function(){var a=this.cursor.getPosition();a=this.dataReader.getNextLeftMeasure(),this.changeCursor(a)},o.prototype.goRightMeasure=function(a){var b=this.cursor.getPosition(),c=this.dataReader.getNbMeasures();a&&b.measureIdx+1>=c&&this.AddMeasure(),b=this.dataReader.getNextRightMeasure(b),this.changeCursor(b)},o.prototype.goLeft=function(a){var b=this.cursor.getPosition();b=this.dataReader.getLeftGracePos(b),this.changeCursor(b),a||this.audio.playNote(this.dataReader.convertVoiceIdx(b))},o.prototype.goRight=function(a,b,c){var d,e=this.cursor.getPosition(),f=this.dataReader.getNbNotes(e),g=this.dataReader.getNbMeasures(),h=function(){e=this.dataReader.getRightGraceNotePos(e),this.changeCursor(e),a||this.audio.playNote(this.dataReader.convertVoiceIdx(e)),c&&c()}.bind(this);b&&e.noteIdx+1>=f&&e.measureIdx+1>=g?(this.lastNoteAdded&&(d=this.lastNoteAdded),this.AddMeasure(!1,h),d&&(this.lastNoteAdded=d)):h()},o.prototype.goUp=function(a){var b=this.cursor.getPosition();b=this.dataReader.getUpNextNote(b),this.changeCursor(b),a&&this.audio.playNote(this.dataReader.convertVoiceIdx(b))},o.prototype.goDown=function(a){var b=this.cursor.getPosition();b=this.dataReader.getDownNextNote(b),this.changeCursor(b),a&&this.audio.playNote(this.dataReader.convertVoiceIdx(b))},o.prototype.adaptDuration=function(){null!==this.duration&&this.noteInfo.isRest&&this.noteInfo.durationType!==this.duration?this.changeDuration(this.duration,!0):null===this.duration||this.noteInfo.isRest||(this.duration=null)},o.prototype.lookupInsertRest=function(){var a=this.noteInfo.durationType;this.InsertRest(a)},o.prototype.InsertRest=function(a){var b=this.cursor.getPosition();b.durationType=a,b.nbDots=0,this.do("action.InsertRest",b)};var s;try{s=c.get("PersistenceService")}catch(a){}return o.prototype.blocCopy=function(){var a=this.rangeSelect.getRange();if(null!==a&&s){var b=this.data.getStaffContentCrossMeasure(a);s.buffer.clear().then(function(){s.buffer.put(b)}.bind(this)),f.add("editor.copy")}},o.prototype.blocCut=function(){var a=this.rangeSelect.getRange();null!==a&&s&&(this.blocCopy(),this.clearRange(a),f.add("editor.cut"))},o.prototype.clearRange=function(a){this.do("action.ClearStaffContentCrossMeasure",a)},o.prototype.paste=function(){s.buffer.query().then(function(a){if(a[0]){var b=this.cursor.getPosition();b.data=a[0],this.pasteAction(b),f.add("editor.paste")}}.bind(this))},o.prototype.pasteAction=function(a){if(a.addVoice=!0,this.do("action.InsertStaffContentCrossMeasureAtIdx",a),!this.err){var b=i.localStack.getPosition();if(!b)return;var c=this.cursor.getPosition();c.measureIdx=b.measureIdx,c.noteIdx=b.noteIdx,this.changeCursor(c)}},o.prototype.IntervalTranspose=function(a){a.preserveTies=!0,a.updateGraces=!0,"undefined"!=typeof a.voiceIdx?this.do("action.TransposeVoiceRange",a):this.do("action.TransposeStaffRange",a)},o.prototype.AddPizzicato=function(a,b,c){c||(c=this.cursor.getPosition()),c.type=a,c.placement=b,this.do("action.AddPizzicatoAtNote",c)},o.prototype.RemovePizzicato=function(a,b){b||(b=this.cursor.getPosition()),b.pizzicatoIdx=a,this.do("action.RemovePizzicatoAtIdx",b)},o.prototype.lookupPedal=function(a,b,c){return this.noteInfo.pedal?this.RemovePedal():("undefined"==typeof b&&(b=this.getMeasureStartStop()),this.AddPedal(a,b,c))},o.prototype.AddPedal=function(a,b,c){c||(c=this.cursor.getPosition()),c.startMeasureIdx=b.startMeasureIdx,c.stopMeasureIdx=b.stopMeasureIdx,c.startNoteIdx=b.startNoteIdx,c.startVoiceIdx=b.startVoiceIdx,c.stopVoiceIdx=b.stopVoiceIdx,c.stopNoteIdx=b.stopNoteIdx,c.placement=a,this.do("action.AddPedal",c)},o.prototype.RemovePedal=function(a){a||(a=this.cursor.getPosition()),this.do("action.RemovePedal",a)},o.prototype.AddTuplet=function(a){var b=this.cursor.getPosition();b.tupletType=a,this.do("action.AddTuplet",b)},o.prototype.RemoveTuplet=function(){var a=this.cursor.getPosition();this.do("action.RemoveTuplet",a)},o.prototype.lookUpSlurs=function(){if(this.noteInfo.isInSlur)this.RemoveSlurs();else{var a=this.cursor.getPosition();a.callback=function(){this.err||this.bindSlurs()}.bind(this),this.AddSlurs(a)}},o.prototype.AddSlurs=function(a,b){if("undefined"==typeof a.stopNoteIdx){var c=this.data.getSlurPossibleRightSide(this.dataReader.convertVoiceIdx(a));if(null===c)return void g.broadcast("There is no right note to slur to",{color:"warning"});a.startMeasureIdx=a.measureIdx,a.startNoteIdx=a.noteIdx,a.stopNoteIdx=c.noteIdx,a.stopMeasureIdx=c.measureIdx}return b!==!0&&this.do("action.AddSlur",a),a},o.prototype.ChangeSlurs=function(a,b,c){var d=this.cursor.getPosition();c?(d.oldMeasureIdx=b.posRight.measureIdx,d.oldNoteIdx=b.posRight.noteIdx,d.newMeasureIdx=a.stopMeasureIdx,d.newNoteIdx=a.stopNoteIdx):(d.oldMeasureIdx=b.posLeft.measureIdx,d.oldNoteIdx=b.posLeft.noteIdx,d.newMeasureIdx=a.startMeasureIdx,d.newNoteIdx=a.startNoteIdx),this.do("action.MoveSlurSide",d)},o.prototype.bindSlurs=function(){var a=this.cursor.getNote(),b=a.staff;if(this.svgTools.isTab(a.staff)){var c=a.sys;b=this.svgTools.getElementsByClassName(c,"staff")[0]}var d=this.svgTools.getElementsByClassName(b,"slur"),e=this.svgTools.getBBox(a.note),f=this.svgTools.getCoord(a.note),g=f.relative.x,h=f.relative.y,i={clientX:g+e.width/2+e.x,clientY:h+e.height/2+e.y};d=this.svgTools.getCloserElem(i,d),d&&this.selected.select(d,this.cursor.getPosition(),this.selected.color)},o.prototype.RemoveSlurs=function(a){a||(a=this.cursor.getPosition()),this.do("action.RemoveSlur",a)},o.prototype.changeNoteHead=function(a){var b=this.cursor.getPosition();return b.isConcertPitch=this.config.get().isConcertPitch,this.noteInfo.isRest?g.broadcast("Action can't be done on a rest. Add a note first",{color:"warning"}):("undefined"==typeof b.line&&(b.line=this.noteInfo.lines[0]),b.notehead=a,void("undefined"!=typeof b.graceIdx?this.do("action.ChangeGraceHeadPercu",b):this.do("action.ChangeHeadPercu",b)))},o.prototype.getStyleAvailable=function(){if(this.noteInfo.isRest)return g.broadcast("Action can't be done on a rest. Add a note first",{color:"warning"});var a=this.cursor.getPosition();return"undefined"==typeof a.line&&(a.line=this.noteInfo.lines[0]),Adagio.Utils.drumSet5Utils.getHeadsForLine(a)},o.prototype.insertGrace=function(){if(this.noteInfo.isRest)return g.broadcast("Action can't be done on a rest. Add a note first",{color:"warning"});var a=this.cursor.getPosition();a.isConcertPitch=this.config.get().isConcertPitch,a.durationType=Adagio.Values.DurationType.EIGHT,"undefined"==typeof a.line&&(a.line=this.noteInfo.lines[0]),a.accidental=this.noteInfo.accidentals[this.noteInfo.lines.indexOf(a.line)],a.graceIdx=0,"drum"===this.currentStyle?(a.notehead=this.noteInfo.noteheads[this.noteInfo.lines.indexOf(a.line)],this.do("action.InsertGraceNotePercu",a)):this.do("action.InsertGraceNote",a)},o.prototype.insertSlashGrace=function(){if(this.noteInfo.isRest)return g.broadcast("Action can't be done on a rest. Add a note first",{color:"warning"});var a=this.cursor.getPosition();a.isConcertPitch=this.config.get().isConcertPitch,a.durationType=Adagio.Values.DurationType.EIGHT,"undefined"==typeof a.line&&(a.line=this.noteInfo.lines[0]),a.accidental=this.noteInfo.accidentals[this.noteInfo.lines.indexOf(a.line)],a.graceIdx=0,"drum"===this.currentStyle?(a.notehead=this.noteInfo.noteheads[this.noteInfo.lines.indexOf(a.line)],this.do("action.InsertSlashedGraceNotePercu",a)):this.do("action.InsertSlashedGraceNote",a)},o.prototype.AddJumpTag=function(a){var b=this.cursor.getPosition();b.type=a,this.do("action.AddJumpTag",b)},o.prototype.AddJumpCall=function(a){var b=this.cursor.getPosition();b.type=a,this.do("action.AddJumpCall",b)},o.prototype.RemoveJumpTag=function(){var a=this.cursor.getPosition();this.do("action.RemoveJumpTag",a)},o.prototype.RemoveJumpCall=function(){var a=this.cursor.getPosition();this.do("action.RemoveJumpCall",a)},o.prototype.changeVoice=function(a){var b=this.cursor.getPosition();this.data.hasPartStaffVoiceAtIdx(b.partIdx,b.staffIdx,a)||this.addVoice(b,a),this.voiceIdx=a,b.voiceIdx=a,this.changeCursor(b)},o.prototype.addVoice=function(a,b){delete a.voiceIdx,a.idxInStaff=b,this.do("action.AddVoices",a)},o.prototype.deleteVoice=function(){var a=this.cursor.getPosition();a.voiceIdx=this.voiceIdx;var b=this.rangeSelect.getRange();if(null!==b)for(var c=b.startMeasureIdx;c<b.stopMeasureIdx;c++)a.measureIdx=c,this.data.hasMeasureVoice(this.dataReader.convertVoiceIdx(a))&&this.data.getMeasureStaffNbDisplayedVoices(a)>1&&this.removeVoice(a);else this.data.hasMeasureVoice(this.dataReader.convertVoiceIdx(a))&&this.data.getMeasureStaffNbDisplayedVoices(a)>1&&this.removeVoice(a);a=this.cursor.getPosition(),a.voiceIdx=0,this.changeCursor(a)},o.prototype.removeVoice=function(a){this.do("action.HideMeasureVoices",a),this.voiceIdx=0},o.prototype.switchScoreLayout=function(b){this.audio.playing&&this.audio.stop(),a.$broadcast("Editor.SwitchScoreLayout",b||("page"===a.scoreLayout?"track":"page")),f.add("editor.switch-layout")},o.prototype.zoomReset=function(){this.zoom=1,this.d("zoom: %s",this.zoom),e.set("score-view.zoom",this.zoom),a.$broadcast("ScoreScaling.Updated")},o.prototype.setZoomValue=function(b){return b=parseFloat(b),!isNaN(b)&&b>=q&&b<=p&&(this.zoom=Math.round(100*b)/100,this.zoomAuto=!1,this.d("zoom: %s",this.zoom),e.set("score-view.zoom",this.zoom),a.$broadcast("ScoreScaling.Updated")),this.zoom},o.prototype.zoomIn=function(b){b=b||.1,this.zoom<p&&(this.zoom=Math.min(p,Math.round(100*(this.zoom+b))/100),this.zoomAuto=!1,this.d("zoom: %s",this.zoom),e.set("score-view.zoom",this.zoom),a.$broadcast("ScoreScaling.Updated"))},o.prototype.zoomOut=function(b){b=b||.1,this.zoom>q&&(this.zoom=Math.max(q,Math.round(100*(this.zoom-b))/100),this.zoomAuto=!1,this.d("zoom: %s",this.zoom),e.set("score-view.zoom",this.zoom),a.$broadcast("ScoreScaling.Updated"))},o.prototype.save=function(){this.rt.save({manually:!0})},o.prototype.setRealtime=function(a){this.rt=a},o.prototype.export=function(a){this.openModal("export",{format:a,rt:this.rt})},o.prototype.print=function(a){this.openModal("export",{printing:!0,format:"pdf",allParts:a,rt:this.rt})},o.prototype.layout=function(){this.openModal("layout",{rt:this.rt})},o.prototype.submissions=function(){this.openMenu("submissions")},o.prototype.studentSubmit=function(){if(a.ltiRequest){a.displayLoader=!0;var b=c.get("LtiHelpers");b.outcomesStudent(this.score).then(function(){a.displayLoader=!1,g.broadcast(i18n.t("Your work has been submitted and attached to your assignment."),{color:"success"}),a.ltiRequest.launch_presentation_return_url&&(window.location=a.ltiRequest.launch_presentation_return_url)}).catch(function(b){a.displayLoader=!1,a.displayErrors(b,null,!0)})}else this.openMenu("assignment",{turnin:!0})},o.prototype.volume=function(){this.openModal("volume",{audio:this.audio})},o.prototype.toggleMetronome=function(){this.audio.toggleMetronome(),f.add("editor.metronome"),this.focusKeyboard()},o.prototype.tbLoaded=function(){if(this.data){var a=this.cursor.getPosition();this.changeCursor(a)}},o.prototype.isNotRest=function(a){this.noteInfo.isRest||("string"==typeof a?this[a]():a.apply(this))},o.prototype.removeElem=function(a){var b=this.rangeSelect.getRange();if(null!==b)this.clearRange(b);else{if(!this.selected)return;this.selected.isSelected()?this.selected.remove(a):this.lookupEraseRest(a)}},o.prototype.lookupEraseRest=function(a){this.noteInfo.isRest?this.RemoveRest():this.RemoveNote(),this.noteInfo.isRest&&a&&this.goLeft()},o.prototype.isRest=function(a){this.noteInfo.isRest&&("string"==typeof a?this[a]():a.apply(this))},o.prototype.isNoRest=function(a){this.noteInfo.isRest||("string"==typeof a?this[a]():a.apply(this))},o.prototype.goBeginning=function(){var a=this.cursor.getPosition();a.line&&delete a.line,a.measureIdx=0,a.noteIdx=0,this.changeCursor(a),this.audio.playing&&this.audio.restart(),this.focusKeyboard()},o.prototype.focusKeyboard=function(){if("undefined"==typeof embedMode||"edit"===embedMode){var a=window.scrollX,b=window.scrollY,c=document.getElementsByClassName("global-editor");c.length>0&&c[0].focus(),window.scrollTo(a,b)}},o.prototype.openModal=function(b,c){return"transpose"===b&&this.data.isPartTab(this.cursor.getPosition().partIdx)?void g.broadcast("You can't tranpose a Tab",{color:"warning"}):(c=c||{},c.score=this.score,c.rt=this.rt,c.interaction=this,c.audio=this.audio,void(a.loadModal&&a.loadModal("editor",b,c)))},o.prototype.openMenu=function(b,c){c=c||{},c.name=b,c.interaction=this,a.$broadcast("Menu.Display",c)},o.prototype.changeStyle=function(a){this.currentStyle=a},o.prototype.checkRange=function(){var a=this.rangeSelect.getRange();return null===a?{min:this.cursor.getPosition().measureIdx,max:this.dataReader.getNbMeasures()-1}:{min:a.startMeasureIdx,max:a.stopMeasureIdx}},o.prototype.getTabsAtString=function(a){if(this.noteInfo.tabsData&&"undefined"!=typeof a)for(var b=0;b<this.noteInfo.tabsData.length;b++)if(this.noteInfo.tabsData[b]&&this.noteInfo.tabsData[b].string===a)return this.noteInfo.tabsData[b];return null},o.prototype.getNoteAtLine=function(a){if(!this.noteInfo.isRest&&"undefined"!=typeof a)for(var b=0;b<this.noteInfo.lines.length;b++)if(this.noteInfo.lines[b]===a)return b;return null},o.prototype.getPitchAtLine=function(a){if(!this.noteInfo.isRest&&"undefined"!=typeof a)for(var b=0;b<this.noteInfo.lines.length;b++)if(this.noteInfo.lines[b]===a)return this.noteInfo.pitches[b];return null},o.prototype.getHigherString=function(){for(var a=-1,b=0;b<this.noteInfo.tabsData.length;b++)this.noteInfo.tabsData[b]&&a<this.noteInfo.tabsData[b].string&&(a=this.noteInfo.tabsData[b].string);return a},o.prototype.getCloserString=function(a,b){for(var c,d,e=6,f=0;f<this.noteInfo.tabsData.length;f++)this.noteInfo.tabsData[f]&&(d=b?a-this.noteInfo.tabsData[f].string:this.noteInfo.tabsData[f].string-a,e>d&&d>0&&(c=f,e=d));return"undefined"!=typeof c?this.noteInfo.tabsData[c].string:a},o.prototype.toggleConcertPitch=function(){this.config.set("isConcertPitch",!this.config.get().isConcertPitch),a.$broadcast("Editor.RedrawScore")},o.prototype.getCursorPosition=function(){return this.cursor.getPosition()},o.prototype.SwitchEnharmonic=function(){if(!this.noteInfo.isRest){var a=this.cursor.getPosition();a.line||(a.line=this.noteInfo.lines[0]);var b=this.getNoteAtLine(a.line);a.pitch=this.noteInfo.pitches[b],a.isConcertPitch=this.config.get().isConcertPitch,this.do("action.SwitchEnharmonic",a)}},o.prototype.canTrySwitchEnharmonic=function(){var a=this.cursor.getPosition();if(!this.noteInfo.canTryEnharmonicSwitch||!this.noteInfo.canTryEnharmonicSwitch.length)return!0;a.line||(a.line=this.noteInfo.lines[0]);var b=this.getNoteAtLine(a.line);return!this.noteInfo.canTryEnharmonicSwitch[b]},o.prototype.openInlinePopover=function(){this.InlinePopOver=!this.InlinePopOver,this.InlinePopOver?$(".range-inline-comment-icon").addClass("active"):$(".range-inline-comment-icon").removeClass("active"),d(angular.noop)},o.prototype.closeInlinePopover=function(){this.InlinePopOver&&($(".range-inline-comment-icon").removeClass("active"),this.InlinePopOver=!1,this.focusKeyboard(),d(angular.noop))},o}]),angular.module("flat.editor.services").factory("flat.editor.services.RightsHandler",["_","$rootScope",function(a,b){var c="RightsHandler.",d={score_write:["score_write","online","rt.ready","current_revision"]},e={};a.each(d,function(b,c){a.each(b,function(a){e[a]||(e[a]=[]),e[a].push(c)})});var f=function(){this.values={},this.categoryState={},a.each(e,function(a,b){this.values[b]=!1}.bind(this)),a.each(d,function(a,b){this.categoryState[b]=!1}.bind(this))};return f.prototype.setValue=function(a,b){if("undefined"==typeof e[a])throw new Error("Unknown criteria "+a);var c=this.values[a];b!==c&&this._handleValueChange(a,!!b)},f.prototype._handleValueChange=function(d,f){this.values[d]=f,a.each(e[d],function(a){var d=this.categoryState[a],e=this.getCategoryRights(a);d!==e&&(this.categoryState[a]=e,b.$broadcast(c+a,e))}.bind(this))},f.prototype.getCategoryRights=function(b){if("undefined"==typeof d[b])throw new Error("Invalid category "+b);return a.every(d[b],function(a){return this.values[a]===!0}.bind(this))},f}]),angular.module("flat.editor.services").factory("flat.editor.services.Keyboard",["$rootScope","$timeout","Instruments","EditorShortcutsService","_",function(a,b,c,d,e){"use strict";function f(a){return e.defaults(a,{"downArrow,,ctrl":{fnc:"octaveShift",param:-1},"downArrow,,meta":{fnc:"octaveShift",param:-1},"upArrow,,ctrl":{fnc:"octaveShift",param:1},"upArrow,,meta":{fnc:"octaveShift",param:1},leftArrow:"goLeft",rightArrow:"goRight",upArrow:{fnc:"increase",param:!1},downArrow:{fnc:"decrease",param:!1},"upArrow,,shift":{fnc:"increase",param:!0},"downArrow,,shift":{fnc:"decrease",param:!0},backspace:{fnc:"remove",param:!0},delete:{fnc:"remove",param:!1},"leftArrow,,shift":"selectLeftNote","rightArrow,,shift":"selectRightNote","upArrow,,alt":"upperHead","downArrow,,alt":"lowerHead","KeyC,,ctrl":"copy","KeyC,,meta":"copy","KeyV,,ctrl":"paste","KeyV,,meta":"paste","KeyX,,ctrl":"cut","KeyX,,meta":"cut","KeyA,,ctrl":"selectAll","KeyA,,meta":"selectAll",Help:"switchKeyboard",Space:"play","Space,,shift":"restart",Dot:"addDot",Comma:"addTie",escape:"unSelectOrDefault","KeyS,,ctrl":"save","KeyS,,meta":"save","KeyP,,ctrl":"print","KeyP,,meta":"print","KeyP,,shift,,ctrl":"print","KeyP,,shift,,meta":"print","KeyZ,,meta":"undo","KeyZ,,ctrl":"undo","KeyY,,meta":"redo","KeyY,,ctrl":"redo","Digit0,,ctrl":"zoomReset","Digit0,,meta":"zoomReset","Equal,,ctrl":"zoomIn","Equal,,meta":"zoomIn","Minus,,ctrl":"zoomOut","Minus,,meta":"zoomOut",KeyA:{fnc:"addNote",param:"A"},KeyB:{fnc:"addNote",param:"B"},KeyC:{fnc:"addNote",param:"C"},KeyD:{fnc:"addNote",param:"D"},KeyE:{fnc:"addNote",param:"E"},KeyF:{fnc:"addNote",param:"F"},KeyG:{fnc:"addNote",param:"G"},KeyH:{fnc:"addNote",param:"H"},KeyJ:{fnc:"addNote",param:"J"},KeyK:{fnc:"addNote",param:"K"},KeyL:{fnc:"addNote",param:"L"},KeyM:{fnc:"addNote",param:"M"},KeyO:{fnc:"addNote",param:"O"},KeyP:{fnc:"addNote",param:"P"},KeyQ:{fnc:"addNote",param:"Q"},KeyT:{fnc:"addNote",param:"T"},KeyU:{fnc:"addNote",param:"U"},KeyV:{fnc:"addNote",param:"V"},KeyW:{fnc:"addNote",param:"W"},"KeyA,,shift":{fnc:"AddOnPreviousNote",param:"A"},"KeyB,,shift":{fnc:"AddOnPreviousNote",param:"B"},"KeyC,,shift":{fnc:"AddOnPreviousNote",param:"C"},"KeyD,,shift":{fnc:"AddOnPreviousNote",param:"D"},"KeyE,,shift":{fnc:"AddOnPreviousNote",param:"E"},"KeyF,,shift":{fnc:"AddOnPreviousNote",param:"F"},"KeyG,,shift":{fnc:"AddOnPreviousNote",param:"G"},"KeyH,,shift":{fnc:"AddOnPreviousNote",param:"H"},"KeyJ,,shift":{fnc:"AddOnPreviousNote",param:"J"},"KeyK,,shift":{fnc:"AddOnPreviousNote",param:"K"},"KeyL,,shift":{fnc:"AddOnPreviousNote",param:"L"},"KeyM,,shift":{fnc:"AddOnPreviousNote",param:"M"},"KeyO,,shift":{fnc:"AddOnPreviousNote",param:"O"},"KeyP,,shift":{fnc:"AddOnPreviousNote",param:"P"},"KeyQ,,shift":{fnc:"AddOnPreviousNote",param:"Q"},"KeyT,,shift":{fnc:"AddOnPreviousNote",param:"T"},"KeyU,,shift":{fnc:"AddOnPreviousNote",param:"U"},"KeyV,,shift":{fnc:"AddOnPreviousNote",param:"V"},"KeyW,,shift":{fnc:"AddOnPreviousNote",param:"W"},KeyS:"AddSlur",KeyR:"duplicate",Upper:{fnc:"addWedge",param:Adagio.Values.WedgeType.CRESCENDO},Lower:{fnc:"addWedge",param:Adagio.Values.WedgeType.DIMINUENDO},OpenBracket:{fnc:"addRepeat",param:{time:1,direction:"forward"}},CloseBracket:{fnc:"addRepeat",param:{time:1,direction:"backward"}},"Digit1,,ctrl":{fnc:"changeMode",param:"select"},"Digit2,,ctrl":{fnc:"changeMode",param:"note"},"Digit3,,ctrl":{fnc:"changeMode",param:"articulation"},"Digit4,,ctrl":{fnc:"changeMode",param:"ornaments"},"Digit5,,ctrl":{fnc:"changeMode",param:"dynamics"},"Digit6,,ctrl":{fnc:"changeMode",param:"measure"},"Digit7,,ctrl":{fnc:"changeMode",param:"text"},"Digit1,,meta":{fnc:"changeMode",param:"select"},"Digit2,,meta":{fnc:"changeMode",param:"note"},"Digit3,,meta":{fnc:"changeMode",param:"articulation"},"Digit4,,meta":{fnc:"changeMode",param:"ornaments"},"Digit5,,meta":{fnc:"changeMode",param:"dynamics"},"Digit6,,meta":{fnc:"changeMode",param:"measure"},"Digit7,,meta":{fnc:"changeMode",param:"text"},"Digit2,,alt":{fnc:"AddTuplet",param:j.DUPLET},"Digit3,,alt":{fnc:"AddTuplet",param:j.TRIPLET},"Digit4,,alt":{fnc:"AddTuplet",param:j.QUADRUPLET},"Digit5,,alt":{fnc:"AddTuplet",param:j.QUINTUPLET},"Digit6,,alt":{fnc:"AddTuplet",param:j.SEXTUPLET},"Digit7,,alt":{fnc:"AddTuplet",param:j.SEPTUPLET},"Digit9,,alt":{fnc:"AddTuplet",param:j.NONUPLET},Numpad7:{fnc:"changeDuration",param:h.SIXTY_FOURTH},Numpad6:{fnc:"changeDuration",param:h.THIRTY_SECOND},Numpad5:{fnc:"changeDuration",param:h.SIXTEENTH},Numpad4:{fnc:"changeDuration",param:h.EIGHT},Numpad3:{fnc:"changeDuration",param:h.QUARTER},Numpad2:{fnc:"changeDuration",param:h.HALF},Numpad1:{fnc:"changeDuration",param:h.FULL},NumpadDecimal:"addDot"})}function g(a){this.i=a,this.svgTools=a.svgTools,this.rangeSelect=a.rangeSelect}var h=Adagio.Values.DurationType,i=Adagio.Values.Notehead,j=Adagio.Values.TupletType,k={note:f({Digit1:{fnc:"changeDuration",param:h.FULL},Digit2:{fnc:"changeDuration",param:h.HALF},Digit3:{fnc:"changeDuration",param:h.QUARTER},Digit4:{fnc:"changeDuration",param:h.EIGHT},Digit5:{fnc:"changeDuration",param:h.SIXTEENTH},Digit6:{fnc:"changeDuration",param:h.THIRTY_SECOND},Digit7:{fnc:"changeDuration",param:h.SIXTY_FOURTH},"Digit2,,shift":{fnc:"addNoteInterval",param:2},"Digit3,,shift":{fnc:"addNoteInterval",param:3},"Digit4,,shift":{fnc:"addNoteInterval",param:4},"Digit5,,shift":{fnc:"addNoteInterval",param:5},"Digit6,,shift":{fnc:"addNoteInterval",param:6},"Digit7,,shift":{fnc:"addNoteInterval",param:7},Digit0:"addNatural",Minus:"addFlat",Equal:"addSharp","Equal,,shift":"addSharp",KeyI:"InsertRest"}),measure:f({1:"addMeasure",2:"removeMeasure"},void 0),select:f({Digit1:{fnc:"changeDuration",param:h.FULL},Digit2:{fnc:"changeDuration",param:h.HALF},Digit3:{fnc:"changeDuration",param:h.QUARTER},Digit4:{fnc:"changeDuration",param:h.EIGHT},Digit5:{fnc:"changeDuration",param:h.SIXTEENTH},Digit6:{fnc:"changeDuration",param:h.THIRTY_SECOND},Digit7:{fnc:"changeDuration",param:h.SIXTY_FOURTH}},void 0),dynamics:f({Digit1:{fnc:"addDynamics",param:"ppp"},Digit2:{fnc:"addDynamics",param:"pp"},Digit3:{fnc:"addDynamics",param:"p"},Digit4:{fnc:"addDynamics",param:"mp"},Digit5:{fnc:"addDynamics",param:"mf"},Digit6:{fnc:"addDynamics",param:"f"},Digit7:{fnc:"addDynamics",param:"ff"},Digit8:{fnc:"addDynamics",param:"fff"},Digit9:{fnc:"addDynamics",param:"sfz"},Digit0:{fnc:"addDynamics",param:"rfz"}},void 0),articulation:f({Digit1:{fnc:"AddArticulation",param:Adagio.Values.ArticulationType.STACCATO},Digit2:{fnc:"AddArticulation",param:Adagio.Values.ArticulationType.STACCATISSIMO},Digit3:{fnc:"AddArticulation",param:Adagio.Values.ArticulationType.TENUTO},Digit4:{fnc:"AddArticulation",param:Adagio.Values.ArticulationType.STRONG},Digit5:{fnc:"AddArticulation",param:Adagio.Values.ArticulationType.ACCENT},Digit6:{fnc:"AddNotation",param:Adagio.Values.NotationType.FERMATA},Digit7:{fnc:"AddTechnical",param:Adagio.Values.TechnicalType.UPBOW},Digit8:{fnc:"AddTechnical",param:Adagio.Values.TechnicalType.DOWNBOW}}),ornaments:f({Digit1:{fnc:"addOrnament",param:Adagio.Values.OrnamentType.TRILLMARK},Digit2:{fnc:"addOrnament",param:{value:Adagio.Values.OrnamentType.TREMOLO,opts:{nbBeam:3}}},Digit3:"addArpeggio",Digit4:{fnc:"addMordent",param:{value:Adagio.Values.OrnamentType.MORDENT,long:"no"}},Digit5:"addGlissando"}),none:f({}),text:f({}),tabs:f({upArrow:"upperString",downArrow:"lowerString",Digit1:{fnc:"changeFret",param:1},Digit2:{fnc:"changeFret",param:2},Digit3:{fnc:"changeFret",param:3},Digit4:{fnc:"changeFret",param:4},Digit5:{fnc:"changeFret",param:5},Digit6:{fnc:"changeFret",param:6},Digit7:{fnc:"changeFret",param:7},Digit8:{fnc:"changeFret",param:8},Digit9:{fnc:"changeFret",param:9},Digit0:{fnc:"changeFret",param:0},Numpad1:{fnc:"changeFret",param:1},Numpad2:{fnc:"changeFret",param:2},Numpad3:{fnc:"changeFret",param:3},Numpad4:{fnc:"changeFret",param:4},Numpad5:{fnc:"changeFret",param:5},Numpad6:{fnc:"changeFret",param:6},Numpad7:{fnc:"changeFret",param:7},Numpad8:{fnc:"changeFret",param:8},Numpad9:{fnc:"changeFret",param:9},Numpad0:{fnc:"changeFret",param:0},"Digit1,,shift":{fnc:"changeDuration",param:h.FULL},"Digit2,,shift":{fnc:"changeDuration",param:h.HALF},"Digit3,,shift":{fnc:"changeDuration",param:h.QUARTER},"Digit4,,shift":{fnc:"changeDuration",param:h.EIGHT},"Digit5,,shift":{fnc:"changeDuration",param:h.SIXTEENTH},"Digit6,,shift":{fnc:"changeDuration",param:h.THIRTY_SECOND},"Digit7,,shift":{fnc:"changeDuration",param:h.SIXTY_FOURTH}})},l={A:{line:3.5,head:i.NORMAL},T:{line:3.5,head:i.X},U:{line:3,head:i.NORMAL},D:{line:2.5,head:i.NORMAL},C:{line:4.5,head:i.NORMAL},Q:{line:4,head:i.NORMAL
},P:{line:2,head:i.NORMAL},B:{line:1.5,head:i.NORMAL},W:{line:5,head:i.NORMAL},F:{line:5.5,head:i.X},O:{line:4.5,head:i.X},M:{line:.5,head:i.X},E:{line:6,head:i.X},L:{line:6.5,head:i.X},G:{line:5,head:i.X},H:{line:5,head:i.DIAMOND},V:{line:7,head:i.X},J:{line:4,head:i.DIAMOND},K:{line:4.5,head:i.DIAMOND}},m={A:{line:4.5,head:i.NORMAL},B:{line:3.5,head:i.NORMAL},C:{line:2.5,head:i.NORMAL},D:{line:1,head:i.NORMAL},E:{line:.5,head:i.NORMAL},F:{line:0,head:i.SLASH},G:{line:5.5,head:i.X}},n={A:{line:5.5,head:i.TRIANGLE},B:{line:6.5,head:i.NORMAL},C:{line:6,head:i.NORMAL},D:{line:5.5,head:i.X},E:{line:5.5,head:i.NORMAL},F:{line:4.5,head:i.X},G:{line:4.5,head:i.NORMAL},H:{line:3.5,head:i.X},J:{line:3.5,head:i.NORMAL},K:{line:2.5,head:i.X},L:{line:2.5,head:i.NORMAL},M:{line:1.5,head:i.X},O:{line:1.5,head:i.NORMAL}},o={A:{line:2.5,head:i.X},B:{line:3,head:i.X},C:{line:3.5,head:i.X},D:{line:3,head:i.NORMAL}},p={A:{line:3,head:i.NORMAL},B:{line:3,head:i.BACK_SLASHED},C:{line:3,head:i.DIAMOND},D:{line:3.5,head:i.NORMAL},E:{line:3,head:i.X},F:{line:3.5,head:i.X}},q={A:{line:3.5,head:i.NORMAL},B:{line:2.5,head:i.NORMAL}},r={A:{line:3.5,head:i.X},B:{line:3,head:i.NORMAL},C:{line:2.5,head:i.NORMAL}},s={A:{line:3,head:i.NORMAL}},t={"drumset-1":l,"marching-bass-drums":m,"marching-tenor-drums":n,"marching-cymbals":o,"marching-snare-drums":p,bongos:q,congas:r},u={8:"backspace",9:"tab",13:"enter",27:"escape",32:"Space",37:"leftArrow",38:"upArrow",39:"rightArrow",40:"downArrow",46:"delete",48:"Digit0",49:"Digit1",50:"Digit2",51:"Digit3",52:"Digit4",53:"Digit5",54:"Digit6",55:"Digit7",56:"Digit8",57:"Digit9",65:"KeyA",66:"KeyB",67:"KeyC",68:"KeyD",69:"KeyE",70:"KeyF",71:"KeyG",72:"KeyH",73:"KeyI",74:"KeyJ",75:"KeyK",76:"KeyL",77:"KeyM",78:"KeyN",79:"KeyO",80:"KeyP",81:"KeyQ",82:"KeyR",83:"KeyS",84:"KeyT",85:"KeyU",86:"KeyV",87:"KeyW",88:"KeyX",89:"KeyY",90:"KeyZ",96:"Numpad0",97:"Numpad1",98:"Numpad2",99:"Numpad3",100:"Numpad4",101:"Numpad5",102:"Numpad6",103:"Numpad7",104:"Numpad8",105:"Numpad9",187:"Equal",188:"Comma",189:"Minus",190:"Dot",191:"Help",219:"OpenBracket",221:"CloseBracket",null:null},v={".":"Dot",",":"Comma","?":"Help",">":"Lower","<":"Upper","[":"OpenBracket","]":"CloseBracket"};g.prototype.keyDown=function(b){a.score&&this.checkMap(b)},g.prototype.resolveAction=function(a,b,c,d,e){var f;f=null===this.i.mode?k.none:"undefined"!=typeof this.i.cursor.getPosition().string?k.tabs:k[this.i.mode];var g,h;for(g in f)if(f.hasOwnProperty(g)&&(h=g.split(",,"),h.length>1&&h[0]===a))for(var i=1;i<h.length&&!("shift"===h[i]&&!b||"meta"===h[i]&&!d||"alt"===h[i]&&!c||"ctrl"===h[i]&&!e);i++)return f[g];for(g in f)if(f.hasOwnProperty(g)&&(h=g.split(",,"),!(1!==h.length||h[0]!==a||b||d||e||c)))return f[g]},g.prototype.checkMap=function(a){var b,c=a.shiftKey,d=a.altKey,e=a.metaKey,f=a.ctrlKey;if("undefined"!=typeof a.key&&"undefined"!=typeof v[a.key])b=v[a.key],c=d=e=f=!1;else{var g=a.keyCode;b=u[g]}var h=this.resolveAction(b,c,d,e,f);"undefined"!=typeof h&&("undefined"!=typeof Raven&&Raven.captureBreadcrumb({category:"keyboard",message:"string"==typeof h?h:JSON.stringify(h),data:{letter:b,shift:c||void 0,alt:d||void 0,meta:e||void 0,ctrl:f||void 0}}),(h="object"==typeof h?this[h.fnc].bind(this,h.param,a):this[h].bind(this,a))())},g.prototype.AddOnPreviousNote=function(a){if("classic"!==this.i.currentStyle)this.i.goLeft(!0),this.addNote(a);else if(a>="A"&&a<="G"){var b=this.i.dataReader.getLeftPos(this.i.cursor.getPosition());delete b.line,b.pitch={},b.pitch.step=a;var c=this.i.data.getPreviousRootPitch(this.i.dataReader.convertVoiceIdx(this.i.cursor.getPosition()));c.octave=parseInt(c.octave,10);var d=Adagio.Values.Step.getStepIdx(c.step),e=Adagio.Values.Step.getStepIdx(a);c.octave+=this.shiftOctave(e,d),b.pitch.octave=c.octave,b.nbDots=this.i.noteInfoLeft.nbDots,this.i.AddNote(this.i.noteInfoLeft.durationType,b)}},g.prototype.getDumsMapping=function(a){var b=c.identifyFromPart(this.i.data.getPartHeader(a.partIdx));return b&&b.instrument?t[b.instrument]||s:s},g.prototype.addNote=function(a){var b=this.i.cursor.getPosition(),c=this.i.duration?this.i.duration:this.i.noteInfo.durationType;if("undefined"!=typeof b.line&&delete b.line,"drum"===this.i.currentStyle){var d=this.getDumsMapping(b)[a];if("undefined"==typeof d)return;b.line=d.line,b.notehead=d.head}else{if("drum"!==this.i.currentStyle&&a>"G")return;b.pitch={},b.pitch.step=a;var e=this.i.data.getPreviousRootPitch(this.i.dataReader.convertVoiceIdx(b));e.octave=parseInt(e.octave,10);var f=Adagio.Values.Step.getStepIdx(e.step),g=Adagio.Values.Step.getStepIdx(a);if(e.octave+=this.shiftOctave(g,f),b.pitch.octave=e.octave,b.voiceIdx!==this.i.voiceIdx){var h=this.i.dataReader.convertVoiceIdx(b);b.voiceIdx=this.i.voiceIdx,b.voiceIdxRef=h.voiceIdx,b.noteIdxRef=h.noteIdx}}this.i.AddNote(c,b),this.i.err||("undefined"!=typeof b.voiceIdxRef&&(b.noteIdx=this.i.dataReader.data.refToNoteIdx(this.i.dataReader.convertVoiceIdx(b)),this.i.changeCursor(b)),this.i.goRight(!0,!0,function(){this.i.adaptDuration()}.bind(this)))},g.prototype.shiftOctave=function(a,b){return a>b?a-b>3.5?-1:0:b-a>3.5?1:0},g.prototype.addNatural=function(){this.i.lookUpNatural()},g.prototype.addFlat=function(){this.i.lookUpFlat()},g.prototype.addSharp=function(){this.i.lookUpSharp()},g.prototype.addDot=function(){var a=((this.i.noteInfo.nbDots||0)+1)%2;this.i.AddDotted(this.i.noteInfo.durationType,a),this.i.isNoError()||this.i.noteInfo.isRest||this.i.goRight()},g.prototype.changeVoice=function(){},g.prototype.addTie=function(){this.i.noteInfo.isTied?this.i.RemoveTie():this.i.AddTie(),this.i.goRight()},g.prototype.play=function(a){this.i.play(),a.preventDefault(),b(angular.noop)},g.prototype.restart=function(a){this.i.goBeginning(),a.preventDefault()},g.prototype.octaveShift=function(a,b){b.preventDefault();var c=this.rangeSelect.getRange();null===c?this.noteOctaveShift(a):this.octaveShiftRange(a,c)},g.prototype.octaveShiftRange=function(a,b){var c=this.i.cursor.getPosition(),d=b;d.startVoiceIdx=this.i.dataReader.convertVoiceIdx(c).voiceIdx,d.stopVoiceIdx=this.i.dataReader.convertVoiceIdx(c).voiceIdx,d.transpose={diatonic:0,chromatic:0,"octave-change":a},this.i.IntervalTranspose(d)},g.prototype.noteOctaveShift=function(a){if(!this.i.noteInfo.isRest){var b=this.i.cursor.getPosition(),c=this.i.dataReader.getNoteAtLine(this.i.noteInfo,b.line),d=this.i.noteInfo.pitches[c];d&&(b.fromPitch=angular.copy(d),a===-1?d.octave-=1:d.octave+=1,b.toPitch=d,this.i.changePitch(b))}},g.prototype.increase=function(b,c){if(!a.flat.modal){var d=this.rangeSelect.getRange();null===d?this.increasePitch(b):this.increaseRange(d,b),c.preventDefault()}},g.prototype.decrease=function(b,c){if(!a.flat.modal){var d=this.rangeSelect.getRange();null===d?this.decreasePitch(b):this.decreaseRange(d,b),c.preventDefault()}},g.prototype.increasePitch=function(a){"undefined"!=typeof this.i.cursor.getPosition().string||this.svgTools.isTab(this.i.cursor.getNote().staff)?this.i.increaseFret():this.i.noteInfo.isRest||"drum"===this.i.currentStyle||this.i.increasePitch(a)},g.prototype.increaseRange=function(a,b){a.startMeasureIdx===a.stopMeasureIdx&&a.startNoteIdx===a.stopNoteIdx?this.i.increaseChord(b):this.i.increaseRange(b)},g.prototype.decreaseRange=function(a,b){a.startMeasureIdx===a.stopMeasureIdx&&a.startNoteIdx===a.stopNoteIdx?this.i.decreaseChord(b):this.i.decreaseRange(b)},g.prototype.decreasePitch=function(a){"undefined"!=typeof this.i.cursor.getPosition().string?this.i.decreaseFret():this.i.noteInfo.isRest||"drum"===this.i.currentStyle||this.i.decreasePitch(a)},g.prototype.changeDuration=function(a){this.i.noteInfo.durationType!==a&&(this.i.setDuration(a),this.i.changeDuration(a),this.i.noteInfo.isRest||this.i.goRight())},g.prototype.goRight=function(a){this.i.setDuration(null),null!==this.rangeSelect.getRange()?(this.i.changeCursor(this.rangeSelect.secondPos),this.rangeSelect.reset()):this.i.goRight(),a.preventDefault()},g.prototype.goLeft=function(a){this.i.setDuration(null),null!==this.rangeSelect.getRange()?(this.i.changeCursor(this.rangeSelect.firstPos),this.rangeSelect.reset()):this.i.goLeft(),a.preventDefault()},g.prototype.addClef=function(a){this.i.AddClef(a)},g.prototype.remove=function(a,b){this.i.removeElem(a),b.preventDefault()},g.prototype.addRepeat=function(a){var b=this.i.getMeasureInfo();"forward"===a.direction&&b.leftBarline&&b.leftBarline.repeat||"backward"===a.direction&&b.rightBarline&&b.rightBarline.repeat?this.i.RemoveBarline(a):this.i.AddRepeat(a)},g.prototype.copy=function(){this.i.blocCopy()},g.prototype.cut=function(){this.i.blocCut()},g.prototype.paste=function(){this.i.paste()},g.prototype.openModal=function(a){this.i.openModal(a)},g.prototype.undo=function(){this.i.undo()},g.prototype.redo=function(a){this.i.redo(),a.preventDefault()},g.prototype.selectLeftNote=function(){var a=this.i.cursor.getPosition();null!==this.rangeSelect.getRange()&&(a=this.i.dataReader.getLeftPos(a)),this.rangeSelect.selectRange(a),this.rangeSelect.bindIcon(),this.i.changeCursor(a)},g.prototype.selectRightNote=function(){var a=this.i.cursor.getPosition();null!==this.rangeSelect.getRange()&&(a=this.i.dataReader.getRightNotePos(a)),this.rangeSelect.selectRange(a),this.rangeSelect.bindIcon(),this.i.changeCursor(a)},g.prototype.AddArticulation=function(a){this.i.noteInfo.articulations.indexOf(a)>=0?this.i.RemoveArticulation(a):this.i.AddArticulation(a),this.i.goRight(!0,!0)},g.prototype.AddArpeggio=function(){this.i.noteInfo.hasArpeggio?this.i.RemoveArpeggio():this.i.AddArpeggio(),this.i.goRight(!0,!0)},g.prototype.AddTechnical=function(a){this.i.noteInfo.technical.indexOf(a)>=0?this.i.RemoveTechnical(a):this.i.AddTechnical(a),this.i.goRight(!0,!0)},g.prototype.AddNotation=function(a){this.i.noteInfo.articulations.indexOf(a)>=0?this.i.RemoveNotation(a):this.i.AddNotation(a),this.i.goRight(!0,!0)},g.prototype.addWedge=function(a){var b=this.i.getMeasureStartStop();this.i.lookupWedge(a,"below",b)},g.prototype.removeWedge=function(){this.i.noteInfo.wedgeType&&this.i.RemoveWedge()},g.prototype.InsertRest=function(){this.i.lookupInsertRest()},g.prototype.addDynamics=function(a){this.i.noteInfo.dynamicStyle&&this.i.noteInfo.dynamicStyle===a?this.i.RemoveDynamics(this.i.noteInfo.dynamicIdx):this.i.AddDynamics(a,"below")},g.prototype.switchKeyboard=function(){this.i.openKeyboardShortcutsModal(),b(angular.noop)},g.prototype.AddSlur=function(){this.i.lookUpSlurs()},g.prototype.upperHead=function(a){if(a&&a.preventDefault(),!this.i.noteInfo.isRest){var b=this.i.cursor.getPosition();if("undefined"!=typeof b.line){var c=this.i.noteInfo.lines.indexOf(b.line);b.line=this.i.noteInfo.lines[c+1<this.i.noteInfo.lines.length?c+1:c]}else"undefined"!=typeof b.string?b.string=this.i.getCloserString(b.string,!0):(b.line=this.noteInfo.lines[0],delete b.string);this.i.changeCursor(b)}},g.prototype.lowerHead=function(a){if(a.preventDefault(),!this.i.noteInfo.isRest){var b=this.i.cursor.getPosition();if("undefined"!=typeof b.line){var c=this.i.noteInfo.lines.indexOf(b.line);b.line=this.i.noteInfo.lines[c-1>=0?c-1:c]}else"undefined"!=typeof b.string?b.string=this.i.getCloserString(b.string,!1):(b.line=this.noteInfo.lines[0],delete b.string);this.i.changeCursor(b)}},g.prototype.unSelectOrDefault=function(b){var c;a.flat.modal?a.hideModal():this.i.selected.isSelected()?this.i.selected.cleanUp():(c=this.rangeSelect.getRange())?this.rangeSelect.reset():"select"!==this.i.mode&&"text"!==this.i.mode&&this.changeMode("select",b)},g.prototype.selectAll=function(){this.rangeSelect.reset();var a=this.i.cursor.getPosition();a.noteIdx=0,a.measureIdx=0;var b=this.i.cursor.getPosition();b.measureIdx=this.i.dataReader.getNbMeasures()-1,b.noteIdx=this.i.dataReader.getNbNotes(b)-1,this.rangeSelect.selectRange(a),this.rangeSelect.selectRange(b)},g.prototype.print=function(a){this.i.print(!a.shiftKey),a.preventDefault()},g.prototype.save=function(a){this.i.save(),a.preventDefault()},g.prototype.zoomReset=function(){this.i.zoomReset()},g.prototype.zoomIn=function(a){this.i.zoomIn(),a.preventDefault()},g.prototype.zoomOut=function(a){this.i.zoomOut(),a.preventDefault()},g.prototype.changeMode=function(b,c){a.$broadcast("Toolbar.mode",b),c.preventDefault()},g.prototype.changeFret=function(a){var c;if(c=this.i.getTabsAtString(this.i.cursor.getPosition().string),null===c){var d=this.i.cursor.getPosition();return d.fretData={string:d.string,fret:a},b(function(){this.collapse=!1}.bind(this),500),a<3&&(this.collapse=!0),this.i.AddNote(this.i.noteInfo.durationType,d)}c=c.fret,c<3&&10*c+a<26&&this.collapse?a=10*c+a:this.collapse=!0,b(function(){this.collapse=!1}.bind(this),500),this.i.changeFret(a)},g.prototype.AddTuplet=function(a){this.i.AddTuplet(a)},g.prototype.duplicate=function(){var a=this.rangeSelect.getRange();null===a?this.i.noteInfo.isRest&&"note"===this.i.mode?(this.i.goLeft(),this.duplicatePrevious(),this.i.goRight()):this.duplicatePrevious():this.duplicateRange(a);var b=this.i.cursor.getPosition(),c=this.i.dataReader.getNbNotes(b),d=this.i.dataReader.getNbMeasures(b);c-1===b.noteIdx&&d-1===b.measureIdx&&this.i.AddMeasure()},g.prototype.duplicatePrevious=function(){var a=this.i.cursor.getPosition(),b={startMeasureIdx:a.measureIdx,startNoteIdx:a.noteIdx,stopMeasureIdx:a.measureIdx,startVoiceIdx:this.i.dataReader.convertVoiceIdx(a).voiceIdx,stopVoiceIdx:this.i.dataReader.convertVoiceIdx(a).voiceIdx,stopNoteIdx:a.noteIdx,staffIdx:a.staffIdx,partIdx:a.partIdx},c=this.i.dataReader.data.getStaffContentCrossMeasure(b);this.i.goRight(!0,!0),a=this.i.cursor.getPosition(),a.data=c,this.i.pasteAction(a),this.i.changeCursor(a)},g.prototype.duplicateRange=function(a){var b=this.i.dataReader.data.getStaffContentCrossMeasure(a),c=this.i.dataReader.getRightNotePos(this.i.cursor.getPosition()),d=angular.copy(c);c.data=b,this.i.pasteAction(c),this.rangeSelect.reset(),this.rangeSelect.selectRange(d),this.rangeSelect.selectRange(this.i.posLeft),this.i.changeCursor(this.i.posLeft)},g.prototype.lowerString=function(a){a.preventDefault();var b=this.i.cursor.getPosition(),c=Adagio.Utils.partContentUtils,d=Adagio.Utils.measureUtils,e=Adagio.Utils.attributesUtils,f=Adagio.Utils.staffDetailsUtils,g=this.i.dataReader.data.getPartContent(b.partIdx),h=c.getMeasure(g,0),i=d.getAttributes(h),j=e.getStaffDetails(i)[0],k=f.getStaffTunings(j),l=k.length;"undefined"==typeof b.string||b.string>=l?b.string=1:b.string++,this.i.changeCursor(b)},g.prototype.upperString=function(a){a.preventDefault();var b=this.i.cursor.getPosition(),c=Adagio.Utils.partContentUtils,d=Adagio.Utils.measureUtils,e=Adagio.Utils.attributesUtils,f=Adagio.Utils.staffDetailsUtils,g=this.i.dataReader.data.getPartContent(b.partIdx),h=c.getMeasure(g,0),i=d.getAttributes(h),j=e.getStaffDetails(i)[0],k=f.getStaffTunings(j),l=k.length;"undefined"==typeof b.string||b.string<=1?b.string=l:b.string--,this.i.changeCursor(b)},g.prototype.addMeasure=function(){this.i.AddMeasure()},g.prototype.removeMeasure=function(){this.i.RemoveMeasure()},g.prototype.addGlissando=function(){this.i.noteInfo.hasGlissando?this.i.RemoveGlissando():this.i.AddGlissando()},g.prototype.addArpeggio=function(){this.i.noteInfo.hasArpeggio?this.i.RemoveArpeggio():this.i.AddArpeggio()},g.prototype.addMordent=function(a){var b=angular.copy(a),c=b.value;delete b.value,this.i.AddOrnament(c,b)},g.prototype.addOrnament=function(a){var b=a.value||a,c=a.opts||{};this.hasOrnament(b)?this.i.RemoveOrnament(b):this.i.AddOrnament(b,c)},g.prototype.hasOrnament=function(a){for(var b in this.i.noteInfo.ornaments)if(a===b)return!0;return!1};var w=function(a,b){var c=Adagio.Utils.pitchUtils,d=Adagio.Utils.pitchLineUtils,e=d.pitchToAbsoluteLine(c,a);return e+=b/2,a=d.absoluteLineToPitch(c,e)};return g.prototype.addNoteInterval=function(a){var b,c,d;if("classic"===this.i.currentStyle){if(this.i.noteInfo.isRest&&!this.i.noteInfoLeft.isRest)b=angular.copy(this.i.noteInfoLeft),c=angular.copy(this.i.posLeft),c.line&&(c.line=b.lines[b.lines.length-1]);else{if(this.i.noteInfo.isRest)return;b=angular.copy(this.i.noteInfo),c=this.i.cursor.getPosition(),c.callback=this.upperHead.bind(this,null)}d="undefined"==typeof c.line?b.pitches[0]:b.pitches[this.i.dataReader.getNoteAtLine(b,c.line)],c.pitch=w(d,a),delete c.line,this.i.AddNote(b.durationType,c)}},g}]),angular.module("flat.editor.services").factory("flat.editor.services.InputMidi",["Experience",function(a){"use strict";function b(a,b){this.data=a,this.interaction=b}var c=Adagio.Utils.noteUtils,d=Adagio.Utils.timeUtils,e=Adagio.Utils.durationUtils,f=Adagio.Utils.attributesUtils,g=Adagio.edit.common.PartData;b.prototype.setData=function(a){this.data=a},b.prototype.getCursorQuarter=function(a,b,d){for(var f=0,g=0;g<a;g++){var h=d.getNote(g),i=c.getDuration(h);f+=i}return e.divisionsToQuarter(f,b)},b.prototype.isUpper=function(a){return a.octave>=4},b.prototype.isLower=function(a){return a.octave<4},b.prototype.prepareStave=function(a,b){var c=[];return 2!==b?c[0]=a:(c[0]=a.filter(this.isUpper),c[1]=a.filter(this.isLower)),c},b.prototype.assignPitches=function(a){a.forEach(function(a){a.accidental=a.alter,"flat"===a.alter?a.alter=-1:"sharp"===a.alter?a.alter=1:a.alter=0})},b.prototype.AddNoteMidi=function(b){var c,d,e,h,i,j,k=!1,l=this.interaction.cursor.getPosition();l=this.interaction.dataReader.convertVoiceIdx(l);var m=this.data.getPartByIdx(l.partIdx);this.partData=new g(m,l.partIdx);var n=this.partData.getMeasureData(l.measureIdx),o=n.getNbStaves(),p=this.data.getPartVoicesIndexes(l.partIdx),q=n.getAttributes(),r=f.getDivisions(q),s=this.getCursorQuarter(l.noteIdx,r,n.getVoice(l.voiceIdx)),t=Adagio.Utils.durationUtils.quarterToRequiredDivisions(s),u=s*t,v=n.getVoice(l.voiceIdx),w=v.getNote(l.noteIdx),x=Adagio.Utils.timeModifUtils.copy(Adagio.Utils.noteUtils.getTimeModif(w)),y=Adagio.edit.common.extractNoteDurationType(w,r),z=Adagio.Utils.noteUtils.getNbDots(w);for(a.add("editor.input-midi"),b.timePos=u,b.divisions=t,b.partIdx=l.partIdx,b.measureIdx=l.measureIdx,b.voiceIdx=l.voiceIdx,b.staffIdx=l.staffIdx,b.noteIdx=l.noteIdx,c=0;c<p.length;c++)if(d=JSON.parse(JSON.stringify(b)),d.voiceIdx=p[c],d.staffIdx=this.data.getPartVoiceMainStaffIdx(l.partIdx,d.voiceIdx),this.interaction.dataReader.hasVoiceAtMeasure(d,d.voiceIdx)&&(Adagio.edit.common.convertTimePosToFloorNoteIdx(n,d),h=n.getVoice(d.voiceIdx),i=h.getNote(d.noteIdx),!Adagio.Utils.noteUtils.hasNormalTimeModif(i))){k=!0;break}if(this.assignPitches(b.pitches),k)for(b.timeModif=x,b.durationType=y,b.nbDots=z,j=b.pitches,delete b.pitches,delete b.quarterDuration,c=0;c<j.length;c++)b.pitch=j[c],this.interaction.AddNote(b.durationType,JSON.parse(JSON.stringify(b)),!0,!0);else for(b.quarterDuration=Number(w.duration)/r,e=this.prepareStave(b.pitches,o),c=0;c<e.length;c++)l.staffIdx=c,l.voiceIdx=this.data.getPartStaffMainVoiceIdx(l.partIdx,c),e[c].length>0&&this.interaction.AddChordCrossMeasure(JSON.parse(JSON.stringify(l)),b.quarterDuration,s,e[c],!0);this.interaction.goRight(!1,!0,function(){this.interaction.adaptDuration()}.bind(this))},b.prototype.AddNoteLiveMidi=function(a,b,c){for(var d=this.prepareStave(a.pitches,this.nbStave),e=0;e<this.nbStave;e++)this.staffIdx=e,this.voiceIdx=e,a.pitches=d[e],a.pitches.length>0&&this.consumeData(angular.copy(a),b,c)},b.prototype.consumeData=function(a,b,c){var d={partIdx:this.partIdx,staffIdx:this.staffIdx,voiceIdx:this.voiceIdx};for(this.quarterFromStart=c,this.opts=a,this.measureIdx=b;this.data.getNbMeasures()<=b;)this.interaction.AddMeasure();this.currentQuarterPos=0;for(var e=null;this.opts.quarterDuration>0;)d.measureIdx=b,this.measureIdx=b,d.noteIdx=this.moveToNote(d),this.interaction.changeCursor(d),this.consumeSpace(),this.interaction.changeCursor(d),this.addNotes(),e&&a.pitches.length>0&&(this.interaction.changeCursor(e),this.interaction.AddTie(!0),this.interaction.changeCursor(d)),b++,e=this.interaction.cursor.getPosition();return d},b.prototype.moveToNote=function(a){this.measureData=this.getMeasureData();var b=this.quarterFromStart-this.currentQuarterPos;for(this.currentMeasureQuarterPos=0,this.noteIdx=0;this.currentMeasureQuarterPos<b;this.noteIdx++){var c=this.getNoteQuarterDuration();if(c+this.currentMeasureQuarterPos>b){var d=b-this.currentMeasureQuarterPos,f=e.quarterToDurationOpts(d);a.noteIdx=this.noteIdx,this.interaction.changeCursor(a),this.interaction.AddDotted(f.durationType,f.nbDots,!0),c=this.getNoteQuarterDuration()}this.currentMeasureQuarterPos+=c}return this.noteIdx},b.prototype.getNoteQuarterDuration=function(){var a=this.getNote(),b=this.getDivisions(),d=c.getDuration(a);return d/b},b.prototype.getTime=function(){var a=this.getMeasureData();return a.getTime(this.staffIdx)},b.prototype.getDivisions=function(){var a=this.getMeasureData(),b=a.getAttributes();return f.getDivisions(b)},b.prototype.getNote=function(){this.measureData=this.getMeasureData();var a=this.measureData.getVoice(this.voiceIdx);return a.getNote(this.noteIdx)},b.prototype.getMeasureData=function(){return this.partData.getMeasureData(this.measureIdx)},b.prototype.changeNoteDuration=function(a){var b=h(a),c=e.quarterToDurationOpts(b);this.interaction.AddDotted(c.durationType,c.nbDots,!0)};var h=function(a){for(var b=e.extractBaseDuration(a),c=0,d=0,f=b;c<2&&b+d<a;)c++,f/=2,d+=f;return b+d>a&&(d-=f),b+d};return b.prototype.consumeSpace=function(){for(var a=this.getMeasureQuarterDuration(),b=a-this.currentMeasureQuarterPos,c=Math.min(this.opts.quarterDuration,b);c>0;){var d=this.getNoteQuarterDuration();if(c>=d){for(;!this.interaction.noteInfo.isRest;)this.interaction.RemoveNote();c-=d;for(var f=d;f>0;)f-=this.getNoteQuarterDuration(),this.interaction.goRight(!0,!0),this.noteIdx++}else{var g=c,i=e.quarterToDurationOpts(h(g));this.interaction.AddDotted(i.durationType,i.nbDots,!0),this.interaction.noteInfo.isRest||this.interaction.RemoveNote(),c=0}}},b.prototype.addNotes=function(){var a=this.getMeasureQuarterDuration(),b=a-this.currentMeasureQuarterPos,c=Math.min(this.opts.quarterDuration,b);this.currentQuarterPos+=this.getMeasureQuarterDuration(),this.opts.quarterDuration-=c,this.quarterFromStart+=c;var d=null,f=this.interaction.cursor.getPosition();for(this.noteIdx=f.noteIdx;c>0;){var g=h(c);c-=g;for(var i=0;i<this.opts.pitches.length;i++){var j=this.opts.pitches[i],k=this.interaction.cursor.getPosition();k.accidental=j.alter,k.pitch=angular.copy(j),k.pitch.alter=0;var l=e.quarterToDurationOpts(g);k.nbDots=l.nbDots,this.interaction.AddNote(l.durationType,k,!0)}if(d&&(this.interaction.changeCursor(d),this.interaction.AddTie(!0),this.interaction.changeCursor(f)),this.opts.pitches.length>0&&(d=this.interaction.cursor.getPosition()),0===this.opts.pitches.length)for(var m=g;m>0;)m-=this.getNoteQuarterDuration(),this.interaction.goRight(!0,!0),this.noteIdx++;else c>0&&this.interaction.goRight(!0,!0);f=this.interaction.cursor.getPosition()}},b.prototype.getMeasureQuarterDuration=function(){var a=this.getTime(),b=d.getBeatType(a),c=d.getBeats(a),e=4/b;return e*c},b}]),angular.module("flat.editor.services").factory("flat.editor.services.Mouse",["flat.editor.services.MouseSelect","flat.editor.services.SVGTools",function(a,b){"use strict";function c(b,c,d,e,f){this.color=null,this.drawer=c,this.drawingContext=c.getDrawingContext(),this.cursor=d,this.collaborators=e,this.spaceLine=this.drawingContext.getSpaceSize();var g=document.getElementById("svg-content");if(g){var h=g.getElementsByClassName("measure");this.service=new a(b,e,d,this,f),this.selected=f;for(var i=0;i<h.length;i++)this.service.bindEvent(h[i]);this.service.drawer=this.drawer,this.service.drawingContext=this.drawingContext,this.service.updateUx()}}function d(a){for(var c=0;c<a.length;c++){var d=a[c].svg,e=b.getElementsByClassName(d.node(),"rect-mea");0===e.length?e=d.append("rect").attr("fill","rgba(255, 255, 0, 0)").attr("width",a[c].width).attr("height",a[c].staffHeight+a[c].spaceAbove+a[c].spaceBelow).attr("transform","translate(0, "+-a[c].spaceAbove+")").attr("class","rect-mea"):(e=e[0],e.setAttribute("fill","rgba(255, 255, 0, 0)"),e.setAttribute("width",a[c].width),e.setAttribute("height",a[c].staffHeight+a[c].spaceAbove+a[c].spaceBelow),e.setAttribute("transform","translate(0, "+-a[c].spaceAbove+")"),e.setAttribute("class","rect-mea"))}}return c.prototype.updateEvents=function(a,b){if(this.service){for(var c=0;c<a.length;c++)this.service.bindEvent(a[c].svg.elem);this.service.updateUx(a,b)}},c.prototype.cleanUp=function(){for(var a=document.getElementsByClassName("measure"),b=0;b<a.length;b++)this.service.cleanEvent(a[b]);this.service.cleanUp(),this.svgPoint=null,this.drawer=null,this.selected.cleanUp()},{mouse:c,setRect:d}}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseClick",["$rootScope",function(a){"use strict";function b(a){this.interaction=a,this.fcursor=a.cursor}return b.prototype.click=function(b){var c=this.interaction,d=c.dataReader,e=c.noteInfo,f=!1;d.checkVoice(b),"note"===c.mode&&(d.comparePos(c.posLeft,b)&&!this.fcursor.samePos(c.posLeft)&&(e=c.noteInfoLeft,f=!0),(f||this.fcursor.samePos(b))&&null===d.getTabsAtString(e,b.string)&&null===d.getNoteAtLine(e,b.line)&&(b="undefined"!=typeof b.string||"undefined"!=typeof b.closeString?this.clickTabs(b):"drum"===c.currentStyle&&this.fcursor.samePos(b)?this.clickDrum(b):this.clickNormal(b,f))),b&&(c.changeCursor(b),c.setDuration(null),c.audio&&c.audio.playNote(d.convertVoiceIdx(b)),a.$broadcast("mouse.click.line",b.line))},b.prototype.clickTabs=function(a,b){var c=this.interaction,d=c.noteInfo,e=c.dataReader;if(b&&(d=c.noteInfoLeft),c.svgTools.correctTab(a),"undefined"!=typeof a.string&&e.getTabsAtString(d,a.string))return a;if(a.fretData={string:a.string,fret:0},a.voiceIdx!==c.voiceIdx){var f=e.convertVoiceIdx(a);a.voiceIdx=c.voiceIdx,a.voiceIdxRef=f.voiceIdx,a.noteIdxRef=f.noteIdx}a.nbDots=d.nbDots,c.AddNote(d.durationType,a),c.audio&&c.audio.playNote(e.convertVoiceIdx(a)),b||(c.setDuration(d.durationType),b||c.goRight(!0,!0,function(){c.adaptDuration()}.bind(this)))},b.prototype.clickNormal=function(a,b){var c=this.interaction,d=c.dataReader,e=c.noteInfo;if(b&&(e=c.noteInfoLeft),null!==c.getNoteAtLine(e,a.line))return a;if(a.voiceIdx!==c.voiceIdx){var f=d.convertVoiceIdx(a);a.voiceIdx=c.voiceIdx,a.voiceIdxRef=f.voiceIdx,a.noteIdxRef=f.noteIdx}a.nbDots=e.nbDots,c.AddNote(e.durationType,a,!0),"undefined"!=typeof a.voiceIdxRef&&(a.noteIdx=d.data.refToNoteIdx(d.convertVoiceIdx(a)),c.changeCursor(a)),c.audio&&c.audio.playNote(d.convertVoiceIdx(a)),b||(c.setDuration(e.durationType),c.goRight(!0,!0,function(){c.adaptDuration()}.bind(this)))},b.prototype.clickDrum=function(a,b){var c=this.interaction,d=c.dataReader,e=c.domCache,f=c.noteInfo;if(b&&(f=c.noteInfoLeft),e.checkCacheHead(a),1===e.cacheHeads[a.partIdx].nbStaffLines&&Object.keys(e.cacheHeads[a.partIdx].pitchMapping).length<2&&(a.line=a.closeLine),null!==d.getNoteAtLine(f,a.line))return a;var g=Adagio.Utils.drumsetUtils.lineToPitch(a.line,e.cacheHeads[a.partIdx].nbStaffLines),h=Adagio.Utils.unpitchedUtils.stringify(g);if("undefined"==typeof e.cacheHeads[a.partIdx].pitchMapping[h])return a;if(a.voiceIdx!==c.voiceIdx){var i=d.convertVoiceIdx(a);a.voiceIdx=c.voiceIdx,a.voiceIdxRef=i.voiceIdx,a.noteIdxRef=i.noteIdx}a.nbDots=f.nbDots,c.AddNote(f.durationType,a),c.audio&&c.audio.playNote(d.convertVoiceIdx(a)),b||(c.setDuration(f.durationType),c.goRight(!0,!0,function(){c.adaptDuration()}.bind(this)))},b}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseGrab",["flat.editor.services.MouseGrabNote","flat.editor.services.MouseGrabPizz","flat.editor.services.MouseGrabPedal","flat.editor.services.MouseGrabWedge","flat.editor.services.MouseGrabWedgeAnchor","flat.editor.services.MouseGrabSlurAnchor","flat.editor.services.MouseGrabDynamic","flat.editor.services.MouseGrabOctaveAnchor","flat.editor.services.MouseGrabOctave","flat.editor.services.MouseGrabTempoChange","flat.editor.services.MouseGrabTempoAnchor","flat.editor.services.MouseGrabMetronome",function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";function m(a,b,c,d){this.init(),this.cursor=b,this.color=c,this.mouseSelected=d,this.interaction=a,this.svgTools=a.svgTools,this.domCache=a.domCache,this.dataReader=a.dataReader,this.rangeSelect=a.rangeSelect}var n={"wedge-anchor":e,"slur-anchor":f,"octave-anchor":h,"tempo-anchor":k,note:a,pizzicato:b,pedal:c,wedgeLines:d,dynamic:g,octaveShift:i,tempoChange:j,metronome:l},o=["wedge-anchor","slur-anchor","octave-anchor","tempo-anchor","dynamic","pizzicato","pedal","wedgeLines","slur","octaveShift","chord","tempoChange","metronome","word","lyricLine"];return m.prototype.init=function(){this.nearElem=null,this.nearName=null,this.grabWorker=null},m.prototype.mousedown=function(a,b){var c;if(c="note"===this.interaction.mode?this.gatherNotes(a,b):this.gatherElems(a,b),c.length>1&&(c=[this.svgTools.getCloserElem(a,c)]),0!==c.length)return this.nearElem=c[0],this.nearName=this.nearElem.classList[0],this.nearElem},m.prototype.gatherNotes=function(a,b){var c=this.svgTools,d=c.findParent(a.target,"measure"),e=c.getElementsByClassName(d,"note");return e=e.filter(function(d){return c.isCloseEnough(a,d,b||2)})},m.prototype.gatherElems=function(a,b){var c=this.svgTools,d=c.findParent(a.target,"staff"),e=[];return o.forEach(function(a){var b=c.getElementsByClassName(d,a);b=[].slice.call(b),e=e.concat(b)},this),e=e.concat(this.gatherNotes(a)),e=e.filter(function(d){return c.isCloseEnough(a,d,b||2)})},m.prototype.move=function(a){if(this.mouseSelected.isSelected()&&null===this.grabWorker&&"undefined"!=typeof n[this.nearName])this.grabWorker=new n[this.nearName](this.interaction,this.cursor,this.color,this.mouseSelected.elem,this.nearElem,a),"undefined"!=typeof Raven&&Raven.captureBreadcrumb({category:"mouse",message:"grab: "+this.nearName});else if(this.grabWorker)this.grabWorker.move(a);else{var b=this.svgTools.findNearestNoteXWide(a,this.domCache.cacheMeasure.measure),c=this.svgTools.findInformation(a,b);this.svgTools.correctTab(c),this.dataReader.checkVoice(c),this.rangeSelect.selectRange(c)}},m.prototype.up=function(a){if(this.grabWorker){try{this.grabWorker.up(a)}catch(a){}delete this.grabWorker,this.grabWorker=null}this.cursor.removeCursor(),this.rangeSelect.bindIcon(),this.nearElem=null,this.nearName=null},m}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseGrabPizz",[function(){"use strict";function a(a,b,c,d){this.cursor=b,this.color=c,this.elem=d.elem,this.interaction=a,this.svgTools=a.svgTools,this.domCache=a.domCache,this.dataReader=a.dataReader;var e=this.svgTools.findParent(this.elem,"measure");this.pizzId=this.svgTools.getPosition(e,this.elem,"pizzicato"),this.initPos=this.svgTools.getTopPosition(e);var f=angular.copy(this.initPos);f.pizzicatoIdx=this.pizzId,this.type=this.dataReader.data.getPizzicatoData(f).type}return a.prototype.move=function(a){this.elem.style.visibility="hidden",this.domCache.checkMeasureCache(a);var b=this.svgTools.findNearestNoteXWide(a,this.domCache.cacheMeasure.measure),c=this.svgTools.findInformation(a,b);this.dataReader.checkVoice(c);var d=this.svgTools.lookUpPlacement(c.line);this.cursor.drawPizzicatoCursor(this.dataReader.convertVoiceIdx(c),d,this.type);var e=this.cursor.getCursorGroup();e.text.elem.style.fill=this.color},a.prototype.up=function(a){this.domCache.checkMeasureCache(a);var b=this.svgTools.findNearestNoteXWide(a,this.domCache.cacheMeasure.measure),c=this.svgTools.findInformation(a,b);this.dataReader.checkVoice(c),this.initPos.pizzicatoIdx=this.pizzId,c.type=this.type,c.placement=this.svgTools.lookUpPlacement(c.line),this.interaction.do([{name:"action.RemovePizzicatoAtIdx",opts:this.initPos},{name:"action.AddPizzicatoAtNote",opts:c}],{mute:!0,subStackName:"pizz",onErrorUndoSubstack:!0})},a}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseGrabNote",[function(){"use strict";function a(a,b,c,d,e,f){this.interaction=a,this.svgTools=a.svgTools,this.dataReader=a.dataReader,this.cursor=b,this.dragNote=e,this.mouseSelected=d;var g=this.mouseSelected.pos;return this.noteInfo=this.dataReader.getNoteInfo(g),
"undefined"!=typeof g.string||this.noteInfo.isRest||this.dataReader.data.isPartUnpitched(g.partIdx)?void(this.isDragRest=!0):(this.dragHead=this.svgTools.getClosestHead(f,this.dragNote),this.dragStaff=this.svgTools.findParent(this.dragHead,"staff"),this.dragMeasure=this.svgTools.findParent(f.target,"measure"),void(this.dragLineStart=this.dragPrevious=this.svgTools.getHeadLine(this.dragHead,this.dragStaff)))}return a.prototype.move=function(a){if(!this.isDragRest){var b=this.svgTools.getLine(a,this.dragStaff),c=5-b,d=this.svgTools.svg[0].node(),e=this.dragHead.transform.baseVal.getItem(0).matrix;e.f=0,this.dragHead.transform.baseVal.initialize(d.createSVGTransformFromMatrix(e.translate(0,c*this.svgTools.spaceLine/this.svgTools.scaling)))}},a.prototype.up=function(a){var b=this.svgTools.findInformation(a,this.dragNote);if(null!==this.dataReader.getNoteAtLine(this.noteInfo,b.line)||Adagio.Utils.pitchUtils.MAX_LINE<b.line||Adagio.Utils.pitchUtils.MIN_LINE>b.line){var c=5-this.dragLineStart,d=this.svgTools.svg[0].node(),e=this.dragHead.transform.baseVal.getItem(0).matrix;return e.f=0,void this.dragHead.transform.baseVal.initialize(d.createSVGTransformFromMatrix(e.translate(0,c*this.svgTools.spaceLine/this.svgTools.scaling)))}var f=angular.copy(this.mouseSelected.pos);f.fromLine=this.dragLineStart,f.toLine=b.line,this.isDragRest||this.interaction.changePitch(f)},a}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseGrabDynamic",[function(){"use strict";function a(a,b,c,d){this.cursor=b,this.color=c,this.interaction=a,this.domCache=a.domCache,this.elem=d.elem;var e=a.svgTools,f=e.findParent(this.elem,"measure");this.dynamicIdx=e.getPosition(f,this.elem,"dynamic"),this.initPos=e.getTopPosition(f);var g=angular.copy(this.initPos);g.dynamicIdx=this.dynamicIdx,this.type=a.dataReader.data.getDynamicData(g).style}return a.prototype.move=function(a){this.elem.style.visibility="hidden",this.domCache.checkMeasureCache(a);var b=this.interaction.svgTools,c=this.interaction.dataReader,d=b.findNearestNoteXWide(a,this.domCache.cacheMeasure.measure),e=b.findInformation(a,d);b.correctTab(e),c.checkVoice(e);var f=b.lookUpPlacement(e.line);this.cursor.drawDynamicCursor(c.convertVoiceIdx(e),f,this.type)},a.prototype.up=function(a){this.domCache.checkMeasureCache(a);var b=this.interaction.svgTools,c=b.findNearestNoteXWide(a,this.domCache.cacheMeasure.measure),d=b.findInformation(a,c);this.interaction.dataReader.checkVoice(d),this.initPos.dynamicIdx=this.dynamicIdx,d.placement=b.lookUpPlacement(d.line),d.style=this.type,this.interaction.do([{name:"action.RemoveDynamicAtIdx",opts:this.initPos},{name:"action.AddDynamics",opts:d}],{mute:!0,subStackName:"dynamics",onErrorUndoSubstack:!0})},a}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseGrabPedal",["flat.editor.services.PosBuilder",function(a){"use strict";function b(b,c,d,e){this.cursor=c,this.elem=e.elem,this.mouseSelected=e,this.color=d,this.interaction=b,this.domCache=b.domCache,this.posBuilder=new a(b,e)}return b.prototype.move=function(a){this.elem.style.visibility="hidden";var b=this.mouseSelected.getRectOrigin();this.domCache.checkMeasureCache(a);var c=this.interaction.svgTools,d=c.findNearestNoteXWide(a,this.domCache.cacheMeasure.measure),e=c.findInformation(a,d);if(c.correctTab(e),this.interaction.dataReader.checkVoice(e),e.staffIdx===this.mouseSelected.pos.staffIdx&&this.mouseSelected.pos.partIdx===e.partIdx&&(this.opts=this.posBuilder.buildOpt(e,b),this.opts)){this.opts.stopNoteIdx--,this.placement=c.lookUpPlacement(e.line);var f=this.cursor.drawPedalCursor(this.opts,this.placement);f&&f.length>0&&(b.left?f[0].style("fill",this.color):f[1].style("fill",this.color))}},b.prototype.up=function(){this.opts&&(this.opts.placement=this.placement,this.interaction.do([{name:"action.RemovePedal",opts:this.mouseSelected.pos},{name:"action.AddPedal",opts:this.opts}],{mute:!0,subStackName:"pedal",onErrorUndoSubstack:!0}))},b}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseGrabWedge",["flat.editor.services.PosBuilder",function(a){"use strict";function b(b,c,d,e){this.cursor=c,this.elem=e.elem,this.color=d,this.selected=e,this.interaction=b,this.selected.elem.style.visibility="hidden",this.posBuilder=new a(b,e)}return b.prototype.move=function(a){var b=this.posBuilder.translatePos(a),c=this.posBuilder.buildPos(b),d=this.interaction.svgTools,e=d.lookUpPlacement(b.line);this.selected.rectOrigin.location.placement=e;var f=this.cursor.drawWedgeCursor(c,this.selected.rectOrigin.location);if(f&&f.length>0){var g=f[0].elem.getElementsByTagName("line");g=[].slice.call(g),g.forEach(function(a){a.style.stroke=this.color},this)}},b.prototype.up=function(){var a=this.posBuilder.buildPos(this.posBuilder.oldPos);a.type=this.selected.rectOrigin.location.type,a.placement=this.selected.rectOrigin.location.placement,this.interaction.do([{name:"action.RemoveWedgeAtTimePos",opts:this.selected.pos},{name:"action.AddWedge",opts:a}],{mute:!0,subStackName:"wedge",onErrorUndoSubstack:!0})},b}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseGrabWedgeAnchor",["flat.editor.services.PosBuilder",function(a){"use strict";function b(b,c,d,e,f){this.cursor=c,this.elem=e.elem,this.mouseSelected=e,this.color=d,this.interaction=b,this.domCache=b.domCache,this.mouseSelected.fixSide(f),this.posBuilder=new a(b,e)}return b.prototype.move=function(a){this.elem.style.visibility="hidden";var b=this.mouseSelected.getRectOrigin();this.domCache.checkMeasureCache(a);var c=this.interaction.svgTools,d=c.findNearestNoteXWide(a,this.domCache.cacheMeasure.measure),e=c.findInformation(a,d);if(c.correctTab(e),this.interaction.dataReader.checkVoice(e),e.staffIdx===this.mouseSelected.pos.staffIdx&&this.mouseSelected.pos.partIdx===e.partIdx&&(this.opts=this.posBuilder.buildOpt(e,b)),this.opts){var f=this.cursor.drawWedgeCursor(this.opts,this.mouseSelected.rectOrigin.location);if(f&&f.length>0){var g=f[0].elem.getElementsByTagName("line");g=[].slice.call(g),g.forEach(function(a){a.style.stroke=this.color},this)}}},b.prototype.up=function(){var a=this.mouseSelected.getRectOrigin();this.opts&&(this.opts.mute=!0,this.interaction.AddWedge(a.location.type,a.location.placement,this.opts),this.elem.style.visibility="visible")},b}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseGrabSlurAnchor",["flat.editor.services.PosBuilder",function(a){"use strict";function b(b,c,d,e,f){this.cursor=c,this.elem=e.elem,this.mouseSelected=e,this.color=d,this.interaction=b,this.domCache=b.domCache,this.mouseSelected.fixSide(f),this.posBuilder=new a(b,e)}return b.prototype.move=function(a){var b=this.mouseSelected.getRectOrigin();this.domCache.checkMeasureCache(a);var c=this.interaction.svgTools,d=c.findNearestNoteX(a,this.domCache.cacheMeasure.measure,this.mouseSelected.pos.voiceIdx),e=c.findInformation(a,d);if(c.correctTab(e),this.interaction.dataReader.checkVoice(e),e.staffIdx===this.mouseSelected.pos.staffIdx&&this.mouseSelected.pos.voiceIdx===e.voiceIdx&&this.mouseSelected.pos.partIdx===e.partIdx&&(this.opts=this.posBuilder.buildOpt(e,b),this.opts.stopNoteIdx--),this.opts){this.elem.style.visibility="hidden",this.opts.voiceIdx=this.mouseSelected.pos.voiceIdx;var f=this.cursor.drawSlurCursor(this.interaction.dataReader.convertVoiceIdx(this.opts));f&&f.length>0&&f[0].style("fill",this.color)}},b.prototype.up=function(){this.opts&&this.interaction.do([{name:"action.RemoveSlur",opts:this.mouseSelected.pos},{name:"action.AddSlur",opts:this.interaction.AddSlurs(this.opts,!0)}],{mute:!0,subStackName:"slurs",onErrorUndoSubstack:!0})},b}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseGrabOctave",["flat.editor.services.PosBuilder",function(a){"use strict";function b(b,c,d,e){this.cursor=c,this.elem=e.elem,this.color=d,this.selected=e,this.interaction=b,this.selected.elem.style.visibility="hidden",this.posBuilder=new a(b,e)}return b.prototype.move=function(a){var b=this.posBuilder.translatePos(a);this.opts=this.posBuilder.buildPos(b);var c=this.interaction.svgTools.lookUpPlacement(b.line);this.selected.rectOrigin.set.placement=c;var d=this.cursor.drawOctaveShiftCursor(this.opts,this.selected.rectOrigin.set);d&&d.length>0&&d[0].style("fill",this.color)},b.prototype.up=function(){var a=this.selected.getRectOrigin();this.opts.placement=a.set.placement,this.opts.size=a.set.size,this.interaction.do([{name:"action.RemoveOctaveShiftAtTimePos",opts:this.selected.pos},{name:"action.AddOctaveShift",opts:this.opts}],{mute:!0,subStackName:"octaveShift",onErrorUndoSubstack:!0})},b}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseGrabOctaveAnchor",["flat.editor.services.PosBuilder",function(a){"use strict";function b(b,c,d,e,f){this.cursor=c,this.elem=e.elem,this.mouseSelected=e,this.color=d,this.interaction=b,this.domCache=b.domCache,this.mouseSelected.fixSide(f),this.posBuilder=new a(b,e)}return b.prototype.move=function(a){this.elem.style.visibility="hidden";var b=this.mouseSelected.getRectOrigin();this.domCache.checkMeasureCache(a);var c=this.interaction.svgTools,d=c.findNearestNoteXWide(a,this.domCache.cacheMeasure.measure),e=c.findInformation(a,d);if(c.correctTab(e),this.interaction.dataReader.checkVoice(e),e.staffIdx===this.mouseSelected.pos.staffIdx&&this.mouseSelected.pos.partIdx===e.partIdx&&(this.opts=this.posBuilder.buildOpt(e,b)),this.opts){var f=c.lookUpPlacement(e.line);b.set.placement=f;var g=this.cursor.drawOctaveShiftCursor(this.opts,b.set);g&&g.length>0&&g[0].style("fill",this.color)}},b.prototype.up=function(){var a=this.mouseSelected.getRectOrigin();this.opts.placement=a.set.placement,this.opts.size=a.set.size,this.interaction.do([{name:"action.RemoveOctaveShiftAtTimePos",opts:this.mouseSelected.pos},{name:"action.AddOctaveShift",opts:this.opts}],{mute:!0,subStackName:"octaveShift",onErrorUndoSubstack:!0})},b}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseGrabTempoChange",["flat.editor.services.PosBuilder",function(a){"use strict";function b(b,c,d,e){this.cursor=c,this.elem=e.elem,this.color=d,this.selected=e,this.interaction=b,this.selected.elem.style.visibility="hidden",this.posBuilder=new a(b,e)}return b.prototype.move=function(a){var b=this.posBuilder.translatePos(a);this.opts=this.posBuilder.buildPos(b);var c=this.cursor.drawTempoChangeCursor(this.opts,{type:this.selected.rectOrigin.type});c&&c.length>0&&c[0].style("fill",this.color)},b.prototype.up=function(){this.opts.type=this.selected.rectOrigin.type,this.selected.pos.transpose=!0,this.interaction.do([{name:"action.RemoveTempoChangeAtTimePos",opts:this.selected.pos},{name:"action.AddTempoChange",opts:this.opts}],{mute:!0,subStackName:"tempoChange",onErrorUndoSubstack:!0})},b}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseGrabMetronome",[function(){"use strict";function a(){}return a.prototype.move=function(){},a.prototype.up=function(){},a}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseGrabTempoAnchor",["flat.editor.services.PosBuilder",function(a){"use strict";function b(b,c,d,e,f){this.cursor=c,this.elem=e.elem,this.mouseSelected=e,this.color=d,this.interaction=b,this.domCache=b.domCache,this.mouseSelected.fixSide(f),this.posBuilder=new a(b,e)}return b.prototype.move=function(a){this.elem.style.visibility="hidden";var b=this.mouseSelected.getRectOrigin();this.domCache.checkMeasureCache(a);var c=this.interaction.svgTools,d=c.findNearestNoteXWide(a,this.domCache.cacheMeasure.measure),e=c.findInformation(a,d);if(c.correctTab(e),this.interaction.dataReader.checkVoice(e),e.staffIdx===this.mouseSelected.pos.staffIdx&&this.mouseSelected.pos.partIdx===e.partIdx&&(this.opts=this.posBuilder.buildOpt(e,b)),this.opts){var f=this.cursor.drawTempoChangeCursor(this.opts,{type:b.type});f&&f.length>0&&f[0].style("fill",this.color)}},b.prototype.up=function(){this.opts&&(this.opts.type=this.mouseSelected.rectOrigin.type,this.interaction.do([{name:"action.RemoveTempoChangeAtTimePos",opts:this.mouseSelected.pos},{name:"action.AddTempoChange",opts:this.opts}],{mute:!0,subStackName:"tempoChange",onErrorUndoSubstack:!0}))},b}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseSelect",["$rootScope","$timeout","flat.editor.services.DarkenLighten","flat.editor.services.Mousemove","flat.editor.services.MouseClick","flat.editor.services.MouseGrab","flat.editor.services.MouseSelectNote",function(a,b,c,d,e,f,g){"use strict";function h(b,g,h,i,j){this.color=c.convertColor(g.getUserColor(a.account.id),40),this.cursor=h,this.highlight=null,this.selected=j,this.interaction=b,this.MouseMove=new d(b,h),this.MouseClick=new e(b),this.MouseGrab=new f(b,h,this.color,j),this.drag=!1,this.collaborators=g,this.mouse=i,this.cb={mousemove:this.mousemove.bind(this),mousedown:this.mousedown.bind(this),mouseup:this.mouseup.bind(this),dblclick:this.dbclick.bind(this),toucheHandler:this.touchHandler.bind(this),click:this.click.bind(this)},this.endCb=this.endAnimation.bind(this)}var i=["webkit","moz","MS","o",""];return h.prototype.bindEvent=function(a){a.addEventListener("mousemove",this.cb.mousemove,!1),a.addEventListener("mousedown",this.cb.mousedown,!1),a.addEventListener("mouseup",this.cb.mouseup,!1),a.addEventListener("click",this.cb.click,!0),a.addEventListener("dblclick",this.cb.dblclick,!1),a.addEventListener("touchstart",this.cb.toucheHandler,!1),a.addEventListener("touchmove",this.cb.toucheHandler,!1),a.addEventListener("touchend",this.cb.toucheHandler,!1),a.addEventListener("touchcancel",this.cb.toucheHandler,!1)},h.prototype.cleanEvent=function(a){a.removeEventListener("mousemove",this.cb.mousemove,!1),a.removeEventListener("mousedown",this.cb.mousedown,!1),a.removeEventListener("mouseup",this.cb.mouseup,!1),a.removeEventListener("dblclick",this.cb.dblclick,!1),a.removeEventListener("touchstart",this.cb.toucheHandler,!1),a.removeEventListener("touchmove",this.cb.toucheHandler,!1),a.removeEventListener("touchend",this.cb.toucheHandler,!1),a.removeEventListener("touchcancel",this.cb.toucheHandler,!1)},h.prototype.updateUx=function(){null!==this.interaction.rangeSelect.firstPos&&null!==this.interaction.rangeSelect.secondPos&&this.interaction.rangeSelect.refresh()},h.prototype.click=function(a){a.stopPropagation()},h.prototype.mousemove=function(a){if(this.interaction.domCache.checkMeasureCache(a),this.mouseDown)this.movedown(a);else{var b=this.MouseMove.move(a),d=this.interaction.cursor.getNote();if(!d)return;if(this.noteHighlight&&this.noteHighlight!==d.head&&(this.cleanElem(this.noteHighlight),this.noteHighlight=null),b&&b.save&&b.save!==d.head){var e=this.interaction.svgTools.getNbVoice(b.save),f=this.interaction.dataReader.data.getPartStaffMapping(b.pos.partIdx,b.pos.staffIdx);e=f[b.pos.staffIdx].voices.indexOf(e),0===e&&b.norm||0===this.interaction.voiceIdx&&e!==this.interaction.voiceIdx&&!b.norm?this.colorElem(b.save,this.color):1===e&&b.norm||1===this.interaction.voiceIdx&&e!==this.interaction.voiceIdx&&!b.norm?this.colorElem(b.save,c.convertColor("#FCA0C4",40)):this.interaction.voiceIdx===e&&this.colorElem(b.save,c.convertColor(this.interaction.cursor.color,40)),this.noteHighlight=b.save}}},h.prototype.cleanUp=function(){},h.prototype.movedown=function(a){this.counterSmoother<2?this.counterSmoother++:(this.drag=!0,this.MouseGrab.move(a))},h.prototype.mousedown=function(a){a.preventDefault(),this.interaction.domCache.checkMeasureCache(a);var b=this.interaction.svgTools,c=b.findNearestNoteX(a,this.interaction.domCache.cacheMeasure.measure,this.interaction.voiceIdx),d=b.findInformation(a,c);b.correctTab(d),this.interaction.dataReader.checkVoice(d);var e=!this.interaction.rightsHandler.categoryState.score_write,f=this.MouseGrab.mousedown(a);return("undefined"!=typeof this.selected&&f&&f.classList[0].indexOf("anchor")<0||!f)&&this.selected.cleanUp(),"undefined"!=typeof f&&this.selected.isSelectable(f,e)&&this.selected.select(f,d,this.color,e),this.mouseDown=!0,this.interaction.rangeSelect.reset(),!1},h.prototype.mouseup=function(a){this.interaction.domCache.checkMeasureCache(a);var b=this.interaction.svgTools,c=b.findNearestNoteX(a,this.interaction.domCache.cacheMeasure.measure,this.interaction.voiceIdx),d=b.findInformation(a,c);b.correctTab(d),this.MouseGrab.up(a),this.counterSmoother=0,this.drag?(this.drag=!1,this.interaction.changeCursor(d)):window.requestAnimationFrame(this.MouseClick.click.bind(this.MouseClick,d)),this.mouseDown=!1},h.prototype.dbclick=function(a){this.interaction.domCache.checkMeasureCache(a);var b=this.interaction.cursor.getPosition(),c=this.interaction.dataReader;this.interaction.rangeSelect.selectRange(angular.copy(b)),b.measureIdx=c.getNbMeasures()-1,c.checkVoice(b),b.noteIdx=c.getNbNotes(b)-1,this.interaction.rangeSelect.selectRange(b)},h.prototype.touchHandler=function(a){if(2===a.touches.length)return this.touchMode="pinch",this.touchPinch(a);if("pinch"===this.touchMode&&"touchstart"!==a.type)return a.preventDefault();var b,c,d,e=this.interaction.svgTools,f=this.interaction.domCache,h=this.interaction.dataReader;if("touchstart"===a.type)this.touchStartTouch=a.changedTouches[0],f.checkMeasureCache(a),b=e.findNearestNoteX(a,f.cacheMeasure.measure,this.interaction.voiceIdx),c=e.findInformation(a,b),e.correctTab(c),h.checkVoice(c),this.interaction.rightsHandler.categoryState.score_write&&(d=this.MouseGrab.mousedown(a,25),d&&this.selected.elem&&this.selected.elem.elem===d?this.touchMode="change":(this.touchMode="select","undefined"!=typeof d&&(d.classList[0].indexOf("anchor")>=0?this.touchMode="change":this.selected.isSelectable(d)&&(this.touchMode="select",this.touchStartSelected=d))));else if("touchmove"===a.type&&"change"===this.touchMode){var i={type:"touchmove",clientX:a.changedTouches[0].clientX,clientY:a.changedTouches[0].clientY,target:document.elementFromPoint(a.changedTouches[0].clientX,a.changedTouches[0].clientY)};if(f.checkMeasureCache(i),f.cacheMeasure.measure||(i=a,f.checkMeasureCache(a)),this.selected.elem instanceof g){b=e.findNearestNoteXWide(i,f.cacheMeasure.measure);var j=e.findInformation(i,b);this.interaction.rangeSelect.selectRange(j)}else this.counterSmoother<2?this.counterSmoother++:(this.touchDrag=!0,this.MouseGrab.move(i));a.preventDefault()}else if("touchend"===a.type){var k={type:"touchend",clientX:a.changedTouches[0].clientX,clientY:a.changedTouches[0].clientY,target:document.elementFromPoint(a.changedTouches[0].clientX,a.changedTouches[0].clientY)};f.checkMeasureCache(k),f.cacheMeasure.measure||(k=a,f.checkMeasureCache(a)),b=e.findNearestNoteX(k,f.cacheMeasure.measure,this.interaction.voiceIdx),c=e.findInformation(k,b),e.correctTab(c),h.checkVoice(c),this.counterSmoother=0,this.touchDrag=!1,this.touchStartSelected?(d=this.MouseGrab.mousedown(a,25),d===this.touchStartSelected?(this.selected.select(d,c,this.color),this.interaction.rangeSelect.reset()):("undefined"!=typeof this.selected&&d&&d.classList[0].indexOf("anchor")<0||!d)&&(this.selected.cleanUp(),this.interaction.rangeSelect.reset()),this.touchStartSelected=null):this.MouseGrab.up(k);var l=a.changedTouches[0],m=Math.sqrt((l.clientX-this.touchStartTouch.clientX)*(l.clientX-this.touchStartTouch.clientX)+(l.clientY-this.touchStartTouch.clientY)*(l.clientY-this.touchStartTouch.clientY));m<10&&("drum"===this.interaction.currentStyle?this.MouseClick.click(c):this.interaction.changeCursor(c)),a.preventDefault()}},h.prototype.touchPinch=function(a){var b=Math.sqrt((a.touches[0].clientX-a.touches[1].clientX)*(a.touches[0].clientX-a.touches[1].clientX)+(a.touches[0].clientY-a.touches[1].clientY)*(a.touches[0].clientY-a.touches[1].clientY));if("touchstart"===a.type)this.touchPinchDistLast=b;else if("touchend"===a.type)this.touchPinchDistLast=null;else{var c=b-this.touchPinchDistLast;0!==c&&(c>0?this.interaction.zoomIn(c/1e3):this.interaction.zoomOut(-c/1e3)),this.touchPinchDistLast=b}a.preventDefault()},h.prototype.addPrefixedEvent=function(a,b,c){for(var d=0;d<i.length;d++)i[d]||(b=b.toLowerCase()),a.addEventListener(i[d]+b,c,!1)},h.prototype.removePrefixedEvent=function(a,b,c){for(var d=0;d<i.length;d++)i[d]||(b=b.toLowerCase()),a.removeEventListener(i[d]+b,c,!1)},h.prototype.endAnimation=function(a){a.target.classList.toggle("paste"),this.removePrefixedEvent(a.target,"AnimationEnd",this.endCb)},h.prototype.colorElem=function(a,b){a.style.fill=b,a.style.stroke=b},h.prototype.cleanElem=function(a){a.style.fill="",a.style.stroke=""},h}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseSelected",["$rootScope","flat.editor.services.DarkenLighten","flat.editor.services.MouseSelectPizz","flat.editor.services.MouseSelectDynamics","flat.editor.services.MouseSelectPedal","flat.editor.services.MouseSelectWedge","flat.editor.services.MouseSelectSlurs","flat.editor.services.MouseSelectOctave","flat.editor.services.MouseSelectChord","flat.editor.services.MouseSelectNote","flat.editor.services.MouseSelectTempoChange","flat.editor.services.MouseSelectMetronome","flat.editor.services.MouseSelectWord","flat.editor.services.MouseSelectLyric",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){"use strict";function o(c,d){this.interaction=c,this.collaborators=d,this.color=b.convertColor(this.collaborators.getUserColor(a.account.id),40),this.elem=null}var p={pizzicato:c,dynamic:d,pedal:e,wedgeLines:f,slur:g,octaveShift:h,chord:i,note:j,tempoChange:k,metronome:l,word:m,lyricLine:n},q={metronome:l};return o.prototype.select=function(a,b,c,d){this.cleanUp();var e=a.classList[0];this.elem=new(d?q:p)[e](a,b,c,this.interaction),"undefined"!=typeof Raven&&Raven.captureBreadcrumb({category:"mouse",message:"selected: "+e,data:{pos:JSON.stringify(b)}})},o.prototype.cleanUp=function(){this.elem&&this.elem.cleanUp(),this.elem=null},o.prototype.colorElem=function(a){a.style.fill=this.color,a.style.stroke=this.color},o.prototype.cleanElem=function(a){a.style.fill="",a.style.stroke=""},o.prototype.isSelectable=function(a,b){var c=a.classList[0];return"undefined"!=typeof(b?q:p)[c]},o.prototype.remove=function(a){this.elem.remove(a),this.elem=null},o.prototype.isSelected=function(){return null!==this.elem},o}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseSelectPizz",[function(){"use strict";function a(a,b,c,d){this.elem=a,this.pos=b,this.color=c,this.colorElem(a),this.interaction=d;var e=d.svgTools,f=e.findParent(a,"measure");this.pizzIdx=e.getPosition(f,a,"pizzicato")}return a.prototype.cleanUp=function(){this.cleanElem(this.elem)},a.prototype.remove=function(){this.interaction.RemovePizzicato(this.pizzIdx,this.pos)},a.prototype.colorElem=function(a){a.style.fill=this.color,a.style.stroke=this.color},a.prototype.cleanElem=function(a){a.style.fill="",a.style.stroke=""},a}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseSelectDynamics",[function(){"use strict";function a(a,b,c,d){this.elem=a,this.pos=b,this.color=c,this.colorElem(a),this.interaction=d;var e=d.svgTools,f=e.findParent(a,"measure");this.dynIdx=e.getPosition(f,a,"dynamic")}return a.prototype.remove=function(){this.interaction.RemoveDynamics(this.dynIdx,this.pos)},a.prototype.colorElem=function(a){a.style.fill=this.color,a.style.stroke=this.color},a.prototype.cleanElem=function(a){a.style.fill="",a.style.stroke=""},a.prototype.cleanUp=function(){this.cleanElem(this.elem)},a}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseSelectPedal",[function(){"use strict";function a(a,b,c,d){this.elem=a,this.pos=b,this.color=c,this.rectOrigin={},this.colorElem(a),this.interaction=d;var e=d.svgTools,f=d.dataReader,g=e.findParent(a,"measure"),h=f.data.getPedalData(f.convertVoiceIdx(b));this.posIdx=e.getPosition(g,a,"pedal"),this.rectOrigin.posLeft={measureIdx:h.startMeasureIdx,noteIdx:h.startNoteIdx,voiceIdx:h.startVoiceIdx},this.rectOrigin.posRight={measureIdx:h.stopMeasureIdx,noteIdx:h.stopNoteIdx,voiceIdx:h.stopVoiceIdx},this.rectOrigin.location=h.placement,this.posIdx===h.startPedalIdx&&h.startMeasureIdx===b.measureIdx&&(this.rectOrigin.left=!0)}return a.prototype.remove=function(){this.interaction.RemovePedal(this.pos)},a.prototype.colorElem=function(a){a.style.fill=this.color},a.prototype.cleanElem=function(a){a.style.fill=""},a.prototype.cleanUp=function(){this.cleanElem(this.elem)},a.prototype.getRectOrigin=function(){return this.rectOrigin},a}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseSelectWedge",[function(){"use strict";function a(a,b,c,d){this.color=c,this.elem=a,this.anchor=[],this.pos=b,this.rectOrigin={},this.anchor[0]=new Adagio.Brush.Elem("circle"),this.anchor[1]=new Adagio.Brush.Elem("circle"),this.anchor.forEach(function(a){a.attr("r",6),a.attr("style","fill: none; stroke-width: 3px; opacity: 1; stroke: "+c),a.attr("class","wedge-anchor")},this),this.interaction=d;var e=this.elem.getBBox();this.anchor[0].attr("transform","translate("+e.x+", 0)"),this.anchor[1].attr("transform","translate("+(e.x+e.width)+", 0)");var f=d.svgTools,g=d.dataReader,h=f.findParent(a,"staff"),i=f.findGoodPage(b.partIdx,b.measureIdx),j=g.data.getMeasuresRangeWedgesData({partIdx:b.partIdx,startMeasureIdx:i.nbstart,stopMeasureIdx:i.nbstart+i.nbMea-1,voiceIdx:g.convertVoiceIdx(b).voiceIdx,staffIdx:b.staffIdx}),k=f.getPosition(h,a,"wedgeLines"),l=j[k];this.pos.timePos=l.startTimePos,this.pos.dpq=l.startDpq,this.pos.measureIdx=l.stopMeasureIdx,this.anchor.forEach(function(a){this.elem.appendChild(a.node())},this);var m=this.elem.getElementsByTagName("line");m=[].slice.call(m),m.forEach(function(a){a.style.stroke=c}),this.rectOrigin.posLeft={measureIdx:l.startMeasureIdx,noteIdx:l.startNoteIdx,voiceIdx:l.startVoiceIdx},this.rectOrigin.posRight={measureIdx:l.stopMeasureIdx,noteIdx:l.stopNoteIdx-1,voiceIdx:l.stopVoiceIdx},this.rectOrigin.location={placement:l.placement,type:l.type}}return a.prototype.remove=function(){this.interaction.RemoveWedgeAtTimePos(this.pos)},a.prototype.colorElem=function(a){a.style.fill=this.color,a.style.stroke=this.color},a.prototype.cleanElem=function(a){a.style.fill="",a.style.stroke=""},a.prototype.cleanCircle=function(){this.anchor.forEach(function(a){a.elem.parentNode&&a.removeFromParent()})},a.prototype.cleanUp=function(){this.cleanElem(this.elem);var a=this.elem.getElementsByTagName("line");a=[].slice.call(a),a.forEach(function(a){this.cleanElem(a)},this),this.cleanCircle()},a.prototype.getRectOrigin=function(){return this.rectOrigin},a.prototype.fixSide=function(a){this.anchor[0].elem===a&&(this.rectOrigin.left=!0)},a}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseSelectSlurs",[function(){"use strict";function a(a,b,c,d){this.elem=a,this.pos=b,this.color=c,this.anchor=[],this.rectOrigin={},this.anchor[0]=new Adagio.Brush.Elem("circle"),this.anchor[1]=new Adagio.Brush.Elem("circle"),this.anchor.forEach(function(a){a.attr("r",6),a.attr("style","fill: none; stroke-width: 3px; opacity: 1"),a.attr("class","slur-anchor")},this),this.interaction=d;var e=a.getBBox(),f=e.y>0?0:e.height;this.anchor[0].attr("transform","translate("+e.x+", "+(e.y+f)+")"),this.anchor[1].attr("transform","translate("+(e.x+e.width)+", "+(e.y+f)+")"),this.anchor.forEach(function(a){this.elem.appendChild(a.node())},this);var g=d.svgTools,h=d.dataReader,i=g.findParent(a,"staffSlurs"),j=i.classList[1],k=g.getPosition(i,a,"slur"),l=parseInt(j.substr(j.indexOf("-")+1,j.length-j.indexOf("-")),10);b.voiceIdx=h.data.voiceIdxToIdxInMainStaff(b.partIdx,l);var m=g.findGoodPage(b.partIdx,b.measureIdx),n=h.data.getMeasuresRangeSlursData({partIdx:b.partIdx,startMeasureIdx:m.nbstart,stopMeasureIdx:m.nbstart+m.nbMea-1,voiceIdx:h.convertVoiceIdx(b).voiceIdx,staffIdx:b.staffIdx}),o=n[k];this.pos.timePos=o.startTimePos,this.pos.divisions=o.startDpq,this.pos.measureIdx=o.startMeasureIdx,this.rectOrigin.posLeft={measureIdx:o.startMeasureIdx,noteIdx:o.startNoteIdx},this.rectOrigin.posRight={measureIdx:o.stopMeasureIdx,noteIdx:o.stopNoteIdx},this.colorElem(a)}return a.prototype.remove=function(){this.interaction.RemoveSlurs(this.pos)},a.prototype.colorElem=function(a){a.style.fill=this.color,a.style.stroke=this.color},a.prototype.cleanElem=function(a){a.style.fill="",a.style.stroke=""},a.prototype.cleanUp=function(){this.cleanElem(this.elem),this.cleanCircle()},a.prototype.cleanCircle=function(){this.anchor.forEach(function(a){a.elem.parentNode&&a.removeFromParent()})},a.prototype.getRectOrigin=function(){return this.rectOrigin},a.prototype.fixSide=function(a){this.anchor[0].elem===a&&(this.rectOrigin.left=!0)},a}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseSelectOctave",[function(){"use strict";function a(a,b,c,d){this.interaction=d,this.elem=a,this.pos=b,this.color=c,this.anchor=[],this.rectOrigin={},this.anchor[0]=new Adagio.Brush.Elem("circle"),this.anchor[1]=new Adagio.Brush.Elem("circle"),this.anchor.forEach(function(a){a.attr("r",6),a.attr("style","fill: none; stroke-width: 3px; opacity: 1"),a.attr("class","octave-anchor")},this);var e=a.getBBox();this.anchor[0].attr("transform","translate("+e.x+", "+(e.y+e.height/2)+")"),this.anchor[1].attr("transform","translate("+(e.x+e.width)+", "+(e.y+e.height/2)+")"),this.anchor.forEach(function(a){this.elem.appendChild(a.node())},this);var f=d.svgTools,g=d.dataReader,h=f.findParent(a,"staff"),i=f.findGoodPage(b.partIdx,b.measureIdx),j=f.getPosition(h,a,"octaveShift"),k=g.data.getMeasuresRangeOctaveShiftsData({partIdx:b.partIdx,startMeasureIdx:i.nbstart,stopMeasureIdx:i.nbstart+i.nbMea-1,voiceIdx:g.convertVoiceIdx(b).voiceIdx,staffIdx:b.staffIdx}),l=k[j];this.pos.timePos=l.startTimePos,this.pos.dpq=l.startDpq,this.pos.measureIdx=l.stopMeasureIdx,this.pos.transpose=!0,this.rectOrigin.posLeft={measureIdx:l.startMeasureIdx,noteIdx:l.startNoteIdx,voiceIdx:l.startVoiceIdx},this.rectOrigin.posRight={measureIdx:l.stopMeasureIdx,noteIdx:l.stopNoteIdx-1,voiceIdx:l.stopVoiceIdx},this.rectOrigin.set={placement:l.placement,size:l.size},this.colorElem(a)}return a.prototype.remove=function(){this.interaction.RemoveOctaveShiftAtTimePos(this.pos)},a.prototype.colorElem=function(a){a.style.fill=this.color,a.style.stroke=this.color},a.prototype.cleanElem=function(a){a.style.fill="",a.style.stroke=""},a.prototype.cleanUp=function(){this.cleanElem(this.elem),this.cleanCircle()},a.prototype.cleanCircle=function(){this.anchor.forEach(function(a){a.elem.parentNode&&a.removeFromParent()})},a.prototype.getRectOrigin=function(){return this.rectOrigin},a.prototype.fixSide=function(a){this.anchor[0].elem===a&&(this.rectOrigin.left=!0)},a}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseSelectChord",[function(){"use strict";function a(a,b,c,d){var e=d.svgTools;this.elem=a,this.pos=b,this.color=c,this.type="chord",this.colorElem(a),this.mea=e.findParent(a,"measure"),this.topPos=e.getTopPosition(this.mea);var f=e.findParent(a,"measure");this.chordIdx=e.getPosition(f,a,"chord")}return a.prototype.cleanUp=function(){this.cleanElem(this.elem)},a.prototype.remove=function(){},a.prototype.colorElem=function(a){a.style.fill=this.color,a.style.stroke=this.color},a.prototype.cleanElem=function(a){a.style.fill="",a.style.stroke=""},a}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseSelectWord",[function(){"use strict";function a(a,b,c,d){this.elem=a,this.pos=b,this.color=c,this.type="word",this.colorElem(a);var e=d.svgTools,f=d.dataReader;this.mea=e.findParent(a,"measure"),this.wordIdx=e.getPosition(this.mea,a,"word"),this.topPos=e.getTopPosition(this.mea),this.topPos.wordIdx=this.wordIdx,this.data=f.data.getWordData(this.topPos),this.data.idx=this.wordIdx}return a.prototype.cleanUp=function(){this.cleanElem(this.elem)},a.prototype.remove=function(){},a.prototype.colorElem=function(a){a.style.fill=this.color,a.style.stroke=this.color},a.prototype.cleanElem=function(a){a.style.fill="",a.style.stroke=""},a}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseSelectLyric",[function(){
"use strict";function a(a,b,c,d){this.elem=a,this.pos=b,this.color=c,this.type="lyricLine",this.colorElem(a),this.mea=d.svgTools.findParent(a,"measure")}return a.prototype.cleanUp=function(){this.cleanElem(this.elem)},a.prototype.remove=function(){},a.prototype.colorElem=function(a){a.style.fill=this.color,a.style.stroke=this.color},a.prototype.cleanElem=function(a){a.style.fill="",a.style.stroke=""},a}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseSelectNote",[function(){"use strict";function a(a,b,c,d){this.elem=a,this.pos=b,this.color=c,this.interaction=d,this.measure=d.svgTools.findParent(a,"measure")}return a.prototype.cleanUp=function(){this.cleanElem(this.elem)},a.prototype.cleanElem=function(){},a.prototype.remove=function(a){this.interaction.lookupEraseRest(a)},a}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseSelectTempoChange",[function(){"use strict";function a(a,b,c,d){this.elem=a,this.pos=b,this.color=c,this.interaction=d,this.anchor=[],this.rectOrigin={},this.anchor[0]=new Adagio.Brush.Elem("circle"),this.anchor[1]=new Adagio.Brush.Elem("circle"),this.anchor.forEach(function(a){a.attr("r",6),a.attr("style","fill: none; stroke-width: 3px; opacity: 1"),a.attr("class","tempo-anchor")},this);var e=a.getBBox();this.anchor[0].attr("transform","translate("+e.x+", "+(e.y+e.height/2)+")"),this.anchor[1].attr("transform","translate("+(e.x+e.width)+", "+(e.y+e.height/2)+")"),this.anchor.forEach(function(a){this.elem.appendChild(a.node())},this);var f=d.svgTools,g=d.dataReader,h=f.findParent(a,"staff"),i=f.findGoodPage(b.partIdx,b.measureIdx),j=f.getPosition(h,a,"tempoChange"),k=g.data.getMeasuresRangeTempoChangesData({partIdx:b.partIdx,startMeasureIdx:i.nbstart,stopMeasureIdx:i.nbstart+i.nbMea-1,voiceIdx:g.convertVoiceIdx(b).voiceIdx,staffIdx:b.staffIdx}),l=k[j];this.pos.timePos=l.startTimePos,this.pos.dpq=l.startDpq,this.pos.measureIdx=l.startMeasureIdx,this.rectOrigin.posLeft={measureIdx:l.startMeasureIdx,noteIdx:l.startNoteIdx,voiceIdx:l.startVoiceIdx},this.rectOrigin.posRight={measureIdx:l.stopMeasureIdx,noteIdx:l.stopNoteIdx-1,voiceIdx:l.stopVoiceIdx},this.rectOrigin.type=l.type,this.colorElem(a)}return a.prototype.remove=function(){this.interaction.RemoveTempoChangeAtTimePos(this.pos)},a.prototype.colorElem=function(a){a.style.fill=this.color,a.style.stroke=this.color},a.prototype.cleanElem=function(a){a.style.fill="",a.style.stroke=""},a.prototype.cleanUp=function(){this.cleanElem(this.elem),this.cleanCircle()},a.prototype.cleanCircle=function(){this.anchor.forEach(function(a){a.elem.parentNode&&a.removeFromParent()})},a.prototype.getRectOrigin=function(){return this.rectOrigin},a.prototype.fixSide=function(a){this.anchor[0].elem===a&&(this.rectOrigin.left=!0)},a}]),angular.module("flat.editor.services").factory("flat.editor.services.MouseSelectMetronome",["$timeout",function(a){"use strict";function b(b,c,d,e){a(e.openModal.bind(e,"tempo"))}return b.prototype.cleanUp=function(){},b.prototype.cleanElem=function(){},b.prototype.remove=function(){},b}]),angular.module("flat.editor.services").factory("flat.editor.services.Mousemove",[function(){"use strict";function a(a,b){this.interaction=a,this.dataReader=a.dataReader,this.svgTools=a.svgTools,this.domCache=a.domCache,this.cursor=b}return a.prototype.move=function(a){this.domCache.checkMeasureCache(a);var b=this.svgTools.findNearestNoteX(a,this.domCache.cacheMeasure.measure,this.interaction.voiceIdx);if("undefined"!=typeof b){var c=this.svgTools.getClosestHead(a,b),d=this.svgTools.findInformation(a,b),e=this.interaction.noteInfo,f=!1,g={pos:d,save:c};if(this.svgTools.correctTab(d),this.dataReader.validateData(d),this.dataReader.checkVoice(d),"note"===this.interaction.mode&&this.interaction.rightsHandler.categoryState.score_write){if(this.dataReader.comparePos(this.interaction.posLeft,d)&&(e=this.interaction.noteInfoLeft,f=!0),(f||this.interaction.cursor.samePos(d))&&null===this.dataReader.getTabsAtString(e,d.string)&&null===this.dataReader.getNoteAtLine(e,d.line)){if("drum"===this.interaction.currentStyle){this.domCache.checkCacheHead(d);var h=this.drawDrumCursor(d,g.save);return h?(g.save=h,g):g}return"undefined"!=typeof d.string?(g.save=this.drawStringCursor(d,g.save),g):(g.save=this.drawClassicCursor(d,g.save),g)}return this.cursor.removeCursor(),g.norm=!0,g}if(this.cursor.removeCursor(),c&&this.svgTools.isPointInsideElem(a,g.save,2))return g.norm=!0,g}},a.prototype.drawDrumCursor=function(a,b){if("undefined"!=typeof this.domCache.cacheHeads[a.partIdx]){var c,d;if(1===this.domCache.cacheHeads[a.partIdx].nbStaffLines&&Object.keys(this.domCache.cacheHeads[a.partIdx].pitchMapping).length<2&&(a.line=a.closeLine),c=Adagio.Utils.drumsetUtils.lineToPitch(a.line,this.domCache.cacheHeads[a.partIdx].nbStaffLines),d=Adagio.Utils.unpitchedUtils.stringify(c),"undefined"!=typeof this.domCache.cacheHeads[a.partIdx].pitchMapping[d])return b="undefined"==typeof a.graceIdx?this.cursor.drawPercuCursor(this.dataReader.convertVoiceIdx(a),{line:a.line,durationType:this.interaction.noteInfo.durationType,notehead:this.domCache.cacheHeads[a.partIdx].pitchMapping[d].default}):this.cursor.drawGracePercuCursor(this.dataReader.convertVoiceIdx(a),{line:a.line,durationType:this.interaction.noteInfo.durationType,notehead:this.domCache.cacheHeads[a.partIdx].pitchMapping[d].default}),b.elem;this.cursor.removeCursor()}},a.prototype.drawStringCursor=function(a,b){var c=this.dataReader.convertVoiceIdx(a);return c.fretData={string:a.string,fret:0},b=this.cursor.drawTabCursorByFret(c,this.interaction.noteInfo.durationType,this.interaction.noteInfo.nbDots),b.elem.getElementsByTagName("path")[0]},a.prototype.drawClassicCursor=function(a){return"undefined"!=typeof a.graceIdx&&null!==a.graceIdx?this.cursor.drawGraceCursor(this.dataReader.convertVoiceIdx(a),this.interaction.noteInfo.durationType).elem:this.cursor.drawNoteCursor(this.dataReader.convertVoiceIdx(a),this.interaction.noteInfo.durationType).elem},a}]),angular.module("flat.editor.services").factory("flat.editor.services.PosBuilder",[function(){"use strict";function a(a,b){this.interaction=a,this.domCache=a.domCache,this.mouseSelected=b,this.oldLeftPos=this.mouseSelected.rectOrigin.posLeft,this.oldRightPos=this.mouseSelected.rectOrigin.posRight,this.oldPos=angular.copy(this.mouseSelected.pos),delete this.oldPos.line,delete this.oldPos.closeLine}return a.prototype.buildOpt=function(a,b){var c={partIdx:this.mouseSelected.pos.partIdx,staffIdx:this.mouseSelected.pos.staffIdx};return b.left?(c.startNoteIdx=a.noteIdx,c.startMeasureIdx=a.measureIdx,c.stopMeasureIdx=b.posRight.measureIdx,c.stopNoteIdx=b.posRight.noteIdx+1,c.startVoiceIdx=this.interaction.dataReader.convertVoiceIdx(a).voiceIdx,c.stopVoiceIdx=b.posRight.voiceIdx):(c.startMeasureIdx=b.posLeft.measureIdx,c.startNoteIdx=b.posLeft.noteIdx,c.stopNoteIdx=a.noteIdx+1,c.stopMeasureIdx=a.measureIdx,c.startVoiceIdx=b.posLeft.voiceIdx,c.stopVoiceIdx=this.interaction.dataReader.convertVoiceIdx(a).voiceIdx),c},a.prototype.translatePos=function(a){this.domCache.checkMeasureCache(a);var b,c=this.interaction.dataReader,d=this.interaction.svgTools.findNearestNoteX(a,this.domCache.cacheMeasure.measure),e=this.interaction.svgTools.findInformation(a,d);if(this.interaction.svgTools.correctTab(e),this.interaction.dataReader.checkVoice(e),e.partIdx!==this.oldPos.partIdx||e.staffIdx!==this.oldPos.staffIdx)return this.oldPos;delete e.closeLine,delete e.elem;var f=this.interaction.dataReader.data.compareNotesTimePos(c.convertVoiceIdx(this.oldPos),c.convertVoiceIdx(e));return this.oldPos=angular.copy(e),f<0?(e.measureIdx=this.oldLeftPos.measureIdx,e.noteIdx=this.oldLeftPos.noteIdx,e.voiceIdx=this.oldLeftPos.voiceIdx,b=c.data.getClosestRightNote(e),this.oldLeftPos={measureIdx:b.measureIdx,noteIdx:b.noteIdx,voiceIdx:b.voiceIdx},e.measureIdx=this.oldRightPos.measureIdx,e.noteIdx=this.oldRightPos.noteIdx,e.voiceIdx=this.oldRightPos.voiceIdx,b=c.data.getClosestRightNote(e),null!==b&&(this.oldRightPos={measureIdx:b.measureIdx,noteIdx:b.noteIdx,voiceIdx:b.voiceIdx})):f>0&&(e.measureIdx=this.oldLeftPos.measureIdx,e.noteIdx=this.oldLeftPos.noteIdx,e.voiceIdx=this.oldLeftPos.voiceIdx,b=c.data.getClosestLeftNote(e),null!==b&&(this.oldLeftPos={measureIdx:b.measureIdx,noteIdx:b.noteIdx,voiceIdx:b.voiceIdx}),e.measureIdx=this.oldRightPos.measureIdx,e.noteIdx=this.oldRightPos.noteIdx,e.voiceIdx=this.oldRightPos.voiceIdx,b=c.data.getClosestLeftNote(e),this.oldRightPos={measureIdx:b.measureIdx,noteIdx:b.noteIdx,voiceIdx:b.voiceIdx}),this.oldPos},a.prototype.buildPos=function(a){var b={partIdx:a.partIdx,staffIdx:a.staffIdx};return b.startMeasureIdx=this.oldLeftPos.measureIdx,b.startNoteIdx=this.oldLeftPos.noteIdx,b.startVoiceIdx=this.oldLeftPos.voiceIdx,b.stopMeasureIdx=this.oldRightPos.measureIdx,b.stopNoteIdx=this.oldRightPos.noteIdx+1,b.stopVoiceIdx=this.oldRightPos.voiceIdx,b},a}]),function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(){return $("#"+C.containerId+" .page:not(#export)").length}function j(a,b){var c={composer:{"font-family":"Noto Serif"},copyrights:{"font-family":"Noto Serif"},harmonyText:{"font-family":"Noto Serif"},lyric:{"font-family":"Noto Serif"},lyricist:{"font-family":"Noto Serif"},measureNumber:{"font-family":"Noto Serif"},pageNumber:{"font-family":"Noto Serif"},partName:{"font-family":"Noto Serif"},pizzicato:{"font-family":"Noto Serif"},rehearsalText:{"font-family":"Noto Serif"},subtitle:{"font-family":"Noto Serif"},tempo:{"font-family":"Noto Serif"},title:{"font-family":"Noto Serif"},word:{"font-family":"Coming Soon"},isConcertPitch:a.isConcertPitch};if(a=a||{},1===C.data.getNbParts())c.displayOtherLinesPartsNames=!1;else if(2===C.data.getNbParts()){var d=C.data.getPartContent(0),e=C.data.getPartContent(1),f=Adagio.Utils.partContentUtils.getNbStaves(d),h=Adagio.Utils.partContentUtils.getNbStaves(e);c.displayOtherLinesPartsNames=f===h}else c.displayOtherLinesPartsNames=!0;if(a.exportBranding){var i="Sheet music created online using Flat (https://flat.io)";c.logoFontJson={glyphs:{"small-flat-logo":{bBoxNE:[4,4],bBoxSW:[0,0],description:"small-flat-logo",path:g.flatLogoPath}},fontName:"FlatLogo",fontVersion:1,meta:{"units-per-em":"1024"}},b?(Adagio.settings.PrintValues.RIGHTS_FONTSIZE=12,b["action.SetRights"]({rights:i})):c.footerBrandingText=i}return c.mergeEmptyMeasures=!!a.multiMeasuresRests,c.hideNonTab=!!a.hideNonTab,c.hideTempo=!!a.hideTempo,c}function k(){var a=new Adagio.Brush.Elem("svg","page");return a.attr("id",C.pageClass),a}function l(a){var b=k();if(Adagio.setDocument(window.document),C.element=$("#"+C.containerId),!C.data.hasPageSize()){var c=h.userPreset(),d=h.userToPreferences(c[0],c[1]);C.data.setScaling(6.35,40),C.data.setPageSizeAsMillimeters(d.width,d.height),C.data.setPageTopMarginMillimeters(10*h.userMargin("Top"),"both"),C.data.setPageBottomMarginMillimeters(10*h.userMargin("Bottom"),"both"),C.data.setPageLeftMarginMillimeters(10*h.userMargin("Left"),"both"),C.data.setPageRightMarginMillimeters(10*h.userMargin("Right"),"both")}C.element.append(b.node()),C.textmetrics=new Adagio.Drawer.CachedTextMetric(b.node()),C.pageLayout=new Adagio.page.PageLayout(C.data,72,C.textmetrics,Adagio.assets.smufl.bravura,j(C.exportOptions,C.data)),C.updater=new Adagio.updater.page.PageDisplayUpdater(C.data,C.pageLayout),f(angular.noop),m({firstRender:!0,svg:b},a)}function m(a,b){var c=a.svg,d=0;!function a(){g.updateProgressTooltip(d+1,i()),C.pageLayout.hasRemaining()&&((d>0||!c)&&(c=k(),C.element.append(c.node())),C.pageLayout.fillNextPage(c),C.svg.push(c),d++),f(angular.noop),f(function(){return r(),C.pageLayout.hasRemaining()?void a():b()})}()}function n(a){for(var b=C.data.score["score-partwise"]["part-list"]["score-part"].length-1;b>=0;b--)if(a.indexOf(b)<0)try{C.data["action.RemovePart"]({partIdx:b,recordContent:!1})}catch(a){e.error(a,"adagio")}}function o(a,b,c){A=a,C.exportOptions=b,B=c,C.data=new Adagio.Data(A.adagioData.exportData()),C.exportOptions.parts&&n(C.exportOptions.parts),p().then(function(){l(q)})}function p(){y=new PDFDocument({info:u(A),autoFirstPage:!1}),z=y.pipe(blobStream()),y.font("Times-Roman");var a=b.defer();d.get("../fonts/notoserif-933357819c8cce88b6f80348ce2387380adf7c84.ttf",{responseType:"arraybuffer"}).then(function(b){y.font(b.data,"Noto Serif"),a.resolve()}).catch(function(){a.resolve()});var c=b.defer();return d.get("../fonts/comingsoon-273721356c876c9ece0411fcac9b23638a0e5793.ttf",{responseType:"arraybuffer"}).then(function(a){y.font(a.data,"Coming Soon"),c.resolve()}).catch(function(){c.resolve()}),b.all([c.promise,a.promise])}function q(){y.end(),z.on("finish",function(){$("#"+C.containerId+" .page#"+C.pageClass).remove();var a="application/pdf",b=this.toBlobURL(a),c=this.toBlob(a);B&&B(null,b,c)})}function r(){var a=$("#"+C.containerId+" .page#"+C.pageClass),b=a.length,c=1===b;if(a&&b>0){var d=$(a[b-1]);g.addPage(y,d),s(d),$("#"+C.containerId+" .page.toRemove").remove(),c||d.addClass("toRemove")}}function s(b){var c=$(b),d=t(c);if(d.length){var e,f;for(y.save(),e=0;e<F.length;e++)for(f=0;f<F[e].length;f++)y=y[F[e][f][0]].apply(y,F[e][f][1]);var g=x(c);for(e=0;e<g.length;e++)y=y[g[e][0]].apply(y,g[e][1]);for(e=0;e<d.length;e++)y=y[d[e][0]].apply(y,d[e][1]);y.restore()}a.forEach(c.children(),function(a){s(a)}),"g"===c.prop("nodeName")&&w(c)}function t(b){var c,d=b.prop("nodeName");if(d&&d.length){var f=a.at(E,d).pop();f?c=f(b):"svg"!==d&&e.error(new Error('[AdagioToPDF] func "'+d+'" not found'),"pdfkit")}return c||[]}function u(a){return{Producer:"Flat (https://flat.io)",Title:a.title,Creator:a.user,ModDate:a.dateModification}}function v(a){var b=x(a);b.length>0&&F.push(b)}function w(a){x(a).length>0&&F.pop()}function x(a){var b=[],c=a.attr("transform");if(c&&c.length){var d=g.getFunctionsFromString(c);if(d.length){var e=g.transformsToString(d);e.length&&(b=e)}}return b}var y,z,A,B,C={data:[],svg:[],exportOptions:{},containerId:"svg-content > div",pageClass:"export"},D={generate:o},E={g:v,path:g.addPath,text:g.addText,line:g.addLine,rect:g.addRect,polygon:g.addPolygon,circle:g.addCircle},F=[];return D}angular.module("flat.editor.services").factory("flat.editor.services.PDFKit",a),a.$inject=["_","$q","$rootScope","$http","$log","$timeout","flat.editor.services.PDFKitUtils","flat.editor.services.PageLayout"]}(),function(){"use strict";function a(a){function b(a,b){s.current=a,b&&(s.max=b);var c=$(".toolbar-icon-exporting + .tooltip .tooltip-inner");if(c&&c.length){c.html(i18n.t("flat:score.export.as_pdf.tt_generating")+": "+s.current);var d=c.width/2*-1;c.css("left",d)}}function c(a,b){var c=k(b),d={};return c.width&&c.width.length&&c.height&&c.height.length&&(d.size=[Number(c.width),Number(c.height)]),a.addPage(d),a}function d(a){var b=[],c=a.attr("d");return c&&c.length&&b.push(["path",[c]],["fill",["black"]]),b}function e(a){var b=[],c=a.text().replace("♭","b"),d=k(a),e=d["font-family"]||d["FONT-FAMILY"],f=d["font-size"]||d["FONT-SIZE"],g="italic"===(d["font-style"]||d["FONT-STYLE"]),h=d["text-anchor"]||d["TEXT-ANCHOR"],i=$(a)[0].getBoundingClientRect();return c&&c.length&&("middle"===h?b.push(["translate",[-i.width/2,-i.height/100*75]]):"end"===h?b.push(["translate",[-i.width,-i.height/100*75]]):b.push(["translate",[0,-i.height/100*75]]),f&&length&&b.push(["fontSize",[f]]),g&&length?b.push(["font",["Times-Italic"]]):(["Coming Soon","Noto Serif"].indexOf(e)<0&&(e="Noto Serif"),b.push(["font",[e]])),b.push(["text",[c,0,0]])),b}function f(a){var b=[],c=k(a),d=c["stroke-width"]||c["STROKE-WIDTH"];if(c.x1&&c.x1.length&&c.y1&&c.y1.length&&c.x2&&c.x2.length&&c.y2&&c.y2.length){if(d&&d.length&&b.push(["lineWidth",[d]]),b.push(["lineCap",["butt"]],["moveTo",[c.x1,c.y1]],["lineTo",[c.x2,c.y2]]),c["stroke-dasharray"]&&c["stroke-dasharray"].length>0){var e=c["stroke-dasharray"].split(",");2===e.length&&b.push(["dash",[e[0],{space:e[1]}]])}b.push(["stroke",[]])}return b}function g(a){var b=[],c=k(a);if("rect-mea"!==c.class&&c.width&&c.width.length&&c.height&&c.height.length&&(b.push(["rect",[0,0,c.width,c.height]]),c.style&&c.style.length)){var d=c.style.split("fill: ")[1];if(d&&d.length){var e=d.split(";")[0];if(e&&e.length){var f;f="#"===e[0]?e:j(e),b.push(["fill",[f]])}}}return b}function h(a){var b=[],c=k(a);if(c.points){c.points=c.points.trim();var d=c.points.split(" ");if(d.length>0){for(var e=0;e<d.length;e++){d[e]=d[e].split(",");for(var f=0;f<d[e].length;f++)d[e][f]=parseFloat(d[e][f])}b.push(["polygon",d],["fill",["black"]])}}return b}function i(a){var b=[],c=k(a);return b.push(["circle",[parseFloat(c.cx),parseFloat(c.cy),parseFloat(c.r)]],["fill",["black"]]),b}function j(a){return a=a.match(p),a&&4===a.length?"#"+("0"+parseInt(a[1],10).toString(16)).slice(-2)+("0"+parseInt(a[2],10).toString(16)).slice(-2)+("0"+parseInt(a[3],10).toString(16)).slice(-2):""}function k(b){var c={};return b[0]&&(b=b[0]),a.forEach(b.attributes,function(a){c[a.name]=a.value.split("px")[0]}),c}function l(b){var c=[];if(b&&b.length){var d=b.match(n);a.forEach(d,function(b){var d={},e=b.match(o);3===e.length&&(d.name=e[1],d.args=a.map(e[2].split(" "),function(a){return parseFloat(a.replace(",","").trim())}),"translate"===d.name&&1===d.args.length&&d.args.push(0),c.push(d))})}return c}function m(b){var c=[];return a.forEach(b,function(b){var d=a.indexOf(r,b.name);d>=0&&("scale"===b.name?c.push([b.name,[a.max(b.args)]]):c.push([b.name,b.args]))}),c}var n=/\w+\s*\(.+?\)/g,o=/(\w+)\s*\((.+),?\)/i,p=/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i,q="M963,490C938,507,904,499,888,473C888,473,643,85,643,85C627,60,634,26,659,9C684,-8,718,-0,734,26C734,26,979,414,979,414C995,439,988,473,963,490C963,490,963,490,963,490M852,682C827,699,793,691,778,666C778,666,411,85,411,85C395,60,402,26,427,9C452,-8,486,-0,502,26C502,26,869,606,869,606C885,632,878,666,853,683C853,683,852,682,852,682M831,1015C805,1032,772,1024,756,999C756,999,179,85,179,85C162,60,170,25,195,9C220,-8,253,-0,270,25C270,25,847,939,847,939C863,964,856,999,831,1015C831,1015,831,1015,831,1015M246,356C246,356,615,939,615,939C631,964,624,999,598,1015C573,1032,539,1024,523,999C523,999,155,416,155,416C139,390,146,356,171,340C197,323,230,331,246,356C246,356,246,356,246,356M366,1015C341,1032,307,1024,291,999C291,999,46,611,46,611C29,585,37,551,62,534C87,518,121,525,137,551C137,551,382,939,382,939C398,964,391,999,366,1015C366,1015,366,1015,366,1015",r=["translate","rotate","scale"],s={current:0,max:0},t={flatLogoPath:q,addPage:c,addPath:d,addText:e,addLine:f,addRect:g,addPolygon:h,addCircle:i,updateProgressTooltip:b,getFunctionsFromString:l,transformsToString:m};return t}angular.module("flat.editor.services").factory("flat.editor.services.PDFKitUtils",a),a.$inject=["_"]}(),angular.module("flat.editor.services").factory("flat.editor.services.PageLayout",["$rootScope",function(a){"use strict";var b={preset:{"US Letter":{height:216,width:279},Tabloid:{height:279,width:432},"US Legal":{height:216,width:356},A2:{height:420,width:594},A3:{height:297,width:420},A4:{height:210,width:297},A5:{height:148,width:210},B5:{height:176,width:250}},presetOrder:["US Letter","Tabloid","US Legal","A2","A3","A4","A5","B5"],userUnit:function(){if(a.account){if(a.account.editorPreferences&&a.account.editorPreferences.lengthUnit)return a.account.editorPreferences.lengthUnit;if("us"===a.account.country)return"inch"}return"cm"},mmToUser:function(a){return"cm"===b.userUnit()?a/10:Math.round(3.937007874*a)/100},mmToUserDisplay:function(a){return a=b.mmToUser(a),"cm"===b.userUnit()?a+"cm":a+'"'},userToMm:function(a){return"cm"===b.userUnit()?10*a:25.4*a},userToPreferences:function(c,d){if("custom"===c&&a.account.editorPreferences)c={height:a.account.editorPreferences.pageHeight,width:a.account.editorPreferences.pageWidth};else if(c=b.preset[c],!c)return null;return"landscape"===d?c:{height:c.width,width:c.height}},sizeToPreset:function(a,c){for(var d in b.preset)if(b.preset.hasOwnProperty(d)){if(a===b.preset[d].height&&c===b.preset[d].width)return[d,"landscape"];if(c===b.preset[d].height&&a===b.preset[d].width)return[d,"portrait"]}return["custom","portrait"]},presetsToUser:function(){var a,c=[];for(var d in b.presetOrder)b.presetOrder.hasOwnProperty(d)&&(d=b.presetOrder[d],a=b.preset[d],a&&c.push({id:d,label:d+" ("+b.mmToUserDisplay(a.height)+" x "+b.mmToUserDisplay(a.width)+")"}));return c},defaultPreset:function(){return"us"===a.account.country?"US Letter":"A4"},defaultHeight:function(){return b.preset[b.defaultPreset()].height},defaultWidth:function(){return b.preset[b.defaultPreset()].width},defaultMargin:17.2,userPreset:function(){return a.account&&a.account.editorPreferences&&a.account.editorPreferences.pageHeight?b.sizeToPreset(a.account.editorPreferences.pageHeight,a.account.editorPreferences.pageWidth):[b.defaultPreset(),"portrait"]},userMargin:function(c){return a.account&&a.account.editorPreferences&&a.account.editorPreferences["pageMargin"+c]?b.mmToUser(a.account.editorPreferences["pageMargin"+c]):b.mmToUser(b.defaultMargin)}};return b}]),angular.module("flat.editor.services").factory("flat.editor.services.RangeSelect",["$rootScope",function(a){"use strict";function b(a){this.firstPos=null,this.secondPos=null,this.inverse=!1,this.rect=[],this.interaction=a,this.svgTools=a.svgTools,this.color=a.colorSelection||"#B0D7FE"}var c="M19 24c-.458 0-.903-.04-1.336-.11L18 24l-3 1.5V23l.372.12C13.352 22.07 12 20.17 12 18c0-3.31 3.134-6 7-6s7 2.69 7 6-3.134 6-7 6zm0-13c-4.42 0-8 3.13-8 7 0 2.21 1.173 4.18 3 5.46V27l4.097-2.05c.297.03.597.05.903.05 4.418 0 8-3.13 8-7s-3.582-7-8-7zm3.5 5h-7c-.276 0-.5.22-.5.5s.224.5.5.5h7c.276 0 .5-.22.5-.5s-.224-.5-.5-.5zm-1 3h-5c-.276 0-.5.22-.5.5s.224.5.5.5h5c.276 0 .5-.22.5-.5s-.224-.5-.5-.5z";return b.prototype.selectRange=function(b){(null===this.firstPos||b.staffIdx===this.firstPos.staffIdx&&b.partIdx===this.firstPos.partIdx)&&(null===this.firstPos?(this.firstPos=b,this.secondPos=b):!this.inverse&&(this.firstPos.measureIdx<b.measureIdx||this.firstPos.measureIdx===b.measureIdx&&this.firstPos.noteIdx<=b.noteIdx)?(this.secondPos=b,this.inverse=!1):this.inverse&&(this.secondPos.measureIdx<b.measureIdx||this.secondPos.measureIdx===b.measureIdx&&this.secondPos.noteIdx<b.noteIdx)?(this.inverse=!1,this.firstPos=angular.copy(this.secondPos),this.secondPos=b):(this.inverse||(this.secondPos=angular.copy(this.firstPos)),this.firstPos=b,this.inverse=!0),this.refresh(),a.$broadcast("Range.Selected",{from:{partIdx:this.firstPos.partIdx,measureIdx:this.firstPos.measureIdx,staffIdx:this.firstPos.staffIdx,voiceIdx:this.firstPos.voiceIdx,noteIdx:this.firstPos.noteIdx},to:{partIdx:this.secondPos.partIdx,measureIdx:this.secondPos.measureIdx,staffIdx:this.secondPos.staffIdx,voiceIdx:this.secondPos.voiceIdx,noteIdx:this.secondPos.noteIdx}}))},b.prototype.reset=function(){(this.firstPos||this.secondPos)&&(this.firstPos=null,this.secondPos=null,this.cleanRect(),this.rect=[],this.interaction.closeInlinePopover())},b.prototype.refresh=function(){this.cleanRect();for(var a=this.buildPos(),b=0;b<a.length;b++){var c=this.svgTools.getNote(a[b].left),d=this.svgTools.getNote(a[b].right);this.calcRect(c,d,b,a[b].last)}},b.prototype.bindIcon=function(){if(this.canComment&&this.rect.length){var a=this.rect[this.rect.length-1];if(this.icon){var b=this.svgTools.findParent(a.node(),"staff");b.appendChild(this.icon.node())}else this.createIcon(a);var c=a.node().getBBox();this.icon.attr("transform","translate("+(c.width+a.xTrans)+", "+a.yTrans+")")}},b.prototype.createIcon=function(a){var b=this.svgTools.findParent(a.node(),"staff");this.icon=new Adagio.Brush.Elem("g");var d=new Adagio.Brush.Elem("circle"),e=new Adagio.Brush.Elem("path");this.icon.append(d),this.icon.append(e),e.attr("d",c),b.appendChild(this.icon.node());var f=e.node().getBBox();d.attr("id","inline-comment-icon-container"),d.attr("r",16).attr("fill","white");var g=-f.x-f.width/2,h=-f.y-f.height/2;e.attr("transform","translate("+g+", "+h+")"),e.attr("fill","#858FA9"),e.attr("class","range-inline-comment-icon"),this.icon.node().addEventListener("click",function(){this.interaction.openInlinePopover()}.bind(this),!0)},b.prototype.cleanRect=function(){this.rect.length&&this.rect.forEach(function(a){this.svgTools.isStillInDom(a.node())&&a.removeFromParent()}.bind(this)),this.rect=[],this.icon&&this.svgTools.isStillInDom(this.icon.node())&&this.icon.removeFromParent()},b.prototype.buildPos=function(){for(var a,b=[],c=this.svgTools,d=0;d<c.info.length;d++)for(var e=0;e<c.info[d].shards.length;e++){if(c.info[d].shards[e].startMeasureIdx<=this.firstPos.measureIdx&&c.info[d].shards[e].startMeasureIdx+c.info[d].shards[e].nbMeasures-1>=this.secondPos.measureIdx)return b.push({left:angular.copy(this.firstPos),right:angular.copy(this.secondPos)}),b;if(c.info[d].shards[e].startMeasureIdx<=this.firstPos.measureIdx&&c.info[d].shards[e].startMeasureIdx+c.info[d].shards[e].nbMeasures-1>=this.firstPos.measureIdx&&c.info[d].shards[e].startMeasureIdx+c.info[d].shards[e].nbMeasures-1<this.secondPos.measureIdx&&0===b.length)a={left:{partIdx:this.firstPos.partIdx,staffIdx:this.firstPos.staffIdx,voiceIdx:this.firstPos.voiceIdx,measureIdx:this.firstPos.measureIdx,noteIdx:this.firstPos.noteIdx},right:{partIdx:this.firstPos.partIdx,staffIdx:this.firstPos.staffIdx,voiceIdx:this.firstPos.voiceIdx,measureIdx:c.info[d].shards[e].startMeasureIdx+c.info[d].shards[e].nbMeasures-1},last:!0},this.dataReader.checkVoice(a.right),a.right.noteIdx=this.dataReader.getNbNotes(a.right)-1,b.push(a);else if(c.info[d].shards[e].startMeasureIdx>=this.firstPos.measureIdx&&c.info[d].shards[e].startMeasureIdx+c.info[d].shards[e].nbMeasures-1<this.secondPos.measureIdx&&b.length>0)a={left:{partIdx:this.firstPos.partIdx,staffIdx:this.firstPos.staffIdx,voiceIdx:this.firstPos.voiceIdx,measureIdx:c.info[d].shards[e].startMeasureIdx,noteIdx:0},right:{partIdx:this.firstPos.partIdx,staffIdx:this.firstPos.staffIdx,voiceIdx:this.firstPos.voiceIdx,measureIdx:c.info[d].shards[e].startMeasureIdx+c.info[d].shards[e].nbMeasures-1},last:!0},this.dataReader.checkVoice(a.right),a.right.noteIdx=this.dataReader.getNbNotes(a.right)-1,b.push(a);else if(c.info[d].shards[e].startMeasureIdx>this.firstPos.measureIdx&&c.info[d].shards[e].startMeasureIdx+c.info[d].shards[e].nbMeasures-1>=this.secondPos.measureIdx)return b.push({left:{partIdx:this.firstPos.partIdx,staffIdx:this.firstPos.staffIdx,voiceIdx:this.firstPos.voiceIdx,measureIdx:c.info[d].shards[e].startMeasureIdx,noteIdx:0},right:angular.copy(this.secondPos)}),b}return b},b.prototype.getRange=function(){if(!this.firstPos||!this.secondPos)return null;var a=angular.copy(this.firstPos),b=angular.copy(this.secondPos);return this.svgTools.correctTab(a),this.svgTools.correctTab(b),{partIdx:this.firstPos.partIdx,staffIdx:this.firstPos.staffIdx,startMeasureIdx:this.firstPos.measureIdx,startVoiceIdx:this.dataReader.convertVoiceIdx(a).voiceIdx,startNoteIdx:this.firstPos.noteIdx,stopMeasureIdx:this.secondPos.measureIdx,stopVoiceIdx:this.dataReader.convertVoiceIdx(b).voiceIdx,stopNoteIdx:this.secondPos.noteIdx}},b.prototype.calcRect=function(a,b,c,d){var e=this.svgTools,f=e.getCoord(a.note),g=e.getCoord(a.mea),h=e.getCoord(a.staff),i=e.extractChild(a.staff,"staffLines",0);i=i.getElementsByTagName("line").length;var j=(i-1)*e.spaceLine;j+=4*e.spaceLine,j/=e.scaling;var k=this.getWidth(a,b,d)/e.scaling;this.rect[c]=new Adagio.Brush.Elem("g");var l=(g.relative.x-h.relative.x+f.relative.x-g.relative.x-e.spaceLine)/e.scaling,m=-a.mea.getBBox().y+a.staff.getBBox().y-e.spaceLine/e.scaling*2;this.rect[c].attr("transform","translate("+l+", "+m+")"),this.rect[c].xTrans=l,this.rect[c].yTrans=m;var n=new Adagio.Brush.Elem("rect");n.attr("width",k).attr("height",j).attr("rx",2).attr("fill",this.color).style("mix-blend-mode","darken"),this.rect[c].append(n),a.staff.insertBefore(this.rect[c].node(),a.staff.firstChild)},b.prototype.getWidth=function(a,b,c){var d,e,f,g=this.svgTools;return a.note===b.note?d=a.note.getBBox().width*g.scaling:c?(e=g.getCoord(a.note),f=g.getCoord(b.mea),d=f.relative.x-e.relative.x+b.mea.getBBox().width*g.scaling):(e=g.getCoord(a.note),f=g.getCoord(b.note),d=f.relative.x-e.relative.x+b.note.getBBox().width*g.scaling),d+2*g.spaceLine},b}]),angular.module("flat.editor.services").factory("flat.editor.services.RealTime",["$rootScope","$log","$cookies","$sce","$window","$timeout","$location","TokenHandler","MessageService","UserV2","ScoreRevisionV2","ScoreRevisionIDB","flat.editor.services.CancelStack",function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=function(c,e,n){this.rt=null,this.focus=!0,this.onceDataCallbacks={},this.revisionId=null,this.collaborators=e,this.interaction=n;var o=this.collaborators.collaborators[a.account.id];if(this.isCollaborator=o&&!o._frontendOnly,this.score=c,c.connecting||c.connected)return!1;b.log("[rt] init"),c.connecting=!0,c.connected=!1,c.saving=!1,this.onceDataCallbacks={},this.hadCriticalError=!1;var p=!0;"serviceWorker"in navigator&&navigator.serviceWorker.controller&&(p=!1),this.rt=new FlatRt({endpoint:rtapibaseurl,access_token:h.get(),scoreId:this.score.id,sharingKey:this.score.sharingKey,revisionId:a.history.masterRevision,accountId:a.account.id||"guest",exclusiveConnection:p},{getData:function(a,c){return this.data&&a===this.revisionId?(b.debug("returning data for ",a," right away"),c(this.data,m.onlineStack)):(b.debug("adding callback to list for revId",a," (currently "+this.revisionId+")"),this.onceDataCallbacks[a]||(this.onceDataCallbacks[a]=[]),this.onceDataCallbacks[a].push(c),void 0)}.bind(this)}),this.rt.on("connect",function(){this.keepLastEvent("online"),c.connected=!0,this.score.connecting=!1,a.$broadcast("Realtime.Online"),this.interaction.rightsHandler.setValue("online",!0)}.bind(this)),this.rt.on("error",function(c){if(c)return c.debug===!0?void b.debug(c):("MissingAPIError"===c.name||"SQLError"===c.name)&&navigator.vendor&&navigator.vendor.indexOf("Apple")>=0?void a.$broadcast("Realtime.PersistedError",i18n.t("flat:realtime.error.safari_private")):"QuotaExceededError"===c.name?void a.$broadcast("Realtime.PersistedError",i18n.t("flat:realtime.error.full_disk")):"InvalidStateError"===c.name?void a.$broadcast("Realtime.PersistedError",i18n.t("flat:realtime.error.invalid_state")):"not-rebased"===c.action?void a.$broadcast("Realtime.UnstackError","not-rebased"):"revision-invalid"===c.action?(this.keepLastEvent("revision-invalid"),void a.$broadcast("Realtime.UnstackError","revision-invalid")):"executing"===c.action?(this.interaction.rightsHandler.setValue("rt.ready",!0),this.keepLastEvent("executing_error"),void a.$broadcast("Realtime.ExecutingError")):"connect"===c.action?(this.score.connected=!1,this.score.connecting=!0,this.keepLastEvent("offline"),a.account.plan&&a.account.plan.features.offlineRW||this.interaction.rightsHandler.setValue("online",!1),void a.$broadcast("Realtime.ConnectionError")):"join"===c.action?(403!==c.error&&(c.error=409),a.addErrors("flat:realtime.error."+c.error),void a.$broadcast("Realtime.JoinError")):("save"===c.action&&(this.interaction.rightsHandler.setValue("rt.ready",!1),i.broadcast("We couldn't save your last modification, sorry about the caused inconvenience. Please reload the editor and contact our team",{color:"danger"})),"open_indexeddb"===c.action&&a.addErrors("flat:realtime.error.open_indexeddb"),"indexeddb"===c.action?(this.hadCriticalError=!0,void a.addErrors("flat:realtime.error.full_disk")):void b.error(c,{logger:"rt"}))}.bind(this)),this.rt.on("disconnect",function(){b.log("[rt] received disconnect"),this.score.connected=!1,this.score.connecting=!1,this.keepLastEvent("offline"),a.$broadcast("Realtime.Offline"),a.account.plan&&a.account.plan.features.offlineRW||this.interaction.rightsHandler.setValue("online",!1),this.switchonbeforeunload(!1)}.bind(this)),this.rt.on("collaborators",function(c){b.log("[rt] on collaborators",c.joined);var d;c.joined?(this.collaborators.setOnline(c.joined),this.interaction.cursor.addGuys(c.joined),d=c.joined):c.left&&(this.collaborators.setOffline(c.left),this.interaction.cursor.delGuys(c.left),
d=c.left),d&&j.get({user:d},function(b){a.account.id!==d&&(d===c.joined?i.broadcast(i18n.t("flat:editor.notification.joined",{name:b.printableName}),{color:"joined"}):i.broadcast(i18n.t("flat:editor.notification.left",{name:b.printableName}),{color:"default"}))})}.bind(this)),this.rt.on("rights",function(a){this.keepLastEvent("rights: "+a),b.log("[rt] current realtime session rights:",a),"rw"!==a?this.score.rights.aclWrite=!1:this.score.rights.aclWrite=!0,this.interaction.rightsHandler.setValue("score_write",this.score.rights.aclWrite)}.bind(this)),this.rt.on("position",function(b){b.userId===a.account.id||a.history.currentRevision||this.interaction.cursor.changeFocus(b,b.userId)}.bind(this)),this.rt.on("revision",function(b){b.redraw||this.setRevision(b.revision),this.keepLastEvent("revision",b),a.$broadcast("Realtime.Revision",b)}.bind(this)),this.rt.on("synced",function(b){this.keepLastEvent("synced",b),this.score.connected=!0,this.score.connecting=!1,a.$broadcast("Realtime.Synced"),f(a.$broadcast.bind(a,"Realtime.Updated"))}.bind(this)),this.rt.on("edit",function(b){if("undefined"!=typeof Raven){var c=angular.copy(b);c.args=JSON.stringify(b.args),Raven.captureBreadcrumb({category:"rt.remote-edit",message:"["+b.id+"] "+b.fnc,data:c})}a.$broadcast("Realtime.Updated")}.bind(this)),this.rt.on("save",function(){this.keepLastEvent("rt-save"),this.save({message:"flat:score.save-auto-message",autosave:!0})}.bind(this)),this.rt.on("unstack",function(b){b&&b.finished&&a.$broadcast("Realtime.Unstacked"),a.$broadcast("Realtime.Unstack",b||{n:0})}),this.rt.on("executing",function(b){a.$broadcast("Realtime.Executing",b||{n:0})}),this.rt.on("executed",function(){this.interaction.rightsHandler.setValue("rt.ready",!0),this.keepLastEvent("executed"),a.$broadcast("Realtime.Executed"),a.$broadcast("Realtime.Synced"),f(a.$broadcast.bind(a,"Realtime.Updated"))}.bind(this)),this.isSetup=function(){return this.rt&&this.rt.isSetup},this.init=function(){this.isSetup()||this.rt.setup(function(a){a&&b.error(a,{logger:"rt"})}.bind(this))},this.edit=function(a,b){"undefined"!=typeof Raven&&Raven.captureBreadcrumb({category:"rt.local-edit",message:a,data:{opts:JSON.stringify(b)}}),this.switchonbeforeunload(!0),this.rt.edit(a,b)},this.bulkEdit=function(a){"undefined"!=typeof Raven&&Raven.captureBreadcrumb({category:"rt.local-bulkEdit",data:{actions:JSON.stringify(a)}}),this.switchonbeforeunload(!0),this.rt.bulkEdit(a)},this.revert=function(d,e){this.keepLastEvent("revert:"+d),this.save(function(){l.getData({score:this.score.id,revision:d},{strategy:"cacheFirst"}).then(function(f){l.create({score:c.id,data:JSON.stringify(f),description:"Restore: "+i18n.t("flat:score.revisions.revert"),autosave:!1},{cache:!0}).then(function(c){return this.keepLastEvent("revert-saved: "+d),b.debug("[rt] revert revision: "+d),a.history.adagioData=null,a.history.scoreData=null,a.history.scoreDataLoaded=null,a.history.currentRevision=null,this.interaction.rightsHandler.setValue("current_revision",!0),g.search("revision",null),e&&e(null,c)}.bind(this)).catch(e)}.bind(this))}.bind(this))},this.applyActionsToCleanData=function(c,d,e,f){l.getData({score:c,revision:d},{strategy:"cacheFirst",cache:this.isCollaborator,update:!1}).then(function(c){delete c.$promise,delete c.$resolved,c=new Adagio.Data(c);for(var d=0;d<e.length;d++)try{e[d].args.logs=e[d].args.logs||[],e[d].args.logs.push({date:new Date,context:"local.save",user:a.account.id,revision:a.history&&a.history.masterRevision,editorSid:a.editorSid,dataSid:this.data.getDataUuid(),rtSid:this.rt.instanceId});var g=Adagio.Utils.clone(e[d].args);c[e[d].fnc](g)}catch(a){if(b.error(a,{logger:"rt",extra:{rt_idx:d,rt_content:"applyActionsToCleanData",rt_revision:e[d].revisionId,rt_uid:e[d].userId,rt_eid:e[d].id,rt_eparent:e[d].parentId,rt_adagiofnc:e[d].fnc,rt_adagioargs:e[d].args}}),!(a instanceof Adagio.Error.InternalError&&"InvalidatedOpts"===a.code)){c=this.data;break}delete e[d].args.actionOrigin,d--}this.hadCriticalError&&(c=this.data);var h=c.exportData();delete h.properties,f(null,h)}.bind(this)).catch(function(a){var b=this.data.exportData();delete b.properties,f(a,b)}.bind(this))},this.save=function(c,e){if("function"!=typeof e&&(e="function"==typeof c?c:function(){}),c="object"==typeof c?c:{},!c.force&&(!this.rt||this.score.saving))return c.manually&&!this.rt&&i.broadcast(i18n.t("flat:editor.notification.save.not-connected"),{color:"danger"}),b.debug("[rt] unable to init or already saving"),this.switchonbeforeunload(!1),e(new Error("unable to init or already saving"));var f=this.rt,h=this.score;f.saving=!0,h.saving=!0,f.applyInQCtx("Realtime.save",function(e){var j=function(b,c){b&&a.$broadcast("Realtime.SaveError",b),f.saving=!1,h.saving=!1,this.switchonbeforeunload(!1),e(b,c)}.bind(this);return h.connected?this.data||c.data?h.rights.aclWrite?(this.keepLastEvent("save",c),void f.getAckActions(function(e,l){return e?(c.manually&&i.broadcast(i18n.t("flat:editor.notification.save.unknown-reason"),{color:"danger"}),b.debug("[rt] Could not get actions list",e),j(new Error("[rt] Could not get actions list"))):c.force||this.hadCriticalError||l&&0!==l.length?void this.applyActionsToCleanData(f.scoreId,f.localRevisionId,l,function(e,m){k.create({score:h.id},{data:JSON.stringify(m),history:angular.copy(l),autosave:c.autosave||!1,description:i18n.t(c.message||"flat:score.save-default-message")},function(e){return e.id?(b.debug("[rt] saved new revision: "+e.id),b.debug("[rt] saved "+l.length+" actions"),a.history.masterRevision=e.id,e.description=d.trustAsHtml(e.description),h.revisions.splice(0,0,e),h.modificationDate=new Date,void j(null,e)):(c.manually&&i.broadcast(i18n.t("flat:editor.notification.save.unknown-reason"),{color:"danger"}),j(new Error("revision id is undefined")))}.bind(this),function(a){var d=new Error("[rt] unable to save ("+a.status+")");return 403===a.status||404===a.status?(c.unload||(404===a.status&&g.url("/score/not-found"),403===a.status&&g.url("/score/"+f.scoreId+"/request-access")),j(d,null)):(a.status>0&&b.error(d,{logger:"rt",extra:{response:a}}),j(d,null))})}):(b.debug("[rt] nothing to save"),j(null,a.history&&a.history.masterRevision))}.bind(this))):(c.manually&&i.broadcast(i18n.t("flat:editor.notification.save.read-only"),{color:"danger"}),j(new Error("[rt] read-only, cant save"))):(c.manually&&i.broadcast(i18n.t("flat:editor.notification.save.unknown-reason"),{color:"danger"}),b.debug("[rt] no adagio instance, already cleanup?"),j(null,a.history&&a.history.masterRevision)):(c.manually&&i.broadcast(i18n.t("flat:editor.notification.save.not-connected"),{color:"danger"}),b.debug("Not connected, unable to save"),j(new Error("[rt] Unable to save while offline")))}.bind(this),e)},a.$on("Account.EnableOfflineRW",function(){this.interaction.rightsHandler.setValue("online",!0)}.bind(this)),a.$on("RealTime.position",function(a,b){this.rt&&this.rt.sendPosition(b)}.bind(this)),this.switchonbeforeunload=function(a){a?window.onbeforeunload=function(){return this.save({unload:!0}),"We are currently saving your score on Flat"}.bind(this):window.onbeforeunload=null},this.saveOnCleanup=function(a){b.debug("[rt] unloading, saving"),this.keepLastEvent("unload"),this.save({unload:!0},a)},this.cleanup=function(){b.log("[rt] cleanup"),this.keepLastEvent("cleanup"),window.onbeforeunload=null,a.score&&(this.score.connected=!1,this.score.connecting=!1),this.rt&&this.saveOnCleanup(function(){this.data=null,this.rt.unload(),this.rt.applyInQCtx("Realtime.cleanup.disconnect",this.rt.disconnect.bind(this.rt))}.bind(this))},this.hasRealTimeError=function(){if(!this.score.errors)return!1;for(var a=0;a<this.score.errors.length;a++)if(this.score.errors[a].indexOf("flat:realtime.error")>=0)return!0;return!1},this.setData=function(a,c){return c&&c===this.data?void b.log("[rt] setData: received same data"):void(c&&(b.log("[rt] setData: updating"),this.keepLastEvent("setdata"),this.rt&&this.data&&this.rt.reset(),this.data=c,this.setRevision(a)))},this.setRevision=function(a){if(b.debug("Setting revision to "+a+" (previously "+this.revisionId+")"),this.revisionId=a,this.onceDataCallbacks[a])for(var c=0;c<this.onceDataCallbacks[a].length;c++)this.onceDataCallbacks[a][c](this.data,m.onlineStack);this.onceDataCallbacks={}},this.keepLastEvent=function(a,b){"undefined"!=typeof Raven&&Raven.captureBreadcrumb({category:"rt",message:a,data:b})},this.focusGained=function(){this.focus||(this.focus=!0,this.rt&&(this.rt.applyInQCtx("Realtime.focusGained.executeSavedActions",this.rt.executeSavedActions.bind(this.rt)),this.rt.applyInQCtx("Realtime.focusGained.reconnect",this.rt.reconnect.bind(this.rt))))},this.reconnect=function(){this.rt&&this.rt.reconnect()},this.focusLost=function(){this.interaction.rightsHandler.setValue("rt.ready",!1),this.focus=!1,this.rt&&this.rt.applyInQCtx("Realtime.focusLost.disconnect",this.rt.disconnect.bind(this.rt))}};return n}]),angular.module("flat.editor.services").factory("flat.editor.services.SVGTools",[function(){"use strict";function a(){this.init.apply(this,arguments)}var b=["page","systemContent","system-group","staff","staffLines","measure","voice","note","graceNote","head"],c={};return c.getElementsByClassName=function(a,b){if(!a)return[];if(a.getElementsByClassName)return[].slice.call(a.getElementsByClassName(b));for(var c=[],d=new RegExp("(^| )"+b+"( |$)"),e=a.getElementsByTagName("*"),f=0,g=e.length;f<g;f++)d.test(e[f].className.baseVal)&&c.push(e[f]);return c},c.extractChild=function(a,b,d){"voice"===b&&(a=c.getElementsByClassName(a,"tickableContent")[0]);for(var e=0,f=0;f<a.childNodes.length;f++){if(a.childNodes[f].classList.contains(b)&&d===e)return a.childNodes[f];a.childNodes[f].classList.contains(b)&&e++}return null},c.getPosition=function(a,b,d){for(var e=c.getElementsByClassName(a,d),f=0;f<e.length;f++)if(e[f]===b)return f},c.isStillInDom=function(a){return document.body.contains(a)},c.getPoint=function(){return c.point&&document.body.contains(c.svgPointContainer)?c.point:(c.svgPointContainer=document.createElementNS("http://www.w3.org/2000/svg","svg"),c.svgPointContainer.style.position="fixed",c.svgPointContainer.style.left="-10000px",c.svgPointContainer.style.bottom="-10000px",document.body.appendChild(c.svgPointContainer),c.point=c.svgPointContainer.createSVGPoint(),c.point)},c.getCoord=function(a){var b={},d=a.getCTM(),e=a.getScreenCTM();if(!d||!e)return b;var f=c.getPoint();return b.abs=f.matrixTransform(d),b.relative=f.matrixTransform(e),b},c.lookUpPlacement=function(a){return a<3?"below":"above"},c.isTab=function(a){return a.classList.contains("tab-staff")},c.correctTab=function(a){"undefined"==typeof a.string&&"undefined"==typeof a.closeString||(a.staffIdx=0)},c.getNbVoice=function(a){var b=c.findParent(a,"voice"),d=b.classList[1].indexOf("-"),e=parseInt(b.classList[1].substring(d+1),10);return e},c.getShard=function(a,b){return c.getElementsByClassName(a,"scoreShard")[b]},c.getPart=function(a,b){return c.getElementsByClassName(a,"systemContent")[b]},c.hasPart=function(a,b){for(var c=0;c<a.systems.length;c++)if(a.systems[c]===b)return c;return-1},c.getNbOccurs=function(a,b){"voice"===b&&(a=c.getElementsByClassName(a,"tickableContent")[0]);for(var d=0,e=0;e<a.childNodes.length;e++)a.childNodes[e].classList.contains(b)&&d++;return d},c.extractStem=function(a){for(var b=0;b<a.childNodes.length;b++){if(a.childNodes[b].classList.contains("stem"))return a.childNodes[b];if(a.childNodes[b].childNodes.length>0){var d=c.extractStem(a.childNodes[b]);if(null!==d)return d}}return null},c.findParent=function(a,b){return a&&a.classList?a.classList[0]===b?a:c.findParent(a.parentElement||a.parentNode,b):null},c.getNearestParent=function(a){return a?"undefined"!=typeof a.classList&&b.indexOf(a.classList[0])===-1?c.getNearestParent(a.parentElement||a.parentNode):a.classList[0]:null},c.getTopParent=function(a){var b=a.parentElement||a.parentNode;return b.classList[0]},c.isCloseEnough=function(a,b,d){var e,f,g;void 0!==a.clientX?(e=a.clientX,f=a.clientY):a.changedTouches&&a.changedTouches.length>0?(e=a.changedTouches[0].clientX,f=a.changedTouches[0].clientY):(e=c.getCoord(a.target).relative.x,f=c.getCoord(a.target).relative.y);var h=this.getBBox(b),i=c.getPoint(),j=i.matrixTransform(b.getScreenCTM()).x+h.x,k=i.matrixTransform(b.getScreenCTM()).y+h.y,l={x:j+h.width/2,y:k+h.height/2},m=Math.max(Math.abs(e-l.x)-h.width/2,0),n=Math.max(Math.abs(f-l.y)-h.height/2,0);return g=Math.sqrt(m*m+n*n),g<=d},a.prototype.init=function(a,b,c){this.svg=a,this.info=b,this.svgContent=document.getElementsByClassName("score-content")[0],c&&(this.drawingContext=c.getDrawingContext(),this.spaceLine=this.drawingContext.getSpaceSize()*c.getScaling(),this.fontSize=this.drawingContext.getLyricsFontSize()*c.getScaling(),this.harmonySize=this.drawingContext.getHarmonyFontSize()*c.getScaling(),this.wordSize=this.drawingContext.getWordFontSize()*c.getScaling(),this.tabLine=this.drawingContext.getTabSpaceSize()*c.getScaling(),this.scaling=c.getScaling())},a.prototype.cleanup=function(){this.svg=null,this.info=null},a.prototype.getBBox=function(a){var b=a.getBBox();return{x:b.x*this.scaling,y:b.y*this.scaling,width:b.width*this.scaling,height:b.height*this.scaling}},a.prototype.setSpaceSize=function(a){this.spaceSize=a},a.prototype.getPage=function(a){return this.svg[a]},a.prototype.getAllPart=function(){var a=c.getElementsByClassName(this.svg[0].node(),"scoreShard")[0];return c.getElementsByClassName(a,"systemContent")},a.prototype.getMeasure=function(a,b,d){var e={},f=this.findGoodPage(a,b);if("undefined"==typeof f)return e;e.svg=this.getPage(f.pageIdx),e.shard=c.getShard(e.svg.node(),f.shardsIdx),e.shardIdx=f.shardsIdx;var g=c.getPart(e.shard,f.partIdx);return"undefined"!=typeof d&&(g=c.getElementsByClassName(g,"staff")[d],e.staff=g),e.measure=c.getElementsByClassName(g,"measure")[b-f.nbstart],e},a.prototype.getNote=function(a){if("undefined"==typeof a||"undefined"==typeof a.partIdx||"undefined"==typeof a.staffIdx||"undefined"==typeof a.measureIdx||"undefined"==typeof a.voiceIdx||"undefined"==typeof a.noteIdx)return null;for(var b={},d=this.findGoodPage(a.partIdx,a.measureIdx);"undefined"==typeof d;)a.measureIdx--,d=this.findGoodPage(a.partIdx,a.measureIdx);var e=this.getPage(d.pageIdx).node();b.pageIdx=d.pageIdx;var f=c.getShard(e,d.shardsIdx),g=c.getPart(f,d.partIdx);b.sys=g;for(var h;null===(h=c.extractChild(b.sys,"staff",a.staffIdx))&&a.staffIdx>=0;)a.staffIdx--;b.staff=h;for(var i;null===(i=c.extractChild(b.staff,"measure",a.measureIdx-d.nbstart))&&a.measureIdx>=0;)a.measureIdx--;b.mea=i;for(var j;null===(j=c.extractChild(i,"voice",a.voiceIdx))&&a.voiceIdx>=0;)a.voiceIdx--;b.voice=j;for(var k;null===(k=c.extractChild(j,"note",a.noteIdx))&&a.noteIdx>=0;)a.noteIdx--;var l;if("undefined"!=typeof a.graceIdx)for(;null===(l=c.extractChild(k,"graceNote",a.graceIdx))&&a.graceIdx>0;)a.graceIdx--;return l?k=l:delete a.graceIdx,b.note=k,b.pos=a,b},a.prototype.getHeadAtLine=function(a,b){for(var d=c.getElementsByClassName(a,"head"),e=0;e<d.length;e++){var f=this.getHeadLine(d[e]);if(b===f)return d[e]}return null},a.prototype.getCloserElem=function(a,b){var d,e,f,g,h=1/0;void 0!==a.clientX?(f=a.clientX,g=a.clientY):a.changedTouches&&a.changedTouches.length>0?(f=a.changedTouches[0].clientX,g=a.changedTouches[0].clientY):(f=c.getCoord(a.target).relative.x,g=c.getCoord(a.target).relative.y);for(var i=0;i<b.length;i++){var j=this.getBBox(b[i]),k=c.getPoint().matrixTransform(b[i].getScreenCTM()).x+j.x,l=c.getPoint().matrixTransform(b[i].getScreenCTM()).y+j.y,m={x:k+j.width/2,y:l+j.height/2},n=Math.max(Math.abs(f-m.x)-j.width/2,0),o=Math.max(Math.abs(g-m.y)-j.height/2,0);e=Math.sqrt(n*n+o*o),e<h&&(d=b[i],h=e)}return d},a.prototype.getCloserNoteToElem=function(a,b){var d=c.getElementsByClassName(b,"voice")[this.voiceIdx],e=c.getElementsByClassName(d,"note"),f=c.getPoint().matrixTransform(a.getScreenCTM()).x,g=c.getPoint().matrixTransform(a.getScreenCTM()).y,h=this.getBBox(a),i={clientX:f+h.width/2+h.x,clientY:g+h.height/2+h.y};return this.getCloserElem(i,e)},a.prototype.findNearestNoteX=function(a,b,d){("undefined"==typeof d||d+1>c.getElementsByClassName(b,"voice").length)&&(d=0);var e,f,g=c.getPoint(),h=c.getElementsByClassName(b,"voice")[d],i=c.getElementsByClassName(h,"note"),j=1/0;if(a.type)void 0!==a.clientX?f=a.clientX:a.changedTouches&&a.changedTouches.length>0&&(f=a.changedTouches[0].clientX);else{var k=this.getBBox(a);f=g.matrixTransform(a.getScreenCTM()).x+k.x}for(var l=0;l<i.length;l++){var m=g.matrixTransform(i[l].getScreenCTM()).x,n=Math.abs(m-f);n<j&&(j=n,e=i[l])}return e},a.prototype.findNearestNoteXWide=function(a,b){var d,e,f=c.getElementsByClassName(b,"note"),g=c.getPoint(),h=1/0;a.type?void 0!==a.clientX?e=a.clientX:a.changedTouches&&a.changedTouches.length>0&&(e=a.changedTouches[0].clientX):e=g.matrixTransform(a.getScreenCTM()).x+this.getBBox(a).x;for(var i=0;i<f.length;i++){var j=this.getBBox(f[i]),k=g.matrixTransform(f[i].getScreenCTM()).x+j.x,l=Math.abs(k-e);l<h&&(h=l,d=f[i])}return d},a.prototype.findNearestNote=function(a,b,d){var e,f=a.target;b||(b=c.findParent(f,"measure")),e="undefined"!=typeof d?c.extractChild(b,"voice",d):c.extractChild(b,"voice",0);var g=c.getElementsByClassName(e,"note");return this.getCloserElem(a,g)},a.prototype.isPointInsideElem=function(a,b,d){var e,f,g=c.getPoint(),h={x:g.matrixTransform(b.getScreenCTM()).x,y:g.matrixTransform(b.getScreenCTM()).y,bbox:this.getBBox(b)};return void 0!==a.clientX?(f=a.clientX,e=a.clientY):a.changedTouches&&a.changedTouches.length>0&&(f=a.changedTouches[0].clientX,e=a.changedTouches[0].clientY),!(e<h.y+h.bbox.y-d||e>h.y+h.bbox.y+h.bbox.height+d||f<h.x-d||f>h.x+h.bbox.width+d)},a.prototype.isInsideElem=function(a,b,d){"undefined"==typeof d&&(d=0);var e=c.getPoint(),f={x:e.matrixTransform(a.getScreenCTM()).x,y:e.matrixTransform(a.getScreenCTM()).y,bbox:this.getBBox(a)},g={x:e.matrixTransform(b.getScreenCTM()).x,y:e.matrixTransform(b.getScreenCTM()).y,bbox:this.getBBox(b)};return!(f.y+f.bbox.y+f.bbox.height<g.y+g.bbox.y||f.y+f.bbox.y>g.y+g.bbox.y+g.bbox.height||f.x+f.bbox.width<g.x||f.x>g.x+g.bbox.width)},a.prototype.getClosestHead=function(a,b){var d=c.getElementsByClassName(b,"head");return 1===d.length?d[0]:this.getCloserElem(a,d)},a.prototype.getLine=function(a,b){var d=a.clientY,e=c.extractChild(b,"staffLines",0),f=c.getPoint(),g=d-f.matrixTransform(e.getScreenCTM()).y;if(c.isTab(b)){var h=c.extractChild(b,"staffLines",0);return h=h.getElementsByTagName("line").length,e=Math.trunc(Math.round(g/this.tabLine*2)/2),Math.max(Math.min(1+e,h),1)}return e=Math.round(g/this.spaceLine*2)/2,5-e},a.prototype.getHeadLine=function(a,b){b||(b=c.findParent(a,"staff"));var d=c.getPoint(),e=d.matrixTransform(a.getScreenCTM()).y,f=c.extractChild(b,"staffLines",0),g=e-d.matrixTransform(f.getScreenCTM()).y;if(c.isTab(b)){var h=f.getElementsByTagName("line").length;return f=Math.trunc(Math.round(g/this.tabLine*2)/2),Math.max(Math.min(1+f,h),1)}return f=Math.round(g/this.spaceLine*2)/2,5-f},a.prototype.getTopPosition=function(a){var b=c.findParent(a,"staff"),d=c.findParent(b,"systemContent"),e=c.findParent(d,"scoreShard"),f=c.findParent(e,"page"),g=c.getPosition(this.svgContent,f,"page"),h=c.getPosition(f,e,"scoreShard"),i=c.getPosition(e,d,"systemContent"),j=this.resolvePos(g,h,i),k=c.getPosition(d,b,"staff");return c.isTab(b)&&k--,{measureIdx:c.getPosition(b,a,"measure")+j.startMea,staffIdx:k,partIdx:j.systemIdx}},a.prototype.findInformation=function(a,b){if("undefined"==typeof b)throw new Error("plantage");var d,e=a&&this.getClosestHead(a,b);e&&"graceNote"===c.getNearestParent(e.parentElement||e.parentNode)&&(d=c.findParent(e,"graceNote"),b=c.findParent(d,"note"));var f=c.findParent(b,"measure"),g=c.findParent(b,"voice"),h=c.findParent(f,"staff"),i=c.findParent(h,"systemContent"),j=c.findParent(i,"scoreShard"),k=c.findParent(j,"page"),l=c.getPosition(this.svgContent,k,"page"),m=c.getPosition(k,j,"scoreShard"),n=c.getPosition(j,i,"systemContent"),o=this.resolvePos(l,m,n),p={elem:{note:b,measure:f,staff:h},measureIdx:c.getPosition(h,f,"measure")+o.startMea,staffIdx:c.getPosition(i,h,"staff"),partIdx:o.systemIdx,voiceIdx:c.getPosition(f,g,"voice"),noteIdx:c.getPosition(g,b,"note"),graceIdx:d&&c.getPosition(b,d,"graceNote")};return a&&!c.isTab(h)?(p.line=this.getLine(a,h),p.closeLine=this.getHeadLine(e,h)):a&&c.isTab(h)&&(p.string=this.getLine(a,h),p.closeString=e&&this.getHeadLine(e,h)),p},a.prototype.findGoodPage=function(a,b){for(var d=0;d<this.info.length;d++){var e,f=0;for(var g in this.info[d].shards)if(this.info[d].shards.hasOwnProperty(g)){var h=this.info[d].shards[g];if(h.startMeasureIdx<=b&&h.startMeasureIdx+h.nbMeasures>b&&(e=c.hasPart(h,a))>-1)return{pageIdx:d,shardsIdx:f,partIdx:e,nbstart:h.startMeasureIdx,nbMea:h.nbMeasures};f++}}},a.prototype.resolvePos=function(a,b,c){var d=this.info[a].shards[b];return{startMea:d.startMeasureIdx,systemIdx:d.systems[c]}},a.prototype.getNextDownPos=function(a,b){var c=this.findGoodPage(a,b);return c.shardsIdx+1<this.info[c.pageIdx].shards.length?this.info[c.pageIdx].shards[c.shardsIdx+1].startMeasureIdx:c.pageIdx+1<this.info.length?this.info[c.pageIdx+1].shards[0].startMeasureIdx:null},a.prototype.getNextUpPos=function(a,b){var c=this.findGoodPage(a,b);return c.shardsIdx>0?this.info[c.pageIdx].shards[c.shardsIdx-1].startMeasureIdx:c.pageIdx>0?this.info[c.pageIdx-1].shards[this.info[c.pageIdx-1].shards.length-1].startMeasureIdx:null},a.prototype.createSvgMatrix=function(){return this.svg.createSVGMatrix()},a.prototype.getElementsByClassName=c.getElementsByClassName,a.prototype.extractChild=c.extractChild,a.prototype.getPosition=c.getPosition,a.prototype.isStillInDom=c.isStillInDom,a.prototype.getPoint=c.getPoint,a.prototype.getCoord=c.getCoord,a.prototype.lookUpPlacement=c.lookUpPlacement,a.prototype.isTab=c.isTab,a.prototype.correctTab=c.correctTab,a.prototype.getNbVoice=c.getNbVoice,a.prototype.getShard=c.getShard,a.prototype.getPart=c.getPart,a.prototype.hasPart=c.hasPart,a.prototype.getNbOccurs=c.getNbOccurs,a.prototype.extractStem=c.extractStem,a.prototype.findParent=c.findParent,a.prototype.getNearestParent=c.getNearestParent,a.prototype.getTopParent=c.getTopParent,a.prototype.isCloseEnough=c.isCloseEnough,c.SVGTools=a,c}]),angular.module("flat.editor.services").factory("EditorShortcutsService",EditorShortcutsService),EditorShortcutsService.$inject=["_","$q","$rootScope","$log","Shortcuts","Instruments"],angular.module("flat.editor.services").factory("flat.editor.services.Slider",["$rootScope",function(a){"use strict";function b(a){this.lines=[],this.interaction=a,this.color=a.colorSlider||"#33B1F8"}var c=1;return b.prototype.init=function(){this.lines=[]},b.prototype.getMeasure=function(a,b){return this._cacheMeasureIdx!==b&&(this._cacheMeasureInfos={},this._cacheMeasureIdx=b),this._cacheMeasureInfos[a]||(this._cacheMeasureInfos[a]=this.interaction.svgTools.getMeasure(a,b)),this._cacheMeasureInfos[a]},b.prototype.getMeasureCoords=function(a,b){if(this._cacheMeasureCoordsIdx!==b&&(this._cacheMeasureCoords={},this._cacheMeasureCoordsIdx=b),!this._cacheMeasureCoords[a]){if(this._cacheMeasureCoords[a]=this.getMeasure(a,b),!this._cacheMeasureCoords[a]||!this._cacheMeasureCoords[a].measure)return null;this._cacheMeasureCoords[a]=this.interaction.svgTools.getCoord(this._cacheMeasureCoords[a].measure.getElementsByTagName("rect")[0])}return this._cacheMeasureCoords[a]},b.prototype.getMeasureWidth=function(a,b){if(this._cacheMeasureWidthIdx!==b&&(this._cacheMeasureWidth={},this._cacheMeasureWidthIdx=b),!this._cacheMeasureWidth[a]){if(this._cacheMeasureWidth[a]=this.getMeasure(a,b),!this._cacheMeasureWidth[a]||!this._cacheMeasureWidth[a].measure)return null;this._cacheMeasureWidth[a]=parseInt(this._cacheMeasureWidth[a].measure.getElementsByTagName("rect")[0].getAttribute("width"),10)*this.interaction.svgTools.scaling}return this._cacheMeasureWidth[a]},b.prototype.getMeasureData=function(a){return this._cacheMeasureDataIdx!==a&&(this._cacheMeasureData=null,this._cacheMeasureDataIdx=a),this._cacheMeasureData||(this._cacheMeasureData=this.interaction.dataReader.data.getStaffMeasure({partIdx:0,measureIdx:a,staffIdx:0})),this._cacheMeasureData},b.prototype.findRealNotes=function(a){for(var b=0;b<this.parts.length;b++){var c=this.getMeasure(b,a),d=this.interaction.svgTools.getElementsByClassName(c.measure,"note");if(d.length>1)return d}return this.interaction.svgTools.getElementsByClassName(this.getMeasure(0,a).measure,"note")},b.prototype.getSpaceBetweenNote=function(a,b,c){var d=this.interaction.dataReader.getNbMeasures();if(a>=d)return null;var e=this.getMeasure(0,a),f=this.interaction.dataReader.data.getPartVoiceMainStaffIdx(0,c),g=this.drawer.getMeasureNbNotes(0,f,a,c),h=this.getMeasureData(a);if("undefined"==typeof e.measure)return null;var i;try{i={note:this.drawer.getNoteXInMeasure(0,f,a,c,b),width:this.drawer.getMeasureWidth(0,a)}}catch(a){return null}if(b+1<g)i.size=this.drawer.getNoteXInMeasure(0,f,a,c,b+1)-i.note;else if(a+1<d&&(null!==h.rightBarline&&"undefined"==typeof h.rightBarline.repeat||null===h.rightBarline)){var j=this.findRealNotes(a+1);i.size1=i.width-i.note;try{var k={partIdx:0,staffIdx:f,voiceIdx:c,measureIdx:a+1};this.interaction.dataReader.checkVoice(k),i.size2=this.drawer.getNoteXInMeasure(0,f,a+1,k.voiceIdx,0)}catch(b){if("TypeError"===b.name)throw new Error("nextNote[0] is undefined in measure ["+(a+1)+"]. nextNote ["+j+"]")}i.size=i.size1+i.size2}else i.size=i.width-i.note;return i},b.prototype.loadSlider=function(a){return this.interaction.svgTools.svg&&a?(this.parts=this.interaction.dataReader.data.getNbParts(),this.drawer=a,this.scoreContent=document.body,this.htmlContent=document.documentElement,this.scoreContent.addEventListener("mousewheel",this.humanScrollSign),this.scoreContent.addEventListener("DOMMouseScroll",this.humanScrollSign),this.initLines(0),this.currentMeasure=null,this.currentNote=null,this.size=0,this.humanScrollInc=0,this.autoScroll=!0,this.currentMeasureInc=0,this.backNormal=!0,0):-1},b.prototype.initLines=function(a){var b=this.interaction.dataReader.getNbMeasures();if(b<=a)return void(this.line=[]);for(var c=0;c<this.parts;c++){var d=this.drawer.getSystemHeight(c,a);this.lines[c]={},0===c&&(this.sizeLine=d),this.lines[c].line=this.initLine(d),this.lines[c].offset=this.drawer.getSpaceAboveStaff(c,0,a)}},b.prototype.initLine=function(a){var b=new Adagio.Brush.Elem("line");return b.attr("x1","0"),b.attr("y1","0"),b.attr("x2","0"),b.attr("y2",a),b.attr("stroke-width","2px"),b.attr("stroke",this.color),b.attr("style","will-change: transform"),b.node()},b.prototype.updateLine=function(b){var c,d=!1,e=!1,f=!1,g=b.timeFromNoteStart/b.currentNoteDuration;if(b.currentMeasure!==this.currentMeasure&&(e=!0,f=!0,this.currentMeasure=b.currentMeasure,this.currentNote=null,this.clearLines(),this.initLines(this.currentMeasure)),0===this.lines.length)return!1;if(this.currentNote!==b.currentNoteIndex&&(this.size=this.getSpaceBetweenNote(b.currentMeasure,b.currentNoteIndex,b.currentVoiceId),this.currentNote=b.currentNoteIndex),null===this.size)return!1;var h=this.currentMeasure,i=this.size.size*g;this.size.note+i>this.size.width&&(d=!0,e=!0,h++),this.lines.forEach(function(a,b){if(e){var c=this.getMeasure(b,h);if(!c||!c.svg)return!1;c.measure.appendChild(a.line)}d?a.line.setAttribute("transform","translate("+(i-this.size.size1)+","+-a.offset+")"):a.line.setAttribute("transform","translate("+(i+this.size.note)+","+-a.offset+")")},this);var j=this.lines[0].line;return"undefined"!=typeof j&&(c=this.interaction.svgTools.getCoord(j),!c.abs||!c.relative||(f&&("track"===a.scoreLayout?(this.autoScroll&&c.relative.x>200&&(this.scrollLeft=!0),this.autoScroll&&c.relative.x<0?this.scrollRight=!0:this.scrollRight=!1,!this.autoScroll&&c.relative.x>0&&c.relative.x<this.htmlContent.clientWidth?this.currentMeasureInc++:this.currentMeasureInc=0):(this.autoScroll&&c.relative.y+this.sizeLine>this.htmlContent.clientHeight&&(this.scrollUp=!0),this.autoScroll&&c.relative.y<0&&(this.scrollDown=!0),!this.autoScroll&&c.relative.y>0&&c.relative.y+this.sizeLine<this.htmlContent.clientHeight?this.currentMeasureInc++:this.currentMeasureInc=0)),this.doScroll(c),!0))},b.prototype.doScroll=function(b){if("track"===a.scoreLayout)this.scrollLeft?this.backNormal?(this.scoreContent.scrollLeft+=(b.relative.x-200)/8,b.relative.x-200<5&&(this.backNormal=!1)):this.scoreContent.scrollLeft+=b.relative.x-200:this.scrollRight&&(this.scoreContent.scrollLeft+=(b.relative.x-150)/8),this.currentMeasureInc>c&&(this.autoScroll=!0,this.backNormal=!0,this.currentMeasureInc=0,this.humanScrollInc=0);else{var d="undefined"==typeof embedMode?240:40;this.scrollUp?b.relative.y-d<=10?this.scrollUp=!1:(this.scoreContent.scrollTop+=(b.relative.y-d)/15,this.humanScrollInc=0):this.scrollDown&&(b.relative.y>d?this.scrollDown=!1:this.scoreContent.scrollTop+=(b.relative.y-d)/15),this.currentMeasureInc>c&&(this.autoScroll=!0,this.currentMeasureInc=0,this.humanScrollInc=0)}},b.prototype.humanScroll=function(){"track"===a.scoreLayout?(this.autoScroll=!1,this.scrollLeft=!1,this.scrollRight=!1):(this.autoScroll=!1,this.scrollDown=!1,this.scrollUp=!1),this.currentMeasureInc=0},b.prototype.clear=function(){this.scoreContent&&(this.scoreContent.removeEventListener("mousewheel",this.humanScrollSign),this.scoreContent.removeEventListener("DOMMouseScroll",this.humanScrollSign)),this.clearLines()},b.prototype.clearLines=function(){this.lines.forEach(function(a){a.line.parentNode&&a.line.parentNode.removeChild(a.line)})},b.prototype.humanScrollSign=b.prototype.humanScroll,b}]),angular.module("flat.editor.services").factory("flat.editor.services.SmartHistoryService",SmartHistoryFactory),SmartHistoryFactory.$inject=["_","$q","$log","$rootScope","Experience","ScoreIDB","ScoreRevisionV2","ScoreRevisionIDB","flat.editor.services.CancelStack"],angular.module("flat.editor.services").factory("flat.editor.services.SocialFacebook",[function(){"use strict";var a={};return a.shareScore=function(a,b){var c=$("<textarea />").html(a.title).text(),d=i18n.t("flat:social.share.fb.title",{name:b.name||b.username,title:c}),e=i18n.t("flat:social.share.fb.caption"),f=i18n.t("flat:social.share.fb.description",{name:b.name||b.username}),g="http://www.facebook.com/dialog/feed?app_id="+fbappid+"&display=popup&caption="+encodeURIComponent(e)+"&description="+encodeURIComponent(f)+"&name="+encodeURIComponent(d)+"&link="+encodeURIComponent(a.htmlUrl)+"&redirect_uri="+encodeURIComponent(baseurl+"/fb-share-done"),h=626,i=436,j=($(window).width()-h)/2,k=($(window).height()-i)/2,l="menubar=no,toolbar=no,resizable=yes,scrollbars=yes,width="+h+",height="+i+",top="+k+",left="+j;window.open(g,"Facebook",l)},a.shareProductUpdate=function(a){var b=$("<textarea />").html(a.title).text(),c=i18n.t("flat:social.share.fb.product-update-title",{title:b}),d=i18n.t("flat:social.share.fb.product-update-caption"),e=i18n.t("flat:social.share.fb.product-update-description"),f="http://www.facebook.com/dialog/feed?app_id="+fbappid+"&display=popup&caption="+encodeURIComponent(d)+"&description="+encodeURIComponent(e)+"&name="+encodeURIComponent(c)+"&link="+encodeURIComponent(baseurl+"/updates/"+a.id)+"&redirect_uri="+encodeURIComponent(baseurl+"/fb-share-done"),g=626,h=436,i=($(window).width()-g)/2,j=($(window).height()-h)/2,k="menubar=no,toolbar=no,resizable=yes,scrollbars=yes,width="+g+",height="+h+",top="+j+",left="+i;window.open(f,"Facebook",k)},a}]),angular.module("flat.editor.services").factory("flat.editor.services.SocialGoogle",[function(){"use strict";var a={};return a.share=function(a){var b=525,c=400,d=($(window).width()-b)/2,e=($(window).height()-c)/2,f="menubar=no,toolbar=no,resizable=yes,scrollbars=yes,width="+b+",height="+c+",top="+e+",left="+d,g="https://plus.google.com/share?url="+encodeURIComponent(a);window.open(g,"Google+",f)},a}]),angular.module("flat.editor.services").factory("flat.editor.services.SocialPinterest",[function(){"use strict";var a={};return a.shareScore=function(a,b){var c=$("<textarea />").html(a.title).text(),d=i18n.t("flat:social.share.fb.title",{
name:b.name||b.username,title:c}),e=a.thumbnailUrl,f=a.htmlUrl,g="https://www.pinterest.com/pin/create/button/?description="+encodeURIComponent(d)+"&media="+encodeURIComponent(e)+"&url="+encodeURIComponent(f),h=626,i=436,j=($(window).width()-h)/2,k=($(window).height()-i)/2,l="menubar=no,toolbar=no,resizable=yes,scrollbars=yes,width="+h+",height="+i+",top="+k+",left="+j;window.open(g,"Pinterest",l)},a}]),angular.module("flat.editor.services").factory("flat.editor.services.SocialTwitter",[function(){"use strict";var a={};return a.shareScore=function(a){var b=$("<textarea />").html(a.title).text(),c=i18n.t("flat:social.share.twitter.message",{title:b}),d="https://twitter.com/intent/tweet?text="+encodeURIComponent(c)+"&url="+encodeURIComponent(a.htmlUrl)+"&related=flat_io",e=575,f=400,g=($(window).width()-e)/2,h=($(window).height()-f)/2,i="menubar=no,toolbar=no,resizable=yes,scrollbars=yes,width="+e+",height="+f+",top="+h+",left="+g;window.open(d,"Twiter",i)},a.shareProductUpdate=function(a){var b=$("<textarea />").html(a.title).text(),c=i18n.t("flat:social.share.twitter.message-pu",{title:b}),d="https://twitter.com/intent/tweet?text="+encodeURIComponent(c)+"&url="+encodeURIComponent(baseurl+"/updates/"+a.id)+"&related=flat_io",e=575,f=400,g=($(window).width()-e)/2,h=($(window).height()-f)/2,i="menubar=no,toolbar=no,resizable=yes,scrollbars=yes,width="+e+",height="+f+",top="+h+",left="+g;window.open(d,"Twiter",i)},a}]),angular.module("flat.editor.services").factory("flat.editor.services.DarkenLighten",[function(){"use strict";var a={convertColor:function(a,b){if("undefined"!=typeof a){var c=!1;"#"===a[0]&&(a=a.slice(1),c=!0);var d=parseInt(a,16),e=(d>>16)+b;e>255?e=255:e<0&&(e=0);var f=(d>>8&255)+b;f>255?f=255:f<0&&(f=0);var g=(255&d)+b;return g>255?g=255:g<0&&(g=0),(c?"#":"")+(g|f<<8|e<<16).toString(16)}}};return a}]),angular.module("flat.editor.services").factory("flat.editor.services.DomCache",[function(){"use strict";function a(a){this.i=a,this.svgTools=a.svgTools,this.cacheHeads=[],this.cacheMeasure={measure:null},this.cacheStaff={staff:null,measure:null,voice:null,topPos:{},staffDirection:null,measureDirection:null,voiceIdx:0}}return a.prototype.checkCacheHead=function(a){if(!this.cacheHeads[a.partIdx]){var b=this.i.data.getPartContent(a.partIdx),c=Adagio.Utils.partContentUtils.getMeasure(b,a.measureIdx),d=Adagio.Utils.measureUtils.getWrappedStaffDetails(c),e=d.getEntry(a.staffIdx),f=Adagio.Utils.staffDetailsUtils.getNbStaffLines(e),g=this.i.data.getPartHeader(a.partIdx),h=Adagio.Utils.partHeaderUtils.getPitchMapping(g);this.cacheHeads[a.partIdx]={},this.cacheHeads[a.partIdx].nbStaffLines=f,this.cacheHeads[a.partIdx].pitchMapping=h}},a.prototype.keyboardUpdateTopPos=function(){var a=this.i.cursor.getPosition();this.cacheMeasure.topPos={partIdx:a.partIdx,staffIdx:a.staffIdx,measureIdx:a.measureIdx}},a.prototype.cleanCacheHead=function(){this.cacheHeads=[]},a.prototype.checkMeasureCache=function(a){var b=this.svgTools.findParent(a.target,"measure");this.cacheMeasure.measure=b},a.prototype.checkStaffCache=function(a,b){var c=!1,d=this.svgTools.findParent(a.target,"measure"),e=this.svgTools.findParent(d,"staff");return this.cacheStaff.staff===e&&!b&&this.svgTools.isStillInDom(e)||(this.cacheStaff.staff=e,this.hashStaffDirections(),c=!0),d===this.cacheStaff.measure&&!b&&this.svgTools.isStillInDom(d)||(this.cacheStaff.measure=d,this.cacheStaff.voice=this.svgTools.getElementsByClassName(d,"voice")[0],this.cacheStaff.topPos=this.svgTools.getTopPosition(d),this.hashMeasureDirections(),this.cacheStaff.voiceIdx=this.i.data.getPartStaffVoiceAtIdx(this.cacheStaff.topPos.partIdx,this.cacheStaff.topPos.staffIdx,0),c=!0),c},a.prototype.hashStaffDirections=function(){var a=this.svgTools.getElementsByClassName(this.cacheStaff.staff,"wedgeLines");this.cacheStaff.staffDirection=[].slice.call(a);var b=this.svgTools.getElementsByClassName(this.cacheStaff.staff,"octaveShift");this.cacheStaff.staffDirection=this.cacheStaff.staffDirection.concat([].slice.call(b))},a.prototype.hashMeasureDirections=function(){this.cacheStaff.measureDirection=this.cacheStaff.staffDirection.filter(function(a){return this.svgTools.isInsideElem(this.cacheStaff.measure,a)}.bind(this));var a=this.svgTools.getElementsByClassName(this.cacheStaff.measure,"dynamic");a=[].slice.call(a);var b=this.svgTools.getElementsByClassName(this.cacheStaff.measure,"pizzicato");b=[].slice.call(b);var c=this.svgTools.getElementsByClassName(this.cacheStaff.measure,"pedal");c=[].slice.call(c),this.cacheStaff.measureDirection=this.cacheStaff.measureDirection.concat(a),this.cacheStaff.measureDirection=this.cacheStaff.measureDirection.concat(b),this.cacheStaff.measureDirection=this.cacheStaff.measureDirection.concat(c)},a}]),angular.module("flat.editor.filters",[]),angular.module("flat.editor.filters").filter("comment",CommentFilter),CommentFilter.$inject=["$sce","Text"];var editorDepsList=["flat.common","flat.editor.filters","flat.editor.services","flat.editor.controllers","flat.editor.directives"];try{angular.module("flat.offline.services"),editorDepsList.push("flat.offline.services")}catch(a){}angular.module("flat.editor",editorDepsList);
//# sourceMappingURL=flat.editor.min.js.map