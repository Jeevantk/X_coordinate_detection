/*!
 * Copyright (c) 2017 Flat <hello@flat.io> - https://flat.io
 * Package: dacapo - 4.8.3
 */

"undefined"!=typeof require&&(Adagio=require("adagio"));var Dacapo=Dacapo||{};Dacapo.qpm=120,Dacapo.timeSignature={beats:null,beatType:null},Dacapo.measureIdx=0,Dacapo.unitDuration=60/Dacapo.qpm,Dacapo.beatDuration=60/Dacapo.qpm,Dacapo.swing=!1,Dacapo.initialized=!1,Dacapo.init=function(){"use strict";if(!Dacapo.initialized){var a=null;if("undefined"!=typeof window){if(a=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext||void 0,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,void 0===a)throw new Dacapo.Error.CompatibilityError("Web Audio API is not available on this browser");if("undefined"==typeof Promise)throw new Dacapo.Error.CompatibilityError("Promises are not available on this browser")}if("undefined"!=typeof Math&&(Math.log10=Math.log10||function(a){return Math.log(a)*Math.LOG10E}),a){try{Dacapo.context=new a}catch(a){if("NotSupportedError"===a.name&&!a.message.indexOf("Failed to construct 'AudioContext': The number of hardware contexts provided"))throw new Dacapo.Error.ConnectionOverflowError(a.message);throw a}Dacapo.setupIos(),Dacapo.now=Dacapo.context.currentTime,Dacapo.initOutput(),Dacapo.initWorkerTimer(),Dacapo.initialized=!0}else Dacapo.context=null}},Dacapo.setupIos=function(){"use strict";if(window.AudioContext||!window.webkitAudioContext||!Dacapo.context||"suspended"!==Dacapo.context.state)return!1;var a=function(){Dacapo.context.resume(),setTimeout(function(){"running"===Dacapo.context.state&&document.body.removeEventListener("touchend",a,!1)},0)};document.body.addEventListener("touchend",a,!1)},Dacapo.throwIfWebAudioStucked=function(a){var b,c=Promise.resolve();return Dacapo.initialized&&(b=Dacapo.context.currentTime,c=new Promise(function(c,d){Dacapo.WorkerTimer.setTimeout(function(){b>=Dacapo.context.currentTime?a?(void 0!==Dacapo.context.resume&&("running"===Dacapo.context.state&&Dacapo.context.suspend(),Dacapo.context.resume()),Dacapo.throwIfWebAudioStucked().then(function(){c()}).catch(function(){d(new Dacapo.Error.BlockedWAAPIError({curTime:b,currentTime:Dacapo.context.currentTime,when:"starting",state:Dacapo.context.state}))})):d(new Dacapo.Error.BlockedWAAPIError({curTime:b,currentTime:Dacapo.context.currentTime,when:"starting",state:Dacapo.context.state})):c()},1e4)})),c},function(){"use strict";Dacapo.Error={}}.call(this),function(){"use strict";var a=Dacapo.Error.CompatibilityError=function(a,b){var c=Error.call(this,a);return this.name=c.name="CompatibilityError",this.stack=c.stack,this.message=c.message,void 0!==b&&(this.code=b),this};a.prototype=Object.create(Error.prototype,{constructor:{value:a}})}.call(this),function(){"use strict";var a=Dacapo.Error.ParseError=function(a,b){var c=Error.call(this,a);return this.name=c.name="ParseError",this.stack=c.stack,this.message=c.message,void 0!==b&&(this.code=b),this};a.prototype=Object.create(Error.prototype,{constructor:{value:a}})}.call(this),function(){"use strict";var a=Dacapo.Error.ConnectionOverflowError=function(a,b){var c=Number(a.substring(a.lastIndexOf("(")+1,a.lastIndexOf(")"))),d="The maximum number of connection to the audio card ("+c+") has been reached.",e=Error.call(this,d);return this.name=e.name="ConnectionOverflowError",this.stack=e.stack,this.message=e.message,this.maxConnections=c,void 0!==b&&(this.code=b),this};a.prototype=Object.create(Error.prototype,{constructor:{value:a}})}.call(this),function(){"use strict";var a=Dacapo.Error.BlockedWAAPIError=function(a){var b=Error.call(this);return this.name=b.name="BlockedWAAPIError",this.stack=b.stack,this.message="The web audio timer is stuck.",this.webAudioCurrentTime=a.currentTime,this.webAudioState=a.state,this.savedCurrentTime=a.curTime,this.when=a.when,this};a.prototype=Object.create(Error.prototype,{constructor:{value:a}})}.call(this),Dacapo.Base64Binary={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",decodeArrayBuffer:function(a){"use strict";var b=Math.ceil(3*a.length/4),c=new ArrayBuffer(b);return this.decode(a,c),c},decode:function(a,b){"use strict";var c=this._keyStr.indexOf(a.charAt(a.length-1)),d=this._keyStr.indexOf(a.charAt(a.length-1)),e=Math.ceil(3*a.length/4);64===c&&e--,64===d&&e--;var f,g,h,i,j,k,l,m,n=0,o=0;for(f=b?new Uint8Array(b):new Uint8Array(e),a=a.replace(/[^A-Za-z0-9\+\/\=]/g,""),n=0;n<e;n+=3)j=this._keyStr.indexOf(a.charAt(o++)),k=this._keyStr.indexOf(a.charAt(o++)),l=this._keyStr.indexOf(a.charAt(o++)),m=this._keyStr.indexOf(a.charAt(o++)),g=j<<2|k>>4,h=(15&k)<<4|l>>2,i=(3&l)<<6|m,f[n]=g,64!==l&&(f[n+1]=h),64!==m&&(f[n+2]=i);return f}},function(){"use strict";Dacapo.Utils=Dacapo.Utils||{},Dacapo.Utils.EPSILON=Math.pow(2,-30),Dacapo.Utils.VELOCITY_DEFAULT=50,Dacapo.Utils.TEMPO_DEFAULT=80,Dacapo.Utils.GRACE_RATIO=.2,Dacapo.Utils.ARPEGGIO_DURATION=.1,Dacapo.Utils.TEMPORARY_AMP=1.73,Dacapo.Utils.oscWaves={0:"sine",1:"square",2:"sawtooth",3:"triangle"},Dacapo.Utils.Dynamics={ppp:9,pp:16,p:25,mp:35,mf:50,f:70,ff:99,fff:140,sfz:99,rfz:99,fp:25,pf:70},Dacapo.Utils.NoteName={C0:12,D0:14,E0:16,F0:17,G0:19,A0:21,B0:23,C1:24,D1:26,E1:28,F1:29,G1:31,A1:33,B1:35,C2:36,D2:38,E2:40,F2:41,G2:43,A2:45,B2:47,C3:48,D3:50,E3:52,F3:53,G3:55,A3:57,B3:59,C4:60,D4:62,E4:64,F4:65,G4:67,A4:69,B4:71,C5:72,D5:74,E5:76,F5:77,G5:79,A5:81,B5:83,C6:84,D6:86,E6:88,F6:89,G6:91,A6:93,B6:95,C7:96,D7:98,E7:100,F7:101,G7:103,A7:105,B7:107,C8:108,D8:110,E8:112,F8:113,G8:115,A8:117,B8:119},Dacapo.Utils.MIDINotes={},Dacapo.Utils.MapUnpitched={635:36,636:37,637:38,638:39,639:40,640:41,641:42,642:43,643:44,644:45},Dacapo.Utils.DiatonicScale=["C","D","E","F","G","A","B"],Dacapo.Utils.KeyToNote={},Dacapo.Utils.NoteToKey={},Dacapo.Utils.Keys=[],function(){var a,b,c,d,e=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];for(a=21;a<=108;a++)d=(a-12)/12>>0,c=e[a%12]+d,Dacapo.Utils.KeyToNote[c]=a,Dacapo.Utils.NoteToKey[a]=c,Dacapo.Utils.Keys.push(c);for(b in Dacapo.Utils.NoteName)Dacapo.Utils.NoteName.hasOwnProperty(b)&&(Dacapo.Utils.MIDINotes[Dacapo.Utils.NoteName[b]]=b)}(),Dacapo.Utils.NoteNameToFreq=function(a){return Dacapo.Utils.MIDIToFreq(Dacapo.Utils.NoteNameToMIDI(a))},Dacapo.Utils.NoteNameToMIDI=function(a){var b=Dacapo.Utils.NoteName[a.step+a.octave];return void 0!==a.alter?b+parseInt(a.alter):b},Dacapo.Utils.freqToMIDI=function(a){return Math.round(69+12*Math.log(a/440)/Math.log(2))},Dacapo.Utils.MIDIToFreq=function(a){return 440*Math.pow(2,(Math.floor(a)-69)/12)},Dacapo.Utils.MIDIToNoteName=function(a){var b=Dacapo.Utils.NoteName.getKeyByValue(a),c=0;if(-1===b&&(b=Dacapo.Utils.NoteName.getKeyByValue(a+1),c--),-1===b)throw new Error("Note out of range");return{step:b.substr(0,1),octave:parseInt(b.substr(1,1),10),alter:c}},Dacapo.Utils.NoteStrToNoteObj=function(a,b){var c={};return c.step=a.substr(0,1),c.octave=parseInt(a.substr(1,1),10),c.alter=b,c},Dacapo.Utils.velocityToVolume=function(a){return.7086614173228346*a/100},Dacapo.Utils.gainToVelocity=function(a){return Math.round(100*a/.7086614173228346)},Dacapo.Utils.decibelsToMIDIVelocity=function(a){return Dacapo.Utils.gainToVelocity(Math.pow(10,a/20))},Dacapo.Utils.MIDIVelocityToDecibels=function(a){return 20*Math.log10(Dacapo.Utils.velocityToVolume(a))},Dacapo.Utils.getLastPizzicatoType=function(a,b){var c,d,e,f,g,h,i,j,k,l=null;for(k=Adagio.Utils.partContentUtils.getNbStaves(a),c=b;c>=0;c--){for(h=0,j=a.measure[c],d=0;d<k;d++)i=Adagio.Utils.measureUtils.getPizzicatos(j,d),i.length>0&&(e=c===b?i[0]:i[i.length-1],f=Adagio.Utils.direction.pizzicatoDirectionUtils.getTimePos(e),g=Adagio.Utils.direction.pizzicatoDirectionUtils.getType(e),c===b&&0===f?l=g:c<b&&f>=h&&(h=f,l=g));if(null!==l)return l}return Adagio.Values.PizzicatoType.ARCO},Dacapo.Utils.chain=function(){for(var a=arguments.length-1;a>=1;--a)arguments[a-1].connectTo(arguments[a])},Dacapo.Utils.epsEqu=function(a,b){return Math.abs(a-b)<Dacapo.Utils.EPSILON},Dacapo.Utils.isFunction=function(a){var b={};return a&&"[object Function]"===b.toString.call(a)},Dacapo.Utils.getGCD=function(a){for(var b=a.length,c=a[0],d=1;d<b;d++){var e=a[d];if(c<0||e<0)return 1;for(;c&&e;)c>e?c%=e:e%=c;c+=e}return c},Dacapo.Utils.getLCM=function(a){for(var b=a.length,c=Math.abs(a[0]),d=1;d<b;d++){for(var e=Math.abs(a[d]),f=c;c&&e;)c>e?c%=e:e%=c;c=Math.abs(f*a[d])/(c+e)}return c},Dacapo.Utils.minArray=function(a){return a.reduce(function(a,b){return a<b?a:b})},Object.defineProperty(Object.prototype,"getKeyByValue",{value:function(a){for(var b in this)if(this.hasOwnProperty(b)&&this[b]===a)return b;return-1},enumerable:!1})}.call(this),function(){"use strict";Dacapo.Utils=Dacapo.Utils||{},Dacapo.Utils.InstrumentConf={1:{id:"acoustic_grand_piano",sustainStart:.2,release:2,maxDuration:10,attenuation:.2,tremolo:"alternate",filter:{type:"lowpass",frequency:7998},samplerv2:!1,sampleRate:32e3,samples:[{notename:"D1",basenote:26,range:{start:0,end:30},loop:{start:170893,end:219499}},{notename:"Gb1",basenote:30,range:{start:27,end:30},loop:{start:160113,end:195247}},{notename:"Bb1",basenote:34,range:{start:31,end:34},loop:{start:129454,end:165045}},{notename:"D2",basenote:38,range:{start:35,end:38},loop:{start:158947,end:193111}},{notename:"Gb2",basenote:42,range:{start:39,end:42},loop:{start:120490,end:155602}},{notename:"Bb2",basenote:46,range:{start:43,end:46},loop:{start:109152,end:141103}},{notename:"D3",basenote:50,range:{start:47,end:50},loop:{start:77368,end:109543}},{notename:"Gb3",basenote:54,range:{start:51,end:54},loop:{start:55019,end:84480}},{notename:"Bb3",basenote:58,range:{start:55,end:58},loop:{start:52686,end:87542}},{notename:"D4",basenote:62,range:{start:59,end:62},loop:{start:73030,end:103885}},{notename:"Gb4",basenote:66,range:{start:63,end:66},loop:{start:62381,end:88426}},{notename:"Bb4",basenote:70,range:{start:67,end:70},loop:{start:51471,end:71088}},{notename:"D5",basenote:74,range:{start:71,end:74},loop:{start:44165,end:67047}},{notename:"Gb5",basenote:78,range:{start:75,end:78},loop:{start:47507,end:75718}},{notename:"C6",basenote:84,range:{start:79,end:84},loop:{start:43879,end:46535}},{notename:"Gb6",basenote:90,range:{start:85,end:90},loop:{start:40281,end:60328}},{notename:"Bb6",basenote:94,range:{start:91,end:94},loop:{start:40230,end:41513}},{notename:"Eb7",basenote:99,range:{start:95,end:99},loop:{start:17820,end:18113}},{notename:"Ab7",basenote:104,range:{start:100,end:104},loop:{start:13695,end:14104}},{notename:"C8",basenote:108,range:{start:105,end:127},loop:{start:12048,end:12733}}]},2:{id:"bright_acoustic_piano",sustainStart:.2,release:1.5,tremolo:"alternate",attack:.008,attenuation:.41,samplerv2:!1,sampleRate:32e3,samples:1},7:{id:"harpsichord",decay:25,sustain:1e-5,release:.45,tremolo:"alternate",filter:{type:"lowpass",frequency:8799},samplerv2:!1,sampleRate:44100,samples:[{notename:"D2",basenote:38,range:{start:0,end:39},loop:{start:167374,end:170995}},{notename:"G2",basenote:43,range:{start:40,end:44},loop:{start:82026,end:86528}},{notename:"C3",basenote:48,range:{start:45,end:48},loop:{start:99441,end:102477}},{notename:"F3",basenote:53,range:{start:49,end:54},loop:{start:47196,end:47448}},{notename:"C4",basenote:60,range:{start:55,end:61},loop:{start:91398,end:93249}},{notename:"F4",basenote:65,range:{start:62,end:65},loop:{start:36618,end:36997}},{notename:"B4",basenote:71,range:{start:66,end:71},loop:{start:37383,end:39081}},{notename:"F5",basenote:77,range:{start:72,end:77},loop:{start:30673,end:31873}},{notename:"D6",basenote:86,range:{start:78,end:86},loop:{start:30172,end:30397}},{notename:"B6",basenote:95,range:{start:87,end:95},loop:{start:20130,end:20576}},{notename:"C7",basenote:96,range:{start:96,end:127},loop:{start:35993,end:36753}}]},9:{id:"celesta",transposechromatic:12,hold:.1,decay:2,sustain:1e-5,release:3.5,attenuation:.31,tremolo:"alternate",samplerv2:!1,sampleRate:44100,samples:[{notename:"Gb3",basenote:54,range:{start:0,end:54},loop:{start:25359,end:26312}},{notename:"C4",basenote:60,range:{start:60,end:65},loop:{start:19225,end:19562}},{notename:"Gb4",basenote:66,range:{start:66,end:71},loop:{start:24481,end:24958}},{notename:"C5",basenote:72,range:{start:72,end:77},loop:{start:22571,end:23245}},{notename:"Gb5",basenote:78,range:{start:78,end:83},loop:{start:21396,end:21873}},{notename:"C6",basenote:84,range:{start:84,end:89},loop:{start:19665,end:20126}},{notename:"Gb6",basenote:90,range:{start:90,end:95},loop:{start:9497,end:9884}},{notename:"C7",basenote:96,range:{start:96,end:127},loop:{start:11684,end:11705}}]},10:{id:"glockenspiel",transposechromatic:24,release:4,tremolo:"roll"},11:{id:"music_box",release:4,tremolo:"roll"},12:{id:"vibraphone",release:4,tremolo:"roll"},13:{id:"marimba",release:2,tremolo:"roll"},14:{id:"xylophone",transposechromatic:12,release:3,tremolo:"roll"},15:{id:"tubular_bells",release:4,tremolo:"roll"},17:{id:"drawbar_organ",release:2,attenuation:.3,tremolo:"amplitude",filter:{type:"lowpass",frequency:8598},samplerv2:!1,sampleRate:32e3,samples:[{notename:"C7",basenote:96,range:{start:0,end:127},loop:{start:11297,end:49216}}]},18:{id:"percussive_organ",release:2,attenuation:.3,tremolo:"amplitude",sampleRate:44100,samplerv2:!1,samples:[{notename:"Eb2",basenote:39,range:{start:0,end:39},loop:{start:31226,end:100902}},{notename:"G2",basenote:43,range:{start:40,end:43},loop:{start:25250,end:91806}},{notename:"A2",basenote:45,range:{start:44,end:45},loop:{start:23602,end:81285}},{notename:"C3",basenote:48,range:{start:46,end:48},loop:{start:12457,end:76458}},{notename:"Db3",basenote:49,range:{start:49,end:50},loop:{start:19729,end:83951}},{notename:"E3",basenote:52,range:{start:51,end:54},loop:{start:24602,end:91436}},{notename:"Ab3",basenote:56,range:{start:55,end:59},loop:{start:46308,end:114633}},{notename:"D4",basenote:62,range:{start:60,end:65},loop:{start:12457,end:76458}},{notename:"Ab4",basenote:68,range:{start:66,end:69},loop:{start:20025,end:82645}},{notename:"C5",basenote:72,range:{start:70,end:76},loop:{start:62080,end:128769}},{notename:"Ab5",basenote:80,range:{start:77,end:80},loop:{start:37396,end:99327}},{notename:"C6",basenote:84,range:{start:81,end:87},loop:{start:19477,end:95770}},{notename:"F6",basenote:89,range:{start:88,end:89},loop:{start:57843,end:158670}},{notename:"G6",basenote:91,range:{start:90,end:127},loop:{start:33792,end:93185}}]},19:{id:"rock_organ",release:2,attenuation:.3,tremolo:"amplitude",samplerv2:!1,sampleRate:32e3,samples:[{notename:"Ab2",basenote:44,range:{start:0,end:44},loop:{start:23350,end:72007}},{notename:"B2",basenote:47,range:{start:45,end:49},loop:{start:54861,end:104311}},{notename:"E3",basenote:52,range:{start:50,end:55},loop:{start:47211,end:97269}},{notename:"A3",basenote:57,range:{start:56,end:58},loop:{start:34474,end:83056}},{notename:"C4",basenote:60,range:{start:59,end:63},loop:{start:66612,end:119553}},{notename:"F4",basenote:65,range:{start:64,end:70},loop:{start:50002,end:99845}},{notename:"Db5",basenote:73,range:{start:71,end:76},loop:{start:46895,end:94475}},{notename:"G5",basenote:79,range:{start:77,end:82},loop:{start:6688,end:77081}},{notename:"B5",basenote:83,range:{start:83,end:86},loop:{start:15126,end:62973}},{notename:"F6",basenote:89,range:{start:87,end:89},loop:{start:11787,end:61146}},{notename:"G6",basenote:91,range:{start:90,end:127},loop:{start:12309,end:60922}}]},20:{id:"church_organ",release:2.42,attenuation:.3,tremolo:"amplitude",samplerv2:!1,sampleRate:22050,samples:[{notename:"C2",basenote:36,range:{start:0,end:36},loop:{start:24522,end:61248}},{notename:"Gb2",basenote:42,range:{start:37,end:45},loop:{start:46262,end:91741}},{notename:"Eb3",basenote:51,range:{start:46,end:54},loop:{start:47046,end:97886}},{notename:"C4",basenote:60,range:{start:55,end:63},loop:{start:45472,end:90380}},{notename:"A4",basenote:69,range:{start:64,end:72},loop:{start:47913,end:78779}},{notename:"Gb5",basenote:78,range:{start:73,end:81},loop:{start:27869,end:61623}},{notename:"Eb6",basenote:87,range:{start:82,end:90},loop:{start:31911,end:71007}},{notename:"C7",basenote:96,range:{start:91,end:127},loop:{start:17894,end:51289}}]},21:{id:"reed_organ",release:2,tremolo:"amplitude",attenuation:.125,samplerv2:!1,sampleRate:44100,samples:[{notename:"Gb3",basenote:54,sampleRate:26e3,range:{start:0,end:54},loop:{start:3092,end:3373}},{notename:"C4",basenote:60,sampleRate:24e3,range:{start:55,end:60},loop:{start:1970,end:2062}},{notename:"Gb4",basenote:66,sampleRate:38e3,range:{start:61,end:66},loop:{start:3011,end:3216}},{notename:"C5",basenote:72,sampleRate:4e4,range:{start:67,end:72},loop:{start:2831,end:3137}},{notename:"Gb5",basenote:78,range:{start:73,end:78},loop:{start:3103,end:3282}},{notename:"C6",basenote:84,sampleRate:32e3,range:{start:79,end:84},loop:{start:971,end:1124}},{notename:"Gb6",basenote:90,range:{start:85,end:90},loop:{start:1457,end:1576}},{notename:"C7",basenote:96,sampleRate:38e3,range:{start:91,end:127},loop:{start:2080,end:2298}}]},22:{id:"accordion",release:1.5,tremolo:"amplitude",glissando:"slide"},23:{id:"harmonica",slur:!0,release:1.5,tremolo:"amplitude"},25:{id:"acoustic_guitar_nylon",release:1.5,tremolo:"strum",glissando:"slide"},26:{id:"acoustic_guitar_steel",release:1.5,tremolo:"strum",glissando:"slide"},27:{id:"electric_guitar_jazz",release:1.5,tremolo:"strum",glissando:"slide"},28:{id:"electric_guitar_clean",release:1.5,tremolo:"strum",glissando:"slide"},29:{id:"electric_guitar_muted",release:1.5,tremolo:"strum",glissando:"slide"},31:{id:"distortion_guitar",release:1.5,tremolo:"strum",glissando:"slide"},34:{id:"electric_bass_finger",release:1.5,tremolo:"strum",glissando:"slide"},35:{id:"electric_bass_pick",release:1.5,tremolo:"strum",glissando:"slide"},37:{id:"slap_bass_1",release:1.4,tremolo:"strum",glissando:"slide"},41:{id:"violin",shorten:.86,release:.6,slur:!0,tremolo:"friction",glissando:"slide",children:{pizzicato:"violin_pizz"}},42:{id:"viola",shorten:.92,release:.6,slur:!0,tremolo:"friction",glissando:"slide",children:{pizzicato:"viola_pizz"}},43:{id:"cello",shorten:.9,release:.7,slur:!0,tremolo:"friction",glissando:"slide",children:{pizzicato:"cello_pizz"}},44:{id:"contrabass",shorten:.88,release:.7,slur:!0,tremolo:"friction",glissando:"slide",children:{pizzicato:"contrabass_pizz"}},46:{id:"string_ensemble_1_pizz",tremolo:"strum",release:1},47:{id:"orchestral_harp",release:6,tremolo:"strum"},48:{id:"timpani",release:6,tremolo:"roll"},49:{id:"string_ensemble_1",tremolo:"friction",release:1,glissando:"slide",children:{pizzicato:"string_ensemble_1_pizz"}},53:{id:"choir_aahs",shorten:.92,release:1.2,tremolo:"amplitude",glissando:"slide"},54:{id:"voice_oohs",shorten:.9,release:1.2,tremolo:"amplitude",glissando:"slide"},55:{id:"synth_choir",shorten:.95,release:1.2,tremolo:"amplitude",glissando:"slide"},57:{id:"trumpet",transposechromatic:-2,shorten:.95,release:.3,slur:!0,tremolo:"amplitude",glissando:"slide"},58:{id:"trombone",shorten:.95,release:.5,slur:!0,tremolo:"alternate",glissando:"slide"},59:{id:"tuba",shorten:.94,release:.5,slur:!0,tremolo:"alternate",glissando:"slide"},61:{id:"french_horn",transposechromatic:-7,shorten:.96,release:1.2,slur:!0,tremolo:"alternate",glissando:"slide"},62:{id:"brass_section",release:1.2,tremolo:"alternate",glissando:"slide"},65:{id:"soprano_sax",transposechromatic:-2,shorten:.94,release:.3,slur:!0,tremolo:"alternate"},66:{id:"alto_sax",transposechromatic:-9,shorten:.95,release:.3,slur:!0,tremolo:"alternate"},67:{id:"tenor_sax",transposechromatic:-14,shorten:.95,release:.3,slur:!0,tremolo:"alternate"},68:{id:"baritone_sax",transposechromatic:-21,shorten:.95,release:.3,slur:!0,tremolo:"alternate"},69:{id:"oboe",shorten:.93,release:.5,slur:!0,tremolo:"alternate"},70:{id:"english_horn",transposechromatic:-7,release:.6,slur:!0,tremolo:"alternate"},71:{id:"bassoon",shorten:.93,release:.5,slur:!0,tremolo:"alternate"},72:{id:"clarinet",transposechromatic:-2,release:.3,slur:!0,tremolo:"alternate"},73:{id:"piccolo",transposechromatic:12,release:.9,slur:!0,tremolo:"alternate"},74:{id:"flute",release:.9,slur:!0,tremolo:"alternate"},75:{id:"recorder",release:.5,slur:!0,tremolo:"alternate"},76:{id:"pan_flute",slur:!0,release:2,tremolo:"amplitude"},79:{id:"whistle",release:.5,slur:!0,tremolo:"amplitude"},80:{id:"ocarina",slur:!0,release:2,tremolo:"amplitude"},86:{id:"lead_6_voice",tremolo:"amplitude",glissando:"slide"},92:{id:"pad_4_choir",tremolo:"amplitude",glissando:"slide"},105:{id:"sitar",release:4,tremolo:"strum",glissando:"slide"},106:{id:"banjo",release:2,tremolo:"strum",glissando:"slide"},110:{id:"bagpipe",transposechromatic:-2,slur:!0,release:1.2,tremolo:"amplitude",glissando:"slide"},115:{id:"steel_drums",release:3,tremolo:"roll"},215:{id:"steel_drums",release:3,tremolo:"roll"},224:{id:"ukulele",release:1.2,tremolo:"strum"},225:{id:"mandolin",release:1.5,tremolo:"strum"},268:{id:"baritone_horn",slur:!0,tremolo:"alternate",glissando:"slide"},269:{id:"baritone_horn",transposechromatic:-14,slur:!0,tremolo:"alternate",glissando:"slide"},270:{id:"euphonium",slur:!0,tremolo:"alternate",glissando:"slide"},272:{id:"bass_clarinet",transposechromatic:-14,release:.3,slur:!0,tremolo:"alternate"},274:{id:"alto_flute",transposechromatic:-5,release:.3,slur:!0,tremolo:"alternate"},666:{id:"cat",tremolo:"amplitude"}},Dacapo.Utils.DrumsetConf={1:{id:"percussion_kit","midi-unpitched":!0,instruments:{36:{name:"Acoustic Bass Drum"},37:{name:"Bass Drum"},38:{name:"Side Stick"},39:{name:"Snare (Acoustic)"},40:{name:"Clapping Hands"},41:{name:"Snare (Electric)"},42:{name:"Tom 5"},43:{name:"Hi-Hat Close"},44:{name:"Tom 4"},45:{name:"Hi-Hat Pedal"},46:{name:"Tom 3"},47:{name:"Hi-Hat Open"},48:{name:"Tom 2"},49:{name:"Tom 1"},50:{name:"Crash 1"},51:{name:"Tom"},52:{name:"Ride"},53:{name:"China"},54:{name:"Ride (bell)"},55:{name:"Tambourine"},56:{name:"Splash Cymbal"},57:{name:"Cowbell"}}},2:{id:"marching_band_set","midi-unpitched":!0,instruments:{36:{name:"Bass Drum 5"},37:{name:"Bass Drum Rims"},38:{name:"Bass Drum 4"},39:{name:"Bass Drum Unison"},40:{name:"Bass Drum 3"},41:{name:"Bass Drum 2"},43:{name:"Bass Drum 1"},44:{name:"Cymbal Smash"},45:{name:"Cymbal Crash"},46:{name:"Hi Hat Choke"},47:{name:"Cymbal Crash Choke"},48:{name:"Snare Left Hand"},49:{name:"Snare Left Hand Rimshot"},50:{name:"Snare Right Hand"},51:{name:"Snare Right Hand Rimshot"},52:{name:"Snare Gok"},53:{name:"Snare Short Guz"},54:{name:"Snare Long Guz"},55:{name:"Snare Left Hand Rim"},56:{name:"Snare Right Hand Rim"},57:{name:"Snare Cross Shot"},58:{name:"Snare Stick Shot"},59:{name:"Snare Stick Click"},60:{name:"Snare Roll Short"},64:{name:"Snare Brush"},65:{name:"Tenor Drum 4"},66:{name:"Tenor Drum 4 Rimshot"},67:{name:"Tenor Drum 4 Buzz Roll"},69:{name:"Tenor Drum 3"},70:{name:"Tenor Drum 3 Rimshot"},71:{name:"Tenor Drum 3 Buzz Roll"},72:{name:"Tenor Drum 2"},73:{name:"Tenor Drum 2 Rimshot"},74:{name:"Tenor Drum 2 Buzz Roll"},76:{name:"Tenor Drum 1"},77:{name:"Tenor Drum 1 Rimshot"},78:{name:"Tenor Drum 1 Buzz Roll"},79:{name:"Tenor Drum Spock"},80:{name:"Tenor Drum Spock Rimshot"},81:{name:"Tenor Drum Hi"},82:{name:"Tenor Drum Lo"},83:{name:"Tenor Stick Click"}}},80:{id:"starwars_set","midi-unpitched":!0,instruments:[{name:"Blaster",unpitched:636},{name:"Lightsaber On",unpitched:637},{name:"Lightsaber Off",unpitched:638},{name:"R2D2",unpitched:639},{name:"Vader Breath",unpitched:640},{name:"I Am Your Father",unpitched:641},{name:"Chewbacca",unpitched:642},{name:"X Wing",unpitched:643},{name:"Tie Fighter",unpitched:644},{name:"Tie Fire",unpitched:645}]}}}.call(this),function(){"use strict";Dacapo.Values=Dacapo.Values||{},Dacapo.Values.Expression={tremolo:{pattern:[{duration:-2e-4,attack:.015},{duration:4e-4,attack:.008},{duration:-3e-4,attack:.01,filters:[{type:"peaking",frequencyMultiplier:4.2,q:20,gain:20},{type:"peaking",frequencyMultiplier:4,q:10,gain:7},{type:"peaking",frequencyMultiplier:3,q:10,gain:4}]},{duration:2e-4,attack:.01},{duration:0,attack:.005},{duration:1e-4,attack:.015,filters:[{type:"peaking",frequencyMultiplier:2.5,q:40,gain:30},{type:"peaking",frequencyMultiplier:3.2,q:30,gain:20}]},{duration:1e-4,attack:.009,filters:[{type:"peaking",frequencyMultiplier:2.7,q:40,gain:25}]},{duration:0,attack:.02},{duration:-2e-4,attack:.005},{duration:2e-4,attack:.006},{duration:0,attack:.002},{duration:0,attack:.002},{duration:-1e-4,attack:.002},{duration:3e-4,attack:.003}]}}}.call(this),function(){"use strict";Dacapo.MIDIUtils={},Dacapo.MIDIUtils.EPSILON=Math.pow(2,-30),Dacapo.MIDIUtils.INNER_TICKS_PER_QUARTER_NOTE=480,Dacapo.MIDIUtils.DEFAULT_TEMPO=120,Dacapo.MIDIUtils.ChannelEvent={},Dacapo.MIDIUtils.ChannelEvent.TYPE={NOTE_OFF:8,NOTE_ON:9,NOTE_AFTERTOUCH:10,CONTROLLER:11,PROGRAM_CHANGE:12,CHANNEL_AFTERTOUCH:13,PITCH_BEND:14,NON_MUSICAL_COMMAND:15},Dacapo.MIDIUtils.MIDICommands={128:"noteOff",144:"noteOn",160:"afterTouch",176:"continuousController",192:"patchChange",208:"channelPressure",224:"pitchBend",240:"nonMusicalCommand"},Dacapo.MIDIUtils.TimeSignature={},Dacapo.MIDIUtils.TimeSignature.isCompound=function(a){return a.beats%3==0&&a.beats>3},Dacapo.MIDIUtils.epsEqu=function(a,b){return Math.abs(a-b)<Dacapo.MIDIUtils.EPSILON}}.call(this),function(){"use strict";Dacapo.Fraction=function(a,b){this.num=a,this.den=b},Dacapo.Fraction.fromTicks=function(a,b){return new Dacapo.Fraction(a,4*b)},Dacapo.Fraction.prototype.copy=function(){return new Dacapo.Fraction(this.num,this.den)},Dacapo.Fraction.prototype.value=function(){return this.num/this.den},Dacapo.Fraction.prototype.toTicks=function(a){void 0===a&&(a=480);var b=4*a/this.den;return Math.floor(this.num*b)},Dacapo.Fraction.prototype.reduce=function(){var a=Dacapo.Utils.getGCD([this.num,this.den]);return 0===a&&(this.num=0,this.den=1),this.num/=a,this.den/=a,this},Dacapo.Fraction.prototype.add=function(a){var b=Dacapo.Utils.getLCM([this.den,a.den]);return this.num=b/this.den*this.num+b/a.den*a.num,this.den=b,this},Dacapo.Fraction.prototype.sub=function(a){var b=Dacapo.Utils.getLCM([this.den,a.den]);return this.num=b/this.den*this.num-b/a.den*a.num,this.den=b,this},Dacapo.Fraction.prototype.mul=function(a){return a instanceof Dacapo.Fraction?(this.num*=a.num,this.den*=a.den):"number"==typeof a&&(this.num*=a),this},Dacapo.Fraction.prototype.div=function(a){return a instanceof Dacapo.Fraction?(this.num*=a.den,this.den*=a.num):"number"==typeof a&&(this.den*=a),this}}.call(this),function(){"use strict";Dacapo.Quantizer=function(){this.baseQuant=new Dacapo.Fraction(1,8),this.minAllowedDuration=new Dacapo.Fraction(1,32),this.ticksPerQuarterNote=480},Dacapo.Quantizer.prototype.adaptQuantIfDotted=function(a,b){var c=a.div(b).value();return c>1.45&&c<1.55&&b.div(2),b},Dacapo.Quantizer.prototype.getAdequateQuantForLength=function(a){for(var b=this.baseQuant.copy();b.value()>a.value()&&b.value()>2*this.minAllowedDuration.value();)b.div(2);return b.value()>=2*this.minAllowedDuration.value()&&(b=this.adaptQuantIfDotted(a.copy(),b.copy())),b},Dacapo.Quantizer.prototype.getAdequateQuantForTuplet=function(a,b){var c=a.copy().div(b);return c>=this.minAllowedDuration&&c.div(2),c},Dacapo.Quantizer.prototype.quantize=function(a,b){var c=a.num*b.den,d=a.den*b.num,e=a.den*b.den;return c=Math.floor((c+d/2)/d)*d,new Dacapo.Fraction(c,e).reduce()},Dacapo.Quantizer.prototype.quantizeNoteOn=function(a,b){var c=!1;"number"==typeof a&&(c=!0,a=Dacapo.Fraction.fromTicks(a,this.ticksPerQuarterNote));var d=this.quantize(a,b);return c?d.toTicks():d},Dacapo.Quantizer.prototype.quantizeNoteOff=function(a,b,c){var d=!1;"number"==typeof a&&"number"==typeof b&&(d=!0,a=Dacapo.Fraction.fromTicks(a,this.ticksPerQuarterNote),b=Dacapo.Fraction.fromTicks(b,this.ticksPerQuarterNote));for(var e=this.quantize(b,c);e.value()<=a.value();)c.value()>=this.baseQuant.value()?c.div(2):e=new Dacapo.Fraction(a.num,a.den).add(c);return d?e.toTicks():e},Dacapo.Quantizer.prototype.quantizeValue=function(a){var b=Dacapo.Fraction.fromTicks(a>>0,this.ticksPerQuarterNote),c=this.getAdequateQuantForLength(b);return this.quantize(b,c).toTicks(this.ticksPerQuarterNote)},Dacapo.Quantizer.prototype.quantizeWithQuant=function(a,b){var c=Dacapo.Fraction.fromTicks(a>>0,this.ticksPerQuarterNote);return this.quantize(c,b).toTicks(this.ticksPerQuarterNote)},Dacapo.Quantizer.prototype.quantizeNote=function(a){var b=Dacapo.Fraction.fromTicks(a.timeOn,this.ticksPerQuarterNote),c=Dacapo.Fraction.fromTicks(a.timeOff,this.ticksPerQuarterNote),d=Dacapo.Fraction.fromTicks(a.duration,this.ticksPerQuarterNote),e=this.getAdequateQuantForLength(d);return b=this.quantizeNoteOn(b,e),c=this.quantizeNoteOff(b,c,e),a.setTimeOn(b.toTicks()>>0),a.setTimeOff(c.toTicks()>>0),this},Dacapo.Quantizer.prototype.setTicksPerQuarterNote=function(a){this.ticksPerQuarterNote=a}}.call(this),function(){"use strict";Dacapo.BufferWriter=function(a){this.release=88200,this.lengthWithoutRelease=0,this.totalLength=0,this.maxOffset=0,this.bufferResult=null,void 0!==a&&this.setScoreLength(a)},Dacapo.BufferWriter.prototype={write:function(a,b,c,d,e){if(null===typeof this.bufferResult)return 0;if(void 0===a)return 0;("number"!=typeof e||isNaN(e))&&(e=.8);var f,g,h,i=[],j=44100*c*2,k=44100*b*2;if(a instanceof Float32Array)h=a;else{for(f=0;f<a.numberOfChannels;f++)i.push(a.getChannelData(f));h=this.interleaveBuffers(i)}for(g=0,f=d>>0;g<h.length&&f<this.totalLength&&g<k;f++,g++)this.bufferResult[f]=Math.min(Math.max(this.bufferResult[f]+h[g]*e,-1),1);if(f<this.totalLength&&g<h.length){k+=j;for(var l=j;g<h.length&&f<this.totalLength&&g<k;f++,g++,l--)this.bufferResult[f]=Math.min(Math.max(this.bufferResult[f]+h[g]*(l/j)*e,-1),1)}return f>this.maxOffset&&(this.maxOffset=f),g},interleaveBuffers:function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c].length;var d=new Float32Array(b),e=0;for(c=0;c<b;c++){for(var f=0;f<a.length;f++)d[c++]=a[f][e];f=0,e++}return d},finishExport:function(){for(var a=this.maxOffset+1;a<this.totalLength;a++)this.bufferResult[a]=0},getResult:function(){return this.bufferResult},setScoreLength:function(a){this.lengthWithoutRelease=a>>0,this.totalLength=this.lengthWithoutRelease+this.release,this.bufferResult=new Float32Array(this.totalLength)}}}.call(this),function(){"use strict";Dacapo.InstrumentManager=function(a,b,c){this.instrumentStack=[],this.transport=a,this.setData(b),this.currentPlayedNote=null,this.midiOutput=c,this.midiOutputEnabled=!1,this.selected=0,this.soloCount=0},Dacapo.InstrumentManager.prototype={addInstrument:function(a){this.instrumentStack.push(a)},playSelectedInstrument:function(a,b){var c;this.instrumentStack[this.selected]||(this.selected=0),c={pitch:a,duration:1/0,velocity:b},this.midiOutput&&this.midiOutputEnabled?this.midiOutput.playNote(c,this.selected):this.instrumentStack[this.selected].playNote(c)},stopSelectedInstrument:function(a,b){this.instrumentStack[this.selected]?this.midiOutput&&this.midiOutputEnabled?this.midiOutput.stopNote(a,this.selected):this.instrumentStack[this.selected].stopNote(a,b):console.error("The instrument manager don't handle any instrument")},getSelectedIndex:function(){return this.instrumentStack[this.selected]?this.selected:0},playNoteAtPosition:function(a){if(!this.data||!Dacapo.context||this.data.getNbMeasures()<=a.measureIdx)return!1;var b,c,d,e,f,g,h=Dacapo.context.currentTime;if(this.selected=a.partIdx,this.hasMode(a.partIdx,"pizzicato")&&(e=Dacapo.Utils.getLastPizzicatoType(this.data.score["score-partwise"].part[a.partIdx],a.measureIdx)),f=this.data.getNoteData({noteIdx:a.noteIdx,voiceIdx:a.voiceIdx,measureIdx:a.measureIdx,partIdx:a.partIdx,isConcertPitch:!0}),g={duration:1,velocity:.68,slurIdx:0,preview:!0,pizzicato:e===Adagio.Values.PizzicatoType.PIZZICATO},this.stopCurrentPlayAtPos(),!f.isRest){if(f.nbGraces){for(d=Dacapo.Utils.GRACE_RATIO*g.duration/f.nbGraces,b=0;b<f.nbGraces;b++)g.duration=d,c=this.data.getGraceData({graceIdx:b,noteIdx:a.noteIdx,voiceIdx:a.voiceIdx,measureIdx:a.measureIdx,partIdx:a.partIdx,isConcertPitch:!0}),this.playNoteData(c,g,a,h),h+=d;g.duration=1*Dacapo.Utils.GRACE_RATIO}this.playNoteData(f,g,a,h),this.playedPartIdx=a.partIdx}return!0},playNoteData:function(a,b,c,d){var e,f
;if(void 0!==a.pitches)for(e=0,f=a.pitches.length;e<f;e++)b.pitch=Dacapo.Utils.NoteNameToMIDI(a.pitches[e]),this.scheduleNote(b,d,c.partIdx);else if(void 0!==a.unpitched)for(e=0,f=a.unpitched.length;e<f;e++)b.pitch=Number(a.unpitched[e].MIDIUnpitched)-1,this.scheduleNote(b,d,c.partIdx)},stopCurrentPlayAtPos:function(){this.playedPartIdx&&this.instrumentStack[this.playedPartIdx]&&(this.instrumentStack[this.playedPartIdx].stopNotesPreview(),this.playedPartIdx=null)},scheduleNote:function(a,b,c){if(this.instrumentStack[c])return this.midiOutput&&this.midiOutputEnabled?this.midiOutput.scheduleNote(a,b,c):this.instrumentStack[c].scheduleNote(a,b)},playNote:function(a,b){this.instrumentStack[b]&&(this.midiOutput&&this.midiOutputEnabled?this.midiOutput.playNote(a,b):this.instrumentStack[b].playNote(a))},stopPedal:function(a,b){this.instrumentStack[a]&&(this.midiOutput&&this.midiOutputEnabled?this.midiOutput.stopPedalForChannel(a,b):this.instrumentStack[a].stopPedal(b))},hasMode:function(a,b){if(this.instrumentStack[a]){if(this.midiOutput&&this.midiOutputEnabled)return!1;this.instrumentStack[a].hasMode(b)}},writeNote:function(a,b){return!this.instrumentStack[b]||this.instrumentStack[b].writeNote(a)},updateOffset:function(a,b){this.instrumentStack[b]&&this.instrumentStack[b].updateOffset(a)},updateTempo:function(a,b){this.instrumentStack[b]&&this.instrumentStack[b].updateTempo&&this.instrumentStack[b].updateTempo(a)},updateTimeSignature:function(a,b,c){this.instrumentStack[c]&&this.instrumentStack[c].updateTimeSignature&&this.instrumentStack[c].updateTimeSignature(a,b)},updateKeySignature:function(a,b,c){this.instrumentStack[c]&&this.instrumentStack[c].updateKeySignature&&this.instrumentStack[c].updateKeySignature(a,b)},getInstruments:function(){return this.instrumentStack},selectInstrument:function(a){this.selected=a},stopAll:function(){if(this.midiOutput&&this.midiOutputEnabled)this.midiOutput.stopNotes();else for(var a=0;a<this.instrumentStack.length;a++)this.instrumentStack[a].stopNotes()},setTransport:function(a){this.transport=a},getInstrumentTranspo:function(a){if(a>=0&&a<this.instrumentStack.length)return this.instrumentStack[a].getTranspo()},setInstrumentVolume:function(a,b){a>=0&&a<this.instrumentStack.length&&"number"==typeof(b=Number(b))&&isFinite(b)&&this.instrumentStack[a].setVolume(b)},getInstrumentVolume:function(a){if(a>=0&&a<this.instrumentStack.length)return Dacapo.context?this.instrumentStack[a].getVolume():1},setInstrumentReverb:function(a,b){if(a>=0&&a<this.instrumentStack.length&&"number"==typeof b&&isFinite(b))return this.instrumentStack[a].setReverb(b)},getInstrumentReverb:function(a){if(a>=0&&a<this.instrumentStack.length)return Dacapo.context?this.instrumentStack[a].getReverb():0},muteAllInstruments:function(){var a;for(a=0;a<this.instrumentStack.length;a++)this.instrumentStack[a].mute()},unmuteAllInstruments:function(){var a;for(a=0;a<this.instrumentStack.length;a++)this.instrumentStack[a].unmute()},setInstrumentSolo:function(a){a>=0&&a<this.instrumentStack.length&&Dacapo.context&&(this.instrumentStack[a].isSolo()||(0===this.soloCount&&this.muteAllInstruments(),this.instrumentStack[a].setSoloMode(),this.soloCount++))},unsetInstrumentSolo:function(a){a>=0&&a<this.instrumentStack.length&&Dacapo.context&&this.instrumentStack[a].isSolo()&&(this.instrumentStack[a].unsetSoloMode(),0===--this.soloCount&&this.unmuteAllInstruments())},isInstrumentSolo:function(a){if(a>=0&&a<this.instrumentStack.length&&Dacapo.context)return this.instrumentStack[a].isSolo()},getMasterVolume:function(){return Dacapo.context?Dacapo.mainOutput.getGain():1},getCursorPosition:function(){return null},getCurrentPosition:function(){if(this.transport){var a=this.transport.getHeadPosition(this.selected);return{measureIdx:a.currentMeasure,quarterPos:a.timeFromMeasureStart/Dacapo.unitDuration}}},preloadSamples:function(a,b){var c,d=0,e=function(){d+1>=a.length&&"function"==typeof b&&b(),d++};for(e(),c=0;c<a.length;c++)this.instrumentStack[c]&&this.instrumentStack[c].preloadSamples(a[c],e)},setData:function(a){this.data=a,a&&(this.commonContent=a.getCommonContent())},setMidiOutput:function(a){this.midiOutput=a},enableMidiOutput:function(){this.midiOutputEnabled=!0},disableMidiOutput:function(){this.midiOutputEnabled=!1}}}.call(this),function(){"use strict";Dacapo.Generator=function(){this.display_name="",Dacapo.context?(this.outputGain=Dacapo.context.createGain(),this.output=Dacapo.context.createGain(),this.outputGain.connect(this.output)):(this.outputGain=null,this.output=null),this.active=!0},Dacapo.Generator.prototype={setName:function(a){this.display_name=a},getName:function(){return this.display_name},connectTo:function(a){if("[object GainNode]"===Object.prototype.toString.call(a.input))return this.output.connect(a.input),a;console.error("Error connecting ",a,"to",this)},connect:function(a){this.output&&this.output.connect(a)},disconnect:function(){this.output&&this.output.disconnect()},switchOn:function(){this.active||(this.active=!0,this.outputGain&&this.output&&this.outputGain.connect(this.output))},switchOff:function(){this.active&&(this.active=!1,this.outputGain&&this.outputGain.disconnect())},isOn:function(){return this.active},setVolume:function(a){this.outputGain&&(this.outputGain.gain.value=a)},getVolume:function(){return this.outputGain?this.outputGain.gain.value:1}}}.call(this),function(){"use strict";Dacapo.Oscillator=function(){Dacapo.Generator.call(this),this.nodes=[],this.playingOsc=[],this.modTarget={freq:null,gain:null},this.setType(0),this.switchOn()},Dacapo.Oscillator.prototype=Object.create(Dacapo.Generator.prototype),Dacapo.Oscillator.prototype.setFrequency=function(a){return void 0!==a&&(this.osc.frequency.cancelScheduledValues(0),this.osc.frequency.setValueAtTime(a,0),!0)},Dacapo.Oscillator.prototype.getFrequency=function(){return this.osc.frequency.value},Dacapo.Oscillator.prototype.setType=function(a){if("string"==typeof a)this.type=a;else{if("number"!=typeof a)return!1;if(!((a=parseInt(a))>=0&&a<=3))return!1;this.type=Dacapo.Utils.oscWaves[a]}return!0},Dacapo.Oscillator.prototype.getType=function(){return this.osc.frequency.type},Dacapo.Oscillator.prototype.setMIDINote=function(a){this.setFrequency(Dacapo.Utils.MIDIToFreq(a))},Dacapo.Oscillator.prototype.playNote=function(a,b){var c=Dacapo.context.createOscillator(),d=Dacapo.context.createGain();d.connect(this.outputGain),c.type=this.type,c.frequency.value=Dacapo.Utils.MIDIToFreq(a),c.connect(d),d.gain.value=1,c.start(Dacapo.context.currentTime),this.playingOsc.push({osc:c,gain:d});var e=this.playingOsc.length-1;return void 0!==b&&null!==b&&0!==b&&(d.gain.linearRampToValueAtTime(.01,Dacapo.context.currentTime+b),this.playingOsc[e].timerId=Dacapo.WorkerTimer.setTimeout(function(){c.stop(0),d.disconnect(),c.disconnect()},Dacapo.context.currentTime+1e3*b)),e},Dacapo.Oscillator.prototype.instantPlayNote=function(a){var b=Dacapo.context.createOscillator(),c=Dacapo.context.createGain();c.connect(this.outputGain),b.type=this.osc.type,b.frequency.value=Dacapo.Utils.MIDIToFreq(a),b.connect(c),b.start(Dacapo.context.currentTime),c.gain.value=1},Dacapo.Oscillator.prototype.stopNote=function(a){var b=this.playingOsc[a];b.osc.stop(0),b.osc.disconnect(),b.gain.disconnect(),Dacapo.WorkerTimer.clearTimeout(b.timerId)},Dacapo.Oscillator.prototype.stopNotes=function(){for(var a=0;a<this.playingOsc.length;a++)null!==this.playingOsc[a]&&this.stopNote(a);this.playingOsc=[]},Dacapo.Oscillator.prototype.getMIDINote=function(){return Dacapo.Utils.FreqToMIDI(this.getFrequency())},Dacapo.Oscillator.prototype.slideFreq=function(a,b){this.osc.frequency.setValueAtTime(this.getFrequency(),Dacapo.now),this.osc.frequency.linearRampToValueAtTime(a,Dacapo.now+b)}}.call(this),function(){"use strict";Dacapo.SFBuffer=function(){this.encodedSamples={},this.PCMSamples={},this.instrumentId=0,this.subBuffers={}},Dacapo.SFBuffer.prototype.init=function(a,b,c,d){var e,f,g=[a.id];for(this.id=a.id,this.loaderList={},this.cbLoaded=b,this.cbLoading=d,a.children&&(g=g.concat(Object.keys(a.children))),e=0;e<g.length;e++)e>0?(f=new Dacapo.SFBuffer,this.subBuffers[g[e]]=f,g[e]=a.children[g[e]]):f=this,this.loaderList[g[e]]=0,f.downloadSoundfont(g[e],this.loadedChild.bind(this),c)},Dacapo.SFBuffer.prototype.loadedChild=function(a,b){this.loaderList[b]=1;for(var c in this.loaderList)if(0===this.loaderList[c])return;return this.cbLoaded(null,this.id)},Dacapo.SFBuffer.prototype.decodeAudioData=function(a){return new Promise(function(b,c){Dacapo.context.decodeAudioData(a,function(a){b(a)},function(a){c(Error(a))})})},Dacapo.SFBuffer.prototype.loadKeyfont=function(a){var b=this.encodedSamples[a];return void 0!==b&&this.decodeAudioData(b).then(function(b){return this.PCMSamples[a]=b,b}.bind(this)).catch(function(a){return a})},Dacapo.SFBuffer.prototype.preloadAll=function(){for(var a in this.encodedSamples)this.encodedSamples[a]&&this.loadKeyfont(a)},Dacapo.SFBuffer.prototype.setKeyfont=function(a,b){var c=a[b].split(",")[1],d=Dacapo.Utils.KeyToNote[b],e=Dacapo.Base64Binary.decodeArrayBuffer(c);this.encodedSamples[d]=e},Dacapo.SFBuffer.prototype.setSoundfont=function(a,b){for(var c in a)a.hasOwnProperty(c)&&this.setKeyfont(a,c);b()},Dacapo.SFBuffer.prototype.chooseBestFormat=function(){if("undefined"==typeof Audio)return"Web Audio API is not supported";var a=new Audio;if(void 0===a.canPlayType)return"Audio.canPlayType is not supported";var b=a.canPlayType('audio/ogg; codecs="vorbis"');if("probably"===b||"maybe"===b)return"ogg";var c=a.canPlayType("audio/mpeg");return"probably"===c||"maybe"===c?"mp3":"Neither ogg nor mp3 are supported"},Dacapo.SFBuffer.prototype.downloadSoundfont=function(a,b,c,d){var e,f,g;if(this.id=a,e=baseurl+"/soundfonts/"+a,"ogg"!==(g=this.chooseBestFormat())&&"mp3"!==g)return b(g);e=e+"-"+g+".json",f=new XMLHttpRequest,f.open("GET",e,!0),f.responseType="json",f.onprogress=function(b){d&&d(b,a)},f.onload=function(){if(f.status<400&&f.response&&"[object Object]"===Object.prototype.toString.call(f.response))try{this.setSoundfont(f.response,function(){b&&b(null,a)})}catch(b){throw new Error("Unable to load soundfont "+a+". "+b)}}.bind(this),f.onerror=function(){"function"==typeof c&&c(a)},f.onabort=function(){"function"==typeof c&&c(a)},f.send()},Dacapo.SFBuffer.prototype.getNote=function(a,b){return b&&this.subBuffers[b]?this.subBuffers[b].getNote(a):this.PCMSamples[a]?Promise.resolve(this.PCMSamples[a]):this.encodedSamples[a]?this.loadKeyfont(a):Promise.reject(Error("Out of range"))},Dacapo.SFBuffer.prototype.hasNote=function(a,b){return b?!!this.subBuffers[b]&&this.subBuffers[b].hasNote(a):!!this.encodedSamples[a]},Dacapo.SFBuffer.prototype.hasMode=function(a){return void 0!==this.subBuffers[a]}}.call(this),function(){"use strict";Dacapo.SFBuffer2=function(){this.encodedSamples={},this.PCMSamples={},this.instrumentId=0,this.subBuffers={},this.info={}},Dacapo.SFBuffer2.prototype.init=function(a,b,c,d){var e,f,g=[a.id];for(this.info=a,this.samples=this.info.samples,"number"==typeof this.samples&&(this.samples=Dacapo.Utils.InstrumentConf[this.samples].samples),this.id=a.id,this.loaderList={},this.cbLoaded=b,this.cbLoading=d,a.children&&(g=g.concat(Object.keys(a.children))),e=0;e<g.length;e++)e>0?(f=new Dacapo.SFBuffer2,this.subBuffers[g[e]]=f,g[e]=a.children[g[e]]):f=this,this.loaderList[g[e]]=0,f.downloadSamples(g[e],this.loadedChild.bind(this),c)},Dacapo.SFBuffer2.prototype.loadedChild=function(a,b){this.loaderList[b]=1;for(var c in this.loaderList)if(0===this.loaderList[c])return;return this.cbLoaded(null,this.id)},Dacapo.SFBuffer2.prototype.decodeAudioData=function(a){return new Promise(function(b,c){Dacapo.context.decodeAudioData(a,function(a){b(a)},function(a){c(Error(a))})})},Dacapo.SFBuffer2.prototype.loadKeyfont=function(a){var b=this.encodedSamples[a];return void 0!==b&&this.decodeAudioData(b).then(function(b){return this.PCMSamples[a]=b,b}.bind(this)).catch(function(a){return a})},Dacapo.SFBuffer2.prototype.preloadAll=function(){for(var a in this.encodedSamples)this.encodedSamples[a]&&this.loadKeyfont(a)},Dacapo.SFBuffer2.prototype.setKeyfont=function(a,b){var c=a[b].split(",")[1],d=Dacapo.Utils.KeyToNote[b],e=Dacapo.Base64Binary.decodeArrayBuffer(c);this.encodedSamples[d]=e},Dacapo.SFBuffer.prototype.setSoundfont=function(a,b){for(var c in a)a.hasOwnProperty(c)&&this.setKeyfont(a,c);b()},Dacapo.SFBuffer2.prototype.downloadSoundfont=function(a,b,c,d){var e,f,g;if(this.id=a,e=baseurl+"/soundfonts/"+a,"ogg"!==(g=this.chooseBestFormat())&&"mp3"!==g)return b(g);e=e+"-"+g+".json",f=new XMLHttpRequest,f.open("GET",e,!0),f.responseType="json",f.onprogress=function(b){d&&d(b,a)},f.onload=function(){if(f.status<400&&f.response&&"[object Object]"===Object.prototype.toString.call(f.response))try{this.setSoundfont(f.response,function(){b&&b(null,a)})}catch(b){throw new Error("Unable to load soundfont "+a+". "+b)}}.bind(this),f.onerror=function(){"function"==typeof c&&c(a)},f.onabort=function(){"function"==typeof c&&c(a)},f.send()},Dacapo.SFBuffer2.prototype.setSample=function(a,b){var c=Dacapo.Utils.KeyToNote[a];return this.decodeAudioData(b).then(function(a){this.PCMSamples[c]=a}.bind(this))},Dacapo.SFBuffer2.prototype.downloadSamples=function(a,b,c){var d,e,f,g={},h=[];for(this.id=a,f=function(a,d,e){a?(void 0===g[e]?g[e]=0:g[e]++,g[e]<3?this.downloadSample(d,e,f):c(d,a)):-1===h.indexOf(e)&&(h.push(e),b&&h.length===this.samples.length&&b(null,d))}.bind(this),d=0;d<this.samples.length;d++)e=this.samples[d].notename,this.downloadSample(a,e,f)},Dacapo.SFBuffer2.prototype.downloadSample=function(a,b,c){var d,e;e=baseurl+"/samples/"+a+"/stereo/"+b+".wav",d=new XMLHttpRequest,d.open("GET",e,!0),d.responseType="arraybuffer",d.onload=function(){d.status<400&&d.response&&this.setSample(b,d.response).then(function(){c(null,a,b)}).catch(function(d){c(d,a,b)})}.bind(this),d.onerror=function(d){"function"==typeof c&&c(new Error("Unable to download soundfont "+a+". "+d),a,b)},d.onabort=d.onerror,d.send()},Dacapo.SFBuffer2.prototype.getNote=function(a,b){return b&&this.subBuffers[b]?this.subBuffers[b].getNote(a):this.PCMSamples[a]?Promise.resolve(this.PCMSamples[a]):this.encodedSamples[a]?this.loadKeyfont(a):Promise.reject(Error("Out of range"))},Dacapo.SFBuffer2.prototype.hasNote=function(a,b){return b?!!this.subBuffers[b]&&this.subBuffers[b].hasNote(a):!!this.encodedSamples[a]},Dacapo.SFBuffer2.prototype.hasMode=function(a){return void 0!==this.subBuffers[a]}}.call(this),function(){var a,b,c;"undefined"!=typeof require?(a=require("fs"),b=require("path"),c=require("async")):a=null,Dacapo.Sampler=function(a){Dacapo.Generator.call(this);var b;for(this.nodes=[],this.ready=!1,this.transposition=0,this.drumSet=!1,this.shortenRatio=.95,this.release=1,this.slur=!1,this.solo=!1,this.playing=[],b=0;b<128;b++)this.playing[b]=[];Dacapo.context&&(this.reverbEffect=new Dacapo.Tools.Reverb,this.outputGain.connect(this.reverbEffect.input),this.reverbEffect.output.connect(this.output)),this.playingPreview={},this.infos={},this.bufferWriter=a,this.sfBuffer=null,this.instInfo=null,this.offset=0,this.headerInstrument={},this.tremoloTable=Dacapo.Values.Expression.tremolo.pattern,this.volumeOutput=1,this.switchOn()},Dacapo.Sampler.prototype=Object.create(Dacapo.Generator.prototype),Dacapo.Sampler.prototype.setSample=function(a,b,c){c.constructor!==Array&&(c=this.samples),b?c[Dacapo.Utils.KeyToNote[b]]=a:c.push(a),this.ready=!0},Dacapo.Sampler.prototype.setKeyfont=function(a,b,c){var d=a.obj[b].split(",")[1],e=Dacapo.Base64Binary.decodeArrayBuffer(d);Dacapo.context.decodeAudioData(e,function(a){a.id=b,this.samples[Dacapo.Utils.KeyToNote[a.id]]=a,this.samples.length===Dacapo.Utils.Keys.length&&c()}.bind(this),function(a){console.log(a)})},Dacapo.Sampler.prototype.setSoundfont=function(a,b,c){var d=null;b.obj=a,b.hasOwnProperty("transposechromatic")&&this.transpose(b.transposechromatic);for(var e=0,f=Dacapo.Utils.Keys.length;e<f;e++)d=Dacapo.Utils.Keys[e],b.obj[d]&&this.setKeyfont(b,d,c)},Dacapo.Sampler.prototype.loadSample=function(a,b,c){var d=new XMLHttpRequest;d.open("GET",a.url,!0),d.responseType="arraybuffer",d.onprogress=function(b){c&&c(b,a)},d.onload=function(){Dacapo.context.decodeAudioData(d.response,function(c){a.buffer=c,this.setSample(a),b(a)}.bind(this))}.bind(this),d.send()},Dacapo.Sampler.prototype.downloadSoundfont=function(a,b,c){a.url=baseurl+"/soundfonts/"+a.id;var d=this.chooseBestFormat();if("ogg"!==d&&"mp3"!==d)return b(d);var e=a.url+"-"+d+".json",f=new XMLHttpRequest;f.open("GET",e,!0),f.responseType="json",f.onprogress=function(b){c&&c(b,a)},f.onload=function(){this.setSoundfont(f.response,a,function(){b&&b(null,a)})}.bind(this),f.send()},Dacapo.Sampler.prototype.loadPCMFiles=function(d,e){a&&(d.hasOwnProperty("transposechromatic")&&this.transpose(d.transposechromatic),this.infos.startLoop=d.sustainStart,this.infos.endLoop=d.sustainEnd,d.path||(d.path=b.join(__dirname,"..","src","soundfonts",d.id)),a.readdir(d.path,function(f,g){f?e&&e(f):c.each(g,function(c,e){var f=b.basename(c,".f32");a.readFile(b.join(d.path,c),{encoding:"binary"},function(a,b){if(a)return e(a);this.storeData(f,b,this.samples),e()}.bind(this))}.bind(this),function(a){e&&e(a)})}.bind(this)))},Dacapo.Sampler.prototype.storeData=function(a,b,c){for(var d=new Buffer(b,"binary"),e=new Float32Array(d.length/4>>0),f=0,g=0;f<d.length&&g<e.length;f+=4,g++)e[g]=d.readFloatLE(f);this.setSample(e,a,c)},Dacapo.Sampler.prototype.loadInstrument=function(c,d,e,f){d&&this.setVolume(d),a?(c.path=b.join(__dirname,"..","src","soundfonts",c.id+"-pcm.json"),a.readFile(c.path,function(a,b){if(a)return void console.log(a);this.setRawSoundfont(JSON.parse(b),c,function(){e&&e(null,c)})}.bind(this))):this.downloadSoundfont(c,e,f)},Dacapo.Sampler.prototype.setInstrumentInfo=function(a){var c;if(this.instInfo=a,this.transpose(a.transposechromatic),void 0!==a.shorten&&(this.shortenRatio=a.shorten),this.slur=a.slur,this.release=a.release||.1,a.pathPrefix&&(this.samples=[],this.paths={normal:b.join(a.pathPrefix,a.id)},this.subSamples={},a.children))for(c in a.children)a.children.hasOwnProperty(c)&&(this.subSamples[c]=[],this.paths[c]=b.join(a.pathPrefix,a.children[c]))},Dacapo.Sampler.prototype.preloadSamples=function(a,b){var c,d=0,e=function(){0!==a.length&&d+1!==a.length||"function"==typeof b&&b(),d++};for(e(),c=0;c<a.length;c++)this.sfBuffer.getNote(a[c]).then(e).catch(e)},Dacapo.Sampler.prototype.getNoteName=function(a){if("number"==typeof a){if(a>128&&(a=Dacapo.Utils.MapUnpitched[a]||129),a>128||a<0)throw new Error("Note out of range")}else this.drumSet&&Adagio.Utils.partHeaderUtils.hasInstrumentId(this.headerInstrument,a)&&(a=Number(Adagio.Utils.partHeaderUtils.searchInstrumentMIDIUnpitched(this.headerInstrument,a))-1)>128&&(a=Dacapo.Utils.MapUnpitched[a]);if(this.sfBuffer&&!this.sfBuffer.hasNote(a))throw new Error("Note does not exists");return a},Dacapo.Sampler.prototype.hasPairNoteRolls=function(a){return!!(this.instInfo.pairNotes&&this.instInfo.pairNotes[a]&&this.instInfo.pairNotes[a].roll)},Dacapo.Sampler.prototype.createFilters=function(a,b,c){var d,e=Math.floor(3*Math.random());if(b){if(a>71||0!==e)return;for(d=0;d<b.length;d++)b[d].frequencyMultiplier&&(b[d].frequency=c*b[d].frequencyMultiplier)}return b},Dacapo.Sampler.prototype.playTremolo=function(a,b){var c,d,e,f,g,h,i,j,k=1,l=a.velocity,m=a.release,n=a.duration,o=!1;if(isFinite(n)||(o=!0,n=a.origDuration),void 0!==this.instInfo.tremolo||this.drumSet)if(j=this.drumSet?.5:.7,e=j/Math.pow(2,3),f=1/e,k=n/e,"amplitude"===this.instInfo.tremolo)a.lfoVol=Dacapo.context.createGain(),d=new Dacapo.LFO(f),d.connect(a.lfoVol.gain),d.start(),this.playSample(a,b);else if("friction"!==this.instInfo.tremolo||a.pizzicato)if("strum"===this.instInfo.tremolo)for(h=e,a.duration=h,c=0;c<k;c++)a.attack=0===c?0:.01,a.release=m,a.velocity=.5*Math.random()+l-.5,this.playSample(a,b),h=a.duration,a.duration=.001*Math.random()+e-5e-4,b+=h;else if(this.hasPairNoteRolls(a.note))for(g=this.getPairNote(a.note),c=0;c<k;c++)this.playSample(a,b+c++*e),c<k&&this.playSample(g,b+c*e);else for(h=e,a.duration=o?1/0:h,c=0;c<k;c++)this.drumSet?(a.detune=c%2==1?Math.floor(50*Math.random())-50:Math.floor(20*Math.random()),a.velocity=.4*Math.random()+l-.2):a.velocity=.6*Math.random()+l-.3,this.playSample(a,b),b+=h,h=1e-4*Math.random()+e-5e-5,a.duration=o?1/0:h;else for(Dacapo.Utils.MIDIToFreq(a.note),h=e+.004,a.duration=h,c=0;c<k;c++)a.attack=0===c?0:.04,a.detune=c%2==1?30*Math.random()-30:0,a.release=c===k-1?m:.5,a.velocity=c%2==1?l:l-.25,this.playSample(a,b),h=a.duration,i=this.tremoloTable[c%this.tremoloTable.length],a.duration=e+i.duration,a.attack=i.attack,b+=h},Dacapo.Sampler.prototype.playTrill=function(a,b){var c,d,e,f,g,h,i,j=a.note,k=1,l=!1,m=a.duration;try{d=this.getNoteName(a.trillPitch)}catch(a){return}for(isFinite(m)||(l=!0,m=a.origDuration),f=.7,g=f/8,1/g,k=m/g-4,e=k/2,h=.15/e,i=4*g,a.duration=l?1/0:i,this.playSample(a,b),b+=i,c=0;c<k;c++)i=2e-4*Math.random()+g-1e-4,a.duration=l?1/0:i,c<e?a.velocity+=h:c>=e&&(a.velocity-=2*h),a.note=c%2==0?d:j,this.playSample(a,b),b+=i},Dacapo.Sampler.prototype.playGlissando=function(a,b){var c,d,e=a.glissando.totalDuration,f=a.glissando.pitch,g=Math.abs(f-a.pitch);if("slide"===this.instInfo.glissando)a.slide=!0,this.playSample(a,b);else{if(d=.05,isFinite(a.duration)&&(a.duration=d),g*d>e&&(d=e/(g+1)),delete a.glissando,a.pitch<f)for(c=a.pitch;c<f;c++){try{a.note=this.getNoteName(c)}catch(a){continue}this.playSample(a,b),b+=d,e-=d}else for(c=a.pitch;c>f;c--){try{a.note=this.getNoteName(c)}catch(a){continue}this.playSample(a,b),b+=d,e-=d}a.pitch=f,a.duration=e,this.scheduleNote(a,b)}},Dacapo.Sampler.prototype.playEffects=function(a,b){return-1!==a.effects.indexOf(Adagio.Values.OrnamentType.TREMOLO)?this.playTremolo(a,b):-1===a.effects.indexOf(Adagio.Values.OrnamentType.TRILLMARK)||this.drumSet?this.playSampleNormal(a,b):this.playTrill(a,b)},Dacapo.Sampler.prototype.playNote=function(a){var b=Dacapo.context.currentTime;try{a.note=this.getNoteName(a.pitch)}catch(a){return}return a.release=this.release,a.velocity=a.velocity||.8,a.effects&&a.effects.length>0?this.playEffects(a,b):a.glissando?this.playGlissando(a,b):this.playSampleNormal(a,b)},Dacapo.Sampler.prototype.scheduleNote=function(a,b){if(void 0===a.pauseOffset){try{a.note=this.getNoteName(a.pitch)}catch(a){return}a.release=this.release,a.velocity=a.velocity||.8}return a.effects&&a.effects.length>0?this.playEffects(a,b):a.glissando?this.playGlissando(a,b):this.playSampleNormal(a,b)},Dacapo.Sampler.prototype.playSampleNormal=function(a,b){return(isNaN(a.duration)||this.drumSet)&&(a.duration=1/0),void 0===a.pauseOffset&&(a.sampleStart=a.pauseOffset),this.playSample(a,b)},Dacapo.Sampler.prototype.applyFilters=function(a,b){var c,d,e=null;for(c=0;c<a.length;c++)d=Dacapo.context.createBiquadFilter(),d.type=a[c].type,d.frequency.value=a[c].frequency,d.Q.value=a[c].q,d.gain.value=a[c].gain,e?e.connect(d):b.connect(d),e=d;d.connect(this.outputGain)},Dacapo.Sampler.prototype.playSample=function(a,b){var c,d,e,f,g=a.lfoVol,h=a.srcVol||Dacapo.context.createGain(),i=a.src||Dacapo.context.createBufferSource();return b=b||Dacapo.context.currentTime,a=JSON.parse(JSON.stringify(a)),a.filters?this.applyFilters(a.filters,h):h.connect(this.outputGain),g?(i.connect(g),g.connect(h)):i.connect(h),a.detune&&i.detune&&(i.detune.value=a.detune),a.pizzicato&&(f="pizzicato"),this.saveNote(i,h,a,b),this.sfBuffer.getNote(a.note,f).then(function(f){i.buffer=f,this.computeEnvelope(a,f.duration),a.attack?(h.gain.setValueAtTime(0,b),h.gain.linearRampToValueAtTime(a.velocity,b+a.attack)):h.gain.value=a.velocity,a.slide&&(c=Dacapo.Utils.MIDIToFreq(a.note),d=Dacapo.Utils.MIDIToFreq(a.glissando.pitch),e=d/c,i.playbackRate.setValueCurveAtTime(new Float32Array([1,.1*(e-1)+1,e]),b,a.duration)),this.playSourceNode(i,h,a,b)}.bind(this)),{srcVol:h,src:i}},Dacapo.Sampler.prototype.playSourceNode=function(a,b,c,d){c.sampleStart?a.start(d,c.sampleStart):a.start(d),c.duration&&c.duration>0&&isFinite(c.duration)&&(b.gain.setTargetAtTime(0,d+c.duration,c.release/8),a.stop(d+c.duration+c.release+1),this.setNodeKilling(a,b,c,d-Dacapo.context.currentTime+c.duration+c.release+1))},Dacapo.Sampler.prototype.saveNote=function(a,b,c,d){var e;e={sample:a,gain:b,release:c.release,startTime:d,stopTime:d+c.duration+c.release+1,duration:c.duration,origDuration:c.origDuration},c.preview?this.playingPreview[c.note]=e:this.playing[c.note].push(e)},Dacapo.Sampler.prototype.setNodeKilling=function(a,b,c,d){return Dacapo.WorkerTimer.setTimeout(function(){this.killSourceNode(a,b,c.note,c.preview)}.bind(this),1e3*d)},Dacapo.Sampler.prototype.killSourceNode=function(a,b,c,d){b.disconnect(),a.disconnect(),d&&delete this.playingPreview[c]},Dacapo.Sampler.prototype.computeEnvelope=function(a,b){a.duration=this.getDuration(b,a.duration,a.slurIdx),a.velocity=this.getVelocity(a.slurIdx,a.velocity),a.release=this.getRelease(b,a.duration,a.note,a.release)},Dacapo.Sampler.prototype.getDuration=function(a,b,c){if(b>=a)return a-.15;if(null!==c){if(this.slur)return c<2?1.1*b:.8*b;if(2===c)return.75*b}return b*this.shortenRatio},Dacapo.Sampler.prototype.getVelocity=function(a,b){if(this.slur){if(a>0)return.85*b}else{if(1===a)return.9*b;if(2===a)return 1.15*b}return b*Dacapo.Utils.TEMPORARY_AMP},Dacapo.Sampler.prototype.getRelease=function(a,b,c,d){var e=d||this.release;return b<a?(e*=60/c,b+e>a&&(e=a-b)):e=0,e},Dacapo.Sampler.prototype.writeNote=function(c){var d,e,f,g,h,i;if(void 0!==this.bufferWriter){try{c.note=this.getNoteName(c.pitch)}catch(a){return 1}if(i=this.samples,f=this.paths.normal,g=c.offset||0,g*=88200,c.pizzicato&&this.subSamples.pizzicato&&(i=this.subSamples.pizzicato,f=this.paths.pizzicato),void 0===i[c.note]){d=Dacapo.Utils.NoteToKey[c.note],a.access(f,function(a){if(a)throw a});try{e=a.readFileSync(b.join(f,d+".f32"),{encoding:"binary"})}catch(a){if("ENOENT"===a.code)return 1;throw a}this.storeData(d,e,i)}return("number"!=typeof c.velocity||isNaN(c.velocity))&&(c.velocity=.8),h=i[c.note].length/2/44100,isNaN(c.duration)||this.drumSet?c.duration=1/0:c.duration=this.getDuration(h,c.duration,c.slurIdx),c.velocity=this.getVelocity(c.slurIdx,c.velocity),c.release=this.getRelease(h,c.duration,c.note)/8,this.bufferWriter.write(i[c.note],c.duration,c.release,this.offset+g,c.velocity*this.volumeOutput)}return 0},Dacapo.Sampler.prototype.updateOffset=function(a){return this.offset+=44100*a*2,this.offset>=this.bufferWriter.totalLength?0:1},Dacapo.Sampler.prototype.transpose=function(a){void 0!==a&&(this.transposition=a)},Dacapo.Sampler.prototype.getTranspo=function(){return this.transposition},Dacapo.Sampler.prototype.stopNote=function(a,b){var c,d=b;if(this.playing[a])for(;c=this.playing[a].shift();)void 0===b&&(d=c.release/8),c.gain.gain.setTargetAtTime(0,Dacapo.context.currentTime,d),c.timer&&Dacapo.WorkerTimer.clearTimeout(c.timer),c.timer=this.setNodeKilling(c.sample,c.gain,{note:a,preview:!1},c.release)},Dacapo.Sampler.prototype.stopVoice=function(a,b){for(var c=0,d=this.playing[a].length;c<d;c++)this.stopNote(a,b);this.playing[a]=[]},Dacapo.Sampler.prototype.stopNotes=function(a){for(var b=0;b<this.playing.length;b++)this.playing[b].constructor===Array&&this.playing[b].length>0&&this.stopVoice(b,a)},Dacapo.Sampler.prototype.stopNotePreview=function(a){var b;this.playingPreview[a]&&(b=this.playingPreview[a])&&(b.gain.gain.setTargetAtTime(0,Dacapo.context.currentTime,b.release/8),b.timer&&Dacapo.WorkerTimer.clearTimeout(b.timer),this.setNodeKilling(b.sample,b.gain,{note:a,preview:!0},b.release))},Dacapo.Sampler.prototype.stopNotesPreview=function(){for(var a in this.playingPreview)this.playingPreview.hasOwnProperty(a)&&this.stopNotePreview(a)},Dacapo.Sampler.prototype.stopPedalForVoice=function(a,b){var c,d;for(c=0;c<this.playing[a].length;c++)d=this.playing[a][c],d.startTime<b&&d.startTime+d.origDuration<=b?d.gain.gain.setTargetAtTime(0,b,d.release/32):d.startTime<b&&d.startTime+d.origDuration>b&&(d.duration=d.origDuration,d.stopTime=d.startTime+d.duration,d.gain.gain.setTargetAtTime(0,d.stopTime,d.release/8))},Dacapo.Sampler.prototype.stopPedal=function(a){for(var b=0;b<this.playing.length;b++)this.playing[b].constructor===Array&&this.playing[b].length>0&&this.stopPedalForVoice(b,a)},Dacapo.Sampler.prototype.setVolume=function(a){this.volumeOutput=a,this.outputGain&&(this.outputGain.gain.value=a)},Dacapo.Sampler.prototype.mute=function(){this.output&&(this.output.gain.value=0)},Dacapo.Sampler.prototype.unmute=function(){this.output&&(this.output.gain.value=1)},Dacapo.Sampler.prototype.setSoloMode=function(){this.unmute(),this.solo=!0},Dacapo.Sampler.prototype.unsetSoloMode=function(){this.mute(),this.solo=!1},Dacapo.Sampler.prototype.isSolo=function(){return this.solo},Dacapo.Sampler.prototype.setReverb=function(a){var b;this.reverbEffect&&(b=a/20,this.reverbEffect.setDuration(b))},Dacapo.Sampler.prototype.getReverb=function(){if(this.reverbEffect)return 20*this.reverbEffect.getDuration()},Dacapo.Sampler.prototype.setDrumSet=function(a){this.drumSet=a},Dacapo.Sampler.prototype.setHeader=function(a){this.headerInstrument=a},Dacapo.Sampler.prototype.setSFBuffer=function(a){this.sfBuffer=a},Dacapo.Sampler.prototype.getPCMData=function(){return this.samples},Dacapo.Sampler.prototype.hasMode=function(a){return this.instInfo.children&&this.instInfo.children[a]}}.call(this),function(){"use strict";Dacapo.SamplerV2=function(){Dacapo.Generator.call(this);var a;for(this.nodes=[],this.ready=!1,this.transposition=0,this.drumSet=!1,this.shortenRatio=.95,this.slur=!1,this.solo=!1,this.playing=[],a=0;a<128;a++)this.playing[a]=[];this.playingPreview={},Dacapo.context&&(this.reverbEffect=new Dacapo.Tools.Reverb,this.outputGain.connect(this.reverbEffect.input),this.reverbEffect.output.connect(this.output)),this.headerInstrument={},this.tremoloTable=Dacapo.Values.Expression.tremolo.pattern,this.instInfo={},this.volumeOutput=1,this.switchOn()},Dacapo.SamplerV2.prototype=Object.create(Dacapo.Generator.prototype),Dacapo.SamplerV2.prototype.setInstrumentInfo=function(a){this.instInfo=a,this.transpose(a.transposechromatic),this.sampleList=this.instInfo.samples,"number"==typeof this.sampleList&&(this.sampleList=Dacapo.Utils.InstrumentConf[this.sampleList].samples),void 0!==a.shorten&&(this.shortenRatio=a.shorten),this.slur=a.slur},Dacapo.SamplerV2.prototype.getClosestSampleInfo=function(a){var b,c;for(b=0;b<this.sampleList.length;b++){if(c=this.sampleList[b],a>=c.range.start&&a<=c.range.end)return c;if(a<c.range.start)return c}return c},Dacapo.SamplerV2.prototype.computePlaybackRate=function(a,b){var c;return c=a-b.basenote,Math.pow(2,c/12)},Dacapo.SamplerV2.prototype.getNoteInfo=function(a){var b;return b=this.getClosestSampleInfo(a),{basenote:b.basenote,detune:b.detune||0,playbackRate:this.computePlaybackRate(a,b),loop:b.loop,sampleRate:b.sampleRate||this.instInfo.sampleRate,filter:b.filter||this.instInfo.filter,attenuation:b.attenuation||this.instInfo.attenuation,envelope:{attack:b.attack||this.instInfo.attack||0,hold:b.hold||this.instInfo.hold||0,decay:b.decay||this.instInfo.decay,sustain:b.sustain||this.instInfo.sustain||1e-5,release:b.release||this.instInfo.release||.1}}},Dacapo.SamplerV2.prototype.preloadSamples=function(a,b){b()},Dacapo.SamplerV2.prototype.getNoteName=function(a){if("number"==typeof a){if(a>128&&(a=Dacapo.Utils.MapUnpitched[a]||129),a>128||a<0)throw new Error("Note out of range")}else this.drumSet&&Adagio.Utils.partHeaderUtils.hasInstrumentId(this.headerInstrument,a)&&(a=Number(Adagio.Utils.partHeaderUtils.searchInstrumentMIDIUnpitched(this.headerInstrument,a))-1)>128&&(a=Dacapo.Utils.MapUnpitched[a]);return a},Dacapo.SamplerV2.prototype.hasPairNoteRolls=function(a){return!!(this.instInfo.pairNotes&&this.instInfo.pairNotes[a]&&this.instInfo.pairNotes[a].roll)},Dacapo.SamplerV2.prototype.playTremolo=function(a,b){var c,d,e,f,g,h,i,j,k=1,l=a.velocity,m=a.duration,n=!1;if(isFinite(m)||(n=!0,m=a.origDuration),
void 0!==this.instInfo.tremolo||this.drumSet)if(j=this.drumSet?.5:.7,e=j/Math.pow(2,3),f=1/e,k=m/e,"amplitude"===this.instInfo.tremolo)a.lfoVol=Dacapo.context.createGain(),d=new Dacapo.LFO(f),d.connect(a.lfoVol.gain),d.start(),this.playSample(a,b);else if("friction"!==this.instInfo.tremolo||a.pizzicato)if("strum"===this.instInfo.tremolo)for(h=e,a.duration=h,c=0;c<k;c++)a.attackDiff=0===c?0:.01,a.releaseDiff=0,a.velocity=.5*Math.random()+l-.5,this.playSample(a,b),h=a.duration,a.duration=.001*Math.random()+e-5e-4,b+=h;else if(this.hasPairNoteRolls(a.note))for(g=this.getPairNote(a.note),c=0;c<k;c++)this.playSample(a,b+c++*e),c<k&&this.playSample(g,b+c*e);else for(h=e,a.duration=n?1/0:h,c=0;c<k;c++)this.drumSet?(a.detuneDiff=c%2==1?Math.floor(50*Math.random())-50:Math.floor(20*Math.random()),a.velocity=.4*Math.random()+l-.2):a.velocity=.6*Math.random()+l-.3,this.playSample(a,b),b+=h,h=1e-4*Math.random()+e-5e-5,a.duration=n?1/0:h;else for(Dacapo.Utils.MIDIToFreq(a.note),h=e+.004,a.duration=h,c=0;c<k;c++)a.detuneDiff=c%2==1?30*Math.random()-30:0,a.releaseDiff=c===k-1?0:.5,a.velocity=c%2==1?l:l-.25,this.playSample(a,b),h=a.duration,i=this.tremoloTable[c%this.tremoloTable.length],a.duration=e+i.duration,a.attackDiff=i.attack,b+=h},Dacapo.SamplerV2.prototype.playTrill=function(a,b){var c,d,e,f,g,h,i,j=a.note,k=1,l=!1,m=a.duration;try{d=this.getNoteName(a.trillPitch)}catch(a){return}for(isFinite(m)||(l=!0,m=a.origDuration),f=.7,g=f/8,1/g,k=m/g-4,e=k/2,h=.15/e,i=4*g,a.duration=l?1/0:i,this.playSample(a,b),b+=i,c=0;c<k;c++)i=2e-4*Math.random()+g-1e-4,a.duration=l?1/0:i,c<e?a.velocity+=h:c>=e&&(a.velocity-=2*h),a.note=c%2==0?d:j,this.playSample(a,b),b+=i},Dacapo.SamplerV2.prototype.playNote=function(a){var b=Dacapo.context.currentTime;try{a.note=this.getNoteName(a.pitch)}catch(a){return}return a.release=this.release,a.velocity=a.velocity||.8,a.effects&&a.effects.length>0?this.playEffects(a,b):a.glissando?this.playGlissando(a,b):this.playSampleNormal(a,b)},Dacapo.SamplerV2.prototype.scheduleNote=function(a,b){if(void 0===a.pauseOffset){try{a.note=this.getNoteName(a.pitch)}catch(a){return}a.velocity=a.velocity||.8}return!isFinite(a.duration)&&this.instInfo.maxDuration&&(a.duration=this.instInfo.maxDuration),a.effects&&a.effects.length>0?this.playEffects(a,b):a.glissando?this.playGlissando(a,b):this.playSampleNormal(a,b)},Dacapo.SamplerV2.prototype.playEffects=function(a,b){return-1!==a.effects.indexOf(Adagio.Values.OrnamentType.TREMOLO)?this.playTremolo(a,b):-1===a.effects.indexOf(Adagio.Values.OrnamentType.TRILLMARK)||this.drumSet?this.playSampleNormal(a,b):this.playTrill(a,b)},Dacapo.SamplerV2.prototype.playGlissando=function(a,b){var c,d,e=a.glissando.totalDuration,f=a.glissando.pitch,g=Math.abs(f-a.pitch);if("slide"===this.instInfo.glissando)a.slide=!0,this.playSample(a,b);else{if(d=.05,isFinite(a.duration)&&(a.duration=d),g*d>e&&(d=e/(g+1)),delete a.glissando,a.pitch<f)for(c=a.pitch;c<f;c++){try{a.note=this.getNoteName(c)}catch(a){continue}this.playSample(a,b),b+=d,e-=d}else for(c=a.pitch;c>f;c--){try{a.note=this.getNoteName(c)}catch(a){continue}this.playSample(a,b),b+=d,e-=d}a.pitch=f,a.duration=e,this.scheduleNote(a,b)}},Dacapo.SamplerV2.prototype.playSampleNormal=function(a,b){return(isNaN(a.duration)||this.drumSet)&&(a.duration=1/0),void 0===a.pauseOffset&&(a.sampleStart=a.pauseOffset),this.playSample(a,b)},Dacapo.SamplerV2.prototype.playSample=function(a,b){var c,d,e,f,g,h,i,j=a.lfoVol,k=a.srcVol||Dacapo.context.createGain(),l=a.src||Dacapo.context.createBufferSource(),m=Dacapo.context.createGain();return b=b||Dacapo.context.currentTime,a=JSON.parse(JSON.stringify(a)),c=this.getNoteInfo(a.note),i=a.detuneDiff||0,d=a.filters||[],d.length>0||void 0!==c.filter?(d.unshift(c.filter),this.applyFilters(d,k)):k.connect(this.outputGain),l.connect(m),m.gain.value=1,c.attenuation&&(m.gain.value=c.attenuation),j?(m.connect(j),j.connect(k)):m.connect(k),a.pizzicato&&(h="pizzicato"),this.computeEnvelope(a,c),k.gain.setValueAtTime(0,b),k.gain.linearRampToValueAtTime(a.velocity,b+c.envelope.attack),c.envelope.decay&&k.gain.setTargetAtTime(c.envelope.sustain,b+c.envelope.attack+c.envelope.hold,c.envelope.decay/8),a.slide&&(e=Dacapo.Utils.MIDIToFreq(a.note),f=Dacapo.Utils.MIDIToFreq(a.glissando.pitch),g=f/e,l.playbackRate.setValueCurveAtTime(new Float32Array([1,.1*(g-1)+1,g]),b,a.duration)),this.saveNote(l,k,a,b),this.sfBuffer.getNote(c.basenote,h).then(function(d){l.buffer=d,l.detune&&c.detune+i&&(l.detune.value=c.detune+i),l.playbackRate.value=c.playbackRate,c.loop&&(l.loop=!0,l.loopStart=c.loop.start/c.sampleRate,l.loopEnd=c.loop.end/c.sampleRate),this.playSourceNode(l,k,a,b)}.bind(this)),{srcVol:k,src:l}},Dacapo.SamplerV2.prototype.playSourceNode=function(a,b,c,d){c.sampleStart?a.start(d,c.sampleStart):a.start(d),c.duration&&c.duration>0&&isFinite(c.duration)&&(b.gain.setTargetAtTime(0,d+c.duration,c.release/8),a.stop(d+c.duration+c.release+1),this.setNodeKilling(a,b,c,d-Dacapo.context.currentTime+c.duration+c.release+1))},Dacapo.SamplerV2.prototype.createFilter=function(a){var b;return b=Dacapo.context.createBiquadFilter(),b.type=a.type,b.frequency.value=a.frequency,b.Q.value=a.Q||0,b.gain.value=a.gain||0,b},Dacapo.SamplerV2.prototype.applyFilters=function(a,b){var c,d,e=null;for(c=0;c<a.length;c++)d=this.createFilter(a[c]),e?e.connect(d):b.connect(d),e=d;d.connect(this.outputGain)},Dacapo.SamplerV2.prototype.computeEnvelope=function(a,b){b.envelope.attack=this.getAttack(a,b),a.duration=this.getDuration(a.duration,a.slurIdx),a.velocity=this.getVelocity(a.slurIdx,a.velocity),a.release=this.getRelease(a,b)},Dacapo.SamplerV2.prototype.getAttack=function(a,b){var c=b.envelope.attack;return c+=a.attackDiff||0},Dacapo.SamplerV2.prototype.getDuration=function(a,b){if(null!==b){if(this.slur)return b<2?1.1*a:.8*a;if(2===b)return.75*a}return a*this.shortenRatio},Dacapo.SamplerV2.prototype.getVelocity=function(a,b){if(this.slur){if(a>0)return.85*b}else{if(1===a)return.9*b;if(2===a)return 1.15*b}return b},Dacapo.SamplerV2.prototype.getRelease=function(a,b){var c=a.releaseDiff||0;return b.envelope.release+c},Dacapo.SamplerV2.prototype.saveNote=function(a,b,c,d){var e;e={sample:a,gain:b,release:c.release,startTime:d,stopTime:d+c.duration+c.release+1,duration:c.duration,origDuration:c.origDuration},c.preview?this.playingPreview[c.note]=e:this.playing[c.note].push(e)},Dacapo.SamplerV2.prototype.setNodeKilling=function(a,b,c,d){return Dacapo.WorkerTimer.setTimeout(function(){this.killSourceNode(a,b,c.note,c.preview)}.bind(this),1e3*d)},Dacapo.SamplerV2.prototype.killSourceNode=function(a,b,c,d){b.disconnect(),a.disconnect(),d&&delete this.playingPreview[c]},Dacapo.SamplerV2.prototype.stopNote=function(a,b){var c,d=b;if(this.playing[a])for(;c=this.playing[a].shift();)void 0===b&&(d=c.release/8),c.gain.gain.setTargetAtTime(0,Dacapo.context.currentTime,d),c.timer&&Dacapo.WorkerTimer.clearTimeout(c.timer),c.timer=this.setNodeKilling(c.sample,c.gain,{note:a,preview:!1},c.release)},Dacapo.SamplerV2.prototype.stopVoice=function(a,b){for(var c=0,d=this.playing[a].length;c<d;c++)this.stopNote(a,b);this.playing[a]=[]},Dacapo.SamplerV2.prototype.stopNotes=function(a){for(var b=0;b<this.playing.length;b++)this.playing[b].constructor===Array&&this.playing[b].length>0&&this.stopVoice(b,a)},Dacapo.SamplerV2.prototype.stopNotePreview=function(a){var b;this.playingPreview[a]&&(b=this.playingPreview[a])&&(b.gain.gain.setTargetAtTime(0,Dacapo.context.currentTime,b.release/8),b.timer&&Dacapo.WorkerTimer.clearTimeout(b.timer),this.setNodeKilling(b.sample,b.gain,{note:a,preview:!0},b.release))},Dacapo.SamplerV2.prototype.stopNotesPreview=function(){for(var a in this.playingPreview)this.playingPreview.hasOwnProperty(a)&&this.stopNotePreview(a)},Dacapo.SamplerV2.prototype.stopPedalForVoice=function(a,b){var c,d;for(c=0;c<this.playing[a].length;c++)d=this.playing[a][c],d.startTime<b&&d.startTime+d.origDuration<=b?d.gain.gain.setTargetAtTime(0,b,d.release/32):d.startTime<b&&d.startTime+d.origDuration>b&&(d.duration=d.origDuration,d.stopTime=d.startTime+d.duration,d.gain.gain.setTargetAtTime(0,d.stopTime,d.release/8))},Dacapo.SamplerV2.prototype.stopPedal=function(a){for(var b=0;b<this.playing.length;b++)this.playing[b].constructor===Array&&this.playing[b].length>0&&this.stopPedalForVoice(b,a)},Dacapo.SamplerV2.prototype.transpose=function(a){void 0!==a&&(this.transposition=a)},Dacapo.SamplerV2.prototype.getTranspo=function(){return this.transposition},Dacapo.SamplerV2.prototype.setVolume=function(a){this.volumeOutput=a,this.outputGain&&(this.outputGain.gain.value=a)},Dacapo.SamplerV2.prototype.mute=function(){this.output&&(this.output.gain.value=0)},Dacapo.SamplerV2.prototype.unmute=function(){this.output&&(this.output.gain.value=1)},Dacapo.SamplerV2.prototype.setSoloMode=function(){this.unmute(),this.solo=!0},Dacapo.SamplerV2.prototype.unsetSoloMode=function(){this.mute(),this.solo=!1},Dacapo.SamplerV2.prototype.isSolo=function(){return this.solo},Dacapo.SamplerV2.prototype.setHeader=function(a){this.headerInstrument=a},Dacapo.SamplerV2.prototype.setSFBuffer=function(a){this.sfBuffer=a},Dacapo.SamplerV2.prototype.hasMode=function(a){return this.instInfo.children&&this.instInfo.children[a]},Dacapo.SamplerV2.prototype.setReverb=function(a){var b;this.reverbEffect&&(b=a/20,this.reverbEffect.setDuration(b))},Dacapo.SamplerV2.prototype.getReverb=function(){if(this.reverbEffect)return 20*this.reverbEffect.getDuration()}}.call(this),function(){"use strict";Dacapo.Metronome=function(){Dacapo.Generator.call(this),this.smp=new Dacapo.Sampler,this.buf=new Dacapo.SFBuffer,this.buf.downloadSoundfont("metronome",function(){this.buf.preloadAll()}.bind(this)),this.smp.setSFBuffer(this.buf),this.smp.setDrumSet(!0),this.outputGain.gain.value=.4,this.smp.connect(this.outputGain),this.timerIds=[],this.scheduledTimes=[],this.mode=0,this.counter=0,this.active=!1,this.solo=!1},Dacapo.Metronome.prototype=Object.create(Dacapo.Generator.prototype),Dacapo.Metronome.prototype.tick=function(a){var b;return b=0===this.counter?60:61,this.active&&this.smp.playNote(b,.05),this.counter=(this.counter+1)%a,0===this.counter},Dacapo.Metronome.prototype.scheduleTick=function(a,b){var c,d;return c=0===this.counter?60:61,this.active&&(d={pitch:c,duration:.05},this.smp.scheduleNote(d,b)),this.scheduledTimes.push({time:b,upbeat:0===this.counter}),this.counter=(this.counter+1)%a,0===this.counter},Dacapo.Metronome.prototype.scheduleSequence=function(a,b,c){var d,e,f;for(this.reset(),d=0;d<a.sequences;d++)for(e=0;e<a.clicks;e++)this.scheduleTick(a.clicks,b),f=Math.abs(b-Dacapo.context.currentTime),b+=a.quarterDuration,c&&this.timerIds.unshift(Dacapo.WorkerTimer.setTimeout(c,1e3*f));return b},Dacapo.Metronome.prototype.scheduleIntro=function(a,b,c){return this.solo=!0,this.switchOn(),a=this.scheduleSequence({sequences:1,clicks:b.beats,quarterDuration:4/b.beatType*c},a),this.switchOff(),this.solo=!1,a},Dacapo.Metronome.prototype.cancelSequence=function(){var a;for(this.smp.stopNotes(1e-4),a=0;a<this.timerIds.length;a++)Dacapo.WorkerTimer.clearTimeout(this.timerIds[a])},Dacapo.Metronome.prototype.getStartMeasureTimeFrom=function(a){var b;for(b=this.scheduledTimes.length-1;b>=0;b--)if(this.scheduledTimes[b].time<=a){for(;b>=0&&!this.scheduledTimes[b].upbeat;)b--;return b<0?a:this.scheduledTimes[b].time}return this.scheduledTimes.length>0?this.scheduledTimes[0].time:0},Dacapo.Metronome.prototype.hasScheduledNotesFrom=function(a){var b=this.scheduledTimes.length-1;return this.scheduledTimes[b].time>a},Dacapo.Metronome.prototype.getNextPossibleTime=function(){var a=Dacapo.context.currentTime+.1,b=0,c=this.scheduledTimes.length-1;return c+1>1&&(b=this.scheduledTimes[c].time-this.scheduledTimes[c-1].time,this.scheduledTimes[c].time+b>a?a=this.scheduledTimes[c].time:b=0),a+b},Dacapo.Metronome.prototype.setMode=function(a){this.mode=a,this.reset()},Dacapo.Metronome.prototype.getMode=function(){return this.mode},Dacapo.Metronome.prototype.setCount=function(a){this.counter=a},Dacapo.Metronome.prototype.getCount=function(){return this.counter},Dacapo.Metronome.prototype.reset=function(){this.setCount(0)},Dacapo.Metronome.prototype.switchOff=function(){this.active=!1},Dacapo.Metronome.prototype.switchOn=function(){this.active=!0},Dacapo.Metronome.prototype.mute=function(){this.output.gain.value=0},Dacapo.Metronome.prototype.unmute=function(){this.output.gain.value=1},Dacapo.Metronome.prototype.isSolo=function(){return this.solo},Dacapo.Metronome.prototype.setSolo=function(a){this.solo=a}}.call(this),function(){"use strict";Dacapo.VoiceReader=function(a,b,c,d,e,f){var g=0;this.id=c,this.partData=a,this.measureIndex=b,this.measureData=a.measure[b],this.notes=this.measureData.note,this.inSlur=!1,this.slurIdx=null,this.voiceLength=this.getNoteCount(),this.divisions=d,this.transpo=e||0,this.currentDivisions=0,this.flagParsed=!1,void 0!==f&&(this.inSlur=f.slur,this.slurIdx=f.slurIdx,g=f.delay),this.init(g)},Dacapo.VoiceReader.prototype={init:function(a,b){this.lastParsedElement={},this.nextNoteDelay=a||0,this.velocity=Dacapo.Utils.VELOCITY_DEFAULT,this.currentNoteIndex=0,this.currentNoteDuration=0,this.timeFromNoteStart=0,this.noteIndex=this.initIndex(b),this.voiceLength+=this.noteIndex,this.direction=this.measureData.direction,this.wedge=null,this.quarterPosition=0,this.nextNoteSwung=!1},initIndex:function(a){var b,c;if(void 0!==a)return this.currentNoteIndex=a.currentNoteIndex,a.noteIndex;for(b=0,c=this.notes.length;b<c;b++)if(Number(this.notes[b].voice||1)===this.id)return b},isFinished:function(){return this.noteIndex>=this.voiceLength},getNoteCount:function(){var a=this.id;return this.notes.reduce(function(b,c){return Number(c.voice||1)===a?b+1:b},0)},substractElapsedTime:function(a){this.nextNoteDelay-=a,this.timeFromNoteStart+=a,Dacapo.Utils.epsEqu(this.nextNoteDelay,0)&&(this.nextNoteDelay=0)},nextNoteReached:function(){return this.nextNoteDelay<=0},getParsedElement:function(){var a=this.lastParsedElement;return this.lastParsedElement={},a},getNotesToPlay:function(a){var b,c,d=!1,e=[],f=[],g={},h=0,i=0,j=0,k=[],l=[],m=!1,n=1/0,o=this.notes[this.noteIndex];for(this.flagParsed&&this.currentNoteIndex++,this.flagParsed=!0;this.noteIndex<this.voiceLength&&o&&(void 0===o.duration||"0"===o.duration);)o.grace?(void 0===o.chord&&(b=[],f.push(b)),b.push({pitch:this.getNotePitch()})):this.currentNoteIndex++,this.noteIndex++,o=this.notes[this.noteIndex];for((c=a&&(this.nextNoteSwung||this.isNoteSwung()))&&(this.nextNoteSwung=!this.nextNoteSwung);this.noteIndex<this.voiceLength&&o&&(o.chord||!d);)d||(m=Adagio.Utils.noteUtils.hasArpeggiate(o),k=Adagio.Utils.noteUtils.getArticulationsList(o),l=Adagio.Utils.noteUtils.getOrnamentsList(o),j=o.duration/this.divisions),i=this.getNoteDuration(),this.currentDivisions&&(this.divisions=this.currentDivisions,this.currentDivisions=0),c&&(i=this.getSwingTime(i)),i<n&&(n=i),-1!==k.indexOf(Adagio.Values.ArticulationType.STACCATO)?i/=2:Adagio.Utils.noteUtils.hasArticulation(o,Adagio.Values.ArticulationType.STACCATISSIMO)?(i*=.35,h=4):-1!==k.indexOf(Adagio.Values.ArticulationType.TENUTO)?i+=.1:Adagio.Utils.noteUtils.hasNotation(o,Adagio.Values.NotationType.FERMATA)&&(i*=2),-1!==k.indexOf(Adagio.Values.ArticulationType.ACCENT)?h=3:-1!==k.indexOf(Adagio.Values.ArticulationType.STRONG)&&(h=6),c&&!this.nextNoteSwung&&(h+=3),Adagio.Utils.noteUtils.hasHeadParentheses(o)&&(h-=6),d||(Adagio.Utils.noteUtils.hasSlurStop(o)?(this.inSlur=!1,this.slurIdx=2):Adagio.Utils.noteUtils.hasSlurStart(o)?(this.inSlur=!0,this.slurIdx=0):this.inSlur?this.slurIdx=1:this.slurIdx=null),d||(this.lastParsedElement={idx:this.currentNoteIndex,realIdx:this.noteIndex,voiceId:this.id,duration:j},c&&(this.lastParsedElement.duration=i)),o.rest||Adagio.Utils.noteUtils.hasTieStop(o)||Adagio.Utils.noteUtils.hasGlissandoStop(o)||(g={pitch:this.getNotePitch(),velocityDiff:h,duration:i,slurIdx:this.slurIdx},-1===l.indexOf(Adagio.Values.OrnamentType.TRILLMARK)||Adagio.Utils.noteUtils.hasUnpitched(this.notes[this.noteIndex])||(g.trillPitch=this.getTrillNotePitch()),Adagio.Utils.noteUtils.hasGlissandoStart(o)&&!Adagio.Utils.noteUtils.hasUnpitched(o)&&(g.glissando=this.getGlissandoEnd(Adagio.Utils.glissandoUtils.getNumber(o))),e.push(g)),this.noteIndex++,d=!0,o=this.notes[this.noteIndex];return 0===this.nextNoteDelay&&(this.nextNoteDelay=n,this.quarterPosition+=j),this.currentNoteDuration=this.nextNoteDelay,this.timeFromNoteStart=0,{voiceId:this.id,graceNotes:f,notesArr:e,chordDuration:n,arpeggio:m,effects:l}},getNextNoteDelay:function(){return this.nextNoteDelay},chordIsSwingable:function(a){var b,c=!1;if(this.notes[a].duration/this.divisions!=.5)return!1;for(;a<this.notes.length&&(!c||this.notes[a].chord);){if(b=this.notes[a],c||(c=!0),Adagio.Utils.noteUtils.hasTieStart(b)||Adagio.Utils.noteUtils.hasTieStop(b))return!1;a++}return!0},closestChordIsSwingable:function(a,b){var c,d;for(c=b>0?this.notes.length:-1;a!==c;a+=b)if((d=this.notes[a])&&!d.chord&&Number(d.voice||1)===this.id)return this.chordIsSwingable(a);return!1},isNoteSwung:function(){return!!this.closestChordIsSwingable(this.noteIndex,1)&&this.closestChordIsSwingable(this.noteIndex+1,1)},getSwingTime:function(a){var b=2*a;return this.quarterPosition%1==0?2*b/3:this.quarterPosition%1==.5?b/3:a},getGlissandoEnd:function(a){for(var b,c=this.measureIndex,d=this.noteIndex,e=this.partData.measure.length;c<e;c++){for(;d<this.partData.measure[c].note.length;d++)if((b=this.partData.measure[c].note[d])&&Number(b.voice||1)===this.id&&Adagio.Utils.noteUtils.hasGlissandoStop(b)&&Adagio.Utils.glissandoUtils.getNumber(b)===a)return{pitch:Dacapo.Utils.NoteNameToMIDI(b.pitch)+this.transpo,duration:this.getNoteDuration(c,d),effects:Adagio.Utils.noteUtils.getOrnamentsList(b)};d=0}},getNextDiatonicNote:function(a){var b={octave:Number(a.octave)},c=Dacapo.Utils.DiatonicScale.indexOf(a.step);return++c>=Dacapo.Utils.DiatonicScale.length?(b.octave+=1,b.step=Dacapo.Utils.DiatonicScale[0]):b.step=Dacapo.Utils.DiatonicScale[c],b},getTrillNotePitch:function(){return this.getNextDiatonicNote(this.notes[this.noteIndex].pitch)},getNotePitch:function(){return Adagio.Utils.noteUtils.hasUnpitched(this.notes[this.noteIndex])?Adagio.Utils.noteUtils.getInstrumentId(this.notes[this.noteIndex]):Dacapo.Utils.NoteNameToMIDI(this.notes[this.noteIndex].pitch)+this.transpo},getNoteDuration:function(a,b){var c;"number"==typeof a&&"number"==typeof b?c=this.partData.measure[a].note[b]:(a=this.measureIndex,b=this.noteIndex,c=this.notes[b]);var d=Number(c.duration)/this.divisions;return Adagio.Utils.noteUtils.hasTieStart(c)&&(d+=this.findTieEnd(a,b+1,d)),d},findTieEnd:function(a,b,c){for(var d=this.partData.measure.length;a<d;a++){for(;b<this.partData.measure[a].note.length;b++){var e=this.partData.measure[a].note[b];if(Number(e.voice||1)===this.id){for(;0===this.nextNoteDelay&&e&&e.chord;)e=this.partData.measure[a].note[++b];if(void 0!==e&&(0===this.nextNoteDelay&&(this.nextNoteDelay=c),Adagio.Utils.noteUtils.hasTieStop(e))){if(void 0!==e.pitch&&"undefined"!==this.notes[this.noteIndex].pitch&&Adagio.Utils.pitchUtils.isSamePitch(e.pitch,this.notes[this.noteIndex].pitch))return this.getNoteDuration(a,b);if(void 0!==e.unpitched&&"undefined"!==this.notes[this.noteIndex].unpitched&&Adagio.Utils.unpitchedUtils.isSame(e.unpitched,this.notes[this.noteIndex].unpitched))return this.getNoteDuration(a,b)}}}b=0,a+1<d&&(this.currentDivisions||(this.currentDivisions=this.divisions),this.divisions=this.partData.measure[a+1].$adagio.attributes.divisions)}}}}.call(this),function(){"use strict";Dacapo.MeasureReader=function(a,b,c,d,e){this.idx=b,this.partData=a,this.commonContent=c,this.nbStaff=Adagio.Utils.partContentUtils.getNbStaves(this.partData),this.mapping=d,this.voiceCount=0,this.qpm=Dacapo.Utils.TEMPO_DEFAULT,this.unitDuration=60/this.qpm,this.sliderVoice=e,this.pizzicatoPart=!1,this.swing=Dacapo.swing,this.nextMeasureSwing=null,this.init()},Dacapo.MeasureReader.prototype={init:function(a,b,c){var d,e,f;this.newMeasure=!0,this.timePastInMeasure=0,this.divisions=1,this.voices=[],this.dynamics=[],this.pedals=[],this.pedalsIdx=0,this.pedalActive=!1,this.pizzicatos=[],this.pizzicatoIdx=0,this.pizzActive=c||!1,this.pizzicatoPart&&void 0===c&&(e=this.getLastPizzicato(this.idx),this.pizzActive=e===Adagio.Values.PizzicatoType.PIZZICATO),this.measureData=this.partData.measure[this.idx],this.played=!1,null!==this.nextMeasureSwing&&(this.swing=this.nextMeasureSwing,this.nextMeasureSwing=null),this.measureData&&(this.barline=this.measureData.barline,this.divisions=this.measureData.$adagio.attributes.divisions,this.beatType=this.measureData.$adagio.attributes.time["beat-type"],this.beats=this.measureData.$adagio.attributes.time.beats,this.fifths=this.measureData.$adagio.attributes.key.fifths,d=Adagio.Utils.measureUtils.getTranspose(this.measureData),this.transpo=Adagio.Utils.transposeUtils.getChromatic(d[0])+12*Adagio.Utils.transposeUtils.getOctaveChange(d[0]),this.tempo=this.commonContent.getTempo(this.idx),this.qpm=Adagio.Utils.tempoUtils.getQpm(this.tempo)>>0,this.unitDuration=60/this.qpm,f={nbDots:Adagio.Utils.tempoUtils.getNbDots(this.tempo),durationType:Adagio.Utils.tempoUtils.getDurationType(this.tempo)},this.bpm=this.qpm*Adagio.Utils.durationUtils.durationOptsToQuarter(f),this.beatDuration=60/this.bpm,this.initPedal(),this.initPizzicato(),this.initDynamics(b),this.initVoices(a))},initDynamicsStaves:function(a){var b,c,d;for(b=0;b<this.nbStaff;b++)c=Dacapo.Utils.VELOCITY_DEFAULT,d=null,a&&a[b]&&(c=a[b].velocity,d=a[b].currentWedge),this.dynamics.push({velocity:c,dynamicsArray:[],dynamicsIdx:0,wedgeArray:[],wedgeIdx:0,currentWedge:d})},initPedal:function(){var a,b,c;for(a=0;a<this.nbStaff;a++)for(Adagio.Utils.measureUtils.hasLeftPedal(this.measureData,a)&&(this.pedalActive=!0),c=Adagio.Utils.measureUtils.getPedals(this.measureData,a),b=0;b<c.length;b++)this.pedals.push({time:Adagio.Utils.direction.pedalDirectionUtils.getTimePos(c[b])/this.divisions,type:Adagio.Utils.direction.pedalDirectionUtils.getType(c[b])});this.pedals.sort(function(a,b){return a.time-b.time})},initPizzicato:function(){var a,b,c;for(a=0;a<this.nbStaff;a++)for(c=Adagio.Utils.measureUtils.getPizzicatos(this.measureData,a),b=0;b<c.length;b++)this.pizzicatos.push({time:Adagio.Utils.direction.pizzicatoDirectionUtils.getTimePos(c[b])/this.divisions,type:Adagio.Utils.direction.pizzicatoDirectionUtils.getType(c[b])});this.pizzicatos.sort(function(a,b){return a.time-b.time})},initDynamics:function(a){var b,c,d,e,f,g,h,i;if(!a&&this.idx>0?a=this.getLastDynamics():this.initDynamicsStaves(a),this.direction=Adagio.Utils.measureUtils.getAllDirections(this.measureData),this.direction&&this.direction.length>0)for(d=0,e=this.direction.length;d<e;d++){if(h=Adagio.Utils.directionUtils.getStaffIdx(this.direction[d]),Adagio.Utils.directionUtils.hasSoundDynamic(this.direction[d])&&(c=Adagio.Utils.direction.dynamicDirectionUtils.getStyle(this.direction[d]),b=Dacapo.Utils.Dynamics[c],void 0===b&&(b=Dacapo.Utils.VELOCITY_DEFAULT),b>0)){for(i={time:Adagio.Utils.directionUtils.getTimePos(this.direction[d])/this.divisions,staff:h,velocity:b},f=this.dynamics[h].dynamicsArray.length;f>0&&i.time<this.dynamics[h].dynamicsArray[f-1];)f--;this.dynamics[h].dynamicsArray.splice(f,0,i)}Adagio.Utils.directionUtils.hasWedge(this.direction[d])&&(g=Adagio.Utils.directionUtils.getWedge(this.direction[d]),"left"===Adagio.Utils.wedgeUtils.getLocation(g)&&this.dynamics[h].wedgeArray.push({time:Adagio.Utils.directionUtils.getTimePos(this.direction[d])/this.divisions,type:Adagio.Utils.wedgeUtils.getType(g),staff:h,nbNotes:Adagio.Utils.wedgeUtils.getNbNotes(g)+1}))}},initVoices:function(a){var b,c,d,e,f=0,g={},h=[];if(void 0===a)a={};else for(d in a)a.hasOwnProperty(d)&&(g[d]=a[d],a[d].delay>f&&(f=a[d].delay));for(b=0;b<this.measureData.note.length;b++)c=Number(this.measureData.note[b].voice||1),-1===h.indexOf(c)&&(void 0===g[c]&&(a[c]={delay:f,slur:!1,slurIdx:0}),e=new Dacapo.VoiceReader(this.partData,this.idx,c,this.divisions,this.transpo,a[c]),c===this.sliderVoice?this.voices.unshift(e):this.voices.push(e),h.push(c));this.voiceCount=h.length},nextMeasure:function(){var a=this.getVoicesInfo();this.idx++,this.init(a,this.dynamics,this.pizzActive)},jumpToMeasure:function(a){if(a>=0&&a<this.partData.measure.length){var b=this.getVoicesInfo();return this.idx=a,this.init(b),!0}return!1},forceEndSong:function(){return this.idx=this.partData.measure.length,!0},getVoicesDelay:function(){for(var a=[],b=0;b<this.voiceCount;b++)this.voices[b]&&(a[this.voices[b].id]=this.voices[b].nextNoteDelay);return a},getVoicesInfo:function(){for(var a={},b=0;b<this.voiceCount;b++)this.voices[b]&&(a[this.voices[b].id]={delay:this.voices[b].nextNoteDelay,slur:this.voices[b].inSlur,slurIdx:this.voices[b].slurIdx});return a},substractElapsedTime:function(a){this.newMeasure?this.newMeasure=!1:this.timePastInMeasure+=a;for(var b=0;b<this.voiceCount;b++)this.voices[b]&&this.voices[b].substractElapsedTime(a)},isFinished:function(){for(var a=!0,b=0;b<this.voiceCount;b++)this.voices[b]&&!this.voices[b].isFinished()&&(a=!1);return a},noMoreDelay:function(){for(var a=!0,b=0;b<this.voiceCount;b++)this.voices[b]&&!this.voices[b].nextNoteReached()&&(a=!1);return a},getVoiceCount:function(){return this.voiceCount},getSliderVoice:function(){return this.voices[0].id},getMinDuration:function(){var a,b,c,d=1/0;for(a=0;a<this.voiceCount;a++)this.voices[a]&&(b=this.voices[a].getNextNoteDelay(),d=b<d?b:d);return this.pedalsIdx<this.pedals.length&&(c=this.pedals[this.pedalsIdx],c.type===Adagio.Values.PedalType.STOP&&c.time-this.timePastInMeasure<d&&c.time-this.timePastInMeasure>0&&(d=c.time-this.timePastInMeasure)),d},getNotes:function(){var a,b=[];this.played=!1;for(var c=0;c<this.voiceCount;c++)if((a=this.voices[c])&&a.nextNoteReached()&&!a.isFinished()){var d=this.voices[c].getNotesToPlay(this.swing);b=b.concat(d),this.played=!0}return b},getParsedElement:function(a){var b;return a<this.voices.length&&(b=this.voices[a].getParsedElement(),Object.keys(b).length>0&&(b.duration*=this.unitDuration,b.measureIdx=this.idx)),b},getPedalStatus:function(){return this.pedalActive},getPizzicatoStatus:function(){return this.pizzActive},getLastDynamics:function(){var a,b,c=[];for(a=0;a<this.nbStaff;a++)b=this.getLastDynamicsForStaff(a),this.dynamics[a]={velocity:b.velocity,dynamicsArray:[],dynamicsIdx:0,wedgeIdx:0,wedgeArray:[],currentWedge:b.currentWedge},c.push(void 0);return c},getLastDynamicsForStaff:function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p=!1,q=[],r=null,s=0;for(b=this.idx-1;b>=0;b--)for(m=this.partData.measure[b],k=m.$adagio.attributes.divisions,l=Adagio.Utils.measureUtils.getAllDirections(m),c=l.length-1;c>=0;c--)if(e=Adagio.Utils.directionUtils.getStaffIdx(l[c]),a===e){if(Adagio.Utils.directionUtils.hasSoundDynamic(l[c])){for(i=Adagio.Utils.direction.dynamicDirectionUtils.getStyle(l[c]),f=Dacapo.Utils.Dynamics[i],void 0===f&&(f=Dacapo.Utils.VELOCITY_DEFAULT),d=0;d<q.length;d++)h="crescendo"===q[d].type?1:-1,q[d].currentWedge?(n=30/q[d].nbNotes,o=q[d].nbNotes-q[d].notesToCurrentPos,f+=h*n*q[d].notesToCurrentPos,r={type:q[d].type,interval:n,stepRemaining:o}):f+=30*h;return{velocity:f,currentWedge:r}}Adagio.Utils.directionUtils.hasWedge(l[c])&&(g=Adagio.Utils.directionUtils.getWedge(l[c]),"left"===Adagio.Utils.wedgeUtils.getLocation(g)?(j=Adagio.Utils.directionUtils.getTimePos(l[c])/k,p||(s=this.countNotesFrom(b,a,j)),q.unshift({nbNotes:Adagio.Utils.wedgeUtils.getNbNotes(g)+1,type:Adagio.Utils.wedgeUtils.getType(g),time:j,currentWedge:!p,notesToCurrentPos:s})):"right"===Adagio.Utils.wedgeUtils.getLocation(g)&&(p=!0))}return{velocity:Dacapo.Utils.VELOCITY_DEFAULT,currentWedge:null}},countNotesFrom:function(a,b,c){for(var d,e,f,g,h,i,j,k=0;a<this.idx;a++)for(f=0,h=this.partData.measure[a],j=h.$adagio.attributes.divisions,i=null,d=0;d<h.note.length;d++)if(e=h.note[d],g=!1,void 0!==e.duration&&0!==e.duration&&e.staff===b){for(null===i&&(i=Number(e.voice)),i===Number(e.voice)&&(f+=e.duration/j);e&&(e.chord||!g);)g=!0,d++,e=h.note[d];f>c&&k++}return k+1},getVelocity:function(a,b){var c,d,e;return void 0!==b&&null!==b||(b=0),void 0===a&&(a=this.voices[0].id),c=this.mapping[a],this.updateDynamics(c),this.updateWedges(c),d=Dacapo.Utils.MIDIVelocityToDecibels(this.dynamics[c].velocity),e=Dacapo.Utils.decibelsToMIDIVelocity(d+b),Dacapo.Utils.velocityToVolume(e)},updatePedals:function(a){var b;return this.pedalsIdx<this.pedals.length&&(a||this.pedals[this.pedalsIdx].time<=this.timePastInMeasure)&&(this.pedals[this.pedalsIdx].type===Adagio.Values.PedalType.START?this.pedalActive=!0:this.pedals[this.pedalsIdx].type===Adagio.Values.PedalType.STOP&&(this.pedalActive=!1,b=Adagio.Values.PedalType.STOP),this.pedalsIdx++),b},updatePizzicato:function(){this.pizzicatoIdx<this.pizzicatos.length&&this.pizzicatos[this.pizzicatoIdx].time<=this.timePastInMeasure&&(this.pizzicatos[this.pizzicatoIdx].type===Adagio.Values.PizzicatoType.PIZZICATO?this.pizzActive=!0:this.pizzicatos[this.pizzicatoIdx].type===Adagio.Values.PizzicatoType.ARCO&&(this.pizzActive=!1),this.pizzicatoIdx++)},updateDynamics:function(a){var b=this.dynamics[a];b.dynamicsIdx<b.dynamicsArray.length&&b.dynamicsArray[b.dynamicsIdx].time<=this.timePastInMeasure&&(b.velocity=b.dynamicsArray[b.dynamicsIdx].velocity,b.dynamicsIdx++)},updateWedges:function(a){var b=this.dynamics[a];b.wedgeIdx<b.wedgeArray.length&&b.wedgeArray[b.wedgeIdx].time<=this.timePastInMeasure?(b.currentWedge={type:b.wedgeArray[b.wedgeIdx].type,interval:30/b.wedgeArray[b.wedgeIdx].nbNotes,stepRemaining:b.wedgeArray[b.wedgeIdx].nbNotes-1},b.wedgeIdx++):null!==b.currentWedge&&("crescendo"===b.currentWedge.type?b.velocity+=b.currentWedge.interval:"diminuendo"===b.currentWedge.type&&(b.velocity-=b.currentWedge.interval),--b.currentWedge.stepRemaining<=0&&(b.currentWedge=null))},hasRepeatForward:function(){return!(!this.measureData||!Adagio.Utils.measureUtils.hasRepeatForward(this.measureData))},hasRepeatBackward:function(){return!(!this.measureData||!Adagio.Utils.measureUtils.hasRepeatBackward(this.measureData))},hasTag:function(){return!!(this.commonContent&&this.idx<this.partData.measure.length&&this.commonContent.hasJumpTag(this.idx))},getTag:function(){return this.hasTag()?this.commonContent.getJumpTag(this.idx):null},hasCall:function(){return!!(this.commonContent&&this.idx<this.partData.measure.length&&this.commonContent.hasJumpCall(this.idx))},getCall:function(){return this.hasCall()?this.commonContent.getJumpCall(this.idx):null},hasPizzicatos:function(){return this.pizzicatos.length>0},getRepeatTimes:function(){if(this.barline)if(this.barline.constructor===Array){for(var a=0,b=this.barline.length;a<b;a++)if(this.barline[a].repeat)return Number(this.barline[a].repeat.$time||1)}else if(this.barline.repeat)return Number(this.barline.repeat.$time||1);return 0},getKeySignature:function(){return this.measureData.$adagio.attributes.key},getMeasureLength:function(){return this.unitDuration*this.beats*(4/this.beatType)},hasNotesInMeasure:function(){for(var a=0;a<this.measureData.note.length;a++)if(!this.measureData.note[a].rest)return!0;return!1},getLastPizzicato:function(a){return Dacapo.Utils.getLastPizzicatoType(this.partData,a)},enablePizzicato:function(){this.pizzicatoPart=!0},enableSwing:function(){this.nextMeasureSwing=!0},disableSwing:function(){this.nextMeasureSwing=!1}}}.call(this),function(){"use strict";Dacapo.PartReader=function(a,b,c,d,e,f,g,h){this.idx=c,this.data=a,this.part=b,this.commonContent=e,this.instru=d,this.mapping={},this.repeatStack=[],this.tags={},this.repeat=!0,this.nextNote=0,this.qpm=null,this.timeSignature={beats:null,beatType:null},this.keySignature={fifths:null,mode:"major"},this.init(f||0,g||0,h||1)},Dacapo.PartReader.prototype={init:function(a,b,c){this.scheduledNotes=[],this.voiceMap=[],this.initStaves(),this.measureIndex=a,this.timeStart=b,this.timePastInPart=0,this.nextTime=this.timeStart+this.timePastInPart,this.currentMeasure=new Dacapo.MeasureReader(this.part,a,this.commonContent,this.mapping,c),
this.updateGlobalMeta(),this.timePastInMeasure=0,this.isNewMeasure=!0,this.bufferOverflow=!1,this.timeFromNoteStart=0,this.currentNoteIndex=0,this.currentNoteDuration=0,this.lastEndingMet=0,this.elapsed=0,this.checkRepeatForward(),this.saveJumpTags(),this.instru&&(this.updateMeta(),this.instru.hasMode(this.idx,"pizzicato")&&(this.currentMeasure.enablePizzicato(),this.currentMeasure.init()))},initStaves:function(){var a;this.data.getPartVoicesIndexes(this.idx).forEach(function(b){a=this.data.getPartVoiceMainStaffIdx(this.idx,b),this.mapping[b+1]=a}.bind(this))},findPrevRepeats:function(a){var b,c,d;for(this.repeatStack=[],b=0;b<=a&&b<this.part.measure.length;b++)Adagio.Utils.measureUtils.hasRepeatForward(this.part.measure[b])&&this.repeatStack.push({measure:b,counter:0}),b<a&&Adagio.Utils.measureUtils.hasRepeatBackward(this.part.measure[b])&&(c=this.repeatStack.pop());return this.repeatStack.length>0&&this.commonContent.hasEnding(a)&&(d=this.commonContent.getEnding(a),c=this.repeatStack[this.repeatStack.length-1],c.counter=d[0]-1),this.repeatStack},setPrevRepeats:function(a){this.repeatStack=[];for(var b=0;b<a.length;b++)this.repeatStack[b]={measure:a[b].measure,counter:a[b].counter}},partCallback:function(a){var b,c,d,e,f,g=!0;if(this.endOfPart())return 1/0;if(this.currentMeasure.substractElapsedTime(a),this.isNewMeasure&&(g=this.currentMeasure.noMoreDelay()),this.isNewMeasure&&g?(this.measureIndex=this.currentMeasure.idx,this.timePastInMeasure=0,this.isNewMeasure=!1,this.updateGlobalMeta()):this.timePastInMeasure+=a,!this.isNewMeasure){if(this.currentMeasure.updatePedals(),this.currentMeasure.updatePizzicato(),b=this.currentMeasure.getNotes(),(d=b.length)>0)for(c=0;c<d;c++)f=this.getVelocity(b[c].notesArr[0],b[c].voiceId),this.playChord(b[c],f);this.saveNoteHead()}return this.timeFromNoteStart=this.currentMeasure.voices[0].timeFromNoteStart,this.bufferOverflow?1/0:(e=this.getMinDuration(),"undefined"!=typeof require&&this.updateOffset(e),this.currentMeasure.isFinished()&&this.changeMeasure(),e)},schedulePartWindow:function(a,b){var c,d,e,f,g,h=0,i=0,j=!0;for(e=0;e<this.scheduledNotes.length;e++)this.scheduledNotes[e].endTime<a&&this.scheduledNotes.splice(e--,1);if(this.nextTime>b)return this.elapsed;if(this.endOfPart())return 1/0;for(;!this.endOfPart();){if(this.currentMeasure.substractElapsedTime(this.elapsed),this.isNewMeasure&&(j=this.currentMeasure.noMoreDelay()),this.isNewMeasure&&j?(this.measureIndex=this.currentMeasure.idx,this.timePastInMeasure=0,this.isNewMeasure=!1,this.updateGlobalMeta()):this.timePastInMeasure+=this.elapsed,!this.isNewMeasure){if(this.currentMeasure.updatePedals()===Adagio.Values.PedalType.STOP&&this.stopPlayingNotes(this.nextTime),this.currentMeasure.updatePizzicato(),c=this.currentMeasure.getNotes(),(f=c.length)>0)for(e=0;e<f;e++)d=this.getVelocity(c[e].notesArr[0],c[e].voiceId),this.scheduleChord(this.nextTime,c[e],d);g=this.currentMeasure.getParsedElement(0),g&&Object.keys(g).length>0&&(g.startTime=this.nextTime,g.endTime=this.nextTime+g.duration,this.voiceMap.push(g))}if(this.elapsed=this.getMinDuration(),h=this.elapsed*this.currentMeasure.unitDuration,i+=h,this.timePastInPart+=h,this.nextTime=this.timeStart+this.timePastInPart,this.currentMeasure.isFinished()&&(this.currentMeasure.updatePedals(!0)===Adagio.Values.PedalType.STOP&&this.stopPlayingNotes(this.nextTime),this.changeMeasure()),this.nextTime>b)return this.elapsed}return this.elapsed},updateOffset:function(a){this.instru&&this.currentMeasure.played&&this.instru.updateOffset(a*this.currentMeasure.unitDuration,this.idx)},updateMeta:function(){this.qpm!==this.currentMeasure.qpm&&(this.qpm=this.currentMeasure.qpm,this.instru.updateTempo&&this.instru.updateTempo(this.qpm,this.idx)),this.timeSignature.beats===this.currentMeasure.beats&&this.timeSignature.beatType===this.currentMeasure.beatType||(this.timeSignature.beats=this.currentMeasure.beats,this.timeSignature.beatType=this.currentMeasure.beatType,this.instru.updateTimeSignature&&this.instru.updateTimeSignature(this.timeSignature.beats,this.timeSignature.beatType,this.idx)),this.keySignature.fifths!==this.currentMeasure.fifths&&(this.keySignature.fifths=this.currentMeasure.fifths,this.instru.updateKeySignature&&this.instru.updateKeySignature(this.keySignature.fifths,this.keySignature.mode,this.idx))},updateGlobalMeta:function(){Dacapo.qpm=this.currentMeasure.qpm,Dacapo.bpm=this.currentMeasure.bpm,Dacapo.timeSignature.beats=this.currentMeasure.beats,Dacapo.timeSignature.beatType=this.currentMeasure.beatType,Dacapo.measureIdx=this.measureIndex,Dacapo.unitDuration=this.currentMeasure.unitDuration,Dacapo.beatDuration=this.currentMeasure.beatDuration},changeMeasure:function(){var a,b,c,d=!0;this.repeat&&this.currentMeasure.hasCall()?this.checkJumpCalls():this.repeat&&this.currentMeasure.hasRepeatBackward()?(this.lastEndingMet=0,b=this.findForwardTag(this.currentMeasure.idx),c=this.currentMeasure.getRepeatTimes(),void 0===b?(b={measure:0,counter:0,measureEnd:this.currentMeasure.idx},this.repeatStack.push(b)):d=!1,++b.counter<c+1?(void 0===b.measureEnd&&(b.measureEnd=this.currentMeasure.idx),this.currentMeasure.jumpToMeasure(b.measure)):(this.currentMeasure.nextMeasure(),d=!0)):this.currentMeasure.nextMeasure(),this.repeat&&d&&this.checkRepeatForward(),this.saveJumpTags(),this.endOfPart()||(this.commonContent.hasEnding(this.currentMeasure.idx)?(a=this.commonContent.getEnding(this.currentMeasure.idx),void 0!==(b=this.repeatStack[this.repeatStack.length-1])&&b.measureEnd>=this.currentMeasure.idx&&(this.lastEndingMet=this.getClosestEnding(a,b.counter),-1===a.indexOf(b.counter+1)&&this.changeMeasure())):this.lastEndingMet>0&&void 0!==(b=this.repeatStack[this.repeatStack.length-1])&&this.lastEndingMet!==b.counter+1&&this.changeMeasure()),this.instru&&this.updateMeta(),this.isNewMeasure=!0},checkRepeatForward:function(){this.currentMeasure.hasRepeatForward()&&!this.findPastRepeat(this.currentMeasure.idx)&&(this.lastEndingMet=0,this.repeatStack.push({measure:this.currentMeasure.idx,counter:0}))},findForwardTag:function(a){var b;for(b=this.repeatStack.length-1;b>=0;b--)if(this.repeatStack[b].measureEnd===a||void 0===this.repeatStack[b].measureEnd)return this.repeatStack[b]},findPastRepeat:function(a){var b;for(b=0;b<this.repeatStack.length;b++)if(this.repeatStack[b].measure===a)return this.repeatStack[b]},findCodaTag:function(){var a;{if(this.tags[Adagio.Values.SoundType.CODA])return this.tags[Adagio.Values.SoundType.CODA][0];for(a=this.part.measure.length-1;a>=0;a--)if(this.commonContent&&this.commonContent.hasJumpTag(a))return this.addTag(Adagio.Values.SoundType.CODA,{counter:0,measureId:a}),this.tags[Adagio.Values.SoundType.CODA][0]}},saveJumpTags:function(){var a,b=this.currentMeasure.getTag();b!==Adagio.Values.SoundType.CODA&&(a=this.searchForTag(b,this.currentMeasure.idx),b&&!a&&(a?0===a.counter&&a.counter++:this.addTag(b,{counter:0,measureId:this.currentMeasure.idx})))},addTag:function(a,b){this.tags[a]||(this.tags[a]=[]),this.tags[a].push(b)},searchForTag:function(a,b){var c,d;if(this.tags[a]&&(d=this.tags[a].length)>0){if(void 0===b)return this.tags[a][d-1];for(c=d-1;c>=0;c--)if(this.tags[a][c].measureId===b)return this.tags[a][c]}return null},checkJumpCalls:function(){var a,b,c,d=this.currentMeasure.getCall();d&&(d===Adagio.Values.SoundType.FINE?(b=this.searchForTag(Adagio.Values.SoundType.SEGNO),c=this.searchForTag(Adagio.Values.SoundType.DACAPO),b&&1===b.counter||c&&c.measureId>this.currentMeasure.idx?this.currentMeasure.forceEndSong():this.currentMeasure.nextMeasure()):d===Adagio.Values.SoundType.DACAPO?this.searchForTag(Adagio.Values.SoundType.DACAPO,this.currentMeasure.idx)?this.currentMeasure.nextMeasure():(this.addTag(Adagio.Values.SoundType.DACAPO,{measureId:this.currentMeasure.idx,counter:1}),this.currentMeasure.jumpToMeasure(0)):d===Adagio.Values.SoundType.DALSEGNO?(a=this.searchForTag(Adagio.Values.SoundType.SEGNO),a&&0===a.counter?(a.counter++,this.currentMeasure.jumpToMeasure(a.measureId)):this.currentMeasure.nextMeasure()):d===Adagio.Values.SoundType.TOCODA&&(a=this.searchForTag(Adagio.Values.SoundType.CODA),a?0===a.counter&&a.callMeasure===this.currentMeasure.idx?(a.counter++,this.currentMeasure.jumpToMeasure(a.measureId)):this.currentMeasure.nextMeasure():(a=this.findCodaTag(),a&&(a.callMeasure=this.currentMeasure.idx),this.currentMeasure.nextMeasure())))},getClosestEnding:function(a,b){for(var c=0;c<a.length;c++)if(a[c]===b+1)return a[c];return a[0]},playChord:function(a,b){var c,d,e=0,f=0,g=0,h=0;if(a.notesArr.length>0){if(a.graceNotes.length>0)for(f=a.chordDuration*Dacapo.Utils.GRACE_RATIO,g=f/a.graceNotes.length,c=0;c<a.graceNotes.length;c++){for(d=0;d<a.graceNotes[c].length;d++)a.graceNotes[c][d].duration=g,this.playNote(a.graceNotes[c][d],a,b);e=g*this.currentMeasure.unitDuration}for(a.arpeggio&&a.notesArr.length>1&&(h=(a.chordDuration-f)/a.notesArr.length,this.sortPitches(a.notesArr)),c=0;c<a.notesArr.length;c++)a.notesArr[c].duration-=f,a.arpeggio&&a.notesArr.length>1&&(a.notesArr[c].duration=h,c>0&&(e+=h*this.currentMeasure.unitDuration)),this.playNote(a.notesArr[c],a,b,e)}},getTrillPitch:function(a){var b=this.currentMeasure.getKeySignature(),c=Adagio.Utils.keyUtils.getFifths(b),d=Adagio.Utils.pitchUtils.stepToAlter(a.step,c);return a.alter=d,Dacapo.Utils.NoteNameToMIDI(a)+this.currentMeasure.transpo},buildPlayOpts:function(a,b,c,d){var e;return e={pitch:a.pitch,duration:a.duration*this.currentMeasure.unitDuration,velocity:c,slurIdx:a.slurIdx,effects:b.effects,pizzicato:this.currentMeasure.getPizzicatoStatus()},e.origDuration=e.duration,this.currentMeasure.getPedalStatus()&&(e.duration=1/0),void 0!==d&&(e.offset=d),-1!==b.effects.indexOf(Adagio.Values.OrnamentType.TRILLMARK)&&a.trillPitch&&(e.trillPitch=this.getTrillPitch(a.trillPitch)),void 0!==a.glissando&&(e.glissando={pitch:a.glissando.pitch,totalDuration:e.duration+a.glissando.duration*this.currentMeasure.unitDuration,effects:a.glissando.effects}),e},playNote:function(a,b,c,d){var e;this.instru&&(e=this.buildPlayOpts(a,b,c,d),"undefined"==typeof require?this.instru.playNote(e,this.idx):this.instru.writeNote(e,this.idx)||(this.bufferOverflow=!0))},scheduleChord:function(a,b,c){var d,e,f=a,g=0,h=0,i=0;if(b.notesArr.length>0){if(b.graceNotes.length>0)for(g=b.chordDuration*Dacapo.Utils.GRACE_RATIO,h=g/b.graceNotes.length,d=0;d<b.graceNotes.length;d++){for(e=0;e<b.graceNotes[d].length;e++)b.graceNotes[d][e].duration=h,this.scheduleNote(f,b.graceNotes[d][e],b,c);f+=h*this.currentMeasure.unitDuration}for(b.arpeggio&&b.notesArr.length>1&&(i=Dacapo.Utils.ARPEGGIO_DURATION,i*b.notesArr.length>b.chordDuration-g&&(i=(b.chordDuration-g)/b.notesArr.length),this.sortPitches(b.notesArr)),d=0;d<b.notesArr.length;d++)b.notesArr[d].duration-=g,b.arpeggio&&b.notesArr.length>1&&(b.notesArr[d].duration=b.chordDuration-g,d>0&&(f+=i*this.currentMeasure.unitDuration)),this.scheduleNote(f,b.notesArr[d],b,c)}},scheduleNote:function(a,b,c,d){var e,f,g;this.instru&&(e=this.buildPlayOpts(b,c,d),f=e.duration,g=this.instru.scheduleNote(e,a,this.idx)||{},this.scheduledNotes.push({opts:e,pitch:b.pitch,velocity:d,inSlur:b.inSlur,gainNode:g.srcVol,bufferNode:g.src,startTime:a,duration:f,endTime:a+f}))},sortPitches:function(a){a.sort(function(a,b){return a.pitch-b.pitch})},stopPlayingNotes:function(a){this.instru&&this.instru.stopPedal(this.idx,a)},stopScheduledNotes:function(){var a,b;for(a=0;a<this.scheduledNotes.length;a++)if(b=this.scheduledNotes[a],b.gainNode&&b.bufferNode){b.gainNode.gain.setValueAtTime(0,0);try{b.bufferNode.stop(0)}catch(a){if("InvalidStateError"!==a.name)throw a}}},pauseScheduledNotes:function(){var a,b,c=Dacapo.context.currentTime;for(a=0;a<this.scheduledNotes.length;a++)if(b=this.scheduledNotes[a],b.gainNode&&b.bufferNode){b.gainNode.gain.setValueAtTime(0,0);try{b.bufferNode.stop(0)}catch(a){if("InvalidStateError"!==a.name)throw a}b.pauseOffset=c-b.startTime}},resumeScheduledNotes:function(a){var b,c,d;for(this.nextTime+=a,this.timeStart+=a,b=0;b<this.scheduledNotes.length;b++)d=this.scheduledNotes[b],d.startTime+=a,d.endTime+=a,d.endTime>this.timeStart&&(d.opts.duration=d.duration,d.opts.pauseOffset=d.pauseOffset,(c=this.instru.scheduleNote(d.opts,d.startTime,this.idx))&&(d.gainNode=c.srcVol,d.bufferNode=c.src));for(b=0;b<this.voiceMap.length;b++)d=this.voiceMap[b],d.startTime+=a,d.endTime+=a},endOfPart:function(){return this.currentMeasure.idx>=this.part.measure.length},getUnitDuration:function(){return this.currentMeasure.unitDuration},getMinDuration:function(){return this.currentMeasure.getMinDuration()},getVelocity:function(a,b){return void 0===a?this.currentMeasure.getVelocity():this.currentMeasure.getVelocity(b,a.velocityDiff)},saveNoteHead:function(){var a=this.currentMeasure.voices[0];a?(this.currentNoteIndex=a.currentNoteIndex,this.currentNoteDuration=a.currentNoteDuration):(this.currentNoteIndex=0,this.currentNoteDuration=Dacapo.timeSignature.beats*(4/Dacapo.timeSignature.beatType))},createPlayingObject:function(a,b,c){var d={idx:0,realIdx:0,voiceId:c,measureIndex:this.measureIndex||0,currentNoteDuration:1,timeFromNoteStart:0};return a&&(d.idx=a.idx,d.realIdx=a.realIdx,d.voiceId=a.voiceId-1,d.measureIndex=a.measureIdx,d.currentNoteDuration=a.duration,d.timeFromNoteStart=b-a.startTime),d},getCurrentPlayingNote:function(a){var b,c,d=0;for(a=a||Dacapo.context.currentTime,b=0;b<this.voiceMap.length;b++)if(c=this.voiceMap[b],a>=c.startTime&&a<c.endTime)return b>0&&this.voiceMap.splice(0,b),this.createPlayingObject(c,a);return c?a<c.startTime?(d=this.voiceMap[0].voiceId-1,c=null):(b=this.voiceMap.length-1,c=this.voiceMap[b]):d=this.currentMeasure.getSliderVoice()-1,this.createPlayingObject(c,a,d)},getPlayingHeadPosition:function(){var a=this.currentMeasure.unitDuration*Dacapo.timeSignature.beats*(4/Dacapo.timeSignature.beatType),b=this.getCurrentPlayingNote();return{timeFromNoteStart:b.timeFromNoteStart,currentNoteIndex:b.idx,currentNoteRealIdx:b.realIdx,currentNoteDuration:b.currentNoteDuration,currentVoiceId:b.voiceId,currentMeasure:b.measureIndex,timePerMeasure:a,beat:Dacapo.timeSignature.beats,beatType:Dacapo.timeSignature.beatType,tempo:Dacapo.qpm}},getHeadPosition:function(){var a=this.currentMeasure.unitDuration*Dacapo.timeSignature.beats*(4/Dacapo.timeSignature.beatType);return{timeFromMeasureStart:this.timePastInMeasure*this.currentMeasure.unitDuration,timeFromNoteStart:this.timeFromNoteStart*this.currentMeasure.unitDuration,currentNoteIndex:this.currentNoteIndex,currentNoteDuration:this.currentNoteDuration*this.currentMeasure.unitDuration,currentMeasure:this.measureIndex,timePerMeasure:a,beat:Dacapo.timeSignature.beats,beatType:Dacapo.timeSignature.beatType,tempo:Dacapo.qpm}},getPartLength:function(){for(var a=0;!this.endOfPart();)a+=this.currentMeasure.getMeasureLength(),this.changeMeasure();return a},getPartTimeEnd:function(){for(var a,b,c=0,d=0;!this.endOfPart();)b=this.currentMeasure.getMeasureLength(),c+=b,a=this.currentMeasure.hasNotesInMeasure(),(!a||a&&this.currentMeasure.idx===this.part.measure.length-1)&&(this.currentMeasure.idx,d=c+b),this.changeMeasure();return d},getMetaMap:function(){var a=[];for(this.init(0),this.setNoRepeat();!this.endOfPart();)a[this.currentMeasure.idx]={beats:this.currentMeasure.beats,beatType:this.currentMeasure.beatType,tempo:this.currentMeasure.qpm},this.changeMeasure();return this.init(0),this.setRepeat(),a},getPlayedNotesInPart:function(){var a,b,c,d,e=[];for(a=0;a<this.part.measure.length;a++)for(c=this.part.measure[a],b=0;b<c.note.length;b++)c.note[b].pitch&&(d=Dacapo.Utils.NoteNameToMIDI(c.note[b].pitch),-1===e.indexOf(d)&&e.push(d));return e},setRepeat:function(){this.repeat=!0},setNoRepeat:function(){this.repeat=!1},setTimeStart:function(a){this.timeStart=a,this.nextTime=this.timeStart+this.timePastInPart},enableSwing:function(){this.currentMeasure.enableSwing()},disableSwing:function(){this.currentMeasure.disableSwing()}}}.call(this),function(){"use strict";Dacapo.Reader=function(a,b,c){this.data=null,this.schedule=[],this.manager=a,this.instruments=a.getInstruments(),this.setData(b),this.setCommonContent(c),this.playTime=0,this.pauseTime=0,this.measureStartTime=0,this.nextTick=0,this.metronome=null,this.metronomeOn=!1,this.init(0)},Dacapo.Reader.prototype={init:function(a){var b,c,d,e;if(this.minDelay=0,this.parts=[],this.instruments.length>0){for(Dacapo.context&&(this.playTime=Dacapo.context.currentTime+.1),e=0;e<this.instruments.length;e++)if(this.schedule[e]&&(b=this.data.getPartStaffVoicesIndexes(e,0)[0]+1,d=new Dacapo.PartReader(this.data,this.schedule[e],e,this.manager,this.commonContent,a,this.playTime,b),this.parts.push(d),a>0))if(0===e){if(a>=this.parts[e].part.measure.length)throw new Dacapo.Error.ParseError("The measure index "+a+" is too high. Max measure index is "+(this.parts[e].part.measure.length-1));c=this.parts[e].findPrevRepeats(a)}else this.parts[e].setPrevRepeats(c);this.started=!1}},getTimeAtMeasure:function(a){for(var b=null,c=null,d=null,e=0,f=0;f<a&&f<this.schedule[0].measure.length;)b=this.commonContent.getTempo(f)>>0,d=this.schedule[0].measure[f].$adagio.attributes.time["beat-type"],c=this.schedule[0].measure[f].$adagio.attributes.time.beats,e+=60/b*c*(4/d),f++;return e},loopCallback:function(){var a=[];if(this.metronomeSolo&&"undefined"==typeof require)this.minDelay=4/Dacapo.timeSignature.beatType;else{this.started||(this.started=!0,this.minDelay=0);for(var b=0,c=this.parts.length;b<c;b++)a[b]=this.parts[b].partCallback(this.minDelay);this.minDelay=Dacapo.Utils.minArray(a)}return this.minDelay===1/0||0===this.minDelay},scheduleWindow:function(a){var b=[],c=Dacapo.context.currentTime,d=c+a;if(this.metronome&&this.metronome.isSolo())this.minDelay=1;else{this.started=this.started||!0;for(var e=0,f=this.parts.length;e<f;e++)b[e]=this.parts[e].schedulePartWindow(c,d);this.minDelay=Dacapo.Utils.minArray(b)}if(this.minDelay===1/0){if(this.hasEndedSlider())return!0}else this.metronome&&this.scheduleTicksMetronome(d);return!1},stopScheduledNotes:function(){for(var a=0,b=this.parts.length;a<b;a++)this.parts[a].stopScheduledNotes()},pauseScheduledNotes:function(){this.pauseTime=Dacapo.context.currentTime;for(var a=0;a<this.parts.length;a++)this.parts[a].pauseScheduledNotes()},resumeScheduledNotes:function(){var a,b;for(b=Dacapo.context.currentTime-this.pauseTime,this.playTime=this.pauseTime+b,a=0;a<this.parts.length;a++)this.parts[a].resumeScheduledNotes(b)},scheduleMetronomeIntro:function(){this.metronome&&(this.playTime=this.metronome.scheduleIntro(this.playTime,Dacapo.timeSignature,Dacapo.unitDuration),this.changeTimeStart(this.playTime))},scheduleTicksMetronome:function(a){for(;this.nextTick<=a;)this.waitEndMeasure&&0===this.metronome.getCount()&&(this.changeTimeStart(this.nextTick),this.metronome.setSolo(!1),this.waitEndMeasure=!1),this.metronome.scheduleTick(Dacapo.timeSignature.beats,this.nextTick),this.nextTick+=4/Dacapo.timeSignature.beatType*Dacapo.unitDuration},setMetronome:function(a){this.metronome=a},setNextTick:function(a){this.nextTick=a},changeTimeStart:function(a){var b;for(b=0;b<this.parts.length;b++)this.parts[b].setTimeStart(a)},hasEndedSlider:function(){var a,b,c,d;return!(!this.parts||!this.parts[0]||(a=this.getPlayingHeadPosition(0),b=this.parts[0].part.measure.length-1,a.currentMeasure!==b||(c=this.parts[0].part.measure[b],d=this.getLastNoteFromVoice(a.currentVoiceId+1,c),a.currentNoteRealIdx!==d)))&&a.timeFromNoteStart>=a.currentNoteDuration},getLastNoteFromVoice:function(a,b){var c;for(c=b.note.length-1;c>=0;c--)if(!b.note[c].chord&&Number(b.note[c].voice||1)===a)return c;return 0},getPlayingHeadPosition:function(a){return this.parts.length>0&&this.started?(void 0===a&&(a=0),this.parts[a].getPlayingHeadPosition()):{timeFromMeasureStart:0,timeFromNoteStart:0,currentNoteDuration:1,currentNoteIndex:0,currentVoiceId:0,currentMeasure:this.parts.length?this.parts[0].measureIndex:0}},getHeadPosition:function(a){return this.parts.length>0&&this.started?(void 0===a&&(a=0),this.parts[a].getHeadPosition()):{timeFromMeasureStart:0,timeFromNoteStart:0,currentNoteDuration:1,currentNoteIndex:0,currentMeasure:this.parts.length?this.parts[0].measureIndex:0,timePerMeasure:0,beat:0,beatType:0,tempo:0}},getMetaMap:function(){return this.parts[0].getMetaMap()},getClosestNoteTime:function(){return this.minDelay*Dacapo.unitDuration},getTotalLength:function(){var a;return this.init(0),a=this.parts[0].getPartLength(),this.init(0),a},getTotalDuration:function(){var a,b,c=0;for(this.init(0),a=0;a<this.parts.length;a++)(b=this.parts[a].getPartTimeEnd())>c&&(c=b);return this.init(0),c},setNoRepeat:function(){for(var a=0;a<this.parts.length;a++)this.parts[a].setNoRepeat()},getPlayedNotesInParts:function(){var a,b=[];for(a=0;a<this.parts.length;a++)b[a]=this.parts[a].getPlayedNotesInPart();return b},setData:function(a){a&&(this.data=a,this.schedule=a.score["score-partwise"].part)},setCommonContent:function(a){a&&(this.commonContent=a)},enableSwing:function(){var a;for(Dacapo.swing=!0,a=0;a<this.parts.length;a++)this.parts[a].enableSwing()},disableSwing:function(){var a;for(Dacapo.swing=!1,a=0;a<this.parts.length;a++)this.parts[a].disableSwing()}}}.call(this),function(){"use strict";Dacapo.Tools=function(){Dacapo.context&&(this.input=Dacapo.context.createGain(),this.inputGain=Dacapo.context.createGain(),this.output=Dacapo.context.createGain(),this.outputGain=Dacapo.context.createGain(),this.bypassed=!1,this.input.connect(this.inputGain),this.inputGain.connect(this.outputGain),this.outputGain.connect(this.output))},Dacapo.Tools.prototype={connectTo:function(a){if("[object GainNode]"===Object.prototype.toString.call(a.input))return this.output.connect(a.input),a;console.error("Error connecting ",a,"to",this)},connect:function(a){this.output.connect(a)},disconnect:function(){this.output.disconnect()},setGain:function(a){this.outputGain.gain.value=a},getGain:function(){return this.outputGain.gain.value},isBypassed:function(){return this.bypassed},bypass:function(){this.bypassed||(this.bypassed=!0,this.outputGain.disconnect(),this.input.connect(this.output))},use:function(){this.bypassed&&(this.bypassed=!1,this.input.disconnect(),this.input.connect(this.inputGain),this.outputGain.connect(this.output))}}}.call(this),function(){"use strict";Dacapo.Tools.Mixer=function(){Dacapo.Tools.call(this),this.compressor=Dacapo.context.createDynamicsCompressor(),this.inputGain.disconnect(),this.inputGain.connect(this.compressor),this.compressor.connect(this.outputGain),this.muted=!1},Dacapo.Tools.Mixer.prototype=Object.create(Dacapo.Tools.prototype),Dacapo.Tools.Mixer.prototype.setThreshold=function(a){this.compressor.threshold.value=a},Dacapo.Tools.Mixer.prototype.mute=function(){this.muted=!0,this.inputGain.value=0},Dacapo.Tools.Mixer.prototype.unmute=function(){this.muted=!1,this.inputGain.value=1},Dacapo.Tools.Mixer.prototype.isMuted=function(){return this.muted}}.call(this),function(){"use strict";Dacapo.Tools.Fader=function(){Dacapo.Tools.call(this),this.muted=!1},Dacapo.Tools.Fader.prototype=Object.create(Dacapo.Tools.prototype),Dacapo.Tools.Fader.prototype.mute=function(){this.muted=!0,this.inputGain.value=0},Dacapo.Tools.Fader.prototype.unmute=function(){this.muted=!1,this.inputGain.value=1},Dacapo.Tools.Fader.prototype.isMuted=function(){return this.muted}}.call(this),function(){"use strict";Dacapo.Tools.Reverb=function(){Dacapo.Tools.call(this),this.convolver=Dacapo.context.createConvolver(),this.active=!1,this.inputGain.connect(this.convolver),this.convolver.connect(this.outputGain),this.reverse=!1,this.seconds=0,this.decay=1,this.buildImpulse()},Dacapo.Tools.Reverb.prototype=Object.create(Dacapo.Tools.prototype),Dacapo.Tools.Reverb.prototype.buildImpulse=function(){var a,b,c,d,e,f=Dacapo.context.sampleRate,g=f*this.seconds>>0,h=this.decay;if(g>0)for(this.use(),a=Dacapo.context.createBuffer(2,g,f),b=a.getChannelData(0),c=a.getChannelData(1),e=0;e<g;e++)d=this.reverse?g-e:e,b[e]=(2*Math.random()-1)*Math.pow(1-d/g,h),c[e]=(2*Math.random()-1)*Math.pow(1-d/g,h);else this.bypass(),a=Dacapo.context.createBuffer(2,1,f);this.convolver.buffer=a},Dacapo.Tools.Reverb.prototype.getDuration=function(){return this.seconds},Dacapo.Tools.Reverb.prototype.setDuration=function(a){this.seconds=a,this.buildImpulse()},Dacapo.Tools.Reverb.prototype.getDecay=function(){return this.decay},Dacapo.Tools.Reverb.prototype.setDecay=function(a){this.decay=a,this.buildImpulse()},Dacapo.Tools.Reverb.prototype.isReverse=function(){return this.reverse},Dacapo.Tools.Reverb.prototype.setReverse=function(a){this.reverse=a,this.buildImpulse()},Dacapo.Tools.Reverb.prototype.isActive=function(){return this.active}}.call(this),function(){"use strict";Dacapo.Tools.ADSR=function(){Dacapo.Tools.call(this),this.a=.005,this.d=.015,this.s=.35,this.r=.05,this.rateDecay=-this.d/Math.log(.001),this.rateRelease=-this.r/Math.log(.001),this.active=!1},Dacapo.Tools.ADSR.prototype=Object.create(Dacapo.Tools.prototype),Dacapo.Tools.ADSR.prototype.getAttack=function(){return this.a},Dacapo.Tools.ADSR.prototype.setAttack=function(a){this.a=a},Dacapo.Tools.ADSR.prototype.getDecay=function(){return this.d},Dacapo.Tools.ADSR.prototype.setDecay=function(a){this.d=a,this.rateDecay=-this.d/Math.log(.001)},Dacapo.Tools.ADSR.prototype.getSustain=function(){return this.s},Dacapo.Tools.ADSR.prototype.setSustain=function(a){this.s=a},Dacapo.Tools.ADSR.prototype.getRelease=function(){return this.r},Dacapo.Tools.ADSR.prototype.setRelease=function(a){this.r=a,this.rateRelease=-this.r/Math.log(.001)},Dacapo.Tools.ADSR.prototype.isActive=function(){return this.active},Dacapo.Tools.ADSR.prototype.noteOn=function(a){var b=a||Dacapo.context.currentTime,c=this.inputGain.gain;c.cancelScheduledValues(b),c.setValueAtTime(0,b),c.linearRampToValueAtTime(1,b+this.a),c.setTargetAtTime(this.s,b+this.a,this.rateDecay),this.active=!0},Dacapo.Tools.ADSR.prototype.noteOff=function(a){var b=a||Dacapo.context.currentTime,c=this.inputGain.gain;c.cancelScheduledValues(b),c.setTargetAtTime(0,b,this.rateRelease),this.active=!1}}.call(this),function(){"use strict";Dacapo.LFO=function(a){Dacapo.Oscillator.call(this),this.init(a)},Dacapo.LFO.prototype=Object.create(Dacapo.Oscillator.prototype),Dacapo.LFO.prototype.init=function(a){this.osc=Dacapo.context.createOscillator(),this.setFrequency(a)},Dacapo.LFO.prototype.start=function(a){a=a||0,this.osc.start(a)},Dacapo.LFO.prototype.stop=function(a){a=a||0,this.osc.stop(a)},Dacapo.LFO.prototype.setFrequency=function(a){this.osc.frequency.value=a},Dacapo.LFO.prototype.connect=function(a){this.osc.connect(a)}}.call(this),function(){"use strict";Dacapo.initOutput=function(){Dacapo.context&&(Dacapo.mainOutput=new Dacapo.Tools.Mixer,("undefined"==typeof require||Dacapo.context.outStream)&&Dacapo.mainOutput.connect(Dacapo.context.destination))}}.call(this),function(){"use strict";Dacapo.initWorkerTimer=function(){var a=window.URL||window.webkitURL;if(!(a&&window.Blob&&window.Worker))throw new Dacapo.Error.CompatibilityError("Cannot instantiate worker due to browser compatibility");var b=Dacapo.TimerWorker.toString();b=b.substring(b.indexOf("{")+1,b.lastIndexOf("}"));var c=a.createObjectURL(new Blob([b],{type:"text/javascript"}));Dacapo.workerInstance=new Worker(c),Dacapo.workerInstance.onmessage=Dacapo.WorkerTimer.onMessage.bind(Dacapo.WorkerTimer)},Dacapo.WorkerTimer={id:0,callbacks:{},setInterval:function(a,b,c){this.id++;var d=this.id;return this.callbacks[d]={fn:a,context:c},Dacapo.workerInstance.postMessage({command:"interval:start",interval:b,id:d}),d},setTimeout:function(a,b,c,d){this.id++;var e=this.id;return this.callbacks[e]={fn:a,context:c,args:d},Dacapo.workerInstance.postMessage({command:"timeout:start",timeout:b,id:e}),e},onMessage:function(a){var b;switch(a.data.message){case"interval:tick":b=this.callbacks[a.data.id],b&&b.fn&&b.fn.apply(b.context);break;case"interval:cleared":delete this.callbacks[a.data.id];break;case"timeout:tick":b=this.callbacks[a.data.id],b&&b.fn&&b.fn.apply(b.context,b.args);break;case"timeout:cleared":delete this.callbacks[a.data.id]}},clearInterval:function(a){Dacapo.workerInstance.postMessage({command:"interval:clear",id:a})},clearTimeout:function(a){Dacapo.workerInstance.postMessage({command:"timeout:clear",id:a})}},Dacapo.TimerWorker=function(){var a={},b=[];this.onmessage=function(c){var d;switch(c.data.command){case"interval:start":d=setInterval(function(){this.postMessage({message:"interval:tick",id:c.data.id})}.bind(this),c.data.interval),this.postMessage({message:"interval:started",id:c.data.id}),a[c.data.id]=d;break;case"timeout:start":d=setTimeout(function(){this.postMessage({message:"timeout:tick",id:c.data.id})}.bind(this),c.data.timeout),this.postMessage({message:"timeout:started",id:c.data.id}),b[c.data.id]=d;break;case"interval:clear":clearInterval(a[c.data.id]),this.postMessage({message:"interval:cleared",id:c.data.id}),delete a[c.data.id];break;case"timeout:clear":clearTimeout(b[c.data.id]),this.postMessage({message:"timeout:cleared",id:c.data.id})}}}}.call(this),function(){"use strict";Dacapo.Clock=function(a){this.interval=25,this.timerID=null,this.isPlaying=!1,this.isPaused=!1,this.isRecording=!1,this.isExporting=!1,this.nextNote=0,this.ahead=.1,this.loopMode=!1,this.endReached=!1,this.cbEnd=null,this.cbSlider=null,this.reader=a,this.startInterval=0,this.nextNoteRelative=0,this.windowSize=2,this.schedulingInterval=500,this.metronome=null,this.swing=!1,this.prmsResolver=null},Dacapo.Clock.prototype={getInterval:function(){return this.interval},setInterval:function(a){this.interval=a},getDuration:function(){return this.duration},setDuration:function(a){this.duration=a},getPlayingHeadPosition:function(){var a=this.reader.getPlayingHeadPosition();return this.isPlaying||(a.currentMeasure=0),a},getHeadPosition:function(){var a,b=this.reader.getHeadPosition();return this.isPlaying?(this.reader.started&&(a=Dacapo.context.currentTime-this.startInterval,b.timeFromMeasureStart+=a,b.timeFromNoteStart+=a),b):(b.timeFromMeasureStart=0,b.currentMeasure=0,b)},loop:function(){if(!this.isExporting&&this.nextNote<=Dacapo.context.currentTime+this.ahead?(this.endReached=this.reader.loopCallback(),this.nextNoteRelative=this.reader.getClosestNoteTime(),this.nextNote+=this.nextNoteRelative,this.startInterval=Dacapo.context.currentTime):this.isExporting&&(this.endReached=this.reader.loopCallback()),!this.loopMode&&this.endReached)return this.isExporting?this.isExporting=!1:this.stop(),void(null!==this.cbEnd&&this.cbEnd());this.isPlaying?(this.timerID=Dacapo.WorkerTimer.setTimeout(function(){this.loop()},this.interval,this),this.isPlaying&&this.cbSlider&&(this.cbSlider(this.getHeadPosition())||this.stop(this.cbEnd))):this.isExporting&&this.loop()},loopSchedule:function(a,b){var c;if(this.endReached=this.reader.scheduleWindow(this.windowSize),!this.loopMode&&this.endReached)return 1!==this.metronome.getMode()?this.cleanWorker():this.metronome.setSolo(!0),this.isPlaying=!1,void(null!==this.cbEnd&&(this.cbEnd(),a()));(this.isPlaying||this.metronome&&this.metronome.isSolo())&&(c=Dacapo.context.currentTime,this.timerID=Dacapo.WorkerTimer.setTimeout(function(a,b){if(Dacapo.context.currentTime===1/0)return a();c>=Dacapo.context.currentTime&&(void 0!==Dacapo.context.resume&&("running"===Dacapo.context.state&&Dacapo.context.suspend(),Dacapo.context.resume()),Dacapo.throwIfWebAudioStucked().catch(function(){b(new Dacapo.Error.BlockedWAAPIError({curTime:c,currentTime:Dacapo.context.currentTime,when:"playing",state:Dacapo.context.state}))})),this.loopSchedule(a,b)},this.schedulingInterval,this,[a,b]))},loopOn:function(){this.loopMode=!0},loopOff:function(){this.loopMode=!1},togglePlay:function(){this.isPlaying?this.stop():this.start()},start:function(a,b,c,d){var e,f=0;if(!this.isPlaying&&Dacapo.context)return"function"==typeof a&&(a=0,e=a,c=b,b=e),"function"==typeof d&&(this.cbSlider=d),this.isPaused?(this.isPaused=!1,this.isPlaying=!0,this.reader.resumeScheduledNotes(),this.prms=new Promise(function(a,b){this.prmsResolver=a,
this.loopSchedule(a,b)}.bind(this))):(this.reader.init(a),this.isPlaying=!0,this.metronome&&(f=this.metronome.getMode()),1!==f?(this.metronome&&0===f&&(this.metronome.setSolo(!0),this.reader.scheduleMetronomeIntro()),this.prms=new Promise(function(a,b){this.prmsResolver=a,this.loopSchedule(a,b)}.bind(this))):this.reader.waitEndMeasure=!0),"function"==typeof c&&(this.cbEnd=c),"function"==typeof b&&b(),this.prms},export:function(a){this.isExporting=!0,"function"==typeof a&&(this.cbEnd=a),this.loop()},pause:function(a){(this.isPlaying||this.metronome.isSolo())&&Dacapo.context&&(this.cleanWorker(),this.reader.pauseScheduledNotes(),this.isPlaying=!1,this.isPaused=!0,this.prmsResolver(),"function"==typeof a&&a())},stop:function(a){Dacapo.context&&(this.isPaused=!1,this.isPlaying&&(this.metronome&&1===this.metronome.getMode()?this.metronome.setSolo(!0):(this.cleanWorker(),this.metronome&&this.metronome.reset()),this.isPlaying=!1,this.reader.stopScheduledNotes(),this.prmsResolver()),this.reader.init(),"function"==typeof a&&a())},restart:function(){if(Dacapo.context)return this.isPaused=!1,this.reader.stopScheduledNotes(),this.prmsResolver(),this.prms=new Promise(function(a,b){this.prmsResolver=a,this.isPlaying&&1!==this.metronome.getMode()?(this.cleanWorker(),this.reader.init(0),this.loopSchedule(a,b)):(this.metronome.setSolo(!0),this.reader.init(0),this.reader.waitEndMeasure=!0)}.bind(this)),this.prms},jumpToMeasure:function(a){return this.reader.stopScheduledNotes(),this.prmsResolver(),this.prms=new Promise(function(b,c){this.prmsResolver=b,this.cleanWorker(),this.reader.init(a),this.loopSchedule(b,c)}.bind(this)),this.prms},cleanWorker:function(){Dacapo.WorkerTimer.clearTimeout(this.timerID)},startRecording:function(a){Dacapo.context&&(this.isRecording||(this.isRecording=!0,this.inputMIDI.startRecording(a)))},stopRecord:function(a){Dacapo.context&&this.isRecording&&(this.isRecording=!1,"function"==typeof a&&a())},setNoRepeat:function(){this.reader&&this.reader.setNoRepeat()},setMetronome:function(a){this.metronome=a,this.reader.setMetronome(a)},scheduleMetronomeSequence:function(a,b,c,d){var e=a.clicks*a.quarterDuration;this.metronome.switchOn(),this.scheduleSequenceRecur(a,e,b,0,c,d)},scheduleSequenceRecur:function(a,b,c,d,e,f){if(d<a.sequences&&Dacapo.context.currentTime+this.windowSize>=c&&(this.metronome.scheduleSequence({sequences:1,clicks:a.clicks,quarterDuration:a.quarterDuration},c,e),d++,c+=b,d>=a.sequences))return this.cleanWorker(),void(this.timerID=Dacapo.WorkerTimer.setTimeout(f,1e3*(c-Dacapo.context.currentTime)));this.timerID=Dacapo.WorkerTimer.setTimeout(function(){this.scheduleSequenceRecur(a,b,c,d,e,f)},this.schedulingInterval,this)},stopMetronomeSequence:function(){this.reader.metronome.cancelSequence(),this.cleanWorker()},toggleMetronome:function(){var a,b;return this.metronome&&(b=this.metronome.getMode(),a=(b+1)%3,this.setMetronomeMode(a)),a},setMetronomeMode:function(a,b){var c,d=this.metronome.getMode();a!==d&&(this.metronome.setMode(a),1===d&&(this.isPlaying||(this.cleanWorker(),this.stop(),this.metronome.setSolo(!1)),this.metronome.switchOff(),this.metronome.cancelSequence()),2===a?this.metronome.mute():2===d&&this.metronome.unmute(),1===a&&(this.metronome.switchOn(),this.isPlaying||(this.metronome.setSolo(!0),c="number"==typeof b?b:this.metronome.getNextPossibleTime(),this.reader.setNextTick(c),this.prms=new Promise(function(a,b){this.prmsResolver=a,this.loopSchedule(a,b)}.bind(this)))))},toggleSwing:function(){this.swing?this.reader.disableSwing():this.reader.enableSwing(),this.swing=!this.swing},enableSwing:function(){this.swing||(this.swing=!0,this.reader.enableSwing())},disableSwing:function(){this.swing&&(this.swing=!0,this.reader.disableSwing())},isSwingEnabled:function(){return this.swing}}}.call(this),function(){"use strict";Dacapo.MIDIProcessing={}}.call(this),function(){"use strict";Dacapo.MetaPart=function(a,b){this.events=a,this.innerTicks=b||480,this.barIndex=0,this.currentMeta={},this.currentIndex=0,this.currentTicks=0},Dacapo.MetaPart.prototype.getEventsAt=function(a){var b,c,d;for(a<this.currentTicks?(b=0,this.currentTicks=0):b=this.currentIndex;b<this.events.length;b++){if(c=this.events[b],this.currentMeta=c,this.currentTicks>=a)return this.currentIndex=b,this.getMetaCopy(c);d=4*c.beats/c.beatType*this.innerTicks,this.currentTicks+=d}return this.getMetaCopy(c)},Dacapo.MetaPart.prototype.getMetaCopy=function(a){return{timeSig:{beats:a.beats,beatType:a.beatType},tempo:a.tempo}},Dacapo.MetaPart.prototype.getTimeSignatureAt=function(a){return this.getEventsAt(a).timeSig},Dacapo.MetaPart.prototype.getTempoAt=function(a){return this.getEventsAt(a).tempo},Dacapo.MetaPart.prototype.setMetaArray=function(a){this.events=a,this.currentIndex=0,this.currentTicks=0},Dacapo.MetaPart.prototype.printMetaPart=function(){console.log("Meta Part")}}.call(this),function(){"use strict";var a=Dacapo.Utils;Dacapo.MIDIProcessing.Note=function(a,b,c,d){this.pitch=a,this.velocity=b,this.timeOn=c,this.duration=d,this.timeOff=this.timeOn+this.duration,this.voice=0,this.tieStart=!1,this.tieStop=!1,this.noteTiedLeft=null,this.noteTiedRight=null,this.finalNoteName=null,this.noteNames={},this.possibleLines=[],void 0!==a&&this.setPossibleNoteNames()},Dacapo.MIDIProcessing.Note.prototype={copy:function(){var a,b,c=new Dacapo.MIDIProcessing.Note(this.pitch,this.velocity,this.timeOn,this.duration);c.voice=this.voice,c.tieStart=this.tieStart,c.tieStop=this.tieStop,c.noteTiedLeft=this.noteTiedLeft,c.noteTiedRight=this.noteTiedRight,c.finalNoteName=this.finalNoteName,c.noteNames={};for(b in this.noteNames)this.noteNames.hasOwnProperty(b)&&(c.noteNames[b]=this.noteNames[b]);for(a=0;a<this.possibleLines.length;a++)c.possibleLines[a]=this.possibleLines[a];return c},setPossibleNoteNames:function(){for(var b,c=-1;c<=1&&(-1!==(b=a.NoteName.getKeyByValue(this.pitch+c))&&(this.noteNames[b]=a.NoteStrToNoteObj(b,-c),this.possibleLines.push(b)),0!==c||2!==this.possibleLines.length);c++);1===this.possibleLines.length?this.finalNoteName=this.noteNames[this.possibleLines[0]]:this.possibleLines.length>1&&0===this.noteNames[this.possibleLines[1]].alter&&this.possibleLines.reverse()},cut:function(a){var b=new Dacapo.MIDIProcessing.Note(void 0,this.velocity,a);return b.pitch=this.pitch,b.finalNoteName=this.finalNoteName,b.noteNames=this.noteNames,b.possibleLines=this.possibleLines,b.voice=this.voice,b.setTimeOff(this.timeOff),b.setTieStop(this),this.setTimeOff(a),this.setTieStart(b),b},setTimeOn:function(a){this.timeOn=a,void 0!==this.timeOff&&(this.duration=this.timeOff-this.timeOn)},setTimeOff:function(a){this.duration=a-this.timeOn,this.timeOff=this.timeOn+this.duration},setDuration:function(a){this.duration=a,this.timeOff=this.timeOn+this.duration},setVoice:function(a){this.voice=a},setTieStart:function(a){this.tieStart||(this.tieStart=!0,a&&(this.noteTiedRight=a))},setTieStop:function(a){this.tieStop||(this.tieStop=!0,a&&(this.noteTiedLeft=a))},removeTieStart:function(){this.tieStart&&(this.tieStart=!1,this.noteTiedRight&&(this.noteTiedRight.removeTieStop(),this.noteTiedRight=null))},removeTieStop:function(){this.tieStop&&(this.tieStop=!1,this.noteTiedLeft&&(this.noteTiedLeft.removeTieStop(),this.noteTiedLeft=null))},removeAllTies:function(){this.removeTieStart(),this.removeTieStop()},hasTie:function(){return this.tieStart||this.tieStop},hasTieStart:function(){return this.tieStart&&this.noteTiedRight},hasTieStop:function(){return this.tieStop&&this.noteTiedLeft},getTieArray:function(){var a=[];return this.tieStart&&a.push({$type:"start"}),this.tieStop&&a.push({$type:"stop"}),a},printNote:function(){console.log("timeOn:",this.timeOn,", duration:",this.duration,", timeOff:",this.timeOff,", pitch:",this.pitch,this.finalNoteName)}}}.call(this),function(){"use strict";var a=Dacapo.Quantizer;Dacapo.MIDIProcessing.Chord=function(a){this.timeOn=-1,this.timeOff=1/0,this.voice=a||0,this.notes=[],this.inTuplet=!1,this.tupletHead=!1,this.tupletInfo={},this.bar=-1,this.orig=null},Dacapo.MIDIProcessing.Chord.prototype={copy:function(){var a,b,c=new Dacapo.MIDIProcessing.Chord(this.voice);for(c.timeOn=this.timeOn,c.timeOff=this.timeOff,c.notes=this.notes,c.inTuplet=this.inTuplet,c.tupletHead=this.tupletHead,c.tupletInfo={},c.bar=this.bar,a=0;a<this.notes.length;a++)c.notes[a]=this.notes[a].copy();if(this.tupletInfo)for(b in this.tupletInfo)this.tupletInfo.hasOwnProperty(b)&&(c.tupletInfo[b]=this.tupletInfo[b]);return c},addNote:function(a){var b;return(b=this.getNoteIdxByPitch(a.pitch))>-1?(a.timeOff>this.notes[b].timeOff&&this.notes[b].setTimeOff(a.timeOff),!0):(this.timeOn<0&&(this.timeOn=a.timeOn),a.timeOff<this.timeOff&&(this.timeOff=a.timeOff),this.notes.push(a),!0)},preventChordOverlap:function(a,b){var c,d,e=null;for(c=0;c<this.notes.length;c++)d=this.notes[c].cut(a),d.duration>b?(e||(e=new Dacapo.MIDIProcessing.Chord),e.addNote(d)):this.notes[c].removeTieStart();return this.timeOff=a,e},sortNotesByLength:function(){this.notes.sort(function(a,b){return a.timeOff-b.timeOff})},assignPitches:function(){for(var a,b=[],c=0;c<this.notes.length;c++)null!==this.notes[c].finalNoteName&&b.push(this.notes[c].possibleLines[0]);for(c=0;c<this.notes.length;c++)if(null===this.notes[c].finalNoteName)for(var d=0;d<2;d++)if(a=this.notes[c].possibleLines[d],-1===b.indexOf(a)){b.push(a),this.notes[c].finalNoteName=this.notes[c].noteNames[a];break}this.epurChord()},epurChord:function(){for(var a=0;a<this.notes.length;a++)null===this.notes[a].finalNoteName&&(this.notes[a].removeAllTies(),this.notes.splice(a,1))},cutOverLengthNotes:function(){var a,b;if(this.notes.length>1)for(var c=0;c<this.notes.length;c++)this.notes[c].timeOff>this.timeOff&&(a=this.notes[c].cut(this.timeOff),void 0===b&&(b=new Dacapo.MIDIProcessing.Chord,b.voice=this.voice,this.inTuplet&&this.tupletInfo.timeOff>a.timeOn&&b.setTuplet(this.tupletInfo)),b.addNote(a));return b},mergeChord:function(b){if(this.inTuplet){var c=new a;b.tupletInfo=this.tupletInfo,b.quantizeChordTuplet(c)}for(var d=0;d<b.notes.length;d++)this.addNote(b.notes[d])},cutNotesAtTime:function(a){for(var b,c=new Dacapo.MIDIProcessing.Chord,d=0;d<this.notes.length;d++)b=this.notes[d].cut(a),c.addNote(b);return this.timeOff=a,c},cutNotesAtLength:function(a){return this.cutNotesAtTime(this.timeOn+a)},setNotesOnAt:function(a){for(var b=0;b<this.notes.length;b++)this.notes[b].setTimeOn(a)},getNoteIdxByPitch:function(a){for(var b=0;b<this.notes.length;b++)if(this.notes[b].pitch===a)return b;return-1},getMinDuration:function(){var a,b=this.notes[0].duration;for(a=1;a<this.notes.length;a++)this.notes[a].duration<b&&(b=this.notes[a].duration);return b},hasANoteLongerOrEqualThan:function(a){for(var b=0;b<this.notes.length;b++)if(this.notes[b].duration>=a)return!0;return!1},setBar:function(a){this.bar=a},setTuplet:function(a){return this.inTuplet=!0,this.tupletInfo=a,!0},setTupletHead:function(){this.tupletHead=!0},removeTuplet:function(){this.inTuplet=!1,this.tupletInfo={},this.tupletHead=!1},quantizeChord:function(a){var b,c=1/0;for(b=0;b<this.notes.length;b++)a.quantizeNote(this.notes[b]),this.notes[b].timeOn<c&&(c=this.notes[b].timeOn);for(this.timeOn=c,this.timeOff=this.notes[0].timeOff,b=0;b<this.notes.length;b++)this.notes[b].setTimeOn(this.timeOn),this.notes[b].timeOn>=this.notes[b].timeOff?this.notes.splice(b--,1):this.notes[b].timeOff<this.timeOff&&(this.timeOff=this.notes[b].timeOff)},quantizeChordTuplet:function(a){var b,c,d,e,f=this.tupletInfo.timeOff,g=1/0,h=new Dacapo.MIDIProcessing.Chord(this.voice);if(e=a.getAdequateQuantForTuplet(this.tupletInfo.len,this.tupletInfo.type),(b=this.tupletHead?this.tupletInfo.timeOn:a.quantizeNoteOn(this.timeOn,e))>=f)return this.removeTuplet(),this.setNotesOnAt(b),this.quantizeChord(a,b),h;for(var i=0;i<this.notes.length;i++)this.notes[i].setTimeOn(b),c=a.quantizeNoteOff(b,this.notes[i].timeOff,e),this.notes[i].setTimeOff(c),c>f&&(d=this.notes[i].cut(f),h.addNote(d),f<g&&(g=f)),c<g&&(g=c);return this.timeOn=b,this.timeOff=g,h},printChord:function(){console.log("-- CHORD: voice",this.voice,", timeOn",this.timeOn,", timeOff",this.timeOff,"bar",this.bar,"inTuplet",this.inTuplet);for(var a=0;a<this.notes.length;a++)this.notes[a].printNote()}}}.call(this),function(){"use strict";Dacapo.MIDIProcessing.Bar=function(a,b,c,d){this.idx=a,this.timeStart=c||0,this.timeEnd=d||0,this.timeSig=b,this.chords=[],this.voiceMax=0,this.prevBar=null,this.nextBar=null},Dacapo.MIDIProcessing.Bar.prototype={addChord:function(a){a.setBar(this.idx),this.chords.push(a)},addChordToTop:function(a){if(a.setBar(this.idx),this.chords.length>0&&a.timeOn===this.chords[0].timeOn)return this.chords[0].mergeChord(a);this.chords.unshift(a)},setPrevBar:function(a){this.prevBar=a,a.nextBar=this},setNextBar:function(a){this.nextBar=a,a.prevBar=this},getChordsInRange:function(a,b){for(var c=[],d=0;d<this.chords.length;d++)this.chords[d].timeOn>=a&&this.chords[d].timeOn<=b&&c.push(this.chords[d]);return c},hasChordsInVoice:function(a){for(var b=0;b<this.chords.length;b++)if(this.chords[b].voice===a)return!0;return!1},getFirstChordInVoice:function(a){for(var b=0;b<this.chords.length;b++)if(this.chords[b].voice===a)return this.chords[b];return this.nextBar?this.nextBar.getFirstChordInVoice(a):null},getChordsFromVoiceForTuplets:function(a){for(var b=[],c=0;c<this.chords.length;c++)this.chords[c].voice===a&&b.push(this.chords[c]);return null!==this.nextBar&&this.nextBar.hasChordsInVoice(a)&&b.push(this.nextBar.getFirstChordInVoice(a)),b},quantizeChords:function(a){var b,c,d;for(b=0;b<this.chords.length;b++)this.chords[b].inTuplet?(c=this.chords[b].quantizeChordTuplet(a),c.notes.length>0&&this.placeNewChord(c,b)):this.chords[b].quantizeChord(a),d=this.getNextChordInVoice(b+1,this.chords[b].voice),this.chords[b].timeOn>=this.chords[b].timeOff||0===this.chords[b].notes.length?this.chords.splice(b--,1):!this.chords[b].inTuplet&&d&&d.inTuplet&&this.chords[b].timeOn===d.tupletInfo.timeOn&&(d.mergeChord(this.chords[b]),this.chords.splice(b--,1));for(b=this.chords.length-1;b>=0;b--)d=this.getNextChordInVoice(b+1,this.chords[b].voice),this.chords[b].timeOn>=this.timeEnd?(this.nextBar||(this.nextBar=new Dacapo.MIDIProcessing.Bar(this.idx+1,this.timeSig,this.timeEnd,this.timeEnd+(this.timeEnd-this.timeStart))),this.nextBar.addChordToTop(this.chords.splice(b,1)[0])):d&&d.timeOn===this.chords[b].timeOn&&(d.mergeChord(this.chords[b]),this.chords.splice(b,1))},getChordsByVoices:function(){var a,b=[];for(a=0;a<this.chords.length;a++)void 0===b[this.chords[a].voice]&&(b[this.chords[a].voice]=[]),b[this.chords[a].voice].push(this.chords[a]);return b},cutChords:function(){var a,b;for(a=0;a<this.chords.length;a++)(b=this.chords[a].cutOverLengthNotes())&&(this.placeNewChord(b,a+1),this.chords[a].inTuplet&&b.timeOn<this.chords[a].tupletInfo.timeOff&&b.setTuplet(this.chords[a].tupletInfo));for(a=0;a<this.chords.length;a++)this.chords[a].timeOff>this.timeEnd&&(b=this.chords[a].cutNotesAtTime(this.timeEnd),this.nextBar||(this.nextBar=new Dacapo.MIDIProcessing.Bar(this.idx+1,this.timeSig,this.timeEnd,this.timeEnd+(this.timeEnd-this.timeStart))),this.nextBar.placeNewChord(b,0))},cutSuperimposedChords:function(){var a,b,c,d;for(a=0;a<this.chords.length;a++)d=this.getNextChordInVoice(a+1,this.chords[a].voice),b=this.chords[a].cutOverLengthNotes(),b&&d&&this.placeNewChord(b,a+1),this.chords[a].timeOff>this.timeEnd&&(b=this.chords[a].cutNotesAtTime(this.timeEnd),this.placeNewChord(b,a+1)),d&&this.chords[a].timeOff>d.timeOn&&(c=this.chords[a].cutNotesAtTime(d.timeOn),d.mergeChord(c)),this.chords[a].assignPitches()},placeNewChord:function(a,b){var c;if(a.timeOn>=this.timeEnd)return this.nextBar||(this.nextBar=new Dacapo.MIDIProcessing.Bar(this.idx+1,this.timeSig,this.timeEnd,this.timeEnd+(this.timeEnd-this.timeStart)),this.nextBar.prevBar=this),this.nextBar.placeNewChord(a,0);for(;b<this.chords.length&&(a.timeOn>this.chords[b].timeOn||this.chords[b].voice!==a.voice);)b++;c=this.getPrevChordInVoice(b-1,a.voice),c&&c.inTuplet&&c.tupletInfo.timeOff>a.timeOn&&a.setTuplet(c.tupletInfo),b<this.chords.length&&a.timeOn===this.chords[b].timeOn&&this.chords[b].voice===a.voice?this.chords[b].mergeChord(a):(a.setBar(this.idx),this.chords.splice(b,0,a))},getPrevChordInVoice:function(a,b){for(;a>=0;a--)if(this.chords[a].voice===b)return this.chords[a];return null},getNextChordInVoice:function(a,b){for(;a<this.chords.length;a++)if(this.chords[a].voice===b)return this.chords[a];return this.nextBar?this.nextBar.getFirstChordInVoice(b):null},printBar:function(){var a;for(console.log("---- BAR index:",this.idx,"tickStart:",this.timeStart,", tickEnd:",this.timeEnd),a=0;a<this.chords.length;a++)this.chords[a].printChord()}}}.call(this),function(){"use strict";var a=Dacapo.MIDIProcessing.Bar,b=Dacapo.MIDIProcessing.Note,c=Dacapo.MIDIProcessing.Chord,d=Dacapo.Fraction,e=Dacapo.Quantizer,f=Dacapo.MIDIUtils,g=f.ChannelEvent;Dacapo.MIDIProcessing.Part=function(a,b,c){this.channel=a,this.drumPart=!1,9===a&&(this.drumPart=!0),this.metaPart=c,this.transpose=0,this.ticksPerBeat=b||480,this.minDuration=b/4,this.quantizer=new e,this.incompleteNotes={},this.lastNoteStop={},this.lastFullNote=null,this.notes=[],this.chords=[],this.bars=[],this.tuplets=[],this.staves=1,this.noteRange={max:0,min:128},this.chordThreshold=.04,this.instrumentId=1,this.lastAbsoluteTime=0,this.humanDelay=.2},Dacapo.MIDIProcessing.Part.prototype={addEvent:function(a,c){var d,e=this.metaPart.getEventsAt(0),f=60/e.tempo,h=this.humanDelay/f*this.ticksPerBeat>>0;if(c=c/f*this.ticksPerBeat>>0,a.type===g.TYPE.NOTE_ON&&a.velocity>0){if(void 0===this.incompleteNotes[a.note]){if(d=new b(a.note+this.transpose,a.velocity,c),this.lastFullNote&&(this.lastFullNote.pitch===d.pitch&&c-this.lastFullNote.timeOff<h+(.3*h>>0)?this.lastFullNote.setTimeOff(c-1):this.lastFullNote.pitch!==d.pitch&&c-this.lastFullNote.timeOff<.3*h>>0&&this.lastFullNote.setTimeOff(c-1)),0===d.possibleLines.length)return;this.notes.push(d),this.incompleteNotes[a.note]=d}}else a.type!==g.TYPE.NOTE_ON&&a.type!==g.TYPE.NOTE_OFF||void 0!==this.incompleteNotes[a.note]&&(d=this.incompleteNotes[a.note],d.setTimeOff(c),this.lastFullNote=d,delete this.incompleteNotes[a.note],this.updateStavesCount(a.note));this.lastAbsoluteTime=c},removeIncompleteNotes:function(){for(var a,b=this.notes.length-1;b>=0&&Object.keys(this.incompleteNotes).length>0;b--)a=this.notes[b].pitch,void 0!==this.incompleteNotes[a]&&(this.notes.splice(b,1),delete this.incompleteNotes[a])},prepareNewTrack:function(){this.incompleteNote={}},sortNotes:function(){this.notes.sort(function(a,b){return a.timeOn-b.timeOn})},sortChords:function(){for(var a=0;a<this.staves;a++)this.chords[a].sort(function(a,b){return a.timeOn-b.timeOn})},quantizeNotes:function(){for(var a=0;a<this.notes.length;a++)this.quantizer.quantizeNote(this.notes[a])},gatherObviousChords:function(){var b,d,e=0,f=[-1,-1,-1],g=[],h=this.metaPart.getEventsAt(0),i=h.timeSig,j=this.chordThreshold/(60/h.tempo)*this.ticksPerBeat>>0,k=0,l=4*i.beats/i.beatType*this.ticksPerBeat,m=0,n=new a(m,i,k,l);for(this.initChordsArray(),b=0;b<this.notes.length;b++){if(this.staves>1&&(this.assignVoice(this.notes[b]),e=this.notes[b].voice),this.notes[b].timeOn>=l)for(;l<=this.notes[b].timeOn;)this.bars.push(n),m++,h=this.metaPart.getEventsAt(l),i=h.timeSig,j=this.chordThreshold/(60/h.tempo)*this.ticksPerBeat>>0,k=l,l+=4*i.beats/i.beatType*this.ticksPerBeat,d=new a(m,i,k,l),d.setPrevBar(n),n=d;(void 0===g[e]||this.notes[b].timeOn>g[e].timeOn+j)&&(void 0!==g[e]&&this.chords[e].push(g[e]),g[e]=new c(e),n.addChord(g[e])),g[e].addNote(this.notes[b]),f[e]=this.notes[b].timeOn}this.bars.push(n)},correctHumanMistakes:function(){var a,b,c,d,e,f,g;for(a=0;a<this.chords.length;a++)for(e=this.chords[a],b=0;b<e.length;b++)f=e[b],c&&(g=c.timeOff-f.timeOn)>0&&g<this.minDuration&&(d=c.preventChordOverlap(f.timeOn,this.minDuration))&&f.mergeChord(d),c=f},assignBars:function(){var a,b,c=0,d=this.metaPart.getTimeSignatureAt(0),e=4*d.beats/d.beatType*this.ticksPerBeat;for(b=0;b<this.chords.length;b++)for(a=0;a<this.chords[b].length;a++)this.chords[a].noteOn>e&&(c++,d=this.metaPart.getTimeSignatureAt(this.chords[a].noteOn),e=4*d.beats/d.beatType*this.ticksPerBeat),this.chords[a].setBar(c)},findTupletsInPart:function(){var a;for(a=0;a<this.chords.length;a++)this.findTupletsInVoice(a)},findTupletsInVoice:function(a){var b;for(b=0;b<this.bars.length;b++)this.setTupletsInBar(this.bars[b].getChordsFromVoiceForTuplets(a),this.bars[b].timeStart,this.bars[b].timeSig)},findTupletsInMeasure:function(a,b,c){var e,f,g,h,i;if(a.length>0){for(f=a[0].timeOn,i=this.getAllowedTupletsType(f,c),c=new d(c.beats,c.beatType),e=0;e<i.length;e++)void 0!==(h=this.isAllowedTuplet(i[e],c,a,b))&&this.isBestTupletForChords(h,g)&&(g=h);"undefined"!=typeof bestTuplet&&this.setTupletInChords(g)}},setTupletsInBar:function(a,b,c){var e,f,g,h,i=[];if(a.length>0){for(f=a[0].timeOn,g=this.getAllowedTupletsType(f,c),c=new d(c.beats,c.beatType),h=this.getDivisionsOfBar(c),e=0;e<h.length;e++)i=i.concat(this.getTupletInfosForLen(b,h[e],c,a,g));this.setTupletFromArrayInfo(i)}},setTupletFromArrayInfo:function(a){var b,c;for(b=0;b<a.length-1;b++)if(a[b])for(c=b+1;c<a.length&&(!a[c]||!this.haveCommonChords(a[b],a[c])||this.keepBestTuplet(a,b,c)!==b);c++);for(this.epurInfoArr(a),b=0;b<a.length;b++)this.setTupletInChords(a[b])},haveCommonChords:function(a,b){var c,d;for(c=0;c<a.chordsInRange.length;c++)for(d=0;d<b.chordsInRange.length;d++)if(a.chordsInRange[c]===b.chordsInRange[d])return!0;return!1},keepBestTuplet:function(a,b,c){var d=0,e=a[b].chords.length,f=a[c].chords.length,g=e-f,h=a[c].tupletSumError-a[b].tupletSumError;return 0!==g&&(d+=g/Math.abs(g)),0!==h&&(d+=h/Math.abs(h)),d<0?(a[b]=null,b):d>0?(a[c]=null,c):a[b].len>a[c].len?(a[c]=null,c):(a[b]=null,b)},epurInfoArr:function(a){var b;for(b=0;b<a.length;)null===a[b]?a.splice(b,1):b++},isAllowedTuplet:function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n=this.getDivisionsOfBar(b),o=4*b.num/b.den*this.ticksPerBeat,p=[];for(l=0;l<n.length;l++)for(e=n[l],f=b.copy().div(e).value(),m=0;m<f;m++)if(g=d+m*e.value()*o,h=d+(m+1)*e.value()*o,k=this.extractChordsInRange(g,h,c),k.length>0){if(!this.tupletIsAllowedInRange(e,a.type,k))return j;i=this.getTupletInfo(k,a,e,g),this.confirmTupletFromInfo(i,a)&&this.isBestTupletForChords(i,j)&&(j=i,p.push(i))}return j},getTupletInfosForLen:function(a,b,c,d,e){var f,g,h,i,j,k=c.copy().div(b).value()>>0,l=[];for(f=0;f<k;f++)h=a+f*b.toTicks(this.ticksPerBeat),i=a+(f+1)*b.toTicks(this.ticksPerBeat),g=this.extractChordsInRange(h,i,d),g.length>0&&(j=this.getTupletInfoForDiv(b,h,g,e))&&l.push(j);return l},getTupletInfoForDiv:function(a,b,c,d){var e,f,g;if(0!==c.length){for(e=0;e<d.length;e++)this.tupletIsAllowedInRange(a,d[e].type,c)&&(f=this.getTupletInfo(c,d[e],a,b),this.confirmTupletFromInfo(f,d[e])&&this.isBestTupletForChords(f,g)&&(g=f));return g}},isBestTupletForChords:function(a,b){var c;if(void 0===b)return!0;for(var d=0;d<a.chords.length;d++)if(a.chords[d].inTuplet){if(b.chords.length<a.chords.length)return!1;if(c=a.tupletSumError-a.regularSumError,b.tupletSumError-b.regularSumError<c)return!1}return!0},setTupletInChords:function(a){if(void 0!==a)for(var b=0;b<a.chordsInRange.length;b++)a.chordsInRange[b].setTuplet(a),0===b&&a.chordsInRange[b].setTupletHead()},confirmTupletFromInfo:function(a,b){var c,d,e,f=b.minChords;if(1===a.chords.length&&3===a.type&&0===a.index)for(d=a.chords[0],c=0;c<d.notes.length;c++)if(Math.abs(d.notes[c].duration-a.noteLen)>a.noteLen/2>>0)return!1;if(a.chords.length<f)return!1;if(a.tupletSumError>=a.regularSumError)return!1;if(a.chords[0].timeOn!==a.timeOn&&(e=this.quantizer.getAdequateQuantForTuplet(a.len,a.type),this.quantizer.quantizeNoteOn(a.chords[0].timeOn,e)!==a.timeOn))return!1;for(c=0;c<a.chords.length;c++)if(a.chords[c].hasANoteLongerOrEqualThan(a.noteLen/2>>0))return!0;return!1},getQuantErrorOnTimes:function(a){var b=a.getMinDuration(),c=d.fromTicks(b,this.ticksPerBeat),e=this.quantizer.getAdequateQuantForLength(c),f=d.fromTicks(a.timeOn,this.ticksPerBeat),g=this.quantizer.quantizeNoteOn(f,e);return Math.abs(a.timeOn-g.toTicks(this.ticksPerBeat))},getTupletInfo:function(a,b,c,d){var e,f,g,h,i,j,k=0,l=c.copy().toTicks(this.ticksPerBeat),m=l/b.type,n={type:b.type,len:c,ratio:b.ratio,index:0,noteLen:m,tupletSumError:0,regularSumError:0,chords:[],chordsInRange:a,timeOn:d,timeOff:d+b.type*m},o=[],p=[];for(e=0;e<b.type;e++)for(g=d+m*e,f=0;f<a.length;f++)if(a[f].timeOn>=g-m/2){if(!(a[f].timeOn<=g+m/2))break;h=Math.abs(a[f].timeOn-g),i=this.getQuantErrorOnTimes(a[f]),j=h-i,o.push({index:e,tupletError:h,regularError:i,diff:j,chord:a[f],qTimeOn:g})}for(e=0;e<o.length&&k+o[e].diff<=0;e++)p.indexOf(o[e].index)&&(k+=o[e].diff,n.chords.push(o[e].chord),n.tupletSumError+=o[e].tupletError,n.regularSumError+=o[e].regularError,0===e&&(n.index=o[e].index),p.push(o[e].index));return n},extractChordsInRange:function(a,b,c){for(var d=[],e=0;e<c.length;e++)c[e].timeOn>=a&&c[e].timeOn<b&&d.push(c[e]);return d},shortestQuantizedNoteInRange:function(a){var b,c=this.ticksPerBeat,d=a[0].getMinDuration(),e=this.quantizer.minAllowedDuration;for(b=1;b<a.length;b++)d=a[b].getMinDuration();for(;c>e;){if(c<=d)return c;c/=2}return c},findQuantForRange:function(a){var b=this.shortestQuantizedNoteInRange(a);return this.quantizer.getAdequateQuantForLength(d.fromTicks(b,this.ticksPerBeat))},tupletIsAllowedInRange:function(a,b,c){var d=a.copy().div(b),e=this.findQuantForRange(c);return!(d.toTicks(this.ticksPerBeat)%1>0)&&d.value()>=e.value()},getDivisionsOfBar:function(a){var b=0,c=[];for(c.push(a.copy()),2===a.num||6===a.num||a.num%4==0?c.push(c[b++].copy().div(2)):a.num%3==0&&a.num>3?c.push(c[b++].copy().div(3)):a.num%5==0?c.push(c[b++].copy().div(5)):a.num%7==0?c.push(c[b++].copy().div(7)):c.push(c[b++].copy().div(a.num));c[b].value()>=2*this.quantizer.minAllowedDuration.value();)c.push(c[b++].copy().div(2));return c},getAllowedTupletsType:function(a,b){return b=b||this.metaPart.getTimeSignatureAt(a),f.TimeSignature.isCompound(b)?[]:[{type:3,ratio:new d(3,2),minChords:2},{type:5,ratio:new d(5,4),minChords:4},{type:6,ratio:new d(6,4),minChords:4}]},quantizeNotesAndGatherChords:function(){var a,b=0,d=[-1,-1,-1],e=[];for(this.initChordsArray(),a=0;a<this.notes.length;a++)this.quantizer.quantizeNote(this.notes[a]),this.staves>1&&(this.assignVoice(this.notes[a]),b=this.notes[a].voice),this.notes[a].timeOn!==d[b]&&(void 0!==e[b]&&this.chords[b].push(e[b]),e[b]=new c(b)),e[b].addNote(this.notes[a]),d[b]=this.notes[a].timeOn;for(a=0;a<this.staves;a++)e[a]&&this.chords[a].push(e[a])},quantizeChordsInBars:function(){var a;for(a=0;a<this.bars.length;a++)this.bars[a].quantizeChords(this.quantizer);this.addNewBars()},assignVoice:function(a){a.pitch<58&&this.staves>1&&a.setVoice(1)},initChordsArray:function(){for(var a=0;a<this.staves;a++)this.chords[a]=[]},cutChords:function(){for(var a,b=0;b<this.chords.length;b++)for(var c=0;c<this.chords[b].length;c++)(a=this.chords[b][c].cutOverLengthNotes())&&this.chords[b][c+1]&&(this.chords[b][c+1].timeOn===a.timeOn?this.chords[b][c+1].mergeChord(a):a.timeOn<this.chords[b][c+1].timeOn?this.chords[b].splice(c+1,0,a):this.placeNewChord(a,c+1,b))},cutChordsInBars:function(){var a;for(a=0;a<this.bars.length;a++)this.bars[a].cutChords();this.addNewBars()},cutSuperimposedChords:function(){for(var a,b,c,d=0;d<this.chords.length;d++)for(var e=0;e<this.chords[d].length;e++)c=this.chords[d][e+1],a=this.chords[d][e].cutOverLengthNotes(),a&&c&&(c.timeOn===a.timeOn?c.mergeChord(a):a.timeOn<c.timeOn?this.chords[d].splice(e+1,0,a):this.placeNewChord(a,e+1,d)),c&&this.chords[d][e].timeOff>c.timeOn&&(b=this.chords[d][e].cutNotesAtTime(c.timeOn),c.mergeChord(b)),this.chords[d][e].assignPitches()},cutSuperimposedChordsInBars:function(){var a;for(a=0;a<this.bars.length;a++)this.bars[a].cutSuperimposedChords();this.addNewBars()},addNewBars:function(){var a;for(a=this.bars.length-1;a<this.bars.length;a++)this.bars[a].nextBar&&this.bars.push(this.bars[a].nextBar)},placeNewChord:function(a,b,c){for(;b<this.chords[c].length&&a.timeOn>this.chords[c][b].timeOn;)b++;b<this.chords[c].length&&a.timeOn===this.chords[c][b].timeOn?this.chords[c][b].mergeChord(a):this.chords[c].splice(b,0,a)},getChordsForMeasure:function(a){for(var b,c,d=[],e=0;e<this.staves;e++)if(this.chords[e])for(d[e]=[];this.chords[e][0]&&this.chords[e][0].timeOn<a;)b=this.chords[e].shift(),b.timeOff>a&&(c=b.cutNotesAtTime(a),this.chords[e].unshift(c)),d[e].push(b);return d},getBar:function(a){return void 0!==this.bars[a]?this.bars[a]:null},hasChordsLeft:function(){for(var a=0;a<this.staves;a++)if(this.chords[a]&&this.chords[a].length>0)return!0;return!1},getPartProperties:function(a){var b={};return this.isDrumPart()?(b.name=this.getPartName(),b.instrumentsList=f.Drumset.instruments,b.pitchMapping=f.Drumset.mapping):(b.partName=this.getPartName(),b.instrumentName=this.getInstrumentName(),b.MIDIProgram=this.getInstrumentId(),b.staves=this.getStaves(a)),b},updateStavesCount:function(a){a>this.noteRange.max&&(this.noteRange.max=a),a<this.noteRange.min&&(this.noteRange.min=a),this.drumPart||(this.staves=Math.floor((this.noteRange.max-this.noteRange.min)/30)+1,this.staves>2&&(this.staves=2))},setInstrumentId:function(a){this.instrumentId=a+1,this.isDrumPart()||(this.setTransposition(f.getInstrumentTranspo(a)),this.setInstrumentName(gm.getInstrument(a)))},setInstrumentName:function(a){this.instrumentName=a.replace(/(^| )(\w)/g,function(a){return a.toUpperCase()}),void 0===this.partName&&(this.partName=this.instrumentName)},getInstrumentId:function(){return this.instrumentId},getPartName:function(){return void 0!==this.partName?this.partName:this.instrumentName},getInstrumentName:function(){return void 0!==this.instrumentName?this.instrumentName:this.isDrumPart()?"Drumset":"Grand Piano"},setTransposition:function(a){this.transpose=a},getStaves:function(a){for(var b,c=[],d=this.computeClefs(),e=0;e<this.staves;e++)b={},b.clef={sign:d[e]},"F"===d[e]&&this.noteRange.min<24&&(b.clef["clef-octave-change"]=-1),b.concertKey={fifths:a.fifths||0},b.transpose={chromatic:0,diatonic:0},c.push(b);return c},computeClefs:function(){return this.staves>1?["G","F"]:1===this.staves&&this.noteRange.min>50?["G"]:1===this.staves&&this.noteRange.max<58?["F"]:["G"]},isDrumPart:function(){return this.drumPart},hasNotes:function(){return this.notes.length>0},setHumanDelay:function(a){this.humanDelay=a},printNotes:function(){for(var a=0;a<this.notes.length;a++)this.notes[a].printNote()},printChords:function(){console.log("ID",this.getInstrumentId(),"NAME",this.getPartName()),console.log("NOTERANGE",this.noteRange);for(var a=0;a<this.chords.length;a++){console.log("---------------------------------VOICE",a);for(var b=0;b<this.chords[a].length;b++)this.chords[a][b].printChord()}},printBars:function(){console.log("ID",this.getInstrumentId(),"NAME",this.getPartName());for(var a=0;a<this.bars.length;a++)this.bars[a].printBar()},printBar:function(a){console.log("ID",this.getInstrumentId(),"NAME",this.getPartName()),this.bars[a].printBar()}}}.call(this),function(){"use strict";var a=Dacapo.MIDIUtils,b=Adagio.Utils.durationUtils,c=Adagio.Utils.timeModifUtils;Dacapo.PostProcessor=function(b){this.innerTicks=a.INNER_TICKS_PER_QUARTER_NOTE,this.metaMap={},this.setMetaMap(b),this.midiPart=new Dacapo.MIDIProcessing.Part(0,this.innerTicks,this.metaMap),this.drumPart=!1,this.dataStaff={},this.selectedVoice=0,this.humanDelayBase=.02,this.tempo=120,this.timeSignature={beats:4,beatType:4},this.initDataStaff(this.drumPart)},Dacapo.PostProcessor.prototype={initDataStaff:function(a){this.dataStaff={notes:[],ties:[],slurs:[],isUnpitched:a,attributes:this.createDefaultAttributes()}},processPart:function(a,b){var c,d,e;for(this.midiPart.setHumanDelay(this.humanDelayBase),c=0;c<b.length;c++)d=b[c],e=d.time-a,this.midiPart.addEvent({type:d.type>>4,note:d.data1,velocity:d.data2},e);return this.midiPart.removeIncompleteNotes(),this.midiPart.sortNotes(),this.midiPart.prepareNewTrack(),
this.quantizePart(this.midiPart),this.buildPart(),this.dataStaff},quantizePart:function(a){a.gatherObviousChords(),a.correctHumanMistakes(),a.findTupletsInPart(),a.quantizeChordsInBars(),a.cutChordsInBars(),a.cutSuperimposedChordsInBars()},buildPart:function(){var a,b,c=!1,d=0,e=0,f=this.timeSignature.beats*this.innerTicks*4/this.timeSignature.beatType;for(b=f,d=0;!c;b+=f,d++)c=this.buildMeasure(d),e=b,a=this.metaMap.getEventsAt(e),f=a.timeSig.beats*this.innerTicks*4/a.timeSig.beatType},buildMeasure:function(a){var b,c,d,e=!0;if(c=this.midiPart.getBar(a)){for(d=c.getChordsByVoices(),b=0;b<d.length;b++)d[b]&&d[b].length>0?(this.selectedVoice=b,this.buildVoice(d[b],a,c.timeStart,c.timeEnd)):this.addRest(c.timeEnd-c.timeStart);0===b&&this.addRest(c.timeEnd-c.timeStart),e=!1}return e},buildVoice:function(a,b,c,d){var e,f,g=c;for(f=0;f<a.length;f++)a[f].timeOn>g&&(f>0&&a[f-1].inTuplet?(e=a[f-1],a[f].inTuplet&&a[f].tupletInfo===a[f-1].tupletInfo?this.addRest(a[f].timeOn-g,a[f].tupletInfo):e.tupletInfo.timeOff>e.timeOff&&(this.addRest(e.tupletInfo.timeOff-e.timeOff,e.tupletInfo),a[f].timeOn>e.tupletInfo.timeOff&&this.addRest(a[f].timeOn-e.tupletInfo.timeOff))):this.addRest(a[f].timeOn-g)),g=a[f].timeOff,a[f].inTuplet&&a[f].tupletHead?this.buildTuplet(a[f]):a[f].timeOff>a[f].timeOn&&this.buildChord(a[f]);g<d&&this.addRest(d-g)},addRest:function(a,d){var e,f,g=a/this.innerTicks;d&&(e=c.create(d.ratio.num,d.ratio.den),g=b.actualToNormal(g,e)),f=this.getDurationArray(g);for(var h=0;h<f.length;h++)f[h].isRest=!0,this.dataStaff.notes.push(f[h])},buildTuplet:function(a){var d,e,f=a.timeOff-a.timeOn,g=f/this.innerTicks,h=a.tupletInfo,i=h.len.toTicks(this.innerTicks),j=i/this.innerTicks,k=j/h.ratio.den,l=b.quarterToDurationOpts(k),m=c.create(h.ratio.num,h.ratio.den);g=b.actualToNormal(g,m),e=b.quarterToDurationOpts(g),d={tuplet:{durationType:l.durationType,timeModif:m},durationType:e.durationType,nbDots:e.nbDots,heads:[]},this.drumPart?this.buildNotesDrums(a.notes,d):this.buildNotes(a.notes,d)},buildChord:function(a){var d,e,f,g,h,i=a.timeOff-a.timeOn,j=i/this.innerTicks,k=[a],l=a.tupletInfo;for(a.inTuplet&&(e=c.create(l.ratio.num,l.ratio.den),j=b.actualToNormal(j,e)),this.isImpossibleDuration(j)&&(k=this.computeSubChords(a,e)),d=0;d<k.length;d++)h=!1,a=k[d],i=a.timeOff-a.timeOn,j=i/this.innerTicks,a.inTuplet&&(j=b.actualToNormal(j,e)),g=b.quarterToDurationOpts(j),d<k.length-1&&(h=!0),f={durationType:g.durationType,nbDots:g.nbDots,heads:[],tie:h},this.drumPart?this.buildNotesDrums(a.notes,f):this.buildNotes(a.notes,f)},buildNotes:function(a,b){var c,d,e=this.dataStaff.notes.length;for(c=0;c<a.length;c++)d=a[c].finalNoteName,b.heads.push({pitch:d}),(b.tie||a[c].hasTieStart())&&this.dataStaff.ties.push({step:d.step,octave:d.octave,alter:d.alter,noteIdx:e});delete b.tie,this.dataStaff.notes.push(b)},buildNotesDrums:function(b,c){var d,e;for(d=0;d<b.length;d++)e=a.MIDIToPercu(b[d].pitch),c.heads.push(e);this.dataStaff.notes.push(c)},getDurationArray:function(a){for(var c,d=[],e=a;e>0;)c=e>4?4:b.extractBaseDuration(e),e-=c,c=b.quarterToDurationOpts(c),d.push(c);return d},computeSubChords:function(a,c){var d,e,f=a.copy(),g=[],h=f.timeOff-f.timeOn,i=h/this.innerTicks;for(a.inTuplet&&(i=b.actualToNormal(i,c));i>0;)e=i>4?4:b.extractBaseDuration(i),e!==i?(a.inTuplet?(d=f.cutNotesAtLength(b.normalToActual(e,c)*this.innerTicks),d.setTuplet(a.tupletInfo)):d=f.cutNotesAtLength(e*this.innerTicks),g.push(f),f=d):g.push(f),i-=e;return g},isImpossibleDuration:function(c){var d;if(c>4)return!0;for(;c>.0625;){if(d=b.extractSmallestBaseDuration(c),0===(c-=d))return!1;if(!a.epsEqu(c/2,d))return!0}return!1},createDefaultAttributes:function(){return{transpose:{chromatic:"0"},staffDetails:{"staff-lines":5}}},getMetaAt:function(a){return this.metaMap[a]},setMetaMap:function(a){this.metaMap=new Dacapo.MetaPart(a,this.innerTicks)},setHumanDelay:function(a){this.humanDelayBase=a,this.midiPart&&this.midiPart.setHumanDelay(a)}}}.call(this),function(){"use strict";Dacapo.MIDI=function(a){this.MIDI=null,this.inputDevices=[],this.outputDevices=[],this.selectedInput=null,this.selectedOuput=null,this.midiInput=new Dacapo.InputMIDI,this.midiOutput=new Dacapo.OutputMIDI(this.handleSend.bind(this),this.clearScheduled.bind(this)),this.metaMap={},this.lengthStack=[],"undefined"!=typeof window&&this.initFocusControl(),this.updateCallback=a},Dacapo.MIDI.prototype={init:function(a){if(this.isWebMIDICompliant())throw new Dacapo.Error.CompatibilityError("MIDI API is not supported in your browser");navigator.requestMIDIAccess().then(function(b){if(this.MIDI=b,this.MIDI.onstatechange=this.updateDevices.bind(this),this.MIDI.inputs&&this.MIDI.inputs.size>0){var c,d,e=this.MIDI.inputs.values(),f=this.MIDI.outputs.values();for(c=e.next();c&&!c.done;c=e.next())this.inputDevices.push(c.value);for(d=f.next();d&&!d.done;d=f.next())this.outputDevices.push(d.value)}a&&a()}.bind(this)).catch(function(a){console.log("You can't get an access to the MIDI API",a)})},isWebMIDICompliant:function(){return"function"!=typeof navigator.requestMIDIAccess},initFocusControl:function(){this.focused=!0,window.onfocus=function(){this.focused=!0}.bind(this),window.onblur=function(){this.focused=!1}.bind(this)},updateDevices:function(a){var b=a.port.state;"connected"===b?this.connectDevice(a.port):"disconnected"===b&&this.disconnectDevice(a.port),this.updateCallback&&this.updateCallback()},connectDevice:function(a){var b=a.constructor.name.substr(4),c=this[b.toLowerCase()+"Devices"];this["isIn"+b+"DevicesList"](a)||c.push(a)},disconnectDevice:function(a){var b,c=a.constructor.name.substr(4),d=this[c.toLowerCase()+"Devices"];for(b=0;b<d.length;b++)if(d[b].id===a.id){d.splice(b,1);break}this["selected"+c]=null},selectInputDevice:function(a){var b;null!==this.selectedInput&&(this.selectedInput.onmidimessage=null),b=this.inputDevices[a],this.selectedInput=b,this.selectedInput.onmidimessage=function(a){(this.focused||this.midiInput.recording)&&this.midiInput.handleMIDIMessage(a)}.bind(this)},selectOutputDevice:function(a){var b;b=this.outputDevices[a],this.selectedOutput=b},handleSend:function(a,b){this.selectedOutput&&(b=b||0,this.selectedOutput.send(a,b))},clearScheduled:function(){this.selectedOutput&&this.selectedOutput.clear()},unselectInputDevice:function(){null!==this.selectedInput&&(this.selectedInput.onmidimessage=null,this.selectedInput=null)},unselectOutputDevice:function(){null!==this.selectedOutput&&(this.selectedOutput=null)},isInInputDevicesList:function(a){for(var b=0;b<this.inputDevices.length;b++)if(this.inputDevices[b].id===a.id)return!0;return!1},isInOutputDevicesList:function(a){for(var b=0;b<this.outputDevices.length;b++)if(this.outputDevices[b].id===a.id)return!0;return!1},getInputs:function(){return this.inputDevices},getOutputs:function(){return this.outputDevices},hasInputs:function(){return this.inputDevices.length>0},getMidiInput:function(){return this.midiInput},getMidiOutput:function(){return this.midiOutput},hasOutputs:function(){return this.outputDevices.length>0},disconnectAllInputDevices:function(){for(var a=0;a<this.inputDevices.length;a++)this.disconnectDevice(this.inputDevices[a])},disconnectAllOutputDevices:function(){for(var a=0;a<this.outputDevices.length;a++)this.disconnectDevice(this.outputDevices[a])},disconnectAllDevices:function(){this.disconnectAllInputDevices(),this.disconnectAllOutputDevices()},destroy:function(){this.disconnectAllDevices(),this.midiInput&&(this.midiInput.stopRecording(),this.midiInput.insertNotesAtCursor=null,this.midiInput.insertCallback=null,this.midiInput.cursorCallback=null,this.midiInput.tempoCallback=null)}}}.call(this),function(){"use strict";Dacapo.InputMIDI=function(a){this.manager=a,this.divisions=240,this.minDivisions=15,this.minRestDuration=.5,this.quantizer=new Dacapo.Quantizer,this.quantizer.setTicksPerQuarterNote(this.divisions),this.playingNotes={},this.playingNotesNum=0,this.waitingNotes=[],this.thresholdLimit=.04,this.fudgeTime=.01,this.threshExt=.02,this.thresholdStart=0,this.threshExtUsed=!1,this.chordLeader=null,this.humanDelayBase=.02,this.mappings={"Maschine Mikro MK2 In":{note:{offset:0},controller:{108:"play",109:"record",104:"restart"}},UMA25S:{note:{offset:0},controller:{22:"restart",25:"stop",26:"pause",27:"play",28:"record"}}},this.activeNotation=!0,this.recording=!1,this.calibrating=!1,this.timerID=null,this.tempo=Dacapo.qpm,this.unitDuration=Dacapo.unitDuration,this.measureStartTime=0,this.quarterNotePerMeasure=4,this.startRecordTime=0,this.transposition=0,this.lastEventTime=0,this.qLastEventTime=0,this.firstChordNote={},this.delay=0,this.currentNotePos={measureIdx:0,quarterPos:0},this.metaMap=[],this.postProcessor=new Dacapo.PostProcessor(this.metaMap),this.lengthStack=[],this.eventStack=[],this.cbValidate=null,this.calibrationNote=0},Dacapo.InputMIDI.prototype={init:function(a,b,c,d,e){this.setInstrumentManager(a),this.insertNotesAtCursor=b,this.insertCallback=c,this.cursorCallback=d,this.tempoCallback=e},handleMIDIMessage:function(a){var b=Dacapo.context.currentTime;if(3===a.data.length){var c,d,e,f,g,h=Dacapo.MIDIUtils.MIDICommands[a.data[0]];this.recording&&(this.firstNote||(this.firstNote=!0,this.startRecordTime=b),this.saveLiveEvent(b,a.data[0],a.data[1],a.data[2])),"noteOn"===h||"noteOff"===h?(c=this.getMappedMIDIPitch(a.data[1]),d=a.data[2]):(e=a.data[1],f=a.data[2]),"noteOn"===h?d>0?this.startNote(c,d):this.stopNote(c):"noteOff"===h?this.stopNote(c):"continuousController"===h&&this.selectedInput&&this.mappings[this.selectedInput.name]&&(g=this.mappings[this.selectedInput.name].controller[e],"play"===g?127===f?this.manager.transport.start():this.manager.transport.pause():"record"===g?127===f?this.startRecording():this.stopRecording():"restart"===g&&this.manager.transport.restart()),this.calibrating&&this.cbValidate&&("noteOn"!==h&&"noteOff"!==h||!("noteOn"===h&&d>0||this.calibrationNote)||this.saveLiveEvent(b,h,c,d),"noteOn"===h&&d>0&&(this.calibrationNote||(this.calibrationNote=c),this.calibrationNote===c&&this.cbValidate()))}},saveLiveEvent:function(a,b,c,d){this.noteLiveStack.push({time:a,type:b,data1:c,data2:d})},isChordNote:function(a){var b=!1,c=0;return 0===this.playingNotesNum?(this.thresholdStart=a,this.threshExtUsed=!1):this.threshExtUsed?(c=a-this.thresholdStart,c<this.thresholdLimit+this.threshExt?b=!0:(this.thresholdStart=a,this.threshExtUsed=!1)):(c=a-this.thresholdStart,c<this.thresholdLimit?(b=!0,this.chordLeader.inChord=!0,c>this.thresholdLimit-this.fudgeTime&&(this.threshExtUsed=!0)):this.thresholdStart=a),b},isSignificant:function(a){return a>=this.minRestDuration},startNote:function(a,b){var c,d=Dacapo.context.currentTime;this.playNote(a,c,d,0,b),this.activeNotation&&(c=this.isChordNote(d),c||(this.chordLeader=this.playingNotes[a]),this.recording&&(this.lastEventTime=d,this.qLastEventTime=0))},playNote:function(a,b,c,d,e){this.manager&&(e=Dacapo.Utils.velocityToVolume(e),this.manager.playSelectedInstrument(a,e),this.playingNotes[a]={pitch:a,inChord:b,startTime:c,qStartTime:d,measureStart:this.currentNotePos.measureIdx,quarterPos:this.currentNotePos.quarterPos},this.playingNotesNum++)},stopNote:function(a){var b,c,d,e=Dacapo.context.currentTime,f=this.playingNotes[a];f&&(this.playingNotesNum--,delete this.playingNotes[a],this.manager.stopSelectedInstrument(a),this.activeNotation&&(b=e-f.startTime,c=b+this.delay+.04,this.calibrating||(this.recording||this.calibrating||this.updateTempoAtCursorPos(),this.recording||this.calibrating||!this.cursorCallback||(d=this.cursorCallback()),this.waitingNotes.push(f),this.playingNotesNum>0?this.timer||"undefined"!=typeof require||(this.timerID=Dacapo.WorkerTimer.setTimeout(function(){this.timerID=null,this.insertNotes(this.waitingNotes,d),this.saveLength(b,c,void 0),this.recording&&(this.lastEventTime=e,this.qLastEventTime=f.qStartTime+d*this.unitDuration)}.bind(this),40)):(this.timerID&&(Dacapo.WorkerTimer.clearTimeout(this.timerID),this.timerID=null),this.insertNotes(this.waitingNotes,d),this.saveLength(b,c,void 0),this.recording&&(this.lastEventTime=e,this.qLastEventTime=f.qStartTime+d*this.unitDuration)))))},guessDuration:function(a,b){var c,d,e,f,g={prob:0};for(e=a/this.unitDuration*this.divisions,b/this.unitDuration*this.divisions,f=this.getEligibleDurations(e),this.editProbaWithHistory(e,f),d=this.getRemainingTimeInMeasure(),this.trimOrExpandIfNecessary(d,f),c=0;c<f.length;c++)f[c].prob>=g.prob&&(g=f[c]);return g.duration},editProbaWithHistory:function(a,b){var c,d,e,f,g=.25,h=b.length;for(c=this.lengthStack.length-1,f=c-10;c>=0&&c>=f&&h>0;){for(e=this.lengthStack[c].qDelta,d=0;d<b.length;d++)if(void 0===b[d].history&&b[d].duration===e){b[d].prob+=g,b[d].history=c,h--;break}c===this.lengthStack.length-1&&(g*=.5),c--}},getEligibleDurations:function(a){var b,c,d=[],e=[],f=new Dacapo.Fraction(1,8),g=1,h=0;for(g=a<=240?4:a<=480?3:2;g>e.length&&f.value()>this.quantizer.minAllowedDuration.value();)b=this.quantizer.quantizeWithQuant(a,f),c=Math.abs(b-a),-1===d.indexOf(b)&&(e.push({delta:c,duration:b}),d.push(b),h+=c),f.div(2);if(e.length>1)for(var i=0;i<e.length;i++)e[i].prob=1-e[i].delta/h;else e[0].prob=1;return e},trimOrExpandIfNecessary:function(a,b){var c,d;for(c=0;c<b.length;c++)d=Math.abs(b[c].duration-a),b[c].duration<this.minDivisions&&(b[c].duration=this.minDivisions),d<=.5?b[c].prob+=1.51:d<1&&void 0!==b[c].history?b[c].prob+=.5:d<1&&(b[c].prob+=.1)},getRemainingTimeInMeasure:function(){var a,b;return this.recording||(a=this.cursorCallback(),b=a*this.divisions),b},insertChord:function(a){this.insertNotes(this.waitingNotes,a)},insertRest:function(a){this.insertCallback({quarterDuration:a,pitches:[]},this.currentNotePos.measureIdx,Number(this.currentNotePos.quarterPos.toFixed(4))),this.updateCurrentPosition(a)},collectPitches:function(a){var b=[],c=0;c=this.getInstrumentTranspo();for(var d=0;d<a.length;d++)try{b[d]=Dacapo.Utils.MIDIToNoteName(a[d].pitch-c),b[d].alter=Adagio.Utils.pitchUtils.alterToAccidental(b[d].alter)}catch(c){b.splice(d,1),a.splice(d--,1)}return b},insertNotes:function(a,b){var c,d,e,f={};a.length>0&&(c=a[0].measureStart,d=a[0].quarterPos,e=a[0].qStartTime,a=this.collectPitches(a),f={quarterDuration:b,pitches:a},this.recording&&this.insertCallback?(this.insertCallback(f,c,Number(d.toFixed(4))),this.updateCurrentPosition(b+(e-this.qLastEventTime)/this.unitDuration)):this.insertNotesAtCursor&&this.insertNotesAtCursor(f),this.waitingNotes=[])},saveLength:function(a,b,c){this.lengthStack.push({realLength:a,delta:b,qDelta:c,errorDelta:Math.abs(c-b),error:Math.abs(c-a)})},updateCurrentPosition:function(a){var b=this.currentNotePos.quarterPos+a,c=Dacapo.context.currentTime-this.startMeasureTime,d=c/this.unitDuration;if(b>=this.quarterNotePerMeasure)for(;b>=this.quarterNotePerMeasure;)b-=this.quarterNotePerMeasure,d-=this.quarterNotePerMeasure,this.startMeasureTime+=this.quarterNotePerMeasure*this.unitDuration,this.currentNotePos.measureIdx++,this.updateTimeSignature(this.currentNotePos.measureIdx);this.currentNotePos.quarterPos=Number(b.toFixed(4)),this.findDelay(d)},updateTimeSignature:function(a){void 0!==this.metaMap[a]&&(this.quarterNotePerMeasure=this.metaMap[a].beats*(4/this.metaMap[a].beatType),this.tempo=this.metaMap[a].tempo,this.unitDuration=60/this.tempo,this.timePerMeasure=this.quarterNotePerMeasure*this.unitDuration)},updateTempoAtCursorPos:function(){this.tempoCallback&&(this.tempo=this.tempoCallback(),this.unitDuration=60/this.tempo)},findDelay:function(a){this.delay=this.unitDuration*(a-this.currentNotePos.quarterPos)},getMappedMIDIPitch:function(a){var b=0;return this.selectedInput&&this.mappings[this.selectedInput.name]&&(b=this.mappings[this.selectedInput.name].note.offset),a+b},getInstrumentTranspo:function(){var a;return a=this.manager.getSelectedIndex(),this.manager.getInstrumentTranspo(a)||0},startRecording:function(a,b){a=a||0,void 0===b&&(b=!1),this.recording||(this.delay=0,this.firstNote=!1,this.noteLiveStack=[],this.postProcessor=new Dacapo.PostProcessor(this.metaMap),this.postProcessor.setHumanDelay(this.humanDelayBase),this.recording=!0,this.currentNotePos={measureIdx:0,quarterPos:0},this.tempo=Dacapo.qpm,this.unitDuration=Dacapo.unitDuration,this.quarterNotePerMeasure=Dacapo.timeSignature.beats*(4/Dacapo.timeSignature.beatType),this.timePerMeasure=this.quarterNotePerMeasure*this.unitDuration,this.startRecordTime=a,this.lastEventTime=this.startRecordTime,this.qLastEventTime=this.lastEventTime,this.startMeasureTime=this.startRecordTime)},setEndMeasureTimer:function(){return Dacapo.WorkerTimer.setTimeout(function(){this.postProcessing(this.startMeasureTime,this.startMeasureTime+this.timePerMeasure),this.startMeasureTime+=this.timePerMeasure,this.updateTimeSignature()}.bind(this),1e3*this.timePerMeasure)},setMetaMap:function(a){this.metaMap=a,this.postProcessor.setMetaMap(a)},setInstrumentManager:function(a){this.manager=a},stopRecording:function(a,b){var c,d;if(this.recording)return this.recording=!1,d={startRecord:this.startRecordTime,events:this.noteLiveStack,humanDelay:this.humanDelayBase,tempo:this.tempo},"undefined"==typeof require&&(Dacapo.WorkerTimer.clearTimeout(this.timerID),Dacapo.WorkerTimer.clearTimeout(this.nextMeasureTimer)),Number.isFinite(a)||(a=this.startRecordTime),c=this.postProcessor.processPart(a,this.noteLiveStack),this.updateCallback&&this.updateCallback(),void 0!==b&&b(c,d),c},getStartRecordTime:function(){return this.startRecordTime},startCalibration:function(a,b){var c={sequences:1/0,clicks:4,quarterDuration:a};this.recording||this.calibrating||(this.calibrating=!0,this.calibrationNote=0,this.cbValidate=b,this.noteLiveStack=[],this.manager.transport.scheduleMetronomeSequence(c,Dacapo.context.currentTime+.1))},analyzeCalibration:function(a,b){var c,d,e,f,g,h,i,j,k,l=0,m=0,n=[],o=0,p=null,q={events:this.noteLiveStack};if(this.noteLiveStack.length<=0)return b({message:"The note sequence is empty! Please try again"});for(k=.5-a.tempo/1e3,j=this.noteLiveStack[0].time,c=0;c<this.noteLiveStack.length;c++){if(g=this.noteLiveStack[c],p&&"noteOn"===g.type&&g.data2>0){if(f=g.time-p.time,Math.abs(j-g.time)>k)return b({message:"The note "+o+" is off beat"});if((o=c/2>>0)>=1&&o<=a.length){if((i=g.time-h)<a[o-1].duration-k)return b({message:"The note "+o+" is too short"});if(i>a[o-1].duration+k/4)return b({message:"The note "+o+" is too long"})}if(f>k)return b({message:"The time between note "+o+" and note "+(o+1)+" is too long"});h=g.time,n.push(f),l+=f,m++,j+=a[o-1].duration}p=g}d=Math.ceil(n.length/2),e=n.sort()[d],l/=m,this.setHumanDelay(e),b(null,e,q)},stopCalibration:function(a,b){this.calibrating&&(this.calibrating=!1,this.manager.transport.stopMetronomeSequence(),this.analyzeCalibration(a,b))},setHumanDelay:function(a){this.humanDelayBase=a,this.postProcessor&&this.postProcessor.setHumanDelay(a)},enableNotation:function(){this.activeNotation=!0},disableNotation:function(){this.activeNotation=!1}}}.call(this),function(){"use strict";Dacapo.OutputMIDI=function(a,b){this.playingNotes={},this.MIDICommands={noteOff:128,noteOn:144,afterTouch:160,continuousController:176,patchChange:192,channelPressure:208,pitchBend:224,nonMusicalCommand:240},this.send=a,this.clear=b},Dacapo.OutputMIDI.prototype.createChannelEvent=function(a,b,c,d){var e=[];return d=127*d>>0,d=d>127?127:d,this.MIDICommands[a]&&c<16&&d<128&&b<128&&(e[0]=this.MIDICommands[a]|c,e[1]=b,e[2]=d),e},Dacapo.OutputMIDI.prototype.getNoteName=function(a){if("number"==typeof a){if(a>128&&(a=Dacapo.Utils.MapUnpitched[a]||129),a>128||a<0)throw new Error("Note out of range")}else this.drumSet&&Adagio.Utils.partHeaderUtils.hasInstrumentId(this.headerInstrument,a)&&(a=Number(Adagio.Utils.partHeaderUtils.searchInstrumentMIDIUnpitched(this.headerInstrument,a))-1)>128&&(a=Dacapo.Utils.MapUnpitched[a]);if(this.sfBuffer&&!this.sfBuffer.hasNote(a))throw new Error("Note does not exists");return a},Dacapo.OutputMIDI.prototype.playNote=function(a,b){var c,d,e,f;if(!(b>15)){try{a.note=this.getNoteName(a.pitch)}catch(a){return}a.duration=a.duration||0,a.velocity=a.velocity||.8,e=window.performance.now(),f=e+1e3*a.duration,c=this.createChannelEvent("noteOn",a.note,b,a.velocity),d=this.createChannelEvent("noteOff",a.note,b,0),this.addNoteInStack(a.note,b,e,f),this.send(c),a.duration&&isFinite(a.duration)&&a.duration>0&&(this.send(d,f),this.setNodeKilling(b,a,a.duration))}},Dacapo.OutputMIDI.prototype.scheduleNote=function(a,b,c){var d,e,f,g,h;try{a.note=this.getNoteName(a.pitch)}catch(a){return}a.duration=a.duration||0,a.velocity=a.velocity||.8,g=b-Dacapo.context.currentTime,b=1e3*g+window.performance.now(),h=b+1e3*a.duration,a.origDuration*=1e3,e=this.createChannelEvent("noteOn",a.note,c,a.velocity),f=this.createChannelEvent("noteOff",a.note,c,0),this.send(e,b),a.duration&&isFinite(a.duration)&&a.duration>0&&(this.send(f,h),d=this.setNodeKilling(c,a,g+a.duration)),this.addNoteInStack(a.note,c,{startTime:b,stopTime:h,origDuration:a.origDuration,timer:d})},Dacapo.OutputMIDI.prototype.setNodeKilling=function(a,b,c){return Dacapo.WorkerTimer.setTimeout(function(){this.playingNotes[a]&&this.playingNotes[a][b.note]&&this.playingNotes[a][b.note].shift()}.bind(this),1e3*c)},Dacapo.OutputMIDI.prototype.addNoteInStack=function(a,b,c){void 0===this.playingNotes[b]&&(this.playingNotes[b]={}),void 0===this.playingNotes[b][a]&&(this.playingNotes[b][a]=[]),this.playingNotes[b][a].push(c)},Dacapo.OutputMIDI.prototype.stopNote=function(a,b){for(var c,d;this.playingNotes[b]&&this.playingNotes[b][a].length>0;)(c=this.playingNotes[b][a].shift())&&(d=this.createChannelEvent("noteOff",a,b,0),this.send(d,c.startTime))},Dacapo.OutputMIDI.prototype.stopNotesFromChannel=function(a,b){var c;if(this.playingNotes[a])for(c in this.playingNotes[a])this.playingNotes[a].hasOwnProperty(c)&&(this.stopNote(c,a,b),delete this.playingNotes[a][c])},Dacapo.OutputMIDI.prototype.stopNotes=function(){var a;for(a in this.playingNotes)this.playingNotes.hasOwnProperty(a)&&this.stopNotesFromChannel(a);this.playingNotes={}},Dacapo.OutputMIDI.prototype.stopPedalForNote=function(a,b,c){for(var d,e;this.playingNotes[b]&&this.playingNotes[b][a].length>0;)if(d=this.playingNotes[b][a].shift())if(c>d.startTime&&d.startTime+d.origDuration<c)Dacapo.WorkerTimer.clearTimeout(d.timer),e=this.createChannelEvent("noteOff",a,b,0),this.send(e,c);else if(c>d.startTime&&d.startTime+d.origDuration>c)return Dacapo.WorkerTimer.clearTimeout(d.timer),d.stopTime=d.startTime+d.origDuration,e=this.createChannelEvent("noteOff",a,b,0),this.send(e,d.stopTime),void this.playingNotes[b][a].push(d);return!0},Dacapo.OutputMIDI.prototype.stopPedalForChannel=function(a,b){var c,d;if(d=b-Dacapo.context.currentTime,b=1e3*d+window.performance.now(),this.playingNotes[a])for(c in this.playingNotes[a])this.playingNotes[a].hasOwnProperty(c)&&this.stopPedalForNote(c,a,b)&&delete this.playingNotes[a][c]}}.call(this),"undefined"!=typeof module&&module.exports&&(module.exports=Dacapo);
//# sourceMappingURL=dacapo.min.js.map