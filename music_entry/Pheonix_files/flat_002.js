/*!
 * Copyright (c) 2017 Flat - Tutteo Ltd. <hello@flat.io>
 * https://flat.io
 */

!function(){"use strict";function a(){function a(a,e){function f(a){return"string"==typeof a&&(a=new Error(a),a.name="SQLError"),a.type="flat",a.action="open_indexeddb",a}function g(){v=new Dexie(u.name),d.call(b,v)}function h(){v.open().then(function(){e.debug("FlatDexie :: database is open")}).catch(function(a){e.debug(f(a),{logger:"offline"})})}function i(){return a(function(a,b){!v||v.hasFailed()?b(v||new Error("FlatDexie: Dexie or IndexedDB not available")):a(v)})}function j(){return c}function k(b,c){return a(function(a,d){i().then(function(e){e.table(b).get(c).then(a).catch(d)}).catch(d)})}function l(b){return a(function(a,c){i().then(function(d){d.table(b).toArray().then(a).catch(c)}).catch(c)})}function m(b,c,d){return a(function(a,e){i().then(function(f){f.table(b).where(c).equals(d).toArray().then(function(b){angular.isArray(b)&&b.length>0?a(b[0]):e(b)}).catch(e)}).catch(e)})}function n(b,c,d){return a(function(a,e){i().then(function(f){f.table(b).where(c).equals(d).toArray().then(a).catch(e)}).catch(e)})}function o(b,c){return a(function(a,d){i().then(function(e){e.table(b).put(s(c)).then(a).catch(d)}).catch(d)})}function p(b,c){return a(function(d,e){var f=[],g=_.map(c,function(a){o(b,a).then(function(a){f.push(a)})});a.all(g).then(function(){d(c)}).catch(function(){e(f)})})}function q(b,c){return a(function(a,d){i().then(function(e){e.table(b).delete(c).then(a).catch(d)}).catch(d)})}function r(b){return a(function(a,c){i().then(function(d){d.table(b).clear().then(a).catch(c)}).catch(c)})}function s(a){var b=Dexie.deepClone(angular.fromJson(angular.toJson(a)));return angular.isDefined(b.$$hashKey)&&delete b.$$hashKey,b}e.debug("FlatDexie :: init");var t={getDb:i,getOptions:j,get:k,getByIndex:m,list:l,listByIndex:n,put:o,putBatch:p,remove:q,clear:r},u=j(),v=null;return"undefined"==typeof Dexie?t:(g(),v.open().then(function(a){a.close(),h()}).catch(function(a){"VersionError"===a.name?v.delete().then(function(){g(),v.open().then(function(a){a.close(),h()}).catch(function(a){e.error(f(a),{logger:"offline"})})}).catch(function(a){e.error(f(a),{logger:"offline"})}):e.debug(f(a),{logger:"offline"})}),v.on("blocked",function(){e.warn("database seems to be blocked")}),t)}var b=this,c={name:"",debug:!1},d=function(){console.error("FlatDexie :: No configuration hook has been set!")};b.setOptions=function(a){c=angular.extend({},c,a)},b.setConfiguration=function(a){d=a},b.$get=a,a.$inject=["$q","$log"]}angular.module("flatdexie",[]).provider("flatDexie",a)}(),function(){"use strict";function a(a,b){function c(c,d){b.debug&&a.debug(c,d)}function d(c,d){b.debug&&a.info(c,d)}function e(c,d){b.debug&&a.warn(c,{extra:d,logger:"offline"})}function f(b,c){a.error(b,{extra:c,logger:"offline"})}return{debug:c,info:d,warn:e,error:f}}function b(a,b,c,d,e,f,g){function h(){b.getDb().then(function(b){b.delete().then(function(){a.info("[PersistenceService] CLEAR: Everything has been deleted from indexedDB","")}).catch(function(){a.warn("[PersistenceService] CLEAR: Error while clearing indexedDB","")})})}return a.info("[PersistenceService] Intialize"),{buffer:c,scores:d,scoreComments:e,scoreRevisions:f,scoreRevisionsData:g,clear:h}}function c(a,b,c){function d(a,b,c,d){return b&&"cacheOnly"===b.strategy?g(a,b,d):b&&"cacheFirst"===b.strategy?h(a,b,c,d):b&&"networkFirst"===b.strategy?f(a,b,c,d):e(a,b,c)}function e(a,b,c){return c(a,b)}function f(d,e,f,g){return a(function(a,h){f(d,e).then(function(d){e.broadcastUpdate===!0&&e.broadcastMsg.length&&(c.debug("[RequestStrategies] BROADCAST: "+e.broadcastMsg,d),b.$broadcast(e.broadcastMsg,d)),a(d)}).catch(function(f){g(d,e).then(function(d){e.broadcastUpdate===!0&&e.broadcastMsg.length&&(c.debug("[RequestStrategies] BROADCAST: "+e.broadcastMsg,d),b.$broadcast(e.broadcastMsg,d)),a(d)}).catch(function(){h(f)})})})}function g(a,b,c){return c(a,b)}function h(d,e,f,g){var h=a.defer();return g(d,e).then(h.resolve).finally(function(){(1!==h.promise.$$state.status||1===h.promise.$$state.status&&e.update!==!1)&&f(d,e).then(function(a){1===h.promise.$$state.status?e.broadcastUpdate===!0&&e.broadcastMsg.length&&(c.debug("[RequestStrategies] BROADCAST: "+e.broadcastMsg,a),b.$broadcast(e.broadcastMsg,a)):h.resolve(a)}).catch(function(a){1!==h.promise.$$state.status&&h.reject(a)})}),h.promise}return{resolve:d}}angular.module("flat.indexedDB",["flatdexie","ngLodash"]),angular.module("flat.indexedDB").constant("DATABASE",{name:"flat",version:1,debug:!1,stores:{buffer:"buffer",scores:"scores",scoreComments:"scoreComments",scoreRevisions:"scoreRevisions",scoreRevisionsData:"scoreRevisionsData"}}),angular.module("flat.indexedDB").config(["flatDexieProvider","DATABASE",function(a,b){a.setOptions({name:b.name,debug:!1}),a.setConfiguration(function(a){a.version(1).stores({buffer:"++_id",scores:"&id",scoreRevisions:"&id,score",scoreRevisionsData:"&_revisionId, _scoreId",scoreComments:"&id,score,replyTo"})})}]),angular.module("flat.indexedDB").factory("IDBLogger",a).factory("PersistenceService",b).factory("RequestStrategies",c),a.$inject=["$log","DATABASE"],b.$inject=["IDBLogger","flatDexie","buffer","scores","scoreComments","scoreRevisions","scoreRevisionsData"],c.$inject=["$q","$rootScope","IDBLogger"]}(),function(){"use strict";function a(a,b,c){function d(){return c.list(b.stores.buffer)}function e(a){return c.put(b.stores.buffer,a)}function f(){return c.clear(b.stores.buffer)}return{query:d,put:e,clear:f}}angular.module("flat.indexedDB").factory("buffer",a),a.$inject=["$q","DATABASE","flatDexie"]}(),function(){"use strict";function a(a,b,c,d){function e(a){return d.listByIndex(c.stores.scoreComments,"score",a)}function f(a){return b(function(b,e){d.getDb().then(function(d){d.table(c.stores.scoreComments).where("replyTo").equals(a).toArray().then(b).catch(e)}).catch(e)})}function g(a){return d.put(c.stores.scoreComments,a)}function h(a){return d.putBatch(c.stores.scoreComments,a)}function i(e){return b(function(g,h){var j=[];f(e).then(function(f){b.all(a.map(f,function(a){return i(a.id).then(function(a){j=j.concat(a)})})).then(function(){d.remove(c.stores.scoreComments,e).then(function(){j.push(e),g(j)}).catch(h)}).catch(h)}).catch(h)})}function j(c){return b(function(d,f){e(c).then(function(c){b.all(a.map(c,function(a){return i(a.id)})).then(function(){d(c)}).catch(f)}).catch(f)})}function k(){return d.clear(c.stores.scoreComments)}return{query:e,getReplies:f,put:g,putBatch:h,remove:i,removeForScore:j,clear:k}}angular.module("flat.indexedDB").factory("scoreComments",a),a.$inject=["_","$q","DATABASE","flatDexie"]}(),function(){"use strict";function a(a,b,c,d){function e(a){return d.listByIndex(c.stores.scoreRevisions,"score",a)}function f(a){return d.get(c.stores.scoreRevisions,a)}function g(a){return d.put(c.stores.scoreRevisions,a)}function h(a){return d.putBatch(c.stores.scoreRevisions,a)}function i(a){return d.remove(c.stores.scoreRevisions,a)}function j(c){return b(function(d,f){e(c).then(function(c){b.all(a.map(c,function(a){return i(a.id)})).then(function(){d(c)}).catch(f)}).catch(f)})}function k(){return d.clear(c.stores.scoreRevisions)}return{query:e,get:f,put:g,putBatch:h,remove:i,removeForScore:j,clear:k}}angular.module("flat.indexedDB").factory("scoreRevisions",a),a.$inject=["_","$q","DATABASE","flatDexie"]}(),function(){"use strict";function a(a,b,c,d){function e(a){return d.listByIndex(c.stores.scoreRevisionsData,"_scoreId",a)}function f(a){return d.get(c.stores.scoreRevisionsData,a)}function g(a){return d.put(c.stores.scoreRevisionsData,a)}function h(a){return d.remove(c.stores.scoreRevisionsData,a)}function i(c){return b(function(d,f){e(c).then(function(c){b.all(a.map(c,function(a){return h(a.revisionId)})).then(function(){d(c)}).catch(f)}).catch(f)})}function j(){return d.clear(c.stores.scoreRevisionsData)}return{query:e,get:f,put:g,remove:h,removeForScore:i,clear:j}}angular.module("flat.indexedDB").factory("scoreRevisionsData",a),a.$inject=["_","$q","DATABASE","flatDexie"]}(),function(){"use strict";function a(a,b,c,d,e){function f(a){return a.sort(function(a,b){return new Date(b.modificationDate)-new Date(a.modificationDate)})}function g(){return a(function(a,d){c.list(b.stores.scores).then(function(b){a(f(b))}).catch(d)})}function h(b){return a(function(a,c){g().then(function(c){var d=[];_.each(c,function(a){return a.user&&a.user.id===b?(d.push(a),!0):void _.each(a.collaborators,function(c){if(c.user&&c.user.id===b)return d.push(a),!1})}),a(f(d))}).catch(c)})}function i(a){return c.getByIndex(b.stores.scores,"id",a)}function j(a){return c.put(b.stores.scores,a)}function k(a){return c.putBatch(b.stores.scores,a)}function l(a){return c.remove(b.stores.scores,a)}function m(b){return a.all([l(b),d.removeForScore(b),e.removeForScore(b)])}function n(){return c.clear(b.stores.scores)}return{query:g,queryByUser:h,get:i,put:j,putBatch:k,remove:l,removeDeep:m,clear:n}}angular.module("flat.indexedDB").factory("scores",a),a.$inject=["$q","DATABASE","flatDexie","scoreRevisions","scoreComments"]}();
//# sourceMappingURL=flat.indexedDB.min.js.map