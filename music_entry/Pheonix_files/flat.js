/*!
 * Copyright (c) 2017 Flat - Tutteo Ltd. <hello@flat.io>
 * https://flat.io
 */

"use strict";angular.module("flat.common",["angular-storage"]).factory("UxStore",["store",function(a){return a.getNamespacedStore("flat_ux")}]).factory("AuthStore",["store",function(a){return a.getNamespacedStore("flat_auth")}]).factory("csrfInterceptor",["AuthStore",function(a){return{request:function(b){var c=a.get("csrf_token");return c&&(b.headers["X-CSRF-Token"]=c),b}}}]).factory("Csrf",["AuthStore",function(a){var b={set:function(b){a.set("csrf_token",b)},transformResponse:function(a,c){b.set(c("x-csrf-token"));try{a=angular.fromJson(a)}catch(a){}return a}};return b}]).factory("TokenHandler",["$rootScope","$http","$cookies","AuthStore",function(a,b,c,d){var e={};return e.set=function(){d.remove("access_token")},e.get=function(){var a=c.get("flat.sid")||d.get("access_token");return a},e.get(),e}]).filter("fromNow",function(){return function(a,b){var c=moment(new Date(a));return c>moment().subtract(15,"d").toDate()?c.fromNow():c.format(b||"LLL")}}).filter("toDayTime",function(){return function(a){return moment(new Date(a)).format("LLL")}}).filter("toDay",function(){return function(a){return moment(new Date(a)).format("MMM Do")}}).filter("escapehtml",function(){return function(a){return $("<div/>").text(a).html()}}).directive("file",["$timeout",function(a){return{restrict:"E",template:'<input type="file" />',replace:!0,require:"ngModel",link:function(b,c,d,e){var f=function(){a(function(){e.$setViewValue(d.multiple?c[0].files:c[0].files[0])})};c.bind("change",f)}}}]).directive("sameAs",function(){return{require:"ngModel",link:function(a,b,c,d){d.$parsers.unshift(function(b){return b===a[c.sameAs]?(d.$setValidity("sameAs",!0),b):void d.$setValidity("sameAs",!1)})}}}).directive("atarget",function(){return{restrict:"A",scope:{atarget:"@"},link:function(a,b,c){c.atarget.length>0&&b.attr("target",c.atarget)}}}).filter("characters",function(){return function(a,b,c){if(isNaN(b))return a;if(b<=0)return"";if(a&&a.length>b){if(a=a.substring(0,b),c)for(;" "===a.charAt(a.length-1);)a=a.substr(0,a.length-1);else{var d=a.lastIndexOf(" ");d!==-1&&(a=a.substr(0,d))}return a+"â€¦"}return a}}).directive("ngRightClick",["$parse","$timeout",function(a,b){return function(c,d,e){var f=a(e.ngRightClick);d.bind("contextmenu",function(a){b(function(){a.preventDefault(),f(c,{$event:a})})})}}]).directive("focusOn",["$timeout",function(a){return{restrict:"A",link:function(b,c,d){b.$watch(d.focusOn,function(b){a(function(){b?c.focus():c.blur()})})}}}]).directive("focus",["$timeout",function(a){return{restrict:"A",scope:{focus:"@"},link:function(b,c){try{b.focus=parseInt(b.focus,10)}catch(a){b.focus=1}a(function(){c[0].focus()},b.focus)}}}]).directive("focusCta",["$timeout",function(a){return{restrict:"A",link:function(b,c){a(function(){c.focus()},1),c.bind("keydown",function(a){var b=a.keyCode||a.which;13===b&&(c.click(),a.preventDefault())})}}}]).factory("focus",["$timeout",function(a){return function(b){a(function(){var a=document.getElementById(b);a&&a.focus()})}}]).directive("includeReplace",function(){return{require:"ngInclude",link:function(a,b){b.replaceWith(b.children())}}}).directive("elastic",["$timeout",function(a){return{restrict:"A",link:function(b,c){b.initialHeight=b.initialHeight||c[0].style.height;var d=function(){c[0].style.height=b.initialHeight,c[0].style.height=""+c[0].scrollHeight+"px"};c.on("input change",d),a(d,0)}}}]).directive("errSrc",function(){return{link:function(a,b,c){b.bind("error",function(){c.src!==c.errSrc&&c.$set("src",c.errSrc)})}}}).directive("actualSrc",function(){return{link:function(a,b,c){c.$observe("actualSrc",function(a){if("undefined"!=typeof a){var d=new Image;d.src=c.actualSrc,angular.element(d).bind("load",function(){b.attr("src",c.actualSrc)})}})}}}),angular.module("flat.user",["flat.services"]).factory("UserPicture",function(){return{resize:function(a,b){return b&&a?a.indexOf("googleusercontent.com")>=0?a+="?sz="+b:a.indexOf("gravatar.com")>=0?a+="&s="+b:a:a}}}).directive("user",["$compile",function(a){return{restrict:"E",replace:!0,scope:{uid:"=",display:"@",width:"@",placement:"=",href:"@",userColor:"=",userOffline:"=",powerBadge:"@",powerBadgeBorder:"@"},templateUrl:"/views/dashboard/user/_user.html",controller:["$rootScope","$scope","$element","UserV2","UserPicture",function(a,b,c,d,e){function f(){var a=b.width||48;a<=36?b.badgeStyle={top:a-10+"px",right:"-8px"}:b.badgeStyle={top:a-20+"px",right:0},0===b.powerBadgeBorder?b.badgeClass="no-stroke":b.powerBadgeBorder>2&&(b.badgeClass="stroke-3"),b.displayPowerBadge=b.user.isPowerUser&&(b.powerBadge||"powerBadge"===b.display)}b.defaultAvatar=baseurl+"/img/avatars/default.png",b.displayPowerBadge=!1;var g=function(){"object"==typeof b.uid?(b.user=b.uid,b.picture=e.resize(b.user.picture,b.width),f()):b.uid&&b.uid.indexOf("@")>0?(b.user={picture:"https://secure.gravatar.com/avatar/"+md5(b.uid)+"?d="+encodeURIComponent(b.defaultAvatar)},b.picture=e.resize(b.user.picture,b.width),$(c).find("a").popover("destroy").find("span").unwrap()):d.get({user:b.uid}).$promise.then(function(a){b.picture=e.resize(a.picture,b.width),b.user=a,f()}).catch(function(){b.user={picture:"https://secure.gravatar.com/avatar/2d9123ca3bbfbacc384d8e390eb859c9?d="+encodeURIComponent(b.defaultAvatar)},b.picture=e.resize(b.user.picture,b.width),$(c).find("a").popover("destroy").find("span").unwrap()})};b.scoreEmbedded=a.scoreEmbedded,"undefined"==typeof b.user&&g(),b.$watch("uid",function(a,b){a!==b&&g()},!0)}],link:function(b,c,d){"none"===d.href?$(c).find("a").contents().unwrap():d.href&&($(c).find("a").attr("href","profile"===d.href?"/{{ user.username }}":d.href),a(c.contents())(b)),b.scoreEmbedded&&$(c).find("a").attr("target","_top"),$(c).addClass("user-"+d.display)}}}]),function(){function a(a,b,c,d){var e=document.createElement("a");e.href=pushapibaseurl,this.socket=null,this.init=function(){if(this.socket)return!0;this.socket=io.connect(e.protocol+"//"+e.host+"/?access_token="+encodeURIComponent(d.get()),{resource:"push"}),this.socket.on("connect",function(){c.offline=!1,b(angular.noop)});var f=function(){c.offline=!0,b(angular.noop)};this.socket.on("disconnect",f),this.socket.on("connect_error",f),this.socket.on("push",function(d){var e=d.payload;if("ObjectUpdate"===d.type){if(!e.object||!e.object.id)return a.warn("[push] got push without data",{extra:{payload:e}}),!1;a.debug("[push] update of object %s (id = %s)",e.type,e.object.id),c.$broadcast("ObjectUpdate."+e.type,e.object),b(angular.noop)}})}}function b(a){function b(b,c,d){g&&(d?a[b](c,d):a[b](c))}function c(a,c){b("debug",a,c)}function d(a,c){b("info",a,c)}function e(a,c){b("warn",a,c)}function f(a,c){b("error",a,c)}var g=!1;return{debug:c,info:d,warn:e,error:f}}function c(a,b,c,d){function e(){return l.supported&&window.goog.propel.PropelClient.isSupported()}function f(){return l.subscribed}function g(a){return b(function(b,d){c(d,a)})}function h(a,c){var d=[a,g(c)];return b.race(d)}function i(){return b(function(b,c){var d=window.goog.propel.PropelClient;d.isSupported()?(a.info("Push Notifications supported by browser"),navigator.serviceWorker.getRegistration().then(function(e){e?(l.client=new d(e),l.supported=!0,l.client.addEventListener("statuschange",function(c){if("denied"===c.permissionStatus)l.subscribed=!1,l.supported=!1,a.warn("Flat.io notifications have been blocked by user");else if(c.currentSubscription){l.subscribed=!0;var d=JSON.parse(JSON.stringify(c.currentSubscription));a.info("User is now subscribed",d)}else a.info("User is not subscribed to push notifications"),l.subscribed=!1;b()})):(a.warn("No service worker registered, canceling push notification registration"),c())}).catch(function(b){l.supported=!1,l.subscribed=!1,a.warn("Error while geting serviceWorker registration",b),c(b)})):(l.supported=!1,l.subscribed=!1,a.warn("Push Notifications is not supported by browser"),c())})}function j(){return b(function(b,c){return l.client?void l.client.getSubscription().then(function(e){l.supported=!0,e?(a.info("User is already subscribed",e),l.subscribed=!0,b(e)):l.client.requestPermission().then(function(e){"granted"===e?h(l.client.subscribe().then(function(c){l.subscribed=!0,a.info("User is now subscribed",c),d.pushSubscribe(c).$promise.then(function(b){a.info("User refistration added to database",b)}),b(c)}).catch(function(b){l.subscribed=!1,a.warn("Error while subscribing to Push Notifications",b),c(b)}),1500).catch(function(b){l.subscribed=!1,a.warn("Timeout Error while subscribing to Push Notifications",b),c(b)}):a.warn("User did not grand permission to Flat.io to send notifications")}).catch(function(b){l.subscribed=!1,a.warn("Error while requesting permission to send Notifications",b),c(b)})}).catch(function(b){l.subscribed=!1,l.supported=!1,a.warn("Error while subscribing to Push Notifications",b),c(b)}):i().then(function(){j().then(b).catch(c)}).catch(c)})}function k(){return b(function(b,c){return l.client?void l.client.getSubscription().then(function(e){l.supported=!0,e?l.client.unsubscribe().then(function(){l.subscribed=!1,a.info("User is now unsubscribed from Push Notifications"),d.pushUnsubscribe(e).$promise.then(function(b){a.info("User refistration removed from database",b)}),b(e)}).catch(function(b){l.subscribed=!0,a.warn("Error while unsubscribing from Push Notifications",b),c(b)}):(l.subscribed=!1,a.info("User is already unsubscribed"),b())}).catch(function(b){l.subscribed=!1,l.supported=!1,a.warn("Error while unsubscribing from Push Notifications",b),c(b)}):i().then(function(){k().then(b).catch(c)}).catch(c)})}var l=this;l.client=null,l.subscribed=!1,l.supported=!0,l.isSupported=e,l.isSubscribed=f,l.initialize=i,l.subscribe=j,l.unsubscribe=k}angular.module("flat.push",["ngLodash"]).service("Push",a).service("CloudMessaging",c).factory("CloudMessagingLogger",b),a.$inject=["$log","$timeout","$rootScope","TokenHandler"],b.$inject=["$log"],c.$inject=["CloudMessagingLogger","$q","$timeout","User"]}(),angular.module("flat.notification",["flat.services","flat.dashboard.services"]).factory("NotificationsResolver",["_","$q","$filter","Notifications","UserV2","ScoreIDB","AssignmentV2",function(a,b,c,d,e,f,g){function h(b){var c=a.findIndex(p,{id:b.id});c>=0?p[c]=b:p.push(b),p=a.orderBy(p,"-date")}function i(){var a=b.defer();return d.query().$promise.then(function(b){p=b,a.resolve(b)}).catch(a.reject),a.promise}function j(a){if(a.resolved=!1,!q[a.actor])return a;if(a.actor=q[a.actor],"classroomSubmission"===a.type||"classroomSubmissionReturned"===a.type){if(!s[a.attachments.classroomAssignment])return a;a.attachments.classroomAssignment=s[a.attachments.classroomAssignment]}else if(a.attachments.score){if(!r[a.attachments.score])return a;a.attachments.score=r[a.attachments.score]}return a.resolved=!0,a}function k(d){for(var h,i,j,k,l=b.defer(),m=[],n=[],o=[],p=[],t=0;t<d.length;t++)h=d[t],h.dateRelative||(h.dateRelative=c("fromNow")(h.date)),a.isUndefined(h.resolved)&&(n.push(h.actor),"classroomSubmission"===h.type||"classroomSubmissionReturned"===h.type?p.push({classroom:h.attachments.classroom,classroomAssignment:h.attachments.classroomAssignment}):h.attachments.score&&o.push(h.attachments.score));for(n=a.uniq(n),o=a.uniq(o),p=a.uniq(p),t=0;t<n.length;t++)i=e.get({user:n[t]}).$promise.then(function(a){q[a.id]=a}),m.push(i);for(t=0;t<o.length;t++)j=f.get({id:o[t]},{strategy:"cacheFirst",cache:!0,update:!1}).then(function(a){r[a.id]=a}),m.push(j);for(t=0;t<p.length;t++)k=g.get({id:p[t].classroomAssignment,class:p[t].classroom}).$promise.then(function(a){s[a.id]=a}),m.push(k);return b.all(m).then(function(){l.resolve(d)}).catch(function(){l.reject(d)}),l.promise}function l(a){var c=b.defer();return k([a]).finally(function(){a=j(a),h(a),c.resolve(a)}),c.promise}function m(c){var d=b.defer(),e=p.slice(0,c);return e.length?(k(e).finally(function(){for(var b=0;b<e.length;b++)e[b].resolved||(e[b]=j(e[b]),h(e[b]));d.resolve(a.filter(e,{resolved:!0}).slice(0,c))}),d.promise):i().then(function(a){return a.length?m(c):(d.resolve(e),d.promise)})}function n(){return m()}function o(){return m(4)}var p=[],q={},r={},s={},t={query:i,queryActivity:n,queryNotificationCenter:o,getMetaForNotification:l};return t}]).directive("notificationCenter",[function(){return{replace:!0,templateUrl:"/views/dashboard/notification/_list.html",controller:["_","$rootScope","$scope","$timeout","Experience","Notifications","NotificationsResolver",function(a,b,c,d,e,f,g){c.allNotifications=[],g.queryNotificationCenter().then(function(a){for(var b=0;b<a.length;b++)c.allNotifications.push(a[b])}).catch(function(){c.allNotifications=[]}).finally(function(){c.hasUnseenNotifications(),c.unseenNotifications&&"user"!==b.account.organizationRole?(c.$broadcast("ObjectUpdate.Notification",c.allNotifications[0]),b.hasSeenLastUpdate=0===a.filter(c.allNotifications,{seen:!1,type:"productUpdate"}).length):b.hasSeenLastUpdate=!0}),c.toogleDropdown=!1,c.hasUnseenNotifications=function(){b.unseenNotifications=c.unseenNotifications=a.filter(c.allNotifications,{seen:!1}).length},c.markAllAsSeen=function(){b.unseenNotifications>0&&(f.markAllAsSeen(function(){for(var a=0;a<c.allNotifications.length;a++)c.allNotifications[a].seen=!0;c.hasUnseenNotifications()}),e.add("notifications.read"))},c.addNotification=function(a){c.allNotifications.unshift(a),a.seen||(c.unseenNotifications+=1),c.hasUnseenNotifications()},c.$on("ObjectUpdate.Notification",function(e,f){g.getMetaForNotification(f).then(function(e){c.toogleDropdown=!0,c.newNotification=e,d(function(){c.toogleDropdown=!1,c.newNotification=null;var d=a.findIndex(c.allNotifications,function(a){return a.id===e.id});d<0&&(c.allNotifications.unshift(e),c.allNotifications.length>4&&c.allNotifications.pop(),c.unseenNotifications+=1,b.unseenNotifications=c.unseenNotifications)},4e3)})})}]}}]).directive("notificationWidget",[function(){return{restrict:"AE",scope:{notification:"=",style:"="},templateUrl:"/views/dashboard/notification/_widget.html",controller:["$rootScope","$scope","Notifications","UserPicture",function(a,b,c,d){if(b.actorName=b.notification.actor.printableName,b.actorUrl=b.notification.actor.htmlUrl,b.actorPicture=d.resize(b.notification.actor.picture,22),"classroomSubmission"===b.notification.type||"classroomSubmissionReturned"===b.notification.type){if(b.notification.attachments){var e=b.notification.attachments.classroom,f=b.notification.attachments.classroomAssignment.id,g=b.notification.attachments.classroomSubmission;b.attachmentName=b.notification.attachments.classroomAssignment.title,"classroomSubmission"===b.notification.type?b.attachmentUrl="/class/"+e+"/reviews/"+f+"#submission-std-"+g:b.attachmentUrl="/class/"+e+"/assignment/"+f}}else b.notification.attachments&&b.notification.attachments.score?(b.attachmentName=b.notification.attachments.score.title,b.attachmentUrl=b.notification.attachments.score.htmlUrl,"scoreComment"===b.notification.type&&(b.attachmentUrl+="?m=comments")):b.notification.attachments&&b.notification.attachments.productUpdate?(b.attachmentName=b.notification.attachments.productUpdate.title,b.attachmentUrl="/updates/"+b.notification.attachments.productUpdate.id):b.notification.attachments&&b.notification.attachments.custom?(b.attachmentName=b.notification.attachments.custom.title,b.attachmentUrl=b.notification.attachments.custom.link):(b.attachmentName=b.notification.attachmentName,b.attachmentUrl=b.notification.attachmentUrl);b.icons={scoreInvitation:"/img/icons/_common/notification_invitation.svg",scoreStar:"/img/icons/_common/notification_like.svg",scoreComment:"/img/icons/_common/notification_comment.svg",userFollow:"/img/icons/_common/notification_follow.svg",classroomSubmission:"/img/icons/_common/notification_submission.svg",classroomSubmissionReturned:"/img/icons/_common/notification_submission_returned.svg",productUpdate:"/img/icons/_common/updates.svg",trialEndedAdvancedHistory:"/img/icons/_common/power_badge_noborder.svg",trialEndedOfflineRW:"/img/icons/_common/power_badge_noborder.svg",custom:"/img/icons/_common/updates.svg"},b.getIcon=function(a){return b.icons[a]?b.icons[a]:b.icons.scoreStar}}]}}]),angular.module("flat.text",[]).factory("Text",function(){var a={encode:function(a){return $("<div/>").text(a).html()},prettyDisplay:function(a){return a.replace(/\r?\n/g," <br />")},prettyLinks:function(a){var b=/((https?:\/\/)[\w-]+(\.[\w-]+)+\.?(:\d+)?(\/\S*)?)/gim,c=/(^|[^\/])(www\.[\S]+(\b|$))/gim,d=/[\w.]+@[a-zA-Z_-]+?(?:\.[a-zA-Z]{2,6})+/gim;return a.replace(b,'<a href="$&" target="_blank">$&</a>').replace(c,'$1<a href="http://$2" target="_blank">$2</a>').replace(d,'<a href="mailto:$&">$&</a>')},extractLinks:function(a,b){if(!a)return[];var c=b?/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&\/\/=]*)/gi:/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&\/\/=]*)\s/gi,d=a.match(c);if(!d)return[];if(!b)for(var e=0;e<d.length;e++)d[e]=d[e].slice(0,-1);return d},extractFlatLinks:function(a){if(!a)return[];var b=/((https?:\/\/)?([\w-]+)?flat\.io\/score\/[\w-]*)\s/gi,c=a.match(b);if(!c)return[];for(var d=0;d<c.length;d++)c[d]=c[d].slice(0,-1);return c},flatDisplay:function(b){return b=a.encode(b),b=a.prettyDisplay(b),b=a.prettyLinks(b)}};return a}),angular.module("flat.themes",["flat.services"]).factory("ThemesHelpers",["$q","Themes",function(a,b){var c={getThemeForScore:function(a,c){var d=b.query(function(){for(var b=0,e=0;e<a.title.length;e++)b+=a.title[e].charCodeAt(0);c("theme-"+d[b%d.length])})},getThemeForUser:function(c){return a(function(a,d){b.query().$promise.then(function(b){if(c&&c.registrationDate){var d=new Date(c.registrationDate).getTime()%b.length;a("theme-"+b[d])}else a("theme-default")}).catch(d)})}};return c}]),angular.module("flat.playerMinimal",["angular-svg-round-progress"]).directive("playerMinimal",["$timeout","$rootScope","Experience",function(a,b,c){return{replace:!0,scope:{src:"=",playing:"="},template:'<div class="player-container">    <div class="state">      <span class="loading" data-ng-if="loading" data-ng-i18next="flat:player.loading"></span>      <span class="prewview" data-ng-if="!loading" data-ng-i18next="flat:player.preview"></span>    </div>    <div       data-round-progress      data-max="duration"      data-current="currentTime"      color=""      bgcolor=""      radius="50"      stroke="5"      clockwise="true"      rounded="true"      iterations="100"></div>      <audio preload="none"><source ng-if="::trustedSrc" src="{{ trustedSrc }}" /></audio></div>',controller:["$sce","$scope",function(b,c){c.trustedSrc=b.trustAsResourceUrl(c.src),c.$watch("playing",function(a){a===!0?(c.controlPlay=!0,c.play()):a===!1&&(c.controlPlay=!1,c.pause())}),document.addEventListener&&document.addEventListener("visibilitychange",function(){document.hidden&&(c.pause(),a(angular.noop))}),c.$on("$destroy",function(){c.pause&&c.pause()})}],link:function(d,e){var f=$(e).find("audio");d.currentTime=0,d.duration=0,d.loadingTimeout=null,d.play=function(){d.loading=!0,d.loadingTimeout=a(function(){f[0].play(),c.add("dashboard.preview-score"),d.controlPlay||f[0].pause()},900)},d.pause=function(){d.controlPlay=!1,d.loadingTimeout&&a.cancel(d.loadingTimeout),0!==f[0].readyState&&(f[0].currentTime=d.currentTime=0,f[0].pause())};var g=function(c){if("canplay"===c.type||d.played){if("canplay"===c.type&&d.played)return;d.duration=f[0].duration,d.played=!0,d.loading=!1,b.$broadcast("Player.Play",d.src),a(angular.noop)}else b.$broadcast("Player.PlayLoading",d.src);d.controlPlay||f[0].pause()},h=function(){b.$broadcast("Player.Stop",d.src),d.actionPlay=!1,a(angular.noop)},i=function(a,b){b!==d.src&&(d.pause(),d.loading=!1)},j=function(){d.currentTime=f[0].currentTime,a(angular.noop)};f.on("canplay",g),f.on("play",g),f.on("ended",h),f.on("pause",h),f.on("timeupdate",j),d.$on("Player.Play",i),d.$on("Player.PlayLoading",i),d.$on("Player.Stop",d.pause)}}}]),angular.module("flat.services",["ngResource"]).factory("AuthV2",["$resource","Csrf",function(a,b){return a(apiv2baseurl+"/auth/:action/:sub",{},{signin:{method:"POST",params:{action:"signin"},transformResponse:b.transformResponse},signup:{method:"POST",params:{action:"signup"},transformResponse:b.transformResponse},ssoGoogle:{method:"POST",params:{action:"sso",sub:"google"},transformResponse:b.transformResponse},ssoFacebook:{method:"POST",params:{action:"sso",sub:"facebook"},transformResponse:b.transformResponse},guest:{method:"POST",params:{action:"guest"},transformResponse:b.transformResponse},logout:{method:"POST",params:{action:"logout"}}})}]).factory("AuthSigninLink",["$resource","Csrf",function(a,b){return a(apiv2baseurl+"/auth/signinLink/:token",{token:"@token"},{request:{method:"POST"},process:{method:"POST",transformResponse:b.transformResponse}})}]).factory("Me",["$resource","Csrf",function(a,b){return a(apiv2baseurl+"/me/:action",{action:"@action"},{get:{method:"GET",transformResponse:b.transformResponse},updateSession:{method:"PUT",params:{action:"session"}}})}]).factory("CustomPitchedInstrument",["$resource",function(a){return a(apiv2baseurl+"/me/instruments/pitched/:instrument",{instrument:"@instrument"},{query:{method:"GET",isArray:!0},post:{method:"POST"},get:{method:"GET"},put:{method:"PUT"}})}]).factory("Version",["$interval","$resource","$rootScope",function(a,b,c){var d=b(baseurl+"/fixtures/version.json"),e=null;return{get:function(){return version},check:function(){a(function(){d.get({t:+new Date},function(a){version&&a&&a.version&&(a.version.split(".")[0]!==version.split(".")[0]||a.version.split(".")[1]!==version.split(".")[1])&&(c.flat.modal||c.loadModal("editor","update"),e=new Date)})},18e5)}}}]).factory("Notifications",["$resource",function(a){return a(apibaseurl+"/notifications.json/:id/:action",{id:"@id"},{markAsSeen:{method:"POST",params:{action:"seen"}},markAllAsSeen:{method:"POST",params:{id:"seen"}}})}]).factory("Offers",["$resource",function(a){return a(apibaseurl+"/offers.json",{},{})}]).factory("OffersV2",["$resource",function(a){return a(apiv2baseurl+"/offers",{},{})}]).factory("Search",["$resource",function(a){return a(apiv2baseurl+"/search/:model",{},{users:{method:"GET",params:{model:"users"},isArray:!0},scores:{method:"GET",params:{model:"scores"},isArray:!0}})}]).factory("User",["$resource","$cacheFactory",function(a,b){var c=b("user"),d={response:function(a){return c.removeAll(),a.data}};return a(apibaseurl+"/user.json/:user/:action/:actionParam",{user:"@id",action:"@action",actionParam:"@actionParam"},{get:{method:"GET",cache:c},getNoCache:{method:"GET",cache:!1,interceptor:d},put:{method:"PUT",interceptor:d},validateEmail:{method:"GET",params:{user:"validateEmail"},interceptor:d},askValidation:{method:"POST",params:{user:"askValidation"},interceptor:d},activateTrial:{method:"POST",params:{user:"trials"},interceptor:d},facebookDetails:{method:"GET",params:{user:"facebook"}},facebookUnlink:{method:"DELETE",params:{user:"facebook"}},googleDetails:{method:"GET",params:{user:"google"}},googleUnlink:{method:"DELETE",params:{user:"google"}},googleClassroomDetails:{method:"GET",params:{user:"google-classroom"}},experience:{method:"POST",params:{action:"experience"}},feedback:{method:"POST",params:{action:"feedback"}},starred:{method:"GET",params:{action:"starred"},isArray:!0},viewsStats:{method:"GET",params:{action:"stats",actionParam:"views"},isArray:!0,cache:!0},commentsStats:{method:"GET",params:{action:"stats",actionParam:"comments"},isArray:!0,cache:!0},starsStats:{method:"GET",params:{action:"stats",actionParam:"stars"},isArray:!0,cache:!0},playedStats:{method:"GET",params:{action:"stats",actionParam:"played"},isArray:!0,cache:!0},notesDroppedStats:{method:"GET",params:{action:"stats",actionParam:"dropped"},isArray:!0,cache:!0},bestFansStats:{method:"GET",params:{action:"stats",actionParam:"fans"},isArray:!0,cache:!0},license:{method:"GET",params:{action:"license"}},uploadProfilePicture:{method:"POST",params:{user:"profile-picture"}},pushSubscribe:{method:"POST",params:{action:"push",actionParam:"subscribe"}},pushUnsubscribe:{method:"POST",params:{action:"push",actionParam:"unsubscribe"}}})}]).factory("UserV2",["$resource","$cacheFactory",function(a,b){var c=b("userv2"),d={response:function(a){return c.removeAll(),a.data}};return a(apiv2baseurl+"/users/:user/:action",{user:"@user"},{get:{method:"GET",cache:c},getNoCache:{method:"GET",cache:!1,interceptor:d},scores:{method:"GET",isArray:!0,params:{action:"scores"}},likes:{method:"GET",isArray:!0,params:{action:"likes"}}})}]).factory("Organization",["$resource",function(a){return a(apibaseurl+"/organizations.json/:id/:action",{id:"@id",action:"@action"},{get:{method:"GET"},put:{method:"PUT"},search:{method:"POST",params:{id:"search"},isArray:!0},join:{method:"POST",params:{action:"join"}},invite:{method:"POST",params:{id:"invitations"}},invitations:{method:"GET",params:{id:"invitations"},isArray:!0},removeInvitation:{method:"DELETE",params:{id:"invitations"}}})}]).factory("OrganizationV2",["$resource",function(a){return a(apiv2baseurl+"/organizations/:id/:action",{id:"@id",action:"@action"},{get:{method:"GET"},put:{method:"PUT"},search:{method:"POST",params:{id:"search"},isArray:!0},join:{method:"POST",params:{action:"join"}},invitations:{method:"GET",params:{id:"invitations"},isArray:!0},invite:{method:"POST",params:{id:"invitations"}},removeInvitation:{method:"DELETE",params:{id:"invitations"}}})}]).factory("GoogleAuth",["$resource",function(a){return a(baseurl+"/auth/google-access-token")}]).factory("GoogleApps",["$resource",function(a){return a(apibaseurl+"/organizations.json/google-apps/:action/:subaction",{},{setAdmin:{method:"PUT",params:{action:"set-admin"}},listDomains:{method:"GET",params:{action:"domains"},isArray:!0},setAutoEnroll:{method:"PUT",params:{action:"domains",subaction:"auto-enroll"},isArray:!0}})}]).factory("Group",["$resource",function(a){return a(apibaseurl+"/organizations.json/groups/:id/:action",{id:"@id",action:"@action"},{users:{method:"GET",params:{action:"users"},cache:!0,isArray:!0},usersNoCache:{method:"GET",params:{action:"users"},cache:!1,isArray:!0},scores:{method:"GET",params:{action:"scores"},cache:!0,isArray:!0}})}]).factory("GroupV2",["$resource",function(a){return a(apiv2baseurl+"/groups/:id/:action",{id:"@id",action:"@action"},{scores:{method:"GET",params:{action:"scores"},cache:!0,isArray:!0}})}]).factory("Support",["$resource",function(a){return a(apibaseurl+"/support.json")}]).factory("BillingDetails",["$resource",function(a){return a(apibaseurl+"/billing.json",{pm:"@pm"},{query:{array:!1},update:{method:"PUT"},postCard:{url:apibaseurl+"/billing.json/paymentMeans/stripe",method:"POST"},queryCards:{url:apibaseurl+"/billing.json/paymentMeans",method:"GET",isArray:!0},deleteCard:{url:apibaseurl+"/billing.json/paymentMeans/:pm",method:"DELETE"},setAsMainPaymentMean:{url:apibaseurl+"/billing.json/paymentMeans/:pm/markAsPreferred",method:"POST"}})}]).factory("BillingDetailsV2",["$resource",function(a){return a(apiv2baseurl+"/billing",{pm:"@pm"},{query:{array:!1},update:{method:"PUT"},postCard:{url:apiv2baseurl+"/billing/paymentMeans/stripe",method:"POST"},queryCards:{url:apiv2baseurl+"/billing/paymentMeans",method:"GET",isArray:!0},deleteCard:{url:apiv2baseurl+"/billing/paymentMeans/:pm",method:"DELETE"},setAsMainPaymentMean:{url:apiv2baseurl+"/billing/paymentMeans/:pm/markAsPreferred",method:"POST"}})}]).factory("Orders",["$resource",function(a){return a(apibaseurl+"/orders.json/:id",{id:"@id",pm:"@pm"},{post:{method:"POST"},pay:{url:apibaseurl+"/orders.json/:id/pay/:pm",method:"POST"},quote:{url:apibaseurl+"/orders.json/:id/quote",method:"POST"}})}]).factory("OrdersV2",["$resource",function(a){return a(apiv2baseurl+"/orders/:id/:action",{id:"@id",action:"@action",pm:"@pm"},{post:{method:"POST"},pay:{url:apiv2baseurl+"/orders/:id/pay/:pm",method:"POST"},quote:{url:apiv2baseurl+"/orders/:id/quote",method:"POST"},siteLicense:{method:"POST",params:{id:"siteLicense"}},purchaseOrder:{method:"POST",params:{action:"purchaseOrder"}}})}]).factory("OrderDocument",["$resource",function(a){return a(apiv2baseurl+"/orders/:order/documents/:document",{order:"@order",document:"@document"},{upload:{method:"POST"}})}]).factory("Gifts",["$resource",function(a){return a(apiv2baseurl+"/gifts/:id/:action",{id:"@id"},{create:{method:"POST"},send:{method:"POST",params:{action:"send"}},redeem:{method:"POST",params:{action:"redeem"}}})}]).factory("Chords",["$resource",function(a){return a(baseurl+"/fixtures/chords.min.json",{},{get:{method:"GET",cache:!0,isArray:!1}})}]).factory("Shortcuts",["$resource",function(a){return a(baseurl+"/fixtures/shortcuts.json?"+version,{},{query:{method:"GET",isArray:!1,cache:!0}})}]).factory("Themes",["$resource",function(a){return a(baseurl+"/fixtures/themes.min.json?"+version,{},{query:{method:"GET",isArray:!0,cache:!0}})}]).factory("Countries",["$resource",function(a){return a(baseurl+"/fixtures/countries.json?"+version,{},{query:{method:"GET",isArray:!1,cache:!0}})}]).factory("SessionAnalytics",["UxStore",function(a){return{init:function(){a.get("analytics.entry-page")||(a.set("analytics.referrer",document.referrer),a.set("analytics.entry-page",document.location.href))}}}]).factory("Experience",["UxStore","User","$rootScope",function(a,b,c){return{add:function(d){c.account&&c.account.experience&&c.account.experience.indexOf(d)<0&&(c.account.experience.push(d),b.experience({actionParam:d}));var e=a.get("session.xps")||{};"number"!=typeof e[d]&&(e[d]=0),e[d]++,a.set("session.xps",e)}}}]).factory("SessionUpdater",["$window","$interval","$rootScope","Me","UxStore",function(a,b,c,d,e){var f,g={user:null,update:function(){var h=0;c.ravenExtraContext&&c.ravenExtraContext["exception:total"]&&(h=c.ravenExtraContext["exception:total"],c.ravenExtraContext["exception:total"]=0);var i={frontendErrorsCount:h,frontendVersion:version};e.get("analytics.entry-page")&&(i.url=e.get("analytics.entry-page"),i.referrer=e.get("analytics.referrer")),i.xp=e.get("session.xps"),d.updateSession(i,function(a){e.remove("session.xps"),e.remove("analytics.entry-page"),e.remove("analytics.referrer"),g.user&&(!a.user||a.user&&a.user.id!==g.user.id)&&(window.location="/auth/logout"),g.user=g.user||a.user},function(c){401===c.status&&(f&&b.cancel(f),a.removeEventListener("beforeunload",g.update))})}};return f=b(g.update,18e4),a.addEventListener("beforeunload",g.update),g}]).factory("ScoreV2",["$resource",function(a){var b=a(apiv2baseurl+"/scores/:id/:action/:secondAction/:thirdAction",{id:"@id",action:"@action",secondAction:"@secondAction",thirdAction:"@thirdAction"},{getcached:{method:"GET",cache:!0},create:{method:"POST"},put:{method:"PUT"},fork:{method:"POST",params:{action:"fork"}},like:{method:"POST",params:{action:"likes"}},unlike:{method:"DELETE",params:{action:"likes"}},midiLink:{method:"GET",params:{action:"revisions",secondAction:"last",thirdAction:"midi",url:!0}},played:{method:"POST",params:{action:"played"}},submissions:{methods:"GET",params:{action:"submissions"},isArray:!0}});return b.generateSharingKey=function(){for(var a="0123456789abcdef",b="",c=0;c<128;c++)b+=a.charAt(Math.floor(Math.random()*a.length));return b},b}]).factory("CollaboratorV2",["$resource",function(a){return a(apiv2baseurl+"/scores/:score/collaborators/:collaborator",{score:"@score",collaborator:"@collaborator"},{add:{method:"POST"}})}]).factory("ClassV2",["$resource",function(a){return a(apiv2baseurl+"/classes/:id/:action",{id:"@id",action:"@action"},{get:{method:"GET"},create:{method:"POST"},put:{method:"PUT"},enroll:{method:"POST",params:{id:"enroll"}},archive:{method:"POST",params:{action:"archive"}},unarchive:{method:"DELETE",params:{action:"archive"}},sync:{method:"POST",params:{action:"sync"}},unsync:{method:"DELETE",params:{action:"sync"}}})}]).factory("GoogleClassroomV2",["$resource",function(a){return a(apiv2baseurl+"/google/classroom/:action",{action:"@action"},{me:{method:"GET",params:{action:"me"}},courses:{method:"GET",params:{action:"courses"},isArray:!0}})}]).factory("AssignmentV2",["$resource",function(a){
return a(apiv2baseurl+"/classes/:class/assignments/:id",{class:"@class",id:"@id"},{create:{method:"POST"},update:{method:"PUT"},sync:{method:"POST",params:{id:"sync"}}})}]).factory("Preview",["$resource",function(a){return a(apiv2baseurl+"/previews/:type",{type:"@type"},{url:{method:"POST",params:{type:"urls"}}})}]).factory("FrontendEvent",["$resource","$timeout",function(a,b){var c=a(apibaseurl+"/events.json/:type",{type:"@type"},{push:{method:"POST"},pushMidi:{method:"POST",params:{type:"midi"}}});return c.setupAutoTrack=function(a,d,e){var f,g=function(a){for(var b,g=a.target;g;){if(g&&g.id){b=g.id;break}g=g.parentElement}b&&(f!==b&&c.push({funnel:{id:d},event:{type:"click"===a.type?"click":"input",category:e||"autotrack",name:b}}),f=b)};b(function(){$(a).click(g).focusin(g)})},c}]),angular.module("flat.instruments",["ngResource"]).factory("Instruments",["$resource",function(a){var b,c=a(baseurl+"/fixtures/instruments_:locale.min.json?"+version,{},{get:{method:"GET",cache:!0}});return c.loaded=c.get({locale:"en"},function(a){b=a.instruments}).$promise,c.identifyFromPart=function(a){if(!b||"undefined"==typeof a["midi-instrument"])return{};var c,d;if(a["midi-instrument"].constructor===Array){if(!a["unpitched-set-hash"]){for(var e=[],f=0;f<a["midi-instrument"].length;f++)e.push(parseInt(a["midi-instrument"][f]["midi-unpitched"],10));a["unpitched-set-hash"]=md5(JSON.stringify(e.sort()))}return b["$midi-unpitched-hashed"][a["unpitched-set-hash"]]||{}}return"undefined"!=typeof a["midi-instrument"]["midi-unpitched"]?(a["midi-instrument"][0]&&a["midi-instrument"][0]["midi-unpitched"]?d=a["midi-instrument"][0]["midi-program"]:"undefined"!=typeof a["midi-instrument"]["midi-unpitched"]&&(d=a["midi-instrument"]["midi-unpitched"]),b["$midi-unpitched"][d]||{}):"undefined"!=typeof a["midi-instrument"]["midi-program"]?(c=a["midi-instrument"]["midi-program"],b.$midi[c]||{}):{}},c}]),angular.module("flat.modal",[]).controller("flat.modal.Main",["$rootScope","$scope","$timeout","$location",function(a,b,c,d){a.flat=b.flat||{},b.flat.modal=null,b.flat.modalData={};var e=null;a.hideModal=b.hideModal=function(){b.flat.modal&&$(".modal,.modal-backdrop").remove(),b.flat.modal=null,d.search("m",null),c(angular.noop)},a.loadModal=b.loadModal=function(a,d,e){d=d.replace(/-/g,"_"),b.flat.modalData={},e&&angular.isObject(e)&&(b.flat.modalData=e),b.flat.modal&&$(".modal").hasClass("in")?$(".modal").on("hidden.bs.modal",function(){b.flat.modal={type:a,name:d},$(".modal-backdrop").remove(),c(angular.noop)}).modal("hide"):b.flat.modal={type:a,name:d}},a.$on("modals.open",function(a,d,e,f){b.loadModal(d,e,f),c(angular.noop)}),a.$on("modals.close",function(){b.hideModal()}),null===e&&(e=b.$watch("flat.modal",function(b,c){null===b&&null!==c&&a.$broadcast("modals.closed")},!0))}]),angular.module("flat.currencies",[]).factory("Currencies",function(){return{ARS:{moneyFormat:"ARS${amount}",moneyWithCurrencyFormat:"${amount} ARS"},AUD:{moneyFormat:"AUD${amount}",moneyWithCurrencyFormat:"${amount} AUD"},BRL:{moneyFormat:"R$ {amount}",moneyWithCurrencyFormat:"R$ {amount} BRL"},CAD:{moneyFormat:"CAD${amount}",moneyWithCurrencyFormat:"${amount} CAD"},CHF:{moneyFormat:"SFr. {amount}",moneyWithCurrencyFormat:"SFr. {amount} CHF"},CLP:{moneyFormat:"CLP${amount}",moneyWithCurrencyFormat:"${amount} CLP"},COP:{moneyFormat:"COL${amount}",moneyWithCurrencyFormat:"${amount} COP"},DKK:{moneyFormat:"kr.{amount}",moneyWithCurrencyFormat:"kr.{amount}"},EUR:{moneyFormat:"â‚¬{amount}",moneyWithCurrencyFormat:"â‚¬{amount} EUR"},GBP:{moneyFormat:"Â£{amount}",moneyWithCurrencyFormat:"Â£{amount} GBP"},HKD:{moneyFormat:"HK${amount}",moneyWithCurrencyFormat:"HK${amount}"},HUF:{moneyFormat:"${amount} Ft",moneyWithCurrencyFormat:"${amount} Ft"},IDR:{moneyFormat:"Rp {amount}",moneyWithCurrencyFormat:"Rp {amount}"},ILS:{moneyFormat:"{amount} NIS",moneyWithCurrencyFormat:"{amount} NIS"},INR:{moneyFormat:"â‚¹{amount}",moneyWithCurrencyFormat:"â‚¹{amount} INR"},JPY:{moneyFormat:"Â¥{amount}",moneyWithCurrencyFormat:"Â¥{amount} JPY"},KRW:{moneyFormat:"â‚©{amount}",moneyWithCurrencyFormat:"â‚©{amount} KRW"},MXN:{moneyFormat:"Mex$ {amount}",moneyWithCurrencyFormat:"$ {amount} MXN"},MYR:{moneyFormat:"RM{amount}",moneyWithCurrencyFormat:"RM{amount} MYR"},NOK:{moneyFormat:"kr {amount}",moneyWithCurrencyFormat:"kr {amount} NOK"},NZD:{moneyFormat:"NZD${amount}",moneyWithCurrencyFormat:"${amount} NZD"},PEN:{moneyFormat:"S/. {amount}",moneyWithCurrencyFormat:"S/. {amount} PEN"},PHP:{moneyFormat:"â‚±{amount}",moneyWithCurrencyFormat:"â‚±{amount} PHP"},PLN:{moneyFormat:"zÅ‚{amount}",moneyWithCurrencyFormat:"zÅ‚{amount} PLN"},QAR:{moneyFormat:"{amount} riyal",moneyWithCurrencyFormat:"QAR {amount}"},RUB:{moneyFormat:"Ñ€ÑƒÐ±{amount}",moneyWithCurrencyFormat:"Ñ€ÑƒÐ±{amount} RUB"},SAR:{moneyFormat:"{amount} SR",moneyWithCurrencyFormat:"{amount} SAR"},SEK:{moneyFormat:"{amount} kr",moneyWithCurrencyFormat:"{amount} kr SEK"},SGD:{moneyFormat:"S${amount}",moneyWithCurrencyFormat:"${amount} SGD"},TWD:{moneyFormat:"NT${amount}",moneyWithCurrencyFormat:"${amount} TWD"},USD:{moneyFormat:"${amount}",moneyWithCurrencyFormat:"${amount} USD"},ZAR:{moneyFormat:"R {amount}",moneyWithCurrencyFormat:"R {amount} ZAR"}}}),angular.module("flat.common").run(["$templateCache",function(a){a.put("/views/common/_errors.html",'<div class="alert alert-danger" data-ng-if="!!errors && errors.length > 0" ng-cloak><ul data-ng-repeat="error in errors" data-ng-show="errors.length > 1"><li>{{(error || \'error.unknown\') | i18next}}</li></ul><span ng-show="errors.length == 1">{{(errors[0] || \'error.unknown\') | i18next}}</span></div>'),a.put("/views/common/_loader.html",'<div class="loader"><div><span><i></i></span><span><i></i></span></div><div><span><i></i></span><span><i></i></span></div><div><span><i></i></span><span><i></i></span></div><div><span><i></i></span><span><i></i></span></div><div><span><i></i></span><span><i></i></span></div></div>'),a.put("/views/common/_warnings.html",'<div class="alert alert-warning" data-ng-show="!!warnings && warnings.length > 0"><ul data-ng-repeat="warning in warnings" data-ng-show="warnings.length > 1"><li>{{(warning || \'error.unknown\') | i18next}}</li></ul><span ng-show="warnings.length == 1">{{(warnings[0] || \'error.unknown\') | i18next}}</span></div>')}]);
//# sourceMappingURL=flat.common.min.js.map