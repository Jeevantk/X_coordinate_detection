/*!
 * Copyright (c) 2017 Flat - Tutteo Ltd. <hello@flat.io>
 * https://flat.io
 */

"use strict";var FlatRt=function(){function a(a,b){if(this.params=a,this.params.autoSaveEvery=a.autoSaveEvery||100,this.scoreId=a.scoreId,this.localRevisionId=a.revisionId,this.accountId=a.accountId,this.onceSocketCallbacks=[],this.helpers=b,a.debug===!1)this.logger=function(){};else{var c=console.debug||console.log;this.logger=c.bind(console,"[rt "+Math.floor(100*Math.random())+"]")}this.instanceId=this.genUuidV4(),this.isSetup=!1,this.connected=!1,this.connecting=!1,this.joined=!1,this.synced=!1,this.rights="ro",this.collaborators=[],this.executed={},this.baseUnstackActionId=null,this.lastLocalActionId=null,this.readyCallbacks=[],this.lastEventReceived=new Date,this.exclusiveConnection=this.params.exclusiveConnection||!1,this._queue=async.queue(function(a,b){var c=function(){b.apply(void 0,arguments)};setTimeout(function(){try{a.fnc(c)}catch(a){c(a)}},0)}.bind(this),1),this._queue.pause()}Emitter(a.prototype);var b=function(a){return function(){var b=arguments;setTimeout(function(){a.apply(this,b)}.bind(this))}.bind(this)}.bind(this);return a.prototype.setRevisionId=function(a,b,c){if(this.localRevisionId!==a){this.logger("changing revision from",this.localRevisionId,"to",a);var d=this.localRevisionId;return this.localRevisionId=this.params.revisionId=a,this.emit("revision",{from:d,revision:a,redraw:b||!1}),this.baseUnstackActionId=null,c&&c()}return this.saving=!1,c&&c()},a.prototype.applyInQCtx=function(a,b,c,d){var e=this._queue.push.bind(this._queue);return d&&(e=this._queue.unshift.bind(this._queue)),e({name:a,fnc:b},c)},a.prototype.setup=function(a){if(!this.scoreId||!this.localRevisionId||!this.accountId){if(!a)return;return a(new Error("Missing parameters scoreId or revisionId"),null)}if(this.isSetup)return a(new Error("Already setup"),null);this.isSetup=!0;var b=function(a,b,c){b.type="rt",b.action="indexeddb",b.function=a,b.data=c,this.emit("error",b)}.bind(this),c=function(){this.logger("DB is fully ready, setup socket.io & last local action id"),this.setupSocketIO(this.params.endpoint,this.params.access_token,this.params.sharingKey),this.setupLastLocalActionId(function(){a&&a(null,null),this.logger("=> Everything is ready, resuming queue"),this._queue.resume()}.bind(this))}.bind(this);return this.logger("Starting DB init"),this.setupIndexedDB(function(a,d){!a&&d?(this.logger("DB initialized"),this.initDBHelpers(d,b,this.logger),this.logger("DB helpers initialized, starting cleanup DB"),d._indexedDB.setup=!0,this.db=d,this.cleanup(function(){this.logger("Cleanup DB done, executing saved actions"),this.executeSavedActions(c)}.bind(this))):(this.logger("Impossible to setup indexedDB"),this.emit("error",a),this.db={_indexedDB:{setup:!1}},this.initDBHelpers(this.db,b,this.logger),c())}.bind(this)),this},a.prototype.setupIndexedDB=function(a,c){var d=new Dexie("scores_actions_"+this.accountId);"function"==typeof a&&(c=a,a={}),d.version(2).stores({actions:"++_id, *scoreId, &id"}),d.on("error",function(a){this.logger("indexedDB error: ",a),this.emit("error",a)}.bind(this)),d.open().then(b(function(){this.logger("Open indexeddb connection"),c(null,{_indexedDB:d})}.bind(this))).catch(function(e){return"string"==typeof e&&(e=new Error(e),e.name="SQLError"),e instanceof SQLError&&(e.name="SQLError"),!a.retrying&&e.toString().indexOf("Internal error")>=0?(this.logger("IndexedDB internal error, trying to re-create the db"),d.delete().then(b(function(){this.setupIndexedDB({retrying:!0},c)}.bind(this))).catch(function(a){"string"==typeof a&&(a=new Error(a),a.name="SQLError"),a instanceof SQLError&&(a.name="SQLError"),a.type="rt",a.action="open_indexeddb",c(a)})):(e.type="rt",e.action="open_indexeddb",void c(e))}.bind(this))},a.prototype.setupSocketIO=function(a,b,c){var d=document.createElement("a");d.href=a,this.socket=io.connect(d.protocol+"//"+d.host+"/?access_token="+encodeURIComponent(b)+"&sharingKey="+encodeURIComponent(c),{resource:"ws","force new connection":!0,"sync disconnect on unload":!0});for(var e=0;e<this.onceSocketCallbacks.length;e++)this.onceSocketCallbacks[e](this.socket);this.connecting=!0,this.connected=!1,this.onceSocketCallbacks=[],this.listenFromSocket("connect",function(a,b){this.logger("connected"),this.connected=!0,this.connecting=!1,this.joined=!1,this.synced=!1,this.baseUnstackActionId=null,this.isUnstacking=!1,this.lastConnectError=null,this.emit("connect"),this.join(),b()}.bind(this)),this.listenFromSocket("disconnect",function(a,b){this.logger("disconnected"),this.emit("disconnect"),this.connected=!1,this.connecting=!1,this.joined=!1,this.synced=!1,this.baseUnstackActionId&&this.emit("unstack",{finished:!0}),this.baseUnstackActionId=null,this.isUnstacking=!1,b()}.bind(this)),this.listenFromSocket("connect_error",function(a,b){this.lastConnectError=new Date,this.logger("connect error",a),this.connected!==!1&&(this.connected=!1,this.connecting=!0),this.joined=!1,this.synced=!1;var c=new Error("[rt] Connect error");c.type="rt",c.action="connect",c.err=a,this.emit("error",c),this.connected&&!this.connecting&&this.applyInQCtx("connect_error.reconnect",this.reconnect.bind(this)),b()}.bind(this)),this.listenFromSocket("join",function(a,b){this.addCollaborator(a.userId),b(),this.emit("collaborators",{joined:a.userId,collaborators:this.collaborators})}.bind(this)),this.listenFromSocket("rights",function(a,b){this.logger("received rights",a),this.rights=a,this.emit("rights",this.rights),b()}.bind(this)),this.listenFromSocket("leave",function(a,b){this.logger("user left",a),this.removeCollaborator(a.userId),this.emit("collaborators",{left:a.userId,collaborators:this.collaborators}),b()}.bind(this)),this.listenFromSocket("position",function(a,b){this.emit("position",a),b()}.bind(this)),this.listenFromSocket("revision",function(a,b){return this.logger("revision changed:"+a.revId+" (event: "+a.eventId+")"),a.eventId?void this.removeActionsUntil(a.eventId,function(c){var d=!1;c&&(d=!0),this.getActions(function(c,e){if(c)return this.setRevisionId(a.revId,d),void this.cleanup(b);for(var f=[],g=0;g<e.length;g++)e[g].revisionId===this.localRevisionId&&(0===f.length&&(e[g].parentId=null),e[g].revisionId=a.revId,f.push(this.applyInQCtx.bind(this,"revision.editAction",this.db.editActionForScore.bind(this.db._indexedDB,e[g]),void 0,!0)));f.push(this.applyInQCtx.bind(this,"revision.setRevisionId",this.setRevisionId.bind(this,a.revId,d),void 0,!0)),f.push(this.applyInQCtx.bind(this,"revision.cleanup",this.cleanup.bind(this),void 0,!0));for(var h=f.length-1;h>=0;h--)f[h]();b()}.bind(this))}.bind(this)):(this.setRevisionId(a.revId,!0),void this.cleanup(b))}.bind(this)),this.listenFromSocket("synced",function(a,b){this.joined=!0,this.logger("received synced",a.events?a.events.length:0);var c=function(){var c=null,d=[];if(a.events&&a.events.length>0)for(var e=0;e<a.events.length;e++)a.events[e].ack=!0,a.events[e].scoreId=this.scoreId,a.events[e].revisionId=a.revision,d.push(this.applyInQCtx.bind(this,"synced.processAction",this.processAction.bind(this,a.events[e],!0),void 0,!0)),c=a.events[e].id;d.push(this.applyInQCtx.bind(this,"synced.autoSave",this.autoSave.bind(this),void 0,!0)),d.push(this.applyInQCtx.bind(this,"synced.finished",function(b){this.emit("synced",{revId:a.revision,n:a.events.length}),this.synced=!0,b()}.bind(this),void 0,!0)),d.push(this.applyInQCtx.bind(this,"synced.unstack",this.unstack.bind(this,c),void 0,!0));for(var f=d.length-1;f>=0;f--)d[f]();b()}.bind(this);a.revision!==this.localRevisionId?(this.logger("synced didn't have same revision",a.revision,this.localRevisionId),this.setRevisionId(a.revision,!0),this.cleanup(c)):c()}.bind(this)),this.listenFromSocket("edit",function(a,b){var c=[],d=this.baseUnstackActionId;a.events=a.events||[];for(var e=function(b,c,d){this.emit("unstack",{n:b,total:a.events.length}),this.receivedEdit(c,d)},f=0;f<a.events.length;f++)a.events[f].scoreId=a.scoreId,a.events[f].args.logs=a.events[f].args.logs||[],a.events[f].args.logs.push({date:new Date,context:"rt.fetch",user:this.uid,revision:this.localRevisionId,editorSid:this.editorSid,dataSid:this.genUuidV4(),rtSid:this.instanceId}),f%10!==0?c.push(this.applyInQCtx.bind(this,"edit.receivedEdit",this.receivedEdit.bind(this,a.events[f]),void 0,!0)):c.push(this.applyInQCtx.bind(this,"edit.progress",e.bind(this,f,a.events[f]),void 0,!0));c.push(this.applyInQCtx.bind(this,"edit.finished",function(b){a.events&&a.events.length&&d&&!this.baseUnstackActionId&&this.emit("unstack",{finished:!0}),b()}.bind(this),void 0,!0)),c.push(this.applyInQCtx.bind(this,"edit.unstack",this.unstack.bind(this,a.events[a.events.length-1].id),void 0,!0));for(var g=c.length-1;g>=0;g--)c[g]();b()}.bind(this)),this.listenFromSocket("error",function(a,b){this.logger("error",c);var c=new Error("[rt] Socket error");c.type="rt",c.action="connect",c.err=a,b(),this.emit("error",c)}.bind(this)),this.listenFromSocket("error.join",function(a,b){this.logger("error on join, rejoining now"),this.joined=!1;var c=new Error("[rt] Unable to join");c.type="rt",c.action="join",c.err=a,this.join(),b(),this.emit("error",c)}.bind(this)),this.listenFromSocket("error.edit",function(a,b){this.logger("error on edit");var c=new Error("[rt] Error while editing");c.type="rt",c.action="edit",c.err=a,b(),this.emit("error",c)}.bind(this)),this.listenFromSocket("error.not-joined",function(a,b){this.logger("not joined, rejoining now"),this.joined=!1,this.join(),b()}.bind(this)),this.listenFromSocket("error.no-parent",function(a,b){this.logger("no parent",a);var c=new Error("[rt] There is no parent for this action");c.type="rt",c.action="no-parent",c.err=a,b(),this.emit("error",c)}.bind(this)),this.listenFromSocket("error.revision-invalid",function(a,b){this.logger("invalid revision",a);var c=new Error("[rt] Invalid revision");c.type="rt",c.action="revision-invalid",c.revId=a.revId,c.localRevId=this.localRevisionId,this.setRevisionId(a.revId),this.cleanup(b),this.emit("error",c)}.bind(this)),this.listenFromSocket("error.not-rebased",function(a,b){this.logger("not rebased on",a.parentId,":",a.id);var c=new Error("[rt] not rebased");c.type="rt",c.action="not-rebased",c.actionId=a.id,c.parentId=a.parentId,this.baseUnstackActionId===a.id&&(this.baseUnstackActionId=null),this.unstack(a.parentId,b),this.emit("error",c)}.bind(this))},a.prototype.listenFromSocket=function(a,b){return this.socket.on(a,function(c){this.applyInQCtx(a,b.bind(this,c))}.bind(this))},a.prototype.join=function(a){return this.joined?a&&a():void this.getSocket(function(b){b.emit("join",{scoreId:this.scoreId,exclusiveConnection:this.exclusiveConnection},function(){this.joined=!0,a&&a()}.bind(this))}.bind(this))},a.prototype.genUuidV4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"===a?b:3&b|8;return c.toString(16)})},a.prototype.help=function(a,b){return this.helpers[a]?this.helpers[a](b):null},a.prototype.getSocket=function(a){return this.socket?a(this.socket):void this.onceSocketCallbacks.push(a)},a.prototype.registerHelper=function(a,b){this.helpers[a]=b},a.prototype.addCollaborator=function(a){this.collaborators.indexOf(a)===-1&&this.collaborators.push(a)},a.prototype.removeCollaborator=function(a){var b;(b=this.collaborators.indexOf(a))>=0&&this.collaborators.splice(b,1)},a.prototype.sendPosition=function(a){this.getSocket(function(b){b.emit("position",a)}.bind(this))},a.prototype.setupLastLocalActionId=function(a){this.getActions(function(b,c){return b?void(a&&a(b)):(0!==c.length&&(this.lastLocalActionId=c[c.length-1].id),void(a&&a(null)))}.bind(this))},a.prototype.getNewAction=function(a,b){var c={id:this.genUuidV4(),scoreId:this.scoreId,revisionId:this.localRevisionId,userId:this.accountId,parentId:this.lastLocalActionId,fnc:a,args:b,ack:!1};return this.executed[c.id]=!0,this.lastLocalActionId=c.id,c},a.prototype.edit=function(a,b,c){Adagio.Data.prototype.hasOwnProperty(a)&&(this._queue.paused&&setTimeout(function(){if(this._queue.paused){this.logger("the queue is paused, couldnt process the edit");var a=new Error("[rt] Couldnt process the edit, the queue is paused");a.type="rt",a.action="save",this.emit("error",a)}}.bind(this),3e4),this.applyInQCtx("edit",function(d){var e=this.getNewAction(a,b),f=function(a,b){return a?c&&c(a,b):(this.applyInQCtx("edit.unstack",this.unstack.bind(this,void 0)),c&&c(a,b))}.bind(this);this.applyInQCtx("edit.processAction",this.processAction.bind(this,e,!1),f,!0),this.params.reconnectAutoDisabled||this.applyInQCtx("edit.reconnect",this.reconnect.bind(this),void 0,!0),d()}.bind(this)))},a.prototype.bulkEdit=function(a,b){this._queue.paused&&setTimeout(function(){if(this._queue.paused){this.logger("the queue is paused, couldnt process the edit");var a=new Error("[rt] Couldnt process the edit, the queue is paused");a.type="rt",a.action="save",this.emit("error",a)}}.bind(this),3e4),this.applyInQCtx("bulkEdit",function(c){for(var d=function(a,c){return a?b&&b(a,c):(this.applyInQCtx("edit.unstack",this.unstack.bind(this,void 0)),b&&b(a,c))}.bind(this),e=[],f=0;f<a.length;f++)e.push(this.getNewAction(a[f].actionName,a[f].opts));this.applyInQCtx("edit.bulkAddActionsForScore",this.db.bulkAddActionsForScore.bind(this.db,e),d,!0),this.params.reconnectAutoDisabled||this.applyInQCtx("edit.reconnect",this.reconnect.bind(this),void 0,!0),c()}.bind(this))},a.prototype.autoSave=function(a){this.getActions(function(b,c){if(b)return a&&a(b,c);for(var d=0,e=!1,f=0;f<c.length;f++){if(c[f].ack!==!0){e=!0;break}c[f].revisionId===this.localRevisionId&&d++}return!b&&!e&&d>=this.params.autoSaveEvery&&!this.saving?(this.logger("Auto saving: events number too high",this.params.autoSaveEvery),this.saving=!0,a&&a(null,c),void this.emit("save")):a&&a(b,c)}.bind(this))},a.prototype.disconnect=function(a){return this.connecting===!1&&this.connected===!1?a&&a():(this.connecting=!1,this.connected=!1,this.db&&this.db._indexedDB&&this.db._indexedDB.setup===!0&&this.db._indexedDB.isOpen()&&(this.logger("closing indexedDB"),this.db._indexedDB.close()),void this.disconnectSocket(a))},a.prototype.disconnectSocket=function(a){this.getSocket(function(b){return b.disconnect(),a&&a()})},a.prototype.reconnect=function(a){if(this.connected===!1&&this.connecting===!0){var b=new Date;if(b.setTime(b.getTime()-5e3),!(b>this.lastConnectError))return a&&a();this.connecting=!1}return this.connected===!0||this.connecting===!0?a&&a():(this.db&&this.db._indexedDB&&this.db._indexedDB.setup===!0&&!this.db._indexedDB.isOpen()&&(this.logger("Open back indexeddb connection"),this.db._indexedDB.open()),this.socket&&(this.socket.removeAllListeners(),this.socket.disconnect(),this.socket=null),this.setupSocketIO(this.params.endpoint,this.params.access_token,this.params.sharingKey),a&&a())},a.prototype.receivedEdit=function(a,b){this.logger("received edit",a.id),this.lastEventReceived=new Date,this.executed[a.id]||a.revisionId!==this.localRevisionId||(this.executed[a.id]=!0,this.executeAction(a,function(b){b?(b.rt_context="remoteEdit",this.emit("error",b)):this.emit("edit",a)}.bind(this)));var c=function(){return this.baseUnstackActionId===a.id&&(this.baseUnstackActionId=null,this.applyInQCtx("receivedEdit.autoSave",this.autoSave.bind(this))),b&&b(null,a)}.bind(this);this.db.getActionByEventId(a.id,function(b,d){return b?c():void(d?this.db.ackActionByEventId(a.id,a.revisionId,a.parentId,function(){c(),this.emit("ack",a.id)}.bind(this)):(a.ack=!0,a._id&&delete a._id,a.revisionId||(a.revisionId=this.localRevisionId),this.lastLocalActionId=a.id,this.processAction(a,!1,c)))}.bind(this))},a.prototype.processAction=function(a,b,c){"undefined"==typeof b&&(b=!0),this.logger("process action",a.id),!b||this.executed[a.id]||a.ack===!0&&a.revisionId!==this.localRevisionId?(this.logger("save action"),this.saveAction(a,c)):(this.executed[a.id]=!0,this.logger("execute action"),this.executeAction(a,function(b){this.logger("save action after execute"),this.saveAction(a,c),b&&this.emit("error",b)}.bind(this)))},a.prototype.unload=function(){this.off(),this.socket&&(this.socket.off&&this.socket.off(),this.socket.removeAllListeners&&this.socket.removeAllListeners())},a.prototype.executeSavedActions=function(a){this.getActions(function(b,c){if(b)return this.logger("error when getting actions",b),a&&a(b,[]);this.emit("executing",{n:0,total:c.length}),this.logger("executing saved actions",c.length);for(var d=[],e=function(a,b,d){this.emit("executing",{n:a,total:c.length}),this.processAction(b,!0,d)},f=0;f<c.length;f++)f%10===0?d.push(e.bind(this,f,c[f])):d.push(this.processAction.bind(this,c[f],!0));async.series(d,function(b,d){a&&a(b,d),b?(b.type="rt",b.action="executing",this.emit("error",b),this.logger("Error executing "+d.length+" saved actions",b)):(this.logger("executed "+d.length+" actions"),this.emit("executed",c.length))}.bind(this))}.bind(this))},a.prototype.getLastActionId=function(a){for(var b=null,c=a.length-1;c>=0;c--)if(a[c].ack===!0&&a[c].revisionId===this.localRevisionId){b=a[c].id;break}return b},a.prototype.executeAction=function(a,b){return this.logger("executing action",a.id,a.fnc),this.helpers.getData&&Adagio.Data.prototype.hasOwnProperty(a.fnc)?void this.helpers.getData(this.localRevisionId,function(c,d){try{a.args.logs=a.args.logs||[],a.args.logs.push({date:new Date,context:"rt.exec",user:this.uid,revision:this.localRevisionId,editorSid:this.editorSid,dataSid:this.genUuidV4(),rtSid:this.instanceId});var e=Adagio.Utils.clone(a.args);c[a.fnc](e,d),this.executed[a.id]=!0,b&&b(null,a)}catch(c){b&&(c.rt_context="executeAction",c.rt_revision=a.revisionId,c.rt_uid=a.userId,c.rt_eid=a.id,c.rt_eparent=a.parentId,c.rt_adagiofnc=a.fnc,c.rt_adagioargs=a.args,b(c,null))}}.bind(this)):b&&b(new Error("[rt] Can not find data or function "+a.fnc),null)},a.prototype.cleanAction=function(a){return delete a.pid,delete a.instance,delete a.server,delete a._id,delete a.ack,a},a.prototype.emitActions=function(a,b){if(this.saving||!this.connected||!a||0===a.length)return b&&b(null,a);for(var c=0;c<a.length;c++)this.logger("emit action",a[c].id,"with parent id",a[c].parentId),a[c]=this.cleanAction(a[c]);this.getSocket(function(c){return c.emit("edit",a),b&&b(null,a)}.bind(this))},a.prototype.emitAction=function(a,b){this.emitActions([a],function(a,c){return b(a,c.length&&c[0])})},a.prototype.getActions=function(a){if(a)return this.db&&this.db._indexedDB&&this.db._indexedDB.setup?void this.db.getActionsForScore(this.scoreId,a):a(new Error("Database doesn't exist"),[])},a.prototype.getAckActions=function(a){if(a)return this.db&&this.db._indexedDB&&this.db._indexedDB.setup?void this.db.getActionsForScore(this.scoreId,function(b,c){if(b)return a(b,c);for(var d=[],e=0;e<c.length;e++)c[e].ack&&this.localRevisionId===c[e].revisionId&&d.push(c[e]);a(null,d)}.bind(this)):a(new Error("Database doesn't exist"),[])},a.prototype.saveAction=function(a,b){return this.db&&this.db._indexedDB&&this.db._indexedDB.setup?void this.db.getActionByEventId(a.id,function(c,d){return c?(this.logger("unable to get action by event id",c),b&&b(new Error("Unable to get action by event id"),a)):void(d?(this.logger("action already exists, updating"),this.db.editActionForScore(a,b)):(this.logger("action didnt exist, adding"),this.db.addActionForScore(a,b)))}.bind(this)):b&&b(new Error("Database doesn't exist"),null)},a.prototype.isReady=function(){return!this.isUnstacking&&null===this.baseUnstackActionId},a.prototype.ready=function(){for(var a=0;a<this.readyCallbacks.length;a++)this.readyCallbacks[a]();this.readyCallbacks=[]},a.prototype.unstack=function(a,b){if(!(this.connected&&this.joined&&this.synced))return b&&b(new Error("not connected or not synced yet"),[]);if(this.saving)return b&&b(new Error("Cannot unstack while saving"),[]);var c=new Date;if(c.setTime(c.getTime()-15e3),!this.isUnstacking&&null!==this.baseUnstackActionId&&c>this.lastEventReceived&&(this.baseUnstackActionId=null),this.isUnstacking||null!==this.baseUnstackActionId)return b&&b(new Error("Already unstacking"),[]);this.isUnstacking=!0,this.lastEventReceived=new Date;var d=function(a,c){b&&b(a,c)}.bind(this);this.getActions(function(b,c){if(b)return d(b,c);var e=this.getLastActionId(c);(a||null===a)&&(e=a);for(var f=[],g=0;g<c.length;g++)c[g].ack===!1&&(c[g].revisionId=this.localRevisionId,c[g].parentId=e,f.push(c[g]),e=c[g].id);this.emit("unstack",{n:0,total:f.length}),f.length&&(this.baseUnstackActionId=f[0].id,this.emitActions(f,d)),this.isUnstacking=!1,0===f.length&&(d(),this.ready())}.bind(this))},a.prototype.removeActionsUntil=function(a,b){this.getActions(function(c,d){if(c)return void(b&&b(c,[]));var e,f=!1;for(e=0;e<d.length;e++)if(d[e].id===a){f=!0;break}if(!f)return void(b&&b(new Error("Not found"),[]));var g=[];this.logger("remove actions:",e+1);for(var h=0;h<=e;h++)g.push(this.db.removeActionById.bind(this.db,d[h].id));async.series(g,b)}.bind(this))},a.prototype.getNumberActions=function(a,b){this.getActions(function(c,d){if(c)return b(c,0);if(!a)return b(null,d.length);for(var e=[],f=0;f<d.length;f++)d[f].revisionId===this.localRevisionId&&e.push(d[f]);return e})},a.prototype.getNumberAckActions=function(a){this.getAckActions(function(b,c){return b?a(b,0):void a(null,c.length)})},a.prototype.cleanup=function(a){return this.localRevisionId?void this.getActions(function(b,c){if(b||!c)return a&&a(b,c);for(var d=[],e=0;e<c.length;e++)c[e].ack&&c[e].revisionId&&c[e].revisionId!==this.localRevisionId&&d.push(this.db.removeActionById.bind(this.db,c[e].id));return d.length?(this.logger("cleaning",d.length,"actions"),void async.series(d,function(b,c){return this.logger("cleaned",c.length,"actions"),a&&a(b,c)}.bind(this))):a&&a(null,[])}.bind(this)):a&&a(new Error("Local Revision undefined"),[])},a.prototype.resetForce=function(){this.getActions(function(a,b){if(!a&&b){for(var c=[],d=0;d<b.length;d++)c.push(this.db.removeActionById.bind(this.db,b[d].id));c.length>0&&(this.logger("cleaning",c.length,"actions"),async.series(c))}}.bind(this)),this.reset()},a.prototype.reset=function(){this.logger("reset executed actions"),this.executed={},this.cleanup(function(){this.executeSavedActions()}.bind(this))},a.prototype.initDBHelpers=function(a,c,d){return a._indexedDB.logger=d,a._indexedDB.exception=c,a.getActionsForScore=function(a,c){return c&&this.setup?(this.isOpen()||(this.logger("initDBHelpers open indexeddb connection"),this.open()),void this.actions.where("scoreId").equals(a).sortBy("_id").then(b(function(a){for(var b,d=[];a.length>0;){for(var e=!1,f=0;f<a.length;f++)if(b&&a[f].parentId===b||!b&&!a[f].parentId){b=e=a[f].id,d.push(a[f]),a.splice(f,1);break}if(!e)break}a.length>0&&(d=d.concat(a)),c(null,d)})).catch("InvalidStateError",function(){c&&c(null,[])}).catch(function(a){this.exception("getActionsForScore",a),c(a,[])}.bind(this))):c&&c(new Error("No database connection opened"),[])}.bind(a._indexedDB),a.getActionByEventId=function(a,c){if(c)return this.setup?(this.isOpen()||(this.logger("getActionByEventId: Open back indexeddb connection"),this.open()),a?void this.actions.where("id").equals(a).toArray(b(function(a){return 0===a.length?c(null,null):void c(null,a[0])})).catch("NotFoundError",function(){c(null,null)}).catch("InvalidStateError",function(){c(null,null)}).catch(function(b){b.param=a,this.exception("getActionByEventId",b),c(null,null)}.bind(this)):c(new Error("action does not have an id"))):c(new Error("No database connection opened"),null)}.bind(a._indexedDB),a.addActionForScore=function(c,d){return this.setup?c.scoreId?c.id?(this.isOpen()||(this.logger("addActionForScore: Open back indexeddb connection"),this.open()),delete c._id,void this.actions.add(c).then(b(function(a){return c._id=a,d&&d(null,c)})).catch("ConstraintError",function(){a.editActionForScore(c,d)}).catch("InvalidStateError",function(){return d&&d(null,c)}).catch(function(a){return this.exception("addActionForScore",a,c),d&&d(a,c)}.bind(this))):d&&d(new Error("action does not have an id"),null):d&&d(new Error("action does not have a scoreId"),null):d&&d(new Error("No database connection opened"),null)}.bind(a._indexedDB),a.bulkAddActionsForScore=function(c,d){return this.setup?(this.isOpen()||(this.logger("addActionForScore: Open back indexeddb connection"),this.open()),void this.actions.bulkAdd(c).then(b(function(){return d&&d(null,c)})).catch("ConstraintError",function(){a.editActionForScore(c,d)}).catch("InvalidStateError",function(){return d&&d(null,c)}).catch(function(a){return this.exception("bulkAddActionForScore",a,c),d&&d(a,c)}.bind(this))):d&&d(new Error("No database connection opened"),null)}.bind(a._indexedDB),a.ackActionByEventId=function(a,c,d,e){return this.setup?a?(this.isOpen()||(this.logger("ackActionByEventId: Open back indexeddb connection"),this.open()),void this.actions.where("id").equals(a).modify({ack:!0,revisionId:c,parentId:d}).then(b(function(){return this.logger("acknowledged action",a),e&&e(null,a)}.bind(this))).catch("InvalidStateError",function(){return e&&e(null,null)}).catch(function(b){return b.param=a,this.exception("ackActionByEventId",b),e&&e(b,null)}.bind(this))):e&&e(new Error("Id is invalid"),null):e&&e(new Error("No database connection opened"),null)}.bind(a._indexedDB),a.editActionForScore=function(a,c){return this.setup?(this.isOpen()||(this.logger("editActionForScore: Open back indexeddb connection"),this.open()),a.id?void this.actions.where("id").equals(a.id).modify({ack:a.ack,revisionId:a.revisionId,parentId:a.parentId}).then(b(function(){return c&&c(null,a)}.bind(this))).catch("InvalidStateError",function(){return c&&c(null,a)}).catch(function(b){return b.param=a.id,this.exception("editActionForScore",b),c&&c(b,null)}.bind(this)):c&&c(new Error("action does not have an id"),null)):c&&c(new Error("No database connection opened"),null)}.bind(a._indexedDB),a.removeActionById=function(a,c){return this.setup?(this.isOpen()||(this.logger("removeActionById: Open back indexeddb connection"),this.open()),a?void this.actions.where("id").equals(a).delete().then(b(function(){return c&&c(null,null)})).catch("InvalidStateError",function(){return c&&c(null,null)}).catch(function(b){return b.param=a,this.exception("removeActionById",b),c&&c(b,null)}.bind(this)):c&&c(new Error("id "+a+" is invalid"),null)):c&&c(new Error("No database connection opened"),null)}.bind(a._indexedDB),a.getOrphanActions=function(a){if(a){if(!this.setup)return a(new Error("No database connection opened"),null);this.isOpen()||(this.logger("getOrphanActions: Open back indexeddb connection"),this.open()),this.actions.where("scoreId").anyOf("").toArray(b(function(c){this.actions.where("id").anyOf("").toArray(b(function(b){for(var d=0;d<b.length;d++)c.push(b[d]);a(null,c)}))}.bind(this))).catch(function(b){this.exception("getOrphanActions",b),a(b,null)}.bind(this))}}.bind(a._indexedDB),a},a}();"undefined"!=typeof module&&(module.exports=FlatRt);
//# sourceMappingURL=rt.min.js.map