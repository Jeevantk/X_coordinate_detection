/*!
 * Copyright (c) 2017 Flat - Tutteo Ltd. <hello@flat.io>
 * https://flat.io
 */

angular.module("flat.dashboard.controllers",[]),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.AccountCtrl",["$timeout","$rootScope","$scope","$location","$analytics","MessageService","User","UserData","Experience","CloudMessaging",function(a,b,c,d,e,f,g,h,i,j){"use strict";b.pageTitle=i18n.t("flat:pageTitle.account-settings"),c.noValidationWarn=!0,c.CloudMessaging=j,a(function(){c.desktopNotifications={isSupported:j.isSupported(),isSubscribed:j.isSubscribed()}},1e3),c.hasGoogleFeature=function(a){return b.account.googleUsedFeatures&&b.account.googleUsedFeatures.indexOf(a)>=0},c.refreshUser=function(){c.user.locale=c.user.locale||window.i18n.options.lng,c.user.newsletter=!!c.user.newsletterSubscribeTime},c.user=b.account=h,c.refreshUser(),d.search().error&&f.broadcast(d.search().error,{color:"danger"}),d.search().askValidation&&g.askValidation({},function(){f.broadcast(i18n.t("flat:account.askValidationSuccess"),{color:"success"}),b.account.emailValidationDate=Date()},function(a){c.displayErrors(a,null,!0)}),c.unlinkAccount=function(a){g[a+"Unlink"](function(){c[a+"Details"]=null},function(a){c.displayErrors(a,null,!0)})},c.changePassword=function(){g.put({password:c.password},function(a){c.formPassword.$setPristine(!0),f.broadcast(i18n.t("flat:account.password-changed"),{color:"success"}),c.user=a,delete c.password,delete c.passwordRetype},function(a){c.displayErrors(a,null,!0)})},c.updateDesktopNotifications=function(){c.CloudMessaging.isSubscribed()?c.CloudMessaging.unsubscribe().then(function(){f.broadcast(i18n.t("flat:account.notifications.desktop.unsubscribe.success"),{color:"success"})}).catch(function(){f.broadcast(i18n.t("flat:account.notifications.desktop.unsubscribe.failure"),{color:"danger"})}).finally(function(){c.desktopNotifications.isSupported=c.CloudMessaging.isSupported(),c.desktopNotifications.isSubscribed=c.CloudMessaging.isSubscribed()}):c.CloudMessaging.subscribe().then(function(){f.broadcast(i18n.t("flat:account.notifications.desktop.subscribe.success"),{color:"success"}),new Notification("Flat",{body:i18n.t("flat:account.notifications.desktop.subscribe.success"),icon:"/img/logo-f-196.png"})}).catch(function(){f.broadcast(i18n.t("flat:account.notifications.desktop.subscribe.failure"),{color:"danger"})}).finally(function(){c.desktopNotifications.isSupported=c.CloudMessaging.isSupported(),c.desktopNotifications.isSubscribed=c.CloudMessaging.isSubscribed()})},c.updateAccount=function(e){var h={};if("delete"===e)h.delete=!0;else if("account"===e)h.email=c.user.email,h.username=c.user.username,h.name=c.user.name,h.bio=c.user.bio,h.locale=c.user.locale;else if("newsletter"===e)h.newsletter=c.user.newsletter;else if("googlePreferences"===e)h.googlePreferences={driveFlatSharingDialog:c.user.googlePreferences.driveFlatSharingDialog,driveSyncDeletions:c.user.googlePreferences.driveSyncDeletions};else if("notifications"===e)h.notifications={onboarding:c.user.notifications.onboarding,scoreInvitation:c.user.notifications.scoreInvitation,scoreComment:c.user.notifications.scoreComment,scoreStar:c.user.notifications.scoreStar,userFollow:c.user.notifications.userFollow,classroomSubmission:c.user.notifications.classroomSubmission,classroomSubmissionReturned:c.user.notifications.classroomSubmissionReturned};else if("privateProfile"===e){if(!b.account.plan||!b.account.plan.features||!b.account.plan.features.privateProfile)return d.path("/settings/upgrade").search("ref","private-profile");h.privateProfile=c.user.privateProfile}g.put(h).$promise.then(function(d){c.formPassword&&c.formPassword.$setPristine(!0),c.pageLayout&&c.pageLayout.$setPristine(!0),h.delete&&!c.user.deletionDate?(f.broadcast(i18n.t("flat:account.delete.scheduled"),{color:"success"}),a(function(){window.location="/auth/logout"},5e3)):h.delete&&c.user.deletionDate?f.broadcast(i18n.t("flat:account.delete.unscheduled"),{color:"success"}):f.broadcast(i18n.t("flat:account.updated"),{color:"success"}),b.account=c.user=d,c.refreshUser(),delete c.password}).catch(function(a){b.displayErrors(a,null,!0)})},c.$watch("ppFile",function(a){if(a&&!a.$error){c.ppFileLoading=!0;var d=new FileReader;d.readAsDataURL(a),d.onload=function(a){var d=new Image;d.src=a.target.result,d.onload=function(){var a={width:128,height:128};smartcrop.crop(d,a).then(function(e){var f=e.topCrop,h=$("<canvas>")[0],j=h.getContext("2d");h.width=a.width,h.height=a.height,j.drawImage(d,f.x,f.y,f.width,f.height,0,0,h.width,h.height);var k=h.toDataURL("image/jpeg").replace("data:image/jpeg;base64,","");g.uploadProfilePicture({file:k},function(a){c.ppFileLoading=!1,b.account.picture=a.picture,i.add("profile.picture")},function(a){c.ppFileLoading=!1,b.displayErrors(a,null,!0)})})}}}}),d.search().unsub&&c.user.notifications[d.search().unsub]&&(c.user.notifications[d.search().unsub].email=!1,c.updateAccount("notifications")),c.isChromeUser=window.chrome,c.cwsInstalled=function(){return window.chrome&&window.chrome.app&&window.chrome.app.isInstalled},c.cws=function(){var b="https://chrome.google.com/webstore/detail/mgfkpiieempkmppimblkblmlcmbdkbcg",d="?utm_source=flat&utm_medium=flat-account&utm_campaign=flat-linked-accounts";e.pageTrack("/account/linked/google/chrome-app"),c.isChromeUser&&"undefined"!=typeof chrome&&chrome.webstore&&chrome.webstore.install?c.cwsInstalled()?window.location=b+"/reviews"+d:chrome.webstore.install(b,function(){e.pageTrack("/account/linked/google/chrome-app/done"),a(angular.noop)},function(){window.location=b+d}):window.location=b+d}}]),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.AccountSummaryCtrl",["$rootScope","$scope","$location","$analytics","UserData","Gifts",function(a,b,c,d,e,f){"use strict";return!e.organization&&e.plan.name.indexOf("indiv-free")<0?c.path("/settings/account").replace():(a.pageTitle=i18n.t("flat:account.summary-title"),b.redeemGift=function(b){return!!b&&void f.redeem({id:b},function(){a.fetchUser()},function(b){a.displayErrors(b,null,!0)})},void(c.search().gift&&b.redeemGift(c.search().gift)))}]),function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(){h("btn-trial")}function j(a){"Enter"===a.key&&$("#btn-trial").click()}function k(a){m.activating=!0,f.activateTrial({action:a},function(c){b.account.plan.trials=c,b.account.plan.features[a]=!0,"advancedHistory"===a&&(0===d.path().indexOf("/score")?d.path(d.path()+"/history"):g.broadcast(i18n.t("flat:trial-history-modal.success"),{color:"success"})),m.closeModal()},function(a){m.activating=!1,b.displayErrors(a,null,!0)})}function l(){$(".modal").modal("hide")}var m=this;return"indiv-power"===b.account.plan.name?($(".modal").remove(),!1):(m.closeModal=l,m.activate=k,m.pressEnter=j,e.pageTrack("/modal/trial-smart-history"),$(".modal").on("hidden.bs.modal",c.hideModal).on("shown.bs.modal",i).modal("show"),void c.$on("$destroy",c.hideModal))}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.AccountTrialModal",a),a.$inject=["$log","$rootScope","$scope","$location","$analytics","User","MessageService","focus"]}(),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.AccountUpgradeCtrl",["$rootScope","$scope","$location",function(a,b,c){return a.account.organization?"admin"!==a.account.organizationRole?c.path("/license-expired").replace():c.path("/settings/your-plan").replace():(!a.account.subscription||!a.account.subscription.status||a.account.subscription.cancelAtPeriodEnd||a.account.subscription.cancelDate||a.account.plan.upgradable||(c.path("/profile").search({}).replace(),window.location="/pricing"),b.hfeature=c.search().hf,b.coupon=c.search().c||c.search().cy||c.search().cl,b.couponYearlyOnly=!!c.search().cy,b.couponLifeOnly=!!c.search().cl,b.referral=c.search().ref,void(b.step=c.search().step))}]),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.AccountUpgradePaypalCtrl",["$analytics","$location","$rootScope","$scope","PaypalAgreement","User","FrontendEvent","UxStore",function(a,b,c,d,e,f,g,h){return d.funnel=h.get("paypal.funnel"),g.push({funnel:{id:d.funnel},event:{type:"page",category:"upgrade-indiv",name:"paypal-callback"}}),b.search().token?(c.account.hidenav=!0,e.execute({token:b.search().token},function(){f.getNoCache({upgraded:!0},function(a){c.account.subscription=a.subscription,c.account.plan=a.plan,c.account.license=a.license,c.account.hidenav=!1,c.loadModal("dashboard","upgrade-success")}),g.push({funnel:{id:d.funnel,completed:!0}})},function(a){return c.displayErrors(a,null,!0),g.push({funnel:{id:d.funnel,completed:!1},event:{type:"error",category:"upgrade-indiv",name:"subscription",properties:a}}),c.account.hidenav=!1,b.path("/settings/upgrade").search({ref:"paypal-failure",step:"payment"})}),void a.pageTrack("/settings/upgrade/success-paypal")):b.path("/settings/upgrade").search({ref:"paypal-failure",step:"payment"})}]),function(){"use strict";function a(a,b,c,d,e){function f(){return d.path("/settings/upgrade").search({hl:"unlimited-private-scores",ref:h.ref})}function g(a){"Enter"===a.key&&f()}var h=this;h.ref=c.flat.modalData.ref||"limit-private-scores-modal",h.mode=c.flat.modalData.mode||"new",h.upgradeRedirection=f,h.pressEnter=g,d.search("m","scores-upgrade"),e.pageTrack("/dashboard/modal/scores-upgrade"),$(".modal").modal("show").on("hidden.bs.modal",b.hideModal)}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.AccountUpgradeScores",a),a.$inject=["$log","$rootScope","$scope","$location","$analytics"]}(),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.AccountUpgradeSuccessCtrl",["$timeout","$analytics","$location","$scope",function(a,b,c,d){b.pageTrack("/settings/upgrade/success-page"),a(function(){c.search({m:null}),d.hideModal()},4e3),function(){var a=350,b=[[255,183,51],[245,115,54],[194,33,33],[217,0,0],[248,182,70]],c=2*Math.PI,d=document.getElementById("confettis"),e=d.getContext("2d"),f=.5,g=d.width=window.innerWidth,h=d.height=window.innerHeight,i=function(a,b){return(b-a)*Math.random()+a},j=function(a,b,d,f){return e.beginPath(),e.arc(a,b,d,0,c,!1),e.fillStyle=f,e.fill()},k=window.requestAnimationFrame,l=function(){function a(){this.style=b[~~i(0,5)],this.rgb="rgba("+this.style[0]+","+this.style[1]+","+this.style[2],this.r=~~i(2,6),this.r2=2*this.r,this.replace()}return a.prototype.replace=function(){this.opacity=0,this.dop=.03*i(1,4),this.x=i(-this.r2,g-this.r2),this.y=i(-20,h-this.r2),this.xmax=g-this.r,this.ymax=h-this.r,this.vx=i(0,2)+8*f-5,this.vy=.7*this.r+i(-1,1)},a.prototype.draw=function(){var a;return this.x+=this.vx,this.y+=this.vy,this.opacity+=this.dop,this.opacity>1&&(this.opacity=1,this.dop*=-1),(this.opacity<0||this.y>this.ymax)&&this.replace(),(a=this.x)>0&&a<this.xmax||(this.x=(this.x+this.xmax)%this.xmax),j(~~this.x,~~this.y,this.r,this.rgb+","+this.opacity+")")},a}(),m=function(){var b,c,d,e;for(e=[],b=c=1,d=a;d>=1?c<=d:c>=d;d>=(b=1)?++c:--c)e.push(new l);return e}(),n=function(){var a,b,c,d;for(k(n),e.clearRect(0,0,g,h),d=[],b=0,c=m.length;b<c;b++)a=m[b],d.push(a.draw());return d};n()}.call(this)}]),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.AccountUpgradeSurveyCtrl",["$analytics","$rootScope","$scope","$location","$timeout","FrontendEvent","Offers","focus","UxStore",function(a,b,c,d,e,f,g,h,i){c.hide=function(){c.hidden=!0,d.search("m",null),e(function(){b.flat.modal=null},300)},c.chooseSurveyKey=function(a){c.surveyKey=a,f.push({funnel:{id:b.upgradeFunnel,survey:{answerKey:a}}}),i.set("upgrade-survey.last",new Date),e(function(){h("price"===a?"survey-price":"survey-text")},500)},c.submitDetails=function(){var a={id:b.upgradeFunnel,survey:{answerKey:c.surveyKey,answerText:c.surveyText,properties:{}}};"price"===c.surveyKey&&(a.survey.properties.price=c.price,a.survey.properties.currency=c.currency),f.push({funnel:a}),i.set("upgrade-survey.last",new Date),c.thanks=!0,e(function(){c.hide()},2e3)},a.pageTrack("/settings/upgrade/survey-page"),c.hidden=!0,e(function(){c.hidden=!1}),f.push({funnel:{id:b.upgradeFunnel},event:{type:"page",category:"upgrade-indiv",name:"survey"}}),c.currency="USD",g.query(function(a){c.currency=a[0].priceWithVAT.currencyCode})}]),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.AccountValidationEmailCtrl",["$rootScope","$scope","$routeParams","$location","User",function(a,b,c,d,e){"use strict";b.errors=[],e.validateEmail({validation:c.validation},function(b){a.account=b,a.account.emailValidationDate=new Date,d.path("/profile").replace()},function(){d.path("/profile").replace()})}]),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.AnalyticsCtrl",["_","$rootScope","$scope","$location","$log","$filter","User","UserData","UserScoresIDB","$q","Experience",function(a,b,c,d,e,f,g,h,i,j,k){function l(a,b){c.loadScores(b)}c.stats={},c.totals={},c.users={},c.scores={},c.grouped={},c.sorted={},c.fans={},c.fansSorted={},c.durationInDays=30,c.durationInDaysViews=30,c.ordering="views",c.fansOrdering="likes",c.isLoading={},b.pageTitle=i18n.t("flat:pageTitle.stats"),c.loadScores=function(a){for(var b=0;b<a.length;b++)c.scores[a[b].id]=a[b]},c.$on("IDBObjectUpdate.UserScores",l),i.query({user:"me"},{strategy:"cacheFirst",broadcastUpdate:!0,cache:!0}).then(function(a){c.loadScores(a)}),c.loadUser=function(a){a&&!c.users[a]&&(c.users[a]=g.get({user:a}))},c.loadStats=function(b,d){if(d?c.durationInDaysViews=b:c.durationInDays=b,!c.stats[b]){c.isLoading[b]=!0,c.stats[b]={},c.stats[b].likes=g.starsStats({duration:2*b}),c.stats[b].comments=g.commentsStats({duration:2*b}),c.stats[b].dropped=g.notesDroppedStats({duration:2*b}),c.stats[b].played=g.playedStats({duration:2*b}),c.stats[b].views=g.viewsStats({duration:2*b}),j.all(a.map(c.stats[b],"$promise")).then(function(){c.calcTotals(b),c.filterBeforeDate(b),c.groupByScore(b)});var e=a.map(c.stats[b],"$promise");0===b&&(c.fans[b]=g.bestFansStats({duration:0}),c.fans[b].$promise.then(function(){c.sortFans(b)}),e.push(c.fans[b].$promise)),j.all(e).then(function(){c.isLoading[b]=!1})}},c.groupByScore=function(b){var d={};if(!c.grouped[b]){c.grouped[b]=[];var e=a.keys(c.stats[b]);a.each(c.stats[b],function(b,c){["views","likes","comments"].indexOf(c)!==-1&&a.each(b,function(b){d[b.score]||(d[b.score]={score:b.score},a.each(e,function(a){d[b.score][a]=0})),d[b.score][c]+=b.count})}),c.grouped[b]=a.values(d),c.sortScores(b)}},c.sortScores=function(b){c.sorted[b]={},c.sorted[b].views=a.slice(a.orderBy(c.grouped[b],["views"],["desc"]),0,10),c.sorted[b].likes=a.slice(a.orderBy(c.grouped[b],["likes"],["desc"]),0,10),c.sorted[b].comments=a.slice(a.orderBy(c.grouped[b],["comments"],["desc"]),0,10)},c.sortFans=function(b){for(var d=0;d<c.fans[b].length;d++)c.fans[b][d].likes=c.fans[b][d].likes||0,c.fans[b][d].comments=c.fans[b][d].comments||0;c.fansSorted[b]={},c.fansSorted[b].likes=a.slice(a.orderBy(c.fans[b],["likes"],["desc"]),0,10),c.fansSorted[b].comments=a.slice(a.orderBy(c.fans[b],["comments"],["desc"]),0,10),a.each(c.fansSorted[b],function(b){a.each(b,function(a){c.loadUser(a.user)})})},c.changeOrdering=function(a){c.ordering=a},c.changeFansOrdering=function(a){c.fansOrdering=a},c.calcTotals=function(a){c.totals[a]={};for(var b in c.stats[a])if(c.stats[a].hasOwnProperty(b)){for(var d=0,e=0,f=moment().subtract(a,"days").toDate(),g=0;g<c.stats[a][b].length;g++)0===a||moment(c.stats[a][b][g].date).toDate()>f?d+=c.stats[a][b][g].count:e+=c.stats[a][b][g].count;c.totals[a][b]={current:d,previous:e,evolution:(d-e)/(e||1)*100}}},c.filterBeforeDate=function(a){for(var b in c.stats[a])if(c.stats[a].hasOwnProperty(b)){for(var d=[],e=moment().subtract(a,"days").toDate(),f=0;f<c.stats[a][b].length;f++)(0===a||moment(c.stats[a][b][f].date).toDate()>e)&&d.push(c.stats[a][b][f]);c.stats[a][b]=d}},h.plan&&h.plan.features.analytics?(c.loadStats(0),c.loadStats(30),k.add("profile.analytics.viewed")):k.add("profile.analytics.intented")}]),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.SettingsBillingCtrl",["$scope","$rootScope","$location","BillingDetails","UserData",function(a,b,c,d,e){"use strict";return e.subscription&&e.subscription.status&&"canceled"!==e.subscription.status&&!e.subscription.cancelAtPeriodEnd?void(a.paymentMeans=d.queryCards(function(c){for(var d=0;d<c.length;d++)if(!b.account.preferredPaymentMean||b.account.preferredPaymentMean===c[d].id){a.pm=c[d];break}})):c.path("/settings/upgrade").search("ref","no-billing").replace()}]),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.SettingsBillingHistoryCtrl",["$rootScope","$scope","$location","$log","$filter","OrdersV2","LicensePools","UserData","Currencies",function(a,b,c,d,e,f,g,h,i){var j=["JPY","KRW"];b.sumLicenses=0,b.activeLicenses=0,b.freeLicenses=0,b.success=a.success,b.errors=a.errors,a.success=null,a.errors=[],async.parallel([function(a){b.orders=f.query(function(b){return h.organization||0!==b.length?(b.forEach(function(a){a.creationDate=new Date(a.creationDate)}),void a()):c.path("/settings/upgrade").search("ref","no-billing").replace()})},function(a){return h.organization?(b.noPools=!1,void(b.pools=g.query(function(){b.pools.forEach(function(a){if("trial"!==a.source){var c=new Date(a.expirationDate);(!a.expirationDate||c>new Date)&&(b.sumLicenses+=a.totalLicenses,b.freeLicenses+=a.freeLicenses,b.activeLicenses+=a.totalLicenses-a.freeLicenses)}}),a()}))):(b.noPools=!0,a())}],function(){}),b.getActiveLicensesPercentage=function(){return b.activeLicenses/b.sumLicenses*100},b.getPriceWithCurrency=function(a){if(a&&a.totalPayed){var b=a.totalPayed.value;return j.indexOf(a.totalPayed.currencyCode)<0&&(b=e("number")(b,2)),i[a.totalPayed.currencyCode].moneyFormat.replace("{amount}",b)}}}]),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.SettingsBillingHistoryPDFCtrl",["$routeParams","$http","$location",function(a,b,c){var d=window.location.protocol+"//"+window.location.host+"/api/v2/orders/"+encodeURIComponent(a.order)+"/pdfInvoice?download=true";b.defaults.headers.common["x-flat-request-as"]&&(d+="&x-flat-request-as="+b.defaults.headers.common["x-flat-request-as"]),window.location=d,c.path("/settings/b-history")}]),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.SettingsBillingRoutingCtrl",["$location","UserData",function(a,b){"use strict";a.path(b.organization?"/settings/school/billing":"/settings/account/billing").replace()}]),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.SettingsBillingUpdateCtrl",["$rootScope","$scope","$location","$timeout","$log","BillingDetails","Offers","UserData",function(a,b,c,d,e,f,g,h){"use strict";return h.subscription&&h.subscription.status&&!h.subscription.cancelAtPeriodEnd?(g.query({id:h.subscription.offer},function(a){0===a.length?e.warn("Offer not found",{extra:{subscription:h.subscription}}):(b.offer=a[0],b.duration=i18n.t("flat:"+(365===b.offer.durationInDays?"year":"month")))}),b.paymentMeans=f.queryCards(),b.stripeCountry=a.account.billingCompany,b.success=!1,b.processing=!1,void(b.updatePM=function(e){a.account.preferredPaymentMean=e.id,async.each(b.paymentMeans,function(a,b){f.deleteCard({pm:a.id},b.bind(b,null),b.bind(b,null))},function(){b.success=!0,b.processing=!1,d(function(){c.path("/settings/account/billing").replace()},1e3)})})):c.path("/settings/upgrade").search("ref","no-billing").replace()}]),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.SettingsSubscriptionCancelCtrl",["$rootScope","$scope","$location","Subscription","User",function(a,b,c,d,e){"use strict";return!a.account.subscription||"active"!==a.account.subscription.status||a.account.subscription.cancelAtPeriodEnd?c.path("/settings/upgrade").search("ref","no-billing").replace():(b.end=moment(a.account.subscription.currentPeriodEndDate).format("LL"),void(b.cancel=function(){b.errors=null,b.processing=!0,d.cancel(function(){b.done=!0,b.processing=!1,e.getNoCache(function(b){a.account.subscription=b.subscription})},function(c){b.errors=a.displayErrors(c),b.processing=!1})}))}]),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.SideMenuCtrl",["$timeout",function(a){"use strict";a(function(){$(".side-menu").find('[data-toggle="tooltip"]').tooltip({delay:{show:200}})},2e3)}]),function(){"use strict";function a(a,b){var c;return b.get("redirect.next")&&(c=b.get("redirect.next"),b.remove("redirect.next")),b.get("redirect.next-logged")&&(c=b.get("redirect.next-logged"),b.remove("redirect.next-logged")),c?void("string"==typeof c?a.path(c):(c.path&&a.path(c.path),c.search&&a.search(c.search))):"undefined"!=typeof domain&&domain&&"scores"!==a.search().next?a.path("/class").replace():void a.path("/profile").replace()}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.HomeCtrl",a),a.$inject=["$location","UxStore"]}(),function(){"use strict";function a(){window.location="/auth"}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.HomeGoAuthCtrl",a)}(),function(){"use strict";function a(a,b,c,d,e,f){function g(){f("btn-indiv2edu")}function h(a){if("Enter"===a.key)return i()}function i(){d.eventTrack("discover",{category:"edu.indiv2edu"}),window.location="/edu"}function j(){d.eventTrack("skip",{category:"edu.indiv2edu"}),b.hideModal()}b.go=i,b.close=j,b.pressEnter=h,c.search({m:"indiv2edu"}),d.eventTrack("displayed",{category:"edu.indiv2edu"}),d.pageTrack("/indiv2edu"),e.set("indiv2edu.displayed",new Date),b.$on("$destroy",j),$(".modal").on("shown.bs.modal",g).on("hidden.bs.modal",j).modal("show"),$(".modal-backdrop").addClass("visible-header white")}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.Indiv2EduCtrl",a),a.$inject=["$rootScope","$scope","$location","$analytics","UxStore","focus"]}(),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.LtiContentPickerCtrl",["$rootScope","$scope","$timeout","$sce","UserScoresV2","ScoreV2","Lti",function(a,b,c,d,e,f,g){"use strict";function h(a){return _.extend({"@type":"ContentItem",icon:{"@id":"https://flat.io/img/logo-f.svg",width:48,height:48}},a)}function i(a,b){return"public"===a.privacy||"organizationPublic"===a.privacy?b():void f.put({id:a.id,privacy:"organizationPublic"}).$promise.then(function(){b()}).catch(function(a){b(a)})}function j(a,b){var c=baseurl+"/embed/"+a.id;if("public"===a.privacy||"organizationPublic"===a.privacy)return b(null,c);if("privateLink"===a.privacy)return c+="?sharingKey="+a.sharingKey,b(null,c);var d=f.generateSharingKey();f.put({id:a.id,privacy:"privateLink",sharingKey:d}).$promise.then(function(){return c+="?sharingKey="+d,b(null,c)}).catch(function(a){return b(a,c)})}var k=debug("lti");b.ids=[],b.jsonLd={"@context":"http://purl.imsglobal.org/ctx/lti/v1/ContentItem","@graph":[]},b.canEmbed=a.ltiRequest.accept_presentation_document_targets.indexOf("embed")>=0,e.query({user:"me"}).$promise.then(function(a){b.scores=a,a.forEach(function(a){b.ids.push(a.id)})}),b.linkScore=function(a,c){var d;return d=a?baseurl+"/lti/launch/score/"+a.id:baseurl+"/lti/launch",c&&(d+="/fork"),b.jsonLd["@graph"]=[h({"@type":"LtiLinkItem",mediaType:"application/vnd.ims.lti.v1.ltilink",title:a?"Flat: "+a.title:"Create a new score with Flat",url:d,placementAdvice:{displayWidth:"100%",displayHeight:"100%",presentationDocumentTarget:"frame"}})],k("link score: %O",b.jsonLd["@graph"]),a?void i(a,b.sendResponse):b.sendResponse()},b.embedScore=function(c){j(c,function(d,e){if(a.ltiRequest.accept_presentation_document_targets.indexOf("iframe")>=0)b.jsonLd["@graph"]=[h({url:e,title:c.title,placementAdvice:{displayWidth:"100%",displayHeight:500,presentationDocumentTarget:"iframe"}})],k("iframe: %O",b.jsonLd["@graph"]);else{if(!(a.ltiRequest.accept_presentation_document_targets.indexOf("embed")>=0&&(a.ltiRequest.accept_media_types.indexOf("text/html")>=0||a.ltiRequest.accept_media_types.indexOf("*/*")>=0)))return b.linkScore(c);b.jsonLd["@graph"]=[h({text:'<iframe src="'+e+'" height="500" width="100%" frameBorder="0" allowfullscreen></iframe>',mediaType:"text/html",placementAdvice:{presentationDocumentTarget:"embed"}})],k("embed: %O",b.jsonLd["@graph"])}b.sendResponse()})},b.defaultScoreAction=function(a){return b.canEmbed?b.embedScore(a):b.linkScore(a)},b.sendResponse=function(){b.trustedLtiUrl=d.trustAsResourceUrl(a.ltiRequest.content_item_return_url),b.ltiJsonLd=JSON.stringify(b.jsonLd),g.contentSigner({url:a.ltiRequest.content_item_return_url,consumerKey:a.ltiRequest.oauth_consumer_key,content:b.ltiJsonLd,tcData:a.ltiRequest.data}).$promise.then(function(a){b.contentResponse=a,c(function(){$("#ltiResponse").submit()})}).catch(function(b){a.displayErrors(b,null,!0)})},b.$on("ObjectUpdate.Score",function(a,c){b.ids.indexOf(c.id)<0&&(k("new score, pushing default action %o",c),b.defaultScoreAction(c))})}]),function(){"use strict";function a(a,b,c,d,e,f,g){function h(d,e){f.getMetaForNotification(e).then(function(){a.findIndex(c.allNotifications,{id:e.id})===-1&&(c.allNotifications.unshift(e),c.unseenNotifications+=1,b.unseenNotifications=c.unseenNotifications)})}c.allNotifications=g||[],c.unseenNotifications=a.filter(c.allNotifications,{seen:!1}).length,c.unseenNotifications>0&&e.markAllAsSeen(function(){for(var d=0;d<c.allNotifications.length;d++)c.allNotifications[d].seen=!0;b.unseenNotifications=c.unseenNotifications=a.filter(c.allNotifications,{seen:!1}).length}),d.add("notifications.list-all"),c.$on("ObjectUpdate.Notification",h)}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.ActivityCtrl",a),a.$inject=["_","$rootScope","$scope","Experience","Notifications","NotificationsResolver","NotificationsData"]}(),function(){"use strict";function a(a,b,c,d,e){var f=window.location.search;f.length>0&&(f=f.substring(1));var g=function(c){b.processing=a.displayLoader=c},h=function(a){g(!0),window.location=a};b.oauthCancel=function(){b.authz?h(b.authz.denyUrl):c("/dashboard")},b.oauthAuthorize=function(a){g(!0),e.process({qs:f,challengeToken:a},function(a){h(a.redirectUrl)},function(a){g(!1),b.oauthError=a.data.message,delete b.authz})},e.start({qs:f},function(a){b.authz=a,b.scopes=[],a.newScopes.forEach(function(a){b.scopes.push(i18n.t("flat:oauth.scope."+a.replace(".","_")))}),"offline"===c.search().access_type&&"token"!==c.search().response_type&&b.scopes.push(i18n.t("flat:oauth.scope.offline")),0===b.scopes.length&&b.oauthAuthorize(a.challengeToken)},function(a){401===a.status?(d.set("redirect.next-logged",{path:c.path(),search:angular.copy(c.search())}),window.location="/auth"):b.oauthError=a.data?a.data.message:"Fatal error"})}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.OAuthAuthorizeCtrl",a),a.$inject=["$rootScope","$scope","$location","UxStore","AppOAuthAuthorize"]}(),function(){"use strict";function a(a,b,c,d,e){return a.organization&&a.organization._id?c.path("/popular/monthly").replace():(a.pageTitle=i18n.t("flat:pageTitle.popular"),b.scores=e,void d.add("popular.list"))}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.PopularCtrl",a),a.$inject=["$rootScope","$scope","$location","Experience","ScoresData"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){function h(a,b){g.get({id:b.id},{strategy:"networkOnly",cache:!0})}function i(a,b){d.scoreComments.put(b)}function j(b,c){d.scores.get(c.score).then(function(b){var e=a.findIndex(b.collaborators,{id:c.id});e<0?b.collaborators.push(c):b.collaborators[e]=a.merge(b.collaborators[e],c),d.scores.put(b)})}c.$on("ObjectUpdate.Score",h),c.$on("ObjectUpdate.ScoreComment",i),c.$on("ObjectUpdate.ScoreCollaborator",j)}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.PushCtrl",a),a.$inject=["_","$rootScope","$scope","PersistenceService","User","UserScoresIDB","ScoreIDB"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j){function k(){l().then(m)}function l(){return i.get({locale:b.account.locale||"en"}).$promise.then(function(b){I.instruments=b.instruments;var c=a.findIndex(I.instruments.$sort,function(a){return a.name.indexOf("unpitched")>=0});c>=0&&I.instruments.$sort.splice(c,1),I.selectedSoundGroupIdx=0,I.selectedSoundGroup=I.instruments.$sort[I.selectedSoundGroupIdx]})}function m(){I.sectionIdx=0,I.section=J[I.sectionIdx];var a=I.instruments.$sort[0];v(a),I.transposition.note=Object.keys(I.transpositionNotes)[0]}function n(a){return"base"===a?I.instrument.icon:"staves-clefs"===a?!(I.instrument.staves<=0||I.instrument.clefs.length!==I.instrument.staves||1===I.instrument.clefs.length&&"TAB"===I.instrument.clefs[0].sign):"transposition"===a?I.transposition.note.length:"sound"===a?I.selectedSoundInstrument&&I.instrument.midichannel.default.program:"name"===a?I.instrument.longname.length&&I.instrument.shortname.length:void 0}function o(a){if(a){var b=J.indexOf(a);b>=0&&b<I.sectionIdx&&(I.sectionIdx=b,I.section=J[I.sectionIdx])}}function p(){I.sectionIdx>0&&J[I.sectionIdx-1]&&(I.sectionIdx-=1,I.section=J[I.sectionIdx])}function q(){I.sectionIdx<J.length-1&&J[I.sectionIdx+1]&&n(I.section)&&(I.sectionIdx+=1,I.section=J[I.sectionIdx])}function r(){j.put({instrument:I.instrument.id},I.instrument).$promise.then(function(a){h.broadcast(i18n.t("flat:score.create-instrument-modal.edition-success"),{color:"success"}),c.onInstrumentUpdate&&(c.onInstrumentUpdate(a),I.instrument.id=null,F())}).catch(function(a){b.displayErrors(a,null,!0)})}function s(){j.post(I.instrument).$promise.then(function(a){h.broadcast(i18n.t("flat:score.create-instrument-modal.creation-success"),{color:"success"}),c.onInstrumentCreation&&(c.onInstrumentCreation(a),I.instrument.id=null,F())}).catch(function(a){b.displayErrors(a,null,!0)})}function t(a,b){"Enter"===a.key&&n(b)&&("name"===b?I.instrument.id?r():s():q())}function u(a){return"/img/icons/music/keysel-"+a.l.toLowerCase()+a.n+(a.o||0)+".svg"}function v(a){var b=a.instruments[0];w(a,I.instruments[a.name][b])}function w(b,c){I.instrument.icon="custom-"+b.name,I.instrument.staves=c.staves||0,I.instrument.transposechromatic=c.transposechromatic||0,I.instrument.transposediatonic=c.transposediatonic||0,I.instrument.midichannel.default.program=c.midichannel.default.program,I.instrument.clefs=[];for(var d=0;d<c.clefs.length;d++)I.instrument.clefs.push({sign:c.clefs[d].sign,"clef-octave-change":parseInt(c.clefs[d]["clef-octave-change"]||0)});if("TAB"===I.instrument.clefs[0].sign&&1===I.instrument.clefs.length)for(var e=0;e<c.alternativeClef.length;e++)I.instrument.clefs.push({sign:c.alternativeClef[e].sign,"clef-octave-change":parseInt(c.alternativeClef[e]["clef-octave-change"]||0)}),I.instrument.staves+=1;I.selectedBaseGroup=b,I.selectedBaseInstrument=c;var f=a.findIndex(I.instruments.$sort,{name:b.name});f>=0&&(I.selectedSoundGroupIdx=f,I.selectedSoundGroup=b,I.selectedSoundInstrument=c)}function x(a){var b=Adagio.Utils.clefUtils.create(a.l,a.n);"undefined"!=typeof a.o&&Adagio.Utils.clefUtils.setOctaveChange(b,a.o);var c={sign:b.sign,displayedSign:b.sign,"clef-octave-change":parseInt(b["clef-octave-change"]||0)};if(("C"===b.sign||"F"===b.sign&&"4"!==b.line)&&(c.displayedSign=b.sign+b.line),0!==c["clef-octave-change"]){var d=c["clef-octave-change"]<0?-1:1;c.clefDetails=8*c["clef-octave-change"],Math.abs(a["clef-octave-change"])>1&&(c.clefDetails-=1*d)}I.instrument.clefs.push(c),I.instrument.staves=I.instrument.clefs.length}function y(a){I.instrument.clefs[a]&&0!==I.instrument.staves&&(I.instrument.clefs.splice(a,1),I.instrument.staves=I.instrument.clefs.length)}function z(a){I.transposition.note=a,B()}function A(a){I.transposition.octave=a,B()}function B(){I.transposition.note&&(I.instrument.transposediatonic=I.transpositionNotes[I.transposition.note].diatonic+7*I.transposition.octave,I.instrument.transposechromatic=I.transpositionNotes[I.transposition.note].chromatic+12*I.transposition.octave);
}function C(a,b){I.selectedSoundInstrument=I.instruments[a][b],I.instrument.midichannel.default.program=I.instruments[a][b].midichannel.default.program}function D(a){I.instruments.$sort[a]&&(I.selectedSoundGroupIdx=a,I.selectedSoundGroup=I.instruments.$sort[a])}function E(a){if(I.selectedSoundGroup&&I.instruments[I.selectedSoundGroup.name][a])return I.instruments[I.selectedSoundGroup.name][a].mp3Url||(I.instruments[I.selectedSoundGroup.name][a].mp3Url=baseurl+"/sounds/instruments-previews/"+a+".mp3"),I.instruments[I.selectedSoundGroup.name][a].mp3Url}function F(){c.closeCustomInstrumentModal&&(m(),c.closeCustomInstrumentModal(),c.cancelEditCustomInstrument())}function G(){if(!b.account.id)return $(".modal").remove(),window.location="/auth",!1}function H(b,d){b!==d&&b===!0&&c.instrumentToEdit&&c.instrumentToEdit.id&&j.get({instrument:c.instrumentToEdit.id}).$promise.then(function(b){I.instrument.id=c.instrumentToEdit.id,I.instrument.longname=b.longname,I.instrument.shortname=b.shortname,I.instrument.icon=b.icon,I.instrument.staves=b.staves||0,I.instrument.transposechromatic=b.transposechromatic||0,I.instrument.transposediatonic=b.transposediatonic||0,I.instrument.midichannel.default.program=b.midichannel.default.program,I.instrument.clefs=[];for(var d=0;d<b.clefs.length;d++)I.instrument.clefs.push({sign:b.clefs[d].sign,"clef-octave-change":parseInt(b.clefs[d]["clef-octave-change"]||0)});var e=I.instruments.$midi[I.instrument.midichannel.default.program].instrument,f=I.instruments.$midi[I.instrument.midichannel.default.program].group,g=a.findIndex(I.instruments.$sort,{name:f});g>=0&&(I.selectedBaseGroup=I.instruments.$sort[g],I.selectedBaseInstrument=I.instruments[f][e],I.selectedSoundGroupIdx=g,I.selectedSoundGroup=I.instruments.$sort[g],I.selectedSoundInstrument=I.instruments[f][e])})}var I=this,J=["base","staves-clefs","transposition","sound","name"];I.sectionIdx=0,I.section=J[I.sectionIdx],I.instrument={longname:"",shortname:"",icon:"",staves:0,clefs:[],transposechromatic:2,transposediatonic:2,midichannel:{default:{program:0}}},I.selectedBaseGroup=null,I.selectedBaseInstrument=null,I.clefs=[{l:"G",n:2},{l:"G",n:2,o:1},{l:"G",n:2,o:2},{l:"G",n:2,o:-1},{l:"G",n:2,o:-2},{l:"G",n:2,o:1},{l:"F",n:4},{l:"F",n:4,o:1},{l:"F",n:4,o:2},{l:"F",n:4,o:-1},{l:"F",n:4,o:-2},{l:"F",n:3},{l:"F",n:5},{l:"C",n:1},{l:"C",n:2},{l:"C",n:3},{l:"C",n:4},{l:"C",n:5}],I.transpositionNotes={C:{diatonic:0,chromatic:0},Db:{diatonic:1,chromatic:1},D:{diatonic:1,chromatic:2},Eb:{diatonic:2,chromatic:3},E:{diatonic:2,chromatic:4},F:{diatonic:3,chromatic:5},"F#":{diatonic:3,chromatic:6},G:{diatonic:4,chromatic:7},Ab:{diatonic:5,chromatic:8},A:{diatonic:5,chromatic:9},Bb:{diatonic:6,chromatic:10},B:{diatonic:6,chromatic:11}},I.transpositionOctavs=[-2,-1,0,1,2],I.transposition={note:"",octave:0},I.selectedSoundGroup=null,I.selectedSoundGroupIdx=null,I.selectedSoundInstrument=null,G(),k(),I.validateSection=n,I.setFormSection=o,I.prevFormSection=p,I.nextFormSection=q,I.createInstrument=s,I.updateInstrument=r,I.pressEnter=t,I.closeModal=F,I.getClefSvg=u,I.setBaseGroup=v,I.setBaseInstrument=w,I.addStave=x,I.removeStave=y,I.setTranspositionNote=z,I.setTranspositionOctave=A,I.selectSound=C,I.selectSoundGroup=D,I.getInstrumentPreviewURL=E,e.pageTrack("/instrument/new"),c.$watch("isCustomInstrumentModalOpen",H)}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.InstrumentNewCtrl",a),a.$inject=["_","$rootScope","$scope","$log","$analytics","$location","focus","MessageService","Instruments","CustomPitchedInstrument"]}(),function(){"use strict";function a(a,b,c,d,e){function f(){e("btn-limit-scores")}function g(a){if("Enter"===a.key)return h()}function h(){d.eventTrack("limited."+b.limit+".upgrade",{category:"freemium"}),c.path("/settings/your-plan").search("ref","limit-scores"),b.hideModal()}function i(){d.eventTrack("limited."+b.limit+".skip",{category:"freemium"}),c.search("limit",null),b.hideModal()}b.limit=b.flat.modalData.limit||"scores",b.quota="assignments"===b.limit?a.account.plan.quotas.assignments:a.account.plan.quotas.privateScores,b.go=h,b.close=i,b.pressEnter=g,b.$on("$destroy",i),d.eventTrack("limited."+b.limit+".displayed",{category:"freemium"}),$(".modal").on("shown.bs.modal",f).on("hidden.bs.modal",i).modal("show"),$(".modal-backdrop").addClass("visible-header white")}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.LimitScoresCtrl",a),a.$inject=["$rootScope","$scope","$location","$analytics","focus"]}(),function(){"use strict";function a(a,b,c,d){return b.availableModals=["newscore"],a.navHistory.length<2||"flat.editor.controllers.EditorCtrl"!==a.navHistory[1].controller?c.path("/score/"+d.scoreId):void(c.search().m&&b.availableModals.indexOf(c.search().m)>=0&&b.loadModal("dashboard",c.search().m))}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.ScoreAccessCtrl",a),a.$inject=["$rootScope","$scope","$location","$routeParams"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j){var k=i.id;a.displayLoader=!0,async.waterfall([function(a){return d.search().multipleCopiesAllowed?a(null,[]):void g.query({user:"me",parent:k}).$promise.then(a.bind(this,null)).catch(a.bind(this))},function(a,b){return a.length>0?b(null,a[0],{}):void h.fork({id:k,googleDriveSynchronous:!0},b.bind(this,null),b.bind(this))},function(a,b,c){d.path("/score/"+a.id).search("multipleCopiesAllowed",null).replace(),d.search().assignment&&d.search().classroom&&(j.addScoreToSubmission(a.id,d.search().assignment,d.search().classroom),d.search("assignment",null),d.search("classroom",null)),c()}],function(b){a.displayLoader=!1,b&&(a.displayErrors(b,null,!0),d.path("/dashboard")),f.add("score.fork-implicit"),e(angular.noop)})}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.ScoreForkCtrl",a),a.$inject=["$rootScope","$scope","$log","$location","$timeout","Experience","UserScoresV2","ScoreV2","ScoreData","AssignmentSubmissionV2"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(a){"Enter"===a.key&&$(".btn-retry").click()}function j(){b.s.data=b.reader.result.split(";base64,")[1],b.s.dataEncoding="base64",b.fileChosen=!0,d(angular.noop),b.import()}function k(){b.processing=!0,g.create(b.s).then(function(d){return a.account.ownedPrivateScoresCount++,e.pageTrack("/score/import/done"),b.uploading=!1,b.processing=!1,h.add("score.import"),c.path("/score/"+d.id)}).catch(function(c){return 402===c.status?a.loadModal("dashboard","scores-upgrade",{ref:"limit-private-scores-import"}):(a.loadIntercom(),e.pageTrack("/score/import/failed"),b.errors=a.displayErrors(c),b.uploading=!1,b.processing=!1,void(b.fileChosen=!1))})}function l(){return b.processing?"flat:score.importing":"flat:score.import"}function m(a){a&&!a.$error&&(b.errors=null,b.reader=new FileReader,b.uploading=!0,b.reader.onload=b.upload,b.reader.readAsDataURL(a),b.s.title=a.name)}function n(){return!!a.account.id||($(".modal").remove(),window.location="/auth",!1)}function o(){return!("private"===b.s.privacy&&a.account.plan&&a.account.plan.quotas&&a.account.plan.quotas.privateScores>=0&&a.account.ownedPrivateScoresCount>=a.account.plan.quotas.privateScores)||($(".modal").remove(),a.account.organization?a.loadModal("dashboard","limit-scores"):a.loadModal("dashboard","scores-upgrade",{mode:"import"}),!1)}function p(){f("btn-retry")}function q(){$(".modal-backdrop").removeClass("visible-header white"),a.hideModal()}return b.s={privacy:b.flat.modalData.privacy||"private"},!(!n()||!o())&&(b.reader=null,b.upload=j,b.import=k,b.buttonProcessing=l,b.pressEnter=i,b.$watch("file",m),e.pageTrack("/score/import"),c.search({m:"importscore"}),$(".modal").on("shown.bs.modal",p).on("hidden.bs.modal",q).modal("show"),void $(".modal-backdrop").addClass("visible-header white"))}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.ScoreImportCtrl",a),a.$inject=["$rootScope","$scope","$location","$timeout","$analytics","focus","ScoreIDB","Experience"]}(),function(){"use strict";function a(a,b,c,d,e,f){a.displayLoader=!0,e.create({privacy:"private",source:{googleDrive:c.scoreId.replace("drive-","")}}).$promise.then(function(c){a.displayLoader=!1,f.add("score.import-drive"),d.pageTrack("/score/import-drive/done"),b.path("/score/"+c.id)}).catch(function(c){a.displayLoader=!1,a.displayErrors(c,null,!0),d.pageTrack("/score/import-drive/failed"),b.path("/dashboard")})}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.ScoreImportDriveCtrl",a),a.$inject=["$rootScope","$location","$routeParams","$analytics","ScoreV2","Experience"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j){b.privacy=d.search().privacy||"private",b.title=d.search().title||"New music score";var k=d.search().url,l=d.search().app;k||(e.warn("Import API: Missing URL in request"),d.path("/profile")),h.get(function(){},function(a){401===a.status&&(g.set("redirect.next-logged",{path:d.path(),search:angular.copy(d.search())}),window.location="/auth")}),l&&(b.app=j.get({app:l})),b.cancel=function(){d.path("/dashboard")},b.import=function(){b.processing=!0,$.ajax({type:"GET",url:k,dataType:"binary",xhrFields:{responseType:"arraybuffer"}}).done(function(e){e=btoa(String.fromCharCode.apply(null,new Uint8Array(e)));var f={privacy:b.privacy,data:e,dataEncoding:"base64",title:b.title};b.app&&(f.app=b.app.id),i.create(f).$promise.then(function(a){d.path("/score/"+a.id).search("url",null).search("title",null).search("app",null).search("privacy",null)}).catch(function(c){b.processing=!1,a.displayErrors(c,null,!0)}),c(angular.noop)}).fail(function(){b.processing=!1,a.displayErrors(new Error("Unable to download the file for this score"),null,!0),c(angular.noop)})}}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.ScoreImportUrlCtrl",a),a.$inject=["$rootScope","$scope","$timeout","$location","$log","$http","UxStore","Me","ScoreV2","AppPublic"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){function h(){return!!b.account}function i(){d.search().m&&m.indexOf(d.search().m)>=0&&c.loadModal("dashboard",d.search().m)}function j(b,d){var e=a.findIndex(c.scores,{id:d.id});e<0?g.get({id:d.id},function(a){c.scores.unshift(a)}):a.merge(c.scores[e],d)}function k(b,d){var e=a.findIndex(c.scores,{id:d});e>=0&&c.scores.splice(e,1)}function l(a,b){c.scores=b}b.pageTitle=i18n.t("flat:pageTitle.score-my");var m=["newscore","importscore"];return!!h()&&(i(),b.account.organizationRole||d.search().m?(c.scores=f,e.pageTrack("/score/my"),c.$on("ObjectUpdate.Score",j),c.$on("ObjectDelete.Score",k),void c.$on("IDBObjectUpdate.UserScores",l)):d.path("/"+b.account.username).replace())}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.ScoreMyCtrl",a),a.$inject=["_","$rootScope","$scope","$location","$analytics","ScoresData","ScoreV2"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(){r(),s(),t()}function r(){b.scoreCreation?(c.score=new p(b.scoreCreation),c.score.privacy=V.privacy||"private"):(c.score=new p({title:V.title||"",privacy:V.privacy||"private",assignment:V.assignment,beats:4,beatType:4,keySignature:0,layout:"staff"}),b.scoreCreation=c.score)}function s(){c.score.getInstrumentsData().then(function(d){if(c.templates=d.templates,c.instruments=d.instruments,b.organization&&b.organization.capabilities&&b.organization.capabilities.fun===!1){var e=a.findIndex(c.instruments.$sort,["name","special"]);e>=0&&c.instruments.$sort.splice(e,1)}angular.forEach(c.instruments.$sort,function(a){"keyboards"===a.name&&(c.selectedGroup=a)}),c.selectedGroup=c.instruments.$sort[0],c.selectedTemplateGroup=Object.values(c.templates)[0]})}function t(){if(!b.hasExperience||b.hasExperience("score.new")||c.score.funnel||n.push({funnel:{category:"editor",name:"score-new",referral:V.ref},event:{type:"page",category:"modal",name:"title"}},function(a){c.score.funnel=a.funnel}),c.score.funnel){var a,d=function(b){for(var d,e=b.target;e;){if(e&&e.id){d=e.id;break}e=e.parentElement}d&&(a!==d&&n.push({funnel:{id:c.score.funnel},event:{type:"click"===b.type?"click":"input",category:"editor",name:d}}),a=d)};$("#newScoreModal").click(d).focusin(d)}}function u(a,b){if(!c.isCustomInstrumentModalOpen&&"Enter"===a.key)return"score-title"===b&&c.score.title&&c.score.title.length>0?T():"score-instruments"===b&&c.score.title&&c.score.title.length>0&&!c.creating&&c.score.instruments.length>0?G():void 0}function v(){c.isCustomInstrumentModalOpen=!0}function w(a,b){return c.instruments[a][b].restricted?(c.powerWarning=!0,!1):(c.score.addInstrument(a,b),void f.eventTrack("instrument.add",{category:"dashboard.score-new",label:a+"."+b}))}function x(a){c.score.removeInstrument(a)}function y(a,b){c.score.removeLastInstrument(a,b)}function z(a,b){c.score.removeLastTemplate(a,b)}function A(a,b){c.score.addTemplate(a,b),b.group=a,f.eventTrack("template.add",{category:"dashboard.score-new",label:b.name}),o.add("score.new.template")}function B(a,b){c.score.removeTemplateInstrument(a,b)}function C(a){c.score.removeTemplate(a)}function D(a){c.selectedGroup===a?c.selectedGroup=null:c.selectedGroup=a;var b=$("#instruListGrp-"+a.name);if(b&&b[0]){var d=c.instruments.$sort.indexOf(a),e=b[0].getBoundingClientRect();$(".instruments-content .modal-body.instrument-list").animate({scrollTop:e.height*d},500)}}function E(a){c.selectedTemplateGroup===a?c.selectedTemplateGroup=null:c.selectedTemplateGroup=a}function F(a){if(c.selectedGroup&&c.instruments[c.selectedGroup.name][a])return c.instruments[c.selectedGroup.name][a].mp3Url||(c.instruments[c.selectedGroup.name][a].mp3Url=baseurl+"/sounds/instruments-previews/"+a+".mp3"),c.instruments[c.selectedGroup.name][a].mp3Url}function G(){c.creating=!0,c.score.build().then(function(a){var d={title:c.score.title,privacy:c.score.privacy,data:JSON.stringify(a)};e.search()["drive-folder"]&&(d.googleDriveFolder=e.search()["drive-folder"]),h.get("drive.folder")&&(d.googleDriveFolder=h.get("drive.folder")),c.score.assignment&&(d.googleDriveSynchronous=!0),k.create(d).then(function(a){f.pageTrack("/score/new/done"),"public"===c.score.privacy?b.account.ownedPublicScoresCount++:b.account.ownedPrivateScoresCount++,o.add("score.new"),c.score.assignment&&"student"===b.account.classRole?c.submissionCreation(a.id):c.scoreRedirect(a.id)}).catch(function(a){h.remove("drive.folder"),c.creating=!1,402===a.status?e.path("/settings/upgrade").search({ref:"limit-private-scores-createsubmit",hf:"unlimited-private-scores"}):401===a.status?window.location="/auth/logout":b.displayErrors(a,null,!0)})}).catch(function(a){d.warn(a)})}function H(){c.isCustomInstrumentModalOpen=!1}function I(a){c.instrumentToEdit=a,c.isCustomInstrumentModalOpen=!0}function J(){c.instrumentToEdit=null}function K(){c.instrumentToRemove=null,c.instrumentRemoving=!1}function L(a,d){return d&&c.instrumentToRemove?void(c.instrumentRemoving||(c.instrumentRemoving=!0,m.delete({instrument:c.instrumentToRemove.id}).$promise.then(function(){i.broadcast(i18n.t("flat:score.create-instrument-modal.deletion-success"),{color:"success"});var b=a.longname.replace(" ","-").toLowerCase();if("custom"===c.instruments.$sort[0].name){var d=c.instruments.$sort[0].instruments.indexOf(b);d>=0&&c.instruments.$sort[0].instruments.splice(d,1)}delete c.instruments.custom[b],c.instrumentToRemove=null,c.instrumentRemoving=!1}).catch(function(a){b.displayErrors(a,null,!0),c.instrumentRemoving=!1}))):void(c.instrumentToRemove=a)}function M(a){if(c.instruments.$sort[0]&&"custom"===c.instruments.$sort[0].name){var b=c.instrumentToEdit.longname.replace(" ","-").toLowerCase(),d=a.longname.replace(" ","-").toLowerCase();if(b!==d){if("custom"===c.instruments.$sort[0].name){var e=c.instruments.$sort[0].instruments.indexOf(b);e>=0&&(c.instruments.$sort[0].instruments[e]=d)}delete c.instruments.custom[b]}c.instruments.custom[d]=a}}function N(a){c.instruments.$sort[0]&&"custom"!==c.instruments.$sort[0].name&&c.instruments.$sort.unshift({name:"custom",instruments:[]}),c.instruments.custom||(c.instruments.custom={$name:"My custom instruments",icon:"choir_synth"});var b=a.longname.replace(" ","-").toLowerCase();c.instruments.$sort[0].instruments.push(b),c.instruments.custom[b]=a}function O(a){g(function(){e.path("/score/"+a)},500),c.score.funnel&&n.push({funnel:{id:c.score.funnel,completed:!0}}),b.scoreCreation={}}function P(){if(!b.account.id)return $(".modal").remove(),window.location="/auth",!1}function Q(){if(b.account.plan&&b.account.plan.quotas&&("private"===c.score.privacy&&b.account.ownedPrivateScoresCount>=b.account.plan.quotas.privateScores||"public"===c.score.privacy&&b.account.ownedPublicScoresCount>=b.account.plan.quotas.publicScores))if($(".modal").remove(),b.account.organization)b.loadModal("dashboard","limit-scores");else{var a="limit-"+c.score.privacy+"-scores";"string"==typeof V.ref&&(a+="-"+V.ref),V.direct||"public"===c.score.privacy||0===b.account.plan.quotas.privateScores?e.path("/settings/upgrade").search({ref:a,hf:"unlimited-private-scores"}):b.loadModal("dashboard","scores-upgrade",{ref:a})}}function R(){j("newScoreTitle")}function S(a){W.includes(a)&&(c.creationType=a)}function T(){c.score.title&&0!==c.score.title.length||(c.score.title=i18n.t("flat:default-score.title")),c.titleValidated=!0,c.instrumentsSelection=!c.instrumentsSelection,c.instrumentsSelection?(f.pageTrack("/score/new/instruments"),c.score.funnel&&n.push({funnel:{id:c.score.funnel},event:{type:"page",category:"modal",name:"instruments"}})):c.score.funnel&&n.push({funnel:{id:c.score.funnel},event:{type:"page",category:"modal",name:"title-back"}})}function U(a){async.waterfall([function(a){l.query({class:c.score.assignment.classroom,assignment:c.score.assignment.id},a.bind(this,null),a.bind(this))},function(b,d,e){var f=b.length>0?b[0].attachments:[];f.push({score:a}),l.put({class:c.score.assignment.classroom,assignment:c.score.assignment.id,attachments:f},e.bind(this,null),e.bind(this))}],function(){c.scoreRedirect(a)})}var V=c.flat.modalData,W=["instruments","templates"];c.titleValidated=!1,c.creationType=W[0],c.score=b.scoreCreation,c.assignmentNoScore=V.assignmentNoScore,c.templates=[],c.instruments=[],c.isCustomInstrumentModalOpen=!1,c.adding=!0,c.newScore=!0,c.tabsInstruments=[],c.displayModes=[{name:"Tabs display",value:"tabs"}],c.options={layout:"staff"},P(),c.selectedGroup=null,c.selectedTemplateGroup=null,c.instrumentToEdit=null,c.instrumentToRemove=null,c.instrumentRemoving=!1,c.create=G,c.scoreRedirect=O,c.submissionCreation=U,c.viewSwitchInstruments=T,c.swichCreationType=S,c.selectGroup=D,c.selectTemplateGroup=E,c.getInstrumentPreviewURL=F,c.addTemplate=A,c.removeTemplate=C,c.removeTemplateInstrument=B,c.removeLastTemplate=z,c.createCustomInstrument=v,c.addInstrument=w,c.removeInstrument=x,c.removeLastInstrument=y,c.pressEnter=u,c.cancelEditCustomInstrument=J,c.editCustomInstrument=I,c.cancelRemoveCustomInstrument=K,c.removeCustomInstrument=L,c.onInstrumentCreation=N,c.onInstrumentUpdate=M,c.closeCustomInstrumentModal=H,$(".modal").modal("show").on("shown.bs.modal",R).on("hidden.bs.modal",b.hideModal),g(function(){q(),Q(),e.search("m","newscore"),f.pageTrack("/score/new")})}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.ScoreNewCtrl",a),a.$inject=["_","$rootScope","$scope","$log","$location","$analytics","$timeout","UxStore","MessageService","focus","ScoreIDB","AssignmentSubmissionV2","CustomPitchedInstrument","FrontendEvent","Experience","flat.dashboard.services.ScoreFactory"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){async.waterfall([function(b){if(!a.account||!a.account.id){var d=f.get("score.jointokens")||{};return d[c.scoreId]=c.token,f.set("score.jointokens",d),b()}var e=new g({id:c.scoreId,user:"me",scoreToken:c.token});e.$add().then(b,b)}],function(){e(function(){d.path("/score/"+c.scoreId).replace()},300)})}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.ScoreTokenCtrl",a),a.$inject=["$rootScope","$scope","$routeParams","$location","$timeout","UxStore","CollaboratorV2"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j){function k(){b.previousSearch!==a.searchQuery&&(b.previousSearch=a.searchQuery,a.searchQuery.length>3&&(b.lastTimeout&&e.cancel(b.lastTimeout),b.lastTimeout=e(function(){d.search("q",a.searchQuery),b.processing=!0,h.scores({q:a.searchQuery},function(a){b.processing=!1,b.searchResult.scores=a}),h.users({q:a.searchQuery},function(a){b.searchResult.users=a}),g.add("search.autocomplete")},150)))}function l(a){b.searchResult._query!==a&&b.search()}a.searchQuery=c.q||"",b.searchResult={_query:a.searchQuery,scores:j,users:i},b.search=k,f("search-view-focus"),g.add("search.list"),b.$watch("searchQuery",l)}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.SearchCtrl",a),a.$inject=["$rootScope","$scope","$routeParams","$location","$timeout","focus","Experience","Search","SearchUsersData","SearchScoresData"]}(),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.SupportCtrl",["$rootScope","$scope","UxStore",function(a,b,c){"use strict";a.pageTitle=i18n.t("flat:pageTitle.support"),b.guestChatting=function(){c.set("redirect.next","/support"),window.location="/auth"}}]),function(){"use strict";function a(a,b,c,d,e,f,g){function h(){i()}function i(){g.query().then(function(b){k.helpItems=b;var c=a.search().m,d=a.search().key;if(c||d){var e=_.find(k.helpItems,function(a){return!!(a.modal&&a.modal.length>1&&a.modal[1]===c)||(a.key===d||void 0)});e?j(e):$(".modal-backdrop").remove()}})}function j(a){a.modal?c.loadModal(a.modal[0],a.modal[1]):a.blog?window.open(a.blog.url):c.loadModal("editor","help",{key:a.key}),f.add("help.editor.watch"),b.pageTrack("/support/editor/item/"+a.key)}var k=this;c.pageTitle=i18n.t("flat:pageTitle.support-kb"),k.current=null,k.displayItem=j,h(),f.add("help.editor"),b.pageTrack("/support/knowledge-base")}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.SupportEditorCtrl",a),a.$inject=["$location","$analytics","$rootScope","$scope","$timeout","Experience","EditorHelpService"]}(),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.SupportFaqCtrl",["$rootScope","$scope","$sce","$analytics","$timeout","Experience",function(a,b,c,d,e,f){"use strict";a.pageTitle=i18n.t("flat:pageTitle.faq"),b.activeCategory=a.account.organization?"education":"individual",b.faq={individual:{general:["general.why-flat","general.learn","general.which-web-browsers","general.how-contact-flat","general.diff-indiv-edu","general.account-change-email","general.how-remove-my-account"],scores:["scores.collaborate","scores.guest-users","scores.delete","scores.ie-playback","scores.midi","scores.live-midi"]},education:{general:["general.why-flat","general.which-web-browsers","general.how-contact-flat","general.diff-indiv-edu","general.account-change-email","general.how-remove-my-account"],scores:["scores.collaborate","scores.delete","scores.ie-playback"],classes:["classes.why","classes.students-join","classes.embed-resource"],googleclassroom:["googleclassroom.what-synchronization","googleclassroom.oauth2-grants"],assignments:["assignments.why","assignments.diff-due-date","assignments.colors","assignments.multiple-steps","assignments.multiple-scores"],admin:["admin.enroll-teachers"]}},b.resolveLocales=function(a){for(var b=0;b<a.length;b++)a[b]={id:a[b],q:i18n.t("help:faq."+a[b]+".q"),a:c.trustAsHtml(i18n.t("help:faq."+a[b]+".a"))}},b.displayItem=function(a){a.visible=!a.visible,a.visible&&d.pageTrack("/support/faq/item/"+a.id)},e(function(){b.resolveLocales(b.faq.individual.general),b.resolveLocales(b.faq.individual.scores),b.resolveLocales(b.faq.education.general),b.resolveLocales(b.faq.education.scores),b.resolveLocales(b.faq.education.classes),b.resolveLocales(b.faq.education.googleclassroom),b.resolveLocales(b.faq.education.assignments),b.resolveLocales(b.faq.education.admin)}),f.add("help.faq")}]),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.SupportTutorialsCtrl",["$rootScope","$scope","$routeParams","$sce","$interval","$analytics","Experience","FrontendEvent",function(a,b,c,d,e,f,g,h){"use strict";a.pageTitle=i18n.t("flat:pageTitle.tutorials"),g.add("help.tutorials"),b.tutorials={"create-a-new-score":{icon:"/img/icons/_common/tutorial_music_score.svg",img:"/img/tutorials/create-a-new-score.png",yid:"XxJybK9kZn4",steps:[{time:0},{time:32},{time:52},{time:72},{time:78},{time:88},{time:102}]},"create-a-new-class":{icon:"/img/icons/_common/people.svg",img:"/img/tutorials/create-a-new-class.png",yid:"21-n5gllaXQ",steps:[{time:0},{time:32},{time:51},{time:74},{time:77},{time:92},{time:102},{time:110}]},"invite-a-student":{icon:"/img/icons/_common/people.svg",img:"/img/tutorials/invite-a-student.png",yid:"Q2uaiCfI_0U",steps:[{time:0},{time:32},{time:58},{time:73},{time:97}]},"create-an-assignment":{icon:"/img/icons/_edu/star.svg",img:"/img/tutorials/create-an-assignment.png",yid:"aWLg1Asoi7s",steps:[{time:0},{time:30},{time:69},{time:84},{time:105},{time:120},{time:175},{time:219}]},"music-scores-as-templates":{icon:"/img/icons/_edu/star.svg",img:"/img/tutorials/music-scores-as-templates.png",yid:"6CWdLX-GVzA",steps:[{time:0},{time:55},{time:62},{time:141}]},"sync-google-classroom":{icon:"/img/icons/_edu/google-classroom-round.svg",img:"/img/tutorials/sync-google-classroom.png",yid:"8AHkaQLzgXE",steps:[{time:0},{time:37},{time:41}]},"copy-score-each-google-classroom-student":{icon:"/img/icons/_edu/google-classroom-round.svg",img:"/img/tutorials/copy-score-each-google-classroom-student.png",yid:"pnu-LeC57p4",steps:[{time:0},{time:44},{time:56}]}},c.id&&(b.chosenId=c.id,b.chosen=b.tutorials[c.id],b.chosen?b.currentStep=b.chosen.steps[0]:b.chosenId=null);var i=["first","second","third","fourth","fifth","sixth","seventh","eighth"];if(b.getStepI18n=function(a){return"help:tutorials."+c.id+".steps."+i[a]},b.setStep=function(a){b.currentStep=a,c.id===b.lastId&&a===b.lastStep||(g.add("help.tutorials.watch"),h.push({event:{type:"action",category:"tutorials",name:c.id,properties:{step:a&&a.time}}}),f.eventTrack("watch.",{category:"tutorials",label:c.id,step:a&&a.time})),b.lastStep=a,b.lastId=c.id},b.changeStep=function(a){b.setStep(a),b.player&&b.player.seekTo&&b.player.seekTo(a.time)},b.isCurrentStep=function(a){return b.currentStep===a},b.initPlayer=function(){b.player=new window.YT.Player("player",{height:"396",width:"650",videoId:b.chosen.yid,playerVars:{listType:"playlist",list:"PLimLiLz1JZA0gE8fbW6lQUmaZOm5KiVo_"},events:{onReady:b.ready}})},b.getDisplayedTime=function(a){var b=Math.floor(a/60).toString(),c=(a-60*b).toString();return 1===b.length&&(b="0"+b),1===c.length&&(c="0"+c),b+":"+c},b.ready=function(){b.stepsInterval=e(b.getStepFromVideo,2e3)},b.$on("$destroy",function(){angular.isDefined(b.stepsInterval)&&(e.cancel(b.stepsInterval),b.stepsInterval=void 0)}),b.getStepFromVideo=function(){if(b.player.getVideoEmbedCode){var a=b.player.getVideoData().video_id;if(b.chosen.yid!==a)for(var c in b.tutorials)b.tutorials.hasOwnProperty(c)&&b.tutorials[c].yid===a&&(b.chosen=b.tutorials[c],b.currentStep=b.chosen.steps[0])}if(b.player.getCurrentTime){for(var d=b.player.getCurrentTime(),e=b.currentStep,f=0;f<b.chosen.steps.length&&!(d<b.chosen.steps[f].time);f++)e=b.chosen.steps[f];b.setStep(e)}},b.chosen)if(window.YT&&window.YT.Player)angular.element(document).ready(function(){b.initPlayer()});else{var j=document.createElement("script");j.src="https://www.youtube.com/iframe_api";var k=document.getElementsByTagName("script")[0];k.parentNode.insertBefore(j,k),window.onYouTubeIframeAPIReady=function(){b.initPlayer()}}}]),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.UpdatesCtrl",["$rootScope","$scope","$routeParams","$sce","UserV2","Experience","ProductUpdates","ProductUpdateLikes","flat.editor.services.SocialFacebook","flat.editor.services.SocialTwitter","flat.editor.services.SocialGoogle","$analytics","ProductUpdatesData",function(a,b,c,d,e,f,g,h,i,j,k,l,m){"use strict";b.likes={},b.users={},b.updates=[],b.canLoadMore=!0,b.users[a.account.id]=a.account,g.userSeen(function(){a.hasSeenLastUpdate=!0});var n=function(a){b.likes[a.update]=a;for(var c=0;c<a.users.length;c++)b.users[a.users[c]]||(b.users[a.users[c]]=e.get({user:a.users[c]}))};if(b.addProductUpdate=function(a){b.updates.push(a),b.likes[a.id]={},b.users[a.user]=e.get({user:a.user}),h.get({update:a.id},n)},m.length)for(var o=0;o<m.length;o++)b.addProductUpdate(m[o]);else a.pageTitle=m.title,b.addProductUpdate(m);b.trustAsHtml=function(a){return d.trustAsHtml(a)},b.loadMore=function(){g.query({skip:b.updates.length},function(a){if(!a||!a.length)return void(b.canLoadMore=!1);for(var c=0;c<a.length;c++)b.addProductUpdate(a[c])})},b.like=function(c){if(a.account.id||(window.location="/auth"),!b.likes[c.id].liking){if(b.likes[c.id].liked)return b.unlike(c);b.likes[c.id].liked=!0,b.likes[c.id].liking=!0,h.save({update:c.id},function(){b.likes[c.id].total+=1,b.likes[c.id].users.length<5&&b.likes[c.id].users.push(a.account.id),b.likes[c.id].liking=!1},function(){b.likes[c.id].liked=!1}),f.add("dashboard.product-update.like")}},b.unlike=function(c){a.account.id||(window.location="/auth"),b.likes[c.id].liking||(b.likes[c.id].liking=!0,b.likes[c.id].liked=!1,h.remove({update:c.id},function(){b.likes[c.id].total-=1;for(var d=0;d<b.likes[c.id].users.length;d++)if(b.likes[c.id].users[d]===a.account.id){b.likes[c.id].users.splice(d,1);break}b.likes[c.id].liking=!1},function(){b.likes[c.id].liked=!0}))},b.shareFb=function(a){i.shareProductUpdate(a),l.pageTrack("/updates/share/facebook"),f.add("dashboard.product-update.share")},b.shareTwitter=function(a){j.shareProductUpdate(a),l.pageTrack("/updates/share/twitter"),f.add("dashboard.product-update.share")},b.shareGoogle=function(a){k.share(baseurl+"/updates/"+a.id),l.pageTrack("/updates/share/google-plus"),f.add("dashboard.product-update.share")},f.add("dashboard.product-update.open")}]),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(){b.pageTitle=i18n.t("flat:pageTitle.profile",{name:c.user.name||c.user.username}),p.getThemeForUser(c.user).then(function(a){c.userTheme=a}),c.loadingScores=!0,o.query({user:d.username||"me"},{strategy:"cacheFirst",broadcastUpdate:!0,cache:!0}).then(function(a){r(a),c.loadingScores=!1}).catch(function(a){b.displayErrors(a,null,!0)}),angular.copy(c.user,c.originalUser),"starred"===c.view?s():"following"===c.view?t():"followers"===c.view&&u(),window.requestAnimationFrame(B),!e.search().m&&0===c.scores.length&&b.account.experience&&b.account.experience.indexOf("score.new")<0&&b.account.experience.indexOf("score.import")<0&&b.account.experience.indexOf("editor.addnote")<0&&b.loadModal("dashboard","newscore",{privacy:b.account.plan&&b.account.plan.quotas&&0===b.account.plan.quotas.privateScores?"public":"private"})}function r(a){if(c.scores=a,c.isMe){c.privateScores=[],c.publicScores=[];for(var b=0;b<c.scores.length;b++)"public"!==c.scores[b].privacy?("privateLink"===c.scores[b].privacy&&(c.scores[b].privacy="private"),c.privateScores.push(c.scores[b])):c.publicScores.push(c.scores[b])}}function s(){c.loadingScores=!0,i.likes({user:c.user.id},function(a){c.starred=a,c.loadingScores=!1})}function t(){c.following=j.following({user:c.user.id})}function u(){c.followers=j.followers({user:c.user.id})}function v(a){e.hash(a),g()}function w(){"/profile"!==e.path()||b.account&&b.account.id||(b.account=n)}function x(){var a=!1;return"undefined"!=typeof domain&&domain&&(a=!0,e.path("/score").replace()),"private-profile"===n.username&&(a=!0,e.path("/private-profile").replace()),d.view&&["scores","shared","starred","following","followers"].indexOf(d.view)<0&&(a=!0,e.path("/"+d.username).replace()),a}function y(){!b.account||b.account.organization||!b.account.googleDetails||!b.account.googleDetails.hd||b.account.plan&&b.account.plan.name&&0!==b.account.plan.name.indexOf("indiv-free")||m.get("indiv2edu.displayed")&&!(new Date(m.get("indiv2edu.displayed"))<moment().subtract(15,"days").toDate())||c.loadModal("dashboard","indiv2edu");
}function z(){if(b.account.plan&&"indiv-free"===b.account.plan.name&&b.account.sales&&b.account.sales.lastPromoDate&&new Date(b.account.sales.lastPromoDate)>new Date){var a;c.limitedOffer={date:new Date(b.account.sales.lastPromoDate),discount:b.account.sales.lastPromoPercent,refresh:function(){var b=c.limitedOffer.date-new Date;b<0?(h.cancel(a),a=null,c.limitedOffer=null):(c.limitedOffer.seconds=("0"+Math.floor(b/1e3%60)).slice(-2),c.limitedOffer.minutes=("0"+Math.floor(b/1e3/60%60)).slice(-2),c.limitedOffer.hours=("0"+Math.floor(b/36e5)).slice(-2))}},a=h(c.limitedOffer.refresh,1e3),c.limitedOffer.refresh()}}function A(){e.search().m&&J.indexOf(e.search().m)>=0&&c.loadModal("dashboard",e.search().m),e.search().m&&I.indexOf(e.search().m)>=0&&c.loadModal("editor",e.search().m)}function B(){var a=document.getElementById("profile-card");if(a){var b=a.offsetTop,d=a.offsetHeight;c.scrollProfile=function(){if(b+d-window.pageYOffset<-50?$(".navigation").addClass("opened"):$(".navigation").removeClass("opened"),c.isMe){var a=document.getElementById("public-scores");a&&(b<b-window.pageYOffset?($(".navigation #public-scores-link").addClass("active"),$(".navigation #private-scores-link").removeClass("active")):($(".navigation #private-scores-link").addClass("active"),$(".navigation #public-scores-link").removeClass("active")))}};var e=!!window.Modernizr.supportsPassiveOption&&{passive:!0};window.addEventListener("scroll",c.scrollProfile,e),c.$on("$destroy",function(){window.removeEventListener("scroll",c.scrollProfile,e)})}}function C(a,b){r(b)}function D(b,d){var e=a.findIndex(c.scores,{id:d.id});e<0?k.get({id:d.id},{strategy:"networkOnly",cache:!0}).then(function(a){c.scores.unshift(a),r(c.scores)}):(a.merge(c.scores[e],d),r(c.scores))}function E(b,d){var e=a.findIndex(c.scores,{id:d});e>=0&&(c.scores.splice(e,1),r(c.scores))}function F(a,d){c.user.id!==d||c.isMe?c.isMe&&(c.user.followingCount+=1,c.followings&&c.followings.push(i.get({user:d}))):(c.user.followersCount+=1,c.followers&&c.followers.push(b.account))}function G(d,e){var f;c.user.id!==e||c.isMe?c.isMe&&(f=a.findIndex(c.followings,{id:e}),c.user.followingCount-=1,f>=0&&c.followings.splice(f,1)):(f=a.findIndex(c.followers,{id:b.account.id}),c.user.followersCount-=1,f>=0&&c.followers.splice(f,1))}function H(){c.hideModal()}var I=["trial-history"],J=["newscore","importscore","indiv2edu","upgrade-survey","upgrade-paypal","upgrade-success","scores-upgrade"];x()!==!0&&(c.view=d.view||"scores",c.errors=[],c.editMode=!1,c.scores=[],c.user=n,c.isMe=!d.username||c.user.id===b.account.id,c.isMe&&(b.account=c.user),c.scoreListContext=c.isMe||"scores"===c.view?"dashboard":"profile",c.scoreListStyle="material",c.scrollTo=v,w(),A(),y(),z(),q(),c.$on("ObjectUpdate.Score",D),c.$on("ObjectDelete.Score",E),c.$on("ObjectUpdate.UserFollow",F),c.$on("ObjectUpdate.UserUnfollow",G),c.$on("IDBObjectUpdate.UserScores",C),c.$on("$destroy",H))}angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.UserCtrl",a),a.$inject=["_","$rootScope","$scope","$routeParams","$location","$analytics","$anchorScroll","$interval","UserV2","Follow","ScoreIDB","Experience","UxStore","ProfileData","UserScoresIDB","ThemesHelpers"]}(),angular.module("flat.dashboard.controllers").controller("flat.dashboard.controllers.UserPrivateCtrl",[function(){}]),angular.module("flat.dashboard.directives",[]),function(){"use strict";function a(){var a={restrict:"EA",templateUrl:"/views/dashboard/score/_widget.html",controller:b,controllerAs:"vm",link:{post:c},bindToController:!0,scope:{score:"=scoredb",context:"=",style:"=",contextUser:"=",display:"=",myScore:"=",customTheme:"@"}};return a}function b(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(){p.scores.removeDeep(D.score.id).then(function(){D.score.offline=!1})}function r(b){a.isUndefined(D.popoverIsOpen[b])&&(D.popoverIsOpen[b]=!1),a.forEach(D.popoverIsOpen,function(a,c){c!==b&&(D.popoverIsOpen[c]=!1)}),D.popoverIsOpen[b]=!D.popoverIsOpen[b],d.$broadcast("Popover.Opened",{score:D.score.id})}function s(a,b){b&&b.score===D.score.id||(D.popoverIsOpen={})}function t(){m.put({id:D.score.id,privacy:"private"}).then(function(){d.account.ownedPrivateScoresCount++,d.account.ownedPublicScoresCount--,D.score.privacy="private",o.add("score.privacy-switch")}).catch(function(a){402===a.status?g.path("/settings/upgrade").search({ref:"limit-private-scores-privacy",hf:"unlimited-private-scores"}):c.error(a)})}function u(){D.loadModal("editor",d.account.organization?"access":"privacy",{score:D.score})}function v(b,c){var d=[],e={};if(a.forEach(b,function(a){if(!c&&e[a])e[a].number++;else{var b=a.split(".")[0],f=a.split(".")[1];if(!D.instruments)return;c?D.instruments&&D.instruments[b]&&D.instruments[b][f]&&D.instruments[b][f].icon&&(e[D.instruments[b][f].icon]=!0):(e[a]={number:1,group:b,instrument:f,instrumentName:D.instruments[b][f].longname},d.push(e[a]))}}),c)return d=Object.keys(e).slice(0,8),0===d.length&&d.push("default"),d;var f=[];return a.forEach(d,function(a){a.display=a.instrumentName,a.number>1&&(a.display+=" ("+a.number+")"),f.push(a.display)}),f.join(", ")}function w(){if(!d.account.id)return window.location="/auth",!1;var a;D.score.likedByUser?(a=D.score.likesCount,l.unlike({id:D.score.id}).$promise.then(function(){var b=d.likedScores.indexOf(D.score.id);b>=0&&d.likedScores.splice(b,1),d.account.likedScoresCount--,D.score.likesCount=a-1,D.score.likedByUser=!1}).catch(function(a){d.displayErrors(a,null,!0)}),o.add("score.unlike"),i.pageTrack("/score/unlike/"+D.context)):(a=D.score.likesCount,l.like({id:D.score.id}).$promise.then(function(){var b=d.likedScores.indexOf(D.score.id);b<0&&d.likedScores.push(D.score.id),d.account.likedScoresCount++,D.score.likesCount=a+1,D.score.likedByUser=!0}).catch(function(a){d.displayErrors(a,null,!0)}),o.add("score.like"),i.pageTrack("/score/like/"+D.context))}function x(){g.path(D.scoreLink),h(angular.noop)}function y(){D.score.mp3Url=D.score.mp3Url||apiv2baseurl+"/scores/"+encodeURIComponent(D.score.id)+"/revisions/last/mp3",D.playing=!0}function z(){D.displayPowerBadge=!1,"dashboard"===D.context&&(D.canAdmin="owner"===D.score.type);var c=[];a.forEach(D.score.collaborators,function(a){"dashboard"===D.context&&a.user&&a.user.id===d.account.id&&(D.canAdmin=a.aclAdmin,D.ownRights=a.id),"popular"===D.context&&a.user&&a.user.isPowerUser&&(D.displayPowerBadge=!0),a.user&&"object"==typeof a.user&&c.push(j.getThemeForUser(a.user).then(function(a){this.theme=a}.bind(a.user)))}),b.all(c).then(function(){D.contextUser&&"popular"!==D.context&&"undefined"!=typeof D.score.collaborators&&(D.score.collaborators=a.filter(D.score.collaborators,function(a){return a.user&&a.user.id!==D.contextUser.id&&(a.user.username||a.name)||a.group})),D.score.displayCollaborators=E.maxDisplayedCollaborators,"undefined"!=typeof D.score.collaborators&&D.score.collaborators.length>E.maxDisplayedCollaborators&&D.score.displayCollaborators--})}function A(){D.theme=D.customTheme,"color"===D.style||"material"===D.style?(D.iconSet="solid-white",j.getThemeForScore(D.score,function(a){D.customTheme||(D.theme=a),D.theme||(D.theme="theme-default")})):D.iconSet="webby"}function B(){D.instruments=k.get({locale:d.account&&d.account.locale||"en"},function(){D.instruments=D.instruments.instruments,D.score.displayedInstruments=v(D.score.instruments,"widget"!==D.display&&"list"!==D.display),"object"==typeof D.score.displayedInstruments&&(D.score.displayedInstruments.isObject=!0)})}function C(b,c){D.score.id===c.id&&l.get({id:c.id}).$promise.then(function(b){a.merge(D.score,b),z()})}var D=this,E={maxDisplayedCollaborators:4};D.display=D.display||"card",D.style=D.style||"solid",D.scoreLink="/score/"+D.score.id,D.popoverIsOpen={},D.loadModal=d.loadModal,D.playing=!1,D.baseurl=d.baseurl,D.dashboard=d.account.id,D.closePopovers=r,D.playScore=y,D.makePublic=u,D.makePrivate=t,D.likeScore=w,D.unSync=q,D.go=x,z(),A(),e.$on("Popover.Opened",s),e.$on("ObjectUpdate.Score",C),e.$watch("vm.display",B),D.score.likedByUser=!1;var F=d.$watch("likedScores",function(a){a&&(D.score.likedByUser=d.likedScores.indexOf(D.score.id)>=0,F())})}function c(a,b){"ontouchstart"in document&&$(b).on("touchstart",".card-score > a",function(b){a.vm.go(),b.preventDefault()})}angular.module("flat.dashboard.directives").directive("scoreWidget",a),b.$inject=["_","$q","$log","$rootScope","$scope","$sce","$location","$timeout","$analytics","ThemesHelpers","Instruments","ScoreV2","ScoreIDB","ScoreRevisionIDB","Experience","PersistenceService"]}(),function(){"use strict";function a(){var a={restrict:"EA",replace:!0,templateUrl:"/views/dashboard/score/_list.html",controller:b,scope:{allScores:"=scoreList",cardsStyle:"=",cardsContext:"=",contextUser:"=",myScores:"=",optionsOnly:"=",privacyFilter:"=privacyContext"}};return a}function b(a,b,c,d,e,f,g,h){function i(){return e.get("score-list.display")}function j(a){e.set("score-list.display",a)}function k(){return e.get("popular-scores.order")}function l(a){e.set("popular-scores.order",a)}function m(){"cards"!==c.scoreDisplay?c.widgetPrivacy="all":c.widgetPrivacy=c.privacyFilter}function n(b,d){var e=a.findIndex(c.scores,{id:d});e>=0&&c.scores.splice(e,1)}function o(b,d){if(!c.optionsOnly){"privateLink"===d.privacy&&(d.privacy="private");var e=a.findIndex(c.scores,{id:d.id});e<0&&c.privacyFilter===d.privacy?h.get({id:d.id}).then(function(a){c.scores&&c.scores.length?c.scores.unshift(a):c.scores=[a]}):e>=0&&c.privacyFilter&&c.privacyFilter!==d.privacy&&"public"!==c.privacyFilter&&c.scores.splice(e,1)}}function p(a){a?(c.orderBy=a,l(a)):c.orderBy=c.orderByValues[0]}function q(a){c.scoreDisplay=a,j(a),b.$broadcast("score-list:switch-display",a),f.add("dashboard.cards-switch")}function r(a,b){c.scoreDisplay=b,m()}function s(){var a=c.scoresPerPage;0===c.scoresTotalDisplayed&&(a+=c.scoresFirstPageDiff);for(var b=c.scoresTotalDisplayed;b<c.allScores.length&&b-c.scoresTotalDisplayed<a;++b)c.scores[b]=c.allScores[b];c.scoresTotalDisplayed+=a}function t(){c.scores=[],c.scoresTotalDisplayed=0,c.displayScores()}function u(a,b){c.filterScores=b,w(b)}function v(){c.filteringScores=!c.filteringScores,c.filteringScores||c.resetScoresDisplay()}function w(a){if(0===a.length)return void c.resetScoresDisplay();if(!(a.length<=3)){c.scores=[],c.scoresTotalDisplayed=0,c.filterScoresLower=a.toLowerCase();for(var b=0;b<c.allScores.length;b++){var d=c.allScores[b];if(d.title.toLowerCase().indexOf(c.filterScoresLower)>=0||(d.user.username||"").toLowerCase().indexOf(c.filterScoresLower)>=0||(d.user.name||"").toLowerCase().indexOf(c.filterScoresLower)>=0)c.scores.push(c.allScores[b]);else if(d.collaborators)for(var e=0;e<d.collaborators.length;e++)if("object"==typeof d.collaborators[e].user&&((d.collaborators[e].user.username||"").toLowerCase().indexOf(c.filterScoresLower)>=0||(d.collaborators[e].user.name||"").toLowerCase().indexOf(c.filterScoresLower)>=0)){c.scores.push(c.allScores[b]);break}}c.scoresTotalDisplayed=c.scores.length,f.add("dashboard.filter-scores")}}function x(a){b.$broadcast("score-list:filter-scores",a)}function y(){h.getCachedScoresIds().then(function(b){var d=a.keyBy(b);a.forEach(c.allScores,function(a,b){c.allScores[b].offline=!!d[a.id]})})}c.loadModal=b.loadModal,c.isEdu=!!b.account.organization,c.maxDisplayedCollaborators=4,c.scoresPerPage=36,c.scoresFirstPageDiff=0,c.scoresTotalDisplayed=0,c.scoreDisplay=i(),"cards"!==c.scoreDisplay&&"list"!==c.scoreDisplay?window.innerWidth<830?c.scoreDisplay="list":c.scoreDisplay="cards":"search"===c.cardsContext&&(c.scoreDisplay="list"),"dashboard"===c.cardsContext&&"material"===c.cardsStyle&&c.myScores&&(c.scoresFirstPageDiff=-1),c.updateOrderBy=p,c.orderByValues=[{name:i18n.t("flat:sort.popular"),value:"-likes.total"},{name:i18n.t("flat:sort.recent"),value:"-modificationDate"}];var z=d.path().split("/").pop();c.periodFilters={popular:{path:"/popular",name:i18n.t("flat:popular.all-time")},weekly:{path:"/popular/weekly",name:i18n.t("flat:popular.weekly")},monthly:{path:"/popular/monthly",name:i18n.t("flat:popular.monthly")}},c.periodFilter=c.periodFilters[z]||c.periodFilters.popular,c.switchDisplay=q,c.displayScores=s,c.filteringScores=!1,c.filterScoresProcess=x,c.resetScoresDisplay=t,c.switchFilteringScores=v,p(k()),m(),y(),c.$on("ObjectDelete.Score",n),c.$on("ObjectUpdate.Score",o),c.$on("score-list:switch-display",r),c.$on("score-list:filter-scores",u),c.$watch(function(){return c.allScores&&c.allScores.length},function(a){a&&c.resetScoresDisplay()})}angular.module("flat.dashboard.directives").directive("scoreList",a),b.$inject=["_","$rootScope","$scope","$location","UxStore","Experience","ScoreV2","ScoreIDB"]}(),angular.module("flat.dashboard.directives").directive("follow",[function(){"use strict";return{restrict:"AE",replace:!0,scope:{uid:"=",context:"@",style:"@",followClass:"@",alreadyFollowing:"="},templateUrl:"/views/dashboard/_follow.html",controller:["$rootScope","$scope","$analytics","Follow","Experience",function(a,b,c,d,e){b.isFollowing=a.account&&a.following&&a.following.indexOf(b.uid)>=0,b._follow=function(){if(!a.account||!a.account.id)return window.location="/auth",!0;var f=a.followingCount+=1;d.follow({targetId:b.uid},function(){a.followingCount=f,a.following=a.following||[],a.following.push(b.uid),b.isFollowing=!0,a.$broadcast("ObjectUpdate.UserFollow",b.uid)}),e.add("follow.add"),c.pageTrack("/user/follow/"+b.context)},b._unfollow=function(){var f=a.followingCount-=1;d.unfollow({targetId:b.uid},function(){a.followingCount=f,a.following=a.following||[];var c=a.following.indexOf(b.uid);c>=0&&a.following.splice(c,1),b.isFollowing=!1,a.$broadcast("ObjectUpdate.UserUnfollow",b.uid)}),e.add("follow.rm"),c.pageTrack("/user/unfollow/"+b.context)},b.follow=function(){return b.isFollowing?b._unfollow():b._follow()}}]}}]),angular.module("flat.dashboard.directives").directive("globalSearch",[function(){"use strict";return{restrict:"AE",replace:!0,templateUrl:"/views/dashboard/search/_global_search.html",controller:["$rootScope","$routeParams","$location","$scope","$timeout","Search","Experience",function(a,b,c,d,e,f,g){function h(){d.resultsAvailable=d.searchResult.users.length>0||d.searchResult.scores.length>0}d.isSearchView=c.path().startsWith("/search"),d.resultsAvailable=!1,a.searchQuery=b.q||"",d.globalSearchFocus=!1,d.searchResult={scores:[],users:[]},d.goToSearchView=function(){return c.path("/search").search({q:a.searchQuery})},d.goToProfile=function(a){return c.path("/"+a.username)},d.goToScore=function(a){return c.path("/score/"+a.id)},d.search=function(b){b&&13===b.keyCode?d.goToSearchView():d.previousSearch!==a.searchQuery&&(d.previousSearch=a.searchQuery,!d.isSearchView&&a.searchQuery.length>3&&(d.lastTimeout&&e.cancel(d.lastTimeout),d.lastTimeout=e(function(){f.scores({q:a.searchQuery},function(a){d.searchResult.scores=a;for(var b=0;b<a.length;b++)a[b].mp3Url=apiv2baseurl+"/scores/"+encodeURIComponent(a[b].id)+"/revisions/last/mp3";h()}),f.users({q:a.searchQuery},function(a){d.searchResult.users=a,h()}),g.add("search.autocomplete")},150)))}}]}}]),angular.module("flat.dashboard.directives").directive("creditCard",[function(){return{restrict:"E",templateUrl:"/views/dashboard/account/_credit-card.html",scope:{pm:"=",selected:"=",onDelete:"&?",onSelect:"&?"},controller:["$scope","$parse",function(a){a.pm.card?(a.class=angular.lowercase(a.pm.card.brand),"American Express"===a.pm.card.brand&&(a.class="amex")):"paypal"===a.pm.provider&&(a.class="paypal"),a.trimYear=function(a){return a?a.substr(a.length-2):a},a.formatMonth=function(a){return("0"+a).slice(-2)}}],link:function(a,b,c){c.onSelect?angular.element(b[0]).bind("click",function(){a.$parent.$apply(c.onSelect)}):angular.element(b[0].querySelector(".radio-cc")).hide()}}}]),angular.module("flat.dashboard.directives").directive("lineChart",[function(){"use strict";return{restrict:"AE",scope:{data:"=",type:"@",label:"@",lineColor:"@",period:"="},replace:!0,templateUrl:"/views/dashboard/account/_line_chart.html",controller:["_","$log","$rootScope","$scope",function(a,b,c,d){function e(b,c){var e,f=function(a,b){b[a]||(b[a]=0)},g=a.keys(b),h=moment();if(0===d.period){var i=a.min(g);g.length||(i=moment().subtract(2,"weeks")),e=moment(i,d.format)}else e=h.clone().subtract(d.period,"days");for(;h.isAfter(e);)b[h.format(d.format)]||(b[h.format(d.format)]=0),a.each(c,f.bind(null,h.format(d.format))),h.subtract(1,"days")}function f(){if(d.chart&&d.data){var b=d.buildData();a.each(b,function(a,b){d.chart.data[b]=a}),d.chart.update()}}d.gradients||(d.gradients={}),d.getFormatFromData=function(){for(var a,b,c=0;d.data&&c<d.data.length;c++){var e=moment(d.data[c].date,"YYYY-MM-DD");a&&!e.isBefore(a)||(a=e),b&&!e.isAfter(b)||(b=e)}return b&&a&&b.diff(a,"weeks")>30?"YYYYMM":"YYYYWW"},d.buildData=function(){var b="positive"===d.lineColor?d.gradients.positive:d.gradients.negative,c={},f={};"mini"===d.type?d.format=d.period<365&&0!==d.period?"YYYYWW":"YYYYMM":d.format=d.period<365&&0!==d.period?"YYYYMMDD":d.getFormatFromData(),f.undefined={};for(var g=0;d.data&&g<d.data.length;g++){var h=moment(d.data[g].date,"YYYY-MM-DD");h.isValid()||console.error("Invalid date grouping",d.data[g].date),h=h.format(d.format),f[d.data[g].type||"undefined"]=f[d.data[g].type||"undefined"]||{},f[d.data[g].type||"undefined"][h]=f[d.data[g].type||"undefined"][h]||0,f[d.data[g].type||"undefined"][h]+=d.data[g].count,c[h]=c[h]||0,c[h]+=d.data[g].count}e(c,f);var i=[];a.each(f,function(c){if(c=a.values(c),"mini"!==d.type&&c.length){var e;c.length>=2&&(e=c[c.length-1]-c[c.length-2]);var f=c[c.length-1]+e/2;f<0&&(f=0),c.push(f)}i.push({data:c,fill:"mini"!==d.type,backgroundColor:d.gradients.normalBackground,borderColor:"mini"===d.type?b:d.gradients.normalBorder,borderWidth:"mini"===d.type?2:3,pointBorderWidth:7,pointBorderColor:"#F7F7F7",pointBackgroundColor:d.gradients.normalBorder,pointRadius:"mini"===d.type?0:6,lineTension:"mini"===d.type?0:void 0,pointHoverRadius:12,pointHoverBorderWidth:3,pointHoverBackgroundColor:"#F7F7F7",pointHoverBorderColor:"rgba(18, 21, 37, 0.25)"})});var j=a.map(a.keys(c),function(a){var b=moment(a,d.format);return b.isValid()||console.error("Invalid date label",a,d.format),b.format("MMDDYYYY")}),k={labels:j,datasets:i};return k},d.$watch("period",f),d.$watch("lineColor",f),d.$watch("data",f,!0)}],link:function(a,b){var c;if("mini"===a.type)c={tooltips:!1,hover:{mode:null},responsive:!0,legend:{display:!1},scales:{yAxes:[{ticks:{beginAtZero:!1,suggestedMin:-.1,suggestedMax:1},display:!1}],xAxes:[{display:!1}]},animateScale:!0};else{var d={fontFamily:"Open Sans",fontSize:10,fontColor:"#858FA9",fontStyle:"bold",padding:20};c={maintainAspectRatio:!1,tooltips:{enabled:!1,callbacks:{label:function(a){return a.yLabel||0}},custom:function(a){var b=$("#chartjs-tooltip");if(b[0]||($(".total-views>div").append('<div id="chartjs-tooltip"></div>'),b=$("#chartjs-tooltip")),!a.opacity)return void b.removeClass("tvisible");if(a.body){var c=['<div class="tooltip-c-title">',(a.beforeTitle||[]).join("\n"),(a.title||[]).join("\n"),(a.afterTitle||[]).join("\n"),'</div><div class="tooltip-c-body">',(a.beforeBody||[]).join("\n"),a.body[0].lines[0]||0,(a.afterBody||[]).join("\n"),"</div>"];b.html(c.join("\n"))}var d=this.getTooltipSize(a),e=0;e="top"===a.yAlign?d.height-b.height():"bottom"===a.yAlign?d.height-b.height()-30:-(d.height-b.height());var f=0;"center"===a.xAlign?f=d.width-b.width():"right"===a.xAlign?f=d.width-b.width():"left"===a.xAlign&&(f=d.width-b.width()+30),b.addClass("tvisible"),b.css({left:7+a.x+f+"px",top:80+a.y+e+"px"})}},responsive:!0,legend:{display:!1},scales:{yAxes:[{ticks:_.extend({},d,{maxTicksLimit:4,beginAtZero:!0}),gridLines:{drawTicks:!1,drawBorder:!1,zeroLineWidth:0,zeroLineColor:"rgba(0, 0, 0, 0)",color:"rgba(231, 232, 238, 0.6)"}}],xAxes:[{ticks:_.extend({},d,{maxRotation:0,callback:function(b){var c=moment(b,"MMDDYYYY");if(c.isValid()||console.error("Invalid date",b),a.period<365&&0!==a.period)return c.format("DD MMM").toUpperCase();if("YYYYMM"===a.format)return c.format("MMM YYYY");var d=c.format("DD"),e=c.format("MMM");c=c.add(1,"weeks").subtract(1,"days");var f=c.format("DD"),g=c.format("MMM");return g===e?(e+" "+d+" - "+f).toUpperCase():(e+" "+d+" - "+g+" "+f).toUpperCase()},padding:20,maxTicksLimit:8}),gridLines:{display:!1}}]},animateScale:!0}}var e={type:"line",data:a.buildData(),options:c},f=b[0].getContext("2d"),g=f.createLinearGradient(0,0,60,0);g.addColorStop(0,"rgba(243, 181, 150, 1)"),g.addColorStop(1,"rgba(207, 108, 133, 1)");var h=f.createLinearGradient(0,0,60,0);h.addColorStop(0,"rgba(65, 207, 177, 1)"),h.addColorStop(1,"rgba(76, 185, 195, 1)");var i=f.createLinearGradient(0,0,0,370);i.addColorStop(0,"rgba(51, 177, 248, 0.2)"),i.addColorStop(1,"rgba(110, 144, 246, 0.2)");var j=f.createLinearGradient(0,0,975,0);j.addColorStop(0,"rgba(51, 177, 248, 1)"),j.addColorStop(1,"rgba(110, 144, 246, 1)"),a.gradients={positive:h,negative:g,normalBackground:i,normalBorder:j},a.chart=new Chart(b[0],e),function(a){this.ctype=a}.bind(a.chart)(a.type)}}}]),angular.module("flat.dashboard.directives").directive("formCreditCard",[function(){"use strict";return{restrict:"AE",replace:!0,scope:{offer:"=",priceText:"=",noCardSaving:"=",successCallback:"=",processing:"=",error:"=",success:"=",paypal:"=",stripeCountry:"="},templateUrl:"/views/dashboard/account/_form_cc.html",controller:["$scope","$rootScope","$log","$timeout","BillingDetailsV2","MessageService",function(a,b,c,d,e,f){a.error={},a.card={},a.loading=!0,a.onLoading=function(){c.debug("[stripe] Stripe.js loaded"),a.$watch("stripeCountry",function(b){b&&(c.debug("[stripe] loading pub key of "+a.stripeCountry+" company: "+stripekey[a.stripeCountry]),Stripe.setPublishableKey(stripekey[a.stripeCountry]),Stripe.applePay.checkAvailability(function(b){a.applePayAvailable=b,d(function(){a.loading=!1})}))})},"undefined"==typeof Stripe?(c.debug("[stripe] loading Stripe.js"),$.getScript("https://js.stripe.com/v2/",function(b){b?(c.error(b),c.error("Stripe is not defined when loading our CC form"),f.broadcast("Unable to load our payments provider (Stripe), please refresh your page and contact our support if you are still encountering this issue.",{color:"danger"})):d(a.onLoading())})):a.onLoading(),a.cvcHelpTooltip=i18n.t("flat:cc.cvc-help");var g;for(a.years=[(new Date).getFullYear()],g=0;g<20;g++)a.years.push(a.years[g]+1);for(a.months=[],g=1;g<=12;g++)a.months.push(("0"+g).slice(-2));a.card.exp_month="01",a.card.exp_year=(new Date).getFullYear()+1,a.displayCardType=function(){a.cardType="string"==typeof a.card.number&&Stripe.card.cardType(a.card.number)},a.validateNumber=function(){Stripe.card.validateCardNumber(a.card.number)?delete a.error:a.error={param:"number",message:i18n.t("flat:cc.error.incorrect_number")}},a.validateCvc=function(){Stripe.card.validateCVC(a.card.cvc)?delete a.error:a.error={param:"cvc",message:i18n.t("flat:cc.error.incorrect_cvc")}},a.submit=function(){a.processing=!0,a.error={},Stripe.card.createToken(a.card,function(c,e){e.error?(a.processing=!1,a.error=e.error,b.$broadcast("CC.Error",a.error)):a.addStripeCard(e),d(angular.noop)})},a.applePay=function(){a.error={};var d={countryCode:(b.account.country||"US").toUpperCase(),currencyCode:a.offer.priceWithVAT.currencyCode,lineItems:[],total:{label:"Tutteo "+("US"===a.stripeCountry?"Inc.":"Ltd.")+" (Flat)",amount:a.offer.priceWithVAT.value}};d.lineItems.push({type:"final",label:a.offer.name,amount:a.offer.priceWithoutVAT.value}),a.offer.VATRate>0&&d.lineItems.push({type:"final",label:"VAT",amount:a.offer.VAT.value});var e=Stripe.applePay.buildSession(d,function(b,d){c.debug("[applepay] Received token"),a.processing=!0,a.addStripeCard(b.token,function(a){c.debug("[applepay] Callback subscription"),a?(c.debug("[applepay] Failure:"+a),d(ApplePaySession.STATUS_FAILURE)):(c.debug("[applepay] Success"),d(ApplePaySession.STATUS_SUCCESS))})},function(c){a.error={param:"apple",message:c.message},a.processing=!1,b.$broadcast("CC.Error",c)});e.begin()},a.addStripeCard=function(c,d){return d=d||function(){},a.noCardSaving?a.successCallback(c,function(){a.processing=!1,d(null,c)}):void e.postCard({token:c.id,tokenCountry:a.stripeCountry},function(b){a.successCallback(b,function(){a.processing=!1,d(null,b)})},function(c){c=c.data,a.error={param:c.param||"number",message:c.description||c.message},a.processing=!1,b.$broadcast("CC.Error",a.error),d(c)})}}],link:function(a,b){$(b).find("[data-cc-tooltip-secure]").tooltip({container:b,title:i18n.t("flat:cc.secure-payment")})}}}]),angular.module("flat.dashboard.directives").directive("formUpgradeIndiv",["FrontendEvent",function(a){"use strict";return{replace:!0,scope:{coupon:"=",couponYearlyOnly:"=",couponLifeOnly:"=",hfeature:"=",successCallback:"=",referral:"=",step:"="},templateUrl:"/views/dashboard/account/_upgrade_form.html",controller:["$rootScope","$scope","$log","$location","$analytics","$timeout","$interval","focus","Offers","Orders","Currencies","Subscription","PaypalAgreement","Coupon","User","UxStore",function(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){function r(){j.query(function(a){for(var d=0;d<a.length;d++)a[d].subscription?365===a[d].durationInDays?c.offers.yearly=a[d]:c.offers.monthly=a[d]:c.offers.life=a[d];if(c.offers.yearly){b.account.billingCompany?c.stripeCountry=b.account.billingCompany:c.stripeCountry="USD"===c.offers.yearly.priceWithVAT.currencyCode?"US":"GB",c.templates=l[c.offers.yearly.priceWithVAT.currencyCode],c.templateCurrency=c.templates.moneyFormat.replace("{amount}","").trim(),s.indexOf(c.offers.yearly.priceWithVAT.currencyCode)<0&&(c.payWithPaypal=null);var f;c.coupon&&(c.couponLifeOnly||(f=c.offers.yearly,f.priceWithVAT.value-=f.priceWithVAT.value*c.couponDetails.percentOff/100,f.priceWithVAT.value=Math.round(100*f.priceWithVAT.value)/100,f.priceWithVAT.text=c.templates.moneyFormat.replace("{amount}",f.priceWithVAT.value.toFixed(2))),c.couponYearlyOnly||c.couponLifeOnly||(f=c.offers.monthly,f.priceWithVAT.value-=f.priceWithVAT.value*c.couponDetails.percentOff/100,f.priceWithVAT.value=Math.round(100*f.priceWithVAT.value)/100,f.priceWithVAT.text=c.templates.moneyFormat.replace("{amount}",f.priceWithVAT.value.toFixed(2))),c.couponYearlyOnly||(f=c.offers.life,f.priceWithVAT.value-=f.priceWithVAT.value*c.couponDetails.percentOff/100,f.priceWithVAT.value=Math.round(100*f.priceWithVAT.value)/100,f.priceWithVAT.text=c.templates.moneyFormat.replace("{amount}",f.priceWithVAT.value.toFixed(2))));var g=function(a){var b={};b.original=a,b.text=c.templates.moneyFormat.replace("{amount}",a===Math.round(a)?a:parseFloat(a).toFixed(2)),b.currency=c.templates.moneyFormat.replace("{amount}","");var d=a===Math.round(a)?parseFloat(a).toString():parseFloat(a).toFixed(2);return b.int=Math.floor(d),d===b.int.toString()?b.decimal=0:b.decimal=d.substring(d.toString().indexOf(".")),b};c.offers.yearly.priceWithVAT.display=g(c.offers.yearly.priceWithVAT.value),c.offers.monthly.priceWithVAT.display=g(c.offers.monthly.priceWithVAT.value),c.offers.life.priceWithVAT.display=g(c.offers.life.priceWithVAT.value),c.offers.yearly.mPriceWithVAT=g(c.offers.yearly.priceWithVAT.value/12)}"payment"===c.step?c.selectOffer(c.offers.yearly):e.search("step","offers").replace()}),j.query({id:"orga.v2.yearly.x1"},function(a){c.eduOffer=a[0],c.templates=l[c.eduOffer.priceWithVAT.currencyCode];var b=50*c.eduOffer.priceWithVAT.value;Math.round(b)!==b&&(b=b.toFixed(2)),c.eduPrice=c.templates.moneyFormat.replace("{amount}",b)})}if(b.account.organizationRole)return void d.debug("Cannot use an individual upgrade page.");c.error={},c.offers={},c.processing=!1,c.currentPlan=b.account.plan,c.offerMonthly=!1,q.remove("test.indiv-checkout"),c.displayEdu=!0,c.displayLifetime=!1;var s=["USD","AUD","CAD","CZK","DKK","EUR","GBP","HKK","HUF","ILS","JPY","MXN","TWD","NZD","NOK","PHP","PLN","RUB","SGD","SEK","CHF","THB"];c.selectOffer=function(b){c.activeOffer||(a.push({funnel:{id:c.funnel},event:{type:"page",category:"upgrade-indiv",name:"payment"}}),g(i.bind(i,"cc-name"))),"indiv-starter"===c.currentPlan.name?c.subscribe(b):(c.activeOffer=b,e.search("step","payment"))};var t="20170320";c.currentPlan&&"indiv-starter"===c.currentPlan.name&&(t+="-usingstarter"),window.innerWidth<768?t+="-small":window.innerWidth<1050&&(t+="-medium"),a.push({funnel:{category:"purchase",name:"individual-upgrade",referral:c.referral,version:t},event:{type:"page",category:"upgrade-indiv",name:"offers"}},function(a){b.upgradeFunnel=c.funnel=a.funnel}),c.features=[],["unlimited-private-scores","smart-history","live-midi","playback-options","analytics","tabs-tuning","awesome-support","offline-composition","midi-output","unbranded-printing","private-profile"].forEach(function(a){c.hfeature===a?c.features.unshift(a):c.features.push(a)}),c.featuresLinks={"smart-history":"/smart-history","midi-output":"/midi-devices","live-midi":"/midi-devices","offline-composition":"/offline","awesome-support":"/support"},c.coupon?o.get({coupon:c.coupon},function(a){c.couponDetails=a,r()},function(){delete c.couponDetails,delete c.coupon,r()}):r(),c.pmAddedCallback=function(a,b){c.pm=a,c.activeOffer.subscription?c.subscribe(b):c.singlePurchase(b)},c.paymentSuccess=function(){c.success=!0,p.getNoCache({upgraded:!0},function(a){d.debug("[subscription] Received new profile"),b.account.subscription=a.subscription,b.account.plan=a.plan,b.account.license=a.license,g(function(){c.successCallback?c.successCallback():(d.debug("[subscription] Redirecting to success page"),e.path("/profile").search({m:"upgrade-success"}))},1e3)})},c.subscribe=function(a,e){e||(e=a),"function"!=typeof e&&(e=function(){}),a&&a.reference||(a=c.activeOffer),c.processing=!0;var f={reference:a.reference,funnel:c.funnel};!c.coupon||c.couponLifeOnly||c.couponYearlyOnly&&365!==a.durationInDays||(f.coupon=c.coupon),m.create(f,function(){d.debug("[subscription] Subscription created"),e(),c.paymentSuccess()},function(a){a=a.data,e(a),c.error={param:a.param||"number",message:a.description},c.activeOffer||b.displayErrors(a.description,null,!0),c.processing=!1,b.$broadcast("CC.Error",c.error)})},c.singlePurchase=function(a,d){d||(d=a),"function"!=typeof d&&(d=function(){}),a&&a.reference||(a=c.activeOffer),c.processing=!0,async.waterfall([function(b){var d={items:[{reference:a.reference,quantity:1}]};c.coupon&&(d.coupon=c.coupon),k.post(d,b.bind(null,null),b)},function(a,b,d){k.pay({id:a.id,pm:c.pm.id},d.bind(null,null),d)}],function(a){a?(c.processing=!1,b.displayErrors(a,null,!0)):c.paymentSuccess()})},c.payWithPaypal=function(){b.displayLoader=!0;var a={reference:c.activeOffer.reference,funnel:c.funnel};!c.coupon||c.couponLifeOnly||c.couponYearlyOnly&&365!==c.activeOffer.durationInDays||(a.coupon=c.coupon),n.create(a,function(a){q.set("paypal.funnel",c.funnel),window.location=a.paypalAgreement.approvalUrl},function(a){b.displayLoader=!1,b.displayErrors(a,null,!0)})},b.$on("CC.Error",function(b,d){a.push({funnel:{id:c.funnel},event:{type:"error",category:"upgrade-indiv",name:"subscription",properties:d}})}),c.showDetails=function(a){c.seeMoreDetails=!!a},c.close=b.hideModal,c.surveyExit=function(){!c.success&&b.account.email&&"en"===b.account.locale&&b.account.experience&&b.account.experience.length>=5&&(!q.get("upgrade-survey.last")||new Date(q.get("upgrade-survey.last"))<moment().subtract(15,"days").toDate())&&g(function(){b.loadModal("dashboard","upgrade-survey")},3e3)},c.$on("$routeUpdate",function(){"offers"===e.search().step&&c.activeOffer?delete c.activeOffer:"payment"!==e.search().step||c.activeOffer||c.selectOffer(c.offers.yearly),a.push({funnel:{id:c.funnel},event:{type:"page",category:"upgrade-indiv",name:e.search().step}})}),f.pageTrack("/settings/upgrade")}],link:function(b,c){var d=b.$watch("funnel",function(e){e&&(a.setupAutoTrack(c,b.funnel,"upgrade-indiv"),d())});c.on("$destroy",function(){b.funnel&&(a.push({funnel:{id:b.funnel,completed:!!b.success}}),b.surveyExit())})}}}]),angular.module("flat.dashboard.services",["ngResource"]).factory("AppOAuthAuthorize",["$resource",function(a){return a(apiv2baseurl+"/apps/oauth2/authorize/:step",{},{
start:{method:"POST",params:{step:"start"}},process:{method:"POST",params:{step:"process"}}})}]).factory("AppPublic",["$resource",function(a){return a(apiv2baseurl+"/apps/:app",{app:"@app"},{get:{method:"GET"}})}]).factory("UserScores",["$resource",function(a){return a(apibaseurl+"/user.json/:user/scores")}]).factory("UserScoresV2",["$resource",function(a){return a(apiv2baseurl+"/users/:user/scores")}]).factory("Follow",["$resource",function(a){return a(apiv2baseurl+"/users/:user/:type/:targetId",{user:"@user",targetId:"@targetId"},{follow:{method:"POST",params:{type:"following",user:"me"}},unfollow:{method:"DELETE",params:{type:"following",user:"me"}},following:{method:"GET",params:{type:"following"},isArray:!0},followers:{method:"GET",params:{type:"followers"},isArray:!0}})}]).factory("AssignmentSubmissionV2",["$resource",function(a){var b=a(apiv2baseurl+"/classes/:class/assignments/:assignment/submissions/:id",{class:"@class",assignment:"@assignment",id:"@id"},{put:{method:"PUT"},sync:{method:"POST",params:{id:"sync"}}});return b.addScoreToSubmission=function(a,c,d,e,f){"function"==typeof e&&(f=e,e=!1),async.waterfall([function(a){b.query({class:d,assignment:c},a.bind(this,null),a.bind(this))},function(e,f,g){for(var h=e.length>0?e[0].attachments:[],i=!1,j=0;j<h.length;j++)h[j].score===a&&(i=!0);i||h.push({score:a}),b.put({class:d,assignment:c,attachments:h},g.bind(this,null),g.bind(this))}],f||function(){})},b}]).factory("ProductUpdates",["$resource",function(a){return a(apibaseurl+"/updates.json/:id",{id:"@id"},{userSeen:{method:"PUT",url:apibaseurl+"/user.json/updates"}})}]).factory("ProductUpdateLikes",["$resource",function(a){return a(apibaseurl+"/updates.json/:update/likes",{update:"@update"})}]).factory("PaypalAgreement",["$resource",function(a){return a(apibaseurl+"/billing.json/paymentMeans/paypalAgreement/:token/:action",{token:"@token"},{create:{method:"POST"},execute:{method:"POST",params:{action:"execute"}}})}]).factory("Lti",["$resource",function(a){return a(baseurl+"/lti/:action",{},{contentSigner:{method:"POST",params:{action:"content-signer"}},outcomesStudent:{method:"POST",params:{action:"outcomes-student"}}})}]).factory("LtiHelpers",["Lti","ScoreV2","AssignmentSubmissionV2","$q","$rootScope",function(a,b,c,d,e){var f={ensureScoreAccessible:function(a){return d(function(c,d){return"public"===a.privacy||"organizationPublic"===a.privacy?c():void b.put({id:a.id,privacy:"organizationPublic"}).$promise.then(c).catch(d)})},addToFlatAssignment:function(a){return d(function(b,d){return e.ltiFlat&&e.ltiFlat.assignment?void c.addScoreToSubmission(a.id,e.ltiFlat.assignment,e.ltiFlat.classroom,!0,function(a){a?d(a):b()}):b()})},outcomesStudent:function(b){return d(function(c,d){f.ensureScoreAccessible(b).then(function(){f.addToFlatAssignment(b).then(function(){return!e.ltiRequest||"string"!=typeof e.ltiRequest.ext_outcome_data_values_accepted||e.ltiRequest.ext_outcome_data_values_accepted.indexOf("url")<0?c():void a.outcomesStudent({score:b.id}).$promise.then(c).catch(d)}).catch(d)}).catch(d)})}};return f}]).factory("Subscription",["$resource",function(a){return a(apibaseurl+"/subscription.json",{pm:"@pm"},{create:{method:"POST"},cancel:{method:"DELETE"}})}]).factory("Coupon",["$resource",function(a){return a(apibaseurl+"/billing.json/coupons/:coupon")}]).factory("LicensePools",["$resource",function(a){return a(apiv2baseurl+"/licensesPools/:id/:action",{id:"@id"},{users:{method:"GET",params:{action:"users"},isArray:!0},cachedquery:{method:"GET",isArray:!0,cache:!0}})}]),function(){"use strict";function a(a,b,c,d,e){function f(a){a=a||{},this.title=a.title||"",this.adagioData=null,this.privacy=a.privacy||"private",this.layout=a.layout||"staff",this.assignment=a.assignment,this.instruments=[],this.tabsInstruments=[],this.instrumentsCount={},this.fifths=a.fifths||0,this.beats=a.beats||4,this.beatType=a.beatType||4,this.keySignature=a.keySignature||0,this.funnel=a.funnel||null,this.currPartIdx=0}function g(a,b){return[a,b.replace(" ","-")].join("_")}function h(a,b){return k[a][b]&&k[a][b].clefs&&"TAB"===k[a][b].clefs[0].sign}function i(a,b,c,d){var e=b.clefs,f={instrumentName:b.longname,abbreviation:b.shortname,partName:b.longname,staves:[],MIDIProgram:b.midichannel.default.program,partIdx:a};e[0]&&"TAB"===e[0].sign&&(e=b.alternativeClef);for(var g=0;g<e.length;g++)f.staves.push({clef:e[g],concertKey:{fifths:c},transpose:{chromatic:b.transposechromatic%12||0,diatonic:b.transposediatonic%7||0,"octave-change":b.transposechromatic<0?Math.ceil(b.transposechromatic/12)||0:Math.floor(b.transposechromatic/12)||0}}),b.details&&"tabs"===d&&(f.staves[g].staffDetails=b.details);return f}function j(a){return e.query().$promise.then(function(b){return a.instruments.$sort[0]&&"custom"!==a.instruments.$sort[0].name?a.instruments.$sort.unshift({name:"custom",instruments:[]}):a.instruments.$sort[0].instruments=[],a.instruments.custom={$name:i18n.t("flat:score.my-custom-instruments"),icon:"custom"},angular.forEach(b,function(b){var c=b.longname.replace(" ","-").toLowerCase();a.instruments.$sort[0].instruments.push(c),a.instruments.custom[c]=b}),a})}var k={},l=a.account.plan&&a.account.plan.features&&a.account.plan.features.customInstrument,m=d.get({locale:a.account.locale||"en"},function(a){k=a.instruments}).$promise;return f.prototype.setTitle=function(a){this.scoreData.setTitle(a)},f.prototype.setNbMeasures=function(a){(!a||a<1)&&(a=1),this.scoreData.setNbMeasures(a)},f.prototype.setTime=function(a,b){this.scoreData.setTime({beats:a,"beat-type":b})},f.prototype.build=function(){return b(function(a,b){return this.instruments.length?(this.scoreData=new Adagio.Data,this.setTitle(this.title),this.setNbMeasures(1),this.setTime(this.beats,this.beatType),void this.addInstrumentsToScoreData().then(function(){a(this.scoreData.exportData())}.bind(this)).catch(b)):b(new Error("[ScoreFactory] No instrument(s) or template(s) has been selected"))}.bind(this))},f.prototype.exportData=function(){return this.setTitle(this.title),this.setTime(this.beats,this.beatType),this.scoreData.exportData()},f.prototype.increaseInstrumentsCountKey=function(a,b){var c=g(a,b);angular.isUndefined(this.instrumentsCount[c])&&(this.instrumentsCount[c]=0),this.instrumentsCount[c]++},f.prototype.decreaseInstrumentsCountKey=function(a,b){var c=g(a,b);this.instrumentsCount[c]>0&&(this.instrumentsCount[c]-=1),0===this.instrumentsCount[c]&&delete this.instrumentsCount[c]},f.prototype.addInstrumentMeta=function(a,b){this.increaseInstrumentsCountKey(a,b),this.addTabsInstrument(a,b)},f.prototype.removeInstrumentMeta=function(a,b){this.decreaseInstrumentsCountKey(a,b),this.removeTabsInstrument(a,b)},f.prototype.addTemplateMeta=function(a,b){this.increaseInstrumentsCountKey(a,b.name),_.each(b.instruments,function(a){this.addInstrumentMeta(a.group,a.id)}.bind(this))},f.prototype.removeTemplateMeta=function(a,b){this.decreaseInstrumentsCountKey(a,b.name),_.each(b.instruments,function(a){this.removeInstrumentMeta(a.group,a.id)}.bind(this))},f.prototype.addTemplate=function(a,b){this.instruments.push({group:a,template:b}),this.addTemplateMeta(a,b)},f.prototype.removeTemplateInstrument=function(a,b){var c=this.instruments[a];if(c&&c.template&&c.template.instruments.length){var d=c.template.instruments[b];if(d)if(1===c.template.instruments.length)this.removeTemplate(a);else{var e=this.instruments[a].template.instruments[b];this.removeInstrumentMeta(e.group,e.id),this.instruments[a].template.instruments.splice(b,1)}}},f.prototype.removeTemplate=function(a){var b=this.instruments[a];b&&b.template&&(this.removeTemplateMeta(b.group,b.template),this.instruments.splice(a,1))},f.prototype.addInstrument=function(a,b){this.instruments.push({group:a,instrument:b}),this.addInstrumentMeta(a,b)},f.prototype.removeInstrument=function(a){this.instruments[a]&&this.instruments[a].instrument&&(this.removeInstrumentMeta(this.instruments[a].group,this.instruments[a].instrument),this.instruments.splice(a,1))},f.prototype.addTabsInstrument=function(a,b){h(a,b)&&(0===this.tabsInstruments.length&&(this.layout="tabs"),this.tabsInstruments.push(b))},f.prototype.removeTabsInstrument=function(a,b){if(h(a,b))for(var c=0;c<this.tabsInstruments.length;c++)if(this.tabsInstruments[c]===b)return 1===this.tabsInstruments.length&&(this.layout="staff"),this.tabsInstruments.splice(c,1)},f.prototype.removeLastInstrument=function(a,b){for(var c=this.instruments.length-1;c>=0;c--)if(this.instruments[c].group===a&&this.instruments[c].instrument===b){this.removeInstrument(c);break}},f.prototype.removeLastTemplate=function(a,b){for(var c=this.instruments.length-1;c>=0;c--)if(this.instruments[c].group===a&&this.instruments[c].template.name===b.name){this.removeTemplate(c);break}},f.prototype.addInstrumentsToScoreData=function(){var a=[],c=[],d=[];return b(function(e,f){return _.each(this.instruments,function(b){b.template?_.each(b.template.instruments,function(b){b.instrument=b.id,a.push(b)}):a.push(b)}),_.each(a,function(a,b){a=angular.copy(a),a.partIdx=b,d.push(this.addInstrumentToScoreData(a).then(function(a){c.push(a)}))}.bind(this)),b.all(d).finally(function(){return a.length===c.length?e(c):f(_.difference(a,c))})}.bind(this))},f.prototype.addInstrumentToScoreData=function(a){return b(function(b,d){var e=a.group,f=a.instrument,g=a.partIdx;try{if(!a.clefs&&("undefined"==typeof e||"undefined"==typeof f||"undefined"==typeof k[e]||"undefined"==typeof k[e][f]||"undefined"==typeof this.scoreData))return d();var h,j=a.clefs&&a||k[e][f];if("unpitched-percussion"===e||j.drumset){for(var l=0;l<j.instruments.length;l++)j.instruments[l].MIDIProgram=j.midiprogram||1;this.scoreData["action.AddPartPercu"]({name:a.longname||a.name||j.longname,abbreviation:a.shortname||j.shortname,partIdx:g,instrumentsList:j.instruments,pitchMapping:j.mapping,nbStaffLines:j.lines})}else h=i(g,j,this.fifths,this.layout),h.instrumentName=h.partName=a.longname||a.name||j.longname,h.abbreviation=a.shortname||j.shortname,this.scoreData["action.AddPart"](h);return b({group:e,instrument:f})}catch(a){var m;return a instanceof Adagio.Error.client.ClientError||a instanceof Adagio.Error.value.ValueError?m=new Error("[ScoreFactory] Adagio crashed while adding a new instrument"):(m=new Error("[ScoreFactory] Crash while adding a new instrument"),m.level="warning"),m.e=a,m.newScore=!0,m.title=this.title,m.fifths=this.fifths,m.beats=this.beats,m.beatType=this.beatType,m.instrument=f,m.group=e,c.error(m),d(m)}}.bind(this))},f.prototype.getInstrumentsData=function(){return b(function(a,b){return l?m.then(j).then(a).catch(b):m.then(a).catch(b)})},f}angular.module("flat.dashboard.services").factory("flat.dashboard.services.ScoreFactory",a),a.$inject=["$rootScope","$q","$log","Instruments","CustomPitchedInstrument"]}();
//# sourceMappingURL=flat.dashboard.min.js.map